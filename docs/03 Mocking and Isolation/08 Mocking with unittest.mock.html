<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>08 Mocking with unittest.mock</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">03 Mocking and Isolation</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-8-mocking-with-unittestmock">Chapter 8: Mocking with unittest.mock</h1>
<h2 id="why-mock">Why Mock?</h2>
<h2 id="the-problem-testing-in-isolation">The Problem: Testing in Isolation</h2>
<p>So far, our tests have been self-contained. We've tested functions that take data, transform it, and return a result. This is the ideal scenario for testing. But real-world applications are rarely so simple. They are complex systems that interact with databases, file systems, third-party APIs, and other services.</p>
<p>Consider a function that processes a customer's order. Its job might involve:
1.  Charging the customer's credit card via a payment gateway API.
2.  Saving the order details to a database.
3.  Sending a confirmation email via an email service.</p>
<p>How would you write a unit test for this function? If your test calls the <em>real</em> payment gateway, you have several major problems:</p>
<ul>
<li><strong>Cost:</strong> You might be charged real money for every test run.</li>
<li><strong>Slowness:</strong> Network requests to external services are orders of magnitude slower than in-memory function calls. A test suite with hundreds of such tests could take minutes or hours to run.</li>
<li><strong>Unreliability:</strong> The external service could be down, or your network connection could be flaky. This would cause your tests to fail for reasons completely unrelated to your code's correctness.</li>
<li><strong>Side Effects:</strong> You would be creating fake orders in the database and sending real emails to non-existent addresses with every test run.</li>
<li><strong>Testing Edge Cases is Hard:</strong> How do you test what happens when the payment gateway returns a "Card Declined" error? Or a "Gateway Timeout" error? You can't easily force a real-world service to produce these specific error conditions on demand.</li>
</ul>
<p>The goal of a <strong>unit test</strong> is to test a single <em>unit</em> of code in <strong>isolation</strong>. To do this, we need a way to pretend these external dependencies exist, controlling their behavior so we can test our code's logic reliably and quickly. This is where mocking comes in.</p>
<h3 id="phase-1-establish-the-reference-implementation">Phase 1: Establish the Reference Implementation</h3>
<p>Let's build a concrete example that demonstrates these problems. We'll create a simple e-commerce order processing system. It has two external dependencies: a <code>PaymentGateway</code> and a <code>NotificationService</code>.</p>
<p>Our anchor example will be the <code>process_order</code> function. We will spend this chapter refining the tests for this single function.</p>
<p>First, let's define the external services. We'll simulate their slowness and potential for failure.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/services.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentGateway</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A simulated external payment gateway.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">charge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_details</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Charges the card. Returns a transaction ID on success.</span>
<span class="sd">        In a real system, this would make a network request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Connecting to payment gateway...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">card_details</span> <span class="ow">or</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid card details or amount.&quot;</span><span class="p">)</span>

        <span class="c1"># Simulate network latency</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Simulate a chance of failure</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">:</span> <span class="c1"># 20% chance of failure</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The payment was declined.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span> <span class="c1"># Return empty string for a declined payment</span>

        <span class="n">transaction_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tx_</span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">9999</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Charge successful. Transaction ID: </span><span class="si">{</span><span class="n">transaction_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">transaction_id</span>

<span class="k">class</span><span class="w"> </span><span class="nc">NotificationService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A simulated external notification service.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">send_receipt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sends a receipt to the customer&#39;s email.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sending receipt for </span><span class="si">{</span><span class="n">transaction_id</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="c1"># Simulate network latency</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Receipt sent.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<p>Now, here is the function we want to test. It coordinates these two services.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/orders.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.services</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentGateway</span><span class="p">,</span> <span class="n">NotificationService</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">customer_email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">card_details</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Processes a customer order.</span>
<span class="sd">    1. Charges the customer&#39;s card.</span>
<span class="sd">    2. Sends a receipt if the charge is successful.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gateway</span> <span class="o">=</span> <span class="n">PaymentGateway</span><span class="p">()</span>
    <span class="n">notifier</span> <span class="o">=</span> <span class="n">NotificationService</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing order </span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="n">transaction_id</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="n">card_details</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">transaction_id</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Payment successful for order </span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">notifier</span><span class="o">.</span><span class="n">send_receipt</span><span class="p">(</span><span class="n">customer_email</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;Order processed successfully.&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Payment failed for order </span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;Payment failed.&quot;</span>
</code></pre></div>

<p>Finally, let's write our first, naive test. This is an <strong>integration test</strong>, not a unit test, because it uses the real, live <code>services</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_orders_naive.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.orders</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_order</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_success_naive</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A slow and unreliable test for a successful order.</span>
<span class="sd">    This test will take ~3 seconds to run.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_order</span><span class="p">(</span>
        <span class="n">order_id</span><span class="o">=</span><span class="s2">&quot;order_123&quot;</span><span class="p">,</span>
        <span class="n">customer_email</span><span class="o">=</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">,</span>
        <span class="n">card_details</span><span class="o">=</span><span class="s2">&quot;tok_valid&quot;</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">49.99</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;Order processed successfully.&quot;</span>
</code></pre></div>

<p>Let's run this test and see the problems firsthand.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v<span class="w"> </span>-s<span class="w"> </span>tests/test_orders_naive.py
<span class="c1"># The -s flag is used to show the print statements</span>

<span class="o">===========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">============================</span>
...
collected<span class="w"> </span><span class="m">1</span><span class="w"> </span>item

tests/test_orders_naive.py::test_process_order_success_naive<span class="w"> </span>
Processing<span class="w"> </span>order<span class="w"> </span>order_123...

Connecting<span class="w"> </span>to<span class="w"> </span>payment<span class="w"> </span>gateway...
Charge<span class="w"> </span>successful.<span class="w"> </span>Transaction<span class="w"> </span>ID:<span class="w"> </span>tx_...
Payment<span class="w"> </span>successful<span class="w"> </span><span class="k">for</span><span class="w"> </span>order<span class="w"> </span>order_123.

Sending<span class="w"> </span>receipt<span class="w"> </span><span class="k">for</span><span class="w"> </span>tx_...<span class="w"> </span>to<span class="w"> </span>test@example.com...
Receipt<span class="w"> </span>sent.
PASSED<span class="w"> </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">=======================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.05s<span class="w"> </span><span class="o">========================</span>
</code></pre></div>

<p>The test passed, but look at the execution time: <strong>3.05 seconds</strong>. For one test! A suite of 100 such tests would take over 5 minutes. Furthermore, if we run it enough times, it will eventually fail due to the <code>random.random()</code> check we added to simulate unreliability.</p>
<p>This is the core problem that mocking solves. We need to test the logic of <code>process_order</code> <em>without</em> actually calling the slow, unreliable, and costly external services.</p>
<h2 id="what-is-a-mock">What Is a Mock?</h2>
<h2 id="test-doubles-stubs-and-mocks">Test Doubles, Stubs, and Mocks</h2>
<p>To test our code in isolation, we replace real dependency objects (like an instance of <code>PaymentGateway</code>) with fake objects that we control. These fake objects are generically called <strong>Test Doubles</strong>. The term comes from the idea of a "stunt double" in movies‚Äîa stand-in that looks and acts like the real thing for a specific, controlled scene.</p>
<p>There are several types of test doubles, but the most common one we'll use is a <strong>Mock</strong>.</p>
<p>A <strong>Mock Object</strong> is a smart test double that:
1.  <strong>Stands in</strong> for a real object.
2.  <strong>Can be configured</strong> to return specific values from its methods.
3.  <strong>Records how it was used</strong>, allowing you to make assertions about which methods were called, how many times, and with what arguments.</p>
<p>In Python, the standard library for creating and managing mocks is <code>unittest.mock</code>. Even though the name includes "unittest" (the built-in test framework), it is a general-purpose library that works perfectly with pytest.</p>
<p>The core idea is to replace this:</p>
<p><code>Our Code -&gt; Real Payment Gateway</code></p>
<p>with this:</p>
<p><code>Our Code -&gt; Mock Payment Gateway &lt;- Our Test</code></p>
<p>Our test code will:
1.  Create a mock object that looks and feels like a <code>PaymentGateway</code>.
2.  Tell the <code>process_order</code> function to use our mock instead of the real one.
3.  Configure the mock to behave in a specific way (e.g., "when <code>charge</code> is called, return <code>tx_12345</code>").
4.  Run <code>process_order</code>.
5.  Ask the mock questions to verify the interaction (e.g., "were you called? Was your <code>charge</code> method called with an amount of 49.99?").</p>
<p>This approach solves all our previous problems:
-   <strong>Cost:</strong> No real services are called. It's free.
-   <strong>Slowness:</strong> Mocks are just in-memory Python objects. They are incredibly fast.
-   <strong>Unreliability:</strong> Mocks are 100% deterministic. They do exactly what you tell them to do.
-   <strong>Side Effects:</strong> No databases are touched, no emails are sent.
-   <strong>Testing Edge Cases:</strong> We can easily configure a mock to simulate a "Card Declined" error or any other scenario we want to test.</p>
<h2 id="creating-mocks-with-mock">Creating Mocks with Mock()</h2>
<h2 id="the-mock-class">The <code>Mock</code> Class</h2>
<p>The <code>unittest.mock</code> module provides a class called <code>Mock</code> (and a more powerful subclass <code>MagicMock</code>) that serves as a generic mock object. Let's see it in action.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># You can run this in a Python interpreter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>

<span class="c1"># Create a mock object</span>
<span class="n">mock_gateway</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

<span class="c1"># You can call any method on it, and it will return another Mock</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="s2">&quot;details&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="c1"># Output: &lt;Mock name=&#39;mock.charge()&#39; id=&#39;...&#39;&gt;</span>

<span class="c1"># You can access any attribute, and it will also return a Mock</span>
<span class="n">api_key</span> <span class="o">=</span> <span class="n">mock_gateway</span><span class="o">.</span><span class="n">api_key</span>
<span class="nb">print</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
<span class="c1"># Output: &lt;Mock name=&#39;mock.api_key&#39; id=&#39;...&#39;&gt;</span>
</code></pre></div>

<p>This is the default behavior. A <code>Mock</code> object is a blank slate that will accept any operation you perform on it and record that it happened. This is useful, but to make it behave like our <code>PaymentGateway</code>, we need to configure it.</p>
<p>We can pre-configure a mock to have specific attributes or methods with return values.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>

<span class="c1"># Configure a mock to simulate a successful charge</span>
<span class="n">mock_gateway</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
<span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;tx_success_123&quot;</span>

<span class="c1"># Now when we call charge, it returns our configured value</span>
<span class="n">transaction_id</span> <span class="o">=</span> <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="n">card_details</span><span class="o">=</span><span class="s2">&quot;tok_valid&quot;</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="mf">50.00</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">transaction_id</span><span class="p">)</span>
<span class="c1"># Output: tx_success_123</span>

<span class="c1"># We can also check if the method was called</span>
<span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span>

<span class="c1"># And check *what* it was called with</span>
<span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">card_details</span><span class="o">=</span><span class="s2">&quot;tok_valid&quot;</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="mf">50.00</span><span class="p">)</span>
</code></pre></div>

<p>This is the fundamental mechanism. However, creating a mock is one thing; getting our <code>process_order</code> function to <em>use</em> it is another. The <code>process_order</code> function creates its own <code>PaymentGateway</code> instance internally. We need a way to intercept that creation and substitute our mock. This is called <strong>patching</strong>.</p>
<h2 id="patching-functions-with-patch">Patching Functions with @patch</h2>
<h2 id="intercepting-code-with-patch">Intercepting Code with <code>@patch</code></h2>
<p>The most common tool you'll use from <code>unittest.mock</code> is <code>patch</code>. It's a powerful decorator (or context manager) that temporarily replaces an object in a specific module with a mock.</p>
<p>The key to using <code>patch</code> correctly is to provide the path to the object <strong>where it is looked up</strong>, not where it is defined. In our case, the <code>process_order</code> function lives in <code>src.orders</code> and it does <code>from .services import PaymentGateway</code>. Therefore, inside <code>src.orders</code>, <code>PaymentGateway</code> refers to <code>src.orders.PaymentGateway</code>. This is the target we must patch.</p>
<h3 id="iteration-1-replacing-the-slow-services">Iteration 1: Replacing the Slow Services</h3>
<p>Let's write a new test that uses <code>@patch</code> to replace both <code>PaymentGateway</code> and <code>NotificationService</code>.</p>
<p><strong>The Goal:</strong> Run the test for <code>process_order</code> without the 3-second delay.</p>
<p>Here is our first attempt.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_orders_mocked.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.orders</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_order</span>

<span class="c1"># The target string is &#39;module.submodule.ClassName&#39;</span>
<span class="c1"># Note the order: decorators are applied from the bottom up.</span>
<span class="c1"># The first argument to the test function corresponds to the *inner-most* decorator.</span>
<span class="c1"># So, mock_notifier comes first, then mock_gateway.</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;src.orders.PaymentGateway&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;src.orders.NotificationService&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_success_mocked</span><span class="p">(</span><span class="n">mock_notifier_class</span><span class="p">,</span> <span class="n">mock_gateway_class</span><span class="p">):</span>
    <span class="c1"># The patch gives us mock *classes*, not instances.</span>
    <span class="c1"># We can configure the behavior of instances that will be created from these classes.</span>
    <span class="n">mock_gateway_instance</span> <span class="o">=</span> <span class="n">mock_gateway_class</span><span class="o">.</span><span class="n">return_value</span>
    <span class="n">mock_gateway_instance</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;tx_mock_456&quot;</span>

    <span class="n">mock_notifier_instance</span> <span class="o">=</span> <span class="n">mock_notifier_class</span><span class="o">.</span><span class="n">return_value</span>

    <span class="c1"># Run the function under test</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_order</span><span class="p">(</span>
        <span class="n">order_id</span><span class="o">=</span><span class="s2">&quot;order_456&quot;</span><span class="p">,</span>
        <span class="n">customer_email</span><span class="o">=</span><span class="s2">&quot;mock@example.com&quot;</span><span class="p">,</span>
        <span class="n">card_details</span><span class="o">=</span><span class="s2">&quot;tok_mock&quot;</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">19.99</span>
    <span class="p">)</span>

    <span class="c1"># Assert the final result</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;Order processed successfully.&quot;</span>
</code></pre></div>

<p>Let's run this new test.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v<span class="w"> </span>-s<span class="w"> </span>tests/test_orders_mocked.py

<span class="o">===========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">============================</span>
...
collected<span class="w"> </span><span class="m">1</span><span class="w"> </span>item

tests/test_orders_mocked.py::test_process_order_success_mocked<span class="w"> </span>
Processing<span class="w"> </span>order<span class="w"> </span>order_456...
Payment<span class="w"> </span>successful<span class="w"> </span><span class="k">for</span><span class="w"> </span>order<span class="w"> </span>order_456.
PASSED<span class="w"> </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">=======================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.02s<span class="w"> </span><span class="o">========================</span>
</code></pre></div>

<p>Look at that! The test passed in <strong>0.02 seconds</strong>. We have successfully replaced the slow external services with fast mock objects.</p>
<p>However, our test is incomplete. It asserts that <code>process_order</code> returns the correct string, but it doesn't verify that the services were used correctly. Did we actually call <code>gateway.charge</code> with the right amount? Did we call <code>notifier.send_receipt</code> with the correct email and transaction ID? Right now, we have no idea. A test that passes for the wrong reasons is just as dangerous as a test that fails. We need to add assertions about the <em>interactions</em> with our mocks.</p>
<h2 id="common-mock-assertions-assert_called-assert_called_with">Common Mock Assertions (assert_called, assert_called_with)</h2>
<h2 id="verifying-mock-interactions">Verifying Mock Interactions</h2>
<p>Mocks are not just stand-ins; they are spies. They record every interaction you have with them. After running your code, you can query the mock to ensure it was used as you expected.</p>
<p>The most common assertion methods are:
-   <code>mock_object.method.assert_called()</code>: Asserts that the method was called at least once.
-   <code>mock_object.method.assert_called_once()</code>: Asserts that the method was called exactly once.
-   <code>mock_object.method.assert_called_with(*args, **kwargs)</code>: Asserts that the <em>last</em> call to the method was with these specific arguments.
-   <code>mock_object.method.assert_called_once_with(*args, **kwargs)</code>: A combination of the above. Asserts it was called exactly once, and that one call was with these arguments.
-   <code>mock_object.method.assert_not_called()</code>: Asserts the method was never called.
-   <code>mock_object.method.call_count</code>: An integer property that tells you how many times the method was called.</p>
<h3 id="iteration-2-verifying-the-gateway-and-notifier-calls">Iteration 2: Verifying the Gateway and Notifier Calls</h3>
<p>Let's improve our previous test by adding assertions to verify that the gateway and notifier were called correctly.</p>
<p><strong>Current Limitation:</strong> Our test only checks the final return value. It doesn't confirm that the dependencies were used correctly.</p>
<p><strong>New Scenario:</strong> We need to ensure <code>gateway.charge</code> is called with the correct <code>card_details</code> and <code>amount</code>, and that <code>notifier.send_receipt</code> is called with the correct <code>email</code> and the <code>transaction_id</code> returned by the gateway.</p>
<p>Let's add these assertions to our test. To demonstrate how the assertions work, we'll start by making a mistake on purpose. Let's assert that the <code>amount</code> was <code>29.99</code> when it was actually <code>19.99</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_orders_mocked.py (updated test)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.orders</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_order</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;src.orders.PaymentGateway&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;src.orders.NotificationService&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_success_with_assertions</span><span class="p">(</span><span class="n">mock_notifier_class</span><span class="p">,</span> <span class="n">mock_gateway_class</span><span class="p">):</span>
    <span class="c1"># Arrange: Configure the mocks</span>
    <span class="n">mock_gateway_instance</span> <span class="o">=</span> <span class="n">mock_gateway_class</span><span class="o">.</span><span class="n">return_value</span>
    <span class="n">mock_gateway_instance</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;tx_mock_456&quot;</span>

    <span class="n">mock_notifier_instance</span> <span class="o">=</span> <span class="n">mock_notifier_class</span><span class="o">.</span><span class="n">return_value</span>

    <span class="c1"># Act: Run the function under test</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_order</span><span class="p">(</span>
        <span class="n">order_id</span><span class="o">=</span><span class="s2">&quot;order_456&quot;</span><span class="p">,</span>
        <span class="n">customer_email</span><span class="o">=</span><span class="s2">&quot;mock@example.com&quot;</span><span class="p">,</span>
        <span class="n">card_details</span><span class="o">=</span><span class="s2">&quot;tok_mock&quot;</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">19.99</span>
    <span class="p">)</span>

    <span class="c1"># Assert: Check the final result and the interactions</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;Order processed successfully.&quot;</span>

    <span class="c1"># Verify the gateway was used correctly</span>
    <span class="n">mock_gateway_instance</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;tok_mock&quot;</span><span class="p">,</span> <span class="mf">29.99</span><span class="p">)</span> <span class="c1"># INTENTIONAL ERROR</span>

    <span class="c1"># Verify the notifier was used correctly</span>
    <span class="n">mock_notifier_instance</span><span class="o">.</span><span class="n">send_receipt</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="s2">&quot;mock@example.com&quot;</span><span class="p">,</span> <span class="s2">&quot;tx_mock_456&quot;</span>
    <span class="p">)</span>
</code></pre></div>

<p>Now, let's run this and see the failure.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v<span class="w"> </span>tests/test_orders_mocked.py::test_process_order_success_with_assertions
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-failure">Diagnostic Analysis: Reading the Failure</h3>
<p><strong>The complete output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">===========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">============================</span>
<span class="p">...</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">item</span>

<span class="n">tests</span><span class="o">/</span><span class="n">test_orders_mocked</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_process_order_success_with_assertions</span><span class="w"> </span><span class="n">FAILED</span><span class="w"> </span><span class="o">[</span><span class="n">100%</span><span class="o">]</span>

<span class="o">=================================</span><span class="w"> </span><span class="n">FAILURES</span><span class="w"> </span><span class="o">=================================</span>
<span class="n">___</span><span class="w"> </span><span class="n">test_process_order_success_with_assertions</span><span class="w"> </span><span class="n">___</span>

<span class="n">mock_notifier_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">MagicMock</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;NotificationService&#39;</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;...&#39;</span><span class="o">&gt;</span>
<span class="n">mock_gateway_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">MagicMock</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;PaymentGateway&#39;</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;...&#39;</span><span class="o">&gt;</span>

<span class="w">    </span><span class="nv">@patch</span><span class="p">(</span><span class="s1">&#39;src.orders.PaymentGateway&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="nv">@patch</span><span class="p">(</span><span class="s1">&#39;src.orders.NotificationService&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">test_process_order_success_with_assertions</span><span class="p">(</span><span class="n">mock_notifier_class</span><span class="p">,</span><span class="w"> </span><span class="n">mock_gateway_class</span><span class="p">)</span><span class="err">:</span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">(</span><span class="n">setup</span><span class="w"> </span><span class="n">code</span><span class="p">)</span><span class="w"> </span><span class="p">...</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">Verify</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">gateway</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">correctly</span>
<span class="o">&gt;</span><span class="w">       </span><span class="n">mock_gateway_instance</span><span class="p">.</span><span class="n">charge</span><span class="p">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="ss">&quot;tok_mock&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">29.99</span><span class="p">)</span>
<span class="n">E</span><span class="w">       </span><span class="nl">AssertionError</span><span class="p">:</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="k">found</span><span class="p">.</span>
<span class="n">E</span><span class="w">       </span><span class="nl">Expected</span><span class="p">:</span><span class="w"> </span><span class="n">charge</span><span class="p">(</span><span class="s1">&#39;tok_mock&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">29.99</span><span class="p">)</span>
<span class="n">E</span><span class="w">       </span><span class="nl">Actual</span><span class="p">:</span><span class="w"> </span><span class="n">charge</span><span class="p">(</span><span class="s1">&#39;tok_mock&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">19.99</span><span class="p">)</span>

<span class="n">tests</span><span class="o">/</span><span class="n">test_orders_mocked</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="mi">28</span><span class="err">:</span><span class="w"> </span><span class="n">AssertionError</span>
<span class="o">=========================</span><span class="w"> </span><span class="n">short</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">summary</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">==========================</span>
<span class="n">FAILED</span><span class="w"> </span><span class="n">tests</span><span class="o">/</span><span class="n">test_orders_mocked</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_process_order_success_with_assertions</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nl">AssertionError</span><span class="p">:</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="k">found</span><span class="p">.</span>
<span class="o">============================</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.05</span><span class="n">s</span><span class="w"> </span><span class="o">=============================</span>
</code></pre></div>

<p><strong>Let's parse this section by section</strong>:</p>
<ol>
<li>
<p><strong>The summary line</strong>: <code>FAILED ... - AssertionError: expected call not found.</code></p>
<ul>
<li>What this tells us: The test failed because a mock assertion failed. Specifically, we asserted a method was called in a certain way, but it wasn't.</li>
</ul>
</li>
<li>
<p><strong>The traceback</strong>:
    <code>python
    &gt;       mock_gateway_instance.charge.assert_called_once_with("tok_mock", 29.99)
    E       AssertionError: expected call not found.</code></p>
<ul>
<li>What this tells us: The exact line that failed was our call to <code>assert_called_once_with</code>.</li>
</ul>
</li>
<li>
<p><strong>The assertion introspection</strong>:
    <code>E       Expected: charge('tok_mock', 29.99)
    E       Actual: charge('tok_mock', 19.99)</code></p>
<ul>
<li>What this tells us: This is the most valuable part. The <code>unittest.mock</code> library provides an incredibly clear report. We expected a call with the amount <code>29.99</code>, but the actual call was made with <code>19.99</code>.</li>
</ul>
</li>
</ol>
<p><strong>Root cause identified</strong>: Our assertion for the <code>amount</code> argument was incorrect.
<strong>Why the current approach can't solve this</strong>: The test itself is fine; the <em>assertion data</em> is wrong. This failure proves our test is working correctly‚Äîit caught a discrepancy.
<strong>What we need</strong>: To fix the test, we simply need to update the assertion to reflect the correct, expected arguments.</p>
<h3 id="the-solution">The Solution</h3>
<p>Let's fix the assertion and rerun the test.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_orders_mocked.py (fixed test)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.orders</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_order</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;src.orders.PaymentGateway&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;src.orders.NotificationService&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_success_with_assertions_fixed</span><span class="p">(</span><span class="n">mock_notifier_class</span><span class="p">,</span> <span class="n">mock_gateway_class</span><span class="p">):</span>
    <span class="c1"># Arrange</span>
    <span class="n">mock_gateway_instance</span> <span class="o">=</span> <span class="n">mock_gateway_class</span><span class="o">.</span><span class="n">return_value</span>
    <span class="n">mock_gateway_instance</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;tx_mock_456&quot;</span>
    <span class="n">mock_notifier_instance</span> <span class="o">=</span> <span class="n">mock_notifier_class</span><span class="o">.</span><span class="n">return_value</span>

    <span class="c1"># Act</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_order</span><span class="p">(</span>
        <span class="n">order_id</span><span class="o">=</span><span class="s2">&quot;order_456&quot;</span><span class="p">,</span>
        <span class="n">customer_email</span><span class="o">=</span><span class="s2">&quot;mock@example.com&quot;</span><span class="p">,</span>
        <span class="n">card_details</span><span class="o">=</span><span class="s2">&quot;tok_mock&quot;</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">19.99</span>
    <span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;Order processed successfully.&quot;</span>
    <span class="n">mock_gateway_instance</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;tok_mock&quot;</span><span class="p">,</span> <span class="mf">19.99</span><span class="p">)</span> <span class="c1"># CORRECTED</span>
    <span class="n">mock_notifier_instance</span><span class="o">.</span><span class="n">send_receipt</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="s2">&quot;mock@example.com&quot;</span><span class="p">,</span> <span class="s2">&quot;tx_mock_456&quot;</span>
    <span class="p">)</span>
</code></pre></div>

<p>Running this test now passes, and we have much higher confidence in its correctness. We've verified the final output <em>and</em> the internal interactions with its dependencies.</p>
<h2 id="mock-side-effects-and-return-values">Mock Side Effects and Return Values</h2>
<h2 id="controlling-mock-behavior">Controlling Mock Behavior</h2>
<p>So far, we've used <code>return_value</code> to specify what a mock method should return. This is the most common way to configure a mock. But what if we need to simulate more complex behavior, like an error?</p>
<h3 id="iteration-3-testing-failure-paths">Iteration 3: Testing Failure Paths</h3>
<p><strong>Current Limitation:</strong> We've only tested the "happy path" where the payment succeeds. A robust test suite must also cover failure scenarios.</p>
<p><strong>New Scenario:</strong> What happens if the payment gateway declines the charge? Our <code>process_order</code> function should return "Payment failed." and should <em>not</em> call the notification service.</p>
<p>To test this, we need to configure our mock gateway's <code>charge</code> method to simulate a failure. In our real <code>PaymentGateway</code>, a failed charge returns an empty string. Let's simulate that.</p>
<p>We can also use another powerful attribute: <code>side_effect</code>. The <code>side_effect</code> argument can be used to raise exceptions or to return different values on subsequent calls.</p>
<ul>
<li><code>mock.method.side_effect = Exception("Boom!")</code>: Calling <code>mock.method()</code> will now raise <code>Exception("Boom!")</code>.</li>
<li><code>mock.method.side_effect = [val1, val2, val3]</code>: The first call will return <code>val1</code>, the second <code>val2</code>, etc.</li>
</ul>
<p>Let's write two new tests: one for a declined payment and one for a gateway exception.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_orders_mocked.py (new tests for failure paths)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.orders</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_order</span>

<span class="c1"># We&#39;ll need a custom exception for one of our tests</span>
<span class="k">class</span><span class="w"> </span><span class="nc">GatewayError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;src.orders.PaymentGateway&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;src.orders.NotificationService&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_payment_declined</span><span class="p">(</span><span class="n">mock_notifier_class</span><span class="p">,</span> <span class="n">mock_gateway_class</span><span class="p">):</span>
    <span class="c1"># Arrange: Configure the gateway to simulate a declined payment (returns empty string)</span>
    <span class="n">mock_gateway_instance</span> <span class="o">=</span> <span class="n">mock_gateway_class</span><span class="o">.</span><span class="n">return_value</span>
    <span class="n">mock_gateway_instance</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># Simulate failure</span>
    <span class="n">mock_notifier_instance</span> <span class="o">=</span> <span class="n">mock_notifier_class</span><span class="o">.</span><span class="n">return_value</span>

    <span class="c1"># Act</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_order</span><span class="p">(</span><span class="s2">&quot;order_789&quot;</span><span class="p">,</span> <span class="s2">&quot;fail@example.com&quot;</span><span class="p">,</span> <span class="s2">&quot;tok_declined&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;Payment failed.&quot;</span>
    <span class="n">mock_gateway_instance</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;tok_declined&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

    <span class="c1"># Crucially, assert the notifier was *not* called</span>
    <span class="n">mock_notifier_instance</span><span class="o">.</span><span class="n">send_receipt</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;src.orders.PaymentGateway&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;src.orders.NotificationService&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_gateway_error</span><span class="p">(</span><span class="n">mock_notifier_class</span><span class="p">,</span> <span class="n">mock_gateway_class</span><span class="p">):</span>
    <span class="c1"># Arrange: Configure the gateway to raise an exception</span>
    <span class="n">mock_gateway_instance</span> <span class="o">=</span> <span class="n">mock_gateway_class</span><span class="o">.</span><span class="n">return_value</span>
    <span class="n">mock_gateway_instance</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">GatewayError</span><span class="p">(</span><span class="s2">&quot;Connection timed out&quot;</span><span class="p">)</span>
    <span class="n">mock_notifier_instance</span> <span class="o">=</span> <span class="n">mock_notifier_class</span><span class="o">.</span><span class="n">return_value</span>

    <span class="c1"># Act &amp; Assert: Use pytest.raises to check for the exception</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">GatewayError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Connection timed out&quot;</span><span class="p">):</span>
        <span class="n">process_order</span><span class="p">(</span><span class="s2">&quot;order_999&quot;</span><span class="p">,</span> <span class="s2">&quot;error@example.com&quot;</span><span class="p">,</span> <span class="s2">&quot;tok_error&quot;</span><span class="p">,</span> <span class="mf">200.00</span><span class="p">)</span>

    <span class="c1"># Assert that the notifier was not called in this case either</span>
    <span class="n">mock_notifier_instance</span><span class="o">.</span><span class="n">send_receipt</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</code></pre></div>

<p>These tests now pass and give us confidence that our <code>process_order</code> function correctly handles two critical failure modes. Mocks made this trivial to test; trying to test this with a real payment gateway would be nearly impossible.</p>
<h2 id="combining-mocks-and-fixtures">Combining Mocks and Fixtures</h2>
<h2 id="the-pytest-way-mocks-as-fixtures">The Pytest Way: Mocks as Fixtures</h2>
<p>Using multiple <code>@patch</code> decorators on every test function works, but it has some drawbacks:
-   <strong>Verbosity:</strong> The decorators stack up, adding boilerplate to each test.
-   <strong>Repetition:</strong> If many tests need the same mock setup, you're repeating the <code>@patch</code> lines everywhere.
-   <strong>Argument Ordering:</strong> You have to remember the reverse order of arguments (<code>@patch('A')</code>, <code>@patch('B')</code> means the test signature is <code>def test(mock_B, mock_A):</code>). This is a common source of bugs.</p>
<p>Pytest's fixture system provides a much cleaner and more maintainable way to manage mocks. We can move the patching logic inside a fixture. The <code>patch</code> object can also be used as a context manager, which is perfect for fixtures.</p>
<h3 id="iteration-4-refactoring-to-fixtures">Iteration 4: Refactoring to Fixtures</h3>
<p><strong>Current Limitation:</strong> Our tests are becoming repetitive with multiple <code>@patch</code> decorators.</p>
<p><strong>Goal:</strong> Encapsulate the mock setup into reusable fixtures to make tests cleaner and more declarative.</p>
<p>Let's create two fixtures, <code>mock_gateway</code> and <code>mock_notifier</code>, in our test file.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_orders_fixtures.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.orders</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_order</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture to mock the PaymentGateway.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;src.orders.PaymentGateway&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_gateway_class</span><span class="p">:</span>
        <span class="n">mock_instance</span> <span class="o">=</span> <span class="n">mock_gateway_class</span><span class="o">.</span><span class="n">return_value</span>
        <span class="k">yield</span> <span class="n">mock_instance</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_notifier</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture to mock the NotificationService.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;src.orders.NotificationService&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_notifier_class</span><span class="p">:</span>
        <span class="n">mock_instance</span> <span class="o">=</span> <span class="n">mock_notifier_class</span><span class="o">.</span><span class="n">return_value</span>
        <span class="k">yield</span> <span class="n">mock_instance</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_success_with_fixtures</span><span class="p">(</span><span class="n">mock_gateway</span><span class="p">,</span> <span class="n">mock_notifier</span><span class="p">):</span>
    <span class="c1"># Arrange</span>
    <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;tx_fixture_123&quot;</span>

    <span class="c1"># Act</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_order</span><span class="p">(</span>
        <span class="n">order_id</span><span class="o">=</span><span class="s2">&quot;order_fixture&quot;</span><span class="p">,</span>
        <span class="n">customer_email</span><span class="o">=</span><span class="s2">&quot;fixture@example.com&quot;</span><span class="p">,</span>
        <span class="n">card_details</span><span class="o">=</span><span class="s2">&quot;tok_fixture&quot;</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">50.00</span>
    <span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;Order processed successfully.&quot;</span>
    <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;tok_fixture&quot;</span><span class="p">,</span> <span class="mf">50.00</span><span class="p">)</span>
    <span class="n">mock_notifier</span><span class="o">.</span><span class="n">send_receipt</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="s2">&quot;fixture@example.com&quot;</span><span class="p">,</span> <span class="s2">&quot;tx_fixture_123&quot;</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_payment_declined_with_fixtures</span><span class="p">(</span><span class="n">mock_gateway</span><span class="p">,</span> <span class="n">mock_notifier</span><span class="p">):</span>
    <span class="c1"># Arrange</span>
    <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># Simulate failure</span>

    <span class="c1"># Act</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_order</span><span class="p">(</span><span class="s2">&quot;order_fail&quot;</span><span class="p">,</span> <span class="s2">&quot;fail_fixture@example.com&quot;</span><span class="p">,</span> <span class="s2">&quot;tok_declined&quot;</span><span class="p">,</span> <span class="mf">75.00</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;Payment failed.&quot;</span>
    <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;tok_declined&quot;</span><span class="p">,</span> <span class="mf">75.00</span><span class="p">)</span>
    <span class="n">mock_notifier</span><span class="o">.</span><span class="n">send_receipt</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</code></pre></div>

<p>This is a significant improvement.
-   <strong>Declarative:</strong> The test function now clearly states its dependencies: <code>mock_gateway</code> and <code>mock_notifier</code>.
-   <strong>Clean:</strong> The test body contains only the logic relevant to that specific test case (Arrange, Act, Assert). The boilerplate of patching is hidden in the fixtures.
-   <strong>Reusable:</strong> These fixtures can be used by any test in the file. If you move them to a <code>conftest.py</code> file, they can be used by your entire test suite.</p>
<p>This pattern of wrapping <code>patch</code> in a fixture is the idiomatic way to use <code>unittest.mock</code> with pytest.</p>
<h3 id="synthesis-the-complete-journey">Synthesis: The Complete Journey</h3>
<p>Let's review our progress. We started with a slow, unreliable integration test and progressively refined it into a fast, robust, and maintainable suite of unit tests.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Iteration</th>
<th style="text-align: left;">Failure Mode / Limitation</th>
<th style="text-align: left;">Technique Applied</th>
<th style="text-align: left;">Result</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">0</td>
<td style="text-align: left;">Test is slow (~3s) and unreliable.</td>
<td style="text-align: left;">None (direct call to real services)</td>
<td style="text-align: left;">An integration test, not a unit test.</td>
</tr>
<tr>
<td style="text-align: left;">1</td>
<td style="text-align: left;">Slowness and unreliability.</td>
<td style="text-align: left;"><code>@patch</code> decorator</td>
<td style="text-align: left;">Test is fast (~0.02s) but doesn't verify interactions.</td>
</tr>
<tr>
<td style="text-align: left;">2</td>
<td style="text-align: left;">Test passes but doesn't prove correctness.</td>
<td style="text-align: left;"><code>assert_called_with</code></td>
<td style="text-align: left;">Test now verifies that dependencies are called with correct arguments.</td>
</tr>
<tr>
<td style="text-align: left;">3</td>
<td style="text-align: left;">Only the "happy path" is tested.</td>
<td style="text-align: left;"><code>return_value</code> and <code>side_effect</code> for failures</td>
<td style="text-align: left;">Test suite now covers success, decline, and exception scenarios.</td>
</tr>
<tr>
<td style="text-align: left;">4</td>
<td style="text-align: left;">Test setup is verbose and repetitive (<code>@patch</code> stack).</td>
<td style="text-align: left;"><code>patch</code> as a context manager inside fixtures</td>
<td style="text-align: left;">Tests are clean, declarative, and setup logic is reusable.</td>
</tr>
</tbody>
</table>
<h3 id="final-implementation">Final Implementation</h3>
<p>Here is what a final, production-ready test file for our <code>process_order</code> function might look like, using all the techniques we've learned.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/final/test_orders.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.orders</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_order</span>

<span class="c1"># A custom exception for testing error paths</span>
<span class="k">class</span><span class="w"> </span><span class="nc">GatewayError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture to mock the PaymentGateway, returning the instance.&quot;&quot;&quot;</span>
    <span class="c1"># Using autospec=True is a best practice. It ensures the mock has the same</span>
    <span class="c1"># API as the real object. If you try to call a non-existent method,</span>
    <span class="c1"># your test will fail.</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;src.orders.PaymentGateway&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_gateway_class</span><span class="p">:</span>
        <span class="n">mock_instance</span> <span class="o">=</span> <span class="n">mock_gateway_class</span><span class="o">.</span><span class="n">return_value</span>
        <span class="k">yield</span> <span class="n">mock_instance</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_notifier</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture to mock the NotificationService, returning the instance.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;src.orders.NotificationService&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_notifier_class</span><span class="p">:</span>
        <span class="n">mock_instance</span> <span class="o">=</span> <span class="n">mock_notifier_class</span><span class="o">.</span><span class="n">return_value</span>
        <span class="k">yield</span> <span class="n">mock_instance</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_success</span><span class="p">(</span><span class="n">mock_gateway</span><span class="p">,</span> <span class="n">mock_notifier</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests the successful order processing path.&quot;&quot;&quot;</span>
    <span class="c1"># Arrange</span>
    <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;tx_final_123&quot;</span>

    <span class="c1"># Act</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_order</span><span class="p">(</span><span class="s2">&quot;order_final&quot;</span><span class="p">,</span> <span class="s2">&quot;final@example.com&quot;</span><span class="p">,</span> <span class="s2">&quot;tok_final&quot;</span><span class="p">,</span> <span class="mf">99.99</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;Order processed successfully.&quot;</span>
    <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;tok_final&quot;</span><span class="p">,</span> <span class="mf">99.99</span><span class="p">)</span>
    <span class="n">mock_notifier</span><span class="o">.</span><span class="n">send_receipt</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;final@example.com&quot;</span><span class="p">,</span> <span class="s2">&quot;tx_final_123&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_payment_declined</span><span class="p">(</span><span class="n">mock_gateway</span><span class="p">,</span> <span class="n">mock_notifier</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests the path where payment is declined.&quot;&quot;&quot;</span>
    <span class="c1"># Arrange</span>
    <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># Act</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_order</span><span class="p">(</span><span class="s2">&quot;order_declined&quot;</span><span class="p">,</span> <span class="s2">&quot;declined@example.com&quot;</span><span class="p">,</span> <span class="s2">&quot;tok_declined&quot;</span><span class="p">,</span> <span class="mf">150.00</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;Payment failed.&quot;</span>
    <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;tok_declined&quot;</span><span class="p">,</span> <span class="mf">150.00</span><span class="p">)</span>
    <span class="n">mock_notifier</span><span class="o">.</span><span class="n">send_receipt</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_gateway_exception</span><span class="p">(</span><span class="n">mock_gateway</span><span class="p">,</span> <span class="n">mock_notifier</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests that an exception from the gateway is propagated.&quot;&quot;&quot;</span>
    <span class="c1"># Arrange</span>
    <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">GatewayError</span><span class="p">(</span><span class="s2">&quot;Gateway is down&quot;</span><span class="p">)</span>

    <span class="c1"># Act &amp; Assert</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">GatewayError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Gateway is down&quot;</span><span class="p">):</span>
        <span class="n">process_order</span><span class="p">(</span><span class="s2">&quot;order_error&quot;</span><span class="p">,</span> <span class="s2">&quot;error@example.com&quot;</span><span class="p">,</span> <span class="s2">&quot;tok_error&quot;</span><span class="p">,</span> <span class="mf">250.00</span><span class="p">)</span>

    <span class="n">mock_notifier</span><span class="o">.</span><span class="n">send_receipt</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</code></pre></div>
        </div>
        <div class="footer">
            Generated on 2025-11-24 14:31:15 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>