<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>08 Mocking with unittest.mock</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">03 Mocking and Isolation</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-8-mocking-with-unittestmock">Chapter 8: Mocking with unittest.mock</h1>
<h2 id="why-mock">Why Mock?</h2>
<h2 id="why-mock_1">Why Mock?</h2>
<p>Testing in isolation is one of the fundamental principles of effective unit testing. When you test a function, you want to verify <em>that specific function's behavior</em>‚Äînot the behavior of every external system it touches. But real-world code rarely exists in isolation. Functions call APIs, query databases, send emails, read files, and interact with countless external dependencies.</p>
<p>Consider this payment processing function:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_processor.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="n">card_number</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;USD&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process a payment through external payment gateway.&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;https://api.payment-gateway.com/charge&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;card&quot;</span><span class="p">:</span> <span class="n">card_number</span><span class="p">,</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">},</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">transaction_id</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">transaction_id</span><span class="p">,</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown error&quot;</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>

<p>How do you test this function? If you run it directly in your tests, you face several problems:</p>
<h3 id="the-problems-with-testing-real-dependencies">The Problems with Testing Real Dependencies</h3>
<p><strong>Problem 1: External Service Dependency</strong></p>
<p>Your tests require a live payment gateway API. This means:
- Tests fail when your internet connection drops
- Tests fail when the API is down for maintenance
- Tests fail when the API changes its behavior
- You can't run tests offline or in isolated environments</p>
<p><strong>Problem 2: Side Effects</strong></p>
<p>Every test run charges real credit cards. This means:
- You need test credit card numbers that work with the real API
- You might accidentally charge real money
- You create transaction records in production systems
- You can't test error scenarios without triggering real failures</p>
<p><strong>Problem 3: Speed</strong></p>
<p>Network calls are slow. A single API call might take 500ms-2000ms. If you have 100 tests that each make API calls, your test suite takes minutes instead of seconds.</p>
<p><strong>Problem 4: Unpredictability</strong></p>
<p>External services are inherently unpredictable:
- Network latency varies
- API responses might differ based on time of day, rate limits, or server load
- You can't reliably test edge cases (what happens when the API returns a 503?)
- Tests become "flaky"‚Äîpassing sometimes, failing other times</p>
<h3 id="the-solution-mocking">The Solution: Mocking</h3>
<p>Mocking solves all these problems by replacing external dependencies with controlled substitutes. Instead of making a real HTTP request, your test uses a fake <code>requests.post()</code> that returns exactly what you tell it to return.</p>
<p>With mocking, you can:
- Test without network access
- Run tests in milliseconds instead of seconds
- Simulate any response scenario (success, failure, timeout, malformed data)
- Verify that your code calls external services correctly
- Test in complete isolation</p>
<h3 id="what-mocking-is-not">What Mocking Is NOT</h3>
<p>Before we dive deeper, let's clarify what mocking is <em>not</em>:</p>
<p><strong>Mocking is not cheating.</strong> You're not skipping tests‚Äîyou're testing your code's logic in isolation from external systems.</p>
<p><strong>Mocking is not testing fake behavior.</strong> You're testing real code with controlled inputs. The logic inside <code>process_payment()</code> executes normally; only the external call is replaced.</p>
<p><strong>Mocking is not a replacement for integration tests.</strong> You still need tests that verify your code works with real external systems. Mocking is for <em>unit</em> tests‚Äîtesting individual components in isolation.</p>
<h3 id="when-to-mock">When to Mock</h3>
<p>Mock external dependencies when:
- The dependency is outside your control (APIs, databases, file systems)
- The dependency is slow (network calls, disk I/O)
- The dependency has side effects (sending emails, charging cards, deleting data)
- You need to test error scenarios that are hard to trigger naturally
- You want fast, reliable, repeatable tests</p>
<p>Don't mock when:
- Testing the integration between your code and the external system (use integration tests)
- The "dependency" is a simple, pure function in your own codebase
- Mocking would make the test more complex than the code being tested</p>
<h3 id="the-path-ahead">The Path Ahead</h3>
<p>In this chapter, we'll build a complete understanding of mocking by:</p>
<ol>
<li>Understanding what mocks are and how they work</li>
<li>Creating simple mocks to replace functions</li>
<li>Using <code>@patch</code> to intercept function calls</li>
<li>Verifying that mocked functions were called correctly</li>
<li>Controlling mock behavior with return values and side effects</li>
<li>Integrating mocks with pytest fixtures for reusable test infrastructure</li>
</ol>
<p>We'll use the <code>process_payment()</code> function as our anchor example, progressively refining our tests to handle increasingly complex scenarios. Each iteration will expose a limitation, demonstrate the failure, and introduce the technique that solves it.</p>
<h2 id="what-is-a-mock">What Is a Mock?</h2>
<h2 id="what-is-a-mock_1">What Is a Mock?</h2>
<p>A mock is a programmable substitute for a real object. It looks like the real thing, responds like the real thing, but is completely under your control. Think of it as a stunt double for your dependencies‚Äîit stands in during testing so the real dependency doesn't have to show up.</p>
<h3 id="the-anatomy-of-a-mock">The Anatomy of a Mock</h3>
<p>Let's start by examining what a mock object actually is. We'll create one manually to understand its structure before using Python's built-in mocking tools.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_mock_basics.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_mock_is_callable</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A mock can be called like a function.&quot;&quot;&quot;</span>
    <span class="n">mock_function</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="c1"># You can call it with any arguments</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">mock_function</span><span class="p">(</span><span class="s2">&quot;any&quot;</span><span class="p">,</span> <span class="s2">&quot;arguments&quot;</span><span class="p">,</span> <span class="n">keyword</span><span class="o">=</span><span class="s2">&quot;work&quot;</span><span class="p">)</span>

    <span class="c1"># By default, it returns another Mock</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Mock</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Called mock, got: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Run this test to see the basic behavior:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_mock_basics.py::test_mock_is_callable<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>test_mock_basics.py::test_mock_is_callable PASSED
Called mock, got: &lt;Mock name=&#39;mock()&#39; id=&#39;140234567890&#39;&gt;
</code></pre></div>

<p>The mock accepted any arguments and returned another mock. This is the fundamental behavior: <strong>mocks are infinitely flexible</strong>. They accept any call, return mocks for any attribute access, and never complain.</p>
<h3 id="configuring-mock-return-values">Configuring Mock Return Values</h3>
<p>The default behavior (returning another mock) isn't useful for testing. We need mocks to return specific values that our code expects.</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_mock_with_return_value</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configure what a mock returns.&quot;&quot;&quot;</span>
    <span class="n">mock_function</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">mock_function</span><span class="p">(</span><span class="s2">&quot;any&quot;</span><span class="p">,</span> <span class="s2">&quot;arguments&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">42</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mock returned: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Now the mock returns exactly what we configured. This is how we simulate successful API responses, database queries, or any other function call.</p>
<h3 id="mocks-record-their-interactions">Mocks Record Their Interactions</h3>
<p>The real power of mocks is that they remember how they were used. This lets you verify that your code called dependencies correctly.</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_mock_records_calls</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mocks remember how they were called.&quot;&quot;&quot;</span>
    <span class="n">mock_function</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="s2">&quot;success&quot;</span><span class="p">)</span>

    <span class="c1"># Call the mock</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">mock_function</span><span class="p">(</span><span class="s2">&quot;test_arg&quot;</span><span class="p">,</span> <span class="n">keyword</span><span class="o">=</span><span class="s2">&quot;test_value&quot;</span><span class="p">)</span>

    <span class="c1"># Verify it was called</span>
    <span class="k">assert</span> <span class="n">mock_function</span><span class="o">.</span><span class="n">called</span>
    <span class="k">assert</span> <span class="n">mock_function</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="c1"># Verify it was called with specific arguments</span>
    <span class="n">mock_function</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;test_arg&quot;</span><span class="p">,</span> <span class="n">keyword</span><span class="o">=</span><span class="s2">&quot;test_value&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mock was called: </span><span class="si">{</span><span class="n">mock_function</span><span class="o">.</span><span class="n">called</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Call count: </span><span class="si">{</span><span class="n">mock_function</span><span class="o">.</span><span class="n">call_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Called with: </span><span class="si">{</span><span class="n">mock_function</span><span class="o">.</span><span class="n">call_args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>Mock was called: True
Call count: 1
Called with: call(&#39;test_arg&#39;, keyword=&#39;test_value&#39;)
</code></pre></div>

<p>The mock tracked:
- Whether it was called at all (<code>called</code>)
- How many times it was called (<code>call_count</code>)
- What arguments it received (<code>call_args</code>)</p>
<h3 id="mocks-have-attributes-too">Mocks Have Attributes Too</h3>
<p>Mocks can simulate objects with attributes and methods, not just standalone functions.</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_mock_with_attributes</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mocks can have attributes and methods.&quot;&quot;&quot;</span>
    <span class="n">mock_api_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_api_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">mock_api_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">}</span>

    <span class="c1"># Use it like a real response object</span>
    <span class="k">assert</span> <span class="n">mock_api_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">mock_api_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;txn_12345&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status: </span><span class="si">{</span><span class="n">mock_api_response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JSON data: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>This mock simulates an HTTP response object with a <code>status_code</code> attribute and a <code>json()</code> method. This is exactly what <code>requests.post()</code> returns, so we can use this mock to test code that processes API responses.</p>
<h3 id="the-mock-hierarchy">The Mock Hierarchy</h3>
<p>When you access an attribute on a mock that hasn't been configured, you get another mock:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_mock_attribute_chain</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unconfigured attributes return new mocks.&quot;&quot;&quot;</span>
    <span class="n">mock_obj</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="c1"># Access a chain of attributes</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">mock_obj</span><span class="o">.</span><span class="n">some</span><span class="o">.</span><span class="n">deeply</span><span class="o">.</span><span class="n">nested</span><span class="o">.</span><span class="n">attribute</span><span class="p">()</span>

    <span class="c1"># Each step returns a mock</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mock_obj</span><span class="o">.</span><span class="n">some</span><span class="p">,</span> <span class="n">Mock</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mock_obj</span><span class="o">.</span><span class="n">some</span><span class="o">.</span><span class="n">deeply</span><span class="p">,</span> <span class="n">Mock</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Mock</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mock_obj.some: </span><span class="si">{</span><span class="n">mock_obj</span><span class="o">.</span><span class="n">some</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mock_obj.some.deeply: </span><span class="si">{</span><span class="n">mock_obj</span><span class="o">.</span><span class="n">some</span><span class="o">.</span><span class="n">deeply</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>This "infinite mock" behavior is useful for mocking complex objects without configuring every possible attribute. However, it can also hide bugs‚Äîif you misspell an attribute name, the mock won't complain.</p>
<h3 id="comparing-mocks-to-real-objects">Comparing Mocks to Real Objects</h3>
<p>Let's see the difference between a real object and a mock side by side:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_real_vs_mock_response</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compare a real response object to a mock.&quot;&quot;&quot;</span>
    <span class="c1"># Create a mock that mimics requests.Response</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">}</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;{&quot;message&quot;: &quot;success&quot;}&#39;</span>

    <span class="c1"># The mock behaves like a real response</span>
    <span class="k">assert</span> <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">}</span>

    <span class="c1"># But it&#39;s not the same type</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mock type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">mock_response</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real response type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mock status_code: </span><span class="si">{</span><span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mock json(): </span><span class="si">{</span><span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nx">Mock</span><span class="w"> </span><span class="k">type</span><span class="p">:</span><span class="w"> </span><span class="p">&lt;</span><span class="kd">class</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">unittest</span><span class="p">.</span><span class="nx">mock</span><span class="p">.</span><span class="nx">Mock</span><span class="err">&#39;</span><span class="p">&gt;</span>
<span class="nx">Real</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="k">type</span><span class="p">:</span><span class="w"> </span><span class="p">&lt;</span><span class="kd">class</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">requests</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">Response</span><span class="err">&#39;</span><span class="p">&gt;</span>
<span class="nx">Mock</span><span class="w"> </span><span class="nx">status_code</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span>
<span class="nx">Mock</span><span class="w"> </span><span class="nx">json</span><span class="p">():</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">message</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">success</span><span class="err">&#39;</span><span class="p">}</span>
</code></pre></div>

<p>The mock isn't a <code>requests.Response</code> object, but it has the same interface. For testing purposes, that's all we need.</p>
<h3 id="when-mocks-fail-the-spec-parameter">When Mocks Fail: The Spec Parameter</h3>
<p>The infinite flexibility of mocks can be dangerous. If you misspell a method name, the mock won't tell you:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_mock_without_spec_hides_errors</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mocks accept any attribute access, even typos.&quot;&quot;&quot;</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>

    <span class="c1"># Typo: should be .json() not .jsno()</span>
    <span class="c1"># The mock doesn&#39;t complain!</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">mock_response</span><span class="o">.</span><span class="n">jsno</span><span class="p">()</span>

    <span class="c1"># This passes, but it shouldn&#39;t</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Mock</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Typo returned: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>This test passes, but it's testing the wrong thing. The real code calls <code>.json()</code>, not <code>.jsno()</code>. The mock's flexibility hid our mistake.</p>
<p>The solution is to use <code>spec</code> to restrict the mock to match a real object's interface:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_mock_with_spec_catches_errors</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Spec restricts mocks to real object interfaces.&quot;&quot;&quot;</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">)</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">}</span>

    <span class="c1"># This works - json() exists on Response</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">}</span>

    <span class="c1"># This would raise AttributeError - jsno() doesn&#39;t exist</span>
    <span class="c1"># Uncomment to see the error:</span>
    <span class="c1"># mock_response.jsno()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valid method call succeeded: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>With <code>spec=requests.Response</code>, the mock only allows attributes and methods that exist on the real <code>Response</code> class. Typos now raise <code>AttributeError</code> immediately.</p>
<h3 id="summary-what-weve-learned">Summary: What We've Learned</h3>
<p>A mock is:
- A programmable substitute for real objects
- Callable with any arguments (by default)
- Configurable to return specific values
- Capable of recording all interactions
- Able to simulate attributes and methods
- Infinitely flexible (which can be dangerous)
- Constrainable with <code>spec</code> to match real interfaces</p>
<p>In the next section, we'll use these building blocks to create mocks for our <code>process_payment()</code> function, replacing the real <code>requests.post()</code> call with a controlled substitute.</p>
<h2 id="creating-mocks-with-mock">Creating Mocks with Mock()</h2>
<h2 id="creating-mocks-with-mock_1">Creating Mocks with Mock()</h2>
<p>Now that we understand what mocks are, let's use them to test real code. We'll return to our payment processing function and progressively build a complete test suite using mocks.</p>
<h3 id="phase-1-the-reference-implementation">Phase 1: The Reference Implementation</h3>
<p>Here's our payment processor again, which will serve as our anchor example throughout this chapter:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_processor.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="n">card_number</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;USD&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process a payment through external payment gateway.&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;https://api.payment-gateway.com/charge&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;card&quot;</span><span class="p">:</span> <span class="n">card_number</span><span class="p">,</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">},</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">transaction_id</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">transaction_id</span><span class="p">,</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown error&quot;</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>

<p>Our goal is to test this function without making real HTTP requests. We need to replace <code>requests.post()</code> with a mock that returns controlled responses.</p>
<h3 id="iteration-0-the-naive-approach-no-mocking">Iteration 0: The Naive Approach (No Mocking)</h3>
<p>Let's first try testing without mocks to see why we need them:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_naive.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_payment</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_successful_payment_naive</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Attempt to test without mocking.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="s2">&quot;transaction_id&quot;</span> <span class="ow">in</span> <span class="n">result</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">100.00</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_naive.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>test_payment_naive.py::test_successful_payment_naive FAILED

================================ FAILURES =================================
________________________ test_successful_payment_naive ________________________

    def test_successful_payment_naive():
        &quot;&quot;&quot;Attempt to test without mocking.&quot;&quot;&quot;
<span class="k">&gt; </span><span class="ge">      result = process_payment(&quot;4111111111111111&quot;, 100.00)</span>

test_payment_naive.py:5: 
<span class="ge">_ _</span> _ <span class="ge">_ _</span> _ <span class="ge">_ _</span> _ <span class="ge">_ _</span> _ <span class="ge">_ _</span> _ <span class="ge">_ _</span> _ <span class="ge">_ _</span> _ <span class="ge">_ _</span> _ <span class="ge">_ _</span> _ <span class="ge">_ _</span> _ <span class="ge">_ _</span> _ <span class="ge">_ _</span> _ <span class="ge">_ _</span>

    response = requests.post(
        &quot;https://api.payment-gateway.com/charge&quot;,
        ...
    )

E   requests.exceptions.ConnectionError: HTTPSConnectionPool(host=&#39;api.payment-gateway.com&#39;, port=443): 
    Max retries exceeded with url: /charge (Caused by NewConnectionError(
    &#39;&lt;urllib3.connection.HTTPSConnection object at 0x7f8b8c0d4d90&gt;: 
    Failed to establish a new connection: [Errno -2] Name or service not known&#39;))
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-failure">Diagnostic Analysis: Reading the Failure</h3>
<p><strong>The complete output tells us</strong>:</p>
<ol>
<li><strong>The summary line</strong>: <code>FAILED test_payment_naive.py::test_successful_payment_naive</code></li>
<li>
<p>The test failed during execution, not during collection</p>
</li>
<li>
<p><strong>The traceback</strong>:</p>
</li>
<li>The failure occurred inside <code>process_payment()</code> when calling <code>requests.post()</code></li>
<li>
<p>The error is <code>requests.exceptions.ConnectionError</code></p>
</li>
<li>
<p><strong>The error details</strong>:</p>
</li>
<li>"Failed to establish a new connection"</li>
<li>"Name or service not known"</li>
<li>This means the test tried to make a real HTTP request to a non-existent domain</li>
</ol>
<p><strong>Root cause identified</strong>: The test is attempting real network communication.</p>
<p><strong>Why the current approach can't solve this</strong>: We can't make the domain exist or guarantee network availability in tests.</p>
<p><strong>What we need</strong>: A way to intercept the <code>requests.post()</code> call and return a fake response without touching the network.</p>
<h3 id="iteration-1-manual-mock-injection">Iteration 1: Manual Mock Injection</h3>
<p>Our first attempt will manually pass a mock into the function. This requires modifying the function to accept an optional dependency:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_processor_injectable.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="n">card_number</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;USD&quot;</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process a payment through external payment gateway.</span>

<span class="sd">    Args:</span>
<span class="sd">        http_client: Optional HTTP client for testing (defaults to requests)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">http_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">http_client</span> <span class="o">=</span> <span class="n">requests</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">http_client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;https://api.payment-gateway.com/charge&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;card&quot;</span><span class="p">:</span> <span class="n">card_number</span><span class="p">,</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">},</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">transaction_id</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">transaction_id</span><span class="p">,</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown error&quot;</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>

<p>Now we can inject a mock:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_injectable.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor_injectable</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_payment</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_successful_payment_with_injection</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test by injecting a mock HTTP client.&quot;&quot;&quot;</span>
    <span class="c1"># Create a mock HTTP client</span>
    <span class="n">mock_client</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="c1"># Configure the mock response</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">}</span>

    <span class="c1"># Make the mock client return our mock response</span>
    <span class="n">mock_client</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>

    <span class="c1"># Inject the mock</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="n">http_client</span><span class="o">=</span><span class="n">mock_client</span><span class="p">)</span>

    <span class="c1"># Verify the result</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;txn_12345&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">100.00</span>

    <span class="c1"># Verify the mock was called correctly</span>
    <span class="n">mock_client</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">call_args</span> <span class="o">=</span> <span class="n">mock_client</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">call_args</span>
    <span class="k">assert</span> <span class="n">call_args</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;https://api.payment-gateway.com/charge&quot;</span>
    <span class="k">assert</span> <span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">][</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">100.00</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_injectable.py::test_successful_payment_with_injection<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>test_payment_injectable.py::test_successful_payment_with_injection PASSED
</code></pre></div>

<p>Success! The test passes without making network requests. Let's analyze what happened:</p>
<ol>
<li>We created a mock HTTP client with <code>Mock()</code></li>
<li>We created a mock response object with the expected attributes</li>
<li>We configured <code>mock_client.post</code> to return our mock response</li>
<li>We injected the mock into the function</li>
<li>The function executed normally, using our mock instead of real <code>requests</code></li>
<li>We verified both the result and that the mock was called correctly</li>
</ol>
<h3 id="current-limitation-requires-code-modification">Current Limitation: Requires Code Modification</h3>
<p>This approach works, but it has a significant drawback: <strong>we had to modify the production code to accept an optional dependency</strong>. The <code>http_client</code> parameter exists solely for testing. This is called "dependency injection," and while it's a valid pattern, it's not always desirable:</p>
<ul>
<li>It clutters the function signature</li>
<li>It exposes internal implementation details</li>
<li>It requires all callers to know about this testing parameter</li>
<li>It doesn't work for code you don't control (third-party libraries)</li>
</ul>
<p><strong>What we need</strong>: A way to replace <code>requests.post()</code> without modifying the function signature.</p>
<h3 id="iteration-2-direct-mock-assignment">Iteration 2: Direct Mock Assignment</h3>
<p>Python's dynamic nature allows us to replace module-level objects at runtime:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_direct_mock.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">payment_processor</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_successful_payment_direct_replacement</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test by directly replacing requests.post.&quot;&quot;&quot;</span>
    <span class="c1"># Save the original</span>
    <span class="n">original_post</span> <span class="o">=</span> <span class="n">payment_processor</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">post</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Create and configure mock response</span>
        <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">}</span>

        <span class="c1"># Create mock post function</span>
        <span class="n">mock_post</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="n">mock_response</span><span class="p">)</span>

        <span class="c1"># Replace requests.post in the payment_processor module</span>
        <span class="n">payment_processor</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">post</span> <span class="o">=</span> <span class="n">mock_post</span>

        <span class="c1"># Now test the function</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">payment_processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;txn_12345&quot;</span>

        <span class="c1"># Verify the mock was called</span>
        <span class="n">mock_post</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Restore the original</span>
        <span class="n">payment_processor</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">post</span> <span class="o">=</span> <span class="n">original_post</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_direct_mock.py::test_successful_payment_direct_replacement<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>test_payment_direct_mock.py::test_successful_payment_direct_replacement PASSED
</code></pre></div>

<p>This works! We replaced <code>requests.post</code> directly in the module where it's used. The function doesn't need modification.</p>
<h3 id="current-limitation-manual-cleanup-required">Current Limitation: Manual Cleanup Required</h3>
<p>This approach has problems:</p>
<ol>
<li><strong>Verbose</strong>: Lots of boilerplate for saving, replacing, and restoring</li>
<li><strong>Error-prone</strong>: If the test fails before the <code>finally</code> block, cleanup might not happen</li>
<li><strong>Repetitive</strong>: Every test needs this same setup/teardown pattern</li>
</ol>
<p><strong>What we need</strong>: A cleaner way to temporarily replace objects that automatically handles cleanup.</p>
<p>This is exactly what <code>@patch</code> provides, which we'll explore in the next section.</p>
<h3 id="summary-what-weve-learned_1">Summary: What We've Learned</h3>
<p>We've seen three approaches to mocking:</p>
<ol>
<li><strong>No mocking</strong>: Tests fail due to external dependencies</li>
<li><strong>Dependency injection</strong>: Works but requires code modification</li>
<li><strong>Direct replacement</strong>: Works without code modification but requires manual cleanup</li>
</ol>
<p>Key insights:
- Mocks simulate objects by providing the same interface
- Configure mocks with <code>return_value</code> to control what they return
- Mocks record calls so you can verify interactions
- Direct replacement works but needs careful cleanup</p>
<p>The next section introduces <code>@patch</code>, which automates the replacement and cleanup process.</p>
<h2 id="patching-functions-with-patch">Patching Functions with @patch</h2>
<h2 id="patching-functions-with-patch_1">Patching Functions with @patch</h2>
<p>The <code>@patch</code> decorator automates the process of replacing objects during tests and restoring them afterward. It's the standard way to mock in Python testing.</p>
<h3 id="understanding-patch-targets">Understanding Patch Targets</h3>
<p>Before using <code>@patch</code>, you must understand <em>where</em> to patch. This is the most common source of confusion with mocking.</p>
<p><strong>The Golden Rule</strong>: Patch where the object is <em>used</em>, not where it's <em>defined</em>.</p>
<p>Consider our payment processor:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_processor.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>  <span class="c1"># requests is defined in the requests module</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="n">card_number</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;USD&quot;</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>  <span class="c1"># requests is used here</span>
</code></pre></div>

<p>When <code>process_payment()</code> executes, it looks up <code>requests</code> in its own module's namespace (<code>payment_processor.requests</code>), not in the original <code>requests</code> module. Therefore, we must patch <code>payment_processor.requests</code>, not <code>requests.requests</code>.</p>
<h3 id="iteration-3-basic-patch-usage">Iteration 3: Basic @patch Usage</h3>
<p>Let's rewrite our test using <code>@patch</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_with_patch.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span><span class="p">,</span> <span class="n">Mock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_payment</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor.requests.post&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_successful_payment_with_patch</span><span class="p">(</span><span class="n">mock_post</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test using @patch decorator.&quot;&quot;&quot;</span>
    <span class="c1"># Configure the mock response</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">}</span>

    <span class="c1"># Configure mock_post to return our response</span>
    <span class="n">mock_post</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>

    <span class="c1"># Call the function</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

    <span class="c1"># Verify the result</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;txn_12345&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">100.00</span>

    <span class="c1"># Verify the mock was called correctly</span>
    <span class="n">mock_post</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">call_args</span> <span class="o">=</span> <span class="n">mock_post</span><span class="o">.</span><span class="n">call_args</span>
    <span class="k">assert</span> <span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">][</span><span class="s2">&quot;card&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;4111111111111111&quot;</span>
    <span class="k">assert</span> <span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">][</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">100.00</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_with_patch.py::test_successful_payment_with_patch<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>test_payment_with_patch.py::test_successful_payment_with_patch PASSED
</code></pre></div>

<p>Let's break down what happened:</p>
<ol>
<li><code>@patch('payment_processor.requests.post')</code> replaces <code>requests.post</code> in the <code>payment_processor</code> module</li>
<li>The replacement (a <code>Mock</code> object) is passed as the <code>mock_post</code> parameter</li>
<li>We configure <code>mock_post</code> to return our mock response</li>
<li>The test runs with the mock in place</li>
<li>After the test completes, <code>@patch</code> automatically restores the original <code>requests.post</code></li>
</ol>
<h3 id="comparing-before-and-after">Comparing Before and After</h3>
<p><strong>Before (manual replacement)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">original</span> <span class="o">=</span> <span class="n">payment_processor</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">post</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">payment_processor</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">post</span> <span class="o">=</span> <span class="n">mock_post</span>
    <span class="c1"># test code</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">payment_processor</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">post</span> <span class="o">=</span> <span class="n">original</span>
</code></pre></div>

<p><strong>After (@patch)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor.requests.post&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_something</span><span class="p">(</span><span class="n">mock_post</span><span class="p">):</span>
    <span class="c1"># test code</span>
</code></pre></div>

<p>The decorator handles all the setup and teardown automatically.</p>
<h3 id="iteration-4-testing-error-scenarios">Iteration 4: Testing Error Scenarios</h3>
<p>Now let's test what happens when the payment gateway returns an error. We'll use the same mocking approach but configure a different response:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor.requests.post&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_failed_payment_with_patch</span><span class="p">(</span><span class="n">mock_post</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test payment failure scenario.&quot;&quot;&quot;</span>
    <span class="c1"># Configure mock to return error response</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">400</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid card number&quot;</span><span class="p">}</span>

    <span class="n">mock_post</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>

    <span class="c1"># Call the function</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;0000000000000000&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

    <span class="c1"># Verify error handling</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Invalid card number&quot;</span>

    <span class="c1"># Verify the request was still made</span>
    <span class="n">mock_post</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_with_patch.py::test_failed_payment_with_patch<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>test_payment_with_patch.py::test_failed_payment_with_patch PASSED
</code></pre></div>

<p>With mocking, we can easily test error scenarios that would be difficult or impossible to trigger with a real API.</p>
<h3 id="iteration-5-multiple-patches">Iteration 5: Multiple Patches</h3>
<p>What if we also want to control the timestamp? Our function calls <code>datetime.now()</code>, which returns the current time. This makes tests non-deterministic‚Äîthe exact timestamp changes with each run.</p>
<p>Let's patch both <code>requests.post</code> and <code>datetime.now</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor.datetime&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor.requests.post&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_with_fixed_timestamp</span><span class="p">(</span><span class="n">mock_post</span><span class="p">,</span> <span class="n">mock_datetime</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test with controlled timestamp.&quot;&quot;&quot;</span>
    <span class="c1"># Configure datetime mock</span>
    <span class="n">fixed_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">mock_datetime</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fixed_time</span>

    <span class="c1"># Configure response mock</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">}</span>
    <span class="n">mock_post</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>

    <span class="c1"># Call the function</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

    <span class="c1"># Verify the result</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>

    <span class="c1"># Verify the timestamp was used correctly</span>
    <span class="n">call_args</span> <span class="o">=</span> <span class="n">mock_post</span><span class="o">.</span><span class="n">call_args</span>
    <span class="n">expected_timestamp</span> <span class="o">=</span> <span class="s2">&quot;2024-01-15T10:30:00&quot;</span>
    <span class="k">assert</span> <span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">][</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_timestamp</span>
</code></pre></div>

<p><strong>Important</strong>: When stacking <code>@patch</code> decorators, they are applied <strong>bottom-to-top</strong>, but parameters are passed <strong>top-to-bottom</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;module.second&#39;</span><span class="p">)</span>  <span class="c1"># This becomes the second parameter</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;module.first&#39;</span><span class="p">)</span>   <span class="c1"># This becomes the first parameter</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_something</span><span class="p">(</span><span class="n">mock_first</span><span class="p">,</span> <span class="n">mock_second</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_with_patch.py::test_payment_with_fixed_timestamp<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>test_payment_with_patch.py::test_payment_with_fixed_timestamp PASSED
</code></pre></div>

<h3 id="iteration-6-patch-as-context-manager">Iteration 6: Patch as Context Manager</h3>
<p>Sometimes you need to patch only part of a test. Use <code>patch()</code> as a context manager:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_with_context_manager</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use patch as a context manager for fine-grained control.&quot;&quot;&quot;</span>
    <span class="c1"># Setup code without mocking</span>
    <span class="n">card_number</span> <span class="o">=</span> <span class="s2">&quot;4111111111111111&quot;</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="mf">100.00</span>

    <span class="c1"># Only mock during the actual call</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;payment_processor.requests.post&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_post</span><span class="p">:</span>
        <span class="c1"># Configure mock</span>
        <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">}</span>
        <span class="n">mock_post</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>

        <span class="c1"># Call function</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="n">card_number</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

        <span class="c1"># Assertions inside the context</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
        <span class="n">mock_post</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="c1"># Outside the context, requests.post is restored</span>
    <span class="c1"># (though we can&#39;t easily demonstrate this in a test)</span>
</code></pre></div>

<p>The context manager form is useful when:
- You need to patch only part of a test
- You want to make multiple calls with different mock configurations
- You're patching in setup code that isn't a test function</p>
<h3 id="iteration-7-patching-object-attributes">Iteration 7: Patching Object Attributes</h3>
<p>You can patch attributes, not just functions:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># config.py</span>
<span class="n">API_ENDPOINT</span> <span class="o">=</span> <span class="s2">&quot;https://api.payment-gateway.com/charge&quot;</span>
<span class="n">API_TIMEOUT</span> <span class="o">=</span> <span class="mi">30</span>

<span class="c1"># payment_processor_with_config.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">config</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="n">card_number</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;USD&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process payment using configuration.&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">API_ENDPOINT</span><span class="p">,</span>  <span class="c1"># Use config value</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;card&quot;</span><span class="p">:</span> <span class="n">card_number</span><span class="p">,</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">},</span>
        <span class="n">timeout</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">API_TIMEOUT</span>  <span class="c1"># Use config value</span>
    <span class="p">)</span>
    <span class="c1"># ... rest of function</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_with_config.py</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor_with_config.config.API_ENDPOINT&#39;</span><span class="p">,</span> <span class="s1">&#39;https://test-api.example.com&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor_with_config.config.API_TIMEOUT&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor_with_config.requests.post&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_uses_config</span><span class="p">(</span><span class="n">mock_post</span><span class="p">,</span> <span class="n">mock_timeout</span><span class="p">,</span> <span class="n">mock_endpoint</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that function uses configuration values.&quot;&quot;&quot;</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">}</span>
    <span class="n">mock_post</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

    <span class="c1"># Verify the mocked config values were used</span>
    <span class="n">call_args</span> <span class="o">=</span> <span class="n">mock_post</span><span class="o">.</span><span class="n">call_args</span>
    <span class="k">assert</span> <span class="n">call_args</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;https://test-api.example.com&#39;</span>
    <span class="k">assert</span> <span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span>
</code></pre></div>

<h3 id="common-patching-mistakes">Common Patching Mistakes</h3>
<h4 id="mistake-1-patching-in-the-wrong-place">Mistake 1: Patching in the Wrong Place</h4>
<p><strong>Wrong</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;requests.post&#39;</span><span class="p">)</span>  <span class="c1"># Patches requests module, not where it&#39;s used</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_payment</span><span class="p">(</span><span class="n">mock_post</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>
</code></pre></div>

<p>This doesn't work because <code>process_payment</code> looks up <code>requests</code> in its own namespace.</p>
<p><strong>Right</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor.requests.post&#39;</span><span class="p">)</span>  <span class="c1"># Patches where it&#39;s used</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_payment</span><span class="p">(</span><span class="n">mock_post</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>
</code></pre></div>

<h4 id="mistake-2-forgetting-to-configure-the-mock">Mistake 2: Forgetting to Configure the Mock</h4>
<p><strong>Wrong</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor.requests.post&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_payment</span><span class="p">(</span><span class="n">mock_post</span><span class="p">):</span>
    <span class="c1"># Forgot to configure mock_post!</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>
    <span class="c1"># result will contain Mock objects, not real data</span>
</code></pre></div>

<p><strong>Right</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor.requests.post&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_payment</span><span class="p">(</span><span class="n">mock_post</span><span class="p">):</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">}</span>
    <span class="n">mock_post</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>
</code></pre></div>

<h4 id="mistake-3-wrong-parameter-order-with-multiple-patches">Mistake 3: Wrong Parameter Order with Multiple Patches</h4>
<p><strong>Wrong</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;module.second&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;module.first&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_something</span><span class="p">(</span><span class="n">mock_second</span><span class="p">,</span> <span class="n">mock_first</span><span class="p">):</span>  <span class="c1"># Wrong order!</span>
    <span class="k">pass</span>
</code></pre></div>

<p><strong>Right</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;module.second&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;module.first&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_something</span><span class="p">(</span><span class="n">mock_first</span><span class="p">,</span> <span class="n">mock_second</span><span class="p">):</span>  <span class="c1"># Matches decorator order</span>
    <span class="k">pass</span>
</code></pre></div>

<h3 id="when-to-use-each-form">When to Use Each Form</h3>
<p><strong>Use decorator form</strong> when:
- The entire test needs the mock
- You're mocking the same thing across multiple tests
- You want clean, declarative test signatures</p>
<p><strong>Use context manager form</strong> when:
- Only part of the test needs the mock
- You need different mock configurations in the same test
- You're patching in non-test code (fixtures, setup functions)</p>
<p><strong>Use manual replacement</strong> when:
- You need very fine-grained control
- You're doing something unusual that <code>@patch</code> doesn't support
- Never, actually‚Äî<code>@patch</code> handles almost everything</p>
<h3 id="summary-the-power-of-patch">Summary: The Power of @patch</h3>
<p><code>@patch</code> provides:
- Automatic setup and teardown
- Clean, declarative syntax
- Support for multiple patches
- Flexible usage (decorator or context manager)
- Correct restoration even when tests fail</p>
<p>The key insight: <strong>patch where the object is used, not where it's defined</strong>.</p>
<p>In the next section, we'll learn how to verify that mocked functions were called correctly using mock assertions.</p>
<h2 id="common-mock-assertions-assert_called-assert_called_with">Common Mock Assertions (assert_called, assert_called_with)</h2>
<h2 id="common-mock-assertions-assert_called-assert_called_with_1">Common Mock Assertions (assert_called, assert_called_with)</h2>
<p>Mocking isn't just about replacing dependencies‚Äîit's also about verifying that your code interacts with those dependencies correctly. Mock assertions let you check that functions were called with the right arguments, the right number of times, and in the right order.</p>
<h3 id="why-verify-mock-calls">Why Verify Mock Calls?</h3>
<p>Consider this scenario: your payment processor successfully returns a result, but you forgot to actually send the payment request. The test passes because the mock returns what you configured, but the real code would fail in production.</p>
<p>Mock assertions catch these bugs by verifying that your code actually called the mocked function.</p>
<h3 id="iteration-8-basic-call-verification">Iteration 8: Basic Call Verification</h3>
<p>Let's start with the simplest assertion‚Äîchecking if a mock was called at all:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_mock_assertions.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span><span class="p">,</span> <span class="n">Mock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_payment</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor.requests.post&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_makes_api_call</span><span class="p">(</span><span class="n">mock_post</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify that the function actually calls the API.&quot;&quot;&quot;</span>
    <span class="c1"># Configure mock</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">}</span>
    <span class="n">mock_post</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>

    <span class="c1"># Call function</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

    <span class="c1"># Verify the mock was called</span>
    <span class="k">assert</span> <span class="n">mock_post</span><span class="o">.</span><span class="n">called</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mock was called: </span><span class="si">{</span><span class="n">mock_post</span><span class="o">.</span><span class="n">called</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Call count: </span><span class="si">{</span><span class="n">mock_post</span><span class="o">.</span><span class="n">call_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_mock_assertions.py::test_payment_makes_api_call<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>test_mock_assertions.py::test_payment_makes_api_call PASSED
Mock was called: True
Call count: 1
</code></pre></div>

<p>The <code>called</code> attribute is <code>True</code> if the mock was called at least once. But this is a weak assertion‚Äîit doesn't verify <em>how</em> the mock was called.</p>
<h3 id="iteration-9-verifying-call-count">Iteration 9: Verifying Call Count</h3>
<p>Let's verify the mock was called exactly once:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor.requests.post&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_calls_api_once</span><span class="p">(</span><span class="n">mock_post</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify the API is called exactly once.&quot;&quot;&quot;</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">}</span>
    <span class="n">mock_post</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

    <span class="c1"># Verify called exactly once</span>
    <span class="n">mock_post</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="c1"># Alternative: check call_count directly</span>
    <span class="k">assert</span> <span class="n">mock_post</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>

<p><code>assert_called_once()</code> is more expressive than checking <code>call_count == 1</code>. It also provides better error messages when it fails.</p>
<h3 id="iteration-10-verifying-call-arguments">Iteration 10: Verifying Call Arguments</h3>
<p>Now let's verify the mock was called with the correct arguments:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor.requests.post&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_sends_correct_data</span><span class="p">(</span><span class="n">mock_post</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify the API is called with correct arguments.&quot;&quot;&quot;</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">}</span>
    <span class="n">mock_post</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>

    <span class="c1"># Call with specific values</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;EUR&quot;</span><span class="p">)</span>

    <span class="c1"># Verify the call arguments</span>
    <span class="n">mock_post</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="s2">&quot;https://api.payment-gateway.com/charge&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;card&quot;</span><span class="p">:</span> <span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">100.00</span><span class="p">,</span>
            <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="s2">&quot;EUR&quot;</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">mock_post</span><span class="o">.</span><span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">][</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>  <span class="c1"># We&#39;ll verify this separately</span>
        <span class="p">},</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span>
    <span class="p">)</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_mock_assertions.py::test_payment_sends_correct_data<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>test_mock_assertions.py::test_payment_sends_correct_data PASSED
</code></pre></div>

<p><code>assert_called_once_with()</code> verifies:
- The mock was called exactly once
- The arguments match exactly</p>
<p>But there's a problem: we had to use <code>mock_post.call_args.kwargs["json"]["timestamp"]</code> because the timestamp changes with each call. This is awkward.</p>
<h3 id="iteration-11-partial-argument-verification">Iteration 11: Partial Argument Verification</h3>
<p>When you can't predict all arguments (like timestamps), verify only the parts you care about:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor.requests.post&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_sends_correct_data_partial</span><span class="p">(</span><span class="n">mock_post</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify specific arguments without checking everything.&quot;&quot;&quot;</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">}</span>
    <span class="n">mock_post</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;EUR&quot;</span><span class="p">)</span>

    <span class="c1"># Get the actual call arguments</span>
    <span class="n">call_args</span> <span class="o">=</span> <span class="n">mock_post</span><span class="o">.</span><span class="n">call_args</span>

    <span class="c1"># Verify positional arguments</span>
    <span class="k">assert</span> <span class="n">call_args</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;https://api.payment-gateway.com/charge&quot;</span>

    <span class="c1"># Verify specific keyword arguments</span>
    <span class="k">assert</span> <span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;timeout&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">30</span>

    <span class="c1"># Verify JSON payload structure</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;card&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;4111111111111111&quot;</span>
    <span class="k">assert</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">100.00</span>
    <span class="k">assert</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;EUR&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;timestamp&quot;</span> <span class="ow">in</span> <span class="n">json_data</span>  <span class="c1"># Just verify it exists</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Call args: </span><span class="si">{</span><span class="n">call_args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JSON data: </span><span class="si">{</span><span class="n">json_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_mock_assertions.py::test_payment_sends_correct_data_partial<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>test_mock_assertions.py::test_payment_sends_correct_data_partial PASSED
Call args: call(&#39;https://api.payment-gateway.com/charge&#39;, json={&#39;card&#39;: &#39;4111111111111111&#39;, &#39;amount&#39;: 100.0, &#39;currency&#39;: &#39;EUR&#39;, &#39;timestamp&#39;: &#39;2024-01-15T10:30:00.123456&#39;}, timeout=30)
JSON data: {&#39;card&#39;: &#39;4111111111111111&#39;, &#39;amount&#39;: 100.0, &#39;currency&#39;: &#39;EUR&#39;, &#39;timestamp&#39;: &#39;2024-01-15T10:30:00.123456&#39;}
</code></pre></div>

<p>This approach is more flexible. We verify the important parts and ignore the unpredictable timestamp value.</p>
<h3 id="understanding-call_args">Understanding call_args</h3>
<p><code>call_args</code> is a <code>call</code> object with two attributes:
- <code>args</code>: Tuple of positional arguments
- <code>kwargs</code>: Dictionary of keyword arguments</p>
<p>You can access them like this:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_understanding_call_args</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate call_args structure.&quot;&quot;&quot;</span>
    <span class="n">mock_func</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="c1"># Call with mixed arguments</span>
    <span class="n">mock_func</span><span class="p">(</span><span class="s2">&quot;pos1&quot;</span><span class="p">,</span> <span class="s2">&quot;pos2&quot;</span><span class="p">,</span> <span class="n">key1</span><span class="o">=</span><span class="s2">&quot;val1&quot;</span><span class="p">,</span> <span class="n">key2</span><span class="o">=</span><span class="s2">&quot;val2&quot;</span><span class="p">)</span>

    <span class="c1"># Access positional arguments</span>
    <span class="k">assert</span> <span class="n">mock_func</span><span class="o">.</span><span class="n">call_args</span><span class="o">.</span><span class="n">args</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;pos1&quot;</span><span class="p">,</span> <span class="s2">&quot;pos2&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">mock_func</span><span class="o">.</span><span class="n">call_args</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;pos1&quot;</span>

    <span class="c1"># Access keyword arguments</span>
    <span class="k">assert</span> <span class="n">mock_func</span><span class="o">.</span><span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;key1&quot;</span><span class="p">:</span> <span class="s2">&quot;val1&quot;</span><span class="p">,</span> <span class="s2">&quot;key2&quot;</span><span class="p">:</span> <span class="s2">&quot;val2&quot;</span><span class="p">}</span>
    <span class="k">assert</span> <span class="n">mock_func</span><span class="o">.</span><span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;key1&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;val1&quot;</span>

    <span class="c1"># Alternative: unpack the call object</span>
    <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">mock_func</span><span class="o">.</span><span class="n">call_args</span>
    <span class="k">assert</span> <span class="n">args</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;pos1&quot;</span><span class="p">,</span> <span class="s2">&quot;pos2&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">kwargs</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;key1&quot;</span><span class="p">:</span> <span class="s2">&quot;val1&quot;</span><span class="p">,</span> <span class="s2">&quot;key2&quot;</span><span class="p">:</span> <span class="s2">&quot;val2&quot;</span><span class="p">}</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Full call_args: </span><span class="si">{</span><span class="n">mock_func</span><span class="o">.</span><span class="n">call_args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Positional: </span><span class="si">{</span><span class="n">mock_func</span><span class="o">.</span><span class="n">call_args</span><span class="o">.</span><span class="n">args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Keyword: </span><span class="si">{</span><span class="n">mock_func</span><span class="o">.</span><span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="iteration-12-verifying-multiple-calls">Iteration 12: Verifying Multiple Calls</h3>
<p>What if a function calls the mock multiple times? Use <code>call_args_list</code> to inspect all calls:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_processor_batch.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_batch_payments</span><span class="p">(</span><span class="n">payments</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process multiple payments.</span>

<span class="sd">    Args:</span>
<span class="sd">        payments: List of (card_number, amount) tuples</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">card_number</span><span class="p">,</span> <span class="n">amount</span> <span class="ow">in</span> <span class="n">payments</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;https://api.payment-gateway.com/charge&quot;</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;card&quot;</span><span class="p">:</span> <span class="n">card_number</span><span class="p">,</span>
                <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
                <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="s2">&quot;USD&quot;</span><span class="p">,</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="p">},</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span>
            <span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown error&quot;</span><span class="p">)</span>
            <span class="p">})</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_batch_payments.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span><span class="p">,</span> <span class="n">Mock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor_batch</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_batch_payments</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor_batch.requests.post&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_batch_payment_multiple_calls</span><span class="p">(</span><span class="n">mock_post</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify multiple API calls for batch processing.&quot;&quot;&quot;</span>
    <span class="c1"># Configure mock to return different responses</span>
    <span class="n">mock_response1</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response1</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">mock_response1</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_001&quot;</span><span class="p">}</span>

    <span class="n">mock_response2</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response2</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">mock_response2</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_002&quot;</span><span class="p">}</span>

    <span class="c1"># Return different responses for each call</span>
    <span class="n">mock_post</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock_response1</span><span class="p">,</span> <span class="n">mock_response2</span><span class="p">]</span>

    <span class="c1"># Process batch</span>
    <span class="n">payments</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;4222222222222222&quot;</span><span class="p">,</span> <span class="mf">200.00</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">process_batch_payments</span><span class="p">(</span><span class="n">payments</span><span class="p">)</span>

    <span class="c1"># Verify two calls were made</span>
    <span class="k">assert</span> <span class="n">mock_post</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="c1"># Verify first call</span>
    <span class="n">first_call</span> <span class="o">=</span> <span class="n">mock_post</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">first_call</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">][</span><span class="s2">&quot;card&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;4111111111111111&quot;</span>
    <span class="k">assert</span> <span class="n">first_call</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">][</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">100.00</span>

    <span class="c1"># Verify second call</span>
    <span class="n">second_call</span> <span class="o">=</span> <span class="n">mock_post</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">second_call</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">][</span><span class="s2">&quot;card&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;4222222222222222&quot;</span>
    <span class="k">assert</span> <span class="n">second_call</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">][</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">200.00</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total calls: </span><span class="si">{</span><span class="n">mock_post</span><span class="o">.</span><span class="n">call_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First call: </span><span class="si">{</span><span class="n">first_call</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Second call: </span><span class="si">{</span><span class="n">second_call</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_batch_payments.py::test_batch_payment_multiple_calls<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>test_batch_payments.py::test_batch_payment_multiple_calls PASSED
Total calls: 2
First call: call(&#39;https://api.payment-gateway.com/charge&#39;, json={&#39;card&#39;: &#39;4111111111111111&#39;, &#39;amount&#39;: 100.0, &#39;currency&#39;: &#39;USD&#39;, &#39;timestamp&#39;: &#39;2024-01-15T10:30:00.123456&#39;}, timeout=30)
Second call: call(&#39;https://api.payment-gateway.com/charge&#39;, json={&#39;card&#39;: &#39;4222222222222222&#39;, &#39;amount&#39;: 200.0, &#39;currency&#39;: &#39;USD&#39;, &#39;timestamp&#39;: &#39;2024-01-15T10:30:00.234567&#39;}, timeout=30)
</code></pre></div>

<p><code>call_args_list</code> is a list of all <code>call</code> objects, indexed from 0.</p>
<h3 id="iteration-13-using-assert_any_call">Iteration 13: Using assert_any_call</h3>
<p>When you don't care about call order or count, just verify a specific call happened:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor_batch.requests.post&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_batch_payment_includes_specific_call</span><span class="p">(</span><span class="n">mock_post</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify a specific call was made, regardless of order.&quot;&quot;&quot;</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_001&quot;</span><span class="p">}</span>
    <span class="n">mock_post</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>

    <span class="n">payments</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;4222222222222222&quot;</span><span class="p">,</span> <span class="mf">200.00</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;4333333333333333&quot;</span><span class="p">,</span> <span class="mf">300.00</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">process_batch_payments</span><span class="p">(</span><span class="n">payments</span><span class="p">)</span>

    <span class="c1"># Verify the second payment was processed</span>
    <span class="c1"># We don&#39;t care about the timestamp, so we can&#39;t use assert_called_with</span>
    <span class="c1"># Instead, check manually</span>
    <span class="n">second_call</span> <span class="o">=</span> <span class="n">mock_post</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">second_call</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">][</span><span class="s2">&quot;card&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;4222222222222222&quot;</span>
    <span class="k">assert</span> <span class="n">second_call</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">][</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">200.00</span>
</code></pre></div>

<h3 id="iteration-14-verifying-no-calls">Iteration 14: Verifying No Calls</h3>
<p>Sometimes you need to verify a mock was <em>not</em> called:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_processor_conditional.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_payment_if_valid</span><span class="p">(</span><span class="n">card_number</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Only process payment if amount is positive.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid amount&quot;</span><span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;https://api.payment-gateway.com/charge&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;card&quot;</span><span class="p">:</span> <span class="n">card_number</span><span class="p">,</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="s2">&quot;USD&quot;</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">},</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown error&quot;</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_conditional_payment.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor_conditional</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_payment_if_valid</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor_conditional.requests.post&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_amount_skips_api_call</span><span class="p">(</span><span class="n">mock_post</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify API is not called for invalid amounts.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment_if_valid</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.00</span><span class="p">)</span>

    <span class="c1"># Verify the result</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Invalid amount&quot;</span>

    <span class="c1"># Verify the API was never called</span>
    <span class="n">mock_post</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mock called: </span><span class="si">{</span><span class="n">mock_post</span><span class="o">.</span><span class="n">called</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Call count: </span><span class="si">{</span><span class="n">mock_post</span><span class="o">.</span><span class="n">call_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_conditional_payment.py::test_invalid_amount_skips_api_call<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>test_conditional_payment.py::test_invalid_amount_skips_api_call PASSED
Mock called: False
Call count: 0
</code></pre></div>

<p><code>assert_not_called()</code> verifies the mock was never invoked. This is useful for testing conditional logic.</p>
<h3 id="complete-mock-assertion-reference">Complete Mock Assertion Reference</h3>
<p>Here's a summary of all mock assertion methods:</p>
<table>
<thead>
<tr>
<th>Assertion</th>
<th>What It Checks</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>mock.assert_called()</code></td>
<td>Mock was called at least once</td>
</tr>
<tr>
<td><code>mock.assert_called_once()</code></td>
<td>Mock was called exactly once</td>
</tr>
<tr>
<td><code>mock.assert_called_with(*args, **kwargs)</code></td>
<td>Most recent call used these arguments</td>
</tr>
<tr>
<td><code>mock.assert_called_once_with(*args, **kwargs)</code></td>
<td>Called exactly once with these arguments</td>
</tr>
<tr>
<td><code>mock.assert_any_call(*args, **kwargs)</code></td>
<td>At least one call used these arguments</td>
</tr>
<tr>
<td><code>mock.assert_not_called()</code></td>
<td>Mock was never called</td>
</tr>
<tr>
<td><code>mock.assert_has_calls(calls, any_order=False)</code></td>
<td>Verify multiple specific calls</td>
</tr>
</tbody>
</table>
<h3 id="common-assertion-mistakes">Common Assertion Mistakes</h3>
<h4 id="mistake-1-using-assert_called_with-after-multiple-calls">Mistake 1: Using assert_called_with After Multiple Calls</h4>
<p><strong>Wrong</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">mock_func</span><span class="p">(</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>
<span class="n">mock_func</span><span class="p">(</span><span class="s2">&quot;second&quot;</span><span class="p">)</span>
<span class="n">mock_func</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>  <span class="c1"># Fails! Checks most recent call</span>
</code></pre></div>

<p><strong>Right</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">mock_func</span><span class="p">(</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>
<span class="n">mock_func</span><span class="p">(</span><span class="s2">&quot;second&quot;</span><span class="p">)</span>
<span class="n">mock_func</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s2">&quot;second&quot;</span><span class="p">)</span>  <span class="c1"># Checks most recent call</span>
<span class="c1"># OR</span>
<span class="n">mock_func</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>  <span class="c1"># Checks any call</span>
</code></pre></div>

<h4 id="mistake-2-forgetting-to-verify-calls">Mistake 2: Forgetting to Verify Calls</h4>
<p><strong>Wrong</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;module.func&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_something</span><span class="p">(</span><span class="n">mock_func</span><span class="p">):</span>
    <span class="n">mock_func</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;result&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">my_function</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;expected&quot;</span>
    <span class="c1"># Forgot to verify mock_func was called!</span>
</code></pre></div>

<p><strong>Right</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;module.func&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_something</span><span class="p">(</span><span class="n">mock_func</span><span class="p">):</span>
    <span class="n">mock_func</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;result&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">my_function</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;expected&quot;</span>
    <span class="n">mock_func</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>  <span class="c1"># Verify the mock was used</span>
</code></pre></div>

<h4 id="mistake-3-over-specifying-arguments">Mistake 3: Over-Specifying Arguments</h4>
<p><strong>Wrong</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Fails if timestamp format changes slightly</span>
<span class="n">mock_post</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
    <span class="s2">&quot;https://api.example.com&quot;</span><span class="p">,</span>
    <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-01-15T10:30:00.123456&quot;</span><span class="p">}</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>Right</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Verify only what matters</span>
<span class="n">call_args</span> <span class="o">=</span> <span class="n">mock_post</span><span class="o">.</span><span class="n">call_args</span>
<span class="k">assert</span> <span class="s2">&quot;timestamp&quot;</span> <span class="ow">in</span> <span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">]</span>
</code></pre></div>

<h3 id="when-to-use-each-assertion">When to Use Each Assertion</h3>
<p><strong>Use <code>assert_called_once()</code></strong> when:
- You want to verify the function was called
- You don't care about the arguments
- You want to ensure it wasn't called multiple times</p>
<p><strong>Use <code>assert_called_once_with()</code></strong> when:
- You know all the arguments
- The arguments are predictable
- You want strict verification</p>
<p><strong>Use <code>call_args</code> inspection</strong> when:
- Some arguments are unpredictable (timestamps, UUIDs)
- You only care about specific arguments
- You need flexible verification</p>
<p><strong>Use <code>assert_not_called()</code></strong> when:
- Testing conditional logic
- Verifying optimization (caching, short-circuits)
- Ensuring side effects don't happen</p>
<h3 id="summary-verifying-mock-interactions">Summary: Verifying Mock Interactions</h3>
<p>Mock assertions let you:
- Verify functions were called
- Check call counts
- Inspect arguments
- Verify call order
- Ensure functions weren't called</p>
<p>The key insight: <strong>Mocking isn't just about replacing dependencies‚Äîit's about verifying your code uses them correctly.</strong></p>
<p>In the next section, we'll explore side effects and return values, which let you simulate complex behaviors like exceptions, state changes, and varying responses.</p>
<h2 id="mock-side-effects-and-return-values">Mock Side Effects and Return Values</h2>
<h2 id="mock-side-effects-and-return-values_1">Mock Side Effects and Return Values</h2>
<p>So far, we've configured mocks to return simple values. But real functions do more than return data‚Äîthey raise exceptions, modify state, and behave differently on subsequent calls. Mock side effects let you simulate all these behaviors.</p>
<h3 id="understanding-side-effects">Understanding Side Effects</h3>
<p>A "side effect" in mocking means "what happens when the mock is called." This can be:
- Returning a value (what we've been doing)
- Raising an exception
- Calling another function
- Returning different values on successive calls</p>
<h3 id="iteration-15-simulating-exceptions">Iteration 15: Simulating Exceptions</h3>
<p>Let's test what happens when the payment API raises a network error:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_processor_with_retry.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_payment_with_retry</span><span class="p">(</span><span class="n">card_number</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process payment with automatic retry on network errors.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;https://api.payment-gateway.com/charge&quot;</span><span class="p">,</span>
                <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;card&quot;</span><span class="p">:</span> <span class="n">card_number</span><span class="p">,</span>
                    <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
                    <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="s2">&quot;USD&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                <span class="p">},</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;attempts&quot;</span><span class="p">:</span> <span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown error&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;attempts&quot;</span><span class="p">:</span> <span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">}</span>

        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Last attempt failed</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Network error after </span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> attempts: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;attempts&quot;</span><span class="p">:</span> <span class="n">max_retries</span>
                <span class="p">}</span>
            <span class="c1"># Otherwise, retry</span>
            <span class="k">continue</span>
</code></pre></div>

<p>Now let's test the retry logic by making the mock raise an exception:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_exceptions.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span><span class="p">,</span> <span class="n">Mock</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor_with_retry</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_payment_with_retry</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor_with_retry.requests.post&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_handles_network_error</span><span class="p">(</span><span class="n">mock_post</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that network errors are handled correctly.&quot;&quot;&quot;</span>
    <span class="c1"># Configure mock to raise an exception</span>
    <span class="n">mock_post</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(</span><span class="s2">&quot;Network unreachable&quot;</span><span class="p">)</span>

    <span class="c1"># Call the function</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment_with_retry</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

    <span class="c1"># Verify error handling</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="s2">&quot;Network error after 3 attempts&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;attempts&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="c1"># Verify it tried 3 times</span>
    <span class="k">assert</span> <span class="n">mock_post</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retry attempts: </span><span class="si">{</span><span class="n">mock_post</span><span class="o">.</span><span class="n">call_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_exceptions.py::test_payment_handles_network_error<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>test_payment_exceptions.py::test_payment_handles_network_error PASSED
Result: {&#39;success&#39;: False, &#39;error&#39;: &#39;Network error after 3 attempts: Network unreachable&#39;, &#39;attempts&#39;: 3}
Retry attempts: 3
</code></pre></div>

<p>When <code>side_effect</code> is an exception, the mock raises it instead of returning a value. This lets us test error handling without triggering real network failures.</p>
<h3 id="iteration-16-different-responses-on-each-call">Iteration 16: Different Responses on Each Call</h3>
<p>What if the first two attempts fail but the third succeeds? Use a list of side effects:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor_with_retry.requests.post&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_succeeds_after_retries</span><span class="p">(</span><span class="n">mock_post</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that payment succeeds after initial failures.&quot;&quot;&quot;</span>
    <span class="c1"># First two calls raise exceptions, third succeeds</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">}</span>

    <span class="n">mock_post</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(</span><span class="s2">&quot;Timeout&quot;</span><span class="p">),</span>
        <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(</span><span class="s2">&quot;Timeout&quot;</span><span class="p">),</span>
        <span class="n">mock_response</span>  <span class="c1"># Third attempt succeeds</span>
    <span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment_with_retry</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

    <span class="c1"># Verify eventual success</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;txn_12345&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;attempts&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="c1"># Verify it tried 3 times</span>
    <span class="k">assert</span> <span class="n">mock_post</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempts before success: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;attempts&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_exceptions.py::test_payment_succeeds_after_retries<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>test_payment_exceptions.py::test_payment_succeeds_after_retries PASSED
Result: {&#39;success&#39;: True, &#39;transaction_id&#39;: &#39;txn_12345&#39;, &#39;attempts&#39;: 3}
Attempts before success: 3
</code></pre></div>

<p>When <code>side_effect</code> is a list, the mock returns/raises each item in sequence. This is perfect for testing retry logic, state machines, or any code that behaves differently on successive calls.</p>
<h3 id="iteration-17-side-effect-functions">Iteration 17: Side Effect Functions</h3>
<p>For complex behavior, use a function as the side effect:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor_with_retry.requests.post&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_with_dynamic_behavior</span><span class="p">(</span><span class="n">mock_post</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test with side effect that depends on arguments.&quot;&quot;&quot;</span>
    <span class="n">call_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">mock_api_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulate API that fails for large amounts.&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">call_count</span>
        <span class="n">call_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">amount</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">][</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span>

        <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="c1"># Large amounts fail</span>
            <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">400</span>
            <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Amount too large&quot;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Small amounts succeed</span>
            <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
            <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;txn_</span><span class="si">{</span><span class="n">call_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">mock_response</span>

    <span class="n">mock_post</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">mock_api_call</span>

    <span class="c1"># Test small amount (should succeed)</span>
    <span class="n">result1</span> <span class="o">=</span> <span class="n">process_payment_with_retry</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result1</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>

    <span class="c1"># Test large amount (should fail)</span>
    <span class="n">result2</span> <span class="o">=</span> <span class="n">process_payment_with_retry</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">2000.00</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result2</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result2</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Amount too large&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Small amount result: </span><span class="si">{</span><span class="n">result1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Large amount result: </span><span class="si">{</span><span class="n">result2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_exceptions.py::test_payment_with_dynamic_behavior<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>test_payment_exceptions.py::test_payment_with_dynamic_behavior PASSED
Small amount result: {&#39;success&#39;: True, &#39;transaction_id&#39;: &#39;txn_1&#39;, &#39;attempts&#39;: 1}
Large amount result: {&#39;success&#39;: False, &#39;error&#39;: &#39;Amount too large&#39;, &#39;attempts&#39;: 1}
</code></pre></div>

<p>When <code>side_effect</code> is a function, the mock calls it with the same arguments it received. This lets you implement arbitrarily complex mock behavior.</p>
<h3 id="iteration-18-combining-return_value-and-side_effect">Iteration 18: Combining return_value and side_effect</h3>
<p>You can't use both <code>return_value</code> and <code>side_effect</code> on the same mock‚Äî<code>side_effect</code> takes precedence. But you can use <code>side_effect</code> to return values:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_side_effect_vs_return_value</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate side_effect precedence.&quot;&quot;&quot;</span>
    <span class="n">mock_func</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="c1"># Set both return_value and side_effect</span>
    <span class="n">mock_func</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;from return_value&quot;</span>
    <span class="n">mock_func</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;from side_effect&quot;</span><span class="p">]</span>

    <span class="c1"># side_effect wins</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">mock_func</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;from side_effect&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Rule</strong>: If <code>side_effect</code> is set, <code>return_value</code> is ignored.</p>
<h3 id="iteration-19-resetting-mocks">Iteration 19: Resetting Mocks</h3>
<p>Sometimes you need to reset a mock's state between test sections:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_resetting_mocks</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate mock reset methods.&quot;&quot;&quot;</span>
    <span class="n">mock_func</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="s2">&quot;initial&quot;</span><span class="p">)</span>

    <span class="c1"># Call it a few times</span>
    <span class="n">mock_func</span><span class="p">(</span><span class="s2">&quot;arg1&quot;</span><span class="p">)</span>
    <span class="n">mock_func</span><span class="p">(</span><span class="s2">&quot;arg2&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">mock_func</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="c1"># Reset call history but keep configuration</span>
    <span class="n">mock_func</span><span class="o">.</span><span class="n">reset_mock</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">mock_func</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">mock_func</span><span class="o">.</span><span class="n">return_value</span> <span class="o">==</span> <span class="s2">&quot;initial&quot;</span>  <span class="c1"># Configuration preserved</span>

    <span class="c1"># Call again</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">mock_func</span><span class="p">(</span><span class="s2">&quot;arg3&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;initial&quot;</span>
    <span class="k">assert</span> <span class="n">mock_func</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After reset, call count: </span><span class="si">{</span><span class="n">mock_func</span><span class="o">.</span><span class="n">call_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return value preserved: </span><span class="si">{</span><span class="n">mock_func</span><span class="o">.</span><span class="n">return_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p><code>reset_mock()</code> clears:
- <code>called</code>
- <code>call_count</code>
- <code>call_args</code>
- <code>call_args_list</code></p>
<p>But preserves:
- <code>return_value</code>
- <code>side_effect</code>
- Attribute configurations</p>
<h3 id="iteration-20-mocking-properties">Iteration 20: Mocking Properties</h3>
<p>Sometimes you need to mock object properties, not just methods:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_service.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserService</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_client</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span> <span class="o">=</span> <span class="n">api_client</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get user status from API.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span><span class="o">.</span><span class="n">is_connected</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Not connected&quot;</span><span class="p">}</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/users/</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_user_service.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">PropertyMock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserService</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_user_service_checks_connection</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that service checks connection status.&quot;&quot;&quot;</span>
    <span class="n">mock_client</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="c1"># Mock the is_connected property</span>
    <span class="nb">type</span><span class="p">(</span><span class="n">mock_client</span><span class="p">)</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="n">PropertyMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">mock_client</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">get_user_status</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Not connected&quot;</span><span class="p">}</span>

    <span class="c1"># Verify the property was accessed</span>
    <span class="nb">type</span><span class="p">(</span><span class="n">mock_client</span><span class="p">)</span><span class="o">.</span><span class="n">is_connected</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p><code>PropertyMock</code> is used to mock properties. The syntax is unusual because properties are defined on the class, not the instance.</p>
<h3 id="side-effect-patterns-summary">Side Effect Patterns Summary</h3>
<table>
<thead>
<tr>
<th>Pattern</th>
<th>Use Case</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Single exception</td>
<td>Test error handling</td>
<td><code>side_effect=ValueError("error")</code></td>
</tr>
<tr>
<td>List of values</td>
<td>Test retry logic</td>
<td><code>side_effect=[error, error, success]</code></td>
</tr>
<tr>
<td>Function</td>
<td>Complex behavior</td>
<td><code>side_effect=lambda x: x * 2</code></td>
</tr>
<tr>
<td>Iterator</td>
<td>Infinite sequence</td>
<td><code>side_effect=itertools.count()</code></td>
</tr>
</tbody>
</table>
<h3 id="common-side-effect-mistakes">Common Side Effect Mistakes</h3>
<h4 id="mistake-1-forgetting-to-raise-exceptions">Mistake 1: Forgetting to Raise Exceptions</h4>
<p><strong>Wrong</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">mock_func</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>  <span class="c1"># Returns the exception object</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">my_function</span><span class="p">()</span>  <span class="c1"># Gets ValueError instance, doesn&#39;t raise</span>
</code></pre></div>

<p><strong>Right</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">mock_func</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>  <span class="c1"># Raises the exception</span>
<span class="c1"># OR</span>
<span class="n">mock_func</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>  <span class="c1"># Also raises</span>
</code></pre></div>

<h4 id="mistake-2-list-too-short">Mistake 2: List Too Short</h4>
<p><strong>Wrong</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">mock_func</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="s2">&quot;second&quot;</span><span class="p">]</span>
<span class="n">mock_func</span><span class="p">()</span>  <span class="c1"># Returns &quot;first&quot;</span>
<span class="n">mock_func</span><span class="p">()</span>  <span class="c1"># Returns &quot;second&quot;</span>
<span class="n">mock_func</span><span class="p">()</span>  <span class="c1"># Raises StopIteration!</span>
</code></pre></div>

<p><strong>Right</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Make sure list is long enough</span>
<span class="n">mock_func</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="s2">&quot;second&quot;</span><span class="p">,</span> <span class="s2">&quot;third&quot;</span><span class="p">]</span>
<span class="c1"># OR use a function for infinite behavior</span>
<span class="n">mock_func</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;always this&quot;</span>
</code></pre></div>

<h4 id="mistake-3-mixing-return_value-and-side_effect">Mistake 3: Mixing return_value and side_effect</h4>
<p><strong>Wrong</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">mock_func</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;value&quot;</span>
<span class="n">mock_func</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;other&quot;</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">mock_func</span><span class="p">()</span>  <span class="c1"># Returns &quot;other&quot;, not &quot;value&quot;</span>
</code></pre></div>

<p><strong>Right</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Choose one approach</span>
<span class="n">mock_func</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>  <span class="c1"># Use side_effect</span>
<span class="c1"># OR</span>
<span class="n">mock_func</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;value&quot;</span>  <span class="c1"># Use return_value</span>
</code></pre></div>

<h3 id="when-to-use-side-effects">When to Use Side Effects</h3>
<p><strong>Use exceptions</strong> when:
- Testing error handling
- Simulating network failures
- Testing retry logic</p>
<p><strong>Use lists</strong> when:
- Testing state changes
- Simulating retry scenarios
- Testing code that polls or iterates</p>
<p><strong>Use functions</strong> when:
- Behavior depends on arguments
- You need complex logic
- You want to track state across calls</p>
<p><strong>Use return_value</strong> when:
- Behavior is simple and constant
- You don't need exceptions or state changes</p>
<h3 id="summary-the-power-of-side-effects">Summary: The Power of Side Effects</h3>
<p>Side effects let you:
- Simulate exceptions and errors
- Return different values on successive calls
- Implement complex, stateful behavior
- Test retry logic and error handling
- Mock properties and attributes</p>
<p>The key insight: <strong>Mocks can simulate any behavior, not just simple return values.</strong></p>
<p>In the final section, we'll combine mocks with pytest fixtures to create reusable, maintainable test infrastructure.</p>
<h2 id="combining-mocks-and-fixtures">Combining Mocks and Fixtures</h2>
<h2 id="combining-mocks-and-fixtures_1">Combining Mocks and Fixtures</h2>
<p>We've learned how to create mocks and how to use fixtures (Chapter 4). Now we'll combine them to create reusable, maintainable test infrastructure. This is where mocking becomes truly powerful in real-world projects.</p>
<h3 id="the-problem-repetitive-mock-setup">The Problem: Repetitive Mock Setup</h3>
<p>Look at our tests so far. Every test that mocks <code>requests.post</code> repeats the same setup:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor.requests.post&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_something</span><span class="p">(</span><span class="n">mock_post</span><span class="p">):</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">}</span>
    <span class="n">mock_post</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>
    <span class="c1"># ... actual test code</span>
</code></pre></div>

<p>This setup appears in every test. If we need to change the mock response structure, we have to update every test. This violates the DRY (Don't Repeat Yourself) principle.</p>
<h3 id="iteration-21-mock-fixtures">Iteration 21: Mock Fixtures</h3>
<p>Let's create a fixture that provides a pre-configured mock:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_payment_api</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture that mocks the payment API with success response.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;payment_processor.requests.post&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_post</span><span class="p">:</span>
        <span class="c1"># Configure default success response</span>
        <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">}</span>
        <span class="n">mock_post</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>

        <span class="k">yield</span> <span class="n">mock_post</span>
</code></pre></div>

<p>Now tests can use this fixture instead of repeating the setup:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_with_fixtures.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_payment</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_successful_payment</span><span class="p">(</span><span class="n">mock_payment_api</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test using the mock fixture.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;txn_12345&quot;</span>

    <span class="c1"># The fixture provides the mock</span>
    <span class="n">mock_payment_api</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_with_fixtures.py::test_successful_payment<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>test_payment_with_fixtures.py::test_successful_payment PASSED
</code></pre></div>

<p>The fixture handles all the mock setup and teardown. Tests are now cleaner and more focused on behavior.</p>
<h3 id="iteration-22-parameterized-mock-fixtures">Iteration 22: Parameterized Mock Fixtures</h3>
<p>What if different tests need different mock responses? Make the fixture configurable:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (updated)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_payment_api_factory</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture factory that creates configured payment API mocks.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_mock</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">transaction_id</span><span class="o">=</span><span class="s2">&quot;txn_12345&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;payment_processor.requests.post&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_post</span><span class="p">:</span>
            <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
            <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>

            <span class="k">if</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">transaction_id</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span> <span class="ow">or</span> <span class="s2">&quot;Unknown error&quot;</span><span class="p">}</span>

            <span class="n">mock_post</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>
            <span class="k">return</span> <span class="n">mock_post</span>

    <span class="k">return</span> <span class="n">_create_mock</span>
</code></pre></div>

<p>Now tests can customize the mock behavior:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_successful_payment_with_factory</span><span class="p">(</span><span class="n">mock_payment_api_factory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test success scenario with factory.&quot;&quot;&quot;</span>
    <span class="n">mock_post</span> <span class="o">=</span> <span class="n">mock_payment_api_factory</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">transaction_id</span><span class="o">=</span><span class="s2">&quot;txn_custom&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">mock_post</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;txn_custom&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_failed_payment_with_factory</span><span class="p">(</span><span class="n">mock_payment_api_factory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test failure scenario with factory.&quot;&quot;&quot;</span>
    <span class="n">mock_post</span> <span class="o">=</span> <span class="n">mock_payment_api_factory</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="s2">&quot;Invalid card&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">mock_post</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;0000000000000000&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Invalid card&quot;</span>
</code></pre></div>

<p>This pattern is called a "fixture factory"‚Äîa fixture that returns a function for creating configured objects.</p>
<h3 id="iteration-23-fixtures-with-automatic-patching">Iteration 23: Fixtures with Automatic Patching</h3>
<p>For even cleaner tests, make the fixture automatically apply the patch:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (updated)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">payment_api_mock</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture that automatically patches and configures payment API.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;payment_processor.requests.post&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_post</span><span class="p">:</span>
        <span class="c1"># Default configuration</span>
        <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">}</span>
        <span class="n">mock_post</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>

        <span class="c1"># Yield the mock for test customization</span>
        <span class="k">yield</span> <span class="n">mock_post</span>

        <span class="c1"># Automatic cleanup happens here</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_with_auto_patching</span><span class="p">(</span><span class="n">payment_api_mock</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test with automatic patching fixture.&quot;&quot;&quot;</span>
    <span class="c1"># The patch is already active</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="n">payment_api_mock</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_with_custom_response</span><span class="p">(</span><span class="n">payment_api_mock</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test with customized mock response.&quot;&quot;&quot;</span>
    <span class="c1"># Reconfigure the mock for this test</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">400</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Declined&quot;</span><span class="p">}</span>
    <span class="n">payment_api_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Declined&quot;</span>
</code></pre></div>

<h3 id="iteration-24-fixtures-for-complex-mock-scenarios">Iteration 24: Fixtures for Complex Mock Scenarios</h3>
<p>For complex systems, create fixtures that mock entire subsystems:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_system.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentGateway</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Payment gateway client.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;https://api.payment-gateway.com&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">charge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_number</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;USD&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Charge a card.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/charge&quot;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span>
            <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;card&quot;</span><span class="p">:</span> <span class="n">card_number</span><span class="p">,</span>
                <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
                <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="p">},</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;High-level payment processor.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gateway</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gateway</span> <span class="o">=</span> <span class="n">gateway</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_number</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;USD&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a payment.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="n">card_number</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown error&quot;</span><span class="p">)</span>
            <span class="p">}</span>
</code></pre></div>

<p>Create fixtures for each component:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (updated)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_gateway_response</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture providing a mock gateway response.&quot;&quot;&quot;</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">mock_response</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_gateway</span><span class="p">(</span><span class="n">mock_gateway_response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture providing a mock payment gateway.&quot;&quot;&quot;</span>
    <span class="n">gateway</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">PaymentGateway</span><span class="p">)</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_gateway_response</span>
    <span class="k">return</span> <span class="n">gateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">payment_processor</span><span class="p">(</span><span class="n">mock_gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture providing a payment processor with mocked gateway.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">mock_gateway</span><span class="p">)</span>
</code></pre></div>

<p>Now tests can use high-level fixtures:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_system.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_processor_success</span><span class="p">(</span><span class="n">payment_processor</span><span class="p">,</span> <span class="n">mock_gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test payment processor with mocked gateway.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">payment_processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;txn_12345&quot;</span>

    <span class="c1"># Verify the gateway was called correctly</span>
    <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;USD&quot;</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_processor_failure</span><span class="p">(</span><span class="n">payment_processor</span><span class="p">,</span> <span class="n">mock_gateway</span><span class="p">,</span> <span class="n">mock_gateway_response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test payment processor with failure response.&quot;&quot;&quot;</span>
    <span class="c1"># Reconfigure the response for this test</span>
    <span class="n">mock_gateway_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">400</span>
    <span class="n">mock_gateway_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Declined&quot;</span><span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">payment_processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Declined&quot;</span>
</code></pre></div>

<h3 id="fixture-composition-benefits">Fixture Composition Benefits</h3>
<p>This fixture composition provides:</p>
<ol>
<li><strong>Reusability</strong>: Mock setup is defined once, used everywhere</li>
<li><strong>Maintainability</strong>: Change mock behavior in one place</li>
<li><strong>Clarity</strong>: Tests focus on behavior, not mock setup</li>
<li><strong>Flexibility</strong>: Tests can customize fixtures as needed</li>
<li><strong>Hierarchy</strong>: Complex fixtures build on simpler ones</li>
</ol>
<h3 id="iteration-25-fixture-scopes-with-mocks">Iteration 25: Fixture Scopes with Mocks</h3>
<p>Be careful with fixture scopes when using mocks. Mocks should usually be function-scoped to avoid test pollution:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (updated)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>  <span class="c1"># Explicit function scope</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_payment_api</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function-scoped mock (default).&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;payment_processor.requests.post&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_post</span><span class="p">:</span>
        <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">}</span>
        <span class="n">mock_post</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>
        <span class="k">yield</span> <span class="n">mock_post</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>  <span class="c1"># Module scope - be careful!</span>
<span class="k">def</span><span class="w"> </span><span class="nf">shared_mock_config</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Module-scoped configuration (not the mock itself).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;default_status&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="s2">&quot;default_transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span>
    <span class="p">}</span>
</code></pre></div>

<p><strong>Rule</strong>: Mock fixtures should almost always be function-scoped. Configuration fixtures can be module or session-scoped.</p>
<h3 id="iteration-26-combining-fixtures-with-parametrize">Iteration 26: Combining Fixtures with Parametrize</h3>
<p>You can combine mock fixtures with parametrized tests:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_payment_api_with_status</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture that uses parametrized status code.&quot;&quot;&quot;</span>
    <span class="n">status_code</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;payment_processor.requests.post&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_post</span><span class="p">:</span>
        <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>

        <span class="k">if</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Error&quot;</span><span class="p">}</span>

        <span class="n">mock_post</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>
        <span class="k">yield</span> <span class="n">mock_post</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;mock_payment_api_with_status&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">500</span><span class="p">],</span> <span class="n">indirect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_with_various_statuses</span><span class="p">(</span><span class="n">mock_payment_api_with_status</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test payment with different status codes.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

    <span class="n">status</span> <span class="o">=</span> <span class="n">mock_payment_api_with_status</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">status_code</span>
    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>The <code>indirect=True</code> parameter tells pytest to pass the parameter to the fixture instead of directly to the test.</p>
<h3 id="best-practices-for-mock-fixtures">Best Practices for Mock Fixtures</h3>
<h4 id="1-keep-fixtures-focused">1. Keep Fixtures Focused</h4>
<p><strong>Bad</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">everything_mocked</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mocks everything at once.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;module.api&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">api</span><span class="p">,</span> \
         <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;module.db&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">,</span> \
         <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;module.cache&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cache</span><span class="p">:</span>
        <span class="c1"># Configure everything...</span>
        <span class="k">yield</span> <span class="n">api</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">cache</span>
</code></pre></div>

<p><strong>Good</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_api</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mocks only the API.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;module.api&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">api</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">api</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mocks only the database.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;module.db&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">db</span>
</code></pre></div>

<h4 id="2-provide-sensible-defaults">2. Provide Sensible Defaults</h4>
<p><strong>Bad</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_api</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unconfigured mock.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;module.api&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">api</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">api</span>  <span class="c1"># Tests must configure everything</span>
</code></pre></div>

<p><strong>Good</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_api</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pre-configured mock with sensible defaults.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;module.api&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">api</span><span class="p">:</span>
        <span class="n">api</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
        <span class="k">yield</span> <span class="n">api</span>  <span class="c1"># Tests can override if needed</span>
</code></pre></div>

<h4 id="3-use-fixture-factories-for-variation">3. Use Fixture Factories for Variation</h4>
<p><strong>Bad</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_api_success</span><span class="p">():</span>
    <span class="c1"># ...</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_api_failure</span><span class="p">():</span>
    <span class="c1"># ...</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_api_timeout</span><span class="p">():</span>
    <span class="c1"># ...</span>
</code></pre></div>

<p><strong>Good</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_api_factory</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for creating API mocks.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_create</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
        <span class="c1"># Configure based on status</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">_create</span>
</code></pre></div>

<h4 id="4-document-fixture-behavior">4. Document Fixture Behavior</h4>
<p><strong>Bad</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_api</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;module.api&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">api</span><span class="p">:</span>
        <span class="n">api</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]}</span>
        <span class="k">yield</span> <span class="n">api</span>
</code></pre></div>

<p><strong>Good</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_api</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mock API client with default success response.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Mock: Configured mock with get() returning {&quot;data&quot;: [1, 2, 3]}</span>

<span class="sd">    Example:</span>
<span class="sd">        def test_something(mock_api):</span>
<span class="sd">            # Customize if needed</span>
<span class="sd">            mock_api.get.return_value = {&quot;data&quot;: [4, 5, 6]}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;module.api&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">api</span><span class="p">:</span>
        <span class="n">api</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]}</span>
        <span class="k">yield</span> <span class="n">api</span>
</code></pre></div>

<h3 id="summary-the-complete-journey">Summary: The Complete Journey</h3>
<p>Let's review our progression through this chapter:</p>
<table>
<thead>
<tr>
<th>Iteration</th>
<th>Problem</th>
<th>Solution</th>
<th>Technique</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Tests make real network calls</td>
<td>Need to replace dependencies</td>
<td>Mocking concept</td>
</tr>
<tr>
<td>1</td>
<td>Manual dependency injection</td>
<td>Inject mocks</td>
<td><code>Mock()</code> objects</td>
</tr>
<tr>
<td>2</td>
<td>Direct replacement is verbose</td>
<td>Automate replacement</td>
<td>Manual patching</td>
</tr>
<tr>
<td>3</td>
<td>Manual cleanup is error-prone</td>
<td>Automatic cleanup</td>
<td><code>@patch</code> decorator</td>
</tr>
<tr>
<td>4</td>
<td>Need to test errors</td>
<td>Simulate failures</td>
<td>Mock configuration</td>
</tr>
<tr>
<td>5</td>
<td>Multiple dependencies</td>
<td>Stack patches</td>
<td>Multiple <code>@patch</code></td>
</tr>
<tr>
<td>6</td>
<td>Partial test mocking</td>
<td>Context manager</td>
<td><code>with patch()</code></td>
</tr>
<tr>
<td>7</td>
<td>Configuration values</td>
<td>Patch attributes</td>
<td>Attribute patching</td>
</tr>
<tr>
<td>8</td>
<td>Verify function was called</td>
<td>Check interactions</td>
<td><code>assert_called()</code></td>
</tr>
<tr>
<td>9</td>
<td>Verify call count</td>
<td>Count calls</td>
<td><code>assert_called_once()</code></td>
</tr>
<tr>
<td>10</td>
<td>Verify arguments</td>
<td>Inspect arguments</td>
<td><code>assert_called_with()</code></td>
</tr>
<tr>
<td>11</td>
<td>Unpredictable arguments</td>
<td>Partial verification</td>
<td><code>call_args</code> inspection</td>
</tr>
<tr>
<td>12</td>
<td>Multiple calls</td>
<td>Inspect all calls</td>
<td><code>call_args_list</code></td>
</tr>
<tr>
<td>13</td>
<td>Verify no calls</td>
<td>Check absence</td>
<td><code>assert_not_called()</code></td>
</tr>
<tr>
<td>14</td>
<td>Verify specific call</td>
<td>Find in history</td>
<td><code>assert_any_call()</code></td>
</tr>
<tr>
<td>15</td>
<td>Test error handling</td>
<td>Raise exceptions</td>
<td><code>side_effect</code> with exception</td>
</tr>
<tr>
<td>16</td>
<td>Test retry logic</td>
<td>Different responses</td>
<td><code>side_effect</code> with list</td>
</tr>
<tr>
<td>17</td>
<td>Complex behavior</td>
<td>Dynamic responses</td>
<td><code>side_effect</code> with function</td>
</tr>
<tr>
<td>18</td>
<td>Mock properties</td>
<td>Property mocking</td>
<td><code>PropertyMock</code></td>
</tr>
<tr>
<td>19</td>
<td>Reset between tests</td>
<td>Clear state</td>
<td><code>reset_mock()</code></td>
</tr>
<tr>
<td>20</td>
<td>Repetitive setup</td>
<td>Reusable mocks</td>
<td>Fixtures</td>
</tr>
<tr>
<td>21</td>
<td>Different scenarios</td>
<td>Configurable mocks</td>
<td>Fixture factories</td>
</tr>
<tr>
<td>22</td>
<td>Automatic patching</td>
<td>Integrated fixtures</td>
<td>Fixture with <code>patch()</code></td>
</tr>
<tr>
<td>23</td>
<td>Complex systems</td>
<td>Layered mocks</td>
<td>Fixture composition</td>
</tr>
<tr>
<td>24</td>
<td>Scope management</td>
<td>Proper isolation</td>
<td>Function-scoped fixtures</td>
</tr>
<tr>
<td>25</td>
<td>Parametrized mocks</td>
<td>Indirect parameters</td>
<td><code>indirect=True</code></td>
</tr>
</tbody>
</table>
<h3 id="final-implementation-production-ready-test-suite">Final Implementation: Production-Ready Test Suite</h3>
<p>Here's a complete, production-ready test suite using all the techniques we've learned:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py - Complete fixture setup</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_payment_response</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture providing a configurable mock response.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_response</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">transaction_id</span><span class="o">=</span><span class="s2">&quot;txn_12345&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>

        <span class="k">if</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">transaction_id</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span> <span class="ow">or</span> <span class="s2">&quot;Unknown error&quot;</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">mock_response</span>

    <span class="k">return</span> <span class="n">_create_response</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_payment_api</span><span class="p">(</span><span class="n">mock_payment_response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture providing a mocked payment API with sensible defaults.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;payment_processor.requests.post&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_post</span><span class="p">:</span>
        <span class="c1"># Default: successful response</span>
        <span class="n">mock_post</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_payment_response</span><span class="p">()</span>
        <span class="k">yield</span> <span class="n">mock_post</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_payment_gateway</span><span class="p">(</span><span class="n">mock_payment_response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture providing a mocked PaymentGateway.&quot;&quot;&quot;</span>
    <span class="n">gateway</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">PaymentGateway</span><span class="p">)</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_payment_response</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">gateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">payment_processor</span><span class="p">(</span><span class="n">mock_payment_gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture providing a PaymentProcessor with mocked gateway.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">mock_payment_gateway</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_complete.py - Complete test suite</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_payment</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_system</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentProcessor</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestPaymentProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test suite for payment processing.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_successful_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_payment_api</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test successful payment processing.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;txn_12345&quot;</span>
        <span class="n">mock_payment_api</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_failed_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_payment_api</span><span class="p">,</span> <span class="n">mock_payment_response</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test failed payment processing.&quot;&quot;&quot;</span>
        <span class="n">mock_payment_api</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_payment_response</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
            <span class="n">error</span><span class="o">=</span><span class="s2">&quot;Invalid card&quot;</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;0000000000000000&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Invalid card&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_network_error_handling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_payment_api</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test network error handling.&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
        <span class="n">mock_payment_api</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(</span><span class="s2">&quot;Network error&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">):</span>
            <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;amount,currency&quot;</span><span class="p">,</span> <span class="p">[</span>
        <span class="p">(</span><span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;USD&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">200.00</span><span class="p">,</span> <span class="s2">&quot;EUR&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="mf">300.00</span><span class="p">,</span> <span class="s2">&quot;GBP&quot;</span><span class="p">),</span>
    <span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_various_amounts_and_currencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_payment_api</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test payment with various amounts and currencies.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="n">currency</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>

        <span class="c1"># Verify correct arguments were passed</span>
        <span class="n">call_args</span> <span class="o">=</span> <span class="n">mock_payment_api</span><span class="o">.</span><span class="n">call_args</span>
        <span class="k">assert</span> <span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">][</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">amount</span>
        <span class="k">assert</span> <span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">currency</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestPaymentSystem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test suite for the complete payment system.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_processor_uses_gateway</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payment_processor</span><span class="p">,</span> <span class="n">mock_payment_gateway</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that processor correctly uses gateway.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">payment_processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
        <span class="n">mock_payment_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;USD&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_processor_handles_gateway_errors</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">payment_processor</span><span class="p">,</span> <span class="n">mock_payment_gateway</span><span class="p">,</span> <span class="n">mock_payment_response</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that processor handles gateway errors.&quot;&quot;&quot;</span>
        <span class="n">mock_payment_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_payment_response</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
            <span class="n">error</span><span class="o">=</span><span class="s2">&quot;Gateway error&quot;</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">payment_processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Gateway error&quot;</span>
</code></pre></div>

<h3 id="decision-framework-when-to-use-each-approach">Decision Framework: When to Use Each Approach</h3>
<table>
<thead>
<tr>
<th>Scenario</th>
<th>Recommended Approach</th>
<th>Why</th>
</tr>
</thead>
<tbody>
<tr>
<td>Simple, one-off mock</td>
<td><code>@patch</code> decorator</td>
<td>Clean, declarative</td>
</tr>
<tr>
<td>Reusable mock setup</td>
<td>Fixture</td>
<td>DRY principle</td>
</tr>
<tr>
<td>Multiple test variations</td>
<td>Fixture factory</td>
<td>Flexibility</td>
</tr>
<tr>
<td>Complex system</td>
<td>Fixture composition</td>
<td>Maintainability</td>
</tr>
<tr>
<td>Partial test mocking</td>
<td>Context manager</td>
<td>Fine-grained control</td>
</tr>
<tr>
<td>Parametrized scenarios</td>
<td>Indirect parametrization</td>
<td>Combines benefits</td>
</tr>
</tbody>
</table>
<h3 id="lessons-learned">Lessons Learned</h3>
<p><strong>Mocking is about isolation</strong>: Test your code, not external systems.</p>
<p><strong>Mocking is about control</strong>: Simulate any scenario, including errors.</p>
<p><strong>Mocking is about verification</strong>: Ensure your code uses dependencies correctly.</p>
<p><strong>Fixtures make mocking maintainable</strong>: Reusable mock setup reduces duplication.</p>
<p><strong>Composition creates flexibility</strong>: Build complex fixtures from simple ones.</p>
<p><strong>Documentation prevents confusion</strong>: Clear docstrings explain fixture behavior.</p>
<p>The journey from manual mocking to fixture-based test infrastructure represents the evolution from beginner to professional testing practices. Master these patterns, and you'll write tests that are fast, reliable, and maintainable.</p>
        </div>
        <div class="footer">
            Generated on 2025-12-03 10:37:02 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>