<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>09 Spies, Stubs, and Test Doubles</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">03 Mocking and Isolation</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-9-spies-stubs-and-test-doubles">Chapter 9: Spies, Stubs, and Test Doubles</h1>
<h2 id="the-difference-between-mocks-stubs-and-spies">The Difference Between Mocks, Stubs, and Spies</h2>
<h2 id="the-difference-between-mocks-stubs-and-spies_1">The Difference Between Mocks, Stubs, and Spies</h2>
<p>In Chapter 8, we learned about mocking with <code>unittest.mock</code>. We used <code>Mock()</code> objects and the <code>@patch</code> decorator to replace real dependencies with test doubles. But we used the term "mock" loosely‚Äîas a catch-all for any fake object in a test.</p>
<p>Professional testing literature distinguishes between several types of test doubles, each with a specific purpose. Understanding these distinctions helps you choose the right tool for each testing scenario and communicate precisely with other developers.</p>
<h3 id="the-reference-implementation-a-payment-processing-system">The Reference Implementation: A Payment Processing System</h3>
<p>We'll explore test doubles through a realistic payment processing system that interacts with multiple external services. This system will serve as our anchor example throughout the chapter.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_processor.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PaymentGateway</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;External payment service - we don&#39;t control this.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">charge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">card_token</span><span class="p">):</span>
        <span class="c1"># In reality, makes HTTP request to payment provider</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Real implementation calls external API&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">refund</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Real implementation calls external API&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FraudDetector</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;External fraud detection service.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">card_token</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="c1"># In reality, calls ML service</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Real implementation calls fraud API&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">NotificationService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sends emails/SMS to users.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">send_receipt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Real implementation sends email&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">send_fraud_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Real implementation sends alert&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Our code - coordinates payment flow.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gateway</span><span class="p">,</span> <span class="n">fraud_detector</span><span class="p">,</span> <span class="n">notifier</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gateway</span> <span class="o">=</span> <span class="n">gateway</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fraud_detector</span> <span class="o">=</span> <span class="n">fraud_detector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span> <span class="o">=</span> <span class="n">notifier</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">card_token</span><span class="p">):</span>
        <span class="c1"># Check for fraud first</span>
        <span class="n">fraud_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraud_detector</span><span class="o">.</span><span class="n">check_transaction</span><span class="p">(</span>
            <span class="n">amount</span><span class="p">,</span> <span class="n">card_token</span><span class="p">,</span> <span class="n">user_id</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">fraud_result</span> <span class="o">==</span> <span class="s2">&quot;SUSPICIOUS&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">send_fraud_alert</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;rejected&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;fraud_detected&quot;</span><span class="p">}</span>

        <span class="c1"># Attempt to charge</span>
        <span class="n">transaction_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">card_token</span><span class="p">)</span>

        <span class="c1"># Send receipt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">send_receipt</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
            <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">transaction_id</span>
        <span class="p">}</span>
</code></pre></div>

<p>This is our production code. It coordinates three external services:
- <strong>PaymentGateway</strong>: Charges credit cards (costs money per call)
- <strong>FraudDetector</strong>: ML-based fraud detection (slow, expensive)
- <strong>NotificationService</strong>: Sends emails/SMS (triggers real communications)</p>
<p>We cannot call these services in tests. We need test doubles.</p>
<h3 id="iteration-0-the-naive-approach-using-mock-for-everything">Iteration 0: The Naive Approach - Using Mock() for Everything</h3>
<p>Let's write our first test using what we learned in Chapter 8‚Äîreplace everything with <code>Mock()</code> objects.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_processor_naive.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentProcessor</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_successful_payment_naive</span><span class="p">():</span>
    <span class="c1"># Create mock objects for all dependencies</span>
    <span class="n">gateway</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">fraud_detector</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">notifier</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="c1"># Make them return something</span>
    <span class="n">fraud_detector</span><span class="o">.</span><span class="n">check_transaction</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;SAFE&quot;</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;txn_12345&quot;</span>

    <span class="c1"># Create processor with mocks</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">gateway</span><span class="p">,</span> <span class="n">fraud_detector</span><span class="p">,</span> <span class="n">notifier</span><span class="p">)</span>

    <span class="c1"># Process payment</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;user_42&quot;</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">99.99</span><span class="p">,</span>
        <span class="n">card_token</span><span class="o">=</span><span class="s2">&quot;tok_visa_4242&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Verify result</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;txn_12345&quot;</span>

    <span class="c1"># Verify interactions happened</span>
    <span class="n">fraud_detector</span><span class="o">.</span><span class="n">check_transaction</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="mf">99.99</span><span class="p">,</span> <span class="s2">&quot;tok_visa_4242&quot;</span><span class="p">,</span> <span class="s2">&quot;user_42&quot;</span>
    <span class="p">)</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="mf">99.99</span><span class="p">,</span> <span class="s2">&quot;tok_visa_4242&quot;</span><span class="p">)</span>
    <span class="n">notifier</span><span class="o">.</span><span class="n">send_receipt</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="s2">&quot;user_42&quot;</span><span class="p">,</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">,</span> <span class="mf">99.99</span>
    <span class="p">)</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_processor_naive.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_processor_naive.py::test_successful_payment_naive PASSED
</code></pre></div>

<p>The test passes. But there's a problem lurking beneath the surface.</p>
<h3 id="diagnostic-analysis-what-are-we-actually-testing">Diagnostic Analysis: What Are We Actually Testing?</h3>
<p>Let's add another test for the fraud detection path:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_fraud_detected_naive</span><span class="p">():</span>
    <span class="n">gateway</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">fraud_detector</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">notifier</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="c1"># Simulate fraud detection</span>
    <span class="n">fraud_detector</span><span class="o">.</span><span class="n">check_transaction</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;SUSPICIOUS&quot;</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">gateway</span><span class="p">,</span> <span class="n">fraud_detector</span><span class="p">,</span> <span class="n">notifier</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;user_42&quot;</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">99.99</span><span class="p">,</span>
        <span class="n">card_token</span><span class="o">=</span><span class="s2">&quot;tok_visa_4242&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Verify fraud rejection</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rejected&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;fraud_detected&quot;</span>

    <span class="c1"># Verify fraud alert was sent</span>
    <span class="n">notifier</span><span class="o">.</span><span class="n">send_fraud_alert</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;user_42&quot;</span><span class="p">)</span>

    <span class="c1"># Verify we did NOT charge the card</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</code></pre></div>

<p>Run both tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_processor_naive.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_processor_naive.py::test_successful_payment_naive PASSED
test_payment_processor_naive.py::test_fraud_detected_naive PASSED
</code></pre></div>

<p>Both pass. But notice what we're doing in each test:</p>
<p><strong>In <code>test_successful_payment_naive</code></strong>:
- We configure return values: <code>fraud_detector.check_transaction.return_value = "SAFE"</code>
- We verify method calls: <code>gateway.charge.assert_called_once_with(...)</code>
- We check both behavior (return value) AND interactions (method calls)</p>
<p><strong>In <code>test_fraud_detected_naive</code></strong>:
- We configure return values: <code>fraud_detector.check_transaction.return_value = "SUSPICIOUS"</code>
- We verify method calls: <code>notifier.send_fraud_alert.assert_called_once_with(...)</code>
- We verify methods were NOT called: <code>gateway.charge.assert_not_called()</code></p>
<p>We're using <code>Mock()</code> for three different purposes:
1. <strong>Providing canned responses</strong> (fraud_detector returning "SAFE")
2. <strong>Recording interactions</strong> (verifying charge was called)
3. <strong>Doing nothing</strong> (notifier just needs to exist)</p>
<p>This works, but it's conceptually muddy. We're using one tool for three distinct jobs.</p>
<h3 id="the-problem-mock-is-too-powerful">The Problem: Mock() Is Too Powerful</h3>
<p>The issue becomes clearer when we look at what <code>Mock()</code> allows:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_mock_accepts_anything</span><span class="p">():</span>
    <span class="n">gateway</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="c1"># Mock accepts ANY method call</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="mf">99.99</span><span class="p">,</span> <span class="s2">&quot;tok_visa&quot;</span><span class="p">)</span>  <span class="c1"># OK</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">refund</span><span class="p">(</span><span class="s2">&quot;txn_123&quot;</span><span class="p">)</span>  <span class="c1"># OK</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">completely_made_up_method</span><span class="p">()</span>  <span class="c1"># Also OK!</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">another_fake_method</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">)</span>  <span class="c1"># Still OK!</span>

    <span class="c1"># Mock accepts ANY attribute access</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">gateway</span><span class="o">.</span><span class="n">some_attribute</span><span class="p">)</span>  <span class="c1"># Returns another Mock</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">gateway</span><span class="o">.</span><span class="n">nested</span><span class="o">.</span><span class="n">deeply</span><span class="o">.</span><span class="n">fake</span><span class="o">.</span><span class="n">attribute</span><span class="p">)</span>  <span class="c1"># Also returns Mock</span>

    <span class="c1"># All of these &quot;work&quot; - Mock never complains</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_processor_naive.py::test_mock_accepts_anything<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_processor_naive.py::test_mock_accepts_anything<span class="w"> </span><span class="nt">&lt;MagicMock</span> <span class="na">name=</span><span class="s">&#39;mock.some_attribute&#39;</span> <span class="na">id=</span><span class="s">&#39;...&#39;</span><span class="nt">&gt;</span>
<span class="nt">&lt;MagicMock</span> <span class="na">name=</span><span class="s">&#39;mock.nested.deeply.fake.attribute&#39;</span> <span class="na">id=</span><span class="s">&#39;...&#39;</span><span class="nt">&gt;</span>
PASSED
</code></pre></div>

<p><code>Mock()</code> accepts everything. This is powerful but dangerous. If we typo a method name in our test, the test still passes:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_dangerous_typo</span><span class="p">():</span>
    <span class="n">gateway</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;txn_12345&quot;</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">gateway</span><span class="p">,</span> <span class="n">Mock</span><span class="p">(),</span> <span class="n">Mock</span><span class="p">())</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;user_42&quot;</span><span class="p">,</span> <span class="mf">99.99</span><span class="p">,</span> <span class="s2">&quot;tok_visa&quot;</span><span class="p">)</span>

    <span class="c1"># Typo: &quot;chrage&quot; instead of &quot;charge&quot;</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">chrage</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>  <span class="c1"># This passes!</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_processor_naive.py::test_dangerous_typo<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_processor_naive.py::test_dangerous_typo PASSED
</code></pre></div>

<p>The test passes even though we verified the wrong method. <code>Mock()</code> created <code>gateway.chrage</code> on the fly when we accessed it.</p>
<h3 id="what-we-need-specialized-test-doubles">What We Need: Specialized Test Doubles</h3>
<p>Professional testing distinguishes between different types of test doubles based on their purpose:</p>
<ol>
<li>
<p><strong>Stub</strong>: Provides canned responses to method calls. Used when you need a dependency to return specific values but don't care about verifying interactions.</p>
</li>
<li>
<p><strong>Spy</strong>: Records information about how it was called. Used when you need to verify interactions happened but don't need to control return values.</p>
</li>
<li>
<p><strong>Mock</strong>: Combines stub and spy‚Äîprovides canned responses AND verifies interactions. Used when you need both capabilities.</p>
</li>
<li>
<p><strong>Fake</strong>: A working implementation with shortcuts (e.g., in-memory database instead of PostgreSQL). Used for integration testing.</p>
</li>
<li>
<p><strong>Dummy</strong>: A placeholder that does nothing. Used when a parameter is required but not used in the test scenario.</p>
</li>
</ol>
<p>Let's rewrite our tests using the appropriate test double for each dependency.</p>
<h3 id="iteration-1-using-stubs-for-canned-responses">Iteration 1: Using Stubs for Canned Responses</h3>
<p>A <strong>stub</strong> provides predetermined responses. We use stubs when we need a dependency to return specific values but don't care about verifying how it was called.</p>
<p>In our payment processor, the <code>FraudDetector</code> is a perfect candidate for stubbing. We need it to return "SAFE" or "SUSPICIOUS", but we don't need to verify the exact parameters it was called with‚Äîthat's an implementation detail.</p>
<p>Let's create a stub manually first to understand the concept:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_processor_stubs.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentProcessor</span><span class="p">,</span> <span class="n">FraudDetector</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FraudDetectorStub</span><span class="p">(</span><span class="n">FraudDetector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A stub that returns predetermined fraud check results.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="s2">&quot;SAFE&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">card_token</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="c1"># Always returns the predetermined result</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_successful_payment_with_stub</span><span class="p">():</span>
    <span class="c1"># Use a stub for fraud detector - we only care about its return value</span>
    <span class="n">fraud_detector</span> <span class="o">=</span> <span class="n">FraudDetectorStub</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="s2">&quot;SAFE&quot;</span><span class="p">)</span>

    <span class="c1"># Use Mock for gateway - we need to verify it was called AND provide return value</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>
    <span class="n">gateway</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;txn_12345&quot;</span>

    <span class="c1"># Use Mock for notifier - we need to verify it was called</span>
    <span class="n">notifier</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">gateway</span><span class="p">,</span> <span class="n">fraud_detector</span><span class="p">,</span> <span class="n">notifier</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;user_42&quot;</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">99.99</span><span class="p">,</span>
        <span class="n">card_token</span><span class="o">=</span><span class="s2">&quot;tok_visa_4242&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;txn_12345&quot;</span>

    <span class="c1"># We verify gateway and notifier interactions</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="mf">99.99</span><span class="p">,</span> <span class="s2">&quot;tok_visa_4242&quot;</span><span class="p">)</span>
    <span class="n">notifier</span><span class="o">.</span><span class="n">send_receipt</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="s2">&quot;user_42&quot;</span><span class="p">,</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">,</span> <span class="mf">99.99</span>
    <span class="p">)</span>
    <span class="c1"># Note: We don&#39;t verify fraud_detector calls - it&#39;s a stub</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_processor_stubs.py::test_successful_payment_with_stub<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_processor_stubs.py::test_successful_payment_with_stub PASSED
</code></pre></div>

<p><strong>What changed</strong>:
- <code>FraudDetectorStub</code> is a real class that implements the <code>FraudDetector</code> interface
- It returns a predetermined value without any mock configuration
- We don't verify how it was called‚Äîwe only care that it returns the right value
- The test is clearer about intent: "fraud detector returns SAFE"</p>
<p>Now test the fraud detection path:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_fraud_detected_with_stub</span><span class="p">():</span>
    <span class="c1"># Stub returns &quot;SUSPICIOUS&quot;</span>
    <span class="n">fraud_detector</span> <span class="o">=</span> <span class="n">FraudDetectorStub</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="s2">&quot;SUSPICIOUS&quot;</span><span class="p">)</span>

    <span class="n">gateway</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">notifier</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">gateway</span><span class="p">,</span> <span class="n">fraud_detector</span><span class="p">,</span> <span class="n">notifier</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;user_42&quot;</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">99.99</span><span class="p">,</span>
        <span class="n">card_token</span><span class="o">=</span><span class="s2">&quot;tok_visa_4242&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rejected&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;fraud_detected&quot;</span>

    <span class="n">notifier</span><span class="o">.</span><span class="n">send_fraud_alert</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;user_42&quot;</span><span class="p">)</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</code></pre></div>

<p>Run both tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_processor_stubs.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_processor_stubs.py::test_successful_payment_with_stub PASSED
test_payment_processor_stubs.py::test_fraud_detected_with_stub PASSED
</code></pre></div>

<p><strong>When to use stubs</strong>:
- You need a dependency to return specific values
- You don't care about verifying interactions
- The dependency's behavior is simple (returns values based on input)
- You want to make test intent clear: "given this input, return this output"</p>
<p><strong>When NOT to use stubs</strong>:
- You need to verify the dependency was called correctly
- The dependency has complex behavior or side effects
- You need to verify the dependency was NOT called in certain scenarios</p>
<h3 id="iteration-2-using-spies-to-record-interactions">Iteration 2: Using Spies to Record Interactions</h3>
<p>A <strong>spy</strong> records how it was called without changing behavior. We use spies when we need to verify interactions but want the real implementation to run (or we need minimal behavior).</p>
<p>In our payment processor, the <code>NotificationService</code> is a good candidate for spying. We need to verify it was called with the right parameters, but we don't need it to actually send emails in tests.</p>
<p>Let's create a spy manually:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_processor_spies.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentProcessor</span><span class="p">,</span> <span class="n">NotificationService</span>

<span class="k">class</span><span class="w"> </span><span class="nc">NotificationServiceSpy</span><span class="p">(</span><span class="n">NotificationService</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A spy that records all method calls.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">receipt_calls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_calls</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">send_receipt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="c1"># Record the call</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">receipt_calls</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
            <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">transaction_id</span><span class="p">,</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span>
        <span class="p">})</span>
        <span class="c1"># Don&#39;t actually send email</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">send_fraud_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="c1"># Record the call</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_calls</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">})</span>
        <span class="c1"># Don&#39;t actually send alert</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_successful_payment_with_spy</span><span class="p">():</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>

    <span class="n">fraud_detector</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">fraud_detector</span><span class="o">.</span><span class="n">check_transaction</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;SAFE&quot;</span>

    <span class="n">gateway</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;txn_12345&quot;</span>

    <span class="c1"># Use a spy for notifications</span>
    <span class="n">notifier</span> <span class="o">=</span> <span class="n">NotificationServiceSpy</span><span class="p">()</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">gateway</span><span class="p">,</span> <span class="n">fraud_detector</span><span class="p">,</span> <span class="n">notifier</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;user_42&quot;</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">99.99</span><span class="p">,</span>
        <span class="n">card_token</span><span class="o">=</span><span class="s2">&quot;tok_visa_4242&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span>

    <span class="c1"># Verify using spy&#39;s recorded calls</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">notifier</span><span class="o">.</span><span class="n">receipt_calls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">notifier</span><span class="o">.</span><span class="n">receipt_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user_42&quot;</span><span class="p">,</span>
        <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">,</span>
        <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">99.99</span>
    <span class="p">}</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">notifier</span><span class="o">.</span><span class="n">alert_calls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_processor_spies.py::test_successful_payment_with_spy<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_processor_spies.py::test_successful_payment_with_spy PASSED
</code></pre></div>

<p><strong>What changed</strong>:
- <code>NotificationServiceSpy</code> records all calls in lists
- We verify interactions by inspecting the spy's recorded data
- The spy doesn't use mock assertions‚Äîit uses plain data structures
- We can inspect the exact parameters passed to each call</p>
<p>Test the fraud path:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_fraud_detected_with_spy</span><span class="p">():</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>

    <span class="n">fraud_detector</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">fraud_detector</span><span class="o">.</span><span class="n">check_transaction</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;SUSPICIOUS&quot;</span>

    <span class="n">gateway</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">notifier</span> <span class="o">=</span> <span class="n">NotificationServiceSpy</span><span class="p">()</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">gateway</span><span class="p">,</span> <span class="n">fraud_detector</span><span class="p">,</span> <span class="n">notifier</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;user_42&quot;</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">99.99</span><span class="p">,</span>
        <span class="n">card_token</span><span class="o">=</span><span class="s2">&quot;tok_visa_4242&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rejected&quot;</span>

    <span class="c1"># Verify fraud alert was sent</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">notifier</span><span class="o">.</span><span class="n">alert_calls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">notifier</span><span class="o">.</span><span class="n">alert_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user_42&quot;</span><span class="p">}</span>

    <span class="c1"># Verify receipt was NOT sent</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">notifier</span><span class="o">.</span><span class="n">receipt_calls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="c1"># Verify gateway was not charged</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</code></pre></div>

<p>Run both tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_processor_spies.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_processor_spies.py::test_successful_payment_with_spy PASSED
test_payment_processor_spies.py::test_fraud_detected_with_spy PASSED
</code></pre></div>

<p><strong>When to use spies</strong>:
- You need to verify a dependency was called with specific parameters
- You want to inspect the exact sequence of calls
- You need to verify a dependency was NOT called
- You want more control over verification than mock assertions provide</p>
<p><strong>When NOT to use spies</strong>:
- You need to control return values (use stub or mock instead)
- The dependency has complex behavior that affects the test
- Simple mock assertions are sufficient</p>
<h3 id="iteration-3-understanding-when-mock-is-actually-a-mock">Iteration 3: Understanding When Mock() Is Actually a Mock</h3>
<p>Now we understand that <code>Mock()</code> from <code>unittest.mock</code> is actually a <strong>mock</strong> in the technical sense‚Äîit combines stub and spy capabilities. It can:
1. Provide canned responses (stub behavior)
2. Record and verify interactions (spy behavior)</p>
<p>Let's rewrite our test using the precise terminology:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_processor_precise.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentProcessor</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_successful_payment_precise_terminology</span><span class="p">():</span>
    <span class="c1"># fraud_detector is a STUB - we only configure return value</span>
    <span class="n">fraud_detector</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">fraud_detector</span><span class="o">.</span><span class="n">check_transaction</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;SAFE&quot;</span>

    <span class="c1"># gateway is a MOCK - we configure return value AND verify calls</span>
    <span class="n">gateway</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;txn_12345&quot;</span>

    <span class="c1"># notifier is a SPY - we only verify calls</span>
    <span class="n">notifier</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">gateway</span><span class="p">,</span> <span class="n">fraud_detector</span><span class="p">,</span> <span class="n">notifier</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;user_42&quot;</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">99.99</span><span class="p">,</span>
        <span class="n">card_token</span><span class="o">=</span><span class="s2">&quot;tok_visa_4242&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Verify result</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;txn_12345&quot;</span>

    <span class="c1"># Verify MOCK (gateway) - both return value and interaction</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="mf">99.99</span><span class="p">,</span> <span class="s2">&quot;tok_visa_4242&quot;</span><span class="p">)</span>

    <span class="c1"># Verify SPY (notifier) - only interaction</span>
    <span class="n">notifier</span><span class="o">.</span><span class="n">send_receipt</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="s2">&quot;user_42&quot;</span><span class="p">,</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">,</span> <span class="mf">99.99</span>
    <span class="p">)</span>

    <span class="c1"># We don&#39;t verify STUB (fraud_detector) - we only care about return value</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_processor_precise.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_processor_precise.py::test_successful_payment_precise_terminology PASSED
</code></pre></div>

<p>Even though we're using <code>Mock()</code> for all three dependencies, we're using them in different ways:
- <strong>As a stub</strong>: Configure return value, don't verify calls
- <strong>As a spy</strong>: Verify calls, don't configure return value (or it returns default)
- <strong>As a mock</strong>: Configure return value AND verify calls</p>
<h3 id="the-vocabulary-summary">The Vocabulary Summary</h3>
<table>
<thead>
<tr>
<th>Test Double</th>
<th>Purpose</th>
<th>Provides Return Values?</th>
<th>Verifies Interactions?</th>
<th>Example Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Stub</strong></td>
<td>Provide canned responses</td>
<td>‚úÖ Yes</td>
<td>‚ùå No</td>
<td>Fraud detector returning "SAFE"</td>
</tr>
<tr>
<td><strong>Spy</strong></td>
<td>Record interactions</td>
<td>‚ùå No (or minimal)</td>
<td>‚úÖ Yes</td>
<td>Notification service recording calls</td>
</tr>
<tr>
<td><strong>Mock</strong></td>
<td>Stub + Spy combined</td>
<td>‚úÖ Yes</td>
<td>‚úÖ Yes</td>
<td>Payment gateway that must return transaction ID and be verified</td>
</tr>
<tr>
<td><strong>Fake</strong></td>
<td>Working implementation</td>
<td>‚úÖ Yes (real logic)</td>
<td>‚ùå No</td>
<td>In-memory database for integration tests</td>
</tr>
<tr>
<td><strong>Dummy</strong></td>
<td>Placeholder</td>
<td>‚ùå No</td>
<td>‚ùå No</td>
<td>Required parameter that's never used</td>
</tr>
</tbody>
</table>
<h3 id="when-to-use-each-type">When to Use Each Type</h3>
<p><strong>Use a Stub when</strong>:
- You need a dependency to return specific values
- You don't care how many times it's called or with what parameters
- The dependency's behavior is simple and deterministic
- Example: Configuration object, data source, external API that returns data</p>
<p><strong>Use a Spy when</strong>:
- You need to verify a dependency was called correctly
- You want to inspect the exact parameters passed
- You need to verify call order or frequency
- Example: Logger, event emitter, notification service</p>
<p><strong>Use a Mock when</strong>:
- You need both stub and spy capabilities
- You need to verify interactions AND control return values
- The dependency is critical to the test's correctness
- Example: Database transaction, payment gateway, authentication service</p>
<p><strong>Use a Fake when</strong>:
- You need realistic behavior without external dependencies
- You're doing integration testing
- The real implementation is too slow or expensive
- Example: In-memory database, fake file system, local message queue</p>
<p><strong>Use a Dummy when</strong>:
- A parameter is required but not used in the test scenario
- You need to satisfy a function signature
- The value doesn't matter for the test
- Example: Unused callback, required but ignored configuration</p>
<h3 id="practical-guideline-start-simple-add-complexity-only-when-needed">Practical Guideline: Start Simple, Add Complexity Only When Needed</h3>
<p>In practice, most Python developers use <code>Mock()</code> for everything because it's convenient and flexible. This is fine for simple tests. The key is understanding what role each mock is playing:</p>
<ol>
<li><strong>If you only configure return values</strong> ‚Üí You're using it as a stub</li>
<li><strong>If you only verify calls</strong> ‚Üí You're using it as a spy  </li>
<li><strong>If you do both</strong> ‚Üí You're using it as a true mock</li>
</ol>
<p>Knowing the terminology helps you:
- Communicate precisely with other developers
- Understand testing literature and documentation
- Make conscious decisions about test design
- Recognize when you're over-verifying (testing implementation details)</p>
<p>In the next sections, we'll explore <code>MagicMock</code>, which extends <code>Mock()</code> with additional capabilities for complex scenarios.</p>
<h2 id="using-magicmock-for-complex-scenarios">Using MagicMock for Complex Scenarios</h2>
<h2 id="using-magicmock-for-complex-scenarios_1">Using MagicMock for Complex Scenarios</h2>
<p>In Section 9.1, we used <code>Mock()</code> to create test doubles. But <code>Mock()</code> has a limitation: it doesn't support Python's "magic methods" (also called dunder methods) like <code>__len__</code>, <code>__getitem__</code>, <code>__iter__</code>, etc.</p>
<p>This limitation becomes a problem when testing code that uses these magic methods‚Äîcode that treats objects as containers, iterables, context managers, or callable objects.</p>
<h3 id="the-reference-implementation-a-data-pipeline">The Reference Implementation: A Data Pipeline</h3>
<p>Let's extend our payment processor with a data pipeline that processes batches of transactions. This pipeline uses Python's magic methods extensively.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># transaction_pipeline.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TransactionBatch</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a batch of transactions to process.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transactions</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transactions</span> <span class="o">=</span> <span class="n">transactions</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Support len(batch).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transactions</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Support batch[index].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transactions</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Support for transaction in batch.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transactions</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TransactionRepository</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetches transactions from database.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fetch_pending</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a TransactionBatch of pending transactions.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Real implementation queries database&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">mark_processed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Marks a transaction as processed.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Real implementation updates database&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BatchProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Processes batches of transactions.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repository</span><span class="p">,</span> <span class="n">payment_processor</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repository</span> <span class="o">=</span> <span class="n">repository</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">payment_processor</span> <span class="o">=</span> <span class="n">payment_processor</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_pending_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="c1"># Fetch batch from repository</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">fetch_pending</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>

        <span class="c1"># Check if batch is empty</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;processed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="n">processed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Iterate over transactions</span>
        <span class="k">for</span> <span class="n">transaction</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Process each transaction</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">payment_processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
                    <span class="n">user_id</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">],</span>
                    <span class="n">amount</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">],</span>
                    <span class="n">card_token</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;card_token&quot;</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">mark_processed</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
                    <span class="n">processed</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">failed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">failed</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;processed&quot;</span><span class="p">:</span> <span class="n">processed</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="n">failed</span><span class="p">}</span>
</code></pre></div>

<p>This code uses several magic methods:
- <code>len(batch)</code> - calls <code>__len__</code>
- <code>for transaction in batch</code> - calls <code>__iter__</code>
- <code>batch[index]</code> - calls <code>__getitem__</code> (not used here but part of the interface)</p>
<h3 id="iteration-0-attempting-to-mock-with-mock">Iteration 0: Attempting to Mock with Mock()</h3>
<p>Let's try to test this using regular <code>Mock()</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_batch_processor_mock.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">transaction_pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">BatchProcessor</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_empty_batch_with_mock</span><span class="p">():</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">payment_processor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="c1"># Try to create a mock batch that returns 0 for len()</span>
    <span class="n">mock_batch</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_batch</span><span class="o">.</span><span class="fm">__len__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">repository</span><span class="o">.</span><span class="n">fetch_pending</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_batch</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">payment_processor</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_pending_batch</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;processed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_batch_processor_mock.py::test_process_empty_batch_with_mock<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nx">test_batch_processor_mock</span><span class="p">.</span><span class="nx">py</span><span class="o">::</span><span class="nx">test_process_empty_batch_with_mock</span><span class="w"> </span><span class="nx">FAILED</span>

<span class="nx">def</span><span class="w"> </span><span class="nx">test_process_empty_batch_with_mock</span><span class="p">():</span>
<span class="w">    </span><span class="o">...</span>
<span class="w">    </span><span class="nx">result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">processor</span><span class="p">.</span><span class="nx">process_pending_batch</span><span class="p">(</span><span class="nx">limit</span><span class="p">=</span><span class="mi">10</span><span class="p">)</span>

<span class="nx">transaction_pipeline</span><span class="p">.</span><span class="nx">py</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">process_pending_batch</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">len</span><span class="p">(</span><span class="nx">batch</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>
<span class="nx">E</span><span class="w">   </span><span class="nx">TypeError</span><span class="p">:</span><span class="w"> </span><span class="nx">object</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">Mock</span><span class="err">&#39;</span><span class="w"> </span><span class="nx">has</span><span class="w"> </span><span class="nx">no</span><span class="w"> </span><span class="nx">len</span><span class="p">()</span>
</code></pre></div>

<h3 id="diagnostic-analysis-why-mock-fails-with-magic-methods">Diagnostic Analysis: Why Mock() Fails with Magic Methods</h3>
<p><strong>The complete output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nx">FAILED</span><span class="w"> </span><span class="nx">test_batch_processor_mock</span><span class="p">.</span><span class="nx">py</span><span class="o">::</span><span class="nx">test_process_empty_batch_with_mock</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">TypeError</span><span class="p">:</span><span class="w"> </span><span class="nx">object</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">Mock</span><span class="err">&#39;</span><span class="w"> </span><span class="nx">has</span><span class="w"> </span><span class="nx">no</span><span class="w"> </span><span class="nx">len</span><span class="p">()</span>
</code></pre></div>

<p><strong>Let's parse this</strong>:</p>
<ol>
<li><strong>The summary line</strong>: <code>TypeError: object of type 'Mock' has no len()</code></li>
<li>
<p>What this tells us: Python's <code>len()</code> function cannot be called on a <code>Mock</code> object</p>
</li>
<li>
<p><strong>The traceback</strong>:</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">transaction_pipeline</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span> <span class="ow">in</span> <span class="n">process_pending_batch</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</code></pre></div>

<ul>
<li>What this tells us: The failure occurs when our code tries to call <code>len()</code> on the batch</li>
<li>
<p>Key line: <code>if len(batch) == 0:</code> - this is where the code breaks</p>
</li>
<li>
<p><strong>The root cause</strong>:</p>
</li>
<li>We configured <code>mock_batch.__len__.return_value = 0</code></li>
<li>But <code>Mock()</code> doesn't actually support magic methods</li>
<li>When Python calls <code>len(mock_batch)</code>, it looks for <code>__len__</code> at the class level, not the instance level</li>
<li><code>Mock()</code> doesn't implement <code>__len__</code> at the class level, so it fails</li>
</ul>
<p><strong>Root cause identified</strong>: <code>Mock()</code> doesn't support Python's magic methods because they must be defined at the class level, not the instance level.</p>
<p><strong>Why the current approach can't solve this</strong>: Configuring <code>mock_batch.__len__.return_value</code> creates an instance attribute, but Python's <code>len()</code> function looks for <code>__len__</code> as a class method.</p>
<p><strong>What we need</strong>: A mock object that properly implements magic methods at the class level.</p>
<h3 id="iteration-1-introducing-magicmock">Iteration 1: Introducing MagicMock</h3>
<p><code>MagicMock</code> is a subclass of <code>Mock</code> that pre-configures all magic methods. It's designed specifically for scenarios where your code uses Python's special methods.</p>
<p>Let's fix our test:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_batch_processor_magicmock.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">MagicMock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">transaction_pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">BatchProcessor</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_empty_batch_with_magicmock</span><span class="p">():</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">payment_processor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="c1"># Use MagicMock instead of Mock</span>
    <span class="n">mock_batch</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_batch</span><span class="o">.</span><span class="fm">__len__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">repository</span><span class="o">.</span><span class="n">fetch_pending</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_batch</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">payment_processor</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_pending_batch</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;processed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_batch_processor_magicmock.py::test_process_empty_batch_with_magicmock<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_batch_processor_magicmock.py::test_process_empty_batch_with_magicmock PASSED
</code></pre></div>

<p><strong>What changed</strong>:
- We replaced <code>Mock()</code> with <code>MagicMock()</code>
- Now <code>len(mock_batch)</code> works correctly
- The magic method <code>__len__</code> is properly implemented at the class level</p>
<h3 id="iteration-2-testing-iteration-with-magicmock">Iteration 2: Testing Iteration with MagicMock</h3>
<p>Now let's test the case where we have transactions to process:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_process_batch_with_transactions</span><span class="p">():</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">payment_processor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="c1"># Create mock transactions</span>
    <span class="n">transactions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_1&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user_1&quot;</span><span class="p">,</span> <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">10.00</span><span class="p">,</span> <span class="s2">&quot;card_token&quot;</span><span class="p">:</span> <span class="s2">&quot;tok_1&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_2&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user_2&quot;</span><span class="p">,</span> <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">20.00</span><span class="p">,</span> <span class="s2">&quot;card_token&quot;</span><span class="p">:</span> <span class="s2">&quot;tok_2&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_3&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user_3&quot;</span><span class="p">,</span> <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">30.00</span><span class="p">,</span> <span class="s2">&quot;card_token&quot;</span><span class="p">:</span> <span class="s2">&quot;tok_3&quot;</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="c1"># Create a MagicMock batch</span>
    <span class="n">mock_batch</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_batch</span><span class="o">.</span><span class="fm">__len__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">mock_batch</span><span class="o">.</span><span class="fm">__iter__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span>

    <span class="n">repository</span><span class="o">.</span><span class="n">fetch_pending</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_batch</span>

    <span class="c1"># Make payment processor return success for all</span>
    <span class="n">payment_processor</span><span class="o">.</span><span class="n">process_payment</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">}</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">payment_processor</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_pending_batch</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;processed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="c1"># Verify all transactions were marked as processed</span>
    <span class="k">assert</span> <span class="n">repository</span><span class="o">.</span><span class="n">mark_processed</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="n">repository</span><span class="o">.</span><span class="n">mark_processed</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;txn_1&quot;</span><span class="p">)</span>
    <span class="n">repository</span><span class="o">.</span><span class="n">mark_processed</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;txn_2&quot;</span><span class="p">)</span>
    <span class="n">repository</span><span class="o">.</span><span class="n">mark_processed</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;txn_3&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_batch_processor_magicmock.py::test_process_batch_with_transactions<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_batch_processor_magicmock.py::test_process_batch_with_transactions PASSED
</code></pre></div>

<p><strong>What we configured</strong>:
- <code>__len__</code> returns 3 (the batch has 3 transactions)
- <code>__iter__</code> returns an iterator over our transaction list
- Both magic methods work correctly with <code>MagicMock</code></p>
<h3 id="iteration-3-testing-mixed-success-and-failure">Iteration 3: Testing Mixed Success and Failure</h3>
<p>Let's test a scenario where some transactions succeed and others fail:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_process_batch_with_mixed_results</span><span class="p">():</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">payment_processor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">transactions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_1&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user_1&quot;</span><span class="p">,</span> <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">10.00</span><span class="p">,</span> <span class="s2">&quot;card_token&quot;</span><span class="p">:</span> <span class="s2">&quot;tok_1&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_2&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user_2&quot;</span><span class="p">,</span> <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">20.00</span><span class="p">,</span> <span class="s2">&quot;card_token&quot;</span><span class="p">:</span> <span class="s2">&quot;tok_2&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_3&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user_3&quot;</span><span class="p">,</span> <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">30.00</span><span class="p">,</span> <span class="s2">&quot;card_token&quot;</span><span class="p">:</span> <span class="s2">&quot;tok_3&quot;</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="n">mock_batch</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_batch</span><span class="o">.</span><span class="fm">__len__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">mock_batch</span><span class="o">.</span><span class="fm">__iter__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span>

    <span class="n">repository</span><span class="o">.</span><span class="n">fetch_pending</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_batch</span>

    <span class="c1"># Make payment processor return different results</span>
    <span class="n">payment_processor</span><span class="o">.</span><span class="n">process_payment</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">},</span>  <span class="c1"># txn_1 succeeds</span>
        <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;rejected&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;fraud_detected&quot;</span><span class="p">},</span>  <span class="c1"># txn_2 fails</span>
        <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">},</span>  <span class="c1"># txn_3 succeeds</span>
    <span class="p">]</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">payment_processor</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_pending_batch</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;processed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="c1"># Verify only successful transactions were marked as processed</span>
    <span class="k">assert</span> <span class="n">repository</span><span class="o">.</span><span class="n">mark_processed</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="n">repository</span><span class="o">.</span><span class="n">mark_processed</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;txn_1&quot;</span><span class="p">)</span>
    <span class="n">repository</span><span class="o">.</span><span class="n">mark_processed</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;txn_3&quot;</span><span class="p">)</span>

    <span class="c1"># Verify txn_2 was NOT marked as processed</span>
    <span class="n">calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">call</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">repository</span><span class="o">.</span><span class="n">mark_processed</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">]</span>
    <span class="k">assert</span> <span class="s2">&quot;txn_2&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">calls</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_batch_processor_magicmock.py::test_process_batch_with_mixed_results<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_batch_processor_magicmock.py::test_process_batch_with_mixed_results PASSED
</code></pre></div>

<p><strong>What we demonstrated</strong>:
- Used <code>side_effect</code> to return different results for each call
- Verified that only successful transactions were marked as processed
- Inspected the actual calls to confirm txn_2 was not processed</p>
<h3 id="common-magic-methods-supported-by-magicmock">Common Magic Methods Supported by MagicMock</h3>
<p><code>MagicMock</code> pre-configures these magic methods:</p>
<p><strong>Container methods</strong>:
- <code>__len__</code> - <code>len(obj)</code>
- <code>__getitem__</code> - <code>obj[key]</code>
- <code>__setitem__</code> - <code>obj[key] = value</code>
- <code>__delitem__</code> - <code>del obj[key]</code>
- <code>__contains__</code> - <code>key in obj</code></p>
<p><strong>Iteration methods</strong>:
- <code>__iter__</code> - <code>for item in obj</code>
- <code>__next__</code> - <code>next(obj)</code></p>
<p><strong>Numeric methods</strong>:
- <code>__add__</code>, <code>__sub__</code>, <code>__mul__</code>, <code>__div__</code> - arithmetic operators
- <code>__lt__</code>, <code>__le__</code>, <code>__gt__</code>, <code>__ge__</code> - comparison operators</p>
<p><strong>Context manager methods</strong>:
- <code>__enter__</code> - <code>with obj:</code>
- <code>__exit__</code> - cleanup after <code>with</code> block</p>
<p><strong>Callable methods</strong>:
- <code>__call__</code> - <code>obj()</code></p>
<p><strong>String representation</strong>:
- <code>__str__</code> - <code>str(obj)</code>
- <code>__repr__</code> - <code>repr(obj)</code></p>
<h3 id="iteration-4-testing-context-managers">Iteration 4: Testing Context Managers</h3>
<p>Let's add a feature that uses context managers:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># transaction_pipeline.py (addition)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TransactionLock</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensures only one batch processes at a time.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Real implementation acquires distributed lock&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Real implementation releases lock&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BatchProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Processes batches of transactions.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repository</span><span class="p">,</span> <span class="n">payment_processor</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repository</span> <span class="o">=</span> <span class="n">repository</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">payment_processor</span> <span class="o">=</span> <span class="n">payment_processor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">lock</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_pending_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="c1"># Acquire lock if provided</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_batch</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_batch</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">fetch_pending</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;processed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="n">processed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">transaction</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">payment_processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
                    <span class="n">user_id</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">],</span>
                    <span class="n">amount</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">],</span>
                    <span class="n">card_token</span><span class="o">=</span><span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;card_token&quot;</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">mark_processed</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
                    <span class="n">processed</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">failed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">failed</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;processed&quot;</span><span class="p">:</span> <span class="n">processed</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="n">failed</span><span class="p">}</span>
</code></pre></div>

<p>Now test the lock behavior:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_process_batch_with_lock</span><span class="p">():</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">payment_processor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>  <span class="c1"># MagicMock supports __enter__ and __exit__</span>

    <span class="n">mock_batch</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_batch</span><span class="o">.</span><span class="fm">__len__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">repository</span><span class="o">.</span><span class="n">fetch_pending</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_batch</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">payment_processor</span><span class="p">,</span> <span class="n">lock</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_pending_batch</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;processed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="c1"># Verify lock was acquired and released</span>
    <span class="n">lock</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">lock</span><span class="o">.</span><span class="fm">__exit__</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_batch_processor_magicmock.py::test_process_batch_with_lock<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_batch_processor_magicmock.py::test_process_batch_with_lock PASSED
</code></pre></div>

<p><strong>What we verified</strong>:
- The lock's <code>__enter__</code> method was called (lock acquired)
- The lock's <code>__exit__</code> method was called (lock released)
- <code>MagicMock</code> automatically supports context manager protocol</p>
<h3 id="when-to-use-magicmock-vs-mock">When to Use MagicMock vs Mock</h3>
<p><strong>Use MagicMock when</strong>:
- Your code uses magic methods (<code>len()</code>, iteration, indexing, etc.)
- You're testing code that treats objects as containers
- You're testing context managers (<code>with</code> statements)
- You're testing callable objects
- You're testing operator overloading</p>
<p><strong>Use regular Mock when</strong>:
- You only need to mock regular methods and attributes
- You want to be explicit about what's being mocked
- You don't need magic method support
- You want slightly better performance (MagicMock has more overhead)</p>
<p><strong>Practical guideline</strong>: Start with <code>Mock()</code>. If you get a <code>TypeError</code> about magic methods, switch to <code>MagicMock()</code>.</p>
<h3 id="the-complete-test-suite">The Complete Test Suite</h3>
<p>Here's our complete test suite using <code>MagicMock</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_batch_processor_complete.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">MagicMock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">transaction_pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">BatchProcessor</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_empty_batch</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test processing when no transactions are pending.&quot;&quot;&quot;</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">payment_processor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">mock_batch</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_batch</span><span class="o">.</span><span class="fm">__len__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">repository</span><span class="o">.</span><span class="n">fetch_pending</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_batch</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">payment_processor</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_pending_batch</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;processed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">repository</span><span class="o">.</span><span class="n">mark_processed</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_batch_all_succeed</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test processing when all transactions succeed.&quot;&quot;&quot;</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">payment_processor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">transactions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_1&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user_1&quot;</span><span class="p">,</span> <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">10.00</span><span class="p">,</span> <span class="s2">&quot;card_token&quot;</span><span class="p">:</span> <span class="s2">&quot;tok_1&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_2&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user_2&quot;</span><span class="p">,</span> <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">20.00</span><span class="p">,</span> <span class="s2">&quot;card_token&quot;</span><span class="p">:</span> <span class="s2">&quot;tok_2&quot;</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="n">mock_batch</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_batch</span><span class="o">.</span><span class="fm">__len__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">mock_batch</span><span class="o">.</span><span class="fm">__iter__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span>
    <span class="n">repository</span><span class="o">.</span><span class="n">fetch_pending</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_batch</span>

    <span class="n">payment_processor</span><span class="o">.</span><span class="n">process_payment</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">}</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">payment_processor</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_pending_batch</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;processed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_batch_with_failures</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test processing when some transactions fail.&quot;&quot;&quot;</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">payment_processor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">transactions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_1&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user_1&quot;</span><span class="p">,</span> <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">10.00</span><span class="p">,</span> <span class="s2">&quot;card_token&quot;</span><span class="p">:</span> <span class="s2">&quot;tok_1&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_2&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;user_2&quot;</span><span class="p">,</span> <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">20.00</span><span class="p">,</span> <span class="s2">&quot;card_token&quot;</span><span class="p">:</span> <span class="s2">&quot;tok_2&quot;</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="n">mock_batch</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_batch</span><span class="o">.</span><span class="fm">__len__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">mock_batch</span><span class="o">.</span><span class="fm">__iter__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span>
    <span class="n">repository</span><span class="o">.</span><span class="n">fetch_pending</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_batch</span>

    <span class="n">payment_processor</span><span class="o">.</span><span class="n">process_payment</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;rejected&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;fraud_detected&quot;</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">payment_processor</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_pending_batch</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;processed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_batch_with_lock</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that lock is properly acquired and released.&quot;&quot;&quot;</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">payment_processor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>

    <span class="n">mock_batch</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_batch</span><span class="o">.</span><span class="fm">__len__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">repository</span><span class="o">.</span><span class="n">fetch_pending</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_batch</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">payment_processor</span><span class="p">,</span> <span class="n">lock</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_pending_batch</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">lock</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">lock</span><span class="o">.</span><span class="fm">__exit__</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
</code></pre></div>

<p>Run the complete suite:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_batch_processor_complete.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_batch_processor_complete.py::test_process_empty_batch PASSED
test_batch_processor_complete.py::test_process_batch_all_succeed PASSED
test_batch_processor_complete.py::test_process_batch_with_failures PASSED
test_batch_processor_complete.py::test_process_batch_with_lock PASSED
</code></pre></div>

<h3 id="key-takeaways">Key Takeaways</h3>
<ol>
<li><strong>MagicMock extends Mock</strong>: It's a subclass that pre-configures magic methods</li>
<li><strong>Use it for special Python protocols</strong>: Containers, iterables, context managers, callables</li>
<li><strong>Configure magic methods like regular methods</strong>: Use <code>return_value</code> and <code>side_effect</code></li>
<li><strong>It's still a mock</strong>: You can verify calls to magic methods just like regular methods</li>
<li><strong>Start with Mock, upgrade to MagicMock</strong>: Only use MagicMock when you need magic method support</li>
</ol>
<p>In the next section, we'll explore how to mock entire classes, not just individual objects.</p>
<h2 id="mocking-entire-classes">Mocking Entire Classes</h2>
<h2 id="mocking-entire-classes_1">Mocking Entire Classes</h2>
<p>So far, we've mocked individual objects‚Äîcreating a mock instance and configuring its methods. But sometimes you need to mock an entire class, so that every instance created from that class is automatically a mock.</p>
<p>This is essential when:
- Your code creates instances internally (you can't inject them)
- You need to verify that a class was instantiated with specific arguments
- You want all instances of a class to behave the same way in tests</p>
<h3 id="the-reference-implementation-a-payment-service-factory">The Reference Implementation: A Payment Service Factory</h3>
<p>Let's extend our payment system with a factory pattern that creates payment processors internally:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_service.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentProcessor</span><span class="p">,</span> <span class="n">PaymentGateway</span><span class="p">,</span> <span class="n">FraudDetector</span><span class="p">,</span> <span class="n">NotificationService</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentServiceFactory</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates payment processors with proper dependencies.&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_processor</span><span class="p">(</span><span class="n">gateway_type</span><span class="o">=</span><span class="s2">&quot;stripe&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a payment processor with the specified gateway.&quot;&quot;&quot;</span>
        <span class="c1"># Create dependencies - we instantiate classes here</span>
        <span class="k">if</span> <span class="n">gateway_type</span> <span class="o">==</span> <span class="s2">&quot;stripe&quot;</span><span class="p">:</span>
            <span class="n">gateway</span> <span class="o">=</span> <span class="n">PaymentGateway</span><span class="p">()</span>  <span class="c1"># Creates Stripe gateway</span>
        <span class="k">elif</span> <span class="n">gateway_type</span> <span class="o">==</span> <span class="s2">&quot;paypal&quot;</span><span class="p">:</span>
            <span class="n">gateway</span> <span class="o">=</span> <span class="n">PaymentGateway</span><span class="p">()</span>  <span class="c1"># Creates PayPal gateway</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown gateway type: </span><span class="si">{</span><span class="n">gateway_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">fraud_detector</span> <span class="o">=</span> <span class="n">FraudDetector</span><span class="p">()</span>  <span class="c1"># Creates fraud detector</span>
        <span class="n">notifier</span> <span class="o">=</span> <span class="n">NotificationService</span><span class="p">()</span>  <span class="c1"># Creates notification service</span>

        <span class="c1"># Return configured processor</span>
        <span class="k">return</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">gateway</span><span class="p">,</span> <span class="n">fraud_detector</span><span class="p">,</span> <span class="n">notifier</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;High-level payment service that uses the factory.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gateway_type</span><span class="o">=</span><span class="s2">&quot;stripe&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentServiceFactory</span><span class="o">.</span><span class="n">create_processor</span><span class="p">(</span><span class="n">gateway_type</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">charge_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">card_token</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Charges a customer using the configured processor.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">card_token</span><span class="p">)</span>
</code></pre></div>

<p>The problem: <code>PaymentService</code> creates its own <code>PaymentProcessor</code> internally. We can't inject a mock processor because the factory creates it. We need to mock the classes themselves.</p>
<h3 id="iteration-0-attempting-to-mock-individual-instances">Iteration 0: Attempting to Mock Individual Instances</h3>
<p>Let's try the approach we know:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_service_naive.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentService</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_charge_customer_naive</span><span class="p">():</span>
    <span class="c1"># Try to create a mock processor</span>
    <span class="n">mock_processor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_processor</span><span class="o">.</span><span class="n">process_payment</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
        <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span>
    <span class="p">}</span>

    <span class="c1"># Create service</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">PaymentService</span><span class="p">(</span><span class="n">gateway_type</span><span class="o">=</span><span class="s2">&quot;stripe&quot;</span><span class="p">)</span>

    <span class="c1"># Try to charge</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">charge_customer</span><span class="p">(</span><span class="s2">&quot;user_42&quot;</span><span class="p">,</span> <span class="mf">99.99</span><span class="p">,</span> <span class="s2">&quot;tok_visa&quot;</span><span class="p">)</span>

    <span class="c1"># This will fail because service created its own processor</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_service_naive.py::test_charge_customer_naive<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nx">test_payment_service_naive</span><span class="p">.</span><span class="nx">py</span><span class="o">::</span><span class="nx">test_charge_customer_naive</span><span class="w"> </span><span class="nx">FAILED</span>

<span class="nx">def</span><span class="w"> </span><span class="nx">test_charge_customer_naive</span><span class="p">():</span>
<span class="w">    </span><span class="o">...</span>
<span class="w">    </span><span class="nx">service</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">PaymentService</span><span class="p">(</span><span class="nx">gateway_type</span><span class="p">=</span><span class="s">&quot;stripe&quot;</span><span class="p">)</span>

<span class="nx">payment_service</span><span class="p">.</span><span class="nx">py</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">create_processor</span>
<span class="w">    </span><span class="nx">gateway</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">PaymentGateway</span><span class="p">()</span>
<span class="nx">payment_processor</span><span class="p">.</span><span class="nx">py</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">__init__</span>
<span class="w">    </span><span class="nx">raise</span><span class="w"> </span><span class="nx">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Real implementation calls external API&quot;</span><span class="p">)</span>
<span class="nx">E</span><span class="w">   </span><span class="nx">NotImplementedError</span><span class="p">:</span><span class="w"> </span><span class="nx">Real</span><span class="w"> </span><span class="nx">implementation</span><span class="w"> </span><span class="nx">calls</span><span class="w"> </span><span class="kd">external</span><span class="w"> </span><span class="nx">API</span>
</code></pre></div>

<h3 id="diagnostic-analysis-why-instance-mocking-fails">Diagnostic Analysis: Why Instance Mocking Fails</h3>
<p><strong>The complete output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nx">FAILED</span><span class="w"> </span><span class="nx">test_payment_service_naive</span><span class="p">.</span><span class="nx">py</span><span class="o">::</span><span class="nx">test_charge_customer_naive</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">NotImplementedError</span><span class="p">:</span><span class="w"> </span><span class="nx">Real</span><span class="w"> </span><span class="nx">implementation</span><span class="w"> </span><span class="nx">calls</span><span class="w"> </span><span class="kd">external</span><span class="w"> </span><span class="nx">API</span>
</code></pre></div>

<p><strong>Let's parse this</strong>:</p>
<ol>
<li><strong>The summary line</strong>: <code>NotImplementedError: Real implementation calls external API</code></li>
<li>
<p>What this tells us: The real <code>PaymentGateway</code> class is being instantiated</p>
</li>
<li>
<p><strong>The traceback</strong>:</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">payment_service</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span> <span class="ow">in</span> <span class="n">create_processor</span>
    <span class="n">gateway</span> <span class="o">=</span> <span class="n">PaymentGateway</span><span class="p">()</span>
<span class="n">payment_processor</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span> <span class="ow">in</span> <span class="fm">__init__</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Real implementation calls external API&quot;</span><span class="p">)</span>
</code></pre></div>

<ul>
<li>What this tells us: The factory is creating a real <code>PaymentGateway</code> instance</li>
<li>
<p>Key line: <code>gateway = PaymentGateway()</code> - this creates a real instance, not our mock</p>
</li>
<li>
<p><strong>The root cause</strong>:</p>
</li>
<li>We created a mock processor instance, but the service doesn't use it</li>
<li>The factory creates its own instances by calling the class constructors</li>
<li>Our mock never gets used because we can't inject it</li>
</ul>
<p><strong>Root cause identified</strong>: We need to mock the class itself, not just create a mock instance.</p>
<p><strong>Why the current approach can't solve this</strong>: Creating a mock instance doesn't affect what happens when code calls <code>PaymentGateway()</code>. The class constructor still creates real instances.</p>
<p><strong>What we need</strong>: A way to replace the class itself so that calling <code>PaymentGateway()</code> returns a mock instead of a real instance.</p>
<h3 id="iteration-1-introducing-patch-for-class-mocking">Iteration 1: Introducing patch() for Class Mocking</h3>
<p>The <code>@patch</code> decorator can mock entire classes. When you patch a class, every call to that class's constructor returns a mock instance.</p>
<p>Let's fix our test:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_service_patched.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentService</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.NotificationService&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.FraudDetector&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.PaymentGateway&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.PaymentProcessor&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_charge_customer_with_class_mocking</span><span class="p">(</span>
    <span class="n">mock_processor_class</span><span class="p">,</span>
    <span class="n">mock_gateway_class</span><span class="p">,</span>
    <span class="n">mock_fraud_class</span><span class="p">,</span>
    <span class="n">mock_notifier_class</span>
<span class="p">):</span>
    <span class="c1"># Configure what the mocked PaymentProcessor instance should return</span>
    <span class="n">mock_processor_instance</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_processor_instance</span><span class="o">.</span><span class="n">process_payment</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
        <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span>
    <span class="p">}</span>

    <span class="c1"># Make the PaymentProcessor class return our configured instance</span>
    <span class="n">mock_processor_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_processor_instance</span>

    <span class="c1"># Create service - this will use mocked classes</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">PaymentService</span><span class="p">(</span><span class="n">gateway_type</span><span class="o">=</span><span class="s2">&quot;stripe&quot;</span><span class="p">)</span>

    <span class="c1"># Charge customer</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">charge_customer</span><span class="p">(</span><span class="s2">&quot;user_42&quot;</span><span class="p">,</span> <span class="mf">99.99</span><span class="p">,</span> <span class="s2">&quot;tok_visa&quot;</span><span class="p">)</span>

    <span class="c1"># Verify result</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;txn_12345&quot;</span>

    <span class="c1"># Verify the processor was called correctly</span>
    <span class="n">mock_processor_instance</span><span class="o">.</span><span class="n">process_payment</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="s2">&quot;user_42&quot;</span><span class="p">,</span> <span class="mf">99.99</span><span class="p">,</span> <span class="s2">&quot;tok_visa&quot;</span>
    <span class="p">)</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_service_patched.py::test_charge_customer_with_class_mocking<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_service_patched.py::test_charge_customer_with_class_mocking PASSED
</code></pre></div>

<p><strong>What changed</strong>:
- We used <code>@patch</code> to replace the classes themselves
- <code>mock_processor_class</code> is the mocked <code>PaymentProcessor</code> class
- When code calls <code>PaymentProcessor(...)</code>, it returns <code>mock_processor_instance</code>
- We configured <code>mock_processor_class.return_value</code> to control what instance is created</p>
<h3 id="understanding-class-mocking-the-two-level-system">Understanding Class Mocking: The Two-Level System</h3>
<p>When you patch a class, you get two mock objects:</p>
<ol>
<li><strong>The mock class</strong> (<code>mock_processor_class</code>): Represents the class itself</li>
<li><strong>The mock instance</strong> (<code>mock_processor_class.return_value</code>): What gets returned when the class is instantiated</li>
</ol>
<p>This diagram shows the relationship:</p>
<div class="codehilite"><pre><span></span><code>Real Code:                          Test Code:
-----------                         -----------
PaymentProcessor (class)    ‚Üí       mock_processor_class (Mock)
    ‚Üì instantiate                       ‚Üì .return_value
processor (instance)        ‚Üí       mock_processor_instance (Mock)
    ‚Üì call method                       ‚Üì configure
processor.process_payment() ‚Üí       .process_payment.return_value
</code></pre></div>

<h3 id="iteration-2-verifying-class-instantiation">Iteration 2: Verifying Class Instantiation</h3>
<p>Let's verify that the classes were instantiated with the correct arguments:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.NotificationService&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.FraudDetector&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.PaymentGateway&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.PaymentProcessor&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_verify_class_instantiation</span><span class="p">(</span>
    <span class="n">mock_processor_class</span><span class="p">,</span>
    <span class="n">mock_gateway_class</span><span class="p">,</span>
    <span class="n">mock_fraud_class</span><span class="p">,</span>
    <span class="n">mock_notifier_class</span>
<span class="p">):</span>
    <span class="c1"># Configure processor instance</span>
    <span class="n">mock_processor_instance</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_processor_instance</span><span class="o">.</span><span class="n">process_payment</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
        <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span>
    <span class="p">}</span>
    <span class="n">mock_processor_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_processor_instance</span>

    <span class="c1"># Create service</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">PaymentService</span><span class="p">(</span><span class="n">gateway_type</span><span class="o">=</span><span class="s2">&quot;stripe&quot;</span><span class="p">)</span>

    <span class="c1"># Verify all dependency classes were instantiated</span>
    <span class="n">mock_gateway_class</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">mock_fraud_class</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">mock_notifier_class</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="c1"># Verify PaymentProcessor was instantiated with the mocked dependencies</span>
    <span class="n">mock_processor_class</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">mock_gateway_class</span><span class="o">.</span><span class="n">return_value</span><span class="p">,</span>  <span class="c1"># The gateway instance</span>
        <span class="n">mock_fraud_class</span><span class="o">.</span><span class="n">return_value</span><span class="p">,</span>    <span class="c1"># The fraud detector instance</span>
        <span class="n">mock_notifier_class</span><span class="o">.</span><span class="n">return_value</span>  <span class="c1"># The notifier instance</span>
    <span class="p">)</span>

    <span class="c1"># Charge customer</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">charge_customer</span><span class="p">(</span><span class="s2">&quot;user_42&quot;</span><span class="p">,</span> <span class="mf">99.99</span><span class="p">,</span> <span class="s2">&quot;tok_visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_service_patched.py::test_verify_class_instantiation<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_service_patched.py::test_verify_class_instantiation PASSED
</code></pre></div>

<p><strong>What we verified</strong>:
- Each dependency class was instantiated exactly once
- <code>PaymentProcessor</code> was instantiated with the correct mock instances
- The instances passed to <code>PaymentProcessor</code> are the <code>.return_value</code> of each mocked class</p>
<h3 id="iteration-3-testing-different-gateway-types">Iteration 3: Testing Different Gateway Types</h3>
<p>Let's test that different gateway types create different configurations:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.NotificationService&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.FraudDetector&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.PaymentGateway&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.PaymentProcessor&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_different_gateway_types</span><span class="p">(</span>
    <span class="n">mock_processor_class</span><span class="p">,</span>
    <span class="n">mock_gateway_class</span><span class="p">,</span>
    <span class="n">mock_fraud_class</span><span class="p">,</span>
    <span class="n">mock_notifier_class</span>
<span class="p">):</span>
    <span class="c1"># Configure processor</span>
    <span class="n">mock_processor_instance</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_processor_instance</span><span class="o">.</span><span class="n">process_payment</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">}</span>
    <span class="n">mock_processor_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_processor_instance</span>

    <span class="c1"># Test Stripe gateway</span>
    <span class="n">service_stripe</span> <span class="o">=</span> <span class="n">PaymentService</span><span class="p">(</span><span class="n">gateway_type</span><span class="o">=</span><span class="s2">&quot;stripe&quot;</span><span class="p">)</span>
    <span class="n">service_stripe</span><span class="o">.</span><span class="n">charge_customer</span><span class="p">(</span><span class="s2">&quot;user_42&quot;</span><span class="p">,</span> <span class="mf">99.99</span><span class="p">,</span> <span class="s2">&quot;tok_visa&quot;</span><span class="p">)</span>

    <span class="c1"># Verify gateway was created</span>
    <span class="k">assert</span> <span class="n">mock_gateway_class</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="c1"># Reset mocks</span>
    <span class="n">mock_gateway_class</span><span class="o">.</span><span class="n">reset_mock</span><span class="p">()</span>
    <span class="n">mock_processor_class</span><span class="o">.</span><span class="n">reset_mock</span><span class="p">()</span>

    <span class="c1"># Test PayPal gateway</span>
    <span class="n">service_paypal</span> <span class="o">=</span> <span class="n">PaymentService</span><span class="p">(</span><span class="n">gateway_type</span><span class="o">=</span><span class="s2">&quot;paypal&quot;</span><span class="p">)</span>
    <span class="n">service_paypal</span><span class="o">.</span><span class="n">charge_customer</span><span class="p">(</span><span class="s2">&quot;user_42&quot;</span><span class="p">,</span> <span class="mf">99.99</span><span class="p">,</span> <span class="s2">&quot;tok_visa&quot;</span><span class="p">)</span>

    <span class="c1"># Verify gateway was created again</span>
    <span class="k">assert</span> <span class="n">mock_gateway_class</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_service_patched.py::test_different_gateway_types<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nx">test_payment_service_patched</span><span class="p">.</span><span class="nx">py</span><span class="o">::</span><span class="nx">test_different_gateway_types</span><span class="w"> </span><span class="nx">PASSED</span>
</code></pre></div>

<p><strong>What we demonstrated</strong>:
- We can test multiple instantiations of the same class
- <code>reset_mock()</code> clears call history between tests
- Each instantiation is tracked separately</p>
<h3 id="iteration-4-handling-invalid-gateway-types">Iteration 4: Handling Invalid Gateway Types</h3>
<p>Let's test error handling:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.NotificationService&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.FraudDetector&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.PaymentGateway&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.PaymentProcessor&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_gateway_type</span><span class="p">(</span>
    <span class="n">mock_processor_class</span><span class="p">,</span>
    <span class="n">mock_gateway_class</span><span class="p">,</span>
    <span class="n">mock_fraud_class</span><span class="p">,</span>
    <span class="n">mock_notifier_class</span>
<span class="p">):</span>
    <span class="c1"># Attempt to create service with invalid gateway</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="n">service</span> <span class="o">=</span> <span class="n">PaymentService</span><span class="p">(</span><span class="n">gateway_type</span><span class="o">=</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="s2">&quot;Unknown gateway type: invalid&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># Verify no classes were instantiated</span>
    <span class="n">mock_gateway_class</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
    <span class="n">mock_fraud_class</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
    <span class="n">mock_notifier_class</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
    <span class="n">mock_processor_class</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_service_patched.py::test_invalid_gateway_type<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nx">test_payment_service_patched</span><span class="p">.</span><span class="nx">py</span><span class="o">::</span><span class="nx">test_invalid_gateway_type</span><span class="w"> </span><span class="nx">PASSED</span>
</code></pre></div>

<p><strong>What we verified</strong>:
- The factory raises an appropriate error for invalid gateway types
- No classes were instantiated when the error occurred
- We can verify that classes were NOT called using <code>assert_not_called()</code></p>
<h3 id="the-patch-target-where-to-patch">The patch() Target: Where to Patch</h3>
<p>A critical detail: we patched <code>'payment_service.PaymentGateway'</code>, not <code>'payment_processor.PaymentGateway'</code>.</p>
<p><strong>Rule</strong>: Patch where the class is used, not where it's defined.</p>
<p>Here's why:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_service.py imports PaymentGateway</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentGateway</span>

<span class="c1"># When this code runs:</span>
<span class="n">gateway</span> <span class="o">=</span> <span class="n">PaymentGateway</span><span class="p">()</span>

<span class="c1"># Python looks up PaymentGateway in payment_service&#39;s namespace</span>
<span class="c1"># So we must patch &#39;payment_service.PaymentGateway&#39;</span>
</code></pre></div>

<p>If we patched <code>'payment_processor.PaymentGateway'</code>, it would replace the class in the <code>payment_processor</code> module, but <code>payment_service</code> already imported it into its own namespace. The patch wouldn't affect the imported reference.</p>
<h3 id="common-failure-mode-patching-the-wrong-location">Common Failure Mode: Patching the Wrong Location</h3>
<p>Let's demonstrate this mistake:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Wrong: patching where it&#39;s defined</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_processor.PaymentGateway&#39;</span><span class="p">)</span>  <span class="c1"># Wrong location!</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.PaymentProcessor&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_wrong_patch_location</span><span class="p">(</span><span class="n">mock_processor_class</span><span class="p">,</span> <span class="n">mock_gateway_class</span><span class="p">):</span>
    <span class="n">mock_processor_instance</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_processor_instance</span><span class="o">.</span><span class="n">process_payment</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">}</span>
    <span class="n">mock_processor_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_processor_instance</span>

    <span class="c1"># This will fail because PaymentGateway isn&#39;t patched in payment_service</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">PaymentService</span><span class="p">(</span><span class="n">gateway_type</span><span class="o">=</span><span class="s2">&quot;stripe&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_service_patched.py::test_wrong_patch_location<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nx">test_payment_service_patched</span><span class="p">.</span><span class="nx">py</span><span class="o">::</span><span class="nx">test_wrong_patch_location</span><span class="w"> </span><span class="nx">FAILED</span>

<span class="nx">payment_service</span><span class="p">.</span><span class="nx">py</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">create_processor</span>
<span class="w">    </span><span class="nx">gateway</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">PaymentGateway</span><span class="p">()</span>
<span class="nx">payment_processor</span><span class="p">.</span><span class="nx">py</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">__init__</span>
<span class="w">    </span><span class="nx">raise</span><span class="w"> </span><span class="nx">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Real implementation calls external API&quot;</span><span class="p">)</span>
<span class="nx">E</span><span class="w">   </span><span class="nx">NotImplementedError</span><span class="p">:</span><span class="w"> </span><span class="nx">Real</span><span class="w"> </span><span class="nx">implementation</span><span class="w"> </span><span class="nx">calls</span><span class="w"> </span><span class="kd">external</span><span class="w"> </span><span class="nx">API</span>
</code></pre></div>

<p>The real class is still being instantiated because we patched the wrong location.</p>
<h3 id="using-patchobject-for-explicit-class-mocking">Using patch.object() for Explicit Class Mocking</h3>
<p>An alternative to string-based patching is <code>patch.object()</code>, which patches an attribute of an object:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">payment_service</span>

<span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">payment_service</span><span class="p">,</span> <span class="s1">&#39;NotificationService&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">payment_service</span><span class="p">,</span> <span class="s1">&#39;FraudDetector&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">payment_service</span><span class="p">,</span> <span class="s1">&#39;PaymentGateway&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">payment_service</span><span class="p">,</span> <span class="s1">&#39;PaymentProcessor&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_with_patch_object</span><span class="p">(</span>
    <span class="n">mock_processor_class</span><span class="p">,</span>
    <span class="n">mock_gateway_class</span><span class="p">,</span>
    <span class="n">mock_fraud_class</span><span class="p">,</span>
    <span class="n">mock_notifier_class</span>
<span class="p">):</span>
    <span class="n">mock_processor_instance</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_processor_instance</span><span class="o">.</span><span class="n">process_payment</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
        <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span>
    <span class="p">}</span>
    <span class="n">mock_processor_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_processor_instance</span>

    <span class="n">service</span> <span class="o">=</span> <span class="n">PaymentService</span><span class="p">(</span><span class="n">gateway_type</span><span class="o">=</span><span class="s2">&quot;stripe&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">charge_customer</span><span class="p">(</span><span class="s2">&quot;user_42&quot;</span><span class="p">,</span> <span class="mf">99.99</span><span class="p">,</span> <span class="s2">&quot;tok_visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_service_patched.py::test_with_patch_object<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_service_patched.py::test_with_patch_object PASSED
</code></pre></div>

<p><strong>Advantages of patch.object()</strong>:
- More explicit: you specify the module object directly
- Catches typos at import time (if module doesn't exist, import fails)
- Clearer intent: "patch this attribute of this module"</p>
<p><strong>Disadvantages</strong>:
- Requires importing the module
- More verbose</p>
<h3 id="when-to-use-class-mocking">When to Use Class Mocking</h3>
<p><strong>Use class mocking when</strong>:
- Your code creates instances internally (factory patterns)
- You need to verify class instantiation arguments
- You want to control all instances of a class uniformly
- You're testing code that uses dependency injection frameworks</p>
<p><strong>Don't use class mocking when</strong>:
- You can inject mock instances directly (prefer dependency injection)
- You only need to mock one specific instance
- The class is simple and doesn't need mocking (use real instances)</p>
<p><strong>Best practice</strong>: Prefer dependency injection over class mocking. Class mocking is powerful but makes tests more brittle because they depend on implementation details (which classes are instantiated and when).</p>
<h3 id="the-complete-test-suite_1">The Complete Test Suite</h3>
<p>Here's our complete test suite for class mocking:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_service_complete.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentService</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.NotificationService&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.FraudDetector&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.PaymentGateway&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.PaymentProcessor&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_successful_charge</span><span class="p">(</span>
    <span class="n">mock_processor_class</span><span class="p">,</span>
    <span class="n">mock_gateway_class</span><span class="p">,</span>
    <span class="n">mock_fraud_class</span><span class="p">,</span>
    <span class="n">mock_notifier_class</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test successful payment processing.&quot;&quot;&quot;</span>
    <span class="n">mock_processor_instance</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_processor_instance</span><span class="o">.</span><span class="n">process_payment</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
        <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span>
    <span class="p">}</span>
    <span class="n">mock_processor_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_processor_instance</span>

    <span class="n">service</span> <span class="o">=</span> <span class="n">PaymentService</span><span class="p">(</span><span class="n">gateway_type</span><span class="o">=</span><span class="s2">&quot;stripe&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">charge_customer</span><span class="p">(</span><span class="s2">&quot;user_42&quot;</span><span class="p">,</span> <span class="mf">99.99</span><span class="p">,</span> <span class="s2">&quot;tok_visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;txn_12345&quot;</span>
    <span class="n">mock_processor_instance</span><span class="o">.</span><span class="n">process_payment</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="s2">&quot;user_42&quot;</span><span class="p">,</span> <span class="mf">99.99</span><span class="p">,</span> <span class="s2">&quot;tok_visa&quot;</span>
    <span class="p">)</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.NotificationService&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.FraudDetector&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.PaymentGateway&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.PaymentProcessor&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_class_instantiation_order</span><span class="p">(</span>
    <span class="n">mock_processor_class</span><span class="p">,</span>
    <span class="n">mock_gateway_class</span><span class="p">,</span>
    <span class="n">mock_fraud_class</span><span class="p">,</span>
    <span class="n">mock_notifier_class</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that dependencies are instantiated correctly.&quot;&quot;&quot;</span>
    <span class="n">mock_processor_instance</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_processor_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_processor_instance</span>

    <span class="n">service</span> <span class="o">=</span> <span class="n">PaymentService</span><span class="p">(</span><span class="n">gateway_type</span><span class="o">=</span><span class="s2">&quot;stripe&quot;</span><span class="p">)</span>

    <span class="c1"># Verify all dependencies were created</span>
    <span class="n">mock_gateway_class</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">mock_fraud_class</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">mock_notifier_class</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="c1"># Verify processor was created with the right dependencies</span>
    <span class="n">mock_processor_class</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">mock_gateway_class</span><span class="o">.</span><span class="n">return_value</span><span class="p">,</span>
        <span class="n">mock_fraud_class</span><span class="o">.</span><span class="n">return_value</span><span class="p">,</span>
        <span class="n">mock_notifier_class</span><span class="o">.</span><span class="n">return_value</span>
    <span class="p">)</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.NotificationService&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.FraudDetector&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.PaymentGateway&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;payment_service.PaymentProcessor&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_gateway_type</span><span class="p">(</span>
    <span class="n">mock_processor_class</span><span class="p">,</span>
    <span class="n">mock_gateway_class</span><span class="p">,</span>
    <span class="n">mock_fraud_class</span><span class="p">,</span>
    <span class="n">mock_notifier_class</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test error handling for invalid gateway types.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="n">service</span> <span class="o">=</span> <span class="n">PaymentService</span><span class="p">(</span><span class="n">gateway_type</span><span class="o">=</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="s2">&quot;Unknown gateway type: invalid&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">mock_processor_class</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</code></pre></div>

<p>Run the complete suite:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_service_complete.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nx">test_payment_service_complete</span><span class="p">.</span><span class="nx">py</span><span class="o">::</span><span class="nx">test_successful_charge</span><span class="w"> </span><span class="nx">PASSED</span>
<span class="nx">test_payment_service_complete</span><span class="p">.</span><span class="nx">py</span><span class="o">::</span><span class="nx">test_class_instantiation_order</span><span class="w"> </span><span class="nx">PASSED</span>
<span class="nx">test_payment_service_complete</span><span class="p">.</span><span class="nx">py</span><span class="o">::</span><span class="nx">test_invalid_gateway_type</span><span class="w"> </span><span class="nx">PASSED</span>
</code></pre></div>

<h3 id="key-takeaways_1">Key Takeaways</h3>
<ol>
<li><strong>Class mocking replaces the class itself</strong>: Every instantiation returns a mock</li>
<li><strong>Two-level system</strong>: Mock class and mock instance (<code>.return_value</code>)</li>
<li><strong>Patch where used, not where defined</strong>: Patch the import location</li>
<li><strong>Verify instantiation</strong>: Use <code>assert_called_once_with()</code> on the mock class</li>
<li><strong>Use patch.object() for clarity</strong>: More explicit than string-based patching</li>
<li><strong>Prefer dependency injection</strong>: Class mocking is powerful but makes tests brittle</li>
</ol>
<p>In the next section, we'll explore mocking properties and attributes, which require special handling.</p>
<h2 id="mocking-properties-and-attributes">Mocking Properties and Attributes</h2>
<h2 id="mocking-properties-and-attributes_1">Mocking Properties and Attributes</h2>
<p>So far, we've mocked methods‚Äîfunctions that are called. But Python objects also have properties and attributes that are accessed, not called. Mocking these requires different techniques.</p>
<p>Properties are especially tricky because they look like attributes but are actually methods decorated with <code>@property</code>. Understanding how to mock them is essential for testing real-world Python code.</p>
<h3 id="the-reference-implementation-a-configuration-system">The Reference Implementation: A Configuration System</h3>
<p>Let's build a configuration system that uses properties extensively:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># config_system.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DatabaseConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Database configuration with computed properties.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">host</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Database host.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Database port.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">connection_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computed connection string.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;postgresql://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_database</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_local</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if database is on localhost.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">connection_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of connections made.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_count</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulate connecting to database.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Connected to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_string</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">EnvironmentConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration that reads from environment variables.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">debug_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if debug mode is enabled.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get log level from environment.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LOG_LEVEL&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">current_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current timestamp - always changes.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ApplicationConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main application configuration.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_config</span><span class="p">,</span> <span class="n">env_config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env_config</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get application status.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connection_string</span><span class="p">,</span>
            <span class="s2">&quot;is_local&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">is_local</span><span class="p">,</span>
            <span class="s2">&quot;debug_mode&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">,</span>
            <span class="s2">&quot;log_level&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">log_level</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">current_timestamp</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize application.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Debug mode enabled at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">current_timestamp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">connection_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;initialized&quot;</span><span class="p">,</span>
            <span class="s2">&quot;connection&quot;</span><span class="p">:</span> <span class="n">connection_result</span><span class="p">,</span>
            <span class="s2">&quot;connections&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connection_count</span>
        <span class="p">}</span>
</code></pre></div>

<p>This configuration system uses properties for:
- Simple attribute access (<code>host</code>, <code>port</code>)
- Computed values (<code>connection_string</code>, <code>is_local</code>)
- Environment variable access (<code>debug_mode</code>, <code>log_level</code>)
- Dynamic values (<code>current_timestamp</code>)</p>
<h3 id="iteration-0-attempting-to-mock-properties-like-methods">Iteration 0: Attempting to Mock Properties Like Methods</h3>
<p>Let's try to test this using what we know about mocking methods:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_config_naive.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">config_system</span><span class="w"> </span><span class="kn">import</span> <span class="n">ApplicationConfig</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_status_naive</span><span class="p">():</span>
    <span class="c1"># Try to mock the config objects</span>
    <span class="n">db_config</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">env_config</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="c1"># Try to configure properties like methods</span>
    <span class="n">db_config</span><span class="o">.</span><span class="n">connection_string</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;postgresql://localhost:5432/testdb&quot;</span>
    <span class="n">db_config</span><span class="o">.</span><span class="n">is_local</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">env_config</span><span class="o">.</span><span class="n">debug_mode</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">env_config</span><span class="o">.</span><span class="n">log_level</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span>
    <span class="n">env_config</span><span class="o">.</span><span class="n">current_timestamp</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;2024-01-01T00:00:00&quot;</span>

    <span class="n">app_config</span> <span class="o">=</span> <span class="n">ApplicationConfig</span><span class="p">(</span><span class="n">db_config</span><span class="p">,</span> <span class="n">env_config</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_config_naive.py::test_get_status_naive<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_config_naive.py::test_get_status_naive<span class="w"> </span>Status:<span class="w"> </span>{&#39;database&#39;:<span class="w"> </span><span class="nt">&lt;MagicMock</span> <span class="na">name=</span><span class="s">&#39;mock.connection_string&#39;</span> <span class="na">id=</span><span class="s">&#39;...&#39;</span><span class="nt">&gt;</span>,<span class="w"> </span>&#39;is_local&#39;:<span class="w"> </span><span class="nt">&lt;MagicMock</span> <span class="na">name=</span><span class="s">&#39;mock.is_local&#39;</span> <span class="na">id=</span><span class="s">&#39;...&#39;</span><span class="nt">&gt;</span>,<span class="w"> </span>&#39;debug_mode&#39;:<span class="w"> </span><span class="nt">&lt;MagicMock</span> <span class="na">name=</span><span class="s">&#39;mock.debug_mode&#39;</span> <span class="na">id=</span><span class="s">&#39;...&#39;</span><span class="nt">&gt;</span>,<span class="w"> </span>&#39;log_level&#39;:<span class="w"> </span><span class="nt">&lt;MagicMock</span> <span class="na">name=</span><span class="s">&#39;mock.log_level&#39;</span> <span class="na">id=</span><span class="s">&#39;...&#39;</span><span class="nt">&gt;</span>,<span class="w"> </span>&#39;timestamp&#39;:<span class="w"> </span><span class="nt">&lt;MagicMock</span> <span class="na">name=</span><span class="s">&#39;mock.current_timestamp&#39;</span> <span class="na">id=</span><span class="s">&#39;...&#39;</span><span class="nt">&gt;</span>}
PASSED
</code></pre></div>

<h3 id="diagnostic-analysis-properties-return-mock-objects-not-values">Diagnostic Analysis: Properties Return Mock Objects, Not Values</h3>
<p><strong>The complete output</strong>:</p>
<div class="codehilite"><pre><span></span><code>Status: {&#39;database&#39;: &lt;MagicMock name=&#39;mock.connection_string&#39; id=&#39;...&#39;&gt;, ...}
</code></pre></div>

<p><strong>Let's parse this</strong>:</p>
<ol>
<li><strong>The status dictionary contains Mock objects</strong>: Each value is <code>&lt;MagicMock ...&gt;</code> instead of the expected string/boolean</li>
<li>
<p>What this tells us: The properties are returning Mock objects, not the configured values</p>
</li>
<li>
<p><strong>Why this happens</strong>:</p>
</li>
<li>When we access <code>db_config.connection_string</code>, Mock creates a new Mock object</li>
<li>We configured <code>db_config.connection_string.return_value</code>, but that's for calling it as a method</li>
<li>Properties are accessed, not called: <code>obj.property</code> not <code>obj.property()</code></li>
<li>
<p>The <code>.return_value</code> configuration is never used</p>
</li>
<li>
<p><strong>The root cause</strong>:</p>
</li>
<li>Properties are accessed like attributes: <code>obj.property</code></li>
<li>Methods are called: <code>obj.method()</code></li>
<li>Configuring <code>.return_value</code> only affects method calls</li>
<li>We need to configure the attribute value directly</li>
</ol>
<p><strong>Root cause identified</strong>: Properties are accessed, not called. We need to configure attribute values, not return values.</p>
<p><strong>Why the current approach can't solve this</strong>: <code>.return_value</code> is for callable objects. Properties are not callable‚Äîthey're accessed like attributes.</p>
<p><strong>What we need</strong>: A way to configure what value is returned when an attribute is accessed.</p>
<h3 id="iteration-1-configuring-properties-correctly">Iteration 1: Configuring Properties Correctly</h3>
<p>To mock properties, we assign values directly to the mock's attributes:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_config_properties.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">config_system</span><span class="w"> </span><span class="kn">import</span> <span class="n">ApplicationConfig</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_status_with_properties</span><span class="p">():</span>
    <span class="n">db_config</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">env_config</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="c1"># Configure properties by direct assignment (not .return_value)</span>
    <span class="n">db_config</span><span class="o">.</span><span class="n">connection_string</span> <span class="o">=</span> <span class="s2">&quot;postgresql://localhost:5432/testdb&quot;</span>
    <span class="n">db_config</span><span class="o">.</span><span class="n">is_local</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">env_config</span><span class="o">.</span><span class="n">debug_mode</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">env_config</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span>
    <span class="n">env_config</span><span class="o">.</span><span class="n">current_timestamp</span> <span class="o">=</span> <span class="s2">&quot;2024-01-01T00:00:00&quot;</span>

    <span class="n">app_config</span> <span class="o">=</span> <span class="n">ApplicationConfig</span><span class="p">(</span><span class="n">db_config</span><span class="p">,</span> <span class="n">env_config</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>

    <span class="c1"># Verify status contains the configured values</span>
    <span class="k">assert</span> <span class="n">status</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;postgresql://localhost:5432/testdb&quot;</span>
    <span class="k">assert</span> <span class="n">status</span><span class="p">[</span><span class="s2">&quot;is_local&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">status</span><span class="p">[</span><span class="s2">&quot;debug_mode&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">status</span><span class="p">[</span><span class="s2">&quot;log_level&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;INFO&quot;</span>
    <span class="k">assert</span> <span class="n">status</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2024-01-01T00:00:00&quot;</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_config_properties.py::test_get_status_with_properties<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_config_properties.py::test_get_status_with_properties PASSED
</code></pre></div>

<p><strong>What changed</strong>:
- We assigned values directly: <code>db_config.connection_string = "..."</code>
- No <code>.return_value</code> needed
- The mock returns the assigned value when the property is accessed
- The test now verifies the actual values, not Mock objects</p>
<h3 id="iteration-2-testing-property-dependent-behavior">Iteration 2: Testing Property-Dependent Behavior</h3>
<p>Let's test code that makes decisions based on property values:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_initialize_with_debug_mode</span><span class="p">():</span>
    <span class="n">db_config</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">env_config</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="c1"># Configure properties</span>
    <span class="n">db_config</span><span class="o">.</span><span class="n">connection_string</span> <span class="o">=</span> <span class="s2">&quot;postgresql://localhost:5432/testdb&quot;</span>
    <span class="n">db_config</span><span class="o">.</span><span class="n">connection_count</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># After connection</span>
    <span class="n">env_config</span><span class="o">.</span><span class="n">debug_mode</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Debug enabled</span>
    <span class="n">env_config</span><span class="o">.</span><span class="n">current_timestamp</span> <span class="o">=</span> <span class="s2">&quot;2024-01-01T00:00:00&quot;</span>

    <span class="c1"># Mock the connect method (this IS a method, so use return_value)</span>
    <span class="n">db_config</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;Connected to postgresql://localhost:5432/testdb&quot;</span>

    <span class="n">app_config</span> <span class="o">=</span> <span class="n">ApplicationConfig</span><span class="p">(</span><span class="n">db_config</span><span class="p">,</span> <span class="n">env_config</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

    <span class="c1"># Verify initialization result</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;initialized&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;connection&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Connected to postgresql://localhost:5432/testdb&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;connections&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="c1"># Verify connect was called</span>
    <span class="n">db_config</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_config_properties.py::test_initialize_with_debug_mode<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_config_properties.py::test_initialize_with_debug_mode PASSED
</code></pre></div>

<p><strong>What we demonstrated</strong>:
- Properties use direct assignment: <code>env_config.debug_mode = True</code>
- Methods use <code>.return_value</code>: <code>db_config.connect.return_value = "..."</code>
- We can mix property mocking and method mocking in the same test</p>
<h3 id="iteration-3-using-propertymock-for-advanced-scenarios">Iteration 3: Using PropertyMock for Advanced Scenarios</h3>
<p>Sometimes you need more control over property behavior. <code>PropertyMock</code> is a specialized mock for properties that need to:
- Track access (how many times was the property read?)
- Return different values on successive accesses
- Raise exceptions when accessed</p>
<p>Let's use <code>PropertyMock</code> to test dynamic properties:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">PropertyMock</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_dynamic_timestamp_with_property_mock</span><span class="p">():</span>
    <span class="n">db_config</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">env_config</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="c1"># Configure static properties normally</span>
    <span class="n">db_config</span><span class="o">.</span><span class="n">connection_string</span> <span class="o">=</span> <span class="s2">&quot;postgresql://localhost:5432/testdb&quot;</span>
    <span class="n">db_config</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;Connected&quot;</span>
    <span class="n">env_config</span><span class="o">.</span><span class="n">debug_mode</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">env_config</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span>

    <span class="c1"># Use PropertyMock for dynamic timestamp</span>
    <span class="n">timestamp_mock</span> <span class="o">=</span> <span class="n">PropertyMock</span><span class="p">(</span><span class="n">side_effect</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;2024-01-01T00:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;2024-01-01T00:00:01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;2024-01-01T00:00:02&quot;</span>
    <span class="p">])</span>
    <span class="nb">type</span><span class="p">(</span><span class="n">env_config</span><span class="p">)</span><span class="o">.</span><span class="n">current_timestamp</span> <span class="o">=</span> <span class="n">timestamp_mock</span>

    <span class="n">app_config</span> <span class="o">=</span> <span class="n">ApplicationConfig</span><span class="p">(</span><span class="n">db_config</span><span class="p">,</span> <span class="n">env_config</span><span class="p">)</span>

    <span class="c1"># Access timestamp multiple times</span>
    <span class="n">status1</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
    <span class="n">status2</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
    <span class="n">status3</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>

    <span class="c1"># Verify different timestamps were returned</span>
    <span class="k">assert</span> <span class="n">status1</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2024-01-01T00:00:00&quot;</span>
    <span class="k">assert</span> <span class="n">status2</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2024-01-01T00:00:01&quot;</span>
    <span class="k">assert</span> <span class="n">status3</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2024-01-01T00:00:02&quot;</span>

    <span class="c1"># Verify property was accessed 3 times</span>
    <span class="k">assert</span> <span class="n">timestamp_mock</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">3</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_config_properties.py::test_dynamic_timestamp_with_property_mock<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_config_properties.py::test_dynamic_timestamp_with_property_mock PASSED
</code></pre></div>

<p><strong>What PropertyMock provides</strong>:
- <code>side_effect</code> for returning different values on each access
- Call tracking (<code>.call_count</code>, <code>.assert_called()</code>, etc.)
- Must be assigned to the mock's type: <code>type(mock).property = PropertyMock(...)</code></p>
<h3 id="understanding-typemockproperty-assignment">Understanding type(mock).property Assignment</h3>
<p>The syntax <code>type(env_config).current_timestamp = timestamp_mock</code> looks strange. Here's why it's necessary:</p>
<p>Properties in Python are descriptors that must be defined on the class, not the instance. When you access <code>obj.property</code>, Python:
1. Looks for <code>property</code> on the class (<code>type(obj)</code>)
2. Calls the property's <code>__get__</code> method
3. Returns the result</p>
<p>To mock a property, we must assign it to the mock's class (accessed via <code>type(mock)</code>), not the instance.</p>
<h3 id="iteration-4-testing-property-exceptions">Iteration 4: Testing Property Exceptions</h3>
<p>Let's test what happens when a property raises an exception:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_property_raises_exception</span><span class="p">():</span>
    <span class="n">db_config</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">env_config</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="c1"># Configure most properties normally</span>
    <span class="n">db_config</span><span class="o">.</span><span class="n">connection_string</span> <span class="o">=</span> <span class="s2">&quot;postgresql://localhost:5432/testdb&quot;</span>
    <span class="n">env_config</span><span class="o">.</span><span class="n">debug_mode</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">env_config</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span>
    <span class="n">env_config</span><span class="o">.</span><span class="n">current_timestamp</span> <span class="o">=</span> <span class="s2">&quot;2024-01-01T00:00:00&quot;</span>

    <span class="c1"># Make is_local raise an exception</span>
    <span class="n">is_local_mock</span> <span class="o">=</span> <span class="n">PropertyMock</span><span class="p">(</span><span class="n">side_effect</span><span class="o">=</span><span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Network error&quot;</span><span class="p">))</span>
    <span class="nb">type</span><span class="p">(</span><span class="n">db_config</span><span class="p">)</span><span class="o">.</span><span class="n">is_local</span> <span class="o">=</span> <span class="n">is_local_mock</span>

    <span class="n">app_config</span> <span class="o">=</span> <span class="n">ApplicationConfig</span><span class="p">(</span><span class="n">db_config</span><span class="p">,</span> <span class="n">env_config</span><span class="p">)</span>

    <span class="c1"># Accessing is_local should raise the exception</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>

    <span class="k">assert</span> <span class="s2">&quot;Network error&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># Verify the property was accessed</span>
    <span class="n">is_local_mock</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_config_properties.py::test_property_raises_exception<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_config_properties.py::test_property_raises_exception PASSED
</code></pre></div>

<p><strong>What we demonstrated</strong>:
- <code>PropertyMock</code> can raise exceptions using <code>side_effect</code>
- The exception is raised when the property is accessed
- We can verify the property was accessed even though it raised an exception</p>
<h3 id="iteration-5-mocking-properties-with-patch">Iteration 5: Mocking Properties with patch()</h3>
<p>You can also mock properties using <code>@patch</code>, which is useful when you need to mock properties on real classes:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span><span class="p">,</span> <span class="n">PropertyMock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">config_system</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatabaseConfig</span><span class="p">,</span> <span class="n">EnvironmentConfig</span><span class="p">,</span> <span class="n">ApplicationConfig</span>

<span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">EnvironmentConfig</span><span class="p">,</span> <span class="s1">&#39;debug_mode&#39;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="n">PropertyMock</span><span class="p">)</span>
<span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">EnvironmentConfig</span><span class="p">,</span> <span class="s1">&#39;log_level&#39;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="n">PropertyMock</span><span class="p">)</span>
<span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">EnvironmentConfig</span><span class="p">,</span> <span class="s1">&#39;current_timestamp&#39;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="n">PropertyMock</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_with_patched_properties</span><span class="p">(</span><span class="n">mock_timestamp</span><span class="p">,</span> <span class="n">mock_log_level</span><span class="p">,</span> <span class="n">mock_debug_mode</span><span class="p">):</span>
    <span class="c1"># Configure the property mocks</span>
    <span class="n">mock_debug_mode</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">mock_log_level</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;DEBUG&quot;</span>
    <span class="n">mock_timestamp</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;2024-01-01T00:00:00&quot;</span>

    <span class="c1"># Create real EnvironmentConfig (properties are mocked)</span>
    <span class="n">env_config</span> <span class="o">=</span> <span class="n">EnvironmentConfig</span><span class="p">()</span>

    <span class="c1"># Create mock DatabaseConfig</span>
    <span class="n">db_config</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">db_config</span><span class="o">.</span><span class="n">connection_string</span> <span class="o">=</span> <span class="s2">&quot;postgresql://localhost:5432/testdb&quot;</span>
    <span class="n">db_config</span><span class="o">.</span><span class="n">is_local</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">db_config</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;Connected&quot;</span>

    <span class="n">app_config</span> <span class="o">=</span> <span class="n">ApplicationConfig</span><span class="p">(</span><span class="n">db_config</span><span class="p">,</span> <span class="n">env_config</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>

    <span class="c1"># Verify mocked property values</span>
    <span class="k">assert</span> <span class="n">status</span><span class="p">[</span><span class="s2">&quot;debug_mode&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">status</span><span class="p">[</span><span class="s2">&quot;log_level&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;DEBUG&quot;</span>
    <span class="k">assert</span> <span class="n">status</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2024-01-01T00:00:00&quot;</span>

    <span class="c1"># Verify properties were accessed</span>
    <span class="n">mock_debug_mode</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span>
    <span class="n">mock_log_level</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span>
    <span class="n">mock_timestamp</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_config_properties.py::test_with_patched_properties<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_config_properties.py::test_with_patched_properties PASSED
</code></pre></div>

<p><strong>What changed</strong>:
- We used <code>@patch.object</code> with <code>new_callable=PropertyMock</code>
- This replaces the real property with a <code>PropertyMock</code>
- We can use a real <code>EnvironmentConfig</code> instance with mocked properties
- The mock parameters are in reverse order (bottom decorator = first parameter)</p>
<h3 id="common-failure-modes-and-their-signatures">Common Failure Modes and Their Signatures</h3>
<h4 id="symptom-property-returns-mock-object-instead-of-value">Symptom: Property returns Mock object instead of value</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">AssertionError</span><span class="o">:</span><span class="w"> </span><span class="n">assert</span><span class="w"> </span><span class="o">&lt;</span><span class="n">MagicMock</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;mock.property&#39;</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;...&#39;</span><span class="o">&gt;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;expected_value&#39;</span>
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- The assertion shows a Mock object where a value was expected
- You configured <code>.return_value</code> on a property</p>
<p><strong>Root cause</strong>: Properties are accessed, not called. <code>.return_value</code> doesn't apply.</p>
<p><strong>Solution</strong>: Use direct assignment: <code>mock.property = "value"</code></p>
<h4 id="symptom-propertymock-not-working">Symptom: PropertyMock not working</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>AttributeError: &#39;Mock&#39; object has no attribute &#39;property&#39;
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- You assigned <code>PropertyMock</code> to the instance: <code>mock.property = PropertyMock(...)</code>
- Properties must be on the class, not the instance</p>
<p><strong>Root cause</strong>: Properties are class-level descriptors.</p>
<p><strong>Solution</strong>: Assign to the type: <code>type(mock).property = PropertyMock(...)</code></p>
<h4 id="symptom-patched-property-not-being-used">Symptom: Patched property not being used</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">AssertionError</span><span class="o">:</span><span class="w"> </span><span class="n">assert</span><span class="w"> </span><span class="s1">&#39;real_value&#39;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;mocked_value&#39;</span>
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- You patched the property but the real value is still being used
- You forgot <code>new_callable=PropertyMock</code></p>
<p><strong>Root cause</strong>: Without <code>new_callable=PropertyMock</code>, <code>@patch</code> creates a regular Mock, not a PropertyMock.</p>
<p><strong>Solution</strong>: Add <code>new_callable=PropertyMock</code> to the <code>@patch</code> decorator</p>
<h3 id="decision-framework-when-to-use-each-approach">Decision Framework: When to Use Each Approach</h3>
<table>
<thead>
<tr>
<th>Approach</th>
<th>Use When</th>
<th>Advantages</th>
<th>Disadvantages</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Direct assignment</strong></td>
<td>Simple property mocking</td>
<td>Simple, clear</td>
<td>No call tracking</td>
</tr>
<tr>
<td><strong>PropertyMock</strong></td>
<td>Need call tracking or dynamic values</td>
<td>Full mock capabilities</td>
<td>More complex syntax</td>
</tr>
<tr>
<td><strong>@patch with PropertyMock</strong></td>
<td>Mocking properties on real classes</td>
<td>Works with real instances</td>
<td>Requires understanding decorator order</td>
</tr>
</tbody>
</table>
<h3 id="the-complete-test-suite_2">The Complete Test Suite</h3>
<p>Here's our complete test suite for property mocking:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_config_complete.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">PropertyMock</span><span class="p">,</span> <span class="n">patch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">config_system</span><span class="w"> </span><span class="kn">import</span> <span class="n">ApplicationConfig</span><span class="p">,</span> <span class="n">EnvironmentConfig</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_simple_property_mocking</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test basic property mocking with direct assignment.&quot;&quot;&quot;</span>
    <span class="n">db_config</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">env_config</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">db_config</span><span class="o">.</span><span class="n">connection_string</span> <span class="o">=</span> <span class="s2">&quot;postgresql://localhost:5432/testdb&quot;</span>
    <span class="n">db_config</span><span class="o">.</span><span class="n">is_local</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">env_config</span><span class="o">.</span><span class="n">debug_mode</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">env_config</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span>
    <span class="n">env_config</span><span class="o">.</span><span class="n">current_timestamp</span> <span class="o">=</span> <span class="s2">&quot;2024-01-01T00:00:00&quot;</span>

    <span class="n">app_config</span> <span class="o">=</span> <span class="n">ApplicationConfig</span><span class="p">(</span><span class="n">db_config</span><span class="p">,</span> <span class="n">env_config</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">status</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;postgresql://localhost:5432/testdb&quot;</span>
    <span class="k">assert</span> <span class="n">status</span><span class="p">[</span><span class="s2">&quot;is_local&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_dynamic_property_with_property_mock</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test property that returns different values on each access.&quot;&quot;&quot;</span>
    <span class="n">db_config</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">env_config</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">db_config</span><span class="o">.</span><span class="n">connection_string</span> <span class="o">=</span> <span class="s2">&quot;postgresql://localhost:5432/testdb&quot;</span>
    <span class="n">db_config</span><span class="o">.</span><span class="n">is_local</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">env_config</span><span class="o">.</span><span class="n">debug_mode</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">env_config</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span>

    <span class="n">timestamp_mock</span> <span class="o">=</span> <span class="n">PropertyMock</span><span class="p">(</span><span class="n">side_effect</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;2024-01-01T00:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;2024-01-01T00:00:01&quot;</span>
    <span class="p">])</span>
    <span class="nb">type</span><span class="p">(</span><span class="n">env_config</span><span class="p">)</span><span class="o">.</span><span class="n">current_timestamp</span> <span class="o">=</span> <span class="n">timestamp_mock</span>

    <span class="n">app_config</span> <span class="o">=</span> <span class="n">ApplicationConfig</span><span class="p">(</span><span class="n">db_config</span><span class="p">,</span> <span class="n">env_config</span><span class="p">)</span>

    <span class="n">status1</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
    <span class="n">status2</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">status1</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2024-01-01T00:00:00&quot;</span>
    <span class="k">assert</span> <span class="n">status2</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2024-01-01T00:00:01&quot;</span>
    <span class="k">assert</span> <span class="n">timestamp_mock</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_property_exception</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test property that raises an exception.&quot;&quot;&quot;</span>
    <span class="n">db_config</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">env_config</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">db_config</span><span class="o">.</span><span class="n">connection_string</span> <span class="o">=</span> <span class="s2">&quot;postgresql://localhost:5432/testdb&quot;</span>
    <span class="n">env_config</span><span class="o">.</span><span class="n">debug_mode</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">env_config</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span>
    <span class="n">env_config</span><span class="o">.</span><span class="n">current_timestamp</span> <span class="o">=</span> <span class="s2">&quot;2024-01-01T00:00:00&quot;</span>

    <span class="n">is_local_mock</span> <span class="o">=</span> <span class="n">PropertyMock</span><span class="p">(</span><span class="n">side_effect</span><span class="o">=</span><span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Network error&quot;</span><span class="p">))</span>
    <span class="nb">type</span><span class="p">(</span><span class="n">db_config</span><span class="p">)</span><span class="o">.</span><span class="n">is_local</span> <span class="o">=</span> <span class="n">is_local_mock</span>

    <span class="n">app_config</span> <span class="o">=</span> <span class="n">ApplicationConfig</span><span class="p">(</span><span class="n">db_config</span><span class="p">,</span> <span class="n">env_config</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="n">app_config</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>

    <span class="k">assert</span> <span class="s2">&quot;Network error&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">EnvironmentConfig</span><span class="p">,</span> <span class="s1">&#39;debug_mode&#39;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="n">PropertyMock</span><span class="p">)</span>
<span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">EnvironmentConfig</span><span class="p">,</span> <span class="s1">&#39;log_level&#39;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="n">PropertyMock</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_patched_properties</span><span class="p">(</span><span class="n">mock_log_level</span><span class="p">,</span> <span class="n">mock_debug_mode</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test mocking properties on real classes.&quot;&quot;&quot;</span>
    <span class="n">mock_debug_mode</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">mock_log_level</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;DEBUG&quot;</span>

    <span class="n">env_config</span> <span class="o">=</span> <span class="n">EnvironmentConfig</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">env_config</span><span class="o">.</span><span class="n">debug_mode</span> <span class="ow">is</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">env_config</span><span class="o">.</span><span class="n">log_level</span> <span class="o">==</span> <span class="s2">&quot;DEBUG&quot;</span>

    <span class="n">mock_debug_mode</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span>
    <span class="n">mock_log_level</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span>
</code></pre></div>

<p>Run the complete suite:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_config_complete.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nx">test_config_complete</span><span class="p">.</span><span class="nx">py</span><span class="o">::</span><span class="nx">test_simple_property_mocking</span><span class="w"> </span><span class="nx">PASSED</span>
<span class="nx">test_config_complete</span><span class="p">.</span><span class="nx">py</span><span class="o">::</span><span class="nx">test_dynamic_property_with_property_mock</span><span class="w"> </span><span class="nx">PASSED</span>
<span class="nx">test_config_complete</span><span class="p">.</span><span class="nx">py</span><span class="o">::</span><span class="nx">test_property_exception</span><span class="w"> </span><span class="nx">PASSED</span>
<span class="nx">test_config_complete</span><span class="p">.</span><span class="nx">py</span><span class="o">::</span><span class="nx">test_patched_properties</span><span class="w"> </span><span class="nx">PASSED</span>
</code></pre></div>

<h3 id="key-takeaways_2">Key Takeaways</h3>
<ol>
<li><strong>Properties are accessed, not called</strong>: Use direct assignment, not <code>.return_value</code></li>
<li><strong>PropertyMock for advanced scenarios</strong>: Use when you need call tracking or dynamic values</li>
<li><strong>type(mock).property syntax</strong>: Required because properties are class-level descriptors</li>
<li><strong>@patch with new_callable=PropertyMock</strong>: For mocking properties on real classes</li>
<li><strong>Mix property and method mocking</strong>: Properties use assignment, methods use <code>.return_value</code></li>
</ol>
<p>In the next section, we'll explore testing code that uses external libraries, where we need to mock third-party dependencies.</p>
<h2 id="testing-code-that-uses-external-libraries">Testing Code That Uses External Libraries</h2>
<h2 id="testing-code-that-uses-external-libraries_1">Testing Code That Uses External Libraries</h2>
<p>Real-world applications depend on external libraries: HTTP clients, database drivers, cloud SDKs, message queues. Testing code that uses these libraries requires mocking third-party dependencies you don't control.</p>
<p>This section teaches you how to isolate your code from external libraries while maintaining realistic test scenarios.</p>
<h3 id="the-reference-implementation-a-cloud-storage-service">The Reference Implementation: A Cloud Storage Service</h3>
<p>Let's build a service that uses the <code>boto3</code> library (AWS SDK) to interact with S3:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># cloud_storage.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">boto3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">botocore.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClientError</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="k">class</span><span class="w"> </span><span class="nc">StorageService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Service for uploading and managing files in S3.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="s2">&quot;us-east-1&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span> <span class="o">=</span> <span class="n">bucket_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">upload_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">object_key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Upload a file to S3.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Calculate file hash for integrity check</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">file_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

            <span class="c1"># Upload to S3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span>
                <span class="n">Filename</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
                <span class="n">Bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span>
                <span class="n">Key</span><span class="o">=</span><span class="n">object_key</span><span class="p">,</span>
                <span class="n">ExtraArgs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Metadata&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;md5&#39;</span><span class="p">:</span> <span class="n">file_hash</span><span class="p">}}</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bucket&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span>
                <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">object_key</span><span class="p">,</span>
                <span class="s2">&quot;md5&quot;</span><span class="p">:</span> <span class="n">file_hash</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;File not found&quot;</span>
            <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">download_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_key</span><span class="p">,</span> <span class="n">destination_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download a file from S3.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span>
                <span class="n">Bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span>
                <span class="n">Key</span><span class="o">=</span><span class="n">object_key</span><span class="p">,</span>
                <span class="n">Filename</span><span class="o">=</span><span class="n">destination_path</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
                <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">destination_path</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">list_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List files in the bucket.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span><span class="o">.</span><span class="n">list_objects_v2</span><span class="p">(</span>
                <span class="n">Bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span>
                <span class="n">Prefix</span><span class="o">=</span><span class="n">prefix</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;Contents&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>

            <span class="k">return</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;Size&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;last_modified&quot;</span><span class="p">:</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;LastModified&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;Contents&quot;</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">delete_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete a file from S3.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s3_client</span><span class="o">.</span><span class="n">delete_object</span><span class="p">(</span>
                <span class="n">Bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span>
                <span class="n">Key</span><span class="o">=</span><span class="n">object_key</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">}</span>
        <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">}</span>
</code></pre></div>

<p>This service uses <code>boto3</code> extensively:
- Creates an S3 client: <code>boto3.client('s3')</code>
- Calls S3 methods: <code>upload_file()</code>, <code>download_file()</code>, <code>list_objects_v2()</code>, <code>delete_object()</code>
- Handles S3-specific exceptions: <code>ClientError</code></p>
<p>We cannot call real S3 in tests. We need to mock <code>boto3</code>.</p>
<h3 id="iteration-0-understanding-the-challenge">Iteration 0: Understanding the Challenge</h3>
<p>Let's try to test this naively:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_storage_naive.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cloud_storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">StorageService</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_upload_file_naive</span><span class="p">():</span>
    <span class="c1"># Try to create a real service</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">StorageService</span><span class="p">(</span><span class="n">bucket_name</span><span class="o">=</span><span class="s2">&quot;test-bucket&quot;</span><span class="p">)</span>

    <span class="c1"># Try to upload a file</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="s2">&quot;test.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;uploads/test.txt&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_storage_naive.py::test_upload_file_naive<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">test_storage_naive</span><span class="o">.</span><span class="n">py</span><span class="p">::</span><span class="n">test_upload_file_naive</span><span class="w"> </span><span class="n">FAILED</span>

<span class="n">botocore</span><span class="o">/</span><span class="n">credentials</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="o">...</span><span class="p">:</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">load_credentials</span>
<span class="w">    </span><span class="o">...</span>
<span class="n">E</span><span class="w">   </span><span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">NoCredentialsError</span><span class="p">:</span><span class="w"> </span><span class="n">Unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">locate</span><span class="w"> </span><span class="n">credentials</span>
</code></pre></div>

<h3 id="diagnostic-analysis-external-library-requires-real-configuration">Diagnostic Analysis: External Library Requires Real Configuration</h3>
<p><strong>The complete output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">FAILED</span><span class="w"> </span><span class="n">test_storage_naive</span><span class="o">.</span><span class="n">py</span><span class="p">::</span><span class="n">test_upload_file_naive</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">NoCredentialsError</span><span class="p">:</span><span class="w"> </span><span class="n">Unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">locate</span><span class="w"> </span><span class="n">credentials</span>
</code></pre></div>

<p><strong>Let's parse this</strong>:</p>
<ol>
<li><strong>The summary line</strong>: <code>NoCredentialsError: Unable to locate credentials</code></li>
<li>What this tells us: <code>boto3</code> is trying to authenticate with AWS</li>
<li>
<p>It needs real AWS credentials to work</p>
</li>
<li>
<p><strong>The traceback</strong>:</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">botocore</span><span class="o">/</span><span class="n">credentials</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="o">...</span><span class="p">:</span> <span class="ow">in</span> <span class="n">load_credentials</span>
</code></pre></div>

<ul>
<li>What this tells us: The error occurs deep in the <code>boto3</code> library</li>
<li>
<p>Our code triggered real AWS SDK initialization</p>
</li>
<li>
<p><strong>The root cause</strong>:</p>
</li>
<li><code>boto3.client('s3')</code> creates a real S3 client</li>
<li>The real client tries to load AWS credentials</li>
<li>We don't have credentials configured (and don't want to use real AWS)</li>
<li>The test fails before our code even runs</li>
</ul>
<p><strong>Root cause identified</strong>: We're creating a real <code>boto3</code> client that tries to connect to AWS.</p>
<p><strong>Why the current approach can't solve this</strong>: We can't test against real AWS‚Äîit's slow, expensive, requires credentials, and creates real resources.</p>
<p><strong>What we need</strong>: A way to mock the <code>boto3</code> client so our code thinks it's talking to S3, but it's actually talking to a mock.</p>
<h3 id="iteration-1-mocking-the-boto3-client">Iteration 1: Mocking the boto3 Client</h3>
<p>We need to mock <code>boto3.client()</code> to return a mock S3 client:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_storage_mocked.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">mock_open</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cloud_storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">StorageService</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;cloud_storage.boto3&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_upload_file_success</span><span class="p">(</span><span class="n">mock_boto3</span><span class="p">):</span>
    <span class="c1"># Create a mock S3 client</span>
    <span class="n">mock_s3_client</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="c1"># Make boto3.client() return our mock</span>
    <span class="n">mock_boto3</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_s3_client</span>

    <span class="c1"># Create service (will use mocked boto3)</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">StorageService</span><span class="p">(</span><span class="n">bucket_name</span><span class="o">=</span><span class="s2">&quot;test-bucket&quot;</span><span class="p">)</span>

    <span class="c1"># Mock file reading</span>
    <span class="n">mock_file_content</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;test file content&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;builtins.open&#39;</span><span class="p">,</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">read_data</span><span class="o">=</span><span class="n">mock_file_content</span><span class="p">)):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="s2">&quot;test.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;uploads/test.txt&quot;</span><span class="p">)</span>

    <span class="c1"># Verify result</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;bucket&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;test-bucket&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;uploads/test.txt&quot;</span>

    <span class="c1"># Verify S3 client was created correctly</span>
    <span class="n">mock_boto3</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>

    <span class="c1"># Verify upload_file was called</span>
    <span class="n">mock_s3_client</span><span class="o">.</span><span class="n">upload_file</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">call_args</span> <span class="o">=</span> <span class="n">mock_s3_client</span><span class="o">.</span><span class="n">upload_file</span><span class="o">.</span><span class="n">call_args</span>
    <span class="k">assert</span> <span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Filename&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;test.txt&quot;</span>
    <span class="k">assert</span> <span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Bucket&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;test-bucket&quot;</span>
    <span class="k">assert</span> <span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;uploads/test.txt&quot;</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_storage_mocked.py::test_upload_file_success<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">test_storage_mocked</span><span class="o">.</span><span class="n">py</span><span class="p">::</span><span class="n">test_upload_file_success</span><span class="w"> </span><span class="n">PASSED</span>
</code></pre></div>

<p><strong>What we did</strong>:
1. <strong>Patched boto3</strong>: <code>@patch('cloud_storage.boto3')</code> replaces the entire <code>boto3</code> module
2. <strong>Mocked client creation</strong>: <code>mock_boto3.client.return_value = mock_s3_client</code>
3. <strong>Mocked file I/O</strong>: <code>mock_open(read_data=...)</code> simulates reading a file
4. <strong>Verified interactions</strong>: Checked that <code>boto3.client()</code> and <code>upload_file()</code> were called correctly</p>
<h3 id="iteration-2-testing-error-handling">Iteration 2: Testing Error Handling</h3>
<p>Let's test what happens when S3 operations fail:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">botocore.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClientError</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;cloud_storage.boto3&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_upload_file_s3_error</span><span class="p">(</span><span class="n">mock_boto3</span><span class="p">):</span>
    <span class="n">mock_s3_client</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_boto3</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_s3_client</span>

    <span class="c1"># Make upload_file raise a ClientError</span>
    <span class="n">error_response</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Error&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;Code&#39;</span><span class="p">:</span> <span class="s1">&#39;NoSuchBucket&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Message&#39;</span><span class="p">:</span> <span class="s1">&#39;The specified bucket does not exist&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">mock_s3_client</span><span class="o">.</span><span class="n">upload_file</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">ClientError</span><span class="p">(</span>
        <span class="n">error_response</span><span class="p">,</span> <span class="s1">&#39;PutObject&#39;</span>
    <span class="p">)</span>

    <span class="n">service</span> <span class="o">=</span> <span class="n">StorageService</span><span class="p">(</span><span class="n">bucket_name</span><span class="o">=</span><span class="s2">&quot;nonexistent-bucket&quot;</span><span class="p">)</span>

    <span class="n">mock_file_content</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;test content&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;builtins.open&#39;</span><span class="p">,</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">read_data</span><span class="o">=</span><span class="n">mock_file_content</span><span class="p">)):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="s2">&quot;test.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;uploads/test.txt&quot;</span><span class="p">)</span>

    <span class="c1"># Verify error was handled</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;NoSuchBucket&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_storage_mocked.py::test_upload_file_s3_error<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">test_storage_mocked</span><span class="o">.</span><span class="n">py</span><span class="p">::</span><span class="n">test_upload_file_s3_error</span><span class="w"> </span><span class="n">PASSED</span>
</code></pre></div>

<p><strong>What we demonstrated</strong>:
- Created a realistic <code>ClientError</code> exception (boto3's error type)
- Used <code>side_effect</code> to make the mock raise the exception
- Verified our code handles S3 errors correctly</p>
<h3 id="iteration-3-testing-file-not-found">Iteration 3: Testing File Not Found</h3>
<p>Let's test the file system error path:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;cloud_storage.boto3&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_upload_file_not_found</span><span class="p">(</span><span class="n">mock_boto3</span><span class="p">):</span>
    <span class="n">mock_s3_client</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_boto3</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_s3_client</span>

    <span class="n">service</span> <span class="o">=</span> <span class="n">StorageService</span><span class="p">(</span><span class="n">bucket_name</span><span class="o">=</span><span class="s2">&quot;test-bucket&quot;</span><span class="p">)</span>

    <span class="c1"># Don&#39;t mock open() - let it fail naturally</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="s2">&quot;nonexistent.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;uploads/test.txt&quot;</span><span class="p">)</span>

    <span class="c1"># Verify error was handled</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;File not found&quot;</span>

    <span class="c1"># Verify S3 was never called</span>
    <span class="n">mock_s3_client</span><span class="o">.</span><span class="n">upload_file</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_storage_mocked.py::test_upload_file_not_found<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">test_storage_mocked</span><span class="o">.</span><span class="n">py</span><span class="p">::</span><span class="n">test_upload_file_not_found</span><span class="w"> </span><span class="n">PASSED</span>
</code></pre></div>

<p><strong>What we demonstrated</strong>:
- We didn't mock <code>open()</code> this time‚Äîlet the real <code>FileNotFoundError</code> occur
- Verified our code handles file system errors
- Verified S3 was never called when the file doesn't exist</p>
<h3 id="iteration-4-testing-list-operations">Iteration 4: Testing List Operations</h3>
<p>Let's test the <code>list_files()</code> method which returns structured data:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;cloud_storage.boto3&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_list_files_success</span><span class="p">(</span><span class="n">mock_boto3</span><span class="p">):</span>
    <span class="n">mock_s3_client</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_boto3</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_s3_client</span>

    <span class="c1"># Mock S3 response with realistic structure</span>
    <span class="n">mock_s3_client</span><span class="o">.</span><span class="n">list_objects_v2</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Contents&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="s1">&#39;uploads/file1.txt&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Size&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
                <span class="s1">&#39;LastModified&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="s1">&#39;uploads/file2.txt&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Size&#39;</span><span class="p">:</span> <span class="mi">2048</span><span class="p">,</span>
                <span class="s1">&#39;LastModified&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>

    <span class="n">service</span> <span class="o">=</span> <span class="n">StorageService</span><span class="p">(</span><span class="n">bucket_name</span><span class="o">=</span><span class="s2">&quot;test-bucket&quot;</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">list_files</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;uploads/&quot;</span><span class="p">)</span>

    <span class="c1"># Verify results</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;uploads/file1.txt&quot;</span>
    <span class="k">assert</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1024</span>
    <span class="k">assert</span> <span class="n">files</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;uploads/file2.txt&quot;</span>
    <span class="k">assert</span> <span class="n">files</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2048</span>

    <span class="c1"># Verify S3 was called correctly</span>
    <span class="n">mock_s3_client</span><span class="o">.</span><span class="n">list_objects_v2</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">Bucket</span><span class="o">=</span><span class="s2">&quot;test-bucket&quot;</span><span class="p">,</span>
        <span class="n">Prefix</span><span class="o">=</span><span class="s2">&quot;uploads/&quot;</span>
    <span class="p">)</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_storage_mocked.py::test_list_files_success<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_storage_mocked.py::test_list_files_success PASSED
</code></pre></div>

<p><strong>What we demonstrated</strong>:
- Created a realistic S3 response structure
- Mocked complex nested data (list of dictionaries)
- Verified our code correctly transforms S3 data</p>
<h3 id="iteration-5-testing-empty-results">Iteration 5: Testing Empty Results</h3>
<p>Let's test the edge case where no files exist:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;cloud_storage.boto3&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_list_files_empty</span><span class="p">(</span><span class="n">mock_boto3</span><span class="p">):</span>
    <span class="n">mock_s3_client</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_boto3</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_s3_client</span>

    <span class="c1"># S3 returns no &#39;Contents&#39; key when bucket is empty</span>
    <span class="n">mock_s3_client</span><span class="o">.</span><span class="n">list_objects_v2</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">service</span> <span class="o">=</span> <span class="n">StorageService</span><span class="p">(</span><span class="n">bucket_name</span><span class="o">=</span><span class="s2">&quot;test-bucket&quot;</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">list_files</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;uploads/&quot;</span><span class="p">)</span>

    <span class="c1"># Verify empty list is returned</span>
    <span class="k">assert</span> <span class="n">files</span> <span class="o">==</span> <span class="p">[]</span>

    <span class="n">mock_s3_client</span><span class="o">.</span><span class="n">list_objects_v2</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_storage_mocked.py::test_list_files_empty<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_storage_mocked.py::test_list_files_empty PASSED
</code></pre></div>

<p><strong>What we demonstrated</strong>:
- Tested edge case behavior (empty bucket)
- Verified our code handles missing keys in S3 responses
- Ensured we return an empty list, not an error</p>
<h3 id="strategies-for-mocking-external-libraries">Strategies for Mocking External Libraries</h3>
<h4 id="strategy-1-mock-at-the-boundary">Strategy 1: Mock at the Boundary</h4>
<p>Mock the external library at the point where your code calls it:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;your_module.external_library&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_something</span><span class="p">(</span><span class="n">mock_library</span><span class="p">):</span>
    <span class="c1"># Your code imports external_library</span>
    <span class="c1"># Patch it in your module&#39;s namespace</span>
    <span class="k">pass</span>
</code></pre></div>

<h4 id="strategy-2-create-realistic-mock-responses">Strategy 2: Create Realistic Mock Responses</h4>
<p>Study the external library's documentation to create realistic mock responses:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Unrealistic mock</span>
<span class="n">mock_response</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;something&quot;</span><span class="p">}</span>

<span class="c1"># Good: Matches actual API response structure</span>
<span class="n">mock_response</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Contents&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="s1">&#39;file.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;Size&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span> <span class="s1">&#39;LastModified&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="o">...</span><span class="p">)}</span>
    <span class="p">],</span>
    <span class="s1">&#39;IsTruncated&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;MaxKeys&#39;</span><span class="p">:</span> <span class="mi">1000</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="strategy-3-mock-exceptions-realistically">Strategy 3: Mock Exceptions Realistically</h4>
<p>Use the actual exception types from the library:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">botocore.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClientError</span>

<span class="c1"># Create realistic error</span>
<span class="n">error_response</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Error&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Code&#39;</span><span class="p">:</span> <span class="s1">&#39;NoSuchBucket&#39;</span><span class="p">,</span> <span class="s1">&#39;Message&#39;</span><span class="p">:</span> <span class="s1">&#39;...&#39;</span><span class="p">}}</span>
<span class="n">mock_client</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">ClientError</span><span class="p">(</span><span class="n">error_response</span><span class="p">,</span> <span class="s1">&#39;Operation&#39;</span><span class="p">)</span>
</code></pre></div>

<h4 id="strategy-4-test-both-success-and-failure-paths">Strategy 4: Test Both Success and Failure Paths</h4>
<p>For each external library call, test:
- Successful operation
- Library-specific errors (e.g., <code>ClientError</code>)
- Network errors
- Timeout scenarios
- Edge cases (empty results, missing data)</p>
<h3 id="common-patterns-for-popular-libraries">Common Patterns for Popular Libraries</h3>
<h4 id="mocking-http-requests-requests-library">Mocking HTTP Requests (requests library)</h4>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;your_module.requests&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_api_call</span><span class="p">(</span><span class="n">mock_requests</span><span class="p">):</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">}</span>
    <span class="n">mock_requests</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>

    <span class="c1"># Your code that calls requests.get()</span>
</code></pre></div>

<h4 id="mocking-database-connections-psycopg2-pymongo">Mocking Database Connections (psycopg2, pymongo)</h4>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;your_module.psycopg2&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_database_query</span><span class="p">(</span><span class="n">mock_psycopg2</span><span class="p">):</span>
    <span class="n">mock_connection</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;row1&quot;</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;row2&quot;</span><span class="p">,)]</span>
    <span class="n">mock_connection</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_cursor</span>
    <span class="n">mock_psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_connection</span>

    <span class="c1"># Your code that uses psycopg2.connect()</span>
</code></pre></div>

<h4 id="mocking-redis">Mocking Redis</h4>
<div class="codehilite"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;your_module.redis&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_cache_operation</span><span class="p">(</span><span class="n">mock_redis</span><span class="p">):</span>
    <span class="n">mock_client</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_client</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;cached_value&quot;</span>
    <span class="n">mock_redis</span><span class="o">.</span><span class="n">Redis</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_client</span>

    <span class="c1"># Your code that uses redis.Redis()</span>
</code></pre></div>

<h3 id="when-to-use-real-libraries-vs-mocks">When to Use Real Libraries vs Mocks</h3>
<p><strong>Use mocks when</strong>:
- The library requires external resources (network, cloud services)
- Operations are slow or expensive
- You need deterministic test results
- You're testing error handling</p>
<p><strong>Use real libraries when</strong>:
- The library is pure Python with no external dependencies
- You're doing integration testing
- The library's behavior is complex and hard to mock accurately
- You have a test environment (e.g., local database)</p>
<h3 id="the-complete-test-suite_3">The Complete Test Suite</h3>
<p>Here's our complete test suite for external library mocking:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_storage_complete.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">mock_open</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">botocore.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClientError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cloud_storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">StorageService</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;cloud_storage.boto3&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_upload_file_success</span><span class="p">(</span><span class="n">mock_boto3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test successful file upload.&quot;&quot;&quot;</span>
    <span class="n">mock_s3_client</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_boto3</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_s3_client</span>

    <span class="n">service</span> <span class="o">=</span> <span class="n">StorageService</span><span class="p">(</span><span class="n">bucket_name</span><span class="o">=</span><span class="s2">&quot;test-bucket&quot;</span><span class="p">)</span>

    <span class="n">mock_file_content</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;test file content&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;builtins.open&#39;</span><span class="p">,</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">read_data</span><span class="o">=</span><span class="n">mock_file_content</span><span class="p">)):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="s2">&quot;test.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;uploads/test.txt&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;bucket&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;test-bucket&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;uploads/test.txt&quot;</span>
    <span class="n">mock_s3_client</span><span class="o">.</span><span class="n">upload_file</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;cloud_storage.boto3&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_upload_file_s3_error</span><span class="p">(</span><span class="n">mock_boto3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test upload with S3 error.&quot;&quot;&quot;</span>
    <span class="n">mock_s3_client</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_boto3</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_s3_client</span>

    <span class="n">error_response</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Error&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;Code&#39;</span><span class="p">:</span> <span class="s1">&#39;NoSuchBucket&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Message&#39;</span><span class="p">:</span> <span class="s1">&#39;The specified bucket does not exist&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">mock_s3_client</span><span class="o">.</span><span class="n">upload_file</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">ClientError</span><span class="p">(</span>
        <span class="n">error_response</span><span class="p">,</span> <span class="s1">&#39;PutObject&#39;</span>
    <span class="p">)</span>

    <span class="n">service</span> <span class="o">=</span> <span class="n">StorageService</span><span class="p">(</span><span class="n">bucket_name</span><span class="o">=</span><span class="s2">&quot;nonexistent-bucket&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;builtins.open&#39;</span><span class="p">,</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">read_data</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;content&quot;</span><span class="p">)):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="s2">&quot;test.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;uploads/test.txt&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;NoSuchBucket&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;cloud_storage.boto3&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_upload_file_not_found</span><span class="p">(</span><span class="n">mock_boto3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test upload with missing file.&quot;&quot;&quot;</span>
    <span class="n">mock_s3_client</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_boto3</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_s3_client</span>

    <span class="n">service</span> <span class="o">=</span> <span class="n">StorageService</span><span class="p">(</span><span class="n">bucket_name</span><span class="o">=</span><span class="s2">&quot;test-bucket&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="s2">&quot;nonexistent.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;uploads/test.txt&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;File not found&quot;</span>
    <span class="n">mock_s3_client</span><span class="o">.</span><span class="n">upload_file</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;cloud_storage.boto3&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_list_files_success</span><span class="p">(</span><span class="n">mock_boto3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test listing files.&quot;&quot;&quot;</span>
    <span class="n">mock_s3_client</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_boto3</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_s3_client</span>

    <span class="n">mock_s3_client</span><span class="o">.</span><span class="n">list_objects_v2</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Contents&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="s1">&#39;uploads/file1.txt&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Size&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
                <span class="s1">&#39;LastModified&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="s1">&#39;uploads/file2.txt&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Size&#39;</span><span class="p">:</span> <span class="mi">2048</span><span class="p">,</span>
                <span class="s1">&#39;LastModified&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>

    <span class="n">service</span> <span class="o">=</span> <span class="n">StorageService</span><span class="p">(</span><span class="n">bucket_name</span><span class="o">=</span><span class="s2">&quot;test-bucket&quot;</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">list_files</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;uploads/&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;uploads/file1.txt&quot;</span>
    <span class="k">assert</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1024</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;cloud_storage.boto3&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_list_files_empty</span><span class="p">(</span><span class="n">mock_boto3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test listing files in empty bucket.&quot;&quot;&quot;</span>
    <span class="n">mock_s3_client</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_boto3</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_s3_client</span>

    <span class="n">mock_s3_client</span><span class="o">.</span><span class="n">list_objects_v2</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">service</span> <span class="o">=</span> <span class="n">StorageService</span><span class="p">(</span><span class="n">bucket_name</span><span class="o">=</span><span class="s2">&quot;test-bucket&quot;</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">list_files</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;uploads/&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">files</span> <span class="o">==</span> <span class="p">[]</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;cloud_storage.boto3&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_delete_file_success</span><span class="p">(</span><span class="n">mock_boto3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test successful file deletion.&quot;&quot;&quot;</span>
    <span class="n">mock_s3_client</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_boto3</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_s3_client</span>

    <span class="n">service</span> <span class="o">=</span> <span class="n">StorageService</span><span class="p">(</span><span class="n">bucket_name</span><span class="o">=</span><span class="s2">&quot;test-bucket&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">delete_file</span><span class="p">(</span><span class="s2">&quot;uploads/test.txt&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span>
    <span class="n">mock_s3_client</span><span class="o">.</span><span class="n">delete_object</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">Bucket</span><span class="o">=</span><span class="s2">&quot;test-bucket&quot;</span><span class="p">,</span>
        <span class="n">Key</span><span class="o">=</span><span class="s2">&quot;uploads/test.txt&quot;</span>
    <span class="p">)</span>
</code></pre></div>

<p>Run the complete suite:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_storage_complete.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">test_storage_complete</span><span class="o">.</span><span class="n">py</span><span class="p">::</span><span class="n">test_upload_file_success</span><span class="w"> </span><span class="n">PASSED</span>
<span class="n">test_storage_complete</span><span class="o">.</span><span class="n">py</span><span class="p">::</span><span class="n">test_upload_file_s3_error</span><span class="w"> </span><span class="n">PASSED</span>
<span class="n">test_storage_complete</span><span class="o">.</span><span class="n">py</span><span class="p">::</span><span class="n">test_upload_file_not_found</span><span class="w"> </span><span class="n">PASSED</span>
<span class="n">test_storage_complete</span><span class="o">.</span><span class="n">py</span><span class="p">::</span><span class="n">test_list_files_success</span><span class="w"> </span><span class="n">PASSED</span>
<span class="n">test_storage_complete</span><span class="o">.</span><span class="n">py</span><span class="p">::</span><span class="n">test_list_files_empty</span><span class="w"> </span><span class="n">PASSED</span>
<span class="n">test_storage_complete</span><span class="o">.</span><span class="n">py</span><span class="p">::</span><span class="n">test_delete_file_success</span><span class="w"> </span><span class="n">PASSED</span>
</code></pre></div>

<h3 id="key-takeaways_3">Key Takeaways</h3>
<ol>
<li><strong>Mock at the boundary</strong>: Patch where the library is imported, not where it's defined</li>
<li><strong>Create realistic responses</strong>: Study the library's documentation to mock accurately</li>
<li><strong>Test error paths</strong>: Mock library-specific exceptions</li>
<li><strong>Verify interactions</strong>: Check that library methods were called correctly</li>
<li><strong>Test edge cases</strong>: Empty results, missing data, timeouts</li>
<li><strong>Use real exception types</strong>: Import and use the library's actual exception classes</li>
</ol>
<p>In the next section, we'll explore the dangers of over-mocking and learn when to stop mocking.</p>
<h2 id="avoiding-over-mocking">Avoiding Over-Mocking</h2>
<h2 id="avoiding-over-mocking_1">Avoiding Over-Mocking</h2>
<p>We've learned powerful mocking techniques throughout this chapter. But with great power comes great responsibility. Over-mocking is one of the most common mistakes in testing‚Äîit creates tests that pass but don't actually verify your code works.</p>
<p>This section teaches you to recognize over-mocking and develop judgment about when to mock and when not to.</p>
<h3 id="the-reference-implementation-a-report-generator">The Reference Implementation: A Report Generator</h3>
<p>Let's build a report generator that processes data and formats it:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># report_generator.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DataProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Processes raw data for reporting.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_total</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amounts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate sum of amounts.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">amounts</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_average</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amounts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate average of amounts.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">amounts</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">amounts</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">amounts</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter_by_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amounts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter amounts above threshold.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">amount</span> <span class="k">for</span> <span class="n">amount</span> <span class="ow">in</span> <span class="n">amounts</span> <span class="k">if</span> <span class="n">amount</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">group_by_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transactions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Group transactions by category.&quot;&quot;&quot;</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">transaction</span> <span class="ow">in</span> <span class="n">transactions</span><span class="p">:</span>
            <span class="n">category</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;uncategorized&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                <span class="n">groups</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">groups</span><span class="p">[</span><span class="n">category</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">groups</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ReportFormatter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Formats data for display.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_currency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format amount as currency.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">amount</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_percentage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format value as percentage.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format date for display.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ReportGenerator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates formatted reports from data.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">:</span> <span class="n">DataProcessor</span><span class="p">,</span> <span class="n">formatter</span><span class="p">:</span> <span class="n">ReportFormatter</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">processor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="n">formatter</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transactions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a summary report.&quot;&quot;&quot;</span>
        <span class="n">amounts</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">transactions</span><span class="p">]</span>

        <span class="n">total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">calculate_total</span><span class="p">(</span><span class="n">amounts</span><span class="p">)</span>
        <span class="n">average</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">calculate_average</span><span class="p">(</span><span class="n">amounts</span><span class="p">)</span>
        <span class="n">high_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">filter_by_threshold</span><span class="p">(</span><span class="n">amounts</span><span class="p">,</span> <span class="mf">1000.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">format_currency</span><span class="p">(</span><span class="n">total</span><span class="p">),</span>
            <span class="s2">&quot;average&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">format_currency</span><span class="p">(</span><span class="n">average</span><span class="p">),</span>
            <span class="s2">&quot;high_value_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">high_value</span><span class="p">),</span>
            <span class="s2">&quot;transaction_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_category_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transactions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a report grouped by category.&quot;&quot;&quot;</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">group_by_category</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span>

        <span class="n">report</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">category_transactions</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">amounts</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">category_transactions</span><span class="p">]</span>
            <span class="n">total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">calculate_total</span><span class="p">(</span><span class="n">amounts</span><span class="p">)</span>

            <span class="n">report</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">format_currency</span><span class="p">(</span><span class="n">total</span><span class="p">),</span>
                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">category_transactions</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">report</span>
</code></pre></div>

<p>This report generator has three layers:
1. <strong>DataProcessor</strong>: Pure logic (calculations, filtering, grouping)
2. <strong>ReportFormatter</strong>: Pure formatting (no logic)
3. <strong>ReportGenerator</strong>: Orchestration (uses processor and formatter)</p>
<h3 id="iteration-0-the-over-mocked-test">Iteration 0: The Over-Mocked Test</h3>
<p>Let's write a test that mocks everything:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_report_over_mocked.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">report_generator</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReportGenerator</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_generate_summary_over_mocked</span><span class="p">():</span>
    <span class="c1"># Mock everything</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="c1"># Configure all the mocks</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">calculate_total</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mf">5000.0</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">calculate_average</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mf">1000.0</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">filter_by_threshold</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1500.0</span><span class="p">,</span> <span class="mf">2000.0</span><span class="p">]</span>

    <span class="n">formatter</span><span class="o">.</span><span class="n">format_currency</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Create generator with mocks</span>
    <span class="n">generator</span> <span class="o">=</span> <span class="n">ReportGenerator</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">formatter</span><span class="p">)</span>

    <span class="c1"># Test data</span>
    <span class="n">transactions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">500.0</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">1000.0</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">1500.0</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">2000.0</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="c1"># Generate report</span>
    <span class="n">report</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate_summary</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span>

    <span class="c1"># Verify result</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$5,000.00&quot;</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;average&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$1,000.00&quot;</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;high_value_count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;transaction_count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span>

    <span class="c1"># Verify all mocks were called</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">calculate_total</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">calculate_average</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">filter_by_threshold</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">formatter</span><span class="o">.</span><span class="n">format_currency</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_report_over_mocked.py::test_generate_summary_over_mocked<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_report_over_mocked.py::test_generate_summary_over_mocked PASSED
</code></pre></div>

<p>The test passes. But what did we actually test?</p>
<h3 id="diagnostic-analysis-what-this-test-actually-verifies">Diagnostic Analysis: What This Test Actually Verifies</h3>
<p>Let's analyze what this test proves:</p>
<p><strong>What the test verifies</strong>:
1. <code>ReportGenerator.generate_summary()</code> calls <code>processor.calculate_total()</code>
2. It calls <code>processor.calculate_average()</code>
3. It calls <code>processor.filter_by_threshold()</code>
4. It calls <code>formatter.format_currency()</code>
5. It returns a dictionary with the expected keys</p>
<p><strong>What the test does NOT verify</strong>:
1. ‚ùå That <code>calculate_total()</code> actually sums the amounts correctly
2. ‚ùå That <code>calculate_average()</code> computes the average correctly
3. ‚ùå That <code>filter_by_threshold()</code> filters correctly
4. ‚ùå That <code>format_currency()</code> formats correctly
5. ‚ùå That the report contains the correct values for the given input</p>
<p><strong>The problem</strong>: We mocked the return values to be what we expect, then verified we got what we mocked. This is circular logic. The test would pass even if all the business logic was broken.</p>
<p>Let's prove this by breaking the code:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># report_generator_broken.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DataProcessor</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_total</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amounts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="c1"># BROKEN: Returns wrong value</span>
        <span class="k">return</span> <span class="mf">999999.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_average</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amounts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="c1"># BROKEN: Returns wrong value</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter_by_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amounts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="c1"># BROKEN: Returns empty list</span>
        <span class="k">return</span> <span class="p">[]</span>
</code></pre></div>

<p>Run the over-mocked test against the broken code:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># The test still passes because it never uses the real implementations!</span>
pytest<span class="w"> </span>test_report_over_mocked.py::test_generate_summary_over_mocked<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_report_over_mocked.py::test_generate_summary_over_mocked PASSED
</code></pre></div>

<p>The test passes even though the code is completely broken. This is the danger of over-mocking.</p>
<h3 id="iteration-1-testing-with-real-dependencies">Iteration 1: Testing with Real Dependencies</h3>
<p>Let's rewrite the test using real <code>DataProcessor</code> and <code>ReportFormatter</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_report_realistic.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">report_generator</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReportGenerator</span><span class="p">,</span> <span class="n">DataProcessor</span><span class="p">,</span> <span class="n">ReportFormatter</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_generate_summary_realistic</span><span class="p">():</span>
    <span class="c1"># Use REAL dependencies</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">DataProcessor</span><span class="p">()</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">ReportFormatter</span><span class="p">()</span>

    <span class="n">generator</span> <span class="o">=</span> <span class="n">ReportGenerator</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">formatter</span><span class="p">)</span>

    <span class="c1"># Test data</span>
    <span class="n">transactions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">500.0</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">1000.0</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">1500.0</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">2000.0</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="c1"># Generate report</span>
    <span class="n">report</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate_summary</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span>

    <span class="c1"># Verify ACTUAL computed values</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$5,000.00&quot;</span>  <span class="c1"># 500 + 1000 + 1500 + 2000</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;average&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$1,250.00&quot;</span>  <span class="c1"># 5000 / 4</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;high_value_count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>  <span class="c1"># 1500 and 2000 are &gt;= 1000</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;transaction_count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_report_realistic.py::test_generate_summary_realistic<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_report_realistic.py::test_generate_summary_realistic PASSED
</code></pre></div>

<p><strong>What changed</strong>:
- We use real <code>DataProcessor</code> and <code>ReportFormatter</code> instances
- The test verifies actual computed values, not mocked return values
- If the business logic is broken, this test will fail</p>
<p>Let's prove it by running this test against the broken code:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># If we use the broken DataProcessor, this test fails:</span>
<span class="c1"># AssertionError: assert &#39;$999,999.00&#39; == &#39;$5,000.00&#39;</span>
</code></pre></div>

<p>This test actually verifies the code works correctly.</p>
<h3 id="iteration-2-when-to-mock-external-dependencies-only">Iteration 2: When to Mock - External Dependencies Only</h3>
<p>The rule of thumb: <strong>Mock external dependencies, not your own code.</strong></p>
<p>Let's add an external dependency to our report generator:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># report_generator.py (addition)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">EmailService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;External service for sending emails.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">send_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subject</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># In reality, calls external email API</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Real implementation sends email&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ReportGenerator</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">:</span> <span class="n">DataProcessor</span><span class="p">,</span> <span class="n">formatter</span><span class="p">:</span> <span class="n">ReportFormatter</span><span class="p">,</span> 
                 <span class="n">email_service</span><span class="p">:</span> <span class="n">EmailService</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">processor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="n">formatter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email_service</span> <span class="o">=</span> <span class="n">email_service</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_and_email_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transactions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">recipient</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate summary and email it.&quot;&quot;&quot;</span>
        <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_summary</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">email_service</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            Summary Report:</span>
<span class="s2">            Total: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">            Average: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;average&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">            High Value Transactions: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;high_value_count&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">            &quot;&quot;&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">email_service</span><span class="o">.</span><span class="n">send_email</span><span class="p">(</span>
                <span class="n">to</span><span class="o">=</span><span class="n">recipient</span><span class="p">,</span>
                <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Transaction Summary Report&quot;</span><span class="p">,</span>
                <span class="n">body</span><span class="o">=</span><span class="n">body</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">report</span>
</code></pre></div>

<p>Now we have a legitimate reason to mock‚Äîthe <code>EmailService</code> is external:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_generate_and_email_summary</span><span class="p">():</span>
    <span class="c1"># Use REAL processor and formatter</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">DataProcessor</span><span class="p">()</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">ReportFormatter</span><span class="p">()</span>

    <span class="c1"># MOCK the external email service</span>
    <span class="n">email_service</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">generator</span> <span class="o">=</span> <span class="n">ReportGenerator</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">formatter</span><span class="p">,</span> <span class="n">email_service</span><span class="p">)</span>

    <span class="n">transactions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">500.0</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">1000.0</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">1500.0</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">2000.0</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">report</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate_and_email_summary</span><span class="p">(</span><span class="n">transactions</span><span class="p">,</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>

    <span class="c1"># Verify report is correct (using real logic)</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$5,000.00&quot;</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;average&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$1,250.00&quot;</span>

    <span class="c1"># Verify email was sent (mock verification)</span>
    <span class="n">email_service</span><span class="o">.</span><span class="n">send_email</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">call_args</span> <span class="o">=</span> <span class="n">email_service</span><span class="o">.</span><span class="n">send_email</span><span class="o">.</span><span class="n">call_args</span>
    <span class="k">assert</span> <span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;user@example.com&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;Summary Report&quot;</span> <span class="ow">in</span> <span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="s2">&quot;$5,000.00&quot;</span> <span class="ow">in</span> <span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">]</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_report_realistic.py::test_generate_and_email_summary<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_report_realistic.py::test_generate_and_email_summary PASSED
</code></pre></div>

<p><strong>What we did right</strong>:
- Used real <code>DataProcessor</code> and <code>ReportFormatter</code> (our code)
- Mocked <code>EmailService</code> (external dependency)
- Verified actual computed values
- Verified the external service was called correctly</p>
<h3 id="the-over-mocking-spectrum">The Over-Mocking Spectrum</h3>
<p>Tests fall on a spectrum from "no mocking" to "everything mocked":</p>
<div class="codehilite"><pre><span></span><code><span class="n">No</span><span class="w"> </span><span class="n">Mocking</span><span class="w">          </span><span class="n">Balanced</span><span class="w">           </span><span class="n">Over</span><span class="o">-</span><span class="n">Mocked</span>
<span class="w">    </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w">                    </span><span class="o">|</span>
<span class="w">    </span><span class="n">v</span><span class="w">                  </span><span class="n">v</span><span class="w">                    </span><span class="n">v</span>
<span class="p">[</span><span class="n">Real</span><span class="w"> </span><span class="n">objects</span><span class="p">]</span><span class="w">  </span><span class="p">[</span><span class="n">Mock</span><span class="w"> </span><span class="n">external</span><span class="p">]</span><span class="w">    </span><span class="p">[</span><span class="n">Mock</span><span class="w"> </span><span class="n">everything</span><span class="p">]</span>
<span class="p">[</span><span class="n">Integration</span><span class="p">]</span><span class="w">   </span><span class="p">[</span><span class="n">Unit</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">verify</span><span class="p">]</span><span class="w">    </span><span class="p">[</span><span class="n">Mock</span><span class="w"> </span><span class="n">own</span><span class="w"> </span><span class="n">code</span><span class="p">]</span>
<span class="p">[</span><span class="n">Slow</span><span class="p">,</span><span class="w"> </span><span class="n">real</span><span class="p">]</span><span class="w">    </span><span class="p">[</span><span class="n">Fast</span><span class="p">,</span><span class="w"> </span><span class="n">focused</span><span class="p">]</span><span class="w">    </span><span class="p">[</span><span class="n">Fast</span><span class="p">,</span><span class="w"> </span><span class="n">useless</span><span class="p">]</span>
</code></pre></div>

<p><strong>No mocking</strong> (left):
- Uses all real objects
- Tests integration between components
- Slow but comprehensive
- Good for integration tests</p>
<p><strong>Balanced</strong> (center):
- Mocks external dependencies only
- Uses real implementations of your code
- Fast and meaningful
- Good for unit tests</p>
<p><strong>Over-mocked</strong> (right):
- Mocks everything including your own code
- Tests only that methods are called
- Fast but verifies nothing
- Bad practice</p>
<h3 id="signs-youre-over-mocking">Signs You're Over-Mocking</h3>
<p><strong>Warning sign 1: You're mocking simple logic</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Mocking simple calculation</span>
<span class="n">processor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
<span class="n">processor</span><span class="o">.</span><span class="n">calculate_total</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mf">100.0</span>

<span class="c1"># Good: Use real calculation</span>
<span class="n">processor</span> <span class="o">=</span> <span class="n">DataProcessor</span><span class="p">()</span>
<span class="n">total</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">calculate_total</span><span class="p">([</span><span class="mf">25.0</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">total</span> <span class="o">==</span> <span class="mf">100.0</span>
</code></pre></div>

<p><strong>Warning sign 2: You're configuring return values to match assertions</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Circular logic</span>
<span class="n">mock</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;expected_value&quot;</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">code_under_test</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;expected_value&quot;</span>  <span class="c1"># Of course it matches!</span>

<span class="c1"># Good: Verify actual computation</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">code_under_test</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">compute_expected_value_independently</span><span class="p">()</span>
</code></pre></div>

<p><strong>Warning sign 3: Your test would pass with broken code</strong></p>
<p>If you can break the implementation and the test still passes, you're over-mocking.</p>
<p><strong>Warning sign 4: You're mocking more than you're testing</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: More mock setup than actual testing</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_something</span><span class="p">():</span>
    <span class="n">mock1</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock1</span><span class="o">.</span><span class="n">method1</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;value1&quot;</span>
    <span class="n">mock1</span><span class="o">.</span><span class="n">method2</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;value2&quot;</span>
    <span class="n">mock2</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock2</span><span class="o">.</span><span class="n">method1</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;value3&quot;</span>
    <span class="n">mock2</span><span class="o">.</span><span class="n">method2</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;value4&quot;</span>
    <span class="n">mock3</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock3</span><span class="o">.</span><span class="n">method1</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;value5&quot;</span>
    <span class="c1"># ... 20 more lines of mock setup ...</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">code_under_test</span><span class="p">(</span><span class="n">mock1</span><span class="p">,</span> <span class="n">mock2</span><span class="p">,</span> <span class="n">mock3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;something&quot;</span>  <span class="c1"># One assertion</span>
</code></pre></div>

<p><strong>Warning sign 5: You're verifying implementation details</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Testing HOW it works</span>
<span class="n">mock</span><span class="o">.</span><span class="n">internal_helper</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
<span class="n">mock</span><span class="o">.</span><span class="n">private_method</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">specific_args</span><span class="p">)</span>

<span class="c1"># Good: Testing WHAT it produces</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">code_under_test</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">expected_output</span>
</code></pre></div>

<h3 id="decision-framework-to-mock-or-not-to-mock">Decision Framework: To Mock or Not to Mock</h3>
<p>Use this decision tree:</p>
<div class="codehilite"><pre><span></span><code><span class="nv">Is</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">an</span><span class="w"> </span><span class="nv">external</span><span class="w"> </span><span class="nv">dependency</span>?
‚îú‚îÄ<span class="w"> </span><span class="nv">Yes</span><span class="w"> </span>‚Üí<span class="w"> </span><span class="nv">Mock</span><span class="w"> </span><span class="nv">it</span>
‚îÇ<span class="w">   </span>‚îú‚îÄ<span class="w"> </span><span class="nv">Network</span><span class="w"> </span><span class="nv">calls</span><span class="w"> </span><span class="ss">(</span><span class="nv">HTTP</span>,<span class="w"> </span><span class="nv">database</span>,<span class="w"> </span><span class="nv">cloud</span><span class="w"> </span><span class="nv">services</span><span class="ss">)</span>
‚îÇ<span class="w">   </span>‚îú‚îÄ<span class="w"> </span><span class="nv">File</span><span class="w"> </span><span class="nv">system</span><span class="w"> </span><span class="nv">operations</span><span class="w"> </span><span class="ss">(</span><span class="nv">when</span><span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="nv">testing</span><span class="w"> </span><span class="nv">I</span><span class="o">/</span><span class="nv">O</span><span class="ss">)</span>
‚îÇ<span class="w">   </span>‚îú‚îÄ<span class="w"> </span><span class="nv">Time</span><span class="o">/</span><span class="nv">randomness</span><span class="w"> </span><span class="ss">(</span><span class="nv">when</span><span class="w"> </span><span class="nv">you</span><span class="w"> </span><span class="nv">need</span><span class="w"> </span><span class="nv">determinism</span><span class="ss">)</span>
‚îÇ<span class="w">   </span>‚îî‚îÄ<span class="w"> </span><span class="nv">External</span><span class="w"> </span><span class="nv">services</span><span class="w"> </span><span class="ss">(</span><span class="nv">email</span>,<span class="w"> </span><span class="nv">SMS</span>,<span class="w"> </span><span class="nv">payment</span><span class="w"> </span><span class="nv">gateways</span><span class="ss">)</span>
‚îÇ
‚îî‚îÄ<span class="w"> </span><span class="nv">No</span><span class="w"> </span>‚Üí<span class="w"> </span><span class="nv">Is</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">your</span><span class="w"> </span><span class="nv">code</span>?
<span class="w">    </span>‚îú‚îÄ<span class="w"> </span><span class="nv">Yes</span><span class="w"> </span>‚Üí<span class="w"> </span><span class="nv">Don</span><span class="err">&#39;t mock it</span>
<span class="err">    ‚îÇ   ‚îú‚îÄ Business logic</span>
<span class="err">    ‚îÇ   ‚îú‚îÄ Data transformations</span>
<span class="err">    ‚îÇ   ‚îú‚îÄ Calculations</span>
<span class="err">    ‚îÇ   ‚îî‚îÄ Formatting</span>
<span class="err">    ‚îÇ</span>
<span class="err">    ‚îî‚îÄ Is it slow or non-deterministic?</span>
<span class="err">        ‚îú‚îÄ Yes ‚Üí Consider mocking</span>
<span class="err">        ‚îÇ   ‚îú‚îÄ Complex algorithms (if too slow)</span>
<span class="err">        ‚îÇ   ‚îî‚îÄ Random number generation</span>
<span class="err">        ‚îÇ</span>
<span class="w">        </span>‚îî‚îÄ<span class="w"> </span><span class="nv">No</span><span class="w"> </span>‚Üí<span class="w"> </span><span class="nv">Don</span><span class="err">&#39;t mock it</span>
</code></pre></div>

<h3 id="refactoring-over-mocked-tests">Refactoring Over-Mocked Tests</h3>
<p>Let's refactor an over-mocked test step by step:</p>
<p><strong>Before (over-mocked)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_category_report_over_mocked</span><span class="p">():</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">processor</span><span class="o">.</span><span class="n">group_by_category</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;food&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">50.0</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">30.0</span><span class="p">}],</span>
        <span class="s2">&quot;transport&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">20.0</span><span class="p">}]</span>
    <span class="p">}</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">calculate_total</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="mf">80.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">]</span>
    <span class="n">formatter</span><span class="o">.</span><span class="n">format_currency</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">generator</span> <span class="o">=</span> <span class="n">ReportGenerator</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">formatter</span><span class="p">)</span>

    <span class="n">transactions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">50.0</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;food&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">30.0</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;food&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">20.0</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;transport&quot;</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">report</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate_category_report</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;food&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$80.00&quot;</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;transport&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$20.00&quot;</span>
</code></pre></div>

<p><strong>After (balanced)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_category_report_realistic</span><span class="p">():</span>
    <span class="c1"># Use real dependencies</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">DataProcessor</span><span class="p">()</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">ReportFormatter</span><span class="p">()</span>

    <span class="n">generator</span> <span class="o">=</span> <span class="n">ReportGenerator</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">formatter</span><span class="p">)</span>

    <span class="n">transactions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">50.0</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;food&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">30.0</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;food&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">20.0</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;transport&quot;</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">report</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate_category_report</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span>

    <span class="c1"># Verify actual computed values</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;food&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$80.00&quot;</span>  <span class="c1"># 50 + 30</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;food&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;transport&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$20.00&quot;</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;transport&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>

<p><strong>What improved</strong>:
- Removed unnecessary mocks
- Test verifies actual business logic
- Test would fail if logic is broken
- Simpler and more maintainable</p>
<h3 id="the-complete-test-suite-balanced-mocking">The Complete Test Suite: Balanced Mocking</h3>
<p>Here's a complete test suite demonstrating balanced mocking:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_report_balanced.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">report_generator</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ReportGenerator</span><span class="p">,</span> <span class="n">DataProcessor</span><span class="p">,</span> <span class="n">ReportFormatter</span><span class="p">,</span> <span class="n">EmailService</span>
<span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_generate_summary_with_real_dependencies</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test summary generation with real processor and formatter.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">DataProcessor</span><span class="p">()</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">ReportFormatter</span><span class="p">()</span>
    <span class="n">generator</span> <span class="o">=</span> <span class="n">ReportGenerator</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">formatter</span><span class="p">)</span>

    <span class="n">transactions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">500.0</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">1000.0</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">1500.0</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">2000.0</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">report</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate_summary</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$5,000.00&quot;</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;average&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$1,250.00&quot;</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;high_value_count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;transaction_count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_generate_category_report_with_real_dependencies</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test category report with real processor and formatter.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">DataProcessor</span><span class="p">()</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">ReportFormatter</span><span class="p">()</span>
    <span class="n">generator</span> <span class="o">=</span> <span class="n">ReportGenerator</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">formatter</span><span class="p">)</span>

    <span class="n">transactions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">50.0</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;food&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">30.0</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;food&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">20.0</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;transport&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">100.0</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;entertainment&quot;</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">report</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate_category_report</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;food&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$80.00&quot;</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;food&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;transport&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$20.00&quot;</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;transport&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;entertainment&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$100.00&quot;</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;entertainment&quot;</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_generate_and_email_summary_mocks_external_only</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test email functionality - mock external service only.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">DataProcessor</span><span class="p">()</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">ReportFormatter</span><span class="p">()</span>
    <span class="n">email_service</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>  <span class="c1"># Mock external dependency</span>

    <span class="n">generator</span> <span class="o">=</span> <span class="n">ReportGenerator</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">formatter</span><span class="p">,</span> <span class="n">email_service</span><span class="p">)</span>

    <span class="n">transactions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">500.0</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">1000.0</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">report</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate_and_email_summary</span><span class="p">(</span>
        <span class="n">transactions</span><span class="p">,</span> <span class="s2">&quot;user@example.com&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Verify real computation</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$1,500.00&quot;</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;average&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$750.00&quot;</span>

    <span class="c1"># Verify external service was called</span>
    <span class="n">email_service</span><span class="o">.</span><span class="n">send_email</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">call_args</span> <span class="o">=</span> <span class="n">email_service</span><span class="o">.</span><span class="n">send_email</span><span class="o">.</span><span class="n">call_args</span>
    <span class="k">assert</span> <span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;user@example.com&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;$1,500.00&quot;</span> <span class="ow">in</span> <span class="n">call_args</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_empty_transactions</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test edge case with no transactions.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">DataProcessor</span><span class="p">()</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">ReportFormatter</span><span class="p">()</span>
    <span class="n">generator</span> <span class="o">=</span> <span class="n">ReportGenerator</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">formatter</span><span class="p">)</span>

    <span class="n">report</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate_summary</span><span class="p">([])</span>

    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$0.00&quot;</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;average&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$0.00&quot;</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;high_value_count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;transaction_count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
</code></pre></div>

<p>Run the complete suite:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_report_balanced.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_report_balanced.py::test_generate_summary_with_real_dependencies PASSED
test_report_balanced.py::test_generate_category_report_with_real_dependencies PASSED
test_report_balanced.py::test_generate_and_email_summary_mocks_external_only PASSED
test_report_balanced.py::test_empty_transactions PASSED
</code></pre></div>

<h3 id="key-principles-for-avoiding-over-mocking">Key Principles for Avoiding Over-Mocking</h3>
<ol>
<li><strong>Mock external dependencies, not your own code</strong></li>
<li>External: Network, database, file system, third-party APIs</li>
<li>
<p>Your code: Business logic, calculations, transformations</p>
</li>
<li>
<p><strong>Test behavior, not implementation</strong></p>
</li>
<li>Good: "Does it produce the correct output?"</li>
<li>
<p>Bad: "Does it call method X with argument Y?"</p>
</li>
<li>
<p><strong>If you can break the code and tests still pass, you're over-mocking</strong></p>
</li>
<li>Tests should fail when business logic is broken</li>
<li>
<p>Mocked return values bypass the actual logic</p>
</li>
<li>
<p><strong>Use real objects when they're fast and deterministic</strong></p>
</li>
<li>Pure functions: Always use real implementations</li>
<li>Simple classes: Use real instances</li>
<li>
<p>Complex external systems: Mock them</p>
</li>
<li>
<p><strong>Mock at the boundaries</strong></p>
</li>
<li>Mock where your system meets external systems</li>
<li>
<p>Don't mock internal boundaries between your own classes</p>
</li>
<li>
<p><strong>Prefer integration tests for complex interactions</strong></p>
</li>
<li>When multiple components work together, test them together</li>
<li>Use mocks only for external dependencies</li>
</ol>
<h3 id="when-over-mocking-is-acceptable">When Over-Mocking Is Acceptable</h3>
<p>There are rare cases where mocking your own code is justified:</p>
<p><strong>1. Performance testing</strong>: When the real implementation is too slow</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Acceptable: Testing performance-critical code</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_report_generation_performance</span><span class="p">():</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>  <span class="c1"># Real processor is too slow</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">calculate_total</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mf">1000.0</span>
    <span class="c1"># ... test that report generation itself is fast</span>
</code></pre></div>

<p><strong>2. Testing error handling</strong>: When you need to simulate specific error conditions</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Acceptable: Testing error handling</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_handles_processor_exception</span><span class="p">():</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">calculate_total</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid data&quot;</span><span class="p">)</span>
    <span class="c1"># ... test that error is handled gracefully</span>
</code></pre></div>

<p><strong>3. Legacy code</strong>: When refactoring is not feasible</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Acceptable: Working with legacy code that&#39;s hard to test</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_legacy_system</span><span class="p">():</span>
    <span class="n">legacy_component</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>  <span class="c1"># Can&#39;t easily create real instance</span>
    <span class="c1"># ... test the new code that uses legacy component</span>
</code></pre></div>

<p>But even in these cases, consider whether there's a better approach:
- Can you optimize the slow code?
- Can you refactor to make testing easier?
- Can you use a test double that's closer to the real implementation?</p>
<h3 id="the-journey-from-over-mocking-to-balanced-testing">The Journey: From Over-Mocking to Balanced Testing</h3>
<table>
<thead>
<tr>
<th>Iteration</th>
<th>Approach</th>
<th>What We Learned</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Mocked everything</td>
<td>Tests pass but verify nothing</td>
</tr>
<tr>
<td>1</td>
<td>Used real dependencies</td>
<td>Tests verify actual behavior</td>
</tr>
<tr>
<td>2</td>
<td>Mocked external only</td>
<td>Balance between speed and accuracy</td>
</tr>
<tr>
<td>3</td>
<td>Refactored over-mocked tests</td>
<td>Simpler, more maintainable tests</td>
</tr>
</tbody>
</table>
<h3 id="final-thoughts">Final Thoughts</h3>
<p>Over-mocking is seductive because:
- It makes tests fast
- It makes tests pass easily
- It feels like you're being thorough</p>
<p>But over-mocked tests are worse than no tests because:
- They give false confidence
- They don't catch bugs
- They're brittle (break when implementation changes)
- They're hard to maintain</p>
<p><strong>The golden rule</strong>: Mock external dependencies. Test your own code with real implementations.</p>
<p>When in doubt, ask yourself: "If I break this business logic, will my test fail?" If the answer is no, you're probably over-mocking.</p>
        </div>
        <div class="footer">
            Generated on 2025-12-03 10:37:04 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>