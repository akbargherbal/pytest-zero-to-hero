<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>09 Spies, Stubs, and Test Doubles</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">03 Mocking and Isolation</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-9-spies-stubs-and-test-doubles">Chapter 9: Spies, Stubs, and Test Doubles</h1>
<h2 id="the-difference-between-mocks-stubs-and-spies">The Difference Between Mocks, Stubs, and Spies</h2>
<h2 id="what-are-test-doubles">What Are Test Doubles?</h2>
<p>In the previous chapter, we introduced <code>unittest.mock</code> and the concept of mocking. "Mock" is often used as a catch-all term, but it's technically one of several types of objects that stand in for real objects during testing. The general, more accurate term for these stand-ins is <strong>Test Double</strong>.</p>
<p>Think of a stunt double in a movie. They look and act like the real actor for a specific scene, allowing the production to film something that would be dangerous or impractical for the star. Test doubles do the same for your code: they stand in for components that are slow, unreliable, or have side effects (like databases, external APIs, or the file system), allowing your tests to run quickly and in isolation.</p>
<p>There are several kinds of test doubles, but we'll focus on the three most common and useful ones: Stubs, Spies, and Mocks. Understanding their distinct roles will make your tests clearer and more intentional.</p>
<h3 id="stubs-the-state-verifiers">Stubs: The State Verifiers</h3>
<p>A <strong>Stub</strong> is a simple object that provides canned answers to calls made during the test. It's all about <strong>state</strong>. You use a stub when your test needs a dependency to return specific data, but you don't care <em>how</em> or <em>if</em> the dependency was called.</p>
<p>Imagine a function that fetches user data and then formats it. To test the formatting logic, you don't need a real database. You just need an object that returns a predictable user dictionary.</p>
<p>Let's look at a system that needs a stub.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/user_service.py</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_user_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;In a real app, this would query a database.&quot;&quot;&quot;</span>
    <span class="c1"># For this example, we&#39;ll simulate a slow or complex lookup.</span>
    <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="s2">&quot;Cannot connect to the database!&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">format_user_display</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetches user data and formats it for display.&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
</code></pre></div>

<p>Testing <code>format_user_display</code> directly is impossible because <code>get_user_data</code> will raise an error. We need to replace <code>get_user_data</code> with a stub that returns a predictable dictionary.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_user_service_stub.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.user_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">format_user_display</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_format_user_display_with_stub</span><span class="p">():</span>
    <span class="c1"># This is our Stub. It&#39;s pre-programmed to return a specific dictionary.</span>
    <span class="c1"># We don&#39;t care how many times it&#39;s called, only that it provides state.</span>
    <span class="n">stub_user_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">}</span>

    <span class="c1"># We use patch to replace the real get_user_data with our stub&#39;s behavior.</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;src.user_service.get_user_data&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">stub_user_data</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_get_user</span><span class="p">:</span>
        <span class="c1"># The test now runs against the stub, not the real function.</span>
        <span class="n">display_name</span> <span class="o">=</span> <span class="n">format_user_display</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># We assert the result of our formatting logic.</span>
    <span class="k">assert</span> <span class="n">display_name</span> <span class="o">==</span> <span class="s2">&quot;Alice (alice@example.com)&quot;</span>

    <span class="c1"># Note: We don&#39;t assert anything about the mock_get_user itself.</span>
    <span class="c1"># We only used it to provide state.</span>
</code></pre></div>

<p>The key takeaway: A stub's job is to provide data to the system under test. The test verifies the system's output, not the stub's interactions.</p>
<h3 id="spies-the-behavior-verifiers">Spies: The Behavior Verifiers</h3>
<p>A <strong>Spy</strong> is a test double that records what happens to it. It's all about <strong>behavior</strong>. You use a spy when you need to verify that a certain function was called, how many times it was called, or what arguments it was called with. The return value is often unimportant.</p>
<p>Imagine a function that processes a payment and then sends a notification email. You want to test that the email function is actually called with the correct details.</p>
<p>Let's define a system that needs a spy.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/notifications.py</span>

<span class="k">def</span><span class="w"> </span><span class="nf">send_notification</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;In a real app, this would connect to an SMTP server and send an email.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending email to </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># This has a side effect we want to avoid in tests.</span>
    <span class="k">return</span> <span class="s2">&quot;Success&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">customer_email</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Processes an order and notifies the customer.&quot;&quot;&quot;</span>
    <span class="c1"># Some complex order processing logic would go here...</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing order </span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="c1"># After processing, send a notification.</span>
    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Your order </span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span><span class="s2"> has been processed.&quot;</span>
    <span class="n">send_notification</span><span class="p">(</span><span class="n">customer_email</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<p>We don't want to actually send an email during our test. We just want to <em>spy</em> on the <code>send_notification</code> function to ensure it was called correctly.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_notifications_spy.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.notifications</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_order</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_sends_notification</span><span class="p">():</span>
    <span class="c1"># We patch send_notification. The resulting mock object acts as our Spy.</span>
    <span class="c1"># It will record all calls made to it.</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;src.notifications.send_notification&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">spy_send_notification</span><span class="p">:</span>
        <span class="n">process_order</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="s2">&quot;ABC-123&quot;</span><span class="p">,</span> <span class="n">customer_email</span><span class="o">=</span><span class="s2">&quot;bob@example.com&quot;</span><span class="p">)</span>

    <span class="c1"># Now we use the spy to verify behavior.</span>
    <span class="c1"># Was the function called exactly once?</span>
    <span class="n">spy_send_notification</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="c1"># Was it called with the correct arguments?</span>
    <span class="n">expected_message</span> <span class="o">=</span> <span class="s2">&quot;Your order ABC-123 has been processed.&quot;</span>
    <span class="n">spy_send_notification</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="s2">&quot;bob@example.com&quot;</span><span class="p">,</span>
        <span class="n">expected_message</span>
    <span class="p">)</span>
</code></pre></div>

<p>The key takeaway: A spy's job is to record interactions. The test uses the spy's records to verify that the system under test behaved as expected.</p>
<h3 id="mocks-the-all-in-one">Mocks: The All-in-One</h3>
<p>A <strong>Mock</strong> is the most powerful type of test double. It combines the capabilities of stubs and spies. A mock is an object that you pre-program with expectations. These expectations include what methods will be called, with what arguments, and what they should return. If the mock receives a call it wasn't expecting, it can raise an error.</p>
<p>Mocks are both <strong>state and behavior</strong> verifiers. You use them when you need to verify complex interactions between your system and its dependencies. The <code>unittest.mock.Mock</code> and <code>MagicMock</code> objects we've been using are, by definition, mocks.</p>
<p>In the previous examples, we used <code>patch</code> to create objects that we <em>used</em> as stubs or spies. The underlying object was a mock, but we chose to use only a subset of its functionality.</p>
<ul>
<li>When we set <code>return_value</code> and didn't make any assertions on the mock itself, we used it as a <strong>stub</strong>.</li>
<li>When we ignored the <code>return_value</code> and only used <code>assert_called_once_with</code>, we used it as a <strong>spy</strong>.</li>
</ul>
<p>A true mock-based test often does both at once.</p>
<h3 id="summary-table">Summary Table</h3>
<table>
<thead>
<tr>
<th>Type</th>
<th>Purpose</th>
<th>Key Question Answered</th>
<th>Example Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Stub</strong></td>
<td>Provide canned data (state)</td>
<td>"Did my code produce the correct output given this input?"</td>
<td>Stubbing a database call to return a specific user record.</td>
</tr>
<tr>
<td><strong>Spy</strong></td>
<td>Record interactions (behavior)</td>
<td>"Did my code call the correct function with the right arguments?"</td>
<td>Spying on a logging function to ensure an error was logged.</td>
</tr>
<tr>
<td><strong>Mock</strong></td>
<td>Pre-programmed expectations (state &amp; behavior)</td>
<td>"Did my code interact with its dependency in exactly this way?"</td>
<td>Mocking a payment gateway API to verify a complex transaction sequence.</td>
</tr>
</tbody>
</table>
<p>In the pytest world, you'll almost always use <code>unittest.mock</code> objects. The important thing isn't the tool itself, but how you use it. By thinking in terms of "am I testing state or behavior?", you can write clearer, more focused tests.</p>
<h2 id="using-magicmock-for-complex-scenarios">Using MagicMock for Complex Scenarios</h2>
<h2 id="using-magicmock-for-complex-scenarios_1">Using MagicMock for Complex Scenarios</h2>
<p>We've used <code>unittest.mock.Mock</code>, but it has a more capable sibling: <code>unittest.mock.MagicMock</code>. For most day-to-day testing, <code>MagicMock</code> is the tool you'll want to reach for.</p>
<p>So, what's "magic" about it? <code>MagicMock</code> pre-implements most of Python's "magic" methods (also called dunder methods, like <code>__str__</code>, <code>__len__</code>, <code>__enter__</code>, <code>__exit__</code>). A regular <code>Mock</code> object does not.</p>
<h3 id="the-problem-with-regular-mocks">The Problem with Regular Mocks</h3>
<p>Let's see what happens when we try to use a regular <code>Mock</code> object in a situation that requires a magic method.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_magicmock_intro.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_regular_mock_limitations</span><span class="p">():</span>
    <span class="n">mock_obj</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="c1"># What happens if we try to get its length?</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">mock_obj</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calling len() on a Mock failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># What happens if we use it as a context manager?</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">mock_obj</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using a Mock as a context manager failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Running this test would produce output like:</p>
<div class="codehilite"><pre><span></span><code><span class="nx">Calling</span><span class="w"> </span><span class="nx">len</span><span class="p">()</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">Mock</span><span class="w"> </span><span class="nx">failed</span><span class="p">:</span><span class="w"> </span><span class="nx">object</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">Mock</span><span class="err">&#39;</span><span class="w"> </span><span class="nx">has</span><span class="w"> </span><span class="nx">no</span><span class="w"> </span><span class="nx">len</span><span class="p">()</span>
<span class="nx">Using</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">Mock</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">context</span><span class="w"> </span><span class="nx">manager</span><span class="w"> </span><span class="nx">failed</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">Mock</span><span class="err">&#39;</span><span class="w"> </span><span class="nx">object</span><span class="w"> </span><span class="nx">does</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nx">support</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">context</span><span class="w"> </span><span class="nx">manager</span><span class="w"> </span><span class="nx">protocol</span>
</code></pre></div>

<p>The <code>Mock</code> object is not equipped to handle these common Python protocols out of the box. You would have to manually configure <code>__len__</code> and <code>__enter__</code>/<code>__exit__</code> methods, which is tedious.</p>
<h3 id="magicmock-to-the-rescue">MagicMock to the Rescue</h3>
<p><code>MagicMock</code> solves this by providing default implementations for these methods. They return another <code>MagicMock</code> instance, allowing you to chain calls and make assertions naturally.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_magicmock_intro.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">MagicMock</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_magicmock_capabilities</span><span class="p">():</span>
    <span class="n">magic_mock</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>

    <span class="c1"># It has a default length</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">magic_mock</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="c1"># It can be used as a context manager</span>
    <span class="k">with</span> <span class="n">magic_mock</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">m</span> <span class="ow">is</span> <span class="n">magic_mock</span>

    <span class="c1"># It can be iterated over (it returns an empty iterator by default)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">magic_mock</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="c1"># You can even access items like a dictionary</span>
    <span class="c1"># This will create a new MagicMock on the fly!</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">magic_mock</span><span class="p">[</span><span class="s2">&quot;some_key&quot;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">MagicMock</span><span class="p">)</span>
</code></pre></div>

<p><code>MagicMock</code> makes your test doubles behave more like real Python objects, reducing the friction of writing tests.</p>
<h3 id="mocking-chained-calls">Mocking Chained Calls</h3>
<p>One of the most powerful features of <code>MagicMock</code> is its ability to mock chained method calls effortlessly. This is extremely common when dealing with libraries that use a fluent API (e.g., ORMs, API clients).</p>
<p>Consider an object that represents a connection to a web service:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/api_client.py</span>

<span class="k">class</span><span class="w"> </span><span class="nc">APIClient</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span> <span class="o">=</span> <span class="n">base_url</span>
        <span class="c1"># In a real client, other setup would happen here.</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">users</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This could be a different object that handles user-related endpoints.</span>
        <span class="c1"># We&#39;ll simulate it for the example.</span>
        <span class="k">class</span><span class="w"> </span><span class="nc">UserEndpoint</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
                <span class="c1"># This would make a real HTTP request.</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Real User&quot;</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">UserEndpoint</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_username_from_api</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">APIClient</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets a user by ID and returns their name.&quot;&quot;&quot;</span>
    <span class="n">user_data</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
</code></pre></div>

<p>To test <code>get_username_from_api</code>, we need to mock the entire chain: <code>client.users.get_by_id(user_id)</code>. With <code>MagicMock</code>, this is surprisingly simple.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_api_client.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">MagicMock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.api_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_username_from_api</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_username_from_api</span><span class="p">():</span>
    <span class="c1"># 1. Create a MagicMock to stand in for the APIClient instance.</span>
    <span class="n">mock_client</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>

    <span class="c1"># 2. Configure the final return value at the end of the chain.</span>
    <span class="c1"># MagicMock automatically creates mock objects for `users` and `get_by_id`.</span>
    <span class="n">mock_client</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get_by_id</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Mocked Alice&quot;</span><span class="p">}</span>

    <span class="c1"># 3. Call the function with the mock client.</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">get_username_from_api</span><span class="p">(</span><span class="n">mock_client</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>

    <span class="c1"># 4. Assert the result.</span>
    <span class="k">assert</span> <span class="n">username</span> <span class="o">==</span> <span class="s2">&quot;Mocked Alice&quot;</span>

    <span class="c1"># 5. (Optional) Assert that the mock was called correctly.</span>
    <span class="n">mock_client</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get_by_id</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
</code></pre></div>

<p>This works because accessing an attribute on a <code>MagicMock</code> (like <code>mock_client.users</code>) that doesn't already exist creates a <em>new</em> <code>MagicMock</code> on the fly. You can then access attributes on <em>that</em> mock (<code>.get_by_id</code>), and so on. You only need to configure the return value of the very last call in the chain.</p>
<p><strong>Rule of thumb:</strong> Use <code>MagicMock</code> as your default choice over <code>Mock</code>. Switch to <code>Mock</code> only if you specifically need the stricter behavior of not having magic methods implemented.</p>
<h2 id="mocking-entire-classes">Mocking Entire Classes</h2>
<h2 id="mocking-entire-classes_1">Mocking Entire Classes</h2>
<p>So far, we've mostly patched functions or methods on existing objects. A more powerful technique is to patch an entire class. This is essential when you want to prevent a class from being instantiated at all, controlling its creation and the behavior of its instances.</p>
<p>This is most common when dealing with classes that manage external resources, like database connections or network clients.</p>
<h3 id="the-scenario-a-database-connector">The Scenario: A Database Connector</h3>
<p>Let's define a simple class that connects to a database. We absolutely do not want this class's <code>__init__</code> method to run during our unit tests, as it would try to establish a real network connection.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/database.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DatabaseConnector</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection_string</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Attempting to connect to </span><span class="si">{</span><span class="n">connection_string</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="c1"># Simulate a slow network connection</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_string</span> <span class="o">=</span> <span class="n">connection_string</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connection successful!&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fetch_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="c1"># In a real scenario, this would execute the query.</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Data for query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_report_for_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Connects to the DB and generates a report.&quot;&quot;&quot;</span>
    <span class="n">connector</span> <span class="o">=</span> <span class="n">DatabaseConnector</span><span class="p">(</span><span class="s2">&quot;postgresql://user:pass@host/db&quot;</span><span class="p">)</span>
    <span class="n">report_data</span> <span class="o">=</span> <span class="n">connector</span><span class="o">.</span><span class="n">fetch_data</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT * FROM reports WHERE user_id=</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Report: </span><span class="si">{</span><span class="n">report_data</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>

<p>Our goal is to test <code>get_report_for_user</code> without ever running the <code>DatabaseConnector.__init__</code> method. We can achieve this by patching the <code>DatabaseConnector</code> class itself.</p>
<h3 id="patching-a-class">Patching a Class</h3>
<p>When you use <code>patch</code> on a class, pytest replaces the class with a <code>MagicMock</code>. Any attempt to instantiate the class (e.g., <code>DatabaseConnector(...)</code>) will "call" this mock. The result of that call‚Äîthe object that is treated as the instance‚Äîis the <code>return_value</code> of the class mock.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_database.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.database</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_report_for_user</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_report_for_user_with_mocked_class</span><span class="p">():</span>
    <span class="c1"># The target string is &#39;module_name.ClassName&#39;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;src.database.DatabaseConnector&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">MockConnector</span><span class="p">:</span>
        <span class="c1"># At this point, DatabaseConnector is a MagicMock class.</span>

        <span class="c1"># Let&#39;s configure the *instance* that will be created.</span>
        <span class="c1"># MockConnector is the mock class.</span>
        <span class="c1"># MockConnector.return_value is the mock instance.</span>
        <span class="n">mock_instance</span> <span class="o">=</span> <span class="n">MockConnector</span><span class="o">.</span><span class="n">return_value</span>
        <span class="n">mock_instance</span><span class="o">.</span><span class="n">fetch_data</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;Mocked report data&quot;</span>

        <span class="c1"># Now, call the function that uses the class.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">get_report_for_user</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

        <span class="c1"># --- Assertions ---</span>

        <span class="c1"># 1. Assert that the class was instantiated correctly.</span>
        <span class="n">MockConnector</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;postgresql://user:pass@host/db&quot;</span><span class="p">)</span>

        <span class="c1"># 2. Assert that the method on the instance was called.</span>
        <span class="n">mock_instance</span><span class="o">.</span><span class="n">fetch_data</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM reports WHERE user_id=42&quot;</span><span class="p">)</span>

        <span class="c1"># 3. Assert the final output of our function.</span>
        <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;Report: Mocked report data&quot;</span>
</code></pre></div>

<h3 id="deconstructing-the-magic">Deconstructing the Magic</h3>
<p>Let's break down the most critical and often confusing part of that test:</p>
<ol>
<li>
<p><strong><code>patch('src.database.DatabaseConnector') as MockConnector</code></strong>:</p>
<ul>
<li>Inside the <code>with</code> block, the name <code>DatabaseConnector</code> in the <code>src.database</code> module now points to our <code>MagicMock</code>, which we've called <code>MockConnector</code>.</li>
</ul>
</li>
<li>
<p><strong><code>connector = DatabaseConnector(...)</code></strong>:</p>
<ul>
<li>When <code>get_report_for_user</code> executes this line, it's not calling the real class constructor. It's calling our <code>MockConnector</code> mock.</li>
<li>This is why <code>MockConnector.assert_called_once_with(...)</code> works. We are verifying the arguments passed to the "constructor".</li>
</ul>
</li>
<li>
<p><strong><code>mock_instance = MockConnector.return_value</code></strong>:</p>
<ul>
<li>The result of calling a mock is its <code>return_value</code> attribute.</li>
<li>Therefore, the <code>connector</code> object inside our function will be whatever <code>MockConnector.return_value</code> is. By default, it's another <code>MagicMock</code>.</li>
<li>We grab a reference to this "instance mock" so we can configure its methods, like <code>fetch_data</code>.</li>
</ul>
</li>
<li>
<p><strong><code>mock_instance.fetch_data.return_value = "..."</code></strong>:</p>
<ul>
<li>We are programming the <code>fetch_data</code> method on the <em>future instance</em> to return our desired string.</li>
</ul>
</li>
<li>
<p><strong><code>connector.fetch_data(...)</code></strong>:</p>
<ul>
<li>Inside the function, this line calls the <code>fetch_data</code> method on our <code>mock_instance</code>. It returns the value we configured, and the call is recorded.</li>
<li>This is why <code>mock_instance.fetch_data.assert_called_once_with(...)</code> works.</li>
</ul>
</li>
</ol>
<p>This pattern is fundamental for isolating your code from complex dependencies. You control class instantiation, you control the instance that's created, and you control the behavior of that instance's methods.</p>
<h2 id="mocking-properties-and-attributes">Mocking Properties and Attributes</h2>
<h2 id="mocking-properties-and-attributes_1">Mocking Properties and Attributes</h2>
<p>Sometimes you don't need to mock an entire class or method, but just a single attribute or a <code>@property</code> on an object. This is useful for testing logic that branches based on an object's state.</p>
<h3 id="mocking-simple-attributes">Mocking Simple Attributes</h3>
<p>Mocking a simple data attribute is straightforward using <code>patch.object</code>. This is often done to simulate different states of an object.</p>
<p>Consider a class that checks if a user is an administrator.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/auth.py</span>

<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">is_admin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_admin</span> <span class="o">=</span> <span class="n">is_admin</span>

<span class="k">def</span><span class="w"> </span><span class="nf">perform_admin_task</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_admin</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">PermissionError</span><span class="p">(</span><span class="s2">&quot;User is not an admin&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;Admin task successful&quot;</span>
</code></pre></div>

<p>In our test, we can take a non-admin user object and temporarily make it an admin by patching the <code>is_admin</code> attribute.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_auth_attributes.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">perform_admin_task</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_perform_admin_task_for_non_admin</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_admin</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">PermissionError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;User is not an admin&quot;</span><span class="p">):</span>
        <span class="n">perform_admin_task</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_perform_admin_task_by_patching_attribute</span><span class="p">():</span>
    <span class="c1"># Start with a non-admin user</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>

    <span class="c1"># Use patch.object to temporarily change the is_admin attribute</span>
    <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;is_admin&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
        <span class="c1"># Inside this block, user.is_admin will be True</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">perform_admin_task</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;Admin task successful&quot;</span>

    <span class="c1"># Outside the block, the attribute is restored to its original value</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_admin</span>
</code></pre></div>

<p><code>patch.object(target_object, 'attribute_name', new_value)</code> is a clean, temporary way to manipulate an object's state for the duration of a test.</p>
<h3 id="mocking-property-methods">Mocking <code>@property</code> Methods</h3>
<p>Mocking a property (a method decorated with <code>@property</code>) is slightly more complex. A property looks like an attribute but is actually a method that gets executed upon access. Simply patching it with a value won't work as intended.</p>
<p>Let's add a property to our <code>User</code> class.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/auth_property.py</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserWithProperty</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="n">first_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="n">last_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_permissions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;read&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;write&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">full_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Calculating full_name...&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">permission</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permissions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">permission</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">greet_user</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">UserWithProperty</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Hello, </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">!&quot;</span>
</code></pre></div>

<p>Let's say the <code>full_name</code> property is computationally expensive, and we want to avoid running it in a test for <code>greet_user</code>. We need to replace the property with a mock that returns a fixed value. For this, we use <code>unittest.mock.PropertyMock</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_auth_property.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span><span class="p">,</span> <span class="n">PropertyMock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.auth_property</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserWithProperty</span><span class="p">,</span> <span class="n">greet_user</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_greet_user_with_mocked_property</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">UserWithProperty</span><span class="p">(</span><span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="s2">&quot;Smith&quot;</span><span class="p">)</span>

    <span class="c1"># To mock a property, we patch it on the CLASS, not the instance.</span>
    <span class="c1"># We use `new_callable=PropertyMock` to replace the property correctly.</span>
    <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">UserWithProperty</span><span class="p">,</span> <span class="s1">&#39;full_name&#39;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="n">PropertyMock</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_full_name</span><span class="p">:</span>
        <span class="c1"># Configure the return value of the mocked property</span>
        <span class="n">mock_full_name</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;Mocked Name&quot;</span>

        <span class="c1"># Now, when greet_user accesses user.full_name, it will hit our mock</span>
        <span class="c1"># instead of running the original property code.</span>
        <span class="n">greeting</span> <span class="o">=</span> <span class="n">greet_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="c1"># The original property&#39;s print statement will not be executed.</span>
        <span class="k">assert</span> <span class="n">greeting</span> <span class="o">==</span> <span class="s2">&quot;Hello, Mocked Name!&quot;</span>

        <span class="c1"># We can also assert that the property was accessed</span>
        <span class="n">mock_full_name</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
</code></pre></div>

<p>Let's break down the key line: <code>patch.object(UserWithProperty, 'full_name', new_callable=PropertyMock)</code>.</p>
<ul>
<li><strong><code>UserWithProperty</code></strong>: We patch the property on the class. This ensures that any instance of the class created within the <code>patch</code> context will use the mock.</li>
<li><strong><code>'full_name'</code></strong>: The name of the property to replace.</li>
<li><strong><code>new_callable=PropertyMock</code></strong>: This is the crucial part. It tells <code>patch</code> not to replace <code>full_name</code> with a regular <code>MagicMock</code>, but specifically with a <code>PropertyMock</code> instance. This special mock is designed to correctly emulate the behavior of a property (i.e., it can be "get", "set", or "deleted").</li>
</ul>
<p>By using this pattern, you can effectively isolate your tests from complex or slow property logic, focusing solely on the behavior of the function you are testing.</p>
<h2 id="testing-code-that-uses-external-libraries">Testing Code That Uses External Libraries</h2>
<h2 id="testing-code-that-uses-external-libraries_1">Testing Code That Uses External Libraries</h2>
<p>One of the most vital uses of mocking is to isolate your application from external libraries, especially those that perform I/O operations like network requests. This makes your tests fast, reliable, and independent of external services.</p>
<p>The popular <code>requests</code> library for making HTTP calls is a perfect candidate for this.</p>
<h3 id="the-scenario-a-github-api-client">The Scenario: A GitHub API Client</h3>
<p>Let's write a simple function that fetches the names of a user's public repositories from the GitHub API.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/github_client.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_public_repo_names</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetches a user&#39;s public repositories from GitHub and returns their names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">username</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Username must be a non-empty string&quot;</span><span class="p">)</span>

    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://api.github.com/users/</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">/repos&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>  <span class="c1"># Raises an HTTPError for bad responses (4xx or 5xx)</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">repos</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">repo</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">repo</span> <span class="ow">in</span> <span class="n">repos</span><span class="p">]</span>
</code></pre></div>

<h3 id="the-wrong-way-making-real-network-calls">The Wrong Way: Making Real Network Calls</h3>
<p>A naive test for this function might look like this. <strong>Do not do this in your actual test suite.</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_github_client_bad.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.github_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_public_repo_names</span>

<span class="c1"># This is a bad test!</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_get_public_repo_names_real_call</span><span class="p">():</span>
    <span class="c1"># 1. Slow: This test takes seconds to run due to the network call.</span>
    <span class="c1"># 2. Unreliable: It will fail if there&#39;s no internet connection or if GitHub is down.</span>
    <span class="c1"># 3. Brittle: It will fail if the &#39;pytest-dev&#39; user changes their repo names.</span>
    <span class="n">repos</span> <span class="o">=</span> <span class="n">get_public_repo_names</span><span class="p">(</span><span class="s2">&quot;pytest-dev&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s2">&quot;pytest&quot;</span> <span class="ow">in</span> <span class="n">repos</span>
</code></pre></div>

<p>This test violates the core principles of a good unit test. It's slow, dependent on external factors, and not deterministic.</p>
<h3 id="the-right-way-mocking-requestsget">The Right Way: Mocking <code>requests.get</code></h3>
<p>The correct approach is to use <code>patch</code> to intercept the call to <code>requests.get</code>. We will replace it with a mock that returns a predictable, simulated response. This allows us to test our function's logic in complete isolation.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_github_client_good.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span><span class="p">,</span> <span class="n">MagicMock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.github_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_public_repo_names</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;src.github_client.requests.get&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_get_public_repo_names_success</span><span class="p">(</span><span class="n">mock_get</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the success case where the API returns a list of repos.&quot;&quot;&quot;</span>
    <span class="c1"># 1. Arrange: Configure the mock to simulate a successful API response.</span>
    <span class="c1"># The return_value of requests.get should be a mock response object.</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;pytest&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;pytest-xdist&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;pytest-cov&quot;</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">mock_get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>

    <span class="c1"># 2. Act: Call our function.</span>
    <span class="n">repo_names</span> <span class="o">=</span> <span class="n">get_public_repo_names</span><span class="p">(</span><span class="s2">&quot;pytest-dev&quot;</span><span class="p">)</span>

    <span class="c1"># 3. Assert: Verify our function&#39;s behavior.</span>
    <span class="c1"># Check that requests.get was called with the correct URL.</span>
    <span class="n">mock_get</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;https://api.github.com/users/pytest-dev/repos&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="c1"># Check that our function correctly processed the mock JSON.</span>
    <span class="k">assert</span> <span class="n">repo_names</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;pytest&quot;</span><span class="p">,</span> <span class="s2">&quot;pytest-xdist&quot;</span><span class="p">,</span> <span class="s2">&quot;pytest-cov&quot;</span><span class="p">]</span>

<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;src.github_client.requests.get&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_get_public_repo_names_http_error</span><span class="p">(</span><span class="n">mock_get</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the case where the API returns an error status code.&quot;&quot;&quot;</span>
    <span class="c1"># 1. Arrange: Configure the mock to simulate an HTTP error.</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
    <span class="c1"># The raise_for_status method should raise an error.</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;404 Not Found&quot;</span><span class="p">)</span>
    <span class="n">mock_get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>

    <span class="c1"># 2. Act: Call our function.</span>
    <span class="n">repo_names</span> <span class="o">=</span> <span class="n">get_public_repo_names</span><span class="p">(</span><span class="s2">&quot;nonexistent-user&quot;</span><span class="p">)</span>

    <span class="c1"># 3. Assert: Verify our function handles the error gracefully.</span>
    <span class="n">mock_get</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;https://api.github.com/users/nonexistent-user/repos&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">repo_names</span> <span class="o">==</span> <span class="p">[]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_public_repo_names_invalid_input</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the input validation logic without any mocking.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Username must be a non-empty string&quot;</span><span class="p">):</span>
        <span class="n">get_public_repo_names</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="analysis-of-the-good-tests">Analysis of the Good Tests</h3>
<ol>
<li><strong><code>@patch('src.github_client.requests.get')</code></strong>: We patch <code>requests.get</code> <em>where it is used</em> (<code>src.github_client</code>), not where it is defined (<code>requests</code>). This is a critical rule of patching.</li>
<li><strong>Configuring the Mock Response</strong>: We create a <code>MagicMock</code> to act as the <code>response</code> object. We then configure its attributes and methods (<code>.status_code</code>, <code>.json()</code>, <code>.raise_for_status()</code>) to match what our code expects from a real <code>requests.Response</code> object.</li>
<li><strong>Testing Different Scenarios</strong>: We can now easily test various scenarios without relying on the real GitHub API. We can simulate success, HTTP errors, network timeouts (<code>side_effect=requests.exceptions.Timeout</code>), and more.</li>
<li><strong>Fast and Reliable</strong>: These tests run in milliseconds and will produce the same result every single time, regardless of network conditions.</li>
</ol>
<p>This pattern is applicable to any external library. Identify the boundary between your code and the library, and place your mock at that boundary.</p>
<h2 id="avoiding-over-mocking">Avoiding Over-Mocking</h2>
<h2 id="avoiding-over-mocking_1">Avoiding Over-Mocking</h2>
<p>Mocking is a powerful tool, but like any tool, it can be misused. <strong>Over-mocking</strong> is a common pitfall where tests become so tightly coupled to the implementation details of the code that they become brittle and difficult to maintain. An over-mocked test verifies <em>how</em> the code works, not <em>what</em> it achieves.</p>
<p>A good unit test should be a test of <strong>behavior</strong>, not implementation. It should validate the public contract of a function or class: given these inputs, I expect these outputs or side effects. It shouldn't care about the internal functions that were called to produce that result.</p>
<h3 id="the-smell-of-over-mocking">The Smell of Over-Mocking</h3>
<p>You might be over-mocking if your tests:
-   Break frequently when you refactor the internal implementation of a function, even though its external behavior hasn't changed.
-   Involve mocking multiple functions from your own application code within a single test.
-   Require complex setup with many <code>patch</code> decorators or context managers.
-   Test the "chain of command" (function A calls B, which calls C) rather than the final outcome.</p>
<h3 id="an-example-of-over-mocking">An Example of Over-Mocking</h3>
<p>Let's consider a system that processes a new user registration.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/registration.py</span>

<span class="k">def</span><span class="w"> </span><span class="nf">validate_email</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validates email format.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">email</span> <span class="ow">and</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">email</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_user_record</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a user record dictionary.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;pending&quot;</span><span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">send_welcome_email</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sends a welcome email (external service).&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending welcome email to </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Imagine an external API call here</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">register_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main registration function.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">validate_email</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid email format&quot;</span><span class="p">)</span>

    <span class="n">user_record</span> <span class="o">=</span> <span class="n">create_user_record</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
    <span class="c1"># In a real app, we&#39;d save this record to a database.</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User record created: </span><span class="si">{</span><span class="n">user_record</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">send_welcome_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">user_record</span>
</code></pre></div>

<p>Now, here is an <strong>over-mocked test</strong> for <code>register_user</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_registration_bad.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.registration</span><span class="w"> </span><span class="kn">import</span> <span class="n">register_user</span>

<span class="c1"># THIS IS A BAD, BRITTLE TEST</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;src.registration.send_welcome_email&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;src.registration.create_user_record&#39;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;src.registration.validate_email&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_register_user_over_mocked</span><span class="p">(</span><span class="n">mock_validate</span><span class="p">,</span> <span class="n">mock_create</span><span class="p">,</span> <span class="n">mock_send</span><span class="p">):</span>
    <span class="c1"># Arrange: Mock every internal function call</span>
    <span class="n">mock_validate</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">mock_create</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;testuser&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;test@example.com&quot;</span><span class="p">}</span>

    <span class="c1"># Act</span>
    <span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;testuser&quot;</span><span class="p">,</span> <span class="s2">&quot;test@example.com&quot;</span><span class="p">)</span>

    <span class="c1"># Assert: Verify that every single internal function was called as expected</span>
    <span class="n">mock_validate</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">)</span>
    <span class="n">mock_create</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;testuser&quot;</span><span class="p">,</span> <span class="s2">&quot;test@example.com&quot;</span><span class="p">)</span>
    <span class="n">mock_send</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Why is this test bad?</strong></p>
<p>Imagine we refactor <code>register_user</code> to combine <code>validate_email</code> and <code>create_user_record</code> into a single helper function. The external behavior of <code>register_user</code> is identical, but the test above would break because <code>validate_email</code> and <code>create_user_record</code> are no longer called directly. The test is coupled to the implementation, not the behavior.</p>
<h3 id="a-better-approach-mocking-at-the-boundaries">A Better Approach: Mocking at the Boundaries</h3>
<p>A better test mocks only the true external dependencies (the "boundaries" of your system) and tests the actual outcome. In our example, the only external dependency is <code>send_welcome_email</code>. The other functions are just implementation details of our own application.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_registration_good.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.registration</span><span class="w"> </span><span class="kn">import</span> <span class="n">register_user</span>

<span class="c1"># THIS IS A GOOD, RESILIENT TEST</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;src.registration.send_welcome_email&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_register_user_boundary_mock</span><span class="p">(</span><span class="n">mock_send_email</span><span class="p">):</span>
    <span class="c1"># Arrange: We only mock the external dependency.</span>
    <span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;testuser&quot;</span>
    <span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;test@example.com&quot;</span>

    <span class="c1"># Act: Call the function and let its internal logic run.</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">register_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>

    <span class="c1"># Assert: Verify the public contract and the external interaction.</span>
    <span class="c1"># 1. Did it return the correct data structure?</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;pending&quot;</span><span class="p">}</span>

    <span class="c1"># 2. Did it interact with the external service correctly?</span>
    <span class="n">mock_send_email</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_register_user_invalid_email</span><span class="p">():</span>
    <span class="c1"># Test the validation behavior directly. No mocking needed.</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Invalid email format&quot;</span><span class="p">):</span>
        <span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;testuser&quot;</span><span class="p">,</span> <span class="s2">&quot;invalid-email&quot;</span><span class="p">)</span>
</code></pre></div>

<p>This improved test is far more robust. We can now refactor the internals of <code>register_user</code> as much as we want. As long as it still returns the correct user record and calls the email service, the test will pass. We are testing the <em>what</em>, not the <em>how</em>.</p>
<h3 id="guidelines-for-healthy-mocking">Guidelines for Healthy Mocking</h3>
<ol>
<li><strong>Mock External Systems</strong>: Your primary targets for mocking should be systems outside your control: databases, external APIs, the file system, the clock (<code>datetime.now</code>), etc.</li>
<li><strong>Don't Mock Your Own Code (Usually)</strong>: Avoid mocking functions and classes that are part of the same application you're testing. If a helper function is complex, it should have its own dedicated unit tests. The function that calls it should use the real helper in an integration-style unit test.</li>
<li><strong>Test the Public Interface</strong>: Focus your tests on the public methods of your classes. Let the private methods be exercised via the public ones.</li>
<li><strong>One Mock Per Test is a Good Goal</strong>: If your test requires patching more than one or two things, it might be a "code smell" indicating that your function is doing too much and should be broken up (Single Responsibility Principle).</li>
</ol>
<p>Mocking is about creating seams that let you isolate the unit of code you're testing. Use it to cut ties with the outside world, not to dissect the internal organs of your own application.</p>
        </div>
        <div class="footer">
            Generated on 2025-11-22 17:25:04 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>