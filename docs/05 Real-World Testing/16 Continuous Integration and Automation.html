<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>16 Continuous Integration and Automation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">05 Real-World Testing</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-16-continuous-integration-and-automation">Chapter 16: Continuous Integration and Automation</h1>
<h2 id="running-tests-in-cicd-pipelines">Running Tests in CI/CD Pipelines</h2>
<h2 id="the-reality-of-manual-testing">The Reality of Manual Testing</h2>
<p>You've built a comprehensive test suite. Your tests pass locally. You commit your code, push to the repository, and... three days later, a teammate discovers your changes broke the production deployment. The tests still pass on your machine, but the production environment uses Python 3.11 while you develop on 3.9. A dependency version mismatch causes silent failures.</p>
<p>This is the problem Continuous Integration (CI) solves: <strong>automated, consistent test execution in a controlled environment on every code change</strong>.</p>
<h3 id="what-is-cicd">What Is CI/CD?</h3>
<p><strong>Continuous Integration (CI)</strong>: Automatically running tests every time code is pushed to a repository. The goal is to catch integration problems early, before they reach production.</p>
<p><strong>Continuous Deployment/Delivery (CD)</strong>: Automatically deploying code that passes all tests. We'll focus on the CI aspect‚Äîensuring your tests run reliably in an automated environment.</p>
<h3 id="the-reference-implementation-a-payment-processing-system">The Reference Implementation: A Payment Processing System</h3>
<p>Throughout this chapter, we'll work with a realistic payment processing system that needs to run in CI. This system will expose the real challenges of automated testing: environment differences, dependency management, test isolation, and reporting.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/payment_processor.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentGateway</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulates interaction with a payment gateway API.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">charge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">card_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a payment charge.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/charges&quot;</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">amount</span><span class="p">),</span>
                <span class="s2">&quot;card_token&quot;</span><span class="p">:</span> <span class="n">card_token</span><span class="p">,</span>
                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span>
            <span class="p">},</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Business logic for processing payments.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gateway</span><span class="p">:</span> <span class="n">PaymentGateway</span><span class="p">,</span> <span class="n">min_amount</span><span class="p">:</span> <span class="n">Decimal</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.50&quot;</span><span class="p">)):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gateway</span> <span class="o">=</span> <span class="n">gateway</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_amount</span> <span class="o">=</span> <span class="n">min_amount</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">card_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process a payment with validation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict with keys: success (bool), transaction_id (str), message (str)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_amount</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Amount must be at least </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min_amount</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">card_token</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Payment processed successfully&quot;</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Payment gateway error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_processor_from_env</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">PaymentProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory function that reads configuration from environment.&quot;&quot;&quot;</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PAYMENT_API_KEY&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;PAYMENT_API_KEY environment variable not set&quot;</span><span class="p">)</span>

    <span class="n">base_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PAYMENT_API_URL&quot;</span><span class="p">,</span> <span class="s2">&quot;https://api.payment-gateway.example.com&quot;</span><span class="p">)</span>

    <span class="n">gateway</span> <span class="o">=</span> <span class="n">PaymentGateway</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="n">base_url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">gateway</span><span class="p">)</span>
</code></pre></div>

<h3 id="initial-test-suite">Initial Test Suite</h3>
<p>Our test suite uses mocking to avoid real API calls and fixtures for test data:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_payment_processor.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentProcessor</span><span class="p">,</span> <span class="n">PaymentGateway</span><span class="p">,</span> <span class="n">create_processor_from_env</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a mock payment gateway.&quot;&quot;&quot;</span>
    <span class="n">gateway</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">PaymentGateway</span><span class="p">)</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;succeeded&quot;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">gateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">processor</span><span class="p">(</span><span class="n">mock_gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a payment processor with mocked gateway.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">mock_gateway</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_successful_payment</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">mock_gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test processing a valid payment.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.00&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;txn_12345&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;successfully&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>

    <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.00&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_below_minimum</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">mock_gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test payment amount below minimum threshold.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.25&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="s2">&quot;at least&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>

    <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_gateway_error_handling</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">mock_gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test handling of gateway API errors.&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
    <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span><span class="p">(</span><span class="s2">&quot;Network timeout&quot;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.00&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="s2">&quot;gateway error&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>

<span class="nd">@patch</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="s2">&quot;os.environ&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;PAYMENT_API_KEY&quot;</span><span class="p">:</span> <span class="s2">&quot;test_key_123&quot;</span><span class="p">})</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_factory_creates_processor</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test factory function reads from environment.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">create_processor_from_env</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">processor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">processor</span><span class="o">.</span><span class="n">gateway</span><span class="o">.</span><span class="n">api_key</span> <span class="o">==</span> <span class="s2">&quot;test_key_123&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_factory_requires_api_key</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test factory fails without API key.&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
    <span class="c1"># Ensure key is not set</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;PAYMENT_API_KEY&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;PAYMENT_API_KEY&quot;</span><span class="p">):</span>
        <span class="n">create_processor_from_env</span><span class="p">()</span>
</code></pre></div>

<h3 id="running-tests-locally">Running Tests Locally</h3>
<p>On your development machine, these tests pass:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_payment_processor.py<span class="w"> </span>-v
<span class="o">========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">=========================</span>
collected<span class="w"> </span><span class="m">5</span><span class="w"> </span>items

tests/test_payment_processor.py::test_successful_payment<span class="w"> </span>PASSED<span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">20</span>%<span class="o">]</span>
tests/test_payment_processor.py::test_payment_below_minimum<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">40</span>%<span class="o">]</span>
tests/test_payment_processor.py::test_gateway_error_handling<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">60</span>%<span class="o">]</span>
tests/test_payment_processor.py::test_factory_creates_processor<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">80</span>%<span class="o">]</span>
tests/test_payment_processor.py::test_factory_requires_api_key<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">=========================</span><span class="w"> </span><span class="m">5</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.12s<span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<h2 id="the-problem-local-success-ci-failure">The Problem: Local Success, CI Failure</h2>
<p>You commit this code and push to your repository. Your CI system runs the tests and reports:</p>
<p><strong>CI Build #47 - FAILED</strong></p>
<p>Let's examine what went wrong and why CI environments expose problems that local testing misses.</p>
<h3 id="iteration-1-the-first-ci-failure">Iteration 1: The First CI Failure</h3>
<p>Your CI system attempts to run the tests:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># CI Log Output</span>
Step<span class="w"> </span><span class="m">1</span>/5:<span class="w"> </span>Checkout<span class="w"> </span>code
‚úì<span class="w"> </span>Repository<span class="w"> </span>cloned<span class="w"> </span>successfully

Step<span class="w"> </span><span class="m">2</span>/5:<span class="w"> </span>Set<span class="w"> </span>up<span class="w"> </span>Python
‚úì<span class="w"> </span>Python<span class="w"> </span><span class="m">3</span>.11.2<span class="w"> </span>installed

Step<span class="w"> </span><span class="m">3</span>/5:<span class="w"> </span>Install<span class="w"> </span>dependencies
ERROR:<span class="w"> </span>Could<span class="w"> </span>not<span class="w"> </span>find<span class="w"> </span>a<span class="w"> </span>version<span class="w"> </span>that<span class="w"> </span>satisfies<span class="w"> </span>the<span class="w"> </span>requirement<span class="w"> </span>requests
ERROR:<span class="w"> </span>No<span class="w"> </span>matching<span class="w"> </span>distribution<span class="w"> </span>found<span class="w"> </span><span class="k">for</span><span class="w"> </span>requests

Build<span class="w"> </span>failed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">23</span><span class="w"> </span>seconds
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-ci-failure">Diagnostic Analysis: Reading the CI Failure</h3>
<p><strong>The complete output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">ERROR</span><span class="o">:</span><span class="w"> </span><span class="n">Could</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">satisfies</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">requirement</span><span class="w"> </span><span class="n">requests</span>
<span class="n">ERROR</span><span class="o">:</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">matching</span><span class="w"> </span><span class="n">distribution</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">requests</span>
</code></pre></div>

<p><strong>Let's parse this section by section</strong>:</p>
<ol>
<li><strong>The error type</strong>: <code>ERROR: Could not find a version</code></li>
<li>What this tells us: The dependency installation step failed</li>
<li>
<p>This happens before tests even run</p>
</li>
<li>
<p><strong>The missing component</strong>: <code>requirement requests</code></p>
</li>
<li>What this tells us: The <code>requests</code> library isn't being installed</li>
<li>
<p>Our code imports <code>requests</code>, so tests will fail without it</p>
</li>
<li>
<p><strong>Why this worked locally</strong>:</p>
</li>
<li>On your machine: <code>requests</code> was already installed (probably for another project)</li>
<li>In CI: Fresh environment every time, nothing pre-installed</li>
</ol>
<p><strong>Root cause identified</strong>: No dependency specification file</p>
<p><strong>Why the current approach can't solve this</strong>: CI environments start from a clean slate. They don't have your local packages.</p>
<p><strong>What we need</strong>: A <code>requirements.txt</code> file that explicitly lists all dependencies.</p>
<h3 id="solution-explicit-dependency-declaration">Solution: Explicit Dependency Declaration</h3>
<p>Create a requirements file that CI can use:</p>
<div class="codehilite"><pre><span></span><code># requirements.txt
requests==2.31.0
pytest==7.4.3
</code></pre></div>

<p>Now CI can install dependencies before running tests. But we need to tell CI <em>how</em> to use this file.</p>
<h3 id="the-minimal-ci-configuration">The Minimal CI Configuration</h3>
<p>Every CI system needs instructions. Here's the conceptual structure (we'll see specific implementations in later sections):</p>
<p><strong>What CI needs to know</strong>:
1. What programming language/runtime to use
2. How to install dependencies
3. How to run the tests
4. What constitutes success vs. failure</p>
<p><strong>Generic CI workflow</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">Provision</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">clean</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="p">(</span><span class="kr">cont</span><span class="n">ainer</span><span class="o">/</span><span class="n">VM</span><span class="p">)</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">repository</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">Install</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">specified</span><span class="w"> </span><span class="n">Python</span><span class="w"> </span><span class="n">version</span>
<span class="mf">4.</span><span class="w"> </span><span class="n">Install</span><span class="w"> </span><span class="n">dependencies</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">requirements</span><span class="mf">.</span><span class="n">txt</span>
<span class="mf">5.</span><span class="w"> </span><span class="kr">Run</span><span class="w"> </span><span class="n">pytest</span>
<span class="mf">6.</span><span class="w"> </span><span class="n">Report</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="p">(</span><span class="n">exit</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">success</span><span class="p">,</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">zero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">failure</span><span class="p">)</span>
</code></pre></div>

<p>Let's see this in a simple shell script form to understand the mechanics:</p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># ci_test.sh - What CI systems do under the hood</span>

<span class="nb">set</span><span class="w"> </span>-e<span class="w">  </span><span class="c1"># Exit on any error</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Step 1: Environment info&quot;</span>
python<span class="w"> </span>--version
pip<span class="w"> </span>--version

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Step 2: Install dependencies&quot;</span>
pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Step 3: Run tests&quot;</span>
pytest<span class="w"> </span>tests/<span class="w"> </span>-v

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Step 4: Success!&quot;</span>
<span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
</code></pre></div>

<p>If you run this script locally, it simulates what CI does:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>chmod<span class="w"> </span>+x<span class="w"> </span>ci_test.sh
$<span class="w"> </span>./ci_test.sh
Step<span class="w"> </span><span class="m">1</span>:<span class="w"> </span>Environment<span class="w"> </span>info
Python<span class="w"> </span><span class="m">3</span>.11.2
pip<span class="w"> </span><span class="m">23</span>.0.1

Step<span class="w"> </span><span class="m">2</span>:<span class="w"> </span>Install<span class="w"> </span>dependencies
Collecting<span class="w"> </span><span class="nv">requests</span><span class="o">==</span><span class="m">2</span>.31.0
<span class="w">  </span>Using<span class="w"> </span>cached<span class="w"> </span>requests-2.31.0-py3-none-any.whl<span class="w"> </span><span class="o">(</span><span class="m">62</span><span class="w"> </span>kB<span class="o">)</span>
Collecting<span class="w"> </span><span class="nv">pytest</span><span class="o">==</span><span class="m">7</span>.4.3
<span class="w">  </span>Using<span class="w"> </span>cached<span class="w"> </span>pytest-7.4.3-py3-none-any.whl<span class="w"> </span><span class="o">(</span><span class="m">325</span><span class="w"> </span>kB<span class="o">)</span>
Installing<span class="w"> </span>collected<span class="w"> </span>packages:<span class="w"> </span>requests,<span class="w"> </span>pytest
Successfully<span class="w"> </span>installed<span class="w"> </span>pytest-7.4.3<span class="w"> </span>requests-2.31.0

Step<span class="w"> </span><span class="m">3</span>:<span class="w"> </span>Run<span class="w"> </span><span class="nv">tests</span>
<span class="o">========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">=========================</span>
collected<span class="w"> </span><span class="m">5</span><span class="w"> </span>items

tests/test_payment_processor.py::test_successful_payment<span class="w"> </span>PASSED<span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">20</span>%<span class="o">]</span>
tests/test_payment_processor.py::test_payment_below_minimum<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">40</span>%<span class="o">]</span>
tests/test_payment_processor.py::test_gateway_error_handling<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">60</span>%<span class="o">]</span>
tests/test_payment_processor.py::test_factory_creates_processor<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">80</span>%<span class="o">]</span>
tests/test_payment_processor.py::test_factory_requires_api_key<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">=========================</span><span class="w"> </span><span class="m">5</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.12s<span class="w"> </span><span class="o">==========================</span>

Step<span class="w"> </span><span class="m">4</span>:<span class="w"> </span>Success!
</code></pre></div>

<h3 id="iteration-2-environment-variable-isolation">Iteration 2: Environment Variable Isolation</h3>
<p>With dependencies fixed, CI runs again. This time, a different failure:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># CI Log Output</span>
Step<span class="w"> </span><span class="m">3</span>/5:<span class="w"> </span>Run<span class="w"> </span><span class="nv">tests</span>
<span class="o">========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">=========================</span>
collected<span class="w"> </span><span class="m">5</span><span class="w"> </span>items

tests/test_payment_processor.py::test_successful_payment<span class="w"> </span>PASSED<span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">20</span>%<span class="o">]</span>
tests/test_payment_processor.py::test_payment_below_minimum<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">40</span>%<span class="o">]</span>
tests/test_payment_processor.py::test_gateway_error_handling<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">60</span>%<span class="o">]</span>
tests/test_payment_processor.py::test_factory_creates_processor<span class="w"> </span>FAILED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">80</span>%<span class="o">]</span>
tests/test_payment_processor.py::test_factory_requires_api_key<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">==============================</span><span class="w"> </span><span class="nv">FAILURES</span><span class="w"> </span><span class="o">==============================</span>
______________<span class="w"> </span>test_factory_creates_processor<span class="w"> </span>_______________

<span class="w">    </span>@patch.dict<span class="o">(</span><span class="s2">&quot;os.environ&quot;</span>,<span class="w"> </span><span class="o">{</span><span class="s2">&quot;PAYMENT_API_KEY&quot;</span>:<span class="w"> </span><span class="s2">&quot;test_key_123&quot;</span><span class="o">})</span>
<span class="w">    </span>def<span class="w"> </span>test_factory_creates_processor<span class="o">()</span>:
<span class="w">        </span><span class="s2">&quot;&quot;&quot;Test factory function reads from environment.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="nv">processor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>create_processor_from_env<span class="o">()</span>
<span class="w">        </span>assert<span class="w"> </span>processor<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>None
&gt;<span class="w">       </span>assert<span class="w"> </span>processor.gateway.api_key<span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;test_key_123&quot;</span>
E<span class="w">       </span>AssertionError:<span class="w"> </span>assert<span class="w"> </span><span class="s1">&#39;sk_live_abc123&#39;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;test_key_123&#39;</span>
E<span class="w">         </span>-<span class="w"> </span>test_key_123
E<span class="w">         </span>+<span class="w"> </span>sk_live_abc123

tests/test_payment_processor.py:58:<span class="w"> </span><span class="nv">AssertionError</span>
<span class="o">=====================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>failed,<span class="w"> </span><span class="m">4</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.15s<span class="w"> </span><span class="o">====================</span>
</code></pre></div>

<h3 id="diagnostic-analysis-environment-pollution">Diagnostic Analysis: Environment Pollution</h3>
<p><strong>The complete output</strong>:</p>
<div class="codehilite"><pre><span></span><code>E       AssertionError: assert &#39;sk_live_abc123&#39; == &#39;test_key_123&#39;
E         - test_key_123
E         + sk_live_abc123
</code></pre></div>

<p><strong>Let's parse this section by section</strong>:</p>
<ol>
<li><strong>The test that failed</strong>: <code>test_factory_creates_processor</code></li>
<li>
<p>What this tells us: The test that uses <code>@patch.dict</code> to set environment variables</p>
</li>
<li>
<p><strong>The assertion introspection</strong>:
   <code>assert 'sk_live_abc123' == 'test_key_123'</code></p>
</li>
<li>What this tells us: The API key is <code>sk_live_abc123</code> instead of our test value</li>
<li>
<p>That looks like a real production API key!</p>
</li>
<li>
<p><strong>Why this happened</strong>:</p>
</li>
<li>Someone set <code>PAYMENT_API_KEY=sk_live_abc123</code> in the CI environment</li>
<li><code>@patch.dict</code> adds to the environment but doesn't clear existing values</li>
<li>The real key takes precedence over our test key</li>
</ol>
<p><strong>Root cause identified</strong>: Environment variables from CI configuration leak into tests</p>
<p><strong>Why the current approach can't solve this</strong>: <code>@patch.dict</code> with a single key doesn't isolate the test from pre-existing environment variables.</p>
<p><strong>What we need</strong>: Complete environment isolation for tests that depend on environment variables.</p>
<h3 id="solution-proper-environment-isolation">Solution: Proper Environment Isolation</h3>
<p>We need to ensure tests run in a clean environment state:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_payment_processor.py (updated)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentProcessor</span><span class="p">,</span> <span class="n">PaymentGateway</span><span class="p">,</span> <span class="n">create_processor_from_env</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">clean_environment</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure clean environment for tests that use environment variables.&quot;&quot;&quot;</span>
    <span class="c1"># Save original environment</span>
    <span class="n">original_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Clear payment-related variables</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;PAYMENT_&quot;</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">yield</span>

    <span class="c1"># Restore original environment</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">original_env</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a mock payment gateway.&quot;&quot;&quot;</span>
    <span class="n">gateway</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">PaymentGateway</span><span class="p">)</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;succeeded&quot;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">gateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">processor</span><span class="p">(</span><span class="n">mock_gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a payment processor with mocked gateway.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">mock_gateway</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_successful_payment</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">mock_gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test processing a valid payment.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.00&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;txn_12345&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;successfully&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>

    <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.00&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_below_minimum</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">mock_gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test payment amount below minimum threshold.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.25&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="s2">&quot;at least&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>

    <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_gateway_error_handling</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">mock_gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test handling of gateway API errors.&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
    <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span><span class="p">(</span><span class="s2">&quot;Network timeout&quot;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.00&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="s2">&quot;gateway error&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_factory_creates_processor</span><span class="p">(</span><span class="n">clean_environment</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test factory function reads from environment.&quot;&quot;&quot;</span>
    <span class="c1"># Now we explicitly set ONLY what we want</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PAYMENT_API_KEY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;test_key_123&quot;</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">create_processor_from_env</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">processor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">processor</span><span class="o">.</span><span class="n">gateway</span><span class="o">.</span><span class="n">api_key</span> <span class="o">==</span> <span class="s2">&quot;test_key_123&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_factory_requires_api_key</span><span class="p">(</span><span class="n">clean_environment</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test factory fails without API key.&quot;&quot;&quot;</span>
    <span class="c1"># clean_environment ensures no PAYMENT_API_KEY exists</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;PAYMENT_API_KEY&quot;</span><span class="p">):</span>
        <span class="n">create_processor_from_env</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_factory_uses_custom_url</span><span class="p">(</span><span class="n">clean_environment</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test factory respects custom API URL.&quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PAYMENT_API_KEY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;test_key_123&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PAYMENT_API_URL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;https://test.example.com&quot;</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">create_processor_from_env</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">processor</span><span class="o">.</span><span class="n">gateway</span><span class="o">.</span><span class="n">base_url</span> <span class="o">==</span> <span class="s2">&quot;https://test.example.com&quot;</span>
</code></pre></div>

<h3 id="verification-tests-now-pass-in-ci">Verification: Tests Now Pass in CI</h3>
<p>With proper environment isolation:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_payment_processor.py<span class="w"> </span>-v
<span class="o">========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">=========================</span>
collected<span class="w"> </span><span class="m">6</span><span class="w"> </span>items

tests/test_payment_processor.py::test_successful_payment<span class="w"> </span>PASSED<span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">16</span>%<span class="o">]</span>
tests/test_payment_processor.py::test_payment_below_minimum<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">33</span>%<span class="o">]</span>
tests/test_payment_processor.py::test_gateway_error_handling<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">50</span>%<span class="o">]</span>
tests/test_payment_processor.py::test_factory_creates_processor<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">66</span>%<span class="o">]</span>
tests/test_payment_processor.py::test_factory_requires_api_key<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">83</span>%<span class="o">]</span>
tests/test_payment_processor.py::test_factory_uses_custom_url<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">=========================</span><span class="w"> </span><span class="m">6</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.14s<span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<h2 id="key-principles-for-ci-ready-tests">Key Principles for CI-Ready Tests</h2>
<h3 id="1-explicit-dependencies">1. Explicit Dependencies</h3>
<p><strong>Problem</strong>: "Works on my machine" because you have packages installed globally.</p>
<p><strong>Solution</strong>: <code>requirements.txt</code> or <code>pyproject.toml</code> with pinned versions.</p>
<h3 id="2-environment-isolation">2. Environment Isolation</h3>
<p><strong>Problem</strong>: Tests pass locally but fail in CI due to environment variable pollution.</p>
<p><strong>Solution</strong>: Fixtures that clean and restore environment state.</p>
<h3 id="3-no-external-dependencies">3. No External Dependencies</h3>
<p><strong>Problem</strong>: Tests that make real HTTP requests fail when CI has no internet access or rate limits.</p>
<p><strong>Solution</strong>: Mock external services (as we did with <code>mock_gateway</code>).</p>
<h3 id="4-deterministic-behavior">4. Deterministic Behavior</h3>
<p><strong>Problem</strong>: Tests that depend on current time, random values, or external state are flaky.</p>
<p><strong>Solution</strong>: Inject dependencies, use fixed seeds, mock time-dependent functions.</p>
<h3 id="5-fast-execution">5. Fast Execution</h3>
<p><strong>Problem</strong>: Slow tests delay feedback and waste CI resources.</p>
<p><strong>Solution</strong>: Use mocks instead of real I/O, parallelize tests, optimize fixtures.</p>
<h3 id="the-ci-mindset">The CI Mindset</h3>
<p>When writing tests, always ask:</p>
<ul>
<li><strong>Will this work in a fresh environment?</strong> (No pre-installed packages)</li>
<li><strong>Will this work without my local configuration?</strong> (No .env files, no global settings)</li>
<li><strong>Will this work in parallel?</strong> (No shared state between tests)</li>
<li><strong>Will this work 100 times in a row?</strong> (No flaky timing dependencies)</li>
</ul>
<p>These questions guide you toward tests that are reliable in automation.</p>
<h2 id="github-actions-for-python-testing">GitHub Actions for Python Testing</h2>
<h2 id="github-actions-ci-in-your-repository">GitHub Actions: CI in Your Repository</h2>
<p>GitHub Actions is a CI/CD platform built into GitHub. It runs workflows defined in YAML files stored in your repository. When you push code or open a pull request, GitHub automatically runs your tests.</p>
<h3 id="why-github-actions">Why GitHub Actions?</h3>
<ul>
<li><strong>Zero setup</strong>: No external service to configure</li>
<li><strong>Free for public repositories</strong>: Generous free tier for private repos</li>
<li><strong>Matrix testing</strong>: Test across multiple Python versions simultaneously</li>
<li><strong>Rich ecosystem</strong>: Thousands of pre-built actions for common tasks</li>
</ul>
<h3 id="the-workflow-file-structure">The Workflow File Structure</h3>
<p>GitHub Actions workflows live in <code>.github/workflows/</code> in your repository. Let's build one step by step.</p>
<h3 id="iteration-1-the-minimal-workflow">Iteration 1: The Minimal Workflow</h3>
<p>Create the workflow file:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .github/workflows/test.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Tests</span>

<span class="nt">on</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">push</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">pull_request</span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">test</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set up Python</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-python@v4</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.11&#39;</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pip install -r requirements.txt</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pytest tests/ -v</span>
</code></pre></div>

<h3 id="understanding-the-workflow-anatomy">Understanding the Workflow Anatomy</h3>
<p>Let's parse each section:</p>
<p><strong><code>name: Tests</code></strong>: The workflow name shown in GitHub's UI.</p>
<p><strong><code>on: [push, pull_request]</code></strong>: When to run this workflow.
- <code>push</code>: Every time code is pushed to any branch
- <code>pull_request</code>: When a PR is opened or updated</p>
<p><strong><code>jobs:</code></strong>: A workflow contains one or more jobs. Jobs run in parallel by default.</p>
<p><strong><code>runs-on: ubuntu-latest</code></strong>: The operating system for the job. Options:
- <code>ubuntu-latest</code>: Linux (most common for Python)
- <code>windows-latest</code>: Windows
- <code>macos-latest</code>: macOS</p>
<p><strong><code>steps:</code></strong>: Sequential tasks within a job.</p>
<p><strong><code>uses: actions/checkout@v4</code></strong>: A pre-built action that clones your repository.</p>
<p><strong><code>uses: actions/setup-python@v4</code></strong>: Installs Python. The <code>with:</code> section specifies version.</p>
<p><strong><code>run: |</code></strong>: Executes shell commands. The <code>|</code> allows multi-line scripts.</p>
<h3 id="seeing-it-in-action">Seeing It in Action</h3>
<p>Commit this file and push:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.github/workflows/test.yml
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Add GitHub Actions workflow&quot;</span>
$<span class="w"> </span>git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>main
</code></pre></div>

<p>GitHub automatically detects the workflow and runs it. You can watch the progress:</p>
<ol>
<li>Go to your repository on GitHub</li>
<li>Click the "Actions" tab</li>
<li>See your workflow running in real-time</li>
</ol>
<p>The output looks like this:</p>
<div class="codehilite"><pre><span></span><code>Run actions/checkout@v4
Syncing repository: owner/repo
Fetching the repository
‚úì Repository cloned

Run actions/setup-python@v4
Setup Python 3.11.2
‚úì Python installed

Run pip install -r requirements.txt
Collecting requests==2.31.0
Collecting pytest==7.4.3
‚úì Dependencies installed

Run pytest tests/ -v
======================== test session starts =========================
collected 6 items

tests/test_payment_processor.py::test_successful_payment PASSED  [ 16%]
tests/test_payment_processor.py::test_payment_below_minimum PASSED [ 33%]
tests/test_payment_processor.py::test_gateway_error_handling PASSED [ 50%]
tests/test_payment_processor.py::test_factory_creates_processor PASSED [ 66%]
tests/test_payment_processor.py::test_factory_requires_api_key PASSED [ 83%]
tests/test_payment_processor.py::test_factory_uses_custom_url PASSED [100%]

========================= 6 passed in 0.14s ==========================
‚úì Tests passed
</code></pre></div>

<h3 id="iteration-2-testing-multiple-python-versions">Iteration 2: Testing Multiple Python Versions</h3>
<p>Your users might run Python 3.9, 3.10, 3.11, or 3.12. You should test all of them. GitHub Actions makes this trivial with <strong>matrix strategy</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .github/workflows/test.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Tests</span>

<span class="nt">on</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">push</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">pull_request</span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">test</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">strategy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">matrix</span><span class="p">:</span>
<span class="w">        </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;3.9&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;3.10&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;3.11&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;3.12&#39;</span><span class="p p-Indicator">]</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set up Python ${{ matrix.python-version }}</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-python@v4</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.python-version }}</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pip install -r requirements.txt</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pytest tests/ -v</span>
</code></pre></div>

<h3 id="understanding-matrix-strategy">Understanding Matrix Strategy</h3>
<p><strong><code>strategy: matrix:</code></strong>: Defines variables that create multiple job instances.</p>
<p><strong><code>python-version: ['3.9', '3.10', '3.11', '3.12']</code></strong>: Creates 4 parallel jobs, one for each Python version.</p>
<p><strong><code>${{ matrix.python-version }}</code></strong>: Template syntax that inserts the current matrix value.</p>
<p>When you push this change, GitHub runs <strong>4 jobs in parallel</strong>:</p>
<div class="codehilite"><pre><span></span><code>‚úì test (3.9)  - 6 passed in 0.14s
‚úì test (3.10) - 6 passed in 0.13s
‚úì test (3.11) - 6 passed in 0.14s
‚úì test (3.12) - 6 passed in 0.15s
</code></pre></div>

<p>If any version fails, you see exactly which one:</p>
<div class="codehilite"><pre><span></span><code>‚úì test (3.9)  - 6 passed
‚úì test (3.10) - 6 passed
‚úó test (3.11) - 5 passed, 1 failed
‚úì test (3.12) - 6 passed
</code></pre></div>

<h3 id="iteration-3-caching-dependencies">Iteration 3: Caching Dependencies</h3>
<p>Installing dependencies on every run is slow. GitHub Actions can cache them:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .github/workflows/test.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Tests</span>

<span class="nt">on</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">push</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">pull_request</span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">test</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">strategy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">matrix</span><span class="p">:</span>
<span class="w">        </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;3.9&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;3.10&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;3.11&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;3.12&#39;</span><span class="p p-Indicator">]</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set up Python ${{ matrix.python-version }}</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-python@v4</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.python-version }}</span>
<span class="w">          </span><span class="nt">cache</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;pip&#39;</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pip install -r requirements.txt</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pytest tests/ -v</span>
</code></pre></div>

<p><strong><code>cache: 'pip'</code></strong>: Automatically caches pip packages based on <code>requirements.txt</code> hash.</p>
<p><strong>First run</strong>: Downloads and caches dependencies (slow).
<strong>Subsequent runs</strong>: Restores from cache (fast).</p>
<p>The output shows the cache in action:</p>
<div class="codehilite"><pre><span></span><code>Run actions/setup-python@v4
Setup Python 3.11.2
Cache restored from key: setup-python-Linux-pip-abc123...
‚úì Python installed with cached dependencies

Run pip install -r requirements.txt
Requirement already satisfied: requests==2.31.0
Requirement already satisfied: pytest==7.4.3
‚úì Dependencies installed (0.3s instead of 12s)
</code></pre></div>

<h3 id="iteration-4-adding-code-coverage">Iteration 4: Adding Code Coverage</h3>
<p>Let's integrate coverage reporting into CI:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .github/workflows/test.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Tests</span>

<span class="nt">on</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">push</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">pull_request</span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">test</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">strategy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">matrix</span><span class="p">:</span>
<span class="w">        </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;3.9&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;3.10&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;3.11&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;3.12&#39;</span><span class="p p-Indicator">]</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set up Python ${{ matrix.python-version }}</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-python@v4</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.python-version }}</span>
<span class="w">          </span><span class="nt">cache</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;pip&#39;</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pip install -r requirements.txt</span>
<span class="w">          </span><span class="no">pip install pytest-cov</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests with coverage</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pytest tests/ --cov=src --cov-report=xml --cov-report=term</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload coverage to Codecov</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">codecov/codecov-action@v3</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./coverage.xml</span>
<span class="w">          </span><span class="nt">flags</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unittests</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">codecov-${{ matrix.python-version }}</span>
</code></pre></div>

<p><strong>New additions</strong>:</p>
<ul>
<li><code>pip install pytest-cov</code>: Adds coverage plugin</li>
<li><code>--cov=src</code>: Measure coverage of the <code>src/</code> directory</li>
<li><code>--cov-report=xml</code>: Generate XML report for Codecov</li>
<li><code>--cov-report=term</code>: Show coverage in terminal output</li>
<li><code>codecov/codecov-action@v3</code>: Uploads coverage to Codecov.io (free for open source)</li>
</ul>
<p>The output now includes coverage:</p>
<div class="codehilite"><pre><span></span><code>Run pytest tests/ --cov=src --cov-report=xml --cov-report=term
======================== test session starts =========================
collected 6 items

tests/test_payment_processor.py::test_successful_payment PASSED  [ 16%]
tests/test_payment_processor.py::test_payment_below_minimum PASSED [ 33%]
tests/test_payment_processor.py::test_gateway_error_handling PASSED [ 50%]
tests/test_payment_processor.py::test_factory_creates_processor PASSED [ 66%]
tests/test_payment_processor.py::test_factory_requires_api_key PASSED [ 83%]
tests/test_payment_processor.py::test_factory_uses_custom_url PASSED [100%]

---------- coverage: platform linux, python 3.11.2 -----------
Name                            Stmts   Miss  Cover
---------------------------------------------------
src/payment_processor.py           45      2    96%
---------------------------------------------------
TOTAL                              45      2    96%

========================= 6 passed in 0.18s ==========================

Run codecov/codecov-action@v3
‚úì Coverage uploaded to Codecov
</code></pre></div>

<h3 id="iteration-5-failing-fast-and-providing-feedback">Iteration 5: Failing Fast and Providing Feedback</h3>
<p>When tests fail, you want immediate feedback. Let's add failure handling:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .github/workflows/test.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Tests</span>

<span class="nt">on</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">push</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">pull_request</span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">test</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">strategy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">matrix</span><span class="p">:</span>
<span class="w">        </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;3.9&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;3.10&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;3.11&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;3.12&#39;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">fail-fast</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set up Python ${{ matrix.python-version }}</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-python@v4</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.python-version }}</span>
<span class="w">          </span><span class="nt">cache</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;pip&#39;</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pip install -r requirements.txt</span>
<span class="w">          </span><span class="no">pip install pytest-cov</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests with coverage</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pytest tests/ --cov=src --cov-report=xml --cov-report=term -v</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload coverage to Codecov</span>
<span class="w">        </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix.python-version == &#39;3.11&#39;</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">codecov/codecov-action@v3</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./coverage.xml</span>
<span class="w">          </span><span class="nt">flags</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unittests</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">codecov-umbrella</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload test results</span>
<span class="w">        </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always()</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/upload-artifact@v3</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-results-${{ matrix.python-version }}</span>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">            </span><span class="no">coverage.xml</span>
<span class="w">            </span><span class="no">.coverage</span>
</code></pre></div>

<p><strong>New additions</strong>:</p>
<p><strong><code>fail-fast: false</code></strong>: Don't cancel other matrix jobs when one fails. This lets you see which Python versions pass and which fail.</p>
<p><strong><code>if: matrix.python-version == '3.11'</code></strong>: Only upload coverage once (from Python 3.11) instead of 4 times.</p>
<p><strong><code>if: always()</code></strong>: Run this step even if tests fail. Useful for uploading test artifacts.</p>
<p><strong><code>actions/upload-artifact@v3</code></strong>: Saves files from the workflow. You can download them later to debug failures.</p>
<h3 id="when-tests-fail-in-ci">When Tests Fail in CI</h3>
<p>Let's simulate a failure. Suppose we introduce a bug:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/payment_processor.py (with bug)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">card_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process a payment with validation.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_amount</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Amount must be at least </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min_amount</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">card_token</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Payment processed successfully&quot;</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># BUG: Forgot to return here!</span>
        <span class="k">pass</span>
</code></pre></div>

<p>GitHub Actions shows the failure clearly:</p>
<div class="codehilite"><pre><span></span><code>Run pytest tests/ --cov=src --cov-report=xml --cov-report=term -v
======================== test session starts =========================
collected 6 items

tests/test_payment_processor.py::test_successful_payment PASSED  [ 16%]
tests/test_payment_processor.py::test_payment_below_minimum PASSED [ 33%]
tests/test_payment_processor.py::test_gateway_error_handling FAILED [ 50%]

============================== FAILURES ==============================
______________ test_gateway_error_handling _______________

processor = &lt;src.payment_processor.PaymentProcessor object at 0x7f8b3c&gt;
mock_gateway = &lt;Mock spec=&#39;PaymentGateway&#39; id=&#39;140234567890&#39;&gt;

    def test_gateway_error_handling(processor, mock_gateway):
        &quot;&quot;&quot;Test handling of gateway API errors.&quot;&quot;&quot;
        import requests
        mock_gateway.charge.side_effect = requests.RequestException(&quot;Network timeout&quot;)

        result = processor.process_payment(Decimal(&quot;10.00&quot;), &quot;card_tok_visa&quot;)

        assert result[&quot;success&quot;] is False
&gt;       assert result[&quot;transaction_id&quot;] is None
E       TypeError: &#39;NoneType&#39; object is not subscriptable

tests/test_payment_processor.py:48: TypeError
===================== 1 failed, 5 passed in 0.15s ====================

Error: Process completed with exit code 1.
</code></pre></div>

<p>The workflow fails, and GitHub:</p>
<ol>
<li><strong>Marks the commit with a red X</strong> in the commit history</li>
<li><strong>Blocks PR merging</strong> if you've configured branch protection</li>
<li><strong>Sends notifications</strong> to the commit author</li>
<li><strong>Shows the exact failure</strong> in the Actions tab</li>
</ol>
<p>You can click through to see the full output, download artifacts, and debug.</p>
<h3 id="the-complete-production-workflow">The Complete Production Workflow</h3>
<p>Here's a full-featured workflow for a production project:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .github/workflows/test.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Tests</span>

<span class="nt">on</span><span class="p">:</span>
<span class="w">  </span><span class="nt">push</span><span class="p">:</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">develop</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">pull_request</span><span class="p">:</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">develop</span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">test</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.os }}</span>
<span class="w">    </span><span class="nt">strategy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">fail-fast</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">      </span><span class="nt">matrix</span><span class="p">:</span>
<span class="w">        </span><span class="nt">os</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">ubuntu-latest</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">windows-latest</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">macos-latest</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;3.9&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;3.10&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;3.11&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;3.12&#39;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">exclude</span><span class="p">:</span>
<span class="w">          </span><span class="c1"># Skip some combinations to save CI time</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">os</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">windows-latest</span>
<span class="w">            </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.9&#39;</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">os</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">macos-latest</span>
<span class="w">            </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.9&#39;</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set up Python ${{ matrix.python-version }}</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-python@v4</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.python-version }}</span>
<span class="w">          </span><span class="nt">cache</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;pip&#39;</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">python -m pip install --upgrade pip</span>
<span class="w">          </span><span class="no">pip install -r requirements.txt</span>
<span class="w">          </span><span class="no">pip install pytest-cov pytest-xdist</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests with coverage</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pytest tests/ \</span>
<span class="w">            </span><span class="no">--cov=src \</span>
<span class="w">            </span><span class="no">--cov-report=xml \</span>
<span class="w">            </span><span class="no">--cov-report=term \</span>
<span class="w">            </span><span class="no">--cov-fail-under=80 \</span>
<span class="w">            </span><span class="no">-n auto \</span>
<span class="w">            </span><span class="no">-v</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload coverage</span>
<span class="w">        </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix.os == &#39;ubuntu-latest&#39; &amp;&amp; matrix.python-version == &#39;3.11&#39;</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">codecov/codecov-action@v3</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./coverage.xml</span>
<span class="w">          </span><span class="nt">flags</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unittests</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">codecov-umbrella</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload test results</span>
<span class="w">        </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always()</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/upload-artifact@v3</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-results-${{ matrix.os }}-${{ matrix.python-version }}</span>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">            </span><span class="no">coverage.xml</span>
<span class="w">            </span><span class="no">.coverage</span>

<span class="w">  </span><span class="nt">lint</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set up Python</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-python@v4</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.11&#39;</span>
<span class="w">          </span><span class="nt">cache</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;pip&#39;</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install linting tools</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pip install black flake8 mypy</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Check code formatting</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">black --check src/ tests/</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Lint with flake8</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">flake8 src/ tests/ --max-line-length=100</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Type check with mypy</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mypy src/ --ignore-missing-imports</span>
</code></pre></div>

<p><strong>Advanced features</strong>:</p>
<p><strong>Multi-OS testing</strong>: <code>matrix.os</code> tests on Linux, Windows, and macOS.</p>
<p><strong>Selective exclusions</strong>: <code>exclude:</code> skips specific combinations to reduce CI time.</p>
<p><strong>Coverage threshold</strong>: <code>--cov-fail-under=80</code> fails if coverage drops below 80%.</p>
<p><strong>Parallel execution</strong>: <code>-n auto</code> uses pytest-xdist to run tests in parallel.</p>
<p><strong>Separate lint job</strong>: Code quality checks run independently from tests.</p>
<p><strong>Branch filtering</strong>: Only runs on <code>main</code> and <code>develop</code> branches for pushes.</p>
<h3 id="github-actions-best-practices">GitHub Actions Best Practices</h3>
<ol>
<li><strong>Use caching</strong>: Speeds up workflows significantly</li>
<li><strong>Fail fast = false</strong>: See all failures, not just the first</li>
<li><strong>Upload artifacts</strong>: Save test results and coverage for debugging</li>
<li><strong>Matrix testing</strong>: Test multiple Python versions and OSes</li>
<li><strong>Separate jobs</strong>: Linting, testing, and building should be independent</li>
<li><strong>Branch protection</strong>: Require passing tests before merging PRs</li>
</ol>
<h2 id="gitlab-ci-integration">GitLab CI Integration</h2>
<h2 id="gitlab-ci-pipeline-based-testing">GitLab CI: Pipeline-Based Testing</h2>
<p>GitLab CI/CD uses a different model than GitHub Actions. Instead of workflows with jobs, GitLab uses <strong>pipelines</strong> with <strong>stages</strong>. Tests are defined in a <code>.gitlab-ci.yml</code> file at the repository root.</p>
<h3 id="why-gitlab-ci">Why GitLab CI?</h3>
<ul>
<li><strong>Integrated with GitLab</strong>: Built into GitLab's platform</li>
<li><strong>Pipeline visualization</strong>: Excellent UI for complex pipelines</li>
<li><strong>Docker-first</strong>: Native Docker support for consistent environments</li>
<li><strong>Self-hosted runners</strong>: Run CI on your own infrastructure</li>
</ul>
<h3 id="the-pipeline-structure">The Pipeline Structure</h3>
<p>GitLab CI organizes work into <strong>stages</strong> that run sequentially, with <strong>jobs</strong> within each stage running in parallel.</p>
<h3 id="iteration-1-the-minimal-pipeline">Iteration 1: The Minimal Pipeline</h3>
<p>Create the pipeline configuration:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .gitlab-ci.yml</span>
<span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.11</span>

<span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>

<span class="nt">test_job</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install -r requirements.txt</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pytest tests/ -v</span>
</code></pre></div>

<h3 id="understanding-the-pipeline-anatomy">Understanding the Pipeline Anatomy</h3>
<p><strong><code>image: python:3.11</code></strong>: The Docker image to use. GitLab runs each job in a fresh container.</p>
<p><strong><code>stages:</code></strong>: Defines the pipeline stages. Jobs in the same stage run in parallel; stages run sequentially.</p>
<p><strong><code>test_job:</code></strong>: A job name (can be anything).</p>
<p><strong><code>stage: test</code></strong>: Assigns this job to the "test" stage.</p>
<p><strong><code>script:</code></strong>: Commands to execute. Each line runs in sequence.</p>
<h3 id="how-gitlab-ci-differs-from-github-actions">How GitLab CI Differs from GitHub Actions</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>GitHub Actions</th>
<th>GitLab CI</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Configuration</strong></td>
<td><code>.github/workflows/*.yml</code></td>
<td><code>.gitlab-ci.yml</code> (root)</td>
</tr>
<tr>
<td><strong>Execution model</strong></td>
<td>Workflows ‚Üí Jobs ‚Üí Steps</td>
<td>Pipelines ‚Üí Stages ‚Üí Jobs</td>
</tr>
<tr>
<td><strong>Environment</strong></td>
<td>VM-based (can use containers)</td>
<td>Docker-first (containers)</td>
</tr>
<tr>
<td><strong>Parallelism</strong></td>
<td>Matrix strategy</td>
<td>Multiple jobs in same stage</td>
</tr>
<tr>
<td><strong>Caching</strong></td>
<td>Explicit cache action</td>
<td>Built-in <code>cache:</code> directive</td>
</tr>
<tr>
<td><strong>Artifacts</strong></td>
<td>Upload/download actions</td>
<td>Built-in <code>artifacts:</code> directive</td>
</tr>
</tbody>
</table>
<h3 id="seeing-it-in-action_1">Seeing It in Action</h3>
<p>Commit and push:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.gitlab-ci.yml
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Add GitLab CI pipeline&quot;</span>
$<span class="w"> </span>git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>main
</code></pre></div>

<p>GitLab automatically detects the pipeline and runs it. Navigate to <strong>CI/CD ‚Üí Pipelines</strong> in your GitLab project to see:</p>
<div class="codehilite"><pre><span></span><code>Pipeline #123 - passed
‚îú‚îÄ test (stage)
   ‚îî‚îÄ test_job - passed (14s)
</code></pre></div>

<p>Click on <code>test_job</code> to see the output:</p>
<div class="codehilite"><pre><span></span><code>Running with gitlab-runner 15.8.0
Preparing the &quot;docker&quot; executor
Using Docker executor with image python:3.11 ...
Pulling docker image python:3.11 ...
‚úì Docker image pulled

Preparing environment
Running on runner-abc123...

Getting source from Git repository
Fetching changes...
‚úì Repository cloned

Executing &quot;step_script&quot; stage of the job script
$ pip install -r requirements.txt
Collecting requests==2.31.0
Collecting pytest==7.4.3
‚úì Dependencies installed

$ pytest tests/ -v
======================== test session starts =========================
collected 6 items

tests/test_payment_processor.py::test_successful_payment PASSED  [ 16%]
tests/test_payment_processor.py::test_payment_below_minimum PASSED [ 33%]
tests/test_payment_processor.py::test_gateway_error_handling PASSED [ 50%]
tests/test_payment_processor.py::test_factory_creates_processor PASSED [ 66%]
tests/test_payment_processor.py::test_factory_requires_api_key PASSED [ 83%]
tests/test_payment_processor.py::test_factory_uses_custom_url PASSED [100%]

========================= 6 passed in 0.14s ==========================

Job succeeded
</code></pre></div>

<h3 id="iteration-2-testing-multiple-python-versions_1">Iteration 2: Testing Multiple Python Versions</h3>
<p>GitLab CI uses <strong>parallel jobs</strong> instead of matrix strategy. Create multiple jobs with different images:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .gitlab-ci.yml</span>
<span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>

<span class="nt">.test_template</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;test_template</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install -r requirements.txt</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pytest tests/ -v</span>

<span class="nt">test_python39</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.9</span>

<span class="nt">test_python310</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.10</span>

<span class="nt">test_python311</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.11</span>

<span class="nt">test_python312</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.12</span>
</code></pre></div>

<h3 id="understanding-yaml-anchors">Understanding YAML Anchors</h3>
<p><strong><code>.test_template: &amp;test_template</code></strong>: Defines a reusable template with an anchor (<code>&amp;</code>).</p>
<p><strong><code>&lt;&lt;: *test_template</code></strong>: Merges the template into this job using an alias (<code>*</code>).</p>
<p>This is YAML's way of avoiding repetition. It's equivalent to:</p>
<div class="codehilite"><pre><span></span><code><span class="nt">test_python39</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.9</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install -r requirements.txt</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pytest tests/ -v</span>
</code></pre></div>

<p>But more maintainable when you have many similar jobs.</p>
<h3 id="pipeline-visualization">Pipeline Visualization</h3>
<p>GitLab shows all 4 jobs running in parallel:</p>
<div class="codehilite"><pre><span></span><code>Pipeline #124 - passed
‚îú‚îÄ test (stage)
   ‚îú‚îÄ test_python39  - passed (12s)
   ‚îú‚îÄ test_python310 - passed (11s)
   ‚îú‚îÄ test_python311 - passed (13s)
   ‚îî‚îÄ test_python312 - passed (14s)
</code></pre></div>

<h3 id="iteration-3-caching-dependencies_1">Iteration 3: Caching Dependencies</h3>
<p>Installing dependencies on every run is slow. GitLab CI has built-in caching:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .gitlab-ci.yml</span>
<span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>

<span class="nt">.test_template</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;test_template</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">cache</span><span class="p">:</span>
<span class="w">    </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${CI_COMMIT_REF_SLUG}-${CI_JOB_IMAGE}</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.cache/pip</span>
<span class="w">  </span><span class="nt">before_script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">export PIP_CACHE_DIR=&quot;$CI_PROJECT_DIR/.cache/pip&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install -r requirements.txt</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pytest tests/ -v</span>

<span class="nt">test_python39</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.9</span>

<span class="nt">test_python310</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.10</span>

<span class="nt">test_python311</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.11</span>

<span class="nt">test_python312</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.12</span>
</code></pre></div>

<h3 id="understanding-gitlab-caching">Understanding GitLab Caching</h3>
<p><strong><code>cache:</code></strong>: Defines what to cache between pipeline runs.</p>
<p><strong><code>key:</code></strong>: Cache identifier. Using <code>${CI_COMMIT_REF_SLUG}-${CI_JOB_IMAGE}</code> creates separate caches for:
- Each branch (<code>CI_COMMIT_REF_SLUG</code>)
- Each Python version (<code>CI_JOB_IMAGE</code>)</p>
<p><strong><code>paths:</code></strong>: Directories to cache. We cache pip's download directory.</p>
<p><strong><code>before_script:</code></strong>: Runs before the main <code>script:</code>. We configure pip to use our cached directory.</p>
<p><strong>First run</strong>: Downloads packages and caches them (slow).
<strong>Subsequent runs</strong>: Restores from cache (fast).</p>
<p>The output shows caching in action:</p>
<div class="codehilite"><pre><span></span><code>Restoring cache
Checking cache for main-python:3.11...
Successfully extracted cache

$ export PIP_CACHE_DIR=&quot;$CI_PROJECT_DIR/.cache/pip&quot;
$ pip install -r requirements.txt
Requirement already satisfied: requests==2.31.0 (from cache)
Requirement already satisfied: pytest==7.4.3 (from cache)
‚úì Dependencies installed (0.4s instead of 11s)
</code></pre></div>

<h3 id="iteration-4-adding-code-coverage_1">Iteration 4: Adding Code Coverage</h3>
<p>Integrate coverage reporting:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .gitlab-ci.yml</span>
<span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">report</span>

<span class="nt">.test_template</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;test_template</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">cache</span><span class="p">:</span>
<span class="w">    </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${CI_COMMIT_REF_SLUG}-${CI_JOB_IMAGE}</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.cache/pip</span>
<span class="w">  </span><span class="nt">before_script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">export PIP_CACHE_DIR=&quot;$CI_PROJECT_DIR/.cache/pip&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install -r requirements.txt</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install pytest-cov</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pytest tests/ --cov=src --cov-report=xml --cov-report=term -v</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">reports</span><span class="p">:</span>
<span class="w">      </span><span class="nt">coverage_report</span><span class="p">:</span>
<span class="w">        </span><span class="nt">coverage_format</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cobertura</span>
<span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">coverage.xml</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">coverage.xml</span>
<span class="w">    </span><span class="nt">expire_in</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1 week</span>

<span class="nt">test_python39</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.9</span>

<span class="nt">test_python310</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.10</span>

<span class="nt">test_python311</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.11</span>

<span class="nt">test_python312</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.12</span>

<span class="nt">coverage_report</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">report</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.11</span>
<span class="w">  </span><span class="nt">dependencies</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test_python311</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install coverage</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">coverage report</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">coverage html</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">htmlcov/</span>
<span class="w">    </span><span class="nt">expire_in</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1 week</span>
<span class="w">  </span><span class="nt">coverage</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;/TOTAL.*\s+(\d+%)$/&#39;</span>
</code></pre></div>

<h3 id="understanding-gitlab-artifacts">Understanding GitLab Artifacts</h3>
<p><strong><code>artifacts:</code></strong>: Files to save after the job completes.</p>
<p><strong><code>reports: coverage_report:</code></strong>: GitLab parses this as coverage data and displays it in the UI.</p>
<p><strong><code>paths:</code></strong>: Files to save. Other jobs can download these.</p>
<p><strong><code>expire_in:</code></strong>: How long to keep artifacts. Options: <code>1 day</code>, <code>1 week</code>, <code>1 month</code>, <code>never</code>.</p>
<p><strong><code>dependencies:</code></strong>: Which jobs' artifacts to download. <code>coverage_report</code> only needs artifacts from <code>test_python311</code>.</p>
<p><strong><code>coverage: '/TOTAL.*\s+(\d+%)$/'</code></strong>: Regex to extract coverage percentage from output. GitLab displays this as a badge.</p>
<h3 id="pipeline-visualization-with-stages">Pipeline Visualization with Stages</h3>
<p>Now the pipeline has two stages:</p>
<div class="codehilite"><pre><span></span><code>Pipeline #125 - passed
‚îú‚îÄ test (stage)
‚îÇ  ‚îú‚îÄ test_python39  - passed (12s)
‚îÇ  ‚îú‚îÄ test_python310 - passed (11s)
‚îÇ  ‚îú‚îÄ test_python311 - passed (13s)
‚îÇ  ‚îî‚îÄ test_python312 - passed (14s)
‚îî‚îÄ report (stage)
   ‚îî‚îÄ coverage_report - passed (8s)
</code></pre></div>

<p>The <code>report</code> stage only runs if all <code>test</code> stage jobs pass.</p>
<h3 id="iteration-5-adding-quality-gates">Iteration 5: Adding Quality Gates</h3>
<p>Fail the pipeline if coverage drops below a threshold:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .gitlab-ci.yml</span>
<span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">report</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">quality</span>

<span class="nt">.test_template</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;test_template</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">cache</span><span class="p">:</span>
<span class="w">    </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${CI_COMMIT_REF_SLUG}-${CI_JOB_IMAGE}</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.cache/pip</span>
<span class="w">  </span><span class="nt">before_script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">export PIP_CACHE_DIR=&quot;$CI_PROJECT_DIR/.cache/pip&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install -r requirements.txt</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install pytest-cov</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pytest tests/ --cov=src --cov-report=xml --cov-report=term --cov-fail-under=80 -v</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">reports</span><span class="p">:</span>
<span class="w">      </span><span class="nt">coverage_report</span><span class="p">:</span>
<span class="w">        </span><span class="nt">coverage_format</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cobertura</span>
<span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">coverage.xml</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">coverage.xml</span>
<span class="w">    </span><span class="nt">expire_in</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1 week</span>

<span class="nt">test_python39</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.9</span>

<span class="nt">test_python310</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.10</span>

<span class="nt">test_python311</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.11</span>

<span class="nt">test_python312</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.12</span>

<span class="nt">coverage_report</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">report</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.11</span>
<span class="w">  </span><span class="nt">dependencies</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test_python311</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install coverage</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">coverage report</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">coverage html</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">htmlcov/</span>
<span class="w">    </span><span class="nt">expire_in</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1 week</span>
<span class="w">  </span><span class="nt">coverage</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;/TOTAL.*\s+(\d+%)$/&#39;</span>

<span class="nt">code_quality</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">quality</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.11</span>
<span class="w">  </span><span class="nt">cache</span><span class="p">:</span>
<span class="w">    </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${CI_COMMIT_REF_SLUG}-quality</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.cache/pip</span>
<span class="w">  </span><span class="nt">before_script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">export PIP_CACHE_DIR=&quot;$CI_PROJECT_DIR/.cache/pip&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install black flake8 mypy</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">black --check src/ tests/</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">flake8 src/ tests/ --max-line-length=100</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mypy src/ --ignore-missing-imports</span>
<span class="w">  </span><span class="nt">allow_failure</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</code></pre></div>

<p><strong>New additions</strong>:</p>
<p><strong><code>--cov-fail-under=80</code></strong>: Tests fail if coverage is below 80%.</p>
<p><strong><code>code_quality</code> job</strong>: Runs linting and type checking.</p>
<p><strong><code>allow_failure: false</code></strong>: Pipeline fails if this job fails (default behavior, but explicit here).</p>
<h3 id="when-tests-fail-in-gitlab-ci">When Tests Fail in GitLab CI</h3>
<p>Let's simulate the same bug from the GitHub Actions section:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/payment_processor.py (with bug)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">card_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process a payment with validation.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_amount</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Amount must be at least </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min_amount</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">card_token</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Payment processed successfully&quot;</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># BUG: Forgot to return here!</span>
        <span class="k">pass</span>
</code></pre></div>

<p>GitLab shows the failure:</p>
<div class="codehilite"><pre><span></span><code>$ pytest tests/ --cov=src --cov-report=xml --cov-report=term --cov-fail-under=80 -v
======================== test session starts =========================
collected 6 items

tests/test_payment_processor.py::test_successful_payment PASSED  [ 16%]
tests/test_payment_processor.py::test_payment_below_minimum PASSED [ 33%]
tests/test_payment_processor.py::test_gateway_error_handling FAILED [ 50%]

============================== FAILURES ==============================
______________ test_gateway_error_handling _______________

processor = &lt;src.payment_processor.PaymentProcessor object at 0x7f8b3c&gt;
mock_gateway = &lt;Mock spec=&#39;PaymentGateway&#39; id=&#39;140234567890&#39;&gt;

    def test_gateway_error_handling(processor, mock_gateway):
        &quot;&quot;&quot;Test handling of gateway API errors.&quot;&quot;&quot;
        import requests
        mock_gateway.charge.side_effect = requests.RequestException(&quot;Network timeout&quot;)

        result = processor.process_payment(Decimal(&quot;10.00&quot;), &quot;card_tok_visa&quot;)

        assert result[&quot;success&quot;] is False
&gt;       assert result[&quot;transaction_id&quot;] is None
E       TypeError: &#39;NoneType&#39; object is not subscriptable

tests/test_payment_processor.py:48: TypeError
===================== 1 failed, 5 passed in 0.15s ====================

ERROR: Job failed: exit code 1
</code></pre></div>

<p>The pipeline visualization shows:</p>
<div class="codehilite"><pre><span></span><code>Pipeline #126 - failed
‚îú‚îÄ test (stage)
‚îÇ  ‚îú‚îÄ test_python39  - passed (12s)
‚îÇ  ‚îú‚îÄ test_python310 - passed (11s)
‚îÇ  ‚îú‚îÄ test_python311 - failed (13s) ‚Üê Failure here
‚îÇ  ‚îî‚îÄ test_python312 - passed (14s)
‚îî‚îÄ report (stage) - skipped (previous stage failed)
</code></pre></div>

<p>GitLab:</p>
<ol>
<li><strong>Marks the commit with a red X</strong></li>
<li><strong>Blocks merge requests</strong> if you've configured merge request approvals</li>
<li><strong>Sends notifications</strong> via email or Slack</li>
<li><strong>Shows the failure</strong> in the pipeline view</li>
</ol>
<p>You can click the failed job to see full output and download artifacts.</p>
<h3 id="the-complete-production-pipeline">The Complete Production Pipeline</h3>
<p>Here's a full-featured pipeline for a production project:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .gitlab-ci.yml</span>
<span class="nt">variables</span><span class="p">:</span>
<span class="w">  </span><span class="nt">PIP_CACHE_DIR</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;$CI_PROJECT_DIR/.cache/pip&quot;</span>

<span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">report</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">quality</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>

<span class="nt">cache</span><span class="p">:</span>
<span class="w">  </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${CI_COMMIT_REF_SLUG}</span>
<span class="w">  </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.cache/pip</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">venv/</span>

<span class="nt">before_script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python -V</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install virtualenv</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">virtualenv venv</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">source venv/bin/activate</span>

<span class="nt">.test_template</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;test_template</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install -r requirements.txt</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install pytest-cov pytest-xdist</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pytest tests/ --cov=src --cov-report=xml --cov-report=term --cov-fail-under=80 -n auto -v</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">reports</span><span class="p">:</span>
<span class="w">      </span><span class="nt">coverage_report</span><span class="p">:</span>
<span class="w">        </span><span class="nt">coverage_format</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cobertura</span>
<span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">coverage.xml</span>
<span class="w">      </span><span class="nt">junit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">report.xml</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">coverage.xml</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">report.xml</span>
<span class="w">    </span><span class="nt">expire_in</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1 week</span>
<span class="w">  </span><span class="nt">coverage</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;/TOTAL.*\s+(\d+%)$/&#39;</span>

<span class="nt">test_python39</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.9</span>

<span class="nt">test_python310</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.10</span>

<span class="nt">test_python311</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.11</span>

<span class="nt">test_python312</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.12</span>

<span class="nt">coverage_report</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">report</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.11</span>
<span class="w">  </span><span class="nt">dependencies</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test_python311</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install coverage</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">coverage report</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">coverage html</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">htmlcov/</span>
<span class="w">    </span><span class="nt">expire_in</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1 month</span>

<span class="nt">code_quality</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">quality</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.11</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install black flake8 mypy</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">black --check src/ tests/</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">flake8 src/ tests/ --max-line-length=100 --count --statistics</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mypy src/ --ignore-missing-imports</span>
<span class="w">  </span><span class="nt">allow_failure</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="nt">security_scan</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">quality</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.11</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install bandit safety</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bandit -r src/ -f json -o bandit-report.json</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">safety check --json &gt; safety-report.json</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bandit-report.json</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">safety-report.json</span>
<span class="w">    </span><span class="nt">expire_in</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1 month</span>
<span class="w">  </span><span class="nt">allow_failure</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">deploy_docs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.11</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install sphinx</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cd docs &amp;&amp; make html</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docs/_build/html</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">main</span>
</code></pre></div>

<p><strong>Advanced features</strong>:</p>
<p><strong>Global cache</strong>: <code>cache:</code> at the top level applies to all jobs.</p>
<p><strong>Virtual environment caching</strong>: Cache <code>venv/</code> to avoid reinstalling packages.</p>
<p><strong>JUnit reports</strong>: <code>junit: report.xml</code> integrates test results into GitLab's UI.</p>
<p><strong>Security scanning</strong>: <code>bandit</code> and <code>safety</code> check for security issues.</p>
<p><strong>Conditional deployment</strong>: <code>only: - main</code> runs <code>deploy_docs</code> only on the main branch.</p>
<p><strong>Parallel testing</strong>: <code>-n auto</code> uses pytest-xdist for parallel execution.</p>
<h3 id="gitlab-ci-best-practices">GitLab CI Best Practices</h3>
<ol>
<li><strong>Use Docker images</strong>: Ensures consistent environments</li>
<li><strong>Cache aggressively</strong>: Cache pip, venv, and build artifacts</li>
<li><strong>Use YAML anchors</strong>: Reduce duplication in configuration</li>
<li><strong>Separate stages</strong>: Build ‚Üí Test ‚Üí Report ‚Üí Quality ‚Üí Deploy</li>
<li><strong>Artifacts for debugging</strong>: Save test results and coverage reports</li>
<li><strong>Merge request pipelines</strong>: Configure pipelines to run on MRs</li>
<li><strong>Protected branches</strong>: Require passing pipelines before merging</li>
</ol>
<h2 id="jenkins-and-other-ci-systems">Jenkins and Other CI Systems</h2>
<h2 id="jenkins-the-self-hosted-powerhouse">Jenkins: The Self-Hosted Powerhouse</h2>
<p>Jenkins is the oldest and most flexible CI system. Unlike GitHub Actions and GitLab CI (which are cloud-hosted), Jenkins typically runs on your own infrastructure. This gives you complete control but requires more setup.</p>
<h3 id="why-jenkins">Why Jenkins?</h3>
<ul>
<li><strong>Self-hosted</strong>: Run on your own servers, no external dependencies</li>
<li><strong>Highly customizable</strong>: Thousands of plugins for every use case</li>
<li><strong>Enterprise features</strong>: Advanced security, audit logs, distributed builds</li>
<li><strong>Language-agnostic</strong>: Not Python-specific, works with any language</li>
</ul>
<h3 id="jenkins-pipeline-structure">Jenkins Pipeline Structure</h3>
<p>Jenkins uses <strong>Jenkinsfiles</strong> written in Groovy (a JVM language). There are two syntaxes:</p>
<ol>
<li><strong>Declarative Pipeline</strong>: Structured, easier to learn (we'll use this)</li>
<li><strong>Scripted Pipeline</strong>: More flexible, harder to learn</li>
</ol>
<h3 id="iteration-1-the-minimal-jenkinsfile">Iteration 1: The Minimal Jenkinsfile</h3>
<p>Create a pipeline definition:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Jenkinsfile</span>
<span class="n">pipeline</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">agent</span><span class="w"> </span><span class="n">any</span>

<span class="w">    </span><span class="n">stages</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Checkout&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">steps</span><span class="w"> </span><span class="o">{</span>
<span class="w">                </span><span class="n">checkout</span><span class="w"> </span><span class="n">scm</span>
<span class="w">            </span><span class="o">}</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">        </span><span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Install Dependencies&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">steps</span><span class="w"> </span><span class="o">{</span>
<span class="w">                </span><span class="n">sh</span><span class="w"> </span><span class="s1">&#39;pip install -r requirements.txt&#39;</span>
<span class="w">            </span><span class="o">}</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">        </span><span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Run Tests&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">steps</span><span class="w"> </span><span class="o">{</span>
<span class="w">                </span><span class="n">sh</span><span class="w"> </span><span class="s1">&#39;pytest tests/ -v&#39;</span>
<span class="w">            </span><span class="o">}</span>
<span class="w">        </span><span class="o">}</span>
<span class="w">    </span><span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<h3 id="understanding-the-jenkinsfile-anatomy">Understanding the Jenkinsfile Anatomy</h3>
<p><strong><code>pipeline {}</code></strong>: The root block for declarative pipelines.</p>
<p><strong><code>agent any</code></strong>: Run on any available Jenkins agent (worker node).</p>
<p><strong><code>stages {}</code></strong>: Contains all pipeline stages.</p>
<p><strong><code>stage('Name') {}</code></strong>: A named stage in the pipeline.</p>
<p><strong><code>steps {}</code></strong>: Commands to execute in this stage.</p>
<p><strong><code>checkout scm</code></strong>: Jenkins-specific command to clone the repository.</p>
<p><strong><code>sh 'command'</code></strong>: Execute a shell command.</p>
<h3 id="how-jenkins-differs-from-github-actions-and-gitlab-ci">How Jenkins Differs from GitHub Actions and GitLab CI</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>GitHub Actions</th>
<th>GitLab CI</th>
<th>Jenkins</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Hosting</strong></td>
<td>Cloud (GitHub)</td>
<td>Cloud (GitLab)</td>
<td>Self-hosted</td>
</tr>
<tr>
<td><strong>Configuration</strong></td>
<td>YAML</td>
<td>YAML</td>
<td>Groovy (Jenkinsfile)</td>
</tr>
<tr>
<td><strong>Execution model</strong></td>
<td>Workflows ‚Üí Jobs</td>
<td>Pipelines ‚Üí Stages</td>
<td>Pipelines ‚Üí Stages</td>
</tr>
<tr>
<td><strong>Environment</strong></td>
<td>VM or container</td>
<td>Docker containers</td>
<td>Configurable (any)</td>
</tr>
<tr>
<td><strong>Plugins</strong></td>
<td>Actions marketplace</td>
<td>Built-in + extensions</td>
<td>1800+ plugins</td>
</tr>
<tr>
<td><strong>Setup</strong></td>
<td>Zero (built-in)</td>
<td>Zero (built-in)</td>
<td>Manual installation</td>
</tr>
</tbody>
</table>
<h3 id="setting-up-jenkins-brief-overview">Setting Up Jenkins (Brief Overview)</h3>
<p>Since Jenkins is self-hosted, you need to:</p>
<ol>
<li><strong>Install Jenkins</strong>: Download from jenkins.io or use Docker</li>
<li><strong>Install plugins</strong>: "Pipeline", "Git", "Python" plugins</li>
<li><strong>Configure agents</strong>: Set up worker nodes with Python installed</li>
<li><strong>Create a job</strong>: Point it to your repository</li>
</ol>
<p>For this chapter, we'll assume Jenkins is already set up and focus on the Jenkinsfile.</p>
<h3 id="iteration-2-testing-multiple-python-versions_2">Iteration 2: Testing Multiple Python Versions</h3>
<p>Jenkins doesn't have built-in matrix support like GitHub Actions. You need to use the <code>matrix</code> directive (added in Jenkins 2.22):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Jenkinsfile</span>
<span class="n">pipeline</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">agent</span><span class="w"> </span><span class="n">none</span>

<span class="w">    </span><span class="n">stages</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Test&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">matrix</span><span class="w"> </span><span class="o">{</span>
<span class="w">                </span><span class="n">agent</span><span class="w"> </span><span class="n">any</span>
<span class="w">                </span><span class="n">axes</span><span class="w"> </span><span class="o">{</span>
<span class="w">                    </span><span class="n">axis</span><span class="w"> </span><span class="o">{</span>
<span class="w">                        </span><span class="n">name</span><span class="w"> </span><span class="s1">&#39;PYTHON_VERSION&#39;</span>
<span class="w">                        </span><span class="n">values</span><span class="w"> </span><span class="s1">&#39;3.9&#39;</span><span class="o">,</span><span class="w"> </span><span class="s1">&#39;3.10&#39;</span><span class="o">,</span><span class="w"> </span><span class="s1">&#39;3.11&#39;</span><span class="o">,</span><span class="w"> </span><span class="s1">&#39;3.12&#39;</span>
<span class="w">                    </span><span class="o">}</span>
<span class="w">                </span><span class="o">}</span>
<span class="w">                </span><span class="n">stages</span><span class="w"> </span><span class="o">{</span>
<span class="w">                    </span><span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Setup&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">                        </span><span class="n">steps</span><span class="w"> </span><span class="o">{</span>
<span class="w">                            </span><span class="n">sh</span><span class="w"> </span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                                python${PYTHON_VERSION} -m venv venv</span>
<span class="s2">                                . venv/bin/activate</span>
<span class="s2">                                pip install -r requirements.txt</span>
<span class="s2">                            &quot;&quot;&quot;</span>
<span class="w">                        </span><span class="o">}</span>
<span class="w">                    </span><span class="o">}</span>
<span class="w">                    </span><span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Test&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">                        </span><span class="n">steps</span><span class="w"> </span><span class="o">{</span>
<span class="w">                            </span><span class="n">sh</span><span class="w"> </span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                                . venv/bin/activate</span>
<span class="s2">                                pytest tests/ -v</span>
<span class="s2">                            &quot;&quot;&quot;</span>
<span class="w">                        </span><span class="o">}</span>
<span class="w">                    </span><span class="o">}</span>
<span class="w">                </span><span class="o">}</span>
<span class="w">            </span><span class="o">}</span>
<span class="w">        </span><span class="o">}</span>
<span class="w">    </span><span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<h3 id="understanding-jenkins-matrix">Understanding Jenkins Matrix</h3>
<p><strong><code>agent none</code></strong>: Don't allocate an agent at the pipeline level (each matrix cell gets its own).</p>
<p><strong><code>matrix {}</code></strong>: Defines a matrix build.</p>
<p><strong><code>axes {}</code></strong>: Defines matrix dimensions.</p>
<p><strong><code>axis { name 'VAR' values '1', '2' }</code></strong>: Creates a variable with multiple values.</p>
<p><strong><code>stages {}</code></strong>: Stages to run for each matrix cell.</p>
<p><strong><code>${PYTHON_VERSION}</code></strong>: Groovy variable interpolation.</p>
<p><strong>Triple-quoted strings (<code>"""</code>)</strong>: Allow multi-line shell commands.</p>
<h3 id="iteration-3-adding-code-coverage">Iteration 3: Adding Code Coverage</h3>
<p>Integrate coverage with Jenkins' built-in reporting:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Jenkinsfile</span>
<span class="n">pipeline</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">agent</span><span class="w"> </span><span class="n">any</span>

<span class="w">    </span><span class="n">stages</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Checkout&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">steps</span><span class="w"> </span><span class="o">{</span>
<span class="w">                </span><span class="n">checkout</span><span class="w"> </span><span class="n">scm</span>
<span class="w">            </span><span class="o">}</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">        </span><span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Setup&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">steps</span><span class="w"> </span><span class="o">{</span>
<span class="w">                </span><span class="n">sh</span><span class="w"> </span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    python3 -m venv venv</span>
<span class="s1">                    . venv/bin/activate</span>
<span class="s1">                    pip install -r requirements.txt</span>
<span class="s1">                    pip install pytest-cov</span>
<span class="s1">                &#39;&#39;&#39;</span>
<span class="w">            </span><span class="o">}</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">        </span><span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Test&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">steps</span><span class="w"> </span><span class="o">{</span>
<span class="w">                </span><span class="n">sh</span><span class="w"> </span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    . venv/bin/activate</span>
<span class="s1">                    pytest tests/ \</span>
<span class="s1">                        --cov=src \</span>
<span class="s1">                        --cov-report=xml \</span>
<span class="s1">                        --cov-report=html \</span>
<span class="s1">                        --cov-report=term \</span>
<span class="s1">                        --junitxml=report.xml \</span>
<span class="s1">                        -v</span>
<span class="s1">                &#39;&#39;&#39;</span>
<span class="w">            </span><span class="o">}</span>
<span class="w">        </span><span class="o">}</span>
<span class="w">    </span><span class="o">}</span>

<span class="w">    </span><span class="n">post</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="n">always</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">junit</span><span class="w"> </span><span class="s1">&#39;report.xml&#39;</span>
<span class="w">            </span><span class="n">publishHTML</span><span class="o">([</span>
<span class="w">                </span><span class="nl">allowMissing:</span><span class="w"> </span><span class="kc">false</span><span class="o">,</span>
<span class="w">                </span><span class="nl">alwaysLinkToLastBuild:</span><span class="w"> </span><span class="kc">true</span><span class="o">,</span>
<span class="w">                </span><span class="nl">keepAll:</span><span class="w"> </span><span class="kc">true</span><span class="o">,</span>
<span class="w">                </span><span class="nl">reportDir:</span><span class="w"> </span><span class="s1">&#39;htmlcov&#39;</span><span class="o">,</span>
<span class="w">                </span><span class="nl">reportFiles:</span><span class="w"> </span><span class="s1">&#39;index.html&#39;</span><span class="o">,</span>
<span class="w">                </span><span class="nl">reportName:</span><span class="w"> </span><span class="s1">&#39;Coverage Report&#39;</span>
<span class="w">            </span><span class="o">])</span>
<span class="w">        </span><span class="o">}</span>
<span class="w">    </span><span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<h3 id="understanding-jenkins-post-actions">Understanding Jenkins Post Actions</h3>
<p><strong><code>post {}</code></strong>: Actions to run after stages complete.</p>
<p><strong><code>always {}</code></strong>: Run regardless of success or failure. Other options:
- <code>success {}</code>: Only on success
- <code>failure {}</code>: Only on failure
- <code>unstable {}</code>: When tests fail but build succeeds</p>
<p><strong><code>junit 'report.xml'</code></strong>: Parse JUnit XML and display test results in Jenkins UI.</p>
<p><strong><code>publishHTML([...])</code></strong>: Publish HTML reports (requires HTML Publisher plugin).</p>
<h3 id="jenkins-ui-integration">Jenkins UI Integration</h3>
<p>After running, Jenkins displays:</p>
<ol>
<li><strong>Test Results</strong>: Clickable test names, failure details, trends over time</li>
<li><strong>Coverage Report</strong>: Interactive HTML coverage report</li>
<li><strong>Build History</strong>: Graph showing test pass/fail trends</li>
<li><strong>Console Output</strong>: Full log of the build</li>
</ol>
<h3 id="iteration-4-parallel-stages">Iteration 4: Parallel Stages</h3>
<p>Jenkins can run stages in parallel for faster builds:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Jenkinsfile</span>
<span class="n">pipeline</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">agent</span><span class="w"> </span><span class="n">any</span>

<span class="w">    </span><span class="n">stages</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Checkout&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">steps</span><span class="w"> </span><span class="o">{</span>
<span class="w">                </span><span class="n">checkout</span><span class="w"> </span><span class="n">scm</span>
<span class="w">            </span><span class="o">}</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">        </span><span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Setup&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">steps</span><span class="w"> </span><span class="o">{</span>
<span class="w">                </span><span class="n">sh</span><span class="w"> </span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    python3 -m venv venv</span>
<span class="s1">                    . venv/bin/activate</span>
<span class="s1">                    pip install -r requirements.txt</span>
<span class="s1">                    pip install pytest-cov pytest-xdist black flake8 mypy</span>
<span class="s1">                &#39;&#39;&#39;</span>
<span class="w">            </span><span class="o">}</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">        </span><span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Parallel Checks&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">parallel</span><span class="w"> </span><span class="o">{</span>
<span class="w">                </span><span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Unit Tests&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">                    </span><span class="n">steps</span><span class="w"> </span><span class="o">{</span>
<span class="w">                        </span><span class="n">sh</span><span class="w"> </span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                            . venv/bin/activate</span>
<span class="s1">                            pytest tests/ \</span>
<span class="s1">                                --cov=src \</span>
<span class="s1">                                --cov-report=xml \</span>
<span class="s1">                                --cov-report=html \</span>
<span class="s1">                                --junitxml=report.xml \</span>
<span class="s1">                                -n auto \</span>
<span class="s1">                                -v</span>
<span class="s1">                        &#39;&#39;&#39;</span>
<span class="w">                    </span><span class="o">}</span>
<span class="w">                </span><span class="o">}</span>

<span class="w">                </span><span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Code Quality&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">                    </span><span class="n">steps</span><span class="w"> </span><span class="o">{</span>
<span class="w">                        </span><span class="n">sh</span><span class="w"> </span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                            . venv/bin/activate</span>
<span class="s1">                            black --check src/ tests/</span>
<span class="s1">                            flake8 src/ tests/ --max-line-length=100</span>
<span class="s1">                            mypy src/ --ignore-missing-imports</span>
<span class="s1">                        &#39;&#39;&#39;</span>
<span class="w">                    </span><span class="o">}</span>
<span class="w">                </span><span class="o">}</span>
<span class="w">            </span><span class="o">}</span>
<span class="w">        </span><span class="o">}</span>
<span class="w">    </span><span class="o">}</span>

<span class="w">    </span><span class="n">post</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="n">always</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="n">junit</span><span class="w"> </span><span class="s1">&#39;report.xml&#39;</span>
<span class="w">            </span><span class="n">publishHTML</span><span class="o">([</span>
<span class="w">                </span><span class="nl">allowMissing:</span><span class="w"> </span><span class="kc">false</span><span class="o">,</span>
<span class="w">                </span><span class="nl">alwaysLinkToLastBuild:</span><span class="w"> </span><span class="kc">true</span><span class="o">,</span>
<span class="w">                </span><span class="nl">keepAll:</span><span class="w"> </span><span class="kc">true</span><span class="o">,</span>
<span class="w">                </span><span class="nl">reportDir:</span><span class="w"> </span><span class="s1">&#39;htmlcov&#39;</span><span class="o">,</span>
<span class="w">                </span><span class="nl">reportFiles:</span><span class="w"> </span><span class="s1">&#39;index.html&#39;</span><span class="o">,</span>
<span class="w">                </span><span class="nl">reportName:</span><span class="w"> </span><span class="s1">&#39;Coverage Report&#39;</span>
<span class="w">            </span><span class="o">])</span>
<span class="w">        </span><span class="o">}</span>
<span class="w">    </span><span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<h3 id="understanding-parallel-stages">Understanding Parallel Stages</h3>
<p><strong><code>parallel {}</code></strong>: Runs contained stages simultaneously.</p>
<p><strong>Benefits</strong>:
- Tests and linting run at the same time
- Faster feedback (total time = max(test_time, lint_time) instead of sum)
- Better resource utilization</p>
<p><strong>Visualization in Jenkins</strong>:</p>
<div class="codehilite"><pre><span></span><code>Pipeline
‚îú‚îÄ Checkout (sequential)
‚îú‚îÄ Setup (sequential)
‚îú‚îÄ Parallel Checks
‚îÇ  ‚îú‚îÄ Unit Tests (parallel)
‚îÇ  ‚îî‚îÄ Code Quality (parallel)
‚îî‚îÄ Post Actions (sequential)
</code></pre></div>

<h2 id="other-ci-systems">Other CI Systems</h2>
<h3 id="circleci">CircleCI</h3>
<p>CircleCI is similar to GitHub Actions but with a different configuration syntax:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .circleci/config.yml</span>
<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.1</span>

<span class="nt">orbs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">python</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">circleci/python@2.1.1</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">test</span><span class="p">:</span>
<span class="w">    </span><span class="nt">docker</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cimg/python:3.11</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">checkout</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">python/install-packages</span><span class="p">:</span>
<span class="w">          </span><span class="nt">pkg-manager</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests</span>
<span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pytest tests/ -v</span>

<span class="nt">workflows</span><span class="p">:</span>
<span class="w">  </span><span class="nt">test-workflow</span><span class="p">:</span>
<span class="w">    </span><span class="nt">jobs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
</code></pre></div>

<p><strong>Key features</strong>:
- <strong>Orbs</strong>: Reusable configuration packages (like <code>python: circleci/python@2.1.1</code>)
- <strong>Docker-first</strong>: Native Docker support
- <strong>Workflows</strong>: Orchestrate multiple jobs
- <strong>Caching</strong>: Automatic dependency caching</p>
<h3 id="travis-ci">Travis CI</h3>
<p>Travis CI uses a <code>.travis.yml</code> file:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .travis.yml</span>
<span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python</span>

<span class="nt">python</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;3.9&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;3.10&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;3.11&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;3.12&quot;</span>

<span class="nt">install</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install -r requirements.txt</span>

<span class="nt">script</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pytest tests/ -v</span>

<span class="nt">after_success</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install codecov</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">codecov</span>
</code></pre></div>

<p><strong>Key features</strong>:
- <strong>Simple configuration</strong>: Very concise for basic use cases
- <strong>Matrix builds</strong>: Built-in support for multiple Python versions
- <strong>Free for open source</strong>: Popular in the open-source community</p>
<h3 id="azure-pipelines">Azure Pipelines</h3>
<p>Azure Pipelines uses <code>azure-pipelines.yml</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># azure-pipelines.yml</span>
<span class="nt">trigger</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">main</span>

<span class="nt">pool</span><span class="p">:</span>
<span class="w">  </span><span class="nt">vmImage</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;ubuntu-latest&#39;</span>

<span class="nt">strategy</span><span class="p">:</span>
<span class="w">  </span><span class="nt">matrix</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Python39</span><span class="p">:</span>
<span class="w">      </span><span class="nt">python.version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.9&#39;</span>
<span class="w">    </span><span class="nt">Python310</span><span class="p">:</span>
<span class="w">      </span><span class="nt">python.version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.10&#39;</span>
<span class="w">    </span><span class="nt">Python311</span><span class="p">:</span>
<span class="w">      </span><span class="nt">python.version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.11&#39;</span>
<span class="w">    </span><span class="nt">Python312</span><span class="p">:</span>
<span class="w">      </span><span class="nt">python.version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.12&#39;</span>

<span class="nt">steps</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">UsePythonVersion@0</span>
<span class="w">    </span><span class="nt">inputs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">versionSpec</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;$(python.version)&#39;</span>
<span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;Use</span><span class="nv"> </span><span class="s">Python</span><span class="nv"> </span><span class="s">$(python.version)&#39;</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">      </span><span class="no">pip install -r requirements.txt</span>
<span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;Install</span><span class="nv"> </span><span class="s">dependencies&#39;</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">      </span><span class="no">pytest tests/ -v</span>
<span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;Run</span><span class="nv"> </span><span class="s">tests&#39;</span>
</code></pre></div>

<p><strong>Key features</strong>:
- <strong>Microsoft ecosystem</strong>: Integrates with Azure services
- <strong>Matrix strategy</strong>: Similar to GitHub Actions
- <strong>Tasks</strong>: Pre-built actions for common operations</p>
<h2 id="choosing-a-ci-system">Choosing a CI System</h2>
<h3 id="decision-framework">Decision Framework</h3>
<table>
<thead>
<tr>
<th>Factor</th>
<th>GitHub Actions</th>
<th>GitLab CI</th>
<th>Jenkins</th>
<th>CircleCI</th>
<th>Travis CI</th>
<th>Azure Pipelines</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Setup complexity</strong></td>
<td>Zero</td>
<td>Zero</td>
<td>High</td>
<td>Low</td>
<td>Low</td>
<td>Low</td>
</tr>
<tr>
<td><strong>Cost (open source)</strong></td>
<td>Free</td>
<td>Free</td>
<td>Free</td>
<td>Free</td>
<td>Free</td>
<td>Free</td>
</tr>
<tr>
<td><strong>Cost (private)</strong></td>
<td>Generous free</td>
<td>Generous</td>
<td>Free</td>
<td>Limited</td>
<td>Paid</td>
<td>Generous</td>
</tr>
<tr>
<td><strong>Self-hosting</strong></td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
<td>No</td>
<td>No</td>
<td>No</td>
</tr>
<tr>
<td><strong>Configuration</strong></td>
<td>YAML</td>
<td>YAML</td>
<td>Groovy</td>
<td>YAML</td>
<td>YAML</td>
<td>YAML</td>
</tr>
<tr>
<td><strong>Matrix testing</strong></td>
<td>Excellent</td>
<td>Good</td>
<td>Good</td>
<td>Good</td>
<td>Excellent</td>
<td>Excellent</td>
</tr>
<tr>
<td><strong>Docker support</strong></td>
<td>Good</td>
<td>Excellent</td>
<td>Good</td>
<td>Excellent</td>
<td>Good</td>
<td>Good</td>
</tr>
<tr>
<td><strong>Learning curve</strong></td>
<td>Low</td>
<td>Low</td>
<td>High</td>
<td>Low</td>
<td>Low</td>
<td>Medium</td>
</tr>
</tbody>
</table>
<h3 id="when-to-choose-each">When to Choose Each</h3>
<p><strong>GitHub Actions</strong>: You're already on GitHub and want zero setup.</p>
<p><strong>GitLab CI</strong>: You're on GitLab or need self-hosted CI with excellent Docker support.</p>
<p><strong>Jenkins</strong>: You need complete control, have complex requirements, or must run on-premises.</p>
<p><strong>CircleCI</strong>: You want powerful features with minimal configuration.</p>
<p><strong>Travis CI</strong>: You're building open-source projects and want simplicity.</p>
<p><strong>Azure Pipelines</strong>: You're in the Microsoft ecosystem or need Azure integration.</p>
<h3 id="universal-best-practices">Universal Best Practices</h3>
<p>Regardless of which CI system you choose:</p>
<ol>
<li><strong>Pin dependencies</strong>: Use exact versions in <code>requirements.txt</code></li>
<li><strong>Test multiple Python versions</strong>: Don't assume your version is the only one</li>
<li><strong>Cache dependencies</strong>: Speed up builds significantly</li>
<li><strong>Fail fast</strong>: Stop on first failure to save time</li>
<li><strong>Parallel execution</strong>: Run tests and linting simultaneously</li>
<li><strong>Artifacts</strong>: Save test results and coverage reports</li>
<li><strong>Clear naming</strong>: Use descriptive job/stage names</li>
<li><strong>Documentation</strong>: Comment complex pipeline logic</li>
</ol>
<h2 id="generating-test-reports">Generating Test Reports</h2>
<h2 id="the-problem-test-output-disappears">The Problem: Test Output Disappears</h2>
<p>When tests run in CI, the output scrolls by in the console log. If you have 500 tests, finding the one that failed is painful. You need <strong>persistent, structured test reports</strong> that you can browse, search, and share.</p>
<h3 id="what-makes-a-good-test-report">What Makes a Good Test Report?</h3>
<p>A good test report should:</p>
<ol>
<li><strong>Persist</strong>: Available after the CI run completes</li>
<li><strong>Be browsable</strong>: HTML format with navigation</li>
<li><strong>Show details</strong>: Full failure messages, tracebacks, and context</li>
<li><strong>Track trends</strong>: Compare results across runs</li>
<li><strong>Be shareable</strong>: Send a link to teammates</li>
</ol>
<h3 id="the-reference-implementation-enhanced-payment-processor">The Reference Implementation: Enhanced Payment Processor</h3>
<p>Let's add more tests to our payment processor to generate meaningful reports:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_payment_processor_extended.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentProcessor</span><span class="p">,</span> <span class="n">PaymentGateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a mock payment gateway.&quot;&quot;&quot;</span>
    <span class="n">gateway</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">PaymentGateway</span><span class="p">)</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;succeeded&quot;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">gateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">processor</span><span class="p">(</span><span class="n">mock_gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a payment processor with mocked gateway.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">mock_gateway</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestPaymentValidation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test payment amount validation.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_minimum_amount_accepted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that minimum amount is accepted.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.50&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_below_minimum_rejected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that below minimum is rejected.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.49&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_zero_amount_rejected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that zero amount is rejected.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.00&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_negative_amount_rejected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that negative amount is rejected.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;-10.00&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestPaymentProcessing</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test successful payment processing.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_small_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">,</span> <span class="n">mock_gateway</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test processing a small payment.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1.00&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;txn_12345&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_large_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">,</span> <span class="n">mock_gateway</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test processing a large payment.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;9999.99&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_gateway_receives_correct_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">,</span> <span class="n">mock_gateway</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that gateway receives the exact amount.&quot;&quot;&quot;</span>
        <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;42.50&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>
        <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;42.50&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestErrorHandling</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test error handling scenarios.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_network_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">,</span> <span class="n">mock_gateway</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test handling of network timeout.&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
        <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Timeout</span><span class="p">(</span><span class="s2">&quot;Connection timeout&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.00&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
        <span class="k">assert</span> <span class="s2">&quot;gateway error&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_connection_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">,</span> <span class="n">mock_gateway</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test handling of connection error.&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
        <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(</span><span class="s2">&quot;Cannot connect&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.00&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_http_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">,</span> <span class="n">mock_gateway</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test handling of HTTP error.&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
        <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;500 Server Error&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.00&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;amount,expected&quot;</span><span class="p">,</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.50&quot;</span><span class="p">),</span> <span class="kc">True</span><span class="p">),</span>
    <span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1.00&quot;</span><span class="p">),</span> <span class="kc">True</span><span class="p">),</span>
    <span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span> <span class="kc">True</span><span class="p">),</span>
    <span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.49&quot;</span><span class="p">),</span> <span class="kc">False</span><span class="p">),</span>
    <span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.00&quot;</span><span class="p">),</span> <span class="kc">False</span><span class="p">),</span>
<span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_amount_validation_parametrized</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test amount validation with multiple values.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected</span>
</code></pre></div>

<p>Now we have 15 tests organized into classes. Let's generate reports for them.</p>
<h2 id="iteration-1-junit-xml-reports">Iteration 1: JUnit XML Reports</h2>
<p>JUnit XML is the universal format for test results. Every CI system understands it.</p>
<h3 id="generating-junit-xml">Generating JUnit XML</h3>
<p>Pytest has built-in JUnit XML support:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/<span class="w"> </span>--junitxml<span class="o">=</span>report.xml<span class="w"> </span>-v
<span class="o">========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">=========================</span>
collected<span class="w"> </span><span class="m">15</span><span class="w"> </span>items

tests/test_payment_processor_extended.py::TestPaymentValidation::test_minimum_amount_accepted<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w">  </span><span class="m">6</span>%<span class="o">]</span>
tests/test_payment_processor_extended.py::TestPaymentValidation::test_below_minimum_rejected<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">13</span>%<span class="o">]</span>
tests/test_payment_processor_extended.py::TestPaymentValidation::test_zero_amount_rejected<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">20</span>%<span class="o">]</span>
tests/test_payment_processor_extended.py::TestPaymentValidation::test_negative_amount_rejected<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">26</span>%<span class="o">]</span>
tests/test_payment_processor_extended.py::TestPaymentProcessing::test_small_payment<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">33</span>%<span class="o">]</span>
tests/test_payment_processor_extended.py::TestPaymentProcessing::test_large_payment<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">40</span>%<span class="o">]</span>
tests/test_payment_processor_extended.py::TestPaymentProcessing::test_gateway_receives_correct_amount<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">46</span>%<span class="o">]</span>
tests/test_payment_processor_extended.py::TestErrorHandling::test_network_timeout<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">53</span>%<span class="o">]</span>
tests/test_payment_processor_extended.py::TestErrorHandling::test_connection_error<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">60</span>%<span class="o">]</span>
tests/test_payment_processor_extended.py::TestErrorHandling::test_http_error<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">66</span>%<span class="o">]</span>
tests/test_payment_processor_extended.py::test_amount_validation_parametrized<span class="o">[</span><span class="m">0</span>.50-True<span class="o">]</span><span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">73</span>%<span class="o">]</span>
tests/test_payment_processor_extended.py::test_amount_validation_parametrized<span class="o">[</span><span class="m">1</span>.00-True<span class="o">]</span><span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">80</span>%<span class="o">]</span>
tests/test_payment_processor_extended.py::test_amount_validation_parametrized<span class="o">[</span><span class="m">100</span>.00-True<span class="o">]</span><span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">86</span>%<span class="o">]</span>
tests/test_payment_processor_extended.py::test_amount_validation_parametrized<span class="o">[</span><span class="m">0</span>.49-False<span class="o">]</span><span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">93</span>%<span class="o">]</span>
tests/test_payment_processor_extended.py::test_amount_validation_parametrized<span class="o">[</span><span class="m">0</span>.00-False<span class="o">]</span><span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">=========================</span><span class="w"> </span><span class="m">15</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.23s<span class="w"> </span><span class="o">=========================</span>
</code></pre></div>

<h3 id="understanding-the-junit-xml-format">Understanding the JUnit XML Format</h3>
<p>The generated <code>report.xml</code> looks like this:</p>
<div class="codehilite"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;testsuites&gt;</span>
<span class="w">  </span><span class="nt">&lt;testsuite</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;pytest&quot;</span><span class="w"> </span><span class="na">errors=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">failures=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">skipped=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">tests=</span><span class="s">&quot;15&quot;</span><span class="w"> </span><span class="na">time=</span><span class="s">&quot;0.234&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;testcase</span><span class="w"> </span><span class="na">classname=</span><span class="s">&quot;tests.test_payment_processor_extended.TestPaymentValidation&quot;</span><span class="w"> </span>
<span class="w">              </span><span class="na">name=</span><span class="s">&quot;test_minimum_amount_accepted&quot;</span><span class="w"> </span>
<span class="w">              </span><span class="na">time=</span><span class="s">&quot;0.012&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;testcase</span><span class="w"> </span><span class="na">classname=</span><span class="s">&quot;tests.test_payment_processor_extended.TestPaymentValidation&quot;</span><span class="w"> </span>
<span class="w">              </span><span class="na">name=</span><span class="s">&quot;test_below_minimum_rejected&quot;</span><span class="w"> </span>
<span class="w">              </span><span class="na">time=</span><span class="s">&quot;0.008&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- More test cases... --&gt;</span>
<span class="w">    </span><span class="nt">&lt;testcase</span><span class="w"> </span><span class="na">classname=</span><span class="s">&quot;tests.test_payment_processor_extended&quot;</span><span class="w"> </span>
<span class="w">              </span><span class="na">name=</span><span class="s">&quot;test_amount_validation_parametrized[0.50-True]&quot;</span><span class="w"> </span>
<span class="w">              </span><span class="na">time=</span><span class="s">&quot;0.011&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/testsuite&gt;</span>
<span class="nt">&lt;/testsuites&gt;</span>
</code></pre></div>

<p><strong>Key elements</strong>:</p>
<ul>
<li><code>&lt;testsuites&gt;</code>: Root element</li>
<li><code>&lt;testsuite&gt;</code>: A collection of tests (usually one per file)</li>
<li><code>&lt;testcase&gt;</code>: Individual test with name, class, and execution time</li>
<li>Attributes: <code>errors</code>, <code>failures</code>, <code>skipped</code>, <code>tests</code>, <code>time</code></li>
</ul>
<h3 id="when-tests-fail">When Tests Fail</h3>
<p>Let's introduce a failure:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Temporarily break a test</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_small_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">,</span> <span class="n">mock_gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test processing a small payment.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1.00&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;WRONG_ID&quot;</span>  <span class="c1"># This will fail</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/<span class="w"> </span>--junitxml<span class="o">=</span>report.xml<span class="w"> </span>-v
<span class="o">========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">=========================</span>
collected<span class="w"> </span><span class="m">15</span><span class="w"> </span>items

tests/test_payment_processor_extended.py::TestPaymentValidation::test_minimum_amount_accepted<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w">  </span><span class="m">6</span>%<span class="o">]</span>
tests/test_payment_processor_extended.py::TestPaymentValidation::test_below_minimum_rejected<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">13</span>%<span class="o">]</span>
tests/test_payment_processor_extended.py::TestPaymentValidation::test_zero_amount_rejected<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">20</span>%<span class="o">]</span>
tests/test_payment_processor_extended.py::TestPaymentValidation::test_negative_amount_rejected<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">26</span>%<span class="o">]</span>
tests/test_payment_processor_extended.py::TestPaymentProcessing::test_small_payment<span class="w"> </span>FAILED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">33</span>%<span class="o">]</span>

<span class="o">==============================</span><span class="w"> </span><span class="nv">FAILURES</span><span class="w"> </span><span class="o">==============================</span>
______________<span class="w"> </span>TestPaymentProcessing.test_small_payment<span class="w"> </span>______________

<span class="nv">self</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>&lt;tests.test_payment_processor_extended.TestPaymentProcessing<span class="w"> </span>object<span class="w"> </span>at<span class="w"> </span>0x7f8b3c&gt;
<span class="nv">processor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>&lt;src.payment_processor.PaymentProcessor<span class="w"> </span>object<span class="w"> </span>at<span class="w"> </span>0x7f8b4d&gt;
<span class="nv">mock_gateway</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>&lt;Mock<span class="w"> </span><span class="nv">spec</span><span class="o">=</span><span class="s1">&#39;PaymentGateway&#39;</span><span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s1">&#39;140234567890&#39;</span>&gt;

<span class="w">    </span>def<span class="w"> </span>test_small_payment<span class="o">(</span>self,<span class="w"> </span>processor,<span class="w"> </span>mock_gateway<span class="o">)</span>:
<span class="w">        </span><span class="s2">&quot;&quot;&quot;Test processing a small payment.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>processor.process_payment<span class="o">(</span>Decimal<span class="o">(</span><span class="s2">&quot;1.00&quot;</span><span class="o">)</span>,<span class="w"> </span><span class="s2">&quot;card_tok_visa&quot;</span><span class="o">)</span>
<span class="w">        </span>assert<span class="w"> </span>result<span class="o">[</span><span class="s2">&quot;success&quot;</span><span class="o">]</span><span class="w"> </span>is<span class="w"> </span>True
&gt;<span class="w">       </span>assert<span class="w"> </span>result<span class="o">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;WRONG_ID&quot;</span>
E<span class="w">       </span>AssertionError:<span class="w"> </span>assert<span class="w"> </span><span class="s1">&#39;txn_12345&#39;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;WRONG_ID&#39;</span>
E<span class="w">         </span>-<span class="w"> </span>WRONG_ID
E<span class="w">         </span>+<span class="w"> </span>txn_12345

tests/test_payment_processor_extended.py:58:<span class="w"> </span><span class="nv">AssertionError</span>
<span class="o">=====================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>failed,<span class="w"> </span><span class="m">14</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.25s<span class="w"> </span><span class="o">====================</span>
</code></pre></div>

<p>The JUnit XML now includes the failure:</p>
<div class="codehilite"><pre><span></span><code><span class="nt">&lt;testcase</span><span class="w"> </span><span class="na">classname=</span><span class="s">&quot;tests.test_payment_processor_extended.TestPaymentProcessing&quot;</span><span class="w"> </span>
<span class="w">          </span><span class="na">name=</span><span class="s">&quot;test_small_payment&quot;</span><span class="w"> </span>
<span class="w">          </span><span class="na">time=</span><span class="s">&quot;0.015&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;failure</span><span class="w"> </span><span class="na">message=</span><span class="s">&quot;AssertionError: assert &#39;txn_12345&#39; == &#39;WRONG_ID&#39;&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cp">&lt;![CDATA[</span>
<span class="cp">self = &lt;tests.test_payment_processor_extended.TestPaymentProcessing object at 0x7f8b3c&gt;</span>
<span class="cp">processor = &lt;src.payment_processor.PaymentProcessor object at 0x7f8b4d&gt;</span>
<span class="cp">mock_gateway = &lt;Mock spec=&#39;PaymentGateway&#39; id=&#39;140234567890&#39;&gt;</span>

<span class="cp">    def test_small_payment(self, processor, mock_gateway):</span>
<span class="cp">        &quot;&quot;&quot;Test processing a small payment.&quot;&quot;&quot;</span>
<span class="cp">        result = processor.process_payment(Decimal(&quot;1.00&quot;), &quot;card_tok_visa&quot;)</span>
<span class="cp">        assert result[&quot;success&quot;] is True</span>
<span class="cp">&gt;       assert result[&quot;transaction_id&quot;] == &quot;WRONG_ID&quot;</span>
<span class="cp">E       AssertionError: assert &#39;txn_12345&#39; == &#39;WRONG_ID&#39;</span>
<span class="cp">E         - WRONG_ID</span>
<span class="cp">E         + txn_12345</span>

<span class="cp">tests/test_payment_processor_extended.py:58: AssertionError</span>
<span class="cp">    ]]&gt;</span>
<span class="w">  </span><span class="nt">&lt;/failure&gt;</span>
<span class="nt">&lt;/testcase&gt;</span>
</code></pre></div>

<p>CI systems parse this XML and display it in their UI with:
- Test names
- Pass/fail status
- Execution time
- Full failure messages
- Trends over time</p>
<h2 id="iteration-2-html-reports-with-pytest-html">Iteration 2: HTML Reports with pytest-html</h2>
<p>JUnit XML is machine-readable but not human-friendly. HTML reports are much better for browsing.</p>
<h3 id="installing-pytest-html">Installing pytest-html</h3>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pytest-html
</code></pre></div>

<h3 id="generating-html-reports">Generating HTML Reports</h3>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/<span class="w"> </span>--html<span class="o">=</span>report.html<span class="w"> </span>--self-contained-html<span class="w"> </span>-v
<span class="o">========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">=========================</span>
collected<span class="w"> </span><span class="m">15</span><span class="w"> </span>items

tests/test_payment_processor_extended.py::TestPaymentValidation::test_minimum_amount_accepted<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w">  </span><span class="m">6</span>%<span class="o">]</span>
tests/test_payment_processor_extended.py::TestPaymentValidation::test_below_minimum_rejected<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">13</span>%<span class="o">]</span>
<span class="o">[</span>...<span class="w"> </span>all<span class="w"> </span>tests<span class="w"> </span>...<span class="o">]</span>
<span class="o">=========================</span><span class="w"> </span><span class="m">15</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.23s<span class="w"> </span><span class="o">=========================</span>

Generated<span class="w"> </span>html<span class="w"> </span>report:<span class="w"> </span>file:///path/to/report.html
</code></pre></div>

<p><strong><code>--html=report.html</code></strong>: Generate HTML report.</p>
<p><strong><code>--self-contained-html</code></strong>: Embed CSS/JS in the HTML file (single file, easy to share).</p>
<h3 id="what-the-html-report-contains">What the HTML Report Contains</h3>
<p>Open <code>report.html</code> in a browser to see:</p>
<p><strong>Summary section</strong>:
- Total tests: 15
- Passed: 15
- Failed: 0
- Skipped: 0
- Errors: 0
- Duration: 0.23s</p>
<p><strong>Test results table</strong>:
| Test                                                                 | Result | Duration |
| -------------------------------------------------------------------- | ------ | -------- |
| tests/...::TestPaymentValidation::test_minimum_amount_accepted       | Passed | 0.012s   |
| tests/...::TestPaymentValidation::test_below_minimum_rejected        | Passed | 0.008s   |
| tests/...::TestPaymentProcessing::test_small_payment                 | Passed | 0.015s   |
| tests/...::test_amount_validation_parametrized[0.50-True]            | Passed | 0.011s   |</p>
<p><strong>Interactive features</strong>:
- Click test names to expand details
- Filter by status (passed/failed/skipped)
- Sort by duration
- Search test names</p>
<h3 id="when-tests-fail_1">When Tests Fail</h3>
<p>With the same failure from before, the HTML report shows:</p>
<div class="codehilite"><pre><span></span><code><span class="cm">&lt;!-- Simplified HTML structure --&gt;</span>
<span class="p">&lt;</span><span class="nt">tr</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;failed&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>tests/...::TestPaymentProcessing::test_small_payment<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">td</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-result&quot;</span><span class="p">&gt;</span>Failed<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">td</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-duration&quot;</span><span class="p">&gt;</span>0.015s<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">tr</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;extra&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">td</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;3&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;log&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">pre</span><span class="p">&gt;</span>
self = <span class="ni">&amp;lt;</span>tests.test_payment_processor_extended.TestPaymentProcessing object at 0x7f8b3c<span class="ni">&amp;gt;</span>
processor = <span class="ni">&amp;lt;</span>src.payment_processor.PaymentProcessor object at 0x7f8b4d<span class="ni">&amp;gt;</span>
mock_gateway = <span class="ni">&amp;lt;</span>Mock spec=&#39;PaymentGateway&#39; id=&#39;140234567890&#39;<span class="ni">&amp;gt;</span>

    def test_small_payment(self, processor, mock_gateway):
        &quot;&quot;&quot;Test processing a small payment.&quot;&quot;&quot;
        result = processor.process_payment(Decimal(&quot;1.00&quot;), &quot;card_tok_visa&quot;)
        assert result[&quot;success&quot;] is True
<span class="ni">&amp;gt;</span>       assert result[&quot;transaction_id&quot;] == &quot;WRONG_ID&quot;
E       AssertionError: assert &#39;txn_12345&#39; == &#39;WRONG_ID&#39;
E         - WRONG_ID
E         + txn_12345

tests/test_payment_processor_extended.py:58: AssertionError
      <span class="p">&lt;/</span><span class="nt">pre</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
</code></pre></div>

<p>The failure is highlighted in red, and clicking it expands the full traceback.</p>
<h2 id="iteration-3-combining-reports-with-coverage">Iteration 3: Combining Reports with Coverage</h2>
<p>Generate both test results and coverage in one command:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--html<span class="o">=</span>report.html<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--self-contained-html<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--cov<span class="o">=</span>src<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--cov-report<span class="o">=</span>html<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--cov-report<span class="o">=</span>term<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--junitxml<span class="o">=</span>junit.xml<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v
<span class="o">========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">=========================</span>
collected<span class="w"> </span><span class="m">15</span><span class="w"> </span>items

tests/test_payment_processor_extended.py::TestPaymentValidation::test_minimum_amount_accepted<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w">  </span><span class="m">6</span>%<span class="o">]</span>
<span class="o">[</span>...<span class="w"> </span>all<span class="w"> </span>tests<span class="w"> </span>...<span class="o">]</span>
<span class="o">=========================</span><span class="w"> </span><span class="m">15</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.23s<span class="w"> </span><span class="o">=========================</span>

----------<span class="w"> </span>coverage:<span class="w"> </span>platform<span class="w"> </span>linux,<span class="w"> </span>python<span class="w"> </span><span class="m">3</span>.11.2<span class="w"> </span>-----------
Name<span class="w">                            </span>Stmts<span class="w">   </span>Miss<span class="w">  </span>Cover
---------------------------------------------------
src/payment_processor.py<span class="w">           </span><span class="m">45</span><span class="w">      </span><span class="m">2</span><span class="w">    </span><span class="m">96</span>%
---------------------------------------------------
TOTAL<span class="w">                              </span><span class="m">45</span><span class="w">      </span><span class="m">2</span><span class="w">    </span><span class="m">96</span>%

Generated<span class="w"> </span>html<span class="w"> </span>report:<span class="w"> </span>file:///path/to/report.html
Generated<span class="w"> </span>coverage<span class="w"> </span>html<span class="w"> </span>report:<span class="w"> </span>file:///path/to/htmlcov/index.html
</code></pre></div>

<p>Now you have:
- <code>report.html</code>: Test results
- <code>htmlcov/index.html</code>: Coverage report
- <code>junit.xml</code>: Machine-readable test results</p>
<h3 id="integrating-with-ci">Integrating with CI</h3>
<p>In your CI configuration, generate reports and save them as artifacts:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .github/workflows/test.yml (excerpt)</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests with reports</span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">pytest tests/ \</span>
<span class="w">      </span><span class="no">--html=report.html \</span>
<span class="w">      </span><span class="no">--self-contained-html \</span>
<span class="w">      </span><span class="no">--cov=src \</span>
<span class="w">      </span><span class="no">--cov-report=html \</span>
<span class="w">      </span><span class="no">--junitxml=junit.xml \</span>
<span class="w">      </span><span class="no">-v</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload test results</span>
<span class="w">  </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always()</span>
<span class="w">  </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/upload-artifact@v3</span>
<span class="w">  </span><span class="nt">with</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-reports</span>
<span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">      </span><span class="no">report.html</span>
<span class="w">      </span><span class="no">junit.xml</span>
<span class="w">      </span><span class="no">htmlcov/</span>
</code></pre></div>

<p>After the CI run, you can:
1. Download the artifacts from the GitHub Actions UI
2. Open <code>report.html</code> locally
3. Browse <code>htmlcov/index.html</code> for coverage details</p>
<h2 id="iteration-4-advanced-reporting-with-allure">Iteration 4: Advanced Reporting with Allure</h2>
<p>Allure is a powerful reporting framework with rich features:</p>
<ul>
<li><strong>Test history</strong>: Compare results across runs</li>
<li><strong>Categorization</strong>: Group tests by feature, severity, etc.</li>
<li><strong>Attachments</strong>: Screenshots, logs, API responses</li>
<li><strong>Trends</strong>: Graphs showing test stability over time</li>
</ul>
<h3 id="installing-allure">Installing Allure</h3>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>allure-pytest
</code></pre></div>

<h3 id="generating-allure-reports">Generating Allure Reports</h3>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/<span class="w"> </span>--alluredir<span class="o">=</span>allure-results<span class="w"> </span>-v
<span class="o">========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">=========================</span>
collected<span class="w"> </span><span class="m">15</span><span class="w"> </span>items

tests/test_payment_processor_extended.py::TestPaymentValidation::test_minimum_amount_accepted<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w">  </span><span class="m">6</span>%<span class="o">]</span>
<span class="o">[</span>...<span class="w"> </span>all<span class="w"> </span>tests<span class="w"> </span>...<span class="o">]</span>
<span class="o">=========================</span><span class="w"> </span><span class="m">15</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.23s<span class="w"> </span><span class="o">=========================</span>
</code></pre></div>

<p>This creates <code>allure-results/</code> with JSON files. To view the report, you need the Allure command-line tool:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Install Allure (requires Java)</span>
$<span class="w"> </span>brew<span class="w"> </span>install<span class="w"> </span>allure<span class="w">  </span><span class="c1"># macOS</span>
$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>allure<span class="w">  </span><span class="c1"># Ubuntu</span>

<span class="c1"># Generate and open the report</span>
$<span class="w"> </span>allure<span class="w"> </span>serve<span class="w"> </span>allure-results
Generating<span class="w"> </span>report...
Report<span class="w"> </span>successfully<span class="w"> </span>generated<span class="w"> </span>to<span class="w"> </span>/tmp/allure-report
Starting<span class="w"> </span>web<span class="w"> </span>server...
Server<span class="w"> </span>started<span class="w"> </span>at<span class="w"> </span>http://localhost:8080
</code></pre></div>

<h3 id="enhancing-tests-with-allure-decorators">Enhancing Tests with Allure Decorators</h3>
<p>Allure provides decorators to add metadata:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_payment_processor_allure.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">allure</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentProcessor</span><span class="p">,</span> <span class="n">PaymentGateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a mock payment gateway.&quot;&quot;&quot;</span>
    <span class="n">gateway</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">PaymentGateway</span><span class="p">)</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;txn_12345&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;succeeded&quot;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">gateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">processor</span><span class="p">(</span><span class="n">mock_gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a payment processor with mocked gateway.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">mock_gateway</span><span class="p">)</span>

<span class="nd">@allure</span><span class="o">.</span><span class="n">feature</span><span class="p">(</span><span class="s2">&quot;Payment Validation&quot;</span><span class="p">)</span>
<span class="nd">@allure</span><span class="o">.</span><span class="n">story</span><span class="p">(</span><span class="s2">&quot;Amount Validation&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TestPaymentValidation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test payment amount validation.&quot;&quot;&quot;</span>

    <span class="nd">@allure</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Minimum amount should be accepted&quot;</span><span class="p">)</span>
    <span class="nd">@allure</span><span class="o">.</span><span class="n">severity</span><span class="p">(</span><span class="n">allure</span><span class="o">.</span><span class="n">severity_level</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_minimum_amount_accepted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that minimum amount is accepted.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">allure</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="s2">&quot;Process payment with minimum amount&quot;</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.50&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">allure</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="s2">&quot;Verify payment succeeded&quot;</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>

    <span class="nd">@allure</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Below minimum amount should be rejected&quot;</span><span class="p">)</span>
    <span class="nd">@allure</span><span class="o">.</span><span class="n">severity</span><span class="p">(</span><span class="n">allure</span><span class="o">.</span><span class="n">severity_level</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_below_minimum_rejected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that below minimum is rejected.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">allure</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="s2">&quot;Process payment below minimum&quot;</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.49&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">allure</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="s2">&quot;Verify payment was rejected&quot;</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
            <span class="k">assert</span> <span class="s2">&quot;at least&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>

<span class="nd">@allure</span><span class="o">.</span><span class="n">feature</span><span class="p">(</span><span class="s2">&quot;Payment Processing&quot;</span><span class="p">)</span>
<span class="nd">@allure</span><span class="o">.</span><span class="n">story</span><span class="p">(</span><span class="s2">&quot;Successful Payments&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TestPaymentProcessing</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test successful payment processing.&quot;&quot;&quot;</span>

    <span class="nd">@allure</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Small payment should be processed successfully&quot;</span><span class="p">)</span>
    <span class="nd">@allure</span><span class="o">.</span><span class="n">severity</span><span class="p">(</span><span class="n">allure</span><span class="o">.</span><span class="n">severity_level</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_small_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">,</span> <span class="n">mock_gateway</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test processing a small payment.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">allure</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="s2">&quot;Process $1.00 payment&quot;</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1.00&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">allure</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="s2">&quot;Verify transaction ID returned&quot;</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
            <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;txn_12345&quot;</span>

        <span class="k">with</span> <span class="n">allure</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="s2">&quot;Verify gateway was called correctly&quot;</span><span class="p">):</span>
            <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1.00&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>

<span class="nd">@allure</span><span class="o">.</span><span class="n">feature</span><span class="p">(</span><span class="s2">&quot;Error Handling&quot;</span><span class="p">)</span>
<span class="nd">@allure</span><span class="o">.</span><span class="n">story</span><span class="p">(</span><span class="s2">&quot;Network Errors&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TestErrorHandling</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test error handling scenarios.&quot;&quot;&quot;</span>

    <span class="nd">@allure</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Network timeout should be handled gracefully&quot;</span><span class="p">)</span>
    <span class="nd">@allure</span><span class="o">.</span><span class="n">severity</span><span class="p">(</span><span class="n">allure</span><span class="o">.</span><span class="n">severity_level</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_network_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">,</span> <span class="n">mock_gateway</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test handling of network timeout.&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

        <span class="k">with</span> <span class="n">allure</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="s2">&quot;Configure gateway to timeout&quot;</span><span class="p">):</span>
            <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Timeout</span><span class="p">(</span><span class="s2">&quot;Connection timeout&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">allure</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="s2">&quot;Attempt payment&quot;</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.00&quot;</span><span class="p">),</span> <span class="s2">&quot;card_tok_visa&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">allure</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="s2">&quot;Verify error was handled&quot;</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
            <span class="k">assert</span> <span class="s2">&quot;gateway error&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
            <span class="n">allure</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Error Message&quot;</span><span class="p">,</span> <span class="n">attachment_type</span><span class="o">=</span><span class="n">allure</span><span class="o">.</span><span class="n">attachment_type</span><span class="o">.</span><span class="n">TEXT</span><span class="p">)</span>
</code></pre></div>

<h3 id="understanding-allure-decorators">Understanding Allure Decorators</h3>
<p><strong><code>@allure.feature("Name")</code></strong>: Groups tests by feature (e.g., "Payment Validation").</p>
<p><strong><code>@allure.story("Name")</code></strong>: Sub-groups within a feature (e.g., "Amount Validation").</p>
<p><strong><code>@allure.title("Description")</code></strong>: Human-readable test name.</p>
<p><strong><code>@allure.severity(level)</code></strong>: Priority level (BLOCKER, CRITICAL, NORMAL, MINOR, TRIVIAL).</p>
<p><strong><code>with allure.step("Description"):</code></strong>: Breaks test into logical steps shown in the report.</p>
<p><strong><code>allure.attach(data, name, type)</code></strong>: Attaches data to the report (logs, screenshots, etc.).</p>
<h3 id="the-allure-report-ui">The Allure Report UI</h3>
<p>The Allure report shows:</p>
<p><strong>Overview</strong>:
- Total tests, pass rate, duration
- Trend graph (if you have historical data)
- Environment info (Python version, OS, etc.)</p>
<p><strong>Suites</strong>:
- Tests organized by file/class
- Expandable to show individual tests</p>
<p><strong>Graphs</strong>:
- Tests by feature
- Tests by severity
- Tests by duration</p>
<p><strong>Timeline</strong>:
- Visual timeline of test execution
- Shows parallel execution</p>
<p><strong>Behaviors</strong>:
- Tests grouped by feature ‚Üí story
- Easy to see coverage of each feature</p>
<p><strong>Test details</strong>:
- Steps with pass/fail status
- Attachments (logs, screenshots)
- Full traceback for failures
- Execution time</p>
<h2 id="iteration-5-integrating-reports-in-ci">Iteration 5: Integrating Reports in CI</h2>
<h3 id="github-actions-with-allure">GitHub Actions with Allure</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># .github/workflows/test.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Tests with Allure</span>

<span class="nt">on</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">push</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">pull_request</span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">test</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set up Python</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-python@v4</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.11&#39;</span>
<span class="w">          </span><span class="nt">cache</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;pip&#39;</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pip install -r requirements.txt</span>
<span class="w">          </span><span class="no">pip install pytest-cov allure-pytest</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pytest tests/ \</span>
<span class="w">            </span><span class="no">--alluredir=allure-results \</span>
<span class="w">            </span><span class="no">--cov=src \</span>
<span class="w">            </span><span class="no">--cov-report=xml \</span>
<span class="w">            </span><span class="no">-v</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload test results</span>
<span class="w">        </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always()</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/upload-artifact@v3</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">allure-results</span>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">allure-results/</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Generate Allure report</span>
<span class="w">        </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always()</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">simple-elf/allure-report-action@master</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">allure_results</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">allure-results</span>
<span class="w">          </span><span class="nt">allure_history</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">allure-history</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deploy report to GitHub Pages</span>
<span class="w">        </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always()</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">peaceiris/actions-gh-pages@v3</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">github_token</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ secrets.GITHUB_TOKEN }}</span>
<span class="w">          </span><span class="nt">publish_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">allure-history</span>
</code></pre></div>

<p>This workflow:
1. Runs tests and generates Allure results
2. Uploads results as artifacts
3. Generates the Allure HTML report
4. Deploys it to GitHub Pages</p>
<p>After setup, your report is available at: <code>https://yourusername.github.io/yourrepo/</code></p>
<h3 id="gitlab-ci-with-allure">GitLab CI with Allure</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># .gitlab-ci.yml</span>
<span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">report</span>

<span class="nt">test</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.11</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install -r requirements.txt</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install pytest-cov allure-pytest</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pytest tests/ --alluredir=allure-results --cov=src -v</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">allure-results/</span>
<span class="w">    </span><span class="nt">expire_in</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1 week</span>

<span class="nt">allure_report</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">report</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">frankescobar/allure-docker-service:latest</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">allure generate allure-results -o allure-report --clean</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">allure-report/</span>
<span class="w">    </span><span class="nt">expire_in</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1 month</span>
<span class="w">  </span><span class="nt">only</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">main</span>
</code></pre></div>

<h2 id="report-best-practices">Report Best Practices</h2>
<h3 id="1-generate-multiple-report-formats">1. Generate Multiple Report Formats</h3>
<p>Different audiences need different formats:
- <strong>JUnit XML</strong>: For CI system integration
- <strong>HTML</strong>: For human browsing
- <strong>Allure</strong>: For detailed analysis and trends</p>
<p>Generate all three:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--junitxml<span class="o">=</span>junit.xml<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--html<span class="o">=</span>report.html<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--self-contained-html<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--alluredir<span class="o">=</span>allure-results<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--cov<span class="o">=</span>src<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--cov-report<span class="o">=</span>html<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v
</code></pre></div>

<h3 id="2-always-upload-reports-as-artifacts">2. Always Upload Reports as Artifacts</h3>
<p>Even if tests pass, save reports for future reference:</p>
<div class="codehilite"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload reports</span>
<span class="w">  </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always()</span><span class="w">  </span><span class="c1"># Run even if tests fail</span>
<span class="w">  </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/upload-artifact@v3</span>
<span class="w">  </span><span class="nt">with</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-reports</span>
<span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">      </span><span class="no">junit.xml</span>
<span class="w">      </span><span class="no">report.html</span>
<span class="w">      </span><span class="no">allure-results/</span>
<span class="w">      </span><span class="no">htmlcov/</span>
</code></pre></div>

<h3 id="3-set-retention-policies">3. Set Retention Policies</h3>
<p>Don't keep reports forever:
- <strong>Test results</strong>: 1 week
- <strong>Coverage reports</strong>: 1 month
- <strong>Allure history</strong>: Keep indefinitely (for trends)</p>
<h3 id="4-make-reports-accessible">4. Make Reports Accessible</h3>
<p>Options for sharing reports:
1. <strong>Artifacts</strong>: Download from CI UI
2. <strong>GitHub Pages</strong>: Deploy to a public URL
3. <strong>S3/Cloud Storage</strong>: Upload to a bucket
4. <strong>Report Portal</strong>: Dedicated test reporting service</p>
<h3 id="5-add-context-to-reports">5. Add Context to Reports</h3>
<p>Use Allure decorators to add:
- Feature/story grouping
- Severity levels
- Test steps
- Attachments (logs, screenshots)</p>
<p>This makes reports much more useful for debugging and analysis.</p>
<h3 id="6-track-trends-over-time">6. Track Trends Over Time</h3>
<p>Keep historical data to see:
- Is test stability improving?
- Are tests getting slower?
- Which tests are flaky?</p>
<p>Allure's history feature does this automatically if you preserve the <code>allure-history/</code> directory between runs.</p>
<h2 id="automated-testing-on-multiple-python-versions-tox">Automated Testing on Multiple Python Versions (tox)</h2>
<h2 id="the-problem-version-fragmentation">The Problem: Version Fragmentation</h2>
<p>Your code works on Python 3.11. But your users run:
- Python 3.9 (still common in enterprise)
- Python 3.10 (stable release)
- Python 3.11 (your version)
- Python 3.12 (latest)</p>
<p>Each version has subtle differences. A feature you use might not exist in 3.9. A deprecated API might break in 3.12. <strong>You need to test all versions locally before pushing to CI.</strong></p>
<h3 id="what-is-tox">What Is Tox?</h3>
<p>Tox is a tool for testing Python packages across multiple environments. It:
1. Creates isolated virtual environments for each Python version
2. Installs your package and dependencies in each environment
3. Runs your tests in each environment
4. Reports results for all environments</p>
<p>Think of tox as "CI on your local machine."</p>
<h3 id="installing-tox">Installing Tox</h3>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>tox
</code></pre></div>

<h2 id="iteration-1-the-minimal-toxini">Iteration 1: The Minimal tox.ini</h2>
<p>Tox is configured via <code>tox.ini</code> in your project root:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tox.ini</span>
<span class="k">[tox]</span>
<span class="na">envlist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">py39,py310,py311,py312</span>

<span class="k">[testenv]</span>
<span class="na">deps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">pytest</span>
<span class="w">    </span><span class="na">requests</span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">pytest tests/ -v</span>
</code></pre></div>

<h3 id="understanding-toxini-structure">Understanding tox.ini Structure</h3>
<p><strong><code>[tox]</code> section</strong>: Global configuration.</p>
<p><strong><code>envlist</code></strong>: List of environments to test. <code>py39</code> means Python 3.9, <code>py310</code> means Python 3.10, etc.</p>
<p><strong><code>[testenv]</code> section</strong>: Configuration for all test environments.</p>
<p><strong><code>deps</code></strong>: Dependencies to install in each environment.</p>
<p><strong><code>commands</code></strong>: Commands to run in each environment.</p>
<h3 id="running-tox">Running Tox</h3>
<p>Simply run <code>tox</code>:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>tox
py39:<span class="w"> </span>install_deps&gt;<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pytest<span class="w"> </span>requests
py39:<span class="w"> </span>commands<span class="o">[</span><span class="m">0</span><span class="o">]</span>&gt;<span class="w"> </span>pytest<span class="w"> </span>tests/<span class="w"> </span>-v
<span class="o">========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">=========================</span>
platform<span class="w"> </span>linux<span class="w"> </span>--<span class="w"> </span>Python<span class="w"> </span><span class="m">3</span>.9.16,<span class="w"> </span>pytest-7.4.3
collected<span class="w"> </span><span class="m">15</span><span class="w"> </span>items

tests/test_payment_processor_extended.py::TestPaymentValidation::test_minimum_amount_accepted<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w">  </span><span class="m">6</span>%<span class="o">]</span>
<span class="o">[</span>...<span class="w"> </span>all<span class="w"> </span>tests<span class="w"> </span>...<span class="o">]</span>
<span class="o">=========================</span><span class="w"> </span><span class="m">15</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.23s<span class="w"> </span><span class="o">=========================</span>
py39:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.45<span class="w"> </span>seconds

py310:<span class="w"> </span>install_deps&gt;<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pytest<span class="w"> </span>requests
py310:<span class="w"> </span>commands<span class="o">[</span><span class="m">0</span><span class="o">]</span>&gt;<span class="w"> </span>pytest<span class="w"> </span>tests/<span class="w"> </span>-v
<span class="o">========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">=========================</span>
platform<span class="w"> </span>linux<span class="w"> </span>--<span class="w"> </span>Python<span class="w"> </span><span class="m">3</span>.10.11,<span class="w"> </span>pytest-7.4.3
collected<span class="w"> </span><span class="m">15</span><span class="w"> </span>items
<span class="o">[</span>...<span class="w"> </span>all<span class="w"> </span>tests<span class="w"> </span>...<span class="o">]</span>
<span class="o">=========================</span><span class="w"> </span><span class="m">15</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.21s<span class="w"> </span><span class="o">=========================</span>
py310:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.12<span class="w"> </span>seconds

py311:<span class="w"> </span>install_deps&gt;<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pytest<span class="w"> </span>requests
py311:<span class="w"> </span>commands<span class="o">[</span><span class="m">0</span><span class="o">]</span>&gt;<span class="w"> </span>pytest<span class="w"> </span>tests/<span class="w"> </span>-v
<span class="o">========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">=========================</span>
platform<span class="w"> </span>linux<span class="w"> </span>--<span class="w"> </span>Python<span class="w"> </span><span class="m">3</span>.11.2,<span class="w"> </span>pytest-7.4.3
collected<span class="w"> </span><span class="m">15</span><span class="w"> </span>items
<span class="o">[</span>...<span class="w"> </span>all<span class="w"> </span>tests<span class="w"> </span>...<span class="o">]</span>
<span class="o">=========================</span><span class="w"> </span><span class="m">15</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.22s<span class="w"> </span><span class="o">=========================</span>
py311:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.08<span class="w"> </span>seconds

py312:<span class="w"> </span>install_deps&gt;<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pytest<span class="w"> </span>requests
py312:<span class="w"> </span>commands<span class="o">[</span><span class="m">0</span><span class="o">]</span>&gt;<span class="w"> </span>pytest<span class="w"> </span>tests/<span class="w"> </span>-v
<span class="o">========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">=========================</span>
platform<span class="w"> </span>linux<span class="w"> </span>--<span class="w"> </span>Python<span class="w"> </span><span class="m">3</span>.12.0,<span class="w"> </span>pytest-7.4.3
collected<span class="w"> </span><span class="m">15</span><span class="w"> </span>items
<span class="o">[</span>...<span class="w"> </span>all<span class="w"> </span>tests<span class="w"> </span>...<span class="o">]</span>
<span class="o">=========================</span><span class="w"> </span><span class="m">15</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.24s<span class="w"> </span><span class="o">=========================</span>
py312:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.21<span class="w"> </span>seconds

___________________________<span class="w"> </span>summary<span class="w"> </span>___________________________
<span class="w">  </span>py39:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.45<span class="w"> </span>seconds
<span class="w">  </span>py310:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.12<span class="w"> </span>seconds
<span class="w">  </span>py311:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.08<span class="w"> </span>seconds
<span class="w">  </span>py312:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.21<span class="w"> </span>seconds
<span class="w">  </span>congratulations<span class="w"> </span>:<span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="m">12</span>.86<span class="w"> </span>seconds<span class="o">)</span>
</code></pre></div>

<p>Tox automatically:
1. Detected that you have Python 3.9, 3.10, 3.11, and 3.12 installed
2. Created a virtual environment for each
3. Installed dependencies in each
4. Ran tests in each
5. Reported results</p>
<h3 id="when-a-version-fails">When a Version Fails</h3>
<p>Suppose Python 3.9 doesn't support a feature you used:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/payment_processor.py (using Python 3.10+ feature)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">card_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process a payment with validation.&quot;&quot;&quot;</span>
    <span class="c1"># Using match/case (Python 3.10+)</span>
    <span class="k">match</span> <span class="n">amount</span><span class="p">:</span>
        <span class="k">case</span> <span class="n">x</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_amount</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Too small&quot;</span><span class="p">}</span>
        <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
            <span class="c1"># Process payment...</span>
            <span class="k">pass</span>
</code></pre></div>

<p>Tox shows the failure:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>tox
py39:<span class="w"> </span>install_deps&gt;<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pytest<span class="w"> </span>requests
py39:<span class="w"> </span>commands<span class="o">[</span><span class="m">0</span><span class="o">]</span>&gt;<span class="w"> </span>pytest<span class="w"> </span>tests/<span class="w"> </span>-v
<span class="o">========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">=========================</span>
platform<span class="w"> </span>linux<span class="w"> </span>--<span class="w"> </span>Python<span class="w"> </span><span class="m">3</span>.9.16,<span class="w"> </span>pytest-7.4.3
collected<span class="w"> </span><span class="m">0</span><span class="w"> </span>items<span class="w"> </span>/<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nv">error</span>

<span class="o">==============================</span><span class="w"> </span><span class="nv">ERRORS</span><span class="w"> </span><span class="o">===============================</span>
______________<span class="w"> </span>ERROR<span class="w"> </span>collecting<span class="w"> </span>src/payment_processor.py<span class="w"> </span>______________
src/payment_processor.py:25:<span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;
<span class="w">    </span>class<span class="w"> </span>PaymentProcessor:
src/payment_processor.py:32:<span class="w"> </span><span class="k">in</span><span class="w"> </span>PaymentProcessor
<span class="w">    </span>match<span class="w"> </span>amount:
<span class="w">        </span>^
SyntaxError:<span class="w"> </span>invalid<span class="w"> </span><span class="nv">syntax</span>
<span class="o">=====================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>error<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.05s<span class="w"> </span><span class="o">==========================</span>
py39:<span class="w"> </span>FAIL<span class="w"> </span>‚úò<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span>.34<span class="w"> </span>seconds

py310:<span class="w"> </span>install_deps&gt;<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pytest<span class="w"> </span>requests
py310:<span class="w"> </span>commands<span class="o">[</span><span class="m">0</span><span class="o">]</span>&gt;<span class="w"> </span>pytest<span class="w"> </span>tests/<span class="w"> </span>-v
<span class="o">========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">=========================</span>
platform<span class="w"> </span>linux<span class="w"> </span>--<span class="w"> </span>Python<span class="w"> </span><span class="m">3</span>.10.11,<span class="w"> </span>pytest-7.4.3
collected<span class="w"> </span><span class="m">15</span><span class="w"> </span>items
<span class="o">[</span>...<span class="w"> </span>all<span class="w"> </span>tests<span class="w"> </span>pass<span class="w"> </span>...<span class="o">]</span>
py310:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.12<span class="w"> </span>seconds

<span class="o">[</span>...<span class="w"> </span>py311<span class="w"> </span>and<span class="w"> </span>py312<span class="w"> </span>also<span class="w"> </span>pass<span class="w"> </span>...<span class="o">]</span>

___________________________<span class="w"> </span>summary<span class="w"> </span>___________________________
<span class="w">  </span>py39:<span class="w"> </span>FAIL<span class="w"> </span>‚úò<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span>.34<span class="w"> </span>seconds
<span class="w">  </span>py310:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.12<span class="w"> </span>seconds
<span class="w">  </span>py311:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.08<span class="w"> </span>seconds
<span class="w">  </span>py312:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.21<span class="w"> </span>seconds
<span class="w">  </span>evaluation<span class="w"> </span>failed<span class="w"> </span>:<span class="o">(</span><span class="w"> </span><span class="o">(</span><span class="m">11</span>.75<span class="w"> </span>seconds<span class="o">)</span>
</code></pre></div>

<p><strong>Diagnostic Analysis</strong>:</p>
<ol>
<li><strong>The error</strong>: <code>SyntaxError: invalid syntax</code></li>
<li>
<p>What this tells us: Python 3.9 can't parse the code</p>
</li>
<li>
<p><strong>The location</strong>: <code>match amount:</code></p>
</li>
<li>
<p>What this tells us: The <code>match/case</code> statement is the problem</p>
</li>
<li>
<p><strong>Why this happened</strong>:</p>
</li>
<li><code>match/case</code> was introduced in Python 3.10</li>
<li>Python 3.9 doesn't recognize this syntax</li>
</ol>
<p><strong>Root cause identified</strong>: Using a feature not available in all target versions.</p>
<p><strong>Solution</strong>: Either drop Python 3.9 support or use an alternative syntax.</p>
<h2 id="iteration-2-using-requirementstxt">Iteration 2: Using requirements.txt</h2>
<p>Instead of listing dependencies in <code>tox.ini</code>, use your existing <code>requirements.txt</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tox.ini</span>
<span class="k">[tox]</span>
<span class="na">envlist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">py39,py310,py311,py312</span>

<span class="k">[testenv]</span>
<span class="na">deps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">-rrequirements.txt</span>
<span class="w">    </span><span class="na">pytest-cov</span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">pytest tests/ --cov</span><span class="o">=</span><span class="s">src -v</span>
</code></pre></div>

<p><strong><code>-rrequirements.txt</code></strong>: Install dependencies from <code>requirements.txt</code>.</p>
<p><strong>Additional deps</strong>: You can still add extra dependencies (like <code>pytest-cov</code>) that aren't in <code>requirements.txt</code>.</p>
<h2 id="iteration-3-testing-with-different-dependency-versions">Iteration 3: Testing with Different Dependency Versions</h2>
<p>Sometimes you need to test against multiple versions of a dependency:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tox.ini</span>
<span class="k">[tox]</span>
<span class="na">envlist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">py{39,310,311,312}-requests{2.28,2.31}</span>

<span class="k">[testenv]</span>
<span class="na">deps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">pytest</span>
<span class="w">    </span><span class="na">requests2.28</span><span class="o">:</span><span class="w"> </span><span class="s">requests==2.28.0</span>
<span class="w">    </span><span class="na">requests2.31</span><span class="o">:</span><span class="w"> </span><span class="s">requests==2.31.0</span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">pytest tests/ -v</span>
</code></pre></div>

<h3 id="understanding-factor-combinations">Understanding Factor Combinations</h3>
<p><strong><code>py{39,310,311,312}-requests{2.28,2.31}</code></strong>: Creates 8 environments:
- <code>py39-requests2.28</code>: Python 3.9 with requests 2.28.0
- <code>py39-requests2.31</code>: Python 3.9 with requests 2.31.0
- <code>py310-requests2.28</code>: Python 3.10 with requests 2.28.0
- <code>py310-requests2.31</code>: Python 3.10 with requests 2.31.0
- ... and so on</p>
<p><strong><code>requests2.28: requests==2.28.0</code></strong>: Conditional dependency. Only install <code>requests==2.28.0</code> in environments with the <code>requests2.28</code> factor.</p>
<p>Running tox now tests all combinations:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>tox
py39-requests2.28:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.45<span class="w"> </span>seconds
py39-requests2.31:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.12<span class="w"> </span>seconds
py310-requests2.28:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.08<span class="w"> </span>seconds
py310-requests2.31:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.21<span class="w"> </span>seconds
py311-requests2.28:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.15<span class="w"> </span>seconds
py311-requests2.31:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.09<span class="w"> </span>seconds
py312-requests2.28:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.18<span class="w"> </span>seconds
py312-requests2.31:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.14<span class="w"> </span>seconds

___________________________<span class="w"> </span>summary<span class="w"> </span>___________________________
<span class="w">  </span>py39-requests2.28:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.45<span class="w"> </span>seconds
<span class="w">  </span>py39-requests2.31:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.12<span class="w"> </span>seconds
<span class="w">  </span>py310-requests2.28:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.08<span class="w"> </span>seconds
<span class="w">  </span>py310-requests2.31:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.21<span class="w"> </span>seconds
<span class="w">  </span>py311-requests2.28:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.15<span class="w"> </span>seconds
<span class="w">  </span>py311-requests2.31:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.09<span class="w"> </span>seconds
<span class="w">  </span>py312-requests2.28:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.18<span class="w"> </span>seconds
<span class="w">  </span>py312-requests2.31:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.14<span class="w"> </span>seconds
<span class="w">  </span>congratulations<span class="w"> </span>:<span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="m">25</span>.42<span class="w"> </span>seconds<span class="o">)</span>
</code></pre></div>

<h2 id="iteration-4-adding-code-quality-checks">Iteration 4: Adding Code Quality Checks</h2>
<p>Tox can run more than just tests. Add linting and type checking:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tox.ini</span>
<span class="k">[tox]</span>
<span class="na">envlist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">py{39,310,311,312}</span>
<span class="w">    </span><span class="na">lint</span>
<span class="w">    </span><span class="na">type</span>

<span class="k">[testenv]</span>
<span class="na">deps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">-rrequirements.txt</span>
<span class="w">    </span><span class="na">pytest-cov</span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">pytest tests/ --cov</span><span class="o">=</span><span class="s">src --cov-report=term -v</span>

<span class="k">[testenv:lint]</span>
<span class="na">deps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">black</span>
<span class="w">    </span><span class="na">flake8</span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">black --check src/ tests/</span>
<span class="w">    </span><span class="na">flake8 src/ tests/ --max-line-length</span><span class="o">=</span><span class="s">100</span>

<span class="k">[testenv:type]</span>
<span class="na">deps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">mypy</span>
<span class="w">    </span><span class="na">-rrequirements.txt</span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">mypy src/ --ignore-missing-imports</span>
</code></pre></div>

<h3 id="understanding-named-environments">Understanding Named Environments</h3>
<p><strong><code>[testenv:lint]</code></strong>: A named environment (not tied to a Python version).</p>
<p><strong><code>[testenv:type]</code></strong>: Another named environment.</p>
<p>These run in addition to the version-specific environments:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>tox
py39:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.45<span class="w"> </span>seconds
py310:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.12<span class="w"> </span>seconds
py311:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.08<span class="w"> </span>seconds
py312:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.21<span class="w"> </span>seconds
lint:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span>.15<span class="w"> </span>seconds
type:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">4</span>.32<span class="w"> </span>seconds

___________________________<span class="w"> </span>summary<span class="w"> </span>___________________________
<span class="w">  </span>py39:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.45<span class="w"> </span>seconds
<span class="w">  </span>py310:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.12<span class="w"> </span>seconds
<span class="w">  </span>py311:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.08<span class="w"> </span>seconds
<span class="w">  </span>py312:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.21<span class="w"> </span>seconds
<span class="w">  </span>lint:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span>.15<span class="w"> </span>seconds
<span class="w">  </span>type:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">4</span>.32<span class="w"> </span>seconds
<span class="w">  </span>congratulations<span class="w"> </span>:<span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="m">19</span>.33<span class="w"> </span>seconds<span class="o">)</span>
</code></pre></div>

<h3 id="running-specific-environments">Running Specific Environments</h3>
<p>You don't always want to run all environments. Tox lets you select:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run only Python 3.11 tests</span>
$<span class="w"> </span>tox<span class="w"> </span>-e<span class="w"> </span>py311

<span class="c1"># Run only linting</span>
$<span class="w"> </span>tox<span class="w"> </span>-e<span class="w"> </span>lint

<span class="c1"># Run multiple specific environments</span>
$<span class="w"> </span>tox<span class="w"> </span>-e<span class="w"> </span>py311,lint,type

<span class="c1"># Run all Python 3.11 environments (if you have factors)</span>
$<span class="w"> </span>tox<span class="w"> </span>-e<span class="w"> </span>py311-requests2.28,py311-requests2.31
</code></pre></div>

<h2 id="iteration-5-parallel-execution">Iteration 5: Parallel Execution</h2>
<p>Tox can run environments in parallel to save time:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>tox<span class="w"> </span>-p<span class="w"> </span>auto
‚úî<span class="w"> </span>OK<span class="w"> </span>py39<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.45<span class="w"> </span>seconds
‚úî<span class="w"> </span>OK<span class="w"> </span>py310<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.12<span class="w"> </span>seconds
‚úî<span class="w"> </span>OK<span class="w"> </span>py311<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.08<span class="w"> </span>seconds
‚úî<span class="w"> </span>OK<span class="w"> </span>py312<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.21<span class="w"> </span>seconds
‚úî<span class="w"> </span>OK<span class="w"> </span>lint<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span>.15<span class="w"> </span>seconds
‚úî<span class="w"> </span>OK<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">4</span>.32<span class="w"> </span>seconds

___________________________<span class="w"> </span>summary<span class="w"> </span>___________________________
<span class="w">  </span>py39:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.45<span class="w"> </span>seconds
<span class="w">  </span>py310:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.12<span class="w"> </span>seconds
<span class="w">  </span>py311:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.08<span class="w"> </span>seconds
<span class="w">  </span>py312:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.21<span class="w"> </span>seconds
<span class="w">  </span>lint:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span>.15<span class="w"> </span>seconds
<span class="w">  </span>type:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">4</span>.32<span class="w"> </span>seconds
<span class="w">  </span>congratulations<span class="w"> </span>:<span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="m">4</span>.32<span class="w"> </span>seconds<span class="o">)</span><span class="w">  </span>‚Üê<span class="w"> </span>Much<span class="w"> </span>faster!
</code></pre></div>

<p><strong><code>-p auto</code></strong>: Run environments in parallel. Tox automatically determines how many to run based on CPU cores.</p>
<p><strong>Time savings</strong>: Instead of 19.33 seconds (sequential), it takes 4.32 seconds (parallel) ‚Äî the time of the slowest environment.</p>
<h2 id="iteration-6-the-complete-production-toxini">Iteration 6: The Complete Production tox.ini</h2>
<p>Here's a full-featured configuration for a production project:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tox.ini</span>
<span class="k">[tox]</span>
<span class="na">envlist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">py{39,310,311,312}</span>
<span class="w">    </span><span class="na">lint</span>
<span class="w">    </span><span class="na">type</span>
<span class="w">    </span><span class="na">docs</span>
<span class="w">    </span><span class="na">coverage</span>
<span class="na">skip_missing_interpreters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>

<span class="k">[testenv]</span>
<span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">Run tests with pytest</span>
<span class="na">deps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">-rrequirements.txt</span>
<span class="w">    </span><span class="na">pytest&gt;</span><span class="o">=</span><span class="s">7.4.0</span>
<span class="w">    </span><span class="na">pytest-cov&gt;</span><span class="o">=</span><span class="s">4.1.0</span>
<span class="w">    </span><span class="na">pytest-xdist&gt;</span><span class="o">=</span><span class="s">3.3.0</span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">pytest tests/ \</span>
<span class="w">        </span><span class="na">--cov</span><span class="o">=</span><span class="s">src </span>\
<span class="w">        </span><span class="s">--cov-report=term-missing </span>\
<span class="w">        </span><span class="s">--cov-report=xml </span>\
<span class="w">        </span><span class="s">--cov-report=html </span>\
<span class="w">        </span><span class="s">-n auto </span>\
<span class="w">        </span><span class="s">-v</span>
<span class="na">setenv</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="na">COVERAGE_FILE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">.coverage.{envname}</span>

<span class="k">[testenv:lint]</span>
<span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">Run code quality checks</span>
<span class="na">deps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">black&gt;</span><span class="o">=</span><span class="s">23.0.0</span>
<span class="w">    </span><span class="na">flake8&gt;</span><span class="o">=</span><span class="s">6.0.0</span>
<span class="w">    </span><span class="na">isort&gt;</span><span class="o">=</span><span class="s">5.12.0</span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">black --check --diff src/ tests/</span>
<span class="w">    </span><span class="na">isort --check-only --diff src/ tests/</span>
<span class="w">    </span><span class="na">flake8 src/ tests/ --max-line-length</span><span class="o">=</span><span class="s">100 --count --statistics</span>

<span class="k">[testenv:type]</span>
<span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">Run type checking with mypy</span>
<span class="na">deps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">mypy&gt;</span><span class="o">=</span><span class="s">1.4.0</span>
<span class="w">    </span><span class="na">-rrequirements.txt</span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">mypy src/ --ignore-missing-imports --strict</span>

<span class="k">[testenv:docs]</span>
<span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">Build documentation</span>
<span class="na">deps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">sphinx&gt;</span><span class="o">=</span><span class="s">7.0.0</span>
<span class="w">    </span><span class="na">sphinx-rtd-theme&gt;</span><span class="o">=</span><span class="s">1.3.0</span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">sphinx-build -W -b html docs/ docs/_build/html</span>

<span class="k">[testenv:coverage]</span>
<span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">Combine coverage from all test runs</span>
<span class="na">deps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">coverage[toml]&gt;</span><span class="o">=</span><span class="s">7.2.0</span>
<span class="na">depends</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">py{39,310,311,312}</span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">coverage combine</span>
<span class="w">    </span><span class="na">coverage report --fail-under</span><span class="o">=</span><span class="s">80</span>
<span class="w">    </span><span class="na">coverage html</span>

<span class="k">[testenv:clean]</span>
<span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">Clean up generated files</span>
<span class="na">deps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">coverage[toml]&gt;</span><span class="o">=</span><span class="s">7.2.0</span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">coverage erase</span>
<span class="w">    </span><span class="na">python -c &quot;import shutil; shutil.rmtree(&#39;htmlcov&#39;, ignore_errors</span><span class="o">=</span><span class="s">True)&quot;</span>
<span class="w">    </span><span class="na">python -c &quot;import shutil; shutil.rmtree(&#39;.tox&#39;, ignore_errors</span><span class="o">=</span><span class="s">True)&quot;</span>
<span class="w">    </span><span class="na">python -c &quot;import shutil; shutil.rmtree(&#39;dist&#39;, ignore_errors</span><span class="o">=</span><span class="s">True)&quot;</span>
<span class="w">    </span><span class="na">python -c &quot;import shutil; shutil.rmtree(&#39;build&#39;, ignore_errors</span><span class="o">=</span><span class="s">True)&quot;</span>
<span class="na">skip_install</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
</code></pre></div>

<h3 id="understanding-advanced-toxini-features">Understanding Advanced tox.ini Features</h3>
<p><strong><code>skip_missing_interpreters = true</code></strong>: Don't fail if a Python version isn't installed. Just skip it.</p>
<p><strong><code>description</code></strong>: Human-readable description shown when running tox.</p>
<p><strong><code>setenv</code></strong>: Set environment variables for the test environment.</p>
<p><strong><code>COVERAGE_FILE = .coverage.{envname}</code></strong>: Create separate coverage files for each environment.</p>
<p><strong><code>depends</code></strong>: The <code>coverage</code> environment depends on all test environments completing first.</p>
<p><strong><code>skip_install = true</code></strong>: Don't install the package (useful for utility environments like <code>clean</code>).</p>
<h3 id="running-the-complete-suite">Running the Complete Suite</h3>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>tox<span class="w"> </span>-p<span class="w"> </span>auto
‚úî<span class="w"> </span>OK<span class="w"> </span>py39<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.45<span class="w"> </span>seconds
‚úî<span class="w"> </span>OK<span class="w"> </span>py310<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.12<span class="w"> </span>seconds
‚úî<span class="w"> </span>OK<span class="w"> </span>py311<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.08<span class="w"> </span>seconds
‚úî<span class="w"> </span>OK<span class="w"> </span>py312<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.21<span class="w"> </span>seconds
‚úî<span class="w"> </span>OK<span class="w"> </span>lint<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span>.15<span class="w"> </span>seconds
‚úî<span class="w"> </span>OK<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">4</span>.32<span class="w"> </span>seconds
‚úî<span class="w"> </span>OK<span class="w"> </span>docs<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">5</span>.67<span class="w"> </span>seconds
‚úî<span class="w"> </span>OK<span class="w"> </span>coverage<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span>.23<span class="w"> </span>seconds

___________________________<span class="w"> </span>summary<span class="w"> </span>___________________________
<span class="w">  </span>py39:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.45<span class="w"> </span>seconds
<span class="w">  </span>py310:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.12<span class="w"> </span>seconds
<span class="w">  </span>py311:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.08<span class="w"> </span>seconds
<span class="w">  </span>py312:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.21<span class="w"> </span>seconds
<span class="w">  </span>lint:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span>.15<span class="w"> </span>seconds
<span class="w">  </span>type:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">4</span>.32<span class="w"> </span>seconds
<span class="w">  </span>docs:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">5</span>.67<span class="w"> </span>seconds
<span class="w">  </span>coverage:<span class="w"> </span>OK<span class="w"> </span>‚úî<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span>.23<span class="w"> </span>seconds
<span class="w">  </span>congratulations<span class="w"> </span>:<span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="m">5</span>.67<span class="w"> </span>seconds<span class="o">)</span>
</code></pre></div>

<h2 id="integrating-tox-with-ci">Integrating Tox with CI</h2>
<h3 id="github-actions-with-tox">GitHub Actions with Tox</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># .github/workflows/test.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Tests</span>

<span class="nt">on</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">push</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">pull_request</span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">test</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.os }}</span>
<span class="w">    </span><span class="nt">strategy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">matrix</span><span class="p">:</span>
<span class="w">        </span><span class="nt">os</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">ubuntu-latest</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">windows-latest</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">macos-latest</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;3.9&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;3.10&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;3.11&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;3.12&#39;</span><span class="p p-Indicator">]</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set up Python ${{ matrix.python-version }}</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-python@v4</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.python-version }}</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install tox</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install tox tox-gh-actions</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tox</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tox</span>
</code></pre></div>

<p><strong><code>tox-gh-actions</code></strong>: A plugin that automatically maps GitHub Actions matrix to tox environments.</p>
<p>With this plugin, you don't need to specify <code>-e py39</code> manually. Tox detects the Python version from the matrix and runs the appropriate environment.</p>
<h3 id="gitlab-ci-with-tox">GitLab CI with Tox</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># .gitlab-ci.yml</span>
<span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>

<span class="nt">.test_template</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;test_template</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">before_script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install tox</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tox -e ${TOX_ENV}</span>

<span class="nt">test_py39</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.9</span>
<span class="w">  </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">    </span><span class="nt">TOX_ENV</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">py39</span>

<span class="nt">test_py310</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.10</span>
<span class="w">  </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">    </span><span class="nt">TOX_ENV</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">py310</span>

<span class="nt">test_py311</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.11</span>
<span class="w">  </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">    </span><span class="nt">TOX_ENV</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">py311</span>

<span class="nt">test_py312</span><span class="p">:</span>
<span class="w">  </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*test_template</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.12</span>
<span class="w">  </span><span class="nt">variables</span><span class="p">:</span>
<span class="w">    </span><span class="nt">TOX_ENV</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">py312</span>

<span class="nt">lint</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.11</span>
<span class="w">  </span><span class="nt">before_script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install tox</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tox -e lint</span>

<span class="nt">type</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python:3.11</span>
<span class="w">  </span><span class="nt">before_script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install tox</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tox -e type</span>
</code></pre></div>

<h2 id="tox-best-practices">Tox Best Practices</h2>
<h3 id="1-use-tox-locally-before-pushing">1. Use tox Locally Before Pushing</h3>
<p>Run <code>tox</code> before committing to catch issues early:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Quick check before commit</span>
$<span class="w"> </span>tox<span class="w"> </span>-e<span class="w"> </span>py311,lint

<span class="c1"># Full check before push</span>
$<span class="w"> </span>tox<span class="w"> </span>-p<span class="w"> </span>auto
</code></pre></div>

<h3 id="2-pin-dependency-versions">2. Pin Dependency Versions</h3>
<p>Use exact versions in <code>requirements.txt</code> to ensure reproducibility:</p>
<div class="codehilite"><pre><span></span><code># requirements.txt
requests==2.31.0
pytest==7.4.3
pytest-cov==4.1.0
</code></pre></div>

<h3 id="3-use-factors-for-combinations">3. Use Factors for Combinations</h3>
<p>Test multiple dependency versions with factors:</p>
<div class="codehilite"><pre><span></span><code><span class="k">[tox]</span>
<span class="na">envlist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">py{39,310,311,312}-django{3.2,4.0,4.1}</span>
</code></pre></div>

<h3 id="4-separate-test-and-quality-environments">4. Separate Test and Quality Environments</h3>
<p>Don't mix tests and linting in the same environment:</p>
<div class="codehilite"><pre><span></span><code><span class="k">[testenv]</span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">pytest tests/</span>

<span class="k">[testenv:lint]</span>
<span class="na">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">black --check src/ tests/</span>
</code></pre></div>

<h3 id="5-use-parallel-execution">5. Use Parallel Execution</h3>
<p>Always use <code>-p auto</code> for faster feedback:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>tox<span class="w"> </span>-p<span class="w"> </span>auto
</code></pre></div>

<h3 id="6-skip-missing-interpreters">6. Skip Missing Interpreters</h3>
<p>Don't fail if a Python version isn't installed:</p>
<div class="codehilite"><pre><span></span><code><span class="k">[tox]</span>
<span class="na">skip_missing_interpreters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
</code></pre></div>

<h3 id="7-clean-up-between-runs">7. Clean Up Between Runs</h3>
<p>Periodically clean tox environments:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Remove all tox environments</span>
$<span class="w"> </span>tox<span class="w"> </span>-e<span class="w"> </span>clean

<span class="c1"># Or manually</span>
$<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>.tox/
</code></pre></div>

<h2 id="the-journey-from-local-testing-to-full-automation">The Journey: From Local Testing to Full Automation</h2>
<table>
<thead>
<tr>
<th>Stage</th>
<th>Tool</th>
<th>What It Tests</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Local development</strong></td>
<td>pytest</td>
<td>Current Python version, current dependencies</td>
</tr>
<tr>
<td><strong>Pre-commit</strong></td>
<td>tox -e py311,lint</td>
<td>Quick check before committing</td>
</tr>
<tr>
<td><strong>Pre-push</strong></td>
<td>tox -p auto</td>
<td>All Python versions, all checks</td>
</tr>
<tr>
<td><strong>CI (GitHub Actions)</strong></td>
<td>Matrix + tox</td>
<td>All versions, all OSes, all dependency combos</td>
</tr>
<tr>
<td><strong>Nightly builds</strong></td>
<td>tox + cron</td>
<td>Latest dependencies, catch breaking changes</td>
</tr>
</tbody>
</table>
<h3 id="the-complete-workflow">The Complete Workflow</h3>
<ol>
<li><strong>Write code</strong>: Test with <code>pytest tests/ -v</code></li>
<li><strong>Before commit</strong>: Run <code>tox -e py311,lint</code></li>
<li><strong>Before push</strong>: Run <code>tox -p auto</code></li>
<li><strong>Push to CI</strong>: GitHub Actions runs full matrix</li>
<li><strong>Review reports</strong>: Check test results, coverage, and quality metrics</li>
<li><strong>Merge</strong>: Only if all checks pass</li>
</ol>
<p>This multi-layered approach catches issues at the earliest possible stage, saving time and preventing bugs from reaching production.</p>
        </div>
        <div class="footer">
            Generated on 2025-12-03 10:37:09 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>