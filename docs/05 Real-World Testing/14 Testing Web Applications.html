<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>14 Testing Web Applications</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">05 Real-World Testing</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-14-testing-web-applications">Chapter 14: Testing Web Applications</h1>
<h2 id="testing-flask-applications">Testing Flask Applications</h2>
<h2 id="testing-flask-applications_1">Testing Flask Applications</h2>
<p>Web applications present unique testing challenges: they handle HTTP requests, manage sessions, interact with databases, and coordinate multiple layers of logic. In this chapter, we'll build a complete testing strategy for web applications, starting with Flask‚Äîa lightweight framework that makes the testing fundamentals crystal clear.</p>
<h3 id="the-reference-application-a-task-management-api">The Reference Application: A Task Management API</h3>
<p>We'll test a realistic Flask application throughout this chapter‚Äîa task management API that handles user authentication, CRUD operations, and data persistence. This will be our anchor example, progressively refined as we encounter real testing challenges.</p>
<p>Here's our initial Flask application:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># app.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># In-memory storage (we&#39;ll address database testing later)</span>
<span class="n">tasks</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">task_id_counter</span> <span class="o">=</span> <span class="mi">1</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_task</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a new task&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">task_id_counter</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span> <span class="ow">or</span> <span class="s1">&#39;title&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Title is required&#39;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="n">task</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">task_id_counter</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;completed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="n">tasks</span><span class="p">[</span><span class="n">task_id_counter</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span>
    <span class="n">task_id_counter</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="mi">201</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/tasks/&lt;int:task_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve a specific task&quot;&quot;&quot;</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Task not found&#39;</span><span class="p">}),</span> <span class="mi">404</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="mi">200</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">list_tasks</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List all tasks&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span> <span class="mi">200</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<h3 id="our-first-test-the-naive-approach">Our First Test: The Naive Approach</h3>
<p>Let's write our first test the way many developers initially approach Flask testing‚Äîby actually running the server:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_app_naive.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_task_naive</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Attempt to test by running the actual server&quot;&quot;&quot;</span>
    <span class="c1"># Start the Flask server in a subprocess</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="s1">&#39;app.py&#39;</span><span class="p">])</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Wait for server to start</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Make a real HTTP request</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s1">&#39;http://localhost:5000/tasks&#39;</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Test task&#39;</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Test task&#39;</span>
        <span class="k">assert</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">data</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Clean up</span>
        <span class="n">server</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">server</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</code></pre></div>

<p>Let's run this test and observe what happens:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_app_naive.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>The complete output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 1 item

test_app_naive.py::test_create_task_naive FAILED                         [100%]

=================================== FAILURES ===================================
______________________________ test_create_task_naive __________________________

    def test_create_task_naive():
        &quot;&quot;&quot;Attempt to test by running the actual server&quot;&quot;&quot;
        server = subprocess.Popen([&#39;python&#39;, &#39;app.py&#39;])
        time.sleep(2)
<span class="k">&gt; </span><span class="ge">      </span>
        try:
            response = requests.post(
                &#39;http://localhost:5000/tasks&#39;,
                json={&#39;title&#39;: &#39;Test task&#39;}
            )
E           requests.exceptions.ConnectionError: HTTPConnectionPool(host=&#39;localhost&#39;, port=5000): 
E           Max retries exceeded with url: /tasks (Caused by NewConnectionError(
E           &#39;&lt;urllib3.connection.HTTPConnection object at 0x7f8b8c0a3d90&gt;: 
E           Failed to establish a new connection: [Errno 111] Connection refused&#39;))

test_app_naive.py:12: ConnectionError
=========================== 1 failed in 2.34s ==================================
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-failure">Diagnostic Analysis: Reading the Failure</h3>
<p><strong>The complete output</strong> shows a <code>ConnectionError</code>, but let's parse this systematically:</p>
<p><strong>1. The summary line</strong>: <code>test_app_naive.py::test_create_task_naive FAILED</code>
   - What this tells us: The test failed during execution, not during collection</p>
<p><strong>2. The traceback</strong>:</p>
<div class="codehilite"><pre><span></span><code>    response = requests.post(
        &#39;http://localhost:5000/tasks&#39;,
        json={&#39;title&#39;: &#39;Test task&#39;}
    )
E   requests.exceptions.ConnectionError: ... Connection refused
</code></pre></div>

<ul>
<li>What this tells us: The HTTP request itself failed‚Äîwe never even got to test our application logic</li>
<li>Key line: <code>Connection refused</code> means no server was listening on port 5000</li>
</ul>
<p><strong>3. The timing</strong>: <code>failed in 2.34s</code>
   - What this tells us: We wasted 2 seconds waiting for a server that never started properly</p>
<p><strong>Root cause identified</strong>: Starting a real server in a test is unreliable, slow, and creates race conditions.</p>
<p><strong>Why the current approach can't solve this</strong>: Even if we increase the sleep time or add retry logic, we're fighting against the fundamental problem‚Äîwe're testing at the wrong level of abstraction.</p>
<p><strong>What we need</strong>: A way to test Flask applications without starting an actual HTTP server.</p>
<h3 id="iteration-1-flasks-test-client">Iteration 1: Flask's Test Client</h3>
<p>Flask provides a built-in test client that simulates HTTP requests without running a server. This is the standard approach for Flask testing.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_app.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_task</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test task creation using Flask&#39;s test client&quot;&quot;&quot;</span>
    <span class="c1"># Create a test client</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>

    <span class="c1"># Make a request (no server needed!)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s1">&#39;/tasks&#39;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Write tests&#39;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># Verify the response</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Write tests&#39;</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
</code></pre></div>

<p>Let's run this improved version:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_app.py::test_create_task<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 1 item

test_app.py::test_create_task PASSED                                     [100%]

============================== 1 passed in 0.03s ===============================
</code></pre></div>

<p><strong>Expected vs. Actual improvement</strong>:
- <strong>Speed</strong>: 2.34s ‚Üí 0.03s (78x faster)
- <strong>Reliability</strong>: Connection errors eliminated
- <strong>Simplicity</strong>: No subprocess management, no sleep calls</p>
<p>This works! But let's add another test to verify retrieval:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_app.py (continued)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_get_task</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test retrieving a task&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>

    <span class="c1"># First, create a task</span>
    <span class="n">create_response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s1">&#39;/tasks&#39;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Test task&#39;</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="n">task_id</span> <span class="o">=</span> <span class="n">create_response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

    <span class="c1"># Now retrieve it</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/tasks/</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Test task&#39;</span>
</code></pre></div>

<p>Run both tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_app.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>The complete output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 2 items

test_app.py::test_create_task PASSED                                     [ 50%]
test_app.py::test_get_task FAILED                                        [100%]

=================================== FAILURES ===================================
_________________________________ test_get_task ________________________________

    def test_get_task():
        &quot;&quot;&quot;Test retrieving a task&quot;&quot;&quot;
        client = app.test_client()

        create_response = client.post(
            &#39;/tasks&#39;,
            json={&#39;title&#39;: &#39;Test task&#39;}
        )
        task_id = create_response.get_json()[&#39;id&#39;]
<span class="k">&gt; </span><span class="ge">      </span>
        response = client.get(f&#39;/tasks/{task_id}&#39;)

        assert response.status_code == 200
        data = response.get_json()
        assert data[&#39;title&#39;] == &#39;Test task&#39;
E       AssertionError: assert &#39;Test task&#39; == &#39;Write tests&#39;
E         - Write tests
E         + Test task

test_app.py:25: AssertionError
=========================== 1 failed, 1 passed in 0.05s =======================
</code></pre></div>

<h3 id="diagnostic-analysis-test-pollution">Diagnostic Analysis: Test Pollution</h3>
<p><strong>Let's parse this section by section</strong>:</p>
<p><strong>1. The summary line</strong>: <code>test_get_task FAILED</code>
   - What this tells us: The second test failed, but the first passed</p>
<p><strong>2. The assertion introspection</strong>:</p>
<div class="codehilite"><pre><span></span><code>E       AssertionError: assert &#39;Test task&#39; == &#39;Write tests&#39;
E         - Write tests
E         + Test task
</code></pre></div>

<ul>
<li>What this tells us: We expected to retrieve "Test task" but got "Write tests"</li>
<li>Key insight: "Write tests" was the title from the FIRST test</li>
</ul>
<p><strong>3. The pattern</strong>: First test passes, second test fails
   - What this tells us: Tests are interfering with each other</p>
<p><strong>Root cause identified</strong>: Our Flask app uses global state (<code>tasks</code> dictionary). The first test creates a task with ID 1, and that task persists into the second test. When the second test creates its task, it gets ID 2, but then tries to retrieve ID 1‚Äîwhich contains data from the first test.</p>
<p><strong>Why the current approach can't solve this</strong>: Simply reordering tests or running them individually would mask the problem, not fix it.</p>
<p><strong>What we need</strong>: A way to reset the application state between tests.</p>
<h3 id="iteration-2-application-state-management-with-fixtures">Iteration 2: Application State Management with Fixtures</h3>
<p>The solution is to create a fresh application instance for each test using fixtures:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_app.py (refactored)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span> <span class="k">as</span> <span class="n">flask_app</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">app</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a fresh Flask app for each test&quot;&quot;&quot;</span>
    <span class="c1"># Configure the app for testing</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;TESTING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">yield</span> <span class="n">flask_app</span>

    <span class="c1"># Clean up: reset global state</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">app</span><span class="w"> </span><span class="kn">import</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">task_id_counter</span>
    <span class="n">tasks</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="c1"># Note: We can&#39;t reset task_id_counter because it&#39;s not mutable</span>
    <span class="c1"># We&#39;ll address this limitation next</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a test client&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_task</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test task creation&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s1">&#39;/tasks&#39;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Write tests&#39;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Write tests&#39;</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_task</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test retrieving a task&quot;&quot;&quot;</span>
    <span class="c1"># Create a task</span>
    <span class="n">create_response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s1">&#39;/tasks&#39;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Test task&#39;</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="n">task_id</span> <span class="o">=</span> <span class="n">create_response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

    <span class="c1"># Retrieve it</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/tasks/</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Test task&#39;</span>
</code></pre></div>

<p>Run the tests again:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_app.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 2 items

test_app.py::test_create_task PASSED                                     [ 50%]
test_app.py::test_get_task PASSED                                        [100%]

============================== 2 passed in 0.04s ===============================
</code></pre></div>

<p><strong>Expected vs. Actual improvement</strong>:
- Tests now pass consistently regardless of execution order
- Each test gets a clean slate
- The fixture pattern makes the setup explicit and reusable</p>
<p><strong>Limitation preview</strong>: We're clearing the <code>tasks</code> dictionary, but we can't reset <code>task_id_counter</code> because it's a module-level integer. This means task IDs will continue incrementing across tests. Let's see why this matters:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_app.py (add this test)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_task_ids_are_sequential</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify that task IDs start at 1&quot;&quot;&quot;</span>
    <span class="n">response1</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;First&#39;</span><span class="p">})</span>
    <span class="n">response2</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Second&#39;</span><span class="p">})</span>

    <span class="k">assert</span> <span class="n">response1</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">response2</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
</code></pre></div>

<p>Run all tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_app.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>The complete output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 3 items

test_app.py::test_create_task PASSED                                     [ 33%]
test_app.py::test_get_task PASSED                                        [ 66%]
test_app.py::test_task_ids_are_sequential FAILED                         [100%]

=================================== FAILURES ===================================
_________________________ test_task_ids_are_sequential _________________________

    def test_task_ids_are_sequential(client):
        &quot;&quot;&quot;Verify that task IDs start at 1&quot;&quot;&quot;
        response1 = client.post(&#39;/tasks&#39;, json={&#39;title&#39;: &#39;First&#39;})
        response2 = client.post(&#39;/tasks&#39;, json={&#39;title&#39;: &#39;Second&#39;})

<span class="k">&gt; </span><span class="ge">      assert response1.get_json()[&#39;id&#39;] == 1</span>
E       AssertionError: assert 3 == 1
E        +  where 3 = {&#39;id&#39;: 3, &#39;title&#39;: &#39;First&#39;, &#39;description&#39;: &#39;&#39;, &#39;completed&#39;: False, ...}[&#39;id&#39;]
E        +    where {&#39;id&#39;: 3, &#39;title&#39;: &#39;First&#39;, &#39;description&#39;: &#39;&#39;, &#39;completed&#39;: False, ...} = &lt;bound method Response.get_json of &lt;Response 201 CREATED&gt;&gt;()

test_app.py:58: AssertionError
=========================== 1 failed, 2 passed in 0.05s =======================
</code></pre></div>

<h3 id="diagnostic-analysis-incomplete-state-reset">Diagnostic Analysis: Incomplete State Reset</h3>
<p><strong>Let's parse this section by section</strong>:</p>
<p><strong>1. The assertion introspection</strong>:</p>
<div class="codehilite"><pre><span></span><code>E       AssertionError: assert 3 == 1
E        +  where 3 = {&#39;id&#39;: 3, &#39;title&#39;: &#39;First&#39;, ...}[&#39;id&#39;]
</code></pre></div>

<ul>
<li>What this tells us: The first task created in this test got ID 3, not ID 1</li>
<li>Key insight: IDs 1 and 2 were used by previous tests</li>
</ul>
<p><strong>2. The pattern</strong>: The test would pass if run in isolation
   - What this tells us: This is a test order dependency issue</p>
<p><strong>Root cause identified</strong>: We're clearing the <code>tasks</code> dictionary but not resetting <code>task_id_counter</code>. The counter keeps incrementing across tests.</p>
<p><strong>Why the current approach can't solve this</strong>: Python integers are immutable. We can't modify <code>task_id_counter</code> from outside the module without restructuring the application code.</p>
<p><strong>What we need</strong>: Either refactor the application to make state resettable, or adjust our testing strategy to not depend on specific ID values.</p>
<h3 id="iteration-3-application-factory-pattern">Iteration 3: Application Factory Pattern</h3>
<p>The professional solution is to refactor the Flask app using the <strong>application factory pattern</strong>. This makes the app testable by design:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># app.py (refactored)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_app</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Application factory function&quot;&quot;&quot;</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># Application state stored on the app object</span>
    <span class="n">app</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">app</span><span class="o">.</span><span class="n">task_id_counter</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_task</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new task&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span> <span class="ow">or</span> <span class="s1">&#39;title&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Title is required&#39;</span><span class="p">}),</span> <span class="mi">400</span>

        <span class="n">task</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">app</span><span class="o">.</span><span class="n">task_id_counter</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="s1">&#39;completed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">app</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="n">app</span><span class="o">.</span><span class="n">task_id_counter</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span>
        <span class="n">app</span><span class="o">.</span><span class="n">task_id_counter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="mi">201</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/tasks/&lt;int:task_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve a specific task&quot;&quot;&quot;</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Task not found&#39;</span><span class="p">}),</span> <span class="mi">404</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="mi">200</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">list_tasks</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List all tasks&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span> <span class="mi">200</span>

    <span class="k">return</span> <span class="n">app</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<p>Now our test fixtures become much cleaner:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_app.py (final version)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_app</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">app</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a fresh Flask app for each test&quot;&quot;&quot;</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">({</span><span class="s1">&#39;TESTING&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
    <span class="k">yield</span> <span class="n">app</span>
    <span class="c1"># No cleanup needed‚Äîeach test gets a new app instance</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a test client&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_task</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test task creation&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s1">&#39;/tasks&#39;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Write tests&#39;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Write tests&#39;</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_task</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test retrieving a task&quot;&quot;&quot;</span>
    <span class="n">create_response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s1">&#39;/tasks&#39;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Test task&#39;</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="n">task_id</span> <span class="o">=</span> <span class="n">create_response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/tasks/</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Test task&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_task_ids_are_sequential</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify that task IDs start at 1&quot;&quot;&quot;</span>
    <span class="n">response1</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;First&#39;</span><span class="p">})</span>
    <span class="n">response2</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Second&#39;</span><span class="p">})</span>

    <span class="k">assert</span> <span class="n">response1</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">response2</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_nonexistent_task</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test 404 handling&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/tasks/999&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span>
    <span class="k">assert</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_task_missing_title</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test validation&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{})</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
    <span class="k">assert</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
</code></pre></div>

<p>Run all tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_app.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 5 items

test_app.py::test_create_task PASSED                                     [ 20%]
test_app.py::test_get_task PASSED                                        [ 40%]
test_app.py::test_task_ids_are_sequential PASSED                         [ 60%]
test_app.py::test_get_nonexistent_task PASSED                            [ 80%]
test_app.py::test_create_task_missing_title PASSED                       [100%]

============================== 5 passed in 0.06s ===============================
</code></pre></div>

<p><strong>Expected vs. Actual improvement</strong>:
- All tests pass consistently
- No manual cleanup required
- Each test gets completely isolated state
- Application code is now more maintainable (factory pattern is a best practice)</p>
<h3 id="common-failure-modes-and-their-signatures">Common Failure Modes and Their Signatures</h3>
<h4 id="symptom-tests-pass-individually-but-fail-when-run-together">Symptom: Tests pass individually but fail when run together</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_app.py::test_first PASSED
test_app.py::test_second FAILED
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Tests pass when run with <code>-k test_second</code> (isolated)
- Failure involves unexpected data from previous tests
- Assertion shows values from earlier test cases</p>
<p><strong>Root cause</strong>: Shared mutable state between tests (global variables, class attributes, module-level collections)</p>
<p><strong>Solution</strong>: Use application factory pattern + fixtures to create fresh instances per test</p>
<h4 id="symptom-connectionerror-or-address-already-in-use">Symptom: ConnectionError or "Address already in use"</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>E   requests.exceptions.ConnectionError: ... Connection refused
</code></pre></div>

<p>or</p>
<div class="codehilite"><pre><span></span><code>E   OSError: [Errno 48] Address already in use
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Error occurs during test setup or first request
- Involves <code>subprocess</code>, <code>threading</code>, or actual server startup
- Tests are slow (&gt;1 second each)</p>
<p><strong>Root cause</strong>: Attempting to run a real HTTP server during tests</p>
<p><strong>Solution</strong>: Use Flask's <code>test_client()</code> instead of starting an actual server</p>
<h4 id="symptom-tests-fail-with-working-outside-of-application-context">Symptom: Tests fail with "Working outside of application context"</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>E   RuntimeError: Working outside of application context.
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Error occurs when accessing Flask features (current_app, g, session)
- Happens in helper functions or fixtures
- Code works fine when running the actual application</p>
<p><strong>Root cause</strong>: Flask requires an application context for certain operations</p>
<p><strong>Solution</strong>: Use <code>app.app_context()</code> or <code>app.test_request_context()</code> in fixtures (we'll cover this in section 14.4)</p>
<h3 id="when-to-apply-this-solution">When to Apply This Solution</h3>
<p><strong>What it optimizes for</strong>:
- Test isolation and reliability
- Fast test execution (no network overhead)
- Ability to test edge cases and error conditions</p>
<p><strong>What it sacrifices</strong>:
- Doesn't test actual HTTP server behavior
- Doesn't catch deployment configuration issues
- Doesn't test reverse proxy or load balancer interactions</p>
<p><strong>When to choose this approach</strong>:
- Unit and integration testing of application logic
- Testing request handlers, validation, and business logic
- CI/CD pipelines where speed matters
- Development workflow (fast feedback loop)</p>
<p><strong>When to avoid this approach</strong>:
- End-to-end testing of deployed applications
- Testing server configuration or deployment issues
- Load testing or performance testing
- Testing interactions with external services in production-like environments</p>
<p><strong>Code characteristics</strong>:
- <strong>Setup complexity</strong>: Low (just create fixtures)
- <strong>Maintenance burden</strong>: Low (tests are simple and fast)
- <strong>Testability</strong>: High (easy to test edge cases and error conditions)</p>
<h2 id="testing-django-applications">Testing Django Applications</h2>
<h2 id="testing-django-applications_1">Testing Django Applications</h2>
<p>Django takes a different approach to testing than Flask. While Flask is minimalist and requires you to build your own patterns, Django comes with a comprehensive testing framework built in. Let's explore how to test Django applications effectively using pytest.</p>
<h3 id="the-reference-application-a-blog-api">The Reference Application: A Blog API</h3>
<p>We'll build and test a Django REST API for a blog system. This will demonstrate Django-specific testing patterns while building on the Flask concepts we just learned.</p>
<p>First, let's set up our Django models and views:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># blog/models.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Post</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">published</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">updated_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-created_at&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Comment</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;comments&#39;</span><span class="p">)</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;created_at&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Comment by </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s1"> on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s1">&#39;</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># blog/views.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.shortcuts</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_object_or_404</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">JsonResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.views.decorators.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">require_http_methods</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.views.decorators.csrf</span><span class="w"> </span><span class="kn">import</span> <span class="n">csrf_exempt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Post</span><span class="p">,</span> <span class="n">Comment</span>

<span class="nd">@csrf_exempt</span>
<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_post</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a new blog post&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid JSON&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Title is required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Authentication required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>

    <span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
        <span class="n">content</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="n">author</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
        <span class="n">published</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;published&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
        <span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
        <span class="s1">&#39;published&#39;</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">published</span><span class="p">,</span>
        <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
    <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span>

<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_post</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">post_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve a specific post&quot;&quot;&quot;</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">post_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
        <span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
        <span class="s1">&#39;published&#39;</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">published</span><span class="p">,</span>
        <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
    <span class="p">})</span>

<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">list_posts</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List all published posts&quot;&quot;&quot;</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">published</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span>
        <span class="s1">&#39;posts&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
                <span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">posts</span>
        <span class="p">]</span>
    <span class="p">})</span>
</code></pre></div>

<h3 id="iteration-1-the-django-testcase-approach">Iteration 1: The Django TestCase Approach</h3>
<p>Django provides <code>django.test.TestCase</code>, which many developers use. Let's start there to understand why pytest offers advantages:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># blog/tests.py (Django&#39;s built-in approach)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.test</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestCase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Post</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PostTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run before each test&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s1">&#39;testuser&#39;</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="s1">&#39;testpass123&#39;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test post creation&quot;&quot;&quot;</span>
        <span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Test Post&#39;</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="s1">&#39;Test content&#39;</span><span class="p">,</span>
            <span class="n">author</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
            <span class="n">published</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s1">&#39;Test Post&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">author</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">published</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_post_str_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test string representation&quot;&quot;&quot;</span>
        <span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Test Post&#39;</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="s1">&#39;Test content&#39;</span><span class="p">,</span>
            <span class="n">author</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">post</span><span class="p">),</span> <span class="s1">&#39;Test Post&#39;</span><span class="p">)</span>
</code></pre></div>

<p>Run this with Django's test runner:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>python<span class="w"> </span>manage.py<span class="w"> </span><span class="nb">test</span><span class="w"> </span>blog
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c">Creating test database for alias &#39;default&#39;</span><span class="nt">...</span>
<span class="c">System check identified no issues (0 silenced)</span><span class="nt">.</span>
<span class="nt">..</span>
<span class="nb">----------------------------------------------------------------------</span>
<span class="c">Ran 2 tests in 0</span><span class="nt">.</span><span class="c">123s</span>

<span class="c">OK</span>
<span class="c">Destroying test database for alias &#39;default&#39;</span><span class="nt">...</span>
</code></pre></div>

<p>This works, but notice several limitations:</p>
<ol>
<li><strong>Verbose syntax</strong>: <code>self.assertEqual()</code> instead of simple <code>assert</code></li>
<li><strong>Class-based structure</strong>: Must inherit from <code>TestCase</code></li>
<li><strong>setUp/tearDown pattern</strong>: Less flexible than pytest fixtures</li>
<li><strong>Limited introspection</strong>: Failures show less detail than pytest</li>
</ol>
<h3 id="iteration-2-switching-to-pytest-with-pytest-django">Iteration 2: Switching to Pytest with pytest-django</h3>
<p>Let's refactor to use pytest with the <code>pytest-django</code> plugin:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pytest-django
</code></pre></div>

<p>Configure pytest for Django:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># pytest.ini</span>
<span class="k">[pytest]</span>
<span class="na">DJANGO_SETTINGS_MODULE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">myproject.settings</span>
<span class="na">python_files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">tests.py test_*.py *_tests.py</span>
</code></pre></div>

<p>Now rewrite our tests using pytest:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># blog/test_models.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">blog.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Post</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a test user&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s1">&#39;testuser&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="s1">&#39;testpass123&#39;</span>
    <span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">django_db</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_create_post</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test post creation&quot;&quot;&quot;</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Test Post&#39;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="s1">&#39;Test content&#39;</span><span class="p">,</span>
        <span class="n">author</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
        <span class="n">published</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">post</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="s1">&#39;Test Post&#39;</span>
    <span class="k">assert</span> <span class="n">post</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="n">user</span>
    <span class="k">assert</span> <span class="n">post</span><span class="o">.</span><span class="n">published</span> <span class="ow">is</span> <span class="kc">True</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">django_db</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_post_str_representation</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test string representation&quot;&quot;&quot;</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Test Post&#39;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="s1">&#39;Test content&#39;</span><span class="p">,</span>
        <span class="n">author</span><span class="o">=</span><span class="n">user</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">post</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Test Post&#39;</span>
</code></pre></div>

<p>Run with pytest:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>blog/test_models.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 2 items

blog/test_models.py::test_create_post PASSED                             [ 50%]
blog/test_models.py::test_post_str_representation PASSED                 [100%]

============================== 2 passed in 0.18s ===============================
</code></pre></div>

<p><strong>Expected vs. Actual improvement</strong>:
- <strong>Cleaner syntax</strong>: <code>assert</code> instead of <code>self.assertEqual()</code>
- <strong>Better failures</strong>: Pytest's introspection shows exactly what differed
- <strong>Fixture composition</strong>: Can combine fixtures easily
- <strong>Parametrization</strong>: Can use <code>@pytest.mark.parametrize</code> (not available in Django TestCase)</p>
<p><strong>Limitation preview</strong>: We're testing models, but we haven't tested the views yet. Let's see what happens when we try to test the API endpoints:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># blog/test_views.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">blog.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Post</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a test user&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s1">&#39;testuser&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="s1">&#39;testpass123&#39;</span>
    <span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">django_db</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_create_post_view</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the create_post view&quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">django.test</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s1">&#39;/blog/posts/&#39;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Test Post&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;Test content&#39;</span><span class="p">},</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>blog/test_views.py::test_create_post_view<span class="w"> </span>-v
</code></pre></div>

<p><strong>The complete output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">=============================</span> <span class="n">test</span> <span class="n">session</span> <span class="n">starts</span> <span class="o">==============================</span>
<span class="n">collected</span> <span class="mi">1</span> <span class="n">item</span>

<span class="n">blog</span><span class="o">/</span><span class="n">test_views</span><span class="o">.</span><span class="n">py</span><span class="p">::</span><span class="n">test_create_post_view</span> <span class="n">FAILED</span>                         <span class="p">[</span><span class="mi">100</span><span class="o">%</span><span class="p">]</span>

<span class="o">===================================</span> <span class="n">FAILURES</span> <span class="o">===================================</span>
<span class="n">__________________________</span> <span class="n">test_create_post_view</span> <span class="n">_______________________________</span>

<span class="n">user</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">User</span><span class="p">:</span> <span class="n">testuser</span><span class="o">&gt;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">django_db</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_post_view</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test the create_post view&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">django.test</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span>

        <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s1">&#39;/blog/posts/&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Test Post&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;Test content&#39;</span><span class="p">},</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span>
        <span class="p">)</span>

<span class="o">&gt;</span>       <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
<span class="n">E</span>       <span class="ne">AssertionError</span><span class="p">:</span> <span class="k">assert</span> <span class="mi">401</span> <span class="o">==</span> <span class="mi">201</span>
<span class="n">E</span>        <span class="o">+</span>  <span class="n">where</span> <span class="mi">401</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">JsonResponse</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> <span class="s2">&quot;application/json&quot;</span><span class="o">&gt;.</span><span class="n">status_code</span>

<span class="n">blog</span><span class="o">/</span><span class="n">test_views</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span> <span class="ne">AssertionError</span>
<span class="o">===========================</span> <span class="mi">1</span> <span class="n">failed</span> <span class="ow">in</span> <span class="mf">0.21</span><span class="n">s</span> <span class="o">=======================</span>
</code></pre></div>

<h3 id="diagnostic-analysis-authentication-required">Diagnostic Analysis: Authentication Required</h3>
<p><strong>Let's parse this section by section</strong>:</p>
<p><strong>1. The assertion introspection</strong>:</p>
<div class="codehilite"><pre><span></span><code>E       AssertionError: assert 401 == 201
E        +  where 401 = &lt;JsonResponse status_code=401, ...&gt;.status_code
</code></pre></div>

<ul>
<li>What this tells us: We got a 401 (Unauthorized) instead of 201 (Created)</li>
<li>Key insight: The view requires authentication, but our test client isn't authenticated</li>
</ul>
<p><strong>2. Looking at the view code</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Authentication required&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
</code></pre></div>

<ul>
<li>What this tells us: The view explicitly checks for authentication</li>
</ul>
<p><strong>Root cause identified</strong>: We created a user fixture but didn't authenticate the test client with that user.</p>
<p><strong>Why the current approach can't solve this</strong>: Simply creating a user doesn't automatically authenticate requests.</p>
<p><strong>What we need</strong>: A way to authenticate the test client as our test user.</p>
<h3 id="iteration-3-authenticated-test-client">Iteration 3: Authenticated Test Client</h3>
<p>Django's test client provides a <code>force_login()</code> method for testing authenticated views:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># blog/test_views.py (refactored)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.test</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">blog.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Post</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a test user&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s1">&#39;testuser&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="s1">&#39;testpass123&#39;</span>
    <span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticated_client</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create an authenticated test client&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
    <span class="n">client</span><span class="o">.</span><span class="n">force_login</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">client</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">django_db</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_create_post_view</span><span class="p">(</span><span class="n">authenticated_client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the create_post view&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">authenticated_client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s1">&#39;/blog/posts/&#39;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Test Post&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;Test content&#39;</span><span class="p">}),</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Test Post&#39;</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Test content&#39;</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">django_db</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_create_post_requires_authentication</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that unauthenticated requests are rejected&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s1">&#39;/blog/posts/&#39;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Test Post&#39;</span><span class="p">}),</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span>
    <span class="k">assert</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">django_db</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_create_post_requires_title</span><span class="p">(</span><span class="n">authenticated_client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test validation&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">authenticated_client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s1">&#39;/blog/posts/&#39;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({}),</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
    <span class="k">assert</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">django_db</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_get_post</span><span class="p">(</span><span class="n">authenticated_client</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test retrieving a post&quot;&quot;&quot;</span>
    <span class="c1"># Create a post directly in the database</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Test Post&#39;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="s1">&#39;Test content&#39;</span><span class="p">,</span>
        <span class="n">author</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
        <span class="n">published</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">authenticated_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/blog/posts/</span><span class="si">{</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">/&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Test Post&#39;</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;testuser&#39;</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">django_db</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_list_posts_shows_only_published</span><span class="p">(</span><span class="n">authenticated_client</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that only published posts appear in the list&quot;&quot;&quot;</span>
    <span class="c1"># Create published and unpublished posts</span>
    <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Published Post&#39;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="s1">&#39;Content&#39;</span><span class="p">,</span>
        <span class="n">author</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
        <span class="n">published</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Draft Post&#39;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="s1">&#39;Content&#39;</span><span class="p">,</span>
        <span class="n">author</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
        <span class="n">published</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">authenticated_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/blog/posts/&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;posts&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;posts&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Published Post&#39;</span>
</code></pre></div>

<p>Run all tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>blog/test_views.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 5 items

blog/test_views.py::test_create_post_view PASSED                         [ 20%]
blog/test_views.py::test_create_post_requires_authentication PASSED      [ 40%]
blog/test_views.py::test_create_post_requires_title PASSED               [ 60%]
blog/test_views.py::test_get_post PASSED                                 [ 80%]
blog/test_views.py::test_list_posts_shows_only_published PASSED          [100%]

============================== 5 passed in 0.34s ===============================
</code></pre></div>

<p><strong>Expected vs. Actual improvement</strong>:
- All tests pass with proper authentication
- Fixture composition makes it easy to create authenticated clients
- Tests are clear about what they're testing (authentication, validation, filtering)</p>
<h3 id="using-pytest-djangos-built-in-fixtures">Using pytest-django's Built-in Fixtures</h3>
<p>pytest-django provides several useful fixtures out of the box:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># blog/test_views_advanced.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">blog.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Post</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user</span><span class="p">(</span><span class="n">django_user_model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a test user using django_user_model fixture&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">django_user_model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s1">&#39;testuser&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="s1">&#39;testpass123&#39;</span>
    <span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">django_db</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_create_post_with_client_fixture</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test using pytest-django&#39;s client fixture&quot;&quot;&quot;</span>
    <span class="n">client</span><span class="o">.</span><span class="n">force_login</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s1">&#39;/blog/posts/&#39;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Test Post&#39;</span><span class="p">}),</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">django_db</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_database_access_with_transactional_db</span><span class="p">(</span><span class="n">transactional_db</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test with transactional database access&quot;&quot;&quot;</span>
    <span class="c1"># transactional_db allows testing transaction behavior</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Test Post&#39;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="s1">&#39;Content&#39;</span><span class="p">,</span>
        <span class="n">author</span><span class="o">=</span><span class="n">user</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_settings_override</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test with modified settings&quot;&quot;&quot;</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span> <span class="ow">is</span> <span class="kc">True</span>
</code></pre></div>

<h3 id="common-failure-modes-and-their-signatures_1">Common Failure Modes and Their Signatures</h3>
<h4 id="symptom-no-such-table-or-relation-does-not-exist">Symptom: "no such table" or "relation does not exist"</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>E   django.db.utils.OperationalError: no such table: blog_post
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Error occurs during database query
- Missing <code>@pytest.mark.django_db</code> decorator
- Test tries to access database without permission</p>
<p><strong>Root cause</strong>: Test doesn't have database access enabled</p>
<p><strong>Solution</strong>: Add <code>@pytest.mark.django_db</code> decorator to the test function</p>
<h4 id="symptom-tests-pass-individually-but-fail-together-with-duplicate-key-errors">Symptom: Tests pass individually but fail together with "duplicate key" errors</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">E</span><span class="w">   </span><span class="n">django</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span><span class="w"> </span><span class="n">UNIQUE</span><span class="w"> </span><span class="n">constraint</span><span class="w"> </span><span class="n">failed</span><span class="p">:</span><span class="w"> </span><span class="n">auth_user</span><span class="o">.</span><span class="n">username</span>
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Error mentions unique constraint
- Tests pass when run with <code>-k</code> to isolate them
- Involves creating users or other unique objects</p>
<p><strong>Root cause</strong>: Fixtures creating objects with hardcoded unique values</p>
<p><strong>Solution</strong>: Use dynamic values or ensure fixtures are function-scoped</p>
<h4 id="symptom-working-outside-of-request-context">Symptom: "Working outside of request context"</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>E   RuntimeError: Working outside of request context
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Error occurs when accessing request-dependent features
- Happens in middleware or view helpers
- Code works fine in actual application</p>
<p><strong>Root cause</strong>: Test doesn't provide a request context</p>
<p><strong>Solution</strong>: Use <code>RequestFactory</code> or test client to create proper request context (covered in section 14.5)</p>
<h3 id="when-to-apply-this-solution_1">When to Apply This Solution</h3>
<p><strong>What it optimizes for</strong>:
- Clean, readable test code
- Fast test execution with database rollback
- Fixture composition and reusability
- Better failure messages</p>
<p><strong>What it sacrifices</strong>:
- Requires learning pytest-django specifics
- Different from Django's built-in testing approach
- May confuse developers familiar only with Django TestCase</p>
<p><strong>When to choose this approach</strong>:
- New Django projects
- Projects already using pytest for other components
- When you need parametrized tests
- When fixture composition is important</p>
<p><strong>When to avoid this approach</strong>:
- Team is strongly committed to Django's built-in testing
- Legacy codebase with extensive Django TestCase tests
- When consistency with Django documentation is critical</p>
<p><strong>Code characteristics</strong>:
- <strong>Setup complexity</strong>: Medium (requires pytest-django configuration)
- <strong>Maintenance burden</strong>: Low (fixtures are reusable and composable)
- <strong>Testability</strong>: High (easy to test complex scenarios)</p>
<h2 id="using-test-clients">Using Test Clients</h2>
<h2 id="using-test-clients_1">Using Test Clients</h2>
<p>Test clients are the bridge between your test code and your web application. They simulate HTTP requests without requiring a running server. Both Flask and Django provide test clients, but they work differently. Let's explore how to use them effectively.</p>
<h3 id="the-test-client-abstraction">The Test Client Abstraction</h3>
<p>A test client provides methods that correspond to HTTP verbs:
- <code>client.get()</code> ‚Üí GET request
- <code>client.post()</code> ‚Üí POST request
- <code>client.put()</code> ‚Üí PUT request
- <code>client.delete()</code> ‚Üí DELETE request
- <code>client.patch()</code> ‚Üí PATCH request</p>
<p>Each method returns a response object containing:
- <code>status_code</code> ‚Üí HTTP status code
- <code>data</code> or <code>content</code> ‚Üí Response body
- <code>headers</code> ‚Üí Response headers
- <code>json()</code> or <code>get_json()</code> ‚Üí Parsed JSON response</p>
<h3 id="iteration-1-basic-request-patterns">Iteration 1: Basic Request Patterns</h3>
<p>Let's explore common request patterns using our Flask task API:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_client_basics.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_app</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">({</span><span class="s1">&#39;TESTING&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_request</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test a simple GET request&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">(),</span> <span class="nb">list</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_post_request_with_json</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test POST with JSON data&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s1">&#39;/tasks&#39;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;New task&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Details&#39;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;New task&#39;</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Details&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_post_request_with_form_data</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test POST with form data&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s1">&#39;/tasks&#39;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;New task&#39;</span><span class="p">},</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/x-www-form-urlencoded&#39;</span>
    <span class="p">)</span>

    <span class="c1"># This will fail because our API expects JSON</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
</code></pre></div>

<p>Run these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_client_basics.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 3 items

test_client_basics.py::test_get_request PASSED                           [ 33%]
test_client_basics.py::test_post_request_with_json PASSED                [ 66%]
test_client_basics.py::test_post_request_with_form_data PASSED           [100%]

============================== 3 passed in 0.05s ===============================
</code></pre></div>

<p>These basic patterns work, but let's test a more complex scenario‚Äîfollowing redirects:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Add to app.py</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/tasks/&lt;int:task_id&gt;/complete&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">complete_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mark a task as complete and redirect to task detail&quot;&quot;&quot;</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Task not found&#39;</span><span class="p">}),</span> <span class="mi">404</span>

    <span class="n">task</span><span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Redirect to the task detail page</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;get_task&#39;</span><span class="p">,</span> <span class="n">task_id</span><span class="o">=</span><span class="n">task_id</span><span class="p">),</span> <span class="n">code</span><span class="o">=</span><span class="mi">303</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_client_basics.py (continued)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_redirect_not_followed_by_default</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that redirects are not followed by default&quot;&quot;&quot;</span>
    <span class="c1"># Create a task first</span>
    <span class="n">create_response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Task&#39;</span><span class="p">})</span>
    <span class="n">task_id</span> <span class="o">=</span> <span class="n">create_response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

    <span class="c1"># Complete the task (triggers redirect)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/tasks/</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s1">/complete&#39;</span><span class="p">)</span>

    <span class="c1"># By default, we get the redirect response</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">303</span>
    <span class="k">assert</span> <span class="s1">&#39;Location&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_client_basics.py::test_redirect_not_followed_by_default<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 1 item

test_client_basics.py::test_redirect_not_followed_by_default PASSED     [100%]

============================== 1 passed in 0.02s ===============================
</code></pre></div>

<p><strong>Limitation preview</strong>: We verified the redirect happened, but we didn't verify where it redirected to or what the final response contains. Let's test following the redirect:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_client_basics.py (continued)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_redirect_followed</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test following redirects&quot;&quot;&quot;</span>
    <span class="c1"># Create a task</span>
    <span class="n">create_response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Task&#39;</span><span class="p">})</span>
    <span class="n">task_id</span> <span class="o">=</span> <span class="n">create_response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

    <span class="c1"># Complete the task and follow redirect</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;/tasks/</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s1">/complete&#39;</span><span class="p">,</span>
        <span class="n">follow_redirects</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Now we get the final response</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
</code></pre></div>

<h3 id="iteration-2-headers-and-cookies">Iteration 2: Headers and Cookies</h3>
<p>Web applications often use headers for authentication and cookies for session management. Let's test these:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Add to app.py</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/tasks/my&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_tasks</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get tasks for the authenticated user&quot;&quot;&quot;</span>
    <span class="n">auth_header</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">auth_header</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Authentication required&#39;</span><span class="p">}),</span> <span class="mi">401</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Simple token validation (in reality, you&#39;d verify the token)</span>
    <span class="k">if</span> <span class="n">token</span> <span class="o">!=</span> <span class="s1">&#39;valid-token&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid token&#39;</span><span class="p">}),</span> <span class="mi">401</span>

    <span class="c1"># Return all tasks (in reality, filter by user)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span> <span class="mi">200</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_client_headers.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_app</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">({</span><span class="s1">&#39;TESTING&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_request_without_auth_header</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that requests without auth header are rejected&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/tasks/my&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span>
    <span class="k">assert</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_request_with_invalid_token</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that invalid tokens are rejected&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;/tasks/my&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="s1">&#39;Bearer invalid-token&#39;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_request_with_valid_token</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test authenticated request&quot;&quot;&quot;</span>
    <span class="c1"># Create a task first</span>
    <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;My task&#39;</span><span class="p">})</span>

    <span class="c1"># Request with valid token</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;/tasks/my&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="s1">&#39;Bearer valid-token&#39;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;My task&#39;</span>
</code></pre></div>

<p>Run these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_client_headers.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 3 items

test_client_headers.py::test_request_without_auth_header PASSED          [ 33%]
test_client_headers.py::test_request_with_invalid_token PASSED           [ 66%]
test_client_headers.py::test_request_with_valid_token PASSED             [100%]

============================== 3 passed in 0.04s ===============================
</code></pre></div>

<p>Now let's test cookie handling:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Add to app.py</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple login that sets a session cookie&quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_response</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>

    <span class="c1"># Simple validation (in reality, check against database)</span>
    <span class="k">if</span> <span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;testuser&#39;</span> <span class="ow">and</span> <span class="n">password</span> <span class="o">==</span> <span class="s1">&#39;testpass&#39;</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Logged in&#39;</span><span class="p">}),</span> <span class="mi">200</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;abc123&#39;</span><span class="p">,</span> <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid credentials&#39;</span><span class="p">}),</span> <span class="mi">401</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/profile&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">profile</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get user profile (requires session cookie)&quot;&quot;&quot;</span>
    <span class="n">session_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">session_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Not authenticated&#39;</span><span class="p">}),</span> <span class="mi">401</span>

    <span class="c1"># In reality, validate session_id against database</span>
    <span class="k">if</span> <span class="n">session_id</span> <span class="o">!=</span> <span class="s1">&#39;abc123&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid session&#39;</span><span class="p">}),</span> <span class="mi">401</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;testuser&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;test@example.com&#39;</span><span class="p">}),</span> <span class="mi">200</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_client_cookies.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_app</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">({</span><span class="s1">&#39;TESTING&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_login_sets_cookie</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that login sets a session cookie&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s1">&#39;/login&#39;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;testuser&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;testpass&#39;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

    <span class="c1"># Check that cookie was set</span>
    <span class="k">assert</span> <span class="s1">&#39;session_id&#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">cookie</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cookie</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">cookie_jar</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_profile_requires_cookie</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that profile endpoint requires session cookie&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/profile&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_profile_with_cookie</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test accessing profile with valid session&quot;&quot;&quot;</span>
    <span class="c1"># Login first to get cookie</span>
    <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s1">&#39;/login&#39;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;testuser&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;testpass&#39;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># Cookie is automatically included in subsequent requests</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/profile&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;testuser&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_manual_cookie_setting</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test manually setting cookies&quot;&quot;&quot;</span>
    <span class="n">client</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;abc123&#39;</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/profile&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
</code></pre></div>

<p>Run these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_client_cookies.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 4 items

test_client_cookies.py::test_login_sets_cookie PASSED                    [ 25%]
test_client_cookies.py::test_profile_requires_cookie PASSED              [ 50%]
test_client_cookies.py::test_profile_with_cookie PASSED                  [ 75%]
test_client_cookies.py::test_manual_cookie_setting PASSED                [100%]

============================== 4 passed in 0.05s ===============================
</code></pre></div>

<h3 id="iteration-3-testing-file-uploads">Iteration 3: Testing File Uploads</h3>
<p>Many web applications handle file uploads. Let's test this functionality:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Add to app.py</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/tasks/&lt;int:task_id&gt;/attachment&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">upload_attachment</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Upload a file attachment to a task&quot;&quot;&quot;</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Task not found&#39;</span><span class="p">}),</span> <span class="mi">404</span>

    <span class="k">if</span> <span class="s1">&#39;file&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No file provided&#39;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Empty filename&#39;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># In reality, save the file to disk or cloud storage</span>
    <span class="c1"># For testing, just store metadata</span>
    <span class="k">if</span> <span class="s1">&#39;attachments&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">task</span><span class="p">:</span>
        <span class="n">task</span><span class="p">[</span><span class="s1">&#39;attachments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">task</span><span class="p">[</span><span class="s1">&#39;attachments&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
        <span class="s1">&#39;content_type&#39;</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">content_type</span><span class="p">,</span>
        <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;File uploaded&#39;</span><span class="p">,</span> <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="p">}),</span> <span class="mi">201</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_client_files.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_app</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">({</span><span class="s1">&#39;TESTING&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_upload_file</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test file upload&quot;&quot;&quot;</span>
    <span class="c1"># Create a task first</span>
    <span class="n">create_response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Task with file&#39;</span><span class="p">})</span>
    <span class="n">task_id</span> <span class="o">=</span> <span class="n">create_response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

    <span class="c1"># Create a fake file</span>
    <span class="n">file_content</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;This is test file content&#39;</span>
    <span class="n">file_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">file_content</span><span class="p">),</span> <span class="s1">&#39;test.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># Upload the file</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;/tasks/</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s1">/attachment&#39;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">file_data</span><span class="p">,</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;multipart/form-data&#39;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;test.txt&#39;</span>

    <span class="c1"># Verify the attachment was stored</span>
    <span class="n">task_response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/tasks/</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">task_response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attachments&#39;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;attachments&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;test.txt&#39;</span>
    <span class="k">assert</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;attachments&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_upload_without_file</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test upload endpoint without file&quot;&quot;&quot;</span>
    <span class="n">create_response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Task&#39;</span><span class="p">})</span>
    <span class="n">task_id</span> <span class="o">=</span> <span class="n">create_response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;/tasks/</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s1">/attachment&#39;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;multipart/form-data&#39;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
    <span class="k">assert</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_upload_empty_filename</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test upload with empty filename&quot;&quot;&quot;</span>
    <span class="n">create_response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Task&#39;</span><span class="p">})</span>
    <span class="n">task_id</span> <span class="o">=</span> <span class="n">create_response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

    <span class="n">file_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;content&#39;</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;/tasks/</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s1">/attachment&#39;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">file_data</span><span class="p">,</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;multipart/form-data&#39;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
</code></pre></div>

<p>Run these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_client_files.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">=============================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">==============================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_client_files</span><span class="o">.</span><span class="n">py</span><span class="p">::</span><span class="n">test_upload_file</span><span class="w"> </span><span class="n">PASSED</span><span class="w">                            </span><span class="p">[</span><span class="w"> </span><span class="mi">33</span><span class="o">%</span><span class="p">]</span>
<span class="n">test_client_files</span><span class="o">.</span><span class="n">py</span><span class="p">::</span><span class="n">test_upload_without_file</span><span class="w"> </span><span class="n">PASSED</span><span class="w">                    </span><span class="p">[</span><span class="w"> </span><span class="mi">66</span><span class="o">%</span><span class="p">]</span>
<span class="n">test_client_files</span><span class="o">.</span><span class="n">py</span><span class="p">::</span><span class="n">test_upload_empty_filename</span><span class="w"> </span><span class="n">PASSED</span><span class="w">                  </span><span class="p">[</span><span class="mi">100</span><span class="o">%</span><span class="p">]</span>

<span class="o">==============================</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.06</span><span class="n">s</span><span class="w"> </span><span class="o">===============================</span>
</code></pre></div>

<h3 id="django-test-client-differences">Django Test Client Differences</h3>
<p>Django's test client has some differences from Flask's. Let's highlight the key ones:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_django_client.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.test</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">django_db</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_django_client_json_shortcut</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Django client has built-in JSON support&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>

    <span class="c1"># Django 3.1+ supports direct JSON posting</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s1">&#39;/blog/posts/&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Test&#39;</span><span class="p">},</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Or use json.dumps explicitly</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s1">&#39;/blog/posts/&#39;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Test&#39;</span><span class="p">}),</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span>
    <span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">django_db</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_django_client_follow_redirects</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Django uses &#39;follow&#39; parameter instead of &#39;follow_redirects&#39;&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>

    <span class="c1"># Note: &#39;follow&#39; not &#39;follow_redirects&#39;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s1">&#39;/some-endpoint/&#39;</span><span class="p">,</span>
        <span class="n">follow</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">django_db</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_django_client_session_access</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Django client provides direct session access&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>

    <span class="c1"># Access session directly</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">session</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">123</span>
    <span class="n">session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="c1"># Session persists across requests</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/profile/&#39;</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">django_db</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_django_client_force_login</span><span class="p">(</span><span class="n">django_user_model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Django client has built-in authentication&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">django_user_model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s1">&#39;testuser&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="s1">&#39;testpass&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Force login without credentials</span>
    <span class="n">client</span><span class="o">.</span><span class="n">force_login</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/profile/&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
</code></pre></div>

<h3 id="common-failure-modes-and-their-signatures_2">Common Failure Modes and Their Signatures</h3>
<h4 id="symptom-content-type-header-is-not-applicationjson">Symptom: "Content-Type header is not application/json"</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>E   AssertionError: assert 400 == 201
E   Response data: {&#39;error&#39;: &#39;Content-Type must be application/json&#39;}
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- 400 Bad Request status
- Error message mentions Content-Type
- Forgot to specify <code>content_type='application/json'</code></p>
<p><strong>Root cause</strong>: Test client defaults to form-encoded data, but API expects JSON</p>
<p><strong>Solution</strong>: Always specify <code>content_type='application/json'</code> when posting JSON data</p>
<h4 id="symptom-cookies-not-persisting-between-requests">Symptom: Cookies not persisting between requests</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>E   AssertionError: assert 401 == 200
E   Response: {&#39;error&#39;: &#39;Not authenticated&#39;}
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- First request (login) succeeds
- Second request (authenticated endpoint) fails with 401
- Cookie was set but not sent in subsequent request</p>
<p><strong>Root cause</strong>: Creating a new client instance between requests</p>
<p><strong>Solution</strong>: Reuse the same client instance across related requests</p>
<h4 id="symptom-file-upload-fails-with-no-file-provided">Symptom: File upload fails with "No file provided"</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>E   AssertionError: assert 400 == 201
E   Response: {&#39;error&#39;: &#39;No file provided&#39;}
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Using <code>json=</code> parameter instead of <code>data=</code>
- Missing <code>content_type='multipart/form-data'</code>
- File not wrapped in tuple format</p>
<p><strong>Root cause</strong>: Incorrect file upload format</p>
<p><strong>Solution</strong>: Use <code>data={'file': (BytesIO(...), 'filename', 'content-type')}</code> with <code>content_type='multipart/form-data'</code></p>
<h3 id="when-to-apply-this-solution_2">When to Apply This Solution</h3>
<p><strong>What it optimizes for</strong>:
- Fast test execution (no network overhead)
- Complete control over request parameters
- Easy testing of edge cases and error conditions
- Deterministic test behavior</p>
<p><strong>What it sacrifices</strong>:
- Doesn't test actual HTTP server behavior
- Doesn't catch issues with reverse proxies or load balancers
- Doesn't test browser-specific behavior (JavaScript, rendering)</p>
<p><strong>When to choose this approach</strong>:
- Unit and integration testing of API endpoints
- Testing request validation and error handling
- CI/CD pipelines where speed matters
- Testing authentication and authorization logic</p>
<p><strong>When to avoid this approach</strong>:
- End-to-end testing of user workflows
- Testing JavaScript-heavy applications
- Performance testing under load
- Testing deployment configuration</p>
<p><strong>Code characteristics</strong>:
- <strong>Setup complexity</strong>: Low (built into frameworks)
- <strong>Maintenance burden</strong>: Low (tests are simple and fast)
- <strong>Testability</strong>: High (easy to test all code paths)</p>
<h2 id="fixtures-for-web-app-testing">Fixtures for Web App Testing</h2>
<h2 id="fixtures-for-web-app-testing_1">Fixtures for Web App Testing</h2>
<p>Web application testing requires careful setup: creating test databases, initializing application instances, managing user sessions, and preparing test data. Fixtures are the key to making this setup reusable, composable, and maintainable.</p>
<h3 id="the-fixture-hierarchy-for-web-testing">The Fixture Hierarchy for Web Testing</h3>
<p>Web application fixtures typically follow this dependency hierarchy:</p>
<div class="codehilite"><pre><span></span><code>app (application instance)
  ‚Üì
db (database connection)
  ‚Üì
user (test user)
  ‚Üì
authenticated_client (logged-in test client)
  ‚Üì
test_data (domain objects: posts, tasks, etc.)
</code></pre></div>

<p>Let's build this hierarchy step by step, starting with our Flask task API.</p>
<h3 id="iteration-1-basic-application-fixtures">Iteration 1: Basic Application Fixtures</h3>
<p>We've already seen simple app and client fixtures. Let's make them more sophisticated:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_app</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">app</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create application instance for the entire test session&quot;&quot;&quot;</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">({</span>
        <span class="s1">&#39;TESTING&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">:</span> <span class="s1">&#39;test-secret-key&#39;</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="k">yield</span> <span class="n">app</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a test client for each test&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">runner</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a CLI test runner&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">app</span><span class="o">.</span><span class="n">test_cli_runner</span><span class="p">()</span>
</code></pre></div>

<p>This works, but there's a problem. Let's test it:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_fixtures_basic.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_first_task</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a task&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;First task&#39;</span><span class="p">})</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_second_task</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create another task&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Second task&#39;</span><span class="p">})</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># Expect ID 1 in fresh state</span>
</code></pre></div>

<p>Run these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_fixtures_basic.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>The complete output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 2 items

test_fixtures_basic.py::test_first_task PASSED                           [ 50%]
test_fixtures_basic.py::test_second_task FAILED                          [100%]

=================================== FAILURES ===================================
____________________________ test_second_task __________________________________

client = &lt;FlaskClient &lt;Flask &#39;app&#39;&gt;&gt;

    def test_second_task(client):
        &quot;&quot;&quot;Create another task&quot;&quot;&quot;
        response = client.post(&#39;/tasks&#39;, json={&#39;title&#39;: &#39;Second task&#39;})
<span class="k">&gt; </span><span class="ge">      assert response.get_json()[&#39;id&#39;] == 1</span>
E       AssertionError: assert 2 == 1
E        +  where 2 = {&#39;id&#39;: 2, &#39;title&#39;: &#39;Second task&#39;, ...}[&#39;id&#39;]

test_fixtures_basic.py:8: AssertionError
=========================== 1 failed, 1 passed in 0.04s =======================
</code></pre></div>

<h3 id="diagnostic-analysis-session-scoped-state-pollution">Diagnostic Analysis: Session-Scoped State Pollution</h3>
<p><strong>Let's parse this section by section</strong>:</p>
<p><strong>1. The assertion introspection</strong>:</p>
<div class="codehilite"><pre><span></span><code>E       AssertionError: assert 2 == 1
E        +  where 2 = {&#39;id&#39;: 2, &#39;title&#39;: &#39;Second task&#39;, ...}[&#39;id&#39;]
</code></pre></div>

<ul>
<li>What this tells us: The second test got ID 2, not ID 1</li>
<li>Key insight: State from the first test persisted</li>
</ul>
<p><strong>2. Looking at our fixture</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">app</span><span class="p">():</span>
</code></pre></div>

<ul>
<li>What this tells us: The app fixture is session-scoped</li>
<li>Key insight: The same app instance is reused across all tests</li>
</ul>
<p><strong>Root cause identified</strong>: Session-scoped fixtures are efficient but cause state pollution. The app's in-memory storage persists across tests.</p>
<p><strong>Why the current approach can't solve this</strong>: We need the app to be session-scoped for performance (creating apps is expensive), but we need fresh state for each test.</p>
<p><strong>What we need</strong>: A way to reset application state between tests while keeping the app instance itself session-scoped.</p>
<h3 id="iteration-2-state-management-with-context-managers">Iteration 2: State Management with Context Managers</h3>
<p>The solution is to separate the app instance (session-scoped) from the app state (function-scoped):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (refactored)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_app</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">app</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create application instance once per session&quot;&quot;&quot;</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">({</span>
        <span class="s1">&#39;TESTING&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">:</span> <span class="s1">&#39;test-secret-key&#39;</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="k">yield</span> <span class="n">app</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">app_context</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a fresh application context for each test&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>
        <span class="c1"># Reset application state</span>
        <span class="n">app</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">app</span><span class="o">.</span><span class="n">task_id_counter</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">yield</span> <span class="n">app</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">(</span><span class="n">app_context</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a test client with fresh state&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">app_context</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>
</code></pre></div>

<p>Run the tests again:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_fixtures_basic.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 2 items

test_fixtures_basic.py::test_first_task PASSED                           [ 50%]
test_fixtures_basic.py::test_second_task PASSED                          [100%]

============================== 2 passed in 0.03s ===============================
</code></pre></div>

<p><strong>Expected vs. Actual improvement</strong>:
- Tests now pass consistently
- App instance is created once (fast)
- State is reset for each test (isolated)</p>
<h3 id="iteration-3-database-fixtures">Iteration 3: Database Fixtures</h3>
<p>Real web applications use databases. Let's add database fixtures to our hierarchy:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (with database support)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_app</span><span class="p">,</span> <span class="n">db</span> <span class="k">as</span> <span class="n">_db</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Task</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">app</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create application instance with test database&quot;&quot;&quot;</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">({</span>
        <span class="s1">&#39;TESTING&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class="p">:</span> <span class="s1">&#39;sqlite:///:memory:&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SQLALCHEMY_TRACK_MODIFICATIONS&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="k">yield</span> <span class="n">app</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create database schema once per session&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>
        <span class="n">_db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
        <span class="k">yield</span> <span class="n">_db</span>
        <span class="n">_db</span><span class="o">.</span><span class="n">drop_all</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">session</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a fresh database session for each test&quot;&quot;&quot;</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">transaction</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>

    <span class="c1"># Create a session bound to the connection</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">create_scoped_session</span><span class="p">(</span>
        <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;bind&#39;</span><span class="p">:</span> <span class="n">connection</span><span class="p">,</span> <span class="s1">&#39;binds&#39;</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>

    <span class="k">yield</span> <span class="n">session</span>

    <span class="c1"># Rollback transaction to reset database state</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">session</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a test client with database access&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>
</code></pre></div>

<p>Now we can write tests that use the database:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_fixtures_database.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Task</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_user</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test creating a user in the database&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;testuser&#39;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s1">&#39;test@example.com&#39;</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_database_is_empty_initially</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify database starts empty for each test&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">Task</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_task_for_user</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test creating a task associated with a user&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;testuser&#39;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s1">&#39;test@example.com&#39;</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Test task&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">task</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">task</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;testuser&#39;</span>
</code></pre></div>

<p>Run these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_fixtures_database.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 3 items

test_fixtures_database.py::test_create_user PASSED                       [ 33%]
test_fixtures_database.py::test_database_is_empty_initially PASSED       [ 66%]
test_fixtures_database.py::test_create_task_for_user PASSED              [100%]

============================== 3 passed in 0.12s ===============================
</code></pre></div>

<h3 id="iteration-4-user-and-authentication-fixtures">Iteration 4: User and Authentication Fixtures</h3>
<p>Most web applications require authentication. Let's create fixtures for users and authenticated clients:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (with authentication fixtures)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a test user&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s1">&#39;testuser&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s1">&#39;test@example.com&#39;</span>
    <span class="p">)</span>
    <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="s1">&#39;testpass123&#39;</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">user</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">admin_user</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create an admin user&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s1">&#39;admin@example.com&#39;</span><span class="p">,</span>
        <span class="n">is_admin</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="s1">&#39;adminpass123&#39;</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">user</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticated_client</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a client authenticated as the test user&quot;&quot;&quot;</span>
    <span class="c1"># Login</span>
    <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;testuser&#39;</span><span class="p">,</span>
        <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;testpass123&#39;</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="n">client</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">admin_client</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">admin_user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a client authenticated as admin&quot;&quot;&quot;</span>
    <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;admin&#39;</span><span class="p">,</span>
        <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;adminpass123&#39;</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="n">client</span>
</code></pre></div>

<p>Now we can write tests that use authentication:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_fixtures_auth.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_unauthenticated_access_denied</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that unauthenticated requests are rejected&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/tasks/my&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authenticated_access_allowed</span><span class="p">(</span><span class="n">authenticated_client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that authenticated requests succeed&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">authenticated_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/tasks/my&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_admin_access</span><span class="p">(</span><span class="n">admin_client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test admin-only endpoint&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">admin_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/admin/users&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_regular_user_cannot_access_admin</span><span class="p">(</span><span class="n">authenticated_client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that regular users cannot access admin endpoints&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">authenticated_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/admin/users&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span>
</code></pre></div>

<h3 id="iteration-5-test-data-fixtures">Iteration 5: Test Data Fixtures</h3>
<p>Complex tests often require multiple related objects. Let's create fixtures for common test data scenarios:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (with test data fixtures)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span><span class="p">,</span> <span class="n">Comment</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">task</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a single test task&quot;&quot;&quot;</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Test Task&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Test description&#39;</span><span class="p">,</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
    <span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">task</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">tasks</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create multiple test tasks&quot;&quot;&quot;</span>
    <span class="n">task_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Task </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Description </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">completed</span><span class="o">=</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Alternate completed status</span>
        <span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="n">task_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">task_list</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">task_with_comments</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a task with multiple comments&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Comment </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">task_id</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">task</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">multi_user_tasks</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">admin_user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create tasks for multiple users&quot;&quot;&quot;</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># User&#39;s tasks</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;User Task </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

    <span class="c1"># Admin&#39;s tasks</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Admin Task </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">admin_user</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">tasks</span>
</code></pre></div>

<p>Now we can write tests that use complex test data:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_fixtures_data.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_task</span><span class="p">(</span><span class="n">authenticated_client</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test retrieving a single task&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">authenticated_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/tasks/</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Test Task&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_list_tasks</span><span class="p">(</span><span class="n">authenticated_client</span><span class="p">,</span> <span class="n">tasks</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test listing multiple tasks&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">authenticated_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;tasks&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">5</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_filter_completed_tasks</span><span class="p">(</span><span class="n">authenticated_client</span><span class="p">,</span> <span class="n">tasks</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test filtering by completion status&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">authenticated_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/tasks?completed=true&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="c1"># 3 out of 5 tasks are completed (indices 0, 2, 4)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;tasks&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_task_with_comments</span><span class="p">(</span><span class="n">authenticated_client</span><span class="p">,</span> <span class="n">task_with_comments</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test retrieving a task with its comments&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">authenticated_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/tasks/</span><span class="si">{</span><span class="n">task_with_comments</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">/comments&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_user_sees_only_own_tasks</span><span class="p">(</span><span class="n">authenticated_client</span><span class="p">,</span> <span class="n">multi_user_tasks</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that users only see their own tasks&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">authenticated_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/tasks/my&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="c1"># Should only see the 3 user tasks, not the 2 admin tasks</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;tasks&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="s1">&#39;User Task&#39;</span> <span class="ow">in</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tasks&#39;</span><span class="p">])</span>
</code></pre></div>

<p>Run these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_fixtures_data.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 5 items

test_fixtures_data.py::test_get_task PASSED                              [ 20%]
test_fixtures_data.py::test_list_tasks PASSED                            [ 40%]
test_fixtures_data.py::test_filter_completed_tasks PASSED                [ 60%]
test_fixtures_data.py::test_task_with_comments PASSED                    [ 80%]
test_fixtures_data.py::test_user_sees_only_own_tasks PASSED              [100%]

============================== 5 passed in 0.23s ===============================
</code></pre></div>

<h3 id="fixture-composition-patterns">Fixture Composition Patterns</h3>
<p>Let's explore advanced fixture composition patterns:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (advanced patterns)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_headers</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Common API headers&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span>
    <span class="p">}</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">auth_headers</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Headers with authentication token&quot;&quot;&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">generate_auth_token</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="p">}</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">client_with_headers</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">api_headers</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Client that automatically includes API headers&quot;&quot;&quot;</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">ClientWithHeaders</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;headers&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;headers&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Add other HTTP methods as needed</span>

    <span class="k">return</span> <span class="n">ClientWithHeaders</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">api_headers</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;admin&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">any_authenticated_client</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">admin_user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parametrized fixture that tests with both user types&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span> <span class="o">==</span> <span class="s1">&#39;user&#39;</span><span class="p">:</span>
        <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;testuser&#39;</span><span class="p">,</span>
            <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;testpass123&#39;</span>
        <span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;admin&#39;</span><span class="p">,</span>
            <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;adminpass123&#39;</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">client</span>
</code></pre></div>

<h3 id="common-failure-modes-and-their-signatures_3">Common Failure Modes and Their Signatures</h3>
<h4 id="symptom-working-outside-of-application-context">Symptom: "Working outside of application context"</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>E   RuntimeError: Working outside of application context.
E   This typically means that you attempted to use functionality that needed
E   to interface with the current application object in some way.
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Error occurs when accessing Flask features (current_app, g, url_for)
- Happens in fixtures or helper functions
- Code works fine in actual application</p>
<p><strong>Root cause</strong>: Flask requires an application context for certain operations</p>
<p><strong>Solution</strong>: Wrap code in <code>with app.app_context():</code> or use <code>app_context</code> fixture</p>
<h4 id="symptom-database-changes-persist-across-tests">Symptom: Database changes persist across tests</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>E   AssertionError: assert 3 == 0
E   Expected empty database but found 3 users
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- First test passes, subsequent tests fail
- Database queries return unexpected data
- Tests pass when run individually</p>
<p><strong>Root cause</strong>: Database session not properly rolled back between tests</p>
<p><strong>Solution</strong>: Use transactional fixtures that rollback after each test</p>
<h4 id="symptom-fixtures-not-found-or-not-executing">Symptom: Fixtures not found or not executing</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>E   fixture &#39;authenticated_client&#39; not found
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Fixture is defined but pytest can't find it
- Fixture is in wrong file or wrong scope
- Import issues with conftest.py</p>
<p><strong>Root cause</strong>: Fixture not in conftest.py or not properly scoped</p>
<p><strong>Solution</strong>: Move fixtures to conftest.py or ensure proper import paths</p>
<h3 id="when-to-apply-this-solution_3">When to Apply This Solution</h3>
<p><strong>What it optimizes for</strong>:
- Test isolation and reliability
- Reusable test setup code
- Fast test execution through proper scoping
- Clear test intent (fixtures document what's needed)</p>
<p><strong>What it sacrifices</strong>:
- Initial setup complexity
- Learning curve for fixture composition
- Potential over-abstraction if not careful</p>
<p><strong>When to choose this approach</strong>:
- Projects with complex test setup requirements
- When multiple tests need similar setup
- When test isolation is critical
- When test speed matters (proper scoping)</p>
<p><strong>When to avoid this approach</strong>:
- Very simple applications with minimal setup
- One-off tests that don't benefit from reuse
- When team is unfamiliar with pytest fixtures</p>
<p><strong>Code characteristics</strong>:
- <strong>Setup complexity</strong>: Medium to High (requires understanding fixture scopes)
- <strong>Maintenance burden</strong>: Low (once set up, very maintainable)
- <strong>Testability</strong>: Very High (fixtures make complex scenarios easy to test)</p>
<h2 id="testing-request-handlers">Testing Request Handlers</h2>
<h2 id="testing-request-handlers_1">Testing Request Handlers</h2>
<p>Request handlers are the core of web applications‚Äîthey receive HTTP requests, process them, and return responses. Testing them thoroughly requires understanding how to simulate different request scenarios, validate responses, and handle edge cases.</p>
<h3 id="the-anatomy-of-a-request-handler">The Anatomy of a Request Handler</h3>
<p>A typical request handler:
1. Validates input (query params, body, headers)
2. Authenticates/authorizes the request
3. Performs business logic
4. Interacts with the database
5. Returns a formatted response</p>
<p>Let's test each of these aspects systematically.</p>
<h3 id="iteration-1-testing-input-validation">Iteration 1: Testing Input Validation</h3>
<p>Input validation is the first line of defense. Let's test it thoroughly:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># app/views.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_task</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a new task with validation&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>

    <span class="c1"># Validation: title is required</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span> <span class="ow">or</span> <span class="s1">&#39;title&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Title is required&#39;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># Validation: title must not be empty</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Title cannot be empty&#39;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># Validation: title length</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Title too long (max 200 characters)&#39;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># Validation: priority must be valid</span>
    <span class="n">priority</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">priority</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid priority&#39;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># Validation: due_date format</span>
    <span class="n">due_date</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;due_date&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">due_date</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">due_date</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid date format (use ISO 8601)&#39;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># Create task</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
        <span class="n">description</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
        <span class="n">due_date</span><span class="o">=</span><span class="n">due_date</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()),</span> <span class="mi">201</span>
</code></pre></div>

<p>Now let's write comprehensive validation tests:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_request_handlers.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_task_success</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test successful task creation&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Valid task&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Task description&#39;</span><span class="p">,</span>
        <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span>
        <span class="s1">&#39;due_date&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">))</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
    <span class="p">})</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Valid task&#39;</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;priority&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_task_missing_title</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that missing title is rejected&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;No title&#39;</span>
    <span class="p">})</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
    <span class="k">assert</span> <span class="s1">&#39;Title is required&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_task_empty_title</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that empty title is rejected&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;   &#39;</span>  <span class="c1"># Only whitespace</span>
    <span class="p">})</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
    <span class="k">assert</span> <span class="s1">&#39;cannot be empty&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_task_title_too_long</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that overly long titles are rejected&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;x&#39;</span> <span class="o">*</span> <span class="mi">201</span>  <span class="c1"># 201 characters</span>
    <span class="p">})</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
    <span class="k">assert</span> <span class="s1">&#39;too long&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_task_invalid_priority</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that invalid priority is rejected&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Task&#39;</span><span class="p">,</span>
        <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="s1">&#39;urgent&#39;</span>  <span class="c1"># Not in allowed values</span>
    <span class="p">})</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
    <span class="k">assert</span> <span class="s1">&#39;Invalid priority&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_task_invalid_date_format</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that invalid date format is rejected&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Task&#39;</span><span class="p">,</span>
        <span class="s1">&#39;due_date&#39;</span><span class="p">:</span> <span class="s1">&#39;2024-13-45&#39;</span>  <span class="c1"># Invalid date</span>
    <span class="p">})</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
    <span class="k">assert</span> <span class="s1">&#39;Invalid date format&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_task_with_defaults</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that defaults are applied correctly&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Minimal task&#39;</span>
    <span class="p">})</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;priority&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;medium&#39;</span>  <span class="c1"># Default</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># Default</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;due_date&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>  <span class="c1"># Default</span>
</code></pre></div>

<p>Run these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_request_handlers.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 7 items

test_request_handlers.py::test_create_task_success PASSED                [ 14%]
test_request_handlers.py::test_create_task_missing_title PASSED          [ 28%]
test_request_handlers.py::test_create_task_empty_title PASSED            [ 42%]
test_request_handlers.py::test_create_task_title_too_long PASSED         [ 57%]
test_request_handlers.py::test_create_task_invalid_priority PASSED       [ 71%]
test_request_handlers.py::test_create_task_invalid_date_format PASSED    [ 85%]
test_request_handlers.py::test_create_task_with_defaults PASSED          [100%]

============================== 7 passed in 0.18s ===============================
</code></pre></div>

<h3 id="iteration-2-testing-query-parameters-and-filtering">Iteration 2: Testing Query Parameters and Filtering</h3>
<p>Many endpoints accept query parameters for filtering, sorting, and pagination. Let's test these:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># app/views.py (add this endpoint)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">list_tasks</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List tasks with filtering and pagination&quot;&quot;&quot;</span>
    <span class="c1"># Get query parameters</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">per_page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;per_page&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">priority</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;priority&#39;</span><span class="p">)</span>
    <span class="n">completed</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;completed&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">)</span>
    <span class="n">sort_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sort_by&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">)</span>

    <span class="c1"># Validate parameters</span>
    <span class="k">if</span> <span class="n">per_page</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;per_page cannot exceed 100&#39;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="k">if</span> <span class="n">sort_by</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;due_date&#39;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid sort_by field&#39;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="k">if</span> <span class="n">order</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;asc&#39;</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid order (use asc or desc)&#39;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># Build query</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">query</span>

    <span class="k">if</span> <span class="n">priority</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">completed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">completed</span><span class="o">=</span><span class="n">completed</span><span class="p">)</span>

    <span class="c1"># Apply sorting</span>
    <span class="n">sort_column</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">Task</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span>
        <span class="n">sort_column</span> <span class="o">=</span> <span class="n">sort_column</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">sort_column</span><span class="p">)</span>

    <span class="c1"># Paginate</span>
    <span class="n">pagination</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="n">per_page</span><span class="p">,</span> <span class="n">error_out</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s1">&#39;tasks&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">pagination</span><span class="o">.</span><span class="n">items</span><span class="p">],</span>
        <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">pagination</span><span class="o">.</span><span class="n">total</span><span class="p">,</span>
        <span class="s1">&#39;page&#39;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span>
        <span class="s1">&#39;per_page&#39;</span><span class="p">:</span> <span class="n">per_page</span><span class="p">,</span>
        <span class="s1">&#39;pages&#39;</span><span class="p">:</span> <span class="n">pagination</span><span class="o">.</span><span class="n">pages</span>
    <span class="p">}),</span> <span class="mi">200</span>
</code></pre></div>

<p>Now test the query parameter handling:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_request_handlers.py (continued)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_list_tasks_default_pagination</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">tasks</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test default pagination&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s1">&#39;tasks&#39;</span> <span class="ow">in</span> <span class="n">data</span>
    <span class="k">assert</span> <span class="s1">&#39;total&#39;</span> <span class="ow">in</span> <span class="n">data</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;per_page&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">10</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_list_tasks_custom_pagination</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">tasks</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test custom pagination parameters&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/tasks?page=2&amp;per_page=2&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;page&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;per_page&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;tasks&#39;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_list_tasks_filter_by_priority</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">tasks</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test filtering by priority&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/tasks?priority=high&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;priority&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tasks&#39;</span><span class="p">])</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_list_tasks_filter_by_completed</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">tasks</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test filtering by completion status&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/tasks?completed=true&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tasks&#39;</span><span class="p">])</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_list_tasks_sort_by_title</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">tasks</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test sorting by title&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/tasks?sort_by=title&amp;order=asc&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tasks&#39;</span><span class="p">]]</span>
    <span class="k">assert</span> <span class="n">titles</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">titles</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_list_tasks_invalid_per_page</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that excessive per_page is rejected&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/tasks?per_page=101&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
    <span class="k">assert</span> <span class="s1">&#39;cannot exceed 100&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_list_tasks_invalid_sort_field</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that invalid sort field is rejected&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/tasks?sort_by=invalid_field&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
    <span class="k">assert</span> <span class="s1">&#39;Invalid sort_by&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_list_tasks_combined_filters</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">tasks</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test combining multiple filters&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/tasks?priority=high&amp;completed=false&amp;sort_by=due_date&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tasks&#39;</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;priority&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span>
        <span class="k">assert</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
</code></pre></div>

<h3 id="iteration-3-testing-request-context-and-headers">Iteration 3: Testing Request Context and Headers</h3>
<p>Some handlers depend on request context (headers, cookies, remote address). Let's test these:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># app/views.py (add this endpoint)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/tasks/&lt;int:task_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update a task with optimistic locking&quot;&quot;&quot;</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>

    <span class="c1"># Check If-Match header for optimistic locking</span>
    <span class="n">if_match</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;If-Match&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">if_match</span> <span class="ow">and</span> <span class="n">if_match</span> <span class="o">!=</span> <span class="n">task</span><span class="o">.</span><span class="n">etag</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Task was modified by another request&#39;</span><span class="p">,</span>
            <span class="s1">&#39;current_etag&#39;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">etag</span>
        <span class="p">}),</span> <span class="mi">412</span>  <span class="c1"># Precondition Failed</span>

    <span class="c1"># Check rate limiting based on IP</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">app.rate_limiter</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_rate_limit</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_rate_limit</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Rate limit exceeded&#39;</span><span class="p">}),</span> <span class="mi">429</span>

    <span class="c1"># Update task</span>
    <span class="k">if</span> <span class="s1">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">task</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">task</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;completed&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">task</span><span class="o">.</span><span class="n">completed</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">]</span>

    <span class="n">task</span><span class="o">.</span><span class="n">update_etag</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;ETag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">etag</span>
    <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="mi">200</span>
</code></pre></div>

<p>Test the header-dependent behavior:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_request_handlers.py (continued)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_update_task_without_etag</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test update without ETag header&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/tasks/</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Updated title&#39;</span>
    <span class="p">})</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Updated title&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_update_task_with_matching_etag</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test update with correct ETag&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;/tasks/</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Updated title&#39;</span><span class="p">},</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;If-Match&#39;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">etag</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_update_task_with_stale_etag</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test update with outdated ETag&quot;&quot;&quot;</span>
    <span class="n">old_etag</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">etag</span>

    <span class="c1"># Simulate another update</span>
    <span class="n">task</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Changed by someone else&#39;</span>
    <span class="n">task</span><span class="o">.</span><span class="n">update_etag</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c1"># Try to update with old ETag</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;/tasks/</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;My update&#39;</span><span class="p">},</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;If-Match&#39;</span><span class="p">:</span> <span class="n">old_etag</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">412</span>
    <span class="k">assert</span> <span class="s1">&#39;modified by another request&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_update_task_rate_limiting</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test rate limiting&quot;&quot;&quot;</span>
    <span class="c1"># Mock the rate limiter to return False</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mock_check_rate_limit</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="s1">&#39;app.rate_limiter.check_rate_limit&#39;</span><span class="p">,</span> <span class="n">mock_check_rate_limit</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/tasks/</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Updated&#39;</span>
    <span class="p">})</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">429</span>
    <span class="k">assert</span> <span class="s1">&#39;Rate limit exceeded&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_response_includes_etag_header</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that response includes ETag header&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/tasks/</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Updated&#39;</span>
    <span class="p">})</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="s1">&#39;ETag&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;ETag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;etag&#39;</span><span class="p">]</span>
</code></pre></div>

<h3 id="iteration-4-testing-error-handling-and-edge-cases">Iteration 4: Testing Error Handling and Edge Cases</h3>
<p>Robust handlers handle errors gracefully. Let's test error scenarios:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># app/views.py (add error handling)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/tasks/&lt;int:task_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete a task with proper error handling&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>

        <span class="c1"># Check if task has dependencies</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Cannot delete task with comments&#39;</span><span class="p">,</span>
                <span class="s1">&#39;comment_count&#39;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="p">}),</span> <span class="mi">409</span>  <span class="c1"># Conflict</span>

        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">204</span>  <span class="c1"># No Content</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error deleting task </span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Internal server error&#39;</span><span class="p">}),</span> <span class="mi">500</span>
</code></pre></div>

<p>Test error handling:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_request_handlers.py (continued)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_delete_task_success</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test successful task deletion&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/tasks/</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">204</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>

    <span class="c1"># Verify task is deleted</span>
    <span class="k">assert</span> <span class="n">Task</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_delete_nonexistent_task</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test deleting non-existent task&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;/tasks/99999&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_delete_task_with_comments</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">task_with_comments</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that tasks with comments cannot be deleted&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/tasks/</span><span class="si">{</span><span class="n">task_with_comments</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">409</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s1">&#39;Cannot delete&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;comment_count&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="c1"># Verify task still exists</span>
    <span class="k">assert</span> <span class="n">Task</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_with_comments</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_delete_task_database_error</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test handling of database errors&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mock_commit</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Database connection lost&#39;</span><span class="p">)</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="s1">&#39;app.db.session.commit&#39;</span><span class="p">,</span> <span class="n">mock_commit</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/tasks/</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">500</span>
    <span class="k">assert</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>

    <span class="c1"># Verify task still exists (rollback worked)</span>
    <span class="k">assert</span> <span class="n">Task</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</code></pre></div>

<p>Run all request handler tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_request_handlers.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 23 items

test_request_handlers.py::test_create_task_success PASSED                [  4%]
test_request_handlers.py::test_create_task_missing_title PASSED          [  8%]
test_request_handlers.py::test_create_task_empty_title PASSED            [ 13%]
test_request_handlers.py::test_create_task_title_too_long PASSED         [ 17%]
test_request_handlers.py::test_create_task_invalid_priority PASSED       [ 21%]
test_request_handlers.py::test_create_task_invalid_date_format PASSED    [ 26%]
test_request_handlers.py::test_create_task_with_defaults PASSED          [ 30%]
test_request_handlers.py::test_list_tasks_default_pagination PASSED      [ 34%]
test_request_handlers.py::test_list_tasks_custom_pagination PASSED       [ 39%]
test_request_handlers.py::test_list_tasks_filter_by_priority PASSED      [ 43%]
test_request_handlers.py::test_list_tasks_filter_by_completed PASSED     [ 47%]
test_request_handlers.py::test_list_tasks_sort_by_title PASSED           [ 52%]
test_request_handlers.py::test_list_tasks_invalid_per_page PASSED        [ 56%]
test_request_handlers.py::test_list_tasks_invalid_sort_field PASSED      [ 60%]
test_request_handlers.py::test_list_tasks_combined_filters PASSED        [ 65%]
test_request_handlers.py::test_update_task_without_etag PASSED           [ 69%]
test_request_handlers.py::test_update_task_with_matching_etag PASSED     [ 73%]
test_request_handlers.py::test_update_task_with_stale_etag PASSED        [ 78%]
test_request_handlers.py::test_update_task_rate_limiting PASSED          [ 82%]
test_request_handlers.py::test_response_includes_etag_header PASSED      [ 86%]
test_request_handlers.py::test_delete_task_success PASSED                [ 91%]
test_request_handlers.py::test_delete_nonexistent_task PASSED            [ 95%]
test_request_handlers.py::test_delete_task_with_comments PASSED          [100%]

============================== 23 passed in 0.45s ===============================
</code></pre></div>

<h3 id="common-failure-modes-and-their-signatures_4">Common Failure Modes and Their Signatures</h3>
<h4 id="symptom-tests-pass-but-real-requests-fail-with-400-bad-request">Symptom: Tests pass but real requests fail with 400 Bad Request</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_create_task PASSED
<span class="gh">#</span> But in production:
<span class="gh">#</span> 400 Bad Request: &quot;The browser (or proxy) sent a request that this server could not understand.&quot;
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Tests use <code>json=</code> parameter correctly
- Real requests send different Content-Type
- Missing <code>Content-Type: application/json</code> header in production</p>
<p><strong>Root cause</strong>: Test client automatically sets correct headers, but real clients might not</p>
<p><strong>Solution</strong>: Add explicit header validation in handler and test both with and without correct headers</p>
<h4 id="symptom-query-parameter-tests-fail-with-unexpected-types">Symptom: Query parameter tests fail with unexpected types</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>E   TypeError: &#39;&gt;&#39; not supported between instances of &#39;str&#39; and &#39;int&#39;
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Error occurs when comparing query parameter values
- Query parameters are strings by default
- Missing type conversion in handler</p>
<p><strong>Root cause</strong>: Forgot to specify <code>type=</code> parameter in <code>request.args.get()</code></p>
<p><strong>Solution</strong>: Always specify type conversion: <code>request.args.get('page', 1, type=int)</code></p>
<h4 id="symptom-tests-pass-but-handler-modifies-database-unexpectedly">Symptom: Tests pass but handler modifies database unexpectedly</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_get_task PASSED
<span class="gh">#</span> But database shows unexpected changes
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- GET request handler modifies data
- Tests don't verify database state after request
- Side effects not caught by response assertions</p>
<p><strong>Root cause</strong>: Handler has unintended side effects</p>
<p><strong>Solution</strong>: Add assertions that verify database state remains unchanged for read-only operations</p>
<h3 id="when-to-apply-this-solution_4">When to Apply This Solution</h3>
<p><strong>What it optimizes for</strong>:
- Comprehensive validation testing
- Edge case coverage
- Error handling verification
- Request/response contract testing</p>
<p><strong>What it sacrifices</strong>:
- Test verbosity (many small tests)
- Setup complexity for complex scenarios
- Time to write comprehensive test suites</p>
<p><strong>When to choose this approach</strong>:
- Public APIs that need robust validation
- Handlers with complex business logic
- Critical endpoints that handle sensitive data
- When debugging production issues</p>
<p><strong>When to avoid this approach</strong>:
- Simple CRUD operations with minimal logic
- Internal APIs with trusted clients
- Prototype or proof-of-concept code
- When time constraints are severe</p>
<p><strong>Code characteristics</strong>:
- <strong>Setup complexity</strong>: Medium (requires good fixtures)
- <strong>Maintenance burden</strong>: Medium (many tests to maintain)
- <strong>Testability</strong>: Very High (catches most handler bugs)</p>
<h2 id="testing-middleware-and-authentication">Testing Middleware and Authentication</h2>
<h2 id="testing-middleware-and-authentication_1">Testing Middleware and Authentication</h2>
<p>Middleware and authentication systems are the gatekeepers of web applications. They intercept requests before they reach handlers, making them critical to test thoroughly. Let's build a complete testing strategy for these cross-cutting concerns.</p>
<h3 id="the-reference-implementation-jwt-authentication-middleware">The Reference Implementation: JWT Authentication Middleware</h3>
<p>We'll implement and test a JWT-based authentication system with role-based access control:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># app/middleware.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s1">&#39;your-secret-key&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">generate_token</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a JWT token&quot;&quot;&quot;</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
        <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span>
        <span class="s1">&#39;exp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">),</span>
        <span class="s1">&#39;iat&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;HS256&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">token_required</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator to require valid JWT token&quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Get token from Authorization header</span>
        <span class="n">auth_header</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">auth_header</span> <span class="ow">and</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">):</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Token is missing&#39;</span><span class="p">}),</span> <span class="mi">401</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Decode token</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HS256&#39;</span><span class="p">])</span>
            <span class="n">g</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>
            <span class="n">g</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">ExpiredSignatureError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Token has expired&#39;</span><span class="p">}),</span> <span class="mi">401</span>
        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid token&#39;</span><span class="p">}),</span> <span class="mi">401</span>

        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">decorated</span>

<span class="k">def</span><span class="w"> </span><span class="nf">role_required</span><span class="p">(</span><span class="n">required_role</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator to require specific role&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="nd">@token_required</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="n">required_role</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s1">&#39;admin&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient permissions&#39;</span><span class="p">}),</span> <span class="mi">403</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decorated</span>
    <span class="k">return</span> <span class="n">decorator</span>
</code></pre></div>

<p>Now let's create protected endpoints:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># app/views.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.middleware</span><span class="w"> </span><span class="kn">import</span> <span class="n">token_required</span><span class="p">,</span> <span class="n">role_required</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/protected&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@token_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">protected_endpoint</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Endpoint that requires authentication&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Access granted&#39;</span><span class="p">,</span>
        <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
        <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">role</span>
    <span class="p">}),</span> <span class="mi">200</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/admin/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@role_required</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">admin_endpoint</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Endpoint that requires admin role&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Admin access granted&#39;</span><span class="p">,</span>
        <span class="s1">&#39;users&#39;</span><span class="p">:</span> <span class="p">[]</span>  <span class="c1"># Would fetch from database</span>
    <span class="p">}),</span> <span class="mi">200</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/moderator/reports&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@role_required</span><span class="p">(</span><span class="s1">&#39;moderator&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">moderator_endpoint</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Endpoint that requires moderator role&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Moderator access granted&#39;</span><span class="p">,</span>
        <span class="s1">&#39;reports&#39;</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">}),</span> <span class="mi">200</span>
</code></pre></div>

<h3 id="iteration-1-testing-basic-authentication">Iteration 1: Testing Basic Authentication</h3>
<p>Let's start by testing the authentication decorator:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_middleware.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_app</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.middleware</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_token</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">app</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">create_app</span><span class="p">({</span><span class="s1">&#39;TESTING&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_protected_endpoint_without_token</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that requests without token are rejected&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/protected&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span>
    <span class="k">assert</span> <span class="s1">&#39;Token is missing&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_protected_endpoint_with_valid_token</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that valid token grants access&quot;&quot;&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">generate_token</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;/protected&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">123</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;user&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_protected_endpoint_with_malformed_header</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that malformed Authorization header is rejected&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;/protected&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="s1">&#39;InvalidFormat token123&#39;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_protected_endpoint_with_invalid_token</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that invalid token is rejected&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;/protected&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="s1">&#39;Bearer invalid.token.here&#39;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span>
    <span class="k">assert</span> <span class="s1">&#39;Invalid token&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>
</code></pre></div>

<p>Run these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_middleware.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 4 items

test_middleware.py::test_protected_endpoint_without_token PASSED         [ 25%]
test_middleware.py::test_protected_endpoint_with_valid_token PASSED      [ 50%]
test_middleware.py::test_protected_endpoint_with_malformed_header PASSED [ 75%]
test_middleware.py::test_protected_endpoint_with_invalid_token PASSED    [100%]

============================== 4 passed in 0.08s ===============================
</code></pre></div>

<p><strong>Limitation preview</strong>: We've tested basic authentication, but we haven't tested token expiration. Let's see what happens with expired tokens:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_middleware.py (continued)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_protected_endpoint_with_expired_token</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that expired token is rejected&quot;&quot;&quot;</span>
    <span class="c1"># Generate a token that&#39;s already expired</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span>
        <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
        <span class="s1">&#39;exp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># Expired 1 hour ago</span>
        <span class="s1">&#39;iat&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">expired_token</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="s1">&#39;your-secret-key&#39;</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;HS256&#39;</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;/protected&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">expired_token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span>
    <span class="k">assert</span> <span class="s1">&#39;expired&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_middleware.py::test_protected_endpoint_with_expired_token<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 1 item

test_middleware.py::test_protected_endpoint_with_expired_token PASSED    [100%]

============================== 1 passed in 0.02s ===============================
</code></pre></div>

<h3 id="iteration-2-testing-role-based-access-control">Iteration 2: Testing Role-Based Access Control</h3>
<p>Now let's test the role-based authorization:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_middleware.py (continued)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_admin_endpoint_with_admin_token</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that admin token grants access to admin endpoint&quot;&quot;&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">generate_token</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;/admin/users&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="s1">&#39;Admin access granted&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_admin_endpoint_with_user_token</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that regular user cannot access admin endpoint&quot;&quot;&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">generate_token</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;/admin/users&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span>
    <span class="k">assert</span> <span class="s1">&#39;Insufficient permissions&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_moderator_endpoint_with_moderator_token</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that moderator token grants access to moderator endpoint&quot;&quot;&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">generate_token</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;moderator&#39;</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;/moderator/reports&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_moderator_endpoint_with_admin_token</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that admin can access moderator endpoints&quot;&quot;&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">generate_token</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;/moderator/reports&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_moderator_endpoint_with_user_token</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that regular user cannot access moderator endpoint&quot;&quot;&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">generate_token</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;/moderator/reports&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span>
</code></pre></div>

<p>Run all middleware tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_middleware.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 10 items

test_middleware.py::test_protected_endpoint_without_token PASSED         [ 10%]
test_middleware.py::test_protected_endpoint_with_valid_token PASSED      [ 20%]
test_middleware.py::test_protected_endpoint_with_malformed_header PASSED [ 30%]
test_middleware.py::test_protected_endpoint_with_invalid_token PASSED    [ 40%]
test_middleware.py::test_protected_endpoint_with_expired_token PASSED    [ 50%]
test_middleware.py::test_admin_endpoint_with_admin_token PASSED          [ 60%]
test_middleware.py::test_admin_endpoint_with_user_token PASSED           [ 70%]
test_middleware.py::test_moderator_endpoint_with_moderator_token PASSED  [ 80%]
test_middleware.py::test_moderator_endpoint_with_admin_token PASSED      [ 90%]
test_middleware.py::test_moderator_endpoint_with_user_token PASSED       [100%]

============================== 10 passed in 0.15s ===============================
</code></pre></div>

<h3 id="iteration-3-testing-requestresponse-middleware">Iteration 3: Testing Request/Response Middleware</h3>
<p>Let's test middleware that processes all requests and responses:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># app/middleware.py (add logging middleware)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">before_request</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log request details and start timer&quot;&quot;&quot;</span>
    <span class="n">g</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Request: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Add request ID for tracing</span>
    <span class="n">g</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X-Request-ID&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">after_request</span>
<span class="k">def</span><span class="w"> </span><span class="nf">after_request</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log response details and add headers&quot;&quot;&quot;</span>
    <span class="c1"># Calculate request duration</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;start_time&#39;</span><span class="p">):</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">g</span><span class="o">.</span><span class="n">start_time</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Request-Duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>

    <span class="c1"># Add request ID to response</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;request_id&#39;</span><span class="p">):</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Request-ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">request_id</span>

    <span class="c1"># Add security headers</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Content-Type-Options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nosniff&#39;</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Frame-Options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;DENY&#39;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">not_found</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom 404 handler&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Resource not found&#39;</span><span class="p">,</span>
        <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span>
    <span class="p">}),</span> <span class="mi">404</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">internal_error</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom 500 handler&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Internal error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Internal server error&#39;</span><span class="p">,</span>
        <span class="s1">&#39;request_id&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_id&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
    <span class="p">}),</span> <span class="mi">500</span>
</code></pre></div>

<p>Test the middleware behavior:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_middleware_hooks.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_app</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">app</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">create_app</span><span class="p">({</span><span class="s1">&#39;TESTING&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_request_id_header_added_to_response</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that request ID is added to response&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;/tasks&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;X-Request-ID&#39;</span><span class="p">:</span> <span class="s1">&#39;test-123&#39;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="s1">&#39;X-Request-ID&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Request-ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;test-123&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_request_duration_header_added</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that request duration is tracked&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="s1">&#39;X-Request-Duration&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Request-Duration&#39;</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">duration</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_security_headers_added</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that security headers are added&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Content-Type-Options&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nosniff&#39;</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Frame-Options&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;DENY&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_custom_404_handler</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test custom 404 error handler&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/nonexistent-endpoint&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s1">&#39;Resource not found&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/nonexistent-endpoint&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_custom_500_handler</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test custom 500 error handler&quot;&quot;&quot;</span>
    <span class="c1"># Create an endpoint that raises an exception</span>
    <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/error-test&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">error_endpoint</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Test error&#39;</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/error-test&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">500</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s1">&#39;Internal server error&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="s1">&#39;request_id&#39;</span> <span class="ow">in</span> <span class="n">data</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_middleware_execution_order</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">caplog</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that middleware executes in correct order&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
    <span class="n">caplog</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">)</span>

    <span class="c1"># Check log messages appear in correct order</span>
    <span class="n">log_messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">message</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">caplog</span><span class="o">.</span><span class="n">records</span><span class="p">]</span>
    <span class="n">request_log</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">msg</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">log_messages</span> <span class="k">if</span> <span class="s1">&#39;Request:&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">response_log</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">msg</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">log_messages</span> <span class="k">if</span> <span class="s1">&#39;Response:&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">request_log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">response_log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">log_messages</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">request_log</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">log_messages</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">response_log</span><span class="p">)</span>
</code></pre></div>

<h3 id="iteration-4-testing-authentication-fixtures">Iteration 4: Testing Authentication Fixtures</h3>
<p>Create reusable fixtures for authenticated testing:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (add authentication fixtures)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.middleware</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_token</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user_token</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a token for a regular user&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">generate_token</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">admin_token</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a token for an admin user&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">generate_token</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">moderator_token</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a token for a moderator&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">generate_token</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;moderator&#39;</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">auth_headers</span><span class="p">(</span><span class="n">user_token</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate headers with user authentication&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">user_token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">admin_headers</span><span class="p">(</span><span class="n">admin_token</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate headers with admin authentication&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">admin_token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticated_client</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">auth_headers</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a client with authentication headers pre-configured&quot;&quot;&quot;</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">AuthenticatedClient</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;headers&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;headers&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;headers&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;headers&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">AuthenticatedClient</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">auth_headers</span><span class="p">)</span>
</code></pre></div>

<p>Now tests become much cleaner:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_with_auth_fixtures.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_task_with_auth_fixture</span><span class="p">(</span><span class="n">authenticated_client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test using authenticated client fixture&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">authenticated_client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/tasks&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;New task&#39;</span>
    <span class="p">})</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_admin_endpoint_with_admin_headers</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">admin_headers</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test using admin headers fixture&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/admin/users&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">admin_headers</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_multiple_roles</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">user_token</span><span class="p">,</span> <span class="n">admin_token</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test comparing behavior across roles&quot;&quot;&quot;</span>
    <span class="c1"># User attempt</span>
    <span class="n">user_response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;/admin/users&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">user_token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">user_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span>

    <span class="c1"># Admin attempt</span>
    <span class="n">admin_response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;/admin/users&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">admin_token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">admin_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
</code></pre></div>

<h3 id="common-failure-modes-and-their-signatures_5">Common Failure Modes and Their Signatures</h3>
<h4 id="symptom-middleware-not-executing-for-certain-routes">Symptom: Middleware not executing for certain routes</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>E   AssertionError: assert &#39;X-Request-ID&#39; not in response.headers
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Middleware works for some endpoints but not others
- Static files or error handlers bypass middleware
- Blueprint-specific middleware not registered correctly</p>
<p><strong>Root cause</strong>: Middleware registered after routes or on wrong blueprint</p>
<p><strong>Solution</strong>: Register middleware on app instance before registering blueprints</p>
<h4 id="symptom-authentication-works-in-tests-but-fails-in-production">Symptom: Authentication works in tests but fails in production</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_protected_endpoint PASSED
<span class="gh">#</span> But in production: 401 Unauthorized
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Tests use hardcoded secret key
- Production uses environment variable
- Token generated with different key than validation</p>
<p><strong>Root cause</strong>: Secret key mismatch between test and production</p>
<p><strong>Solution</strong>: Use same configuration mechanism in tests as production</p>
<h4 id="symptom-middleware-modifies-request-but-handler-doesnt-see-changes">Symptom: Middleware modifies request but handler doesn't see changes</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>E   AssertionError: assert hasattr(g, &#39;user_id&#39;) is True
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Middleware sets <code>g.user_id</code>
- Handler can't access <code>g.user_id</code>
- Works in some tests but not others</p>
<p><strong>Root cause</strong>: Application context not properly managed in tests</p>
<p><strong>Solution</strong>: Ensure tests use <code>app.app_context()</code> or proper client fixtures</p>
<h3 id="the-journey-from-problem-to-solution">The Journey: From Problem to Solution</h3>
<table>
<thead>
<tr>
<th>Iteration</th>
<th>Failure Mode</th>
<th>Technique Applied</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>No authentication testing</td>
<td>None</td>
<td>Insecure endpoints</td>
</tr>
<tr>
<td>1</td>
<td>Basic auth not tested</td>
<td>Token generation fixtures</td>
<td>Basic security verified</td>
</tr>
<tr>
<td>2</td>
<td>Role-based access not tested</td>
<td>Role-specific fixtures</td>
<td>Authorization verified</td>
</tr>
<tr>
<td>3</td>
<td>Middleware hooks not tested</td>
<td>Request/response inspection</td>
<td>Cross-cutting concerns tested</td>
</tr>
<tr>
<td>4</td>
<td>Repetitive auth setup</td>
<td>Authenticated client fixtures</td>
<td>Clean, maintainable tests</td>
</tr>
</tbody>
</table>
<h3 id="final-implementation">Final Implementation</h3>
<p>Here's the complete, production-ready testing setup:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (complete version)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_app</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.middleware</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_token</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">app</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create application for testing&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">create_app</span><span class="p">({</span>
        <span class="s1">&#39;TESTING&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">:</span> <span class="s1">&#39;test-secret-key&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class="p">:</span> <span class="s1">&#39;sqlite:///:memory:&#39;</span>
    <span class="p">})</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create test client&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>

<span class="c1"># Authentication fixtures</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user_token</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">generate_token</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">admin_token</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">generate_token</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">moderator_token</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">generate_token</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;moderator&#39;</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">auth_headers</span><span class="p">(</span><span class="n">user_token</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">user_token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">admin_headers</span><span class="p">(</span><span class="n">admin_token</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">admin_token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticated_client</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">auth_headers</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Client with automatic authentication&quot;&quot;&quot;</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">AuthenticatedClient</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;headers&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="n">method</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">AuthenticatedClient</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">auth_headers</span><span class="p">)</span>
</code></pre></div>

<h3 id="decision-framework-which-approach-when">Decision Framework: Which Approach When?</h3>
<table>
<thead>
<tr>
<th>Scenario</th>
<th>Approach</th>
<th>Why</th>
</tr>
</thead>
<tbody>
<tr>
<td>Testing public endpoints</td>
<td>Plain <code>client</code> fixture</td>
<td>No authentication needed</td>
</tr>
<tr>
<td>Testing user-specific endpoints</td>
<td><code>authenticated_client</code> fixture</td>
<td>Automatic auth headers</td>
</tr>
<tr>
<td>Testing multiple roles</td>
<td>Individual token fixtures</td>
<td>Explicit role comparison</td>
</tr>
<tr>
<td>Testing auth failures</td>
<td>Manual token generation</td>
<td>Need invalid/expired tokens</td>
</tr>
<tr>
<td>Testing middleware behavior</td>
<td>Request/response inspection</td>
<td>Verify headers and timing</td>
</tr>
<tr>
<td>Testing error handlers</td>
<td>Trigger errors explicitly</td>
<td>Verify error response format</td>
</tr>
</tbody>
</table>
<h3 id="lessons-learned">Lessons Learned</h3>
<p><strong>Key insights from testing middleware and authentication</strong>:</p>
<ol>
<li>
<p><strong>Fixtures are essential</strong>: Authentication testing requires many fixtures, but they make tests clean and maintainable</p>
</li>
<li>
<p><strong>Test the negative cases</strong>: Most bugs are in error handling‚Äîtest invalid tokens, expired tokens, wrong roles</p>
</li>
<li>
<p><strong>Middleware order matters</strong>: Test that middleware executes in the correct sequence</p>
</li>
<li>
<p><strong>Context is critical</strong>: Flask's <code>g</code> object and application context must be properly managed in tests</p>
</li>
<li>
<p><strong>Security headers matter</strong>: Don't forget to test that security headers are added correctly</p>
</li>
<li>
<p><strong>Composition over duplication</strong>: Build higher-level fixtures from lower-level ones (authenticated_client from auth_headers from token)</p>
</li>
</ol>
<h3 id="when-to-apply-this-solution_5">When to Apply This Solution</h3>
<p><strong>What it optimizes for</strong>:
- Security verification
- Authorization testing
- Cross-cutting concern validation
- Middleware behavior verification</p>
<p><strong>What it sacrifices</strong>:
- Test complexity (many fixtures)
- Setup time (authentication infrastructure)
- Learning curve (understanding middleware execution)</p>
<p><strong>When to choose this approach</strong>:
- Applications with authentication requirements
- APIs with role-based access control
- Systems with complex middleware chains
- Security-critical applications</p>
<p><strong>When to avoid this approach</strong>:
- Public APIs with no authentication
- Simple applications without middleware
- Prototype or proof-of-concept code
- When security is not a concern</p>
<p><strong>Code characteristics</strong>:
- <strong>Setup complexity</strong>: High (requires authentication infrastructure)
- <strong>Maintenance burden</strong>: Medium (fixtures need updates when auth changes)
- <strong>Testability</strong>: Very High (comprehensive security testing)</p>
        </div>
        <div class="footer">
            Generated on 2025-12-03 10:37:07 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>