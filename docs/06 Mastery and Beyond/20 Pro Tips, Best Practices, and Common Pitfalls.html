<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>20 Pro Tips, Best Practices, and Common Pitfalls</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">06 Mastery and Beyond</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-20-pro-tips-best-practices-and-common-pitfalls">Chapter 20: Pro Tips, Best Practices, and Common Pitfalls</h1>
<h2 id="time-saving-tips">Time-Saving Tips</h2>
<h2 id="time-saving-tips_1">Time-Saving Tips</h2>
<p>As your test suite grows, the time it takes to run becomes a significant factor in your development feedback loop. A slow feedback loop discourages frequent testing and can lead to bugs slipping through. This section covers essential tools and techniques to keep your testing workflow fast, efficient, and enjoyable.</p>
<h3 id="2011-watching-tests-with-pytest-watch">20.1.1 Watching Tests with pytest-watch</h3>
<p>The typical Test-Driven Development (TDD) cycle involves:
1. Write a failing test.
2. Write the minimum code to make it pass.
3. Refactor.
4. Repeat.</p>
<p>This cycle involves constant switching between your editor and the terminal to re-run tests. This context switching, while small, adds up and breaks your flow.</p>
<p><strong>The Problem: The Manual Run Cycle</strong></p>
<p>Every time you save a file, you have to manually switch to your terminal and press "up arrow, enter" to run <code>pytest</code>. It's a small but constant interruption.</p>
<p><strong>The Solution: <code>pytest-watch</code></strong></p>
<p>The <code>pytest-watch</code> plugin automates this cycle. It watches your project files for changes and automatically re-runs your tests whenever you save.</p>
<p>First, install it:</p>
<div class="codehilite"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>pytest-watch
</code></pre></div>

<p>Now, instead of running <code>pytest</code>, you run <code>ptw</code> (short for pytest-watch) in your terminal.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># In your project root</span>
ptw
</code></pre></div>

<p>Let's see it in action. Imagine a simple function and its test.</p>
<p><code>utils.py</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># utils.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">is_palindrome</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if a string is a palindrome.&quot;&quot;&quot;</span>
    <span class="c1"># Let&#39;s start with a failing implementation</span>
    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>

<p><code>test_utils.py</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_utils.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_palindrome</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_is_palindrome_simple_case</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">is_palindrome</span><span class="p">(</span><span class="s2">&quot;radar&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>
</code></pre></div>

<p>Now, run <code>ptw</code> in your terminal. It will run the tests once and then wait.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span><span class="nv">ptw</span>
<span class="o">=============================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==============================</span>
...
collected<span class="w"> </span><span class="m">1</span><span class="w"> </span>item

test_utils.py<span class="w"> </span>F<span class="w">                                                          </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">===================================</span><span class="w"> </span><span class="nv">FAILURES</span><span class="w"> </span><span class="o">===================================</span>
_________________________<span class="w"> </span>test_is_palindrome_simple_case<span class="w"> </span>_________________________

<span class="w">    </span>def<span class="w"> </span>test_is_palindrome_simple_case<span class="o">()</span>:
&gt;<span class="w">       </span>assert<span class="w"> </span>is_palindrome<span class="o">(</span><span class="s2">&quot;radar&quot;</span><span class="o">)</span><span class="w"> </span>is<span class="w"> </span>True
E<span class="w">       </span>assert<span class="w"> </span>False<span class="w"> </span>is<span class="w"> </span>True
E<span class="w">        </span>+<span class="w">  </span>where<span class="w"> </span><span class="nv">False</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>is_palindrome<span class="o">(</span><span class="s1">&#39;radar&#39;</span><span class="o">)</span>

test_utils.py:5:<span class="w"> </span><span class="nv">AssertionError</span>
<span class="o">===========================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>failed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.01s<span class="w"> </span><span class="o">============================</span>
***<span class="w"> </span>Waiting<span class="w"> </span><span class="k">for</span><span class="w"> </span>file<span class="w"> </span>changes...<span class="w"> </span>***
</code></pre></div>

<p>The test fails as expected. Now, without touching the terminal, go back to your editor and fix the <code>is_palindrome</code> function.</p>
<p><code>utils.py</code> (updated):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># utils.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">is_palindrome</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if a string is a palindrome.&quot;&quot;&quot;</span>
    <span class="n">processed_s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">isalnum</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">processed_s</span> <span class="o">==</span> <span class="n">processed_s</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div>

<p>The moment you save the file, <code>pytest-watch</code> detects the change and instantly re-runs the tests in your terminal.</p>
<div class="codehilite"><pre><span></span><code>***<span class="w"> </span>File<span class="w"> </span>change<span class="w"> </span>detected:<span class="w"> </span>utils.py<span class="w"> </span>***
<span class="o">=============================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==============================</span>
...
collected<span class="w"> </span><span class="m">1</span><span class="w"> </span>item

test_utils.py<span class="w"> </span>.<span class="w">                                                          </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">==============================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.01s<span class="w"> </span><span class="o">===============================</span>
***<span class="w"> </span>Waiting<span class="w"> </span><span class="k">for</span><span class="w"> </span>file<span class="w"> </span>changes...<span class="w"> </span>***
</code></pre></div>

<p>This instant feedback loop is transformative for productivity. You can keep your editor and terminal side-by-side and get immediate validation as you code.</p>
<h3 id="2012-parallel-test-execution-with-pytest-xdist">20.1.2 Parallel Test Execution with pytest-xdist</h3>
<p>As a project grows to hundreds or thousands of tests, even an optimized test suite can take several minutes to run. This is especially true for integration or end-to-end tests that involve I/O operations.</p>
<p><strong>The Problem: Serial Execution is a Bottleneck</strong></p>
<p>By default, pytest runs your tests one by one. If you have 10 tests that each take 1 second, the total run time will be 10 seconds. But what if you have 4 CPU cores? Most of that time, three cores are sitting idle.</p>
<p><strong>The Solution: <code>pytest-xdist</code></strong></p>
<p>The <code>pytest-xdist</code> plugin allows you to run tests in parallel, distributing them across multiple CPU cores or even different machines.</p>
<p>First, install it:</p>
<div class="codehilite"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>pytest-xdist
</code></pre></div>

<p>Let's create a few slow tests to simulate a real-world scenario.</p>
<p><code>test_slow_operations.py</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_slow_operations.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_operation_alpha</span><span class="p">():</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_operation_beta</span><span class="p">():</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_operation_gamma</span><span class="p">():</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_operation_delta</span><span class="p">():</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="kc">True</span>
</code></pre></div>

<p>Let's run this normally and time it.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span><span class="nb">time</span><span class="w"> </span>pytest<span class="w"> </span>test_slow_operations.py
<span class="o">=============================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==============================</span>
...
collected<span class="w"> </span><span class="m">4</span><span class="w"> </span>items

test_slow_operations.py<span class="w"> </span>....<span class="w">                                             </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">==============================</span><span class="w"> </span><span class="m">4</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">4</span>.05s<span class="w"> </span><span class="o">===============================</span>

real<span class="w">    </span>0m4.102s
user<span class="w">    </span>0m0.045s
sys<span class="w">     </span>0m0.012s
</code></pre></div>

<p>As expected, it takes about 4 seconds. Now, let's use <code>pytest-xdist</code> to run the tests in parallel. The <code>-n</code> flag specifies the number of processes to use. A common choice is <code>auto</code> to use all available CPU cores.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span><span class="nb">time</span><span class="w"> </span>pytest<span class="w"> </span>-n<span class="w"> </span>auto<span class="w"> </span>test_slow_operations.py
<span class="o">=============================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==============================</span>
...
plugins:<span class="w"> </span>xdist-3.1.0,<span class="w"> </span>anyio-3.6.2
gw0<span class="w"> </span><span class="o">[</span><span class="m">4</span><span class="o">]</span><span class="w"> </span>/<span class="w"> </span>gw1<span class="w"> </span><span class="o">[</span><span class="m">4</span><span class="o">]</span><span class="w"> </span>/<span class="w"> </span>gw2<span class="w"> </span><span class="o">[</span><span class="m">4</span><span class="o">]</span><span class="w"> </span>/<span class="w"> </span>gw3<span class="w"> </span><span class="o">[</span><span class="m">4</span><span class="o">]</span>
....
<span class="o">==============================</span><span class="w"> </span><span class="m">4</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span>.18s<span class="w"> </span><span class="o">===============================</span>

real<span class="w">    </span>0m1.812s
user<span class="w">    </span>0m0.451s
sys<span class="w">     </span>0m0.098s
</code></pre></div>

<p>The total time dropped from over 4 seconds to just over 1 second! <code>pytest-xdist</code> distributed one test to each of the four available workers, and they all ran concurrently.</p>
<p><strong>Important Caveat</strong>: Parallel execution requires your tests to be completely independent. If one test depends on the side effects of another, <code>pytest-xdist</code> will expose this bad practice by causing flaky failures. This is a feature, not a bug‚Äîit forces you to write better, more isolated tests.</p>
<h3 id="2013-test-selection-shortcuts">20.1.3 Test Selection Shortcuts</h3>
<p>Running the entire test suite is often unnecessary during development. Pytest provides powerful options to run only the tests you care about, dramatically shortening the feedback loop.</p>
<p>We've already covered basic selection with <code>-k</code> (keyword) and <code>-m</code> (marker), but here are some workflow-enhancing flags:</p>
<p><strong><code>-x</code> or <code>--exitfirst</code>: Stop on First Failure</strong></p>
<p>When you're fixing a specific bug, you often don't care about subsequent failures. Use <code>-x</code> to make pytest stop immediately after the first test fails.</p>
<p><strong><code>--lf</code> or <code>--last-failed</code>: Run Only the Failures</strong></p>
<p>This is one of the most useful flags. After a test run, pytest saves a list of the tests that failed. Running <code>pytest --lf</code> will execute <em>only</em> those tests that failed in the previous run. This is perfect for the "fix and re-run" cycle.</p>
<p><strong><code>--ff</code> or <code>--failed-first</code>: Run Failures First, Then the Rest</strong></p>
<p>This is a variation of <code>--lf</code>. It runs the tests that failed last time first. If they all pass, it proceeds to run the rest of the test suite. This gives you fast feedback on your fixes while still ensuring you haven't broken anything else.</p>
<p><strong>Example Workflow:</strong></p>
<ol>
<li>You run the full suite: <code>pytest</code><ul>
<li>3 out of 500 tests fail.</li>
</ul>
</li>
<li>You work on a fix for the first failure.</li>
<li>You run <code>pytest --lf -x</code>.<ul>
<li>This runs <em>only</em> the 3 failed tests and stops after the first one. You see it now passes.</li>
</ul>
</li>
<li>You work on the next fix.</li>
<li>You run <code>pytest --lf</code> again.<ul>
<li>It runs the remaining 2 failures. They now pass.</li>
</ul>
</li>
<li>You're confident in your fixes. You run <code>pytest --ff</code> to run the previously failing tests first, followed by all 497 others to ensure no regressions were introduced.</li>
</ol>
<h3 id="2014-using-test-templates">20.1.4 Using Test Templates</h3>
<p>While not a pytest feature, establishing a template for your tests is a professional habit that saves mental energy and ensures consistency. Most modern IDEs have a "snippets" or "live templates" feature that is perfect for this.</p>
<p><strong>The Problem: Boilerplate Repetition</strong></p>
<p>Every time you create a new test file, you might type the same imports or define a similar test structure. This is minor but repetitive.</p>
<p><strong>The Solution: A Test Snippet</strong></p>
<p>Define a template in your IDE. For example, in VS Code, you could create a snippet that you trigger by typing <code>pytest_class</code>.</p>
<p><code>python.json</code> (VS Code Snippets):</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;Pytest Test Class&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;prefix&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pytest_class&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;body&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;import pytest&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;class Test${1:ClassName}:&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;    def test_${2:behavior_being_tested}(self):&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;        # Arrange&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;        &quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;        # Act&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;        &quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;        # Assert&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;        assert False, \&quot;Not implemented\&quot;&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Creates a pytest test class structure&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Now, in a new <code>test_new_feature.py</code> file, you can simply type <code>pytest_class</code> and hit Enter. It will expand to:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestClassName</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_behavior_being_tested</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Arrange</span>

        <span class="c1"># Act</span>

        <span class="c1"># Assert</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Not implemented&quot;</span>
</code></pre></div>

<p>Your cursor will be positioned to rename <code>ClassName</code>, and pressing Tab will move you to <code>behavior_being_tested</code>. This simple template enforces a consistent structure (like Arrange-Act-Assert) and gets you writing the actual test logic faster.</p>
<h2 id="industry-hacks-and-patterns">Industry Hacks and Patterns</h2>
<h2 id="industry-hacks-and-patterns_1">Industry Hacks and Patterns</h2>
<p>Beyond the core features of pytest, several advanced patterns and complementary tools are used in the industry to tackle complex testing challenges like legacy code, microservices, and elusive bugs.</p>
<h3 id="2021-testing-legacy-code-without-refactoring">20.2.1 Testing Legacy Code Without Refactoring</h3>
<p><strong>The Problem:</strong> You're tasked with modifying a large, complex function that has no tests. You're afraid that any change might break existing behavior in subtle ways. You can't refactor it first because you don't have a safety net of tests.</p>
<p>This is a classic chicken-and-egg problem. The solution is to create that safety net <em>before</em> you refactor, by writing <strong>Characterization Tests</strong>.</p>
<p>A characterization test doesn't judge whether the code's behavior is <em>correct</em>. It simply documents and asserts the code's <em>current</em> behavior, warts and all.</p>
<p><strong>The Anchor Example: A convoluted pricing function</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># pricing.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_price</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">user_type</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="n">discount_code</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A legacy function with complex, undocumented business rules.&quot;&quot;&quot;</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">base</span> <span class="o">*</span> <span class="n">quantity</span>
    <span class="k">if</span> <span class="n">user_type</span> <span class="o">==</span> <span class="s2">&quot;premium&quot;</span><span class="p">:</span>
        <span class="n">price</span> <span class="o">*=</span> <span class="mf">0.8</span>  <span class="c1"># 20% discount for premium users</span>

    <span class="k">if</span> <span class="n">country</span> <span class="o">==</span> <span class="s2">&quot;US&quot;</span><span class="p">:</span>
        <span class="n">price</span> <span class="o">+=</span> <span class="mi">5</span> <span class="c1"># Shipping</span>
    <span class="k">elif</span> <span class="n">country</span> <span class="o">==</span> <span class="s2">&quot;CA&quot;</span><span class="p">:</span>
        <span class="n">price</span> <span class="o">+=</span> <span class="mi">7</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">price</span> <span class="o">+=</span> <span class="mi">10</span>

    <span class="k">if</span> <span class="n">discount_code</span> <span class="o">==</span> <span class="s2">&quot;SAVE10&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">price</span> <span class="o">-=</span> <span class="mi">10</span>
    <span class="k">elif</span> <span class="n">discount_code</span> <span class="o">==</span> <span class="s2">&quot;HALF&quot;</span><span class="p">:</span>
        <span class="n">price</span> <span class="o">*=</span> <span class="mf">0.5</span>

    <span class="k">if</span> <span class="n">quantity</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="c1"># Bulk discount, but it&#39;s applied late</span>
        <span class="n">price</span> <span class="o">*=</span> <span class="mf">0.9</span>

    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div>

<p>We need to change the shipping logic, but we're afraid of breaking the discount rules.</p>
<p><strong>Step 1: Write Characterization Tests</strong></p>
<p>We'll write tests that capture the output for a variety of inputs. We are not trying to understand the logic yet, just record the results.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_pricing_characterization.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pricing</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate_price</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_price_premium_us_user_with_code</span><span class="p">():</span>
    <span class="c1"># We run the function, see the output is 82.0, and lock it in.</span>
    <span class="k">assert</span> <span class="n">calculate_price</span><span class="p">(</span>
        <span class="n">base</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> 
        <span class="n">quantity</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
        <span class="n">user_type</span><span class="o">=</span><span class="s2">&quot;premium&quot;</span><span class="p">,</span> 
        <span class="n">country</span><span class="o">=</span><span class="s2">&quot;US&quot;</span><span class="p">,</span> 
        <span class="n">discount_code</span><span class="o">=</span><span class="s2">&quot;SAVE10&quot;</span>
    <span class="p">)</span> <span class="o">==</span> <span class="mf">82.0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_price_standard_international_bulk</span><span class="p">():</span>
    <span class="c1"># We run it, see 1000.0, and lock it in.</span>
    <span class="k">assert</span> <span class="n">calculate_price</span><span class="p">(</span>
        <span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
        <span class="n">quantity</span><span class="o">=</span><span class="mi">110</span><span class="p">,</span> 
        <span class="n">user_type</span><span class="o">=</span><span class="s2">&quot;standard&quot;</span><span class="p">,</span> 
        <span class="n">country</span><span class="o">=</span><span class="s2">&quot;DE&quot;</span><span class="p">,</span> 
        <span class="n">discount_code</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span> <span class="o">==</span> <span class="mf">1000.0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_price_canadian_premium_half_off</span><span class="p">():</span>
    <span class="c1"># We run it, see 43.5, and lock it in.</span>
    <span class="k">assert</span> <span class="n">calculate_price</span><span class="p">(</span>
        <span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
        <span class="n">quantity</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
        <span class="n">user_type</span><span class="o">=</span><span class="s2">&quot;premium&quot;</span><span class="p">,</span> 
        <span class="n">country</span><span class="o">=</span><span class="s2">&quot;CA&quot;</span><span class="p">,</span> 
        <span class="n">discount_code</span><span class="o">=</span><span class="s2">&quot;HALF&quot;</span>
    <span class="p">)</span> <span class="o">==</span> <span class="mf">43.5</span>
</code></pre></div>

<p><strong>Step 2: Refactor with Confidence</strong></p>
<p>Now that we have a safety net, we can refactor the <code>calculate_price</code> function. Let's say we want to reorganize it to apply discounts before shipping.</p>
<p><code>pricing.py</code> (Refactored):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># pricing.py (refactored)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_price</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">user_type</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="n">discount_code</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Refactored to be more logical.&quot;&quot;&quot;</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">base</span> <span class="o">*</span> <span class="n">quantity</span>

    <span class="c1"># Apply user type discount</span>
    <span class="k">if</span> <span class="n">user_type</span> <span class="o">==</span> <span class="s2">&quot;premium&quot;</span><span class="p">:</span>
        <span class="n">price</span> <span class="o">*=</span> <span class="mf">0.8</span>

    <span class="c1"># Apply bulk discount</span>
    <span class="k">if</span> <span class="n">quantity</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">price</span> <span class="o">*=</span> <span class="mf">0.9</span>

    <span class="c1"># Apply discount codes</span>
    <span class="k">if</span> <span class="n">discount_code</span> <span class="o">==</span> <span class="s2">&quot;SAVE10&quot;</span> <span class="ow">and</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
        <span class="n">price</span> <span class="o">-=</span> <span class="mi">10</span>
    <span class="k">elif</span> <span class="n">discount_code</span> <span class="o">==</span> <span class="s2">&quot;HALF&quot;</span><span class="p">:</span>
        <span class="n">price</span> <span class="o">*=</span> <span class="mf">0.5</span>

    <span class="c1"># Apply shipping</span>
    <span class="k">if</span> <span class="n">country</span> <span class="o">==</span> <span class="s2">&quot;US&quot;</span><span class="p">:</span>
        <span class="n">price</span> <span class="o">+=</span> <span class="mi">5</span>
    <span class="k">elif</span> <span class="n">country</span> <span class="o">==</span> <span class="s2">&quot;CA&quot;</span><span class="p">:</span>
        <span class="n">price</span> <span class="o">+=</span> <span class="mi">7</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">price</span> <span class="o">+=</span> <span class="mi">10</span>

    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div>

<p><strong>Step 3: Run the Characterization Tests</strong></p>
<p>Now we run our test suite.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span><span class="nv">pytest</span>
<span class="o">=============================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==============================</span>
...
collected<span class="w"> </span><span class="m">3</span><span class="w"> </span>items

test_pricing_characterization.py<span class="w"> </span>F.F<span class="w">                                     </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">===================================</span><span class="w"> </span><span class="nv">FAILURES</span><span class="w"> </span><span class="o">===================================</span>
_________________<span class="w"> </span>test_calculate_price_premium_us_user_with_code<span class="w"> </span>_________________

<span class="w">    </span>def<span class="w"> </span>test_calculate_price_premium_us_user_with_code<span class="o">()</span>:
<span class="w">        </span><span class="c1"># We run the function, see the output is 82.0, and lock it in.</span>
<span class="w">        </span>assert<span class="w"> </span>calculate_price<span class="o">(</span>
<span class="w">            </span><span class="nv">base</span><span class="o">=</span><span class="m">20</span>,
<span class="w">            </span><span class="nv">quantity</span><span class="o">=</span><span class="m">5</span>,
<span class="w">            </span><span class="nv">user_type</span><span class="o">=</span><span class="s2">&quot;premium&quot;</span>,
<span class="w">            </span><span class="nv">country</span><span class="o">=</span><span class="s2">&quot;US&quot;</span>,
<span class="w">            </span><span class="nv">discount_code</span><span class="o">=</span><span class="s2">&quot;SAVE10&quot;</span>
&gt;<span class="w">       </span><span class="o">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">82</span>.0
E<span class="w">       </span>assert<span class="w"> </span><span class="m">77</span>.0<span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">82</span>.0
E<span class="w">        </span>+<span class="w">  </span>where<span class="w"> </span><span class="m">77</span>.0<span class="w"> </span><span class="o">=</span><span class="w"> </span>calculate_price<span class="o">(</span><span class="nv">base</span><span class="o">=</span><span class="m">20</span>,<span class="w"> </span><span class="nv">quantity</span><span class="o">=</span><span class="m">5</span>,<span class="w"> </span><span class="nv">user_type</span><span class="o">=</span><span class="s1">&#39;premium&#39;</span>,<span class="w"> </span><span class="nv">country</span><span class="o">=</span><span class="s1">&#39;US&#39;</span>,<span class="w"> </span><span class="nv">discount_code</span><span class="o">=</span><span class="s1">&#39;SAVE10&#39;</span><span class="o">)</span>

test_pricing_characterization.py:11:<span class="w"> </span>AssertionError
...
</code></pre></div>

<p>The tests immediately show that our "logical" refactoring has changed the behavior. The original code applied the bulk discount <em>after</em> shipping and some coupon codes, which was probably a bug. Our characterization tests caught this unintended change.</p>
<p>Now we can make an informed decision:
1.  Is the new behavior correct? If so, update the characterization tests to reflect the new, correct values. They now become proper regression tests.
2.  Was the old behavior intentional? If so, our refactoring was wrong, and we need to revert or adjust it to preserve the original logic.</p>
<p>Characterization tests are a powerful technique for safely introducing tests and enabling refactoring in untested legacy systems.</p>
<h3 id="2024-property-based-testing-with-hypothesis">20.2.4 Property-Based Testing with Hypothesis</h3>
<p>Example-based testing is what we've done so far: you pick one input (e.g., <code>5</code>) and assert a specific output (e.g., <code>25</code> for a square function). The weakness is that you might not think of the edge cases that break your code (e.g., <code>-1</code>, <code>0</code>, a floating-point number, a very large number).</p>
<p><strong>The Problem: Our Imagination is Limited</strong></p>
<p>We can't possibly write examples for every edge case. We often miss things like empty strings, zero, negative numbers, or unicode characters.</p>
<p><strong>The Solution: <code>hypothesis</code></strong></p>
<p>Property-based testing flips the script. Instead of testing for specific outcomes, you state properties about your function that should hold true for <em>all</em> valid inputs. The <code>hypothesis</code> library then generates hundreds of diverse and tricky examples, actively trying to find a counterexample that breaks your property.</p>
<p>First, install it:</p>
<div class="codehilite"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>hypothesis
</code></pre></div>

<p>Let's test a custom encoding function.</p>
<p><code>data_encoder.py</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># data_encoder.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">custom_encode</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A simple run-length encoder.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">text</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">text</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count</span><span class="si">}{</span><span class="n">text</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count</span><span class="si">}{</span><span class="n">text</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">custom_decode</span><span class="p">(</span><span class="n">encoded_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="c1"># This has a subtle bug</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoded_text</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">encoded_text</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">char</span> <span class="o">=</span> <span class="n">encoded_text</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span> <span class="n">count</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>

<p>Now, let's write a property-based test. The core property of any encoding/decoding pair is that decoding an encoded string should give you back the original string.</p>
<p><code>test_encoder_hypothesis.py</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_encoder_hypothesis.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hypothesis</span><span class="w"> </span><span class="kn">import</span> <span class="n">given</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hypothesis.strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">text</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">data_encoder</span><span class="w"> </span><span class="kn">import</span> <span class="n">custom_encode</span><span class="p">,</span> <span class="n">custom_decode</span>

<span class="c1"># A regular example-based test that passes</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_encode_decode_simple</span><span class="p">():</span>
    <span class="n">original</span> <span class="o">=</span> <span class="s2">&quot;AAABBC&quot;</span>
    <span class="n">encoded</span> <span class="o">=</span> <span class="n">custom_encode</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
    <span class="n">decoded</span> <span class="o">=</span> <span class="n">custom_decode</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">decoded</span> <span class="o">==</span> <span class="n">original</span>

<span class="c1"># A property-based test</span>
<span class="nd">@given</span><span class="p">(</span><span class="n">text</span><span class="p">())</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_encode_decode_is_reversible</span><span class="p">(</span><span class="n">original_text</span><span class="p">):</span>
    <span class="n">encoded</span> <span class="o">=</span> <span class="n">custom_encode</span><span class="p">(</span><span class="n">original_text</span><span class="p">)</span>
    <span class="n">decoded</span> <span class="o">=</span> <span class="n">custom_decode</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">decoded</span> <span class="o">==</span> <span class="n">original_text</span>
</code></pre></div>

<p>The <code>@given(text())</code> decorator tells Hypothesis: "Run this test function many times, and for each run, pass in a different string for the <code>original_text</code> argument."</p>
<p>Let's run pytest.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest
...
test_encoder_hypothesis.py<span class="w"> </span>.F<span class="w">                                            </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>
<span class="o">===================================</span><span class="w"> </span><span class="nv">FAILURES</span><span class="w"> </span><span class="o">===================================</span>
______________________<span class="w"> </span>test_encode_decode_is_reversible<span class="w"> </span>______________________

<span class="w">    </span>@given<span class="o">(</span>text<span class="o">())</span>
<span class="w">    </span>def<span class="w"> </span>test_encode_decode_is_reversible<span class="o">(</span>original_text<span class="o">)</span>:
<span class="w">        </span><span class="nv">encoded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>custom_encode<span class="o">(</span>original_text<span class="o">)</span>
<span class="w">        </span><span class="nv">decoded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>custom_decode<span class="o">(</span>encoded<span class="o">)</span>
&gt;<span class="w">       </span>assert<span class="w"> </span><span class="nv">decoded</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>original_text
E<span class="w">       </span>AssertionError:<span class="w"> </span>assert<span class="w"> </span><span class="s1">&#39;1111111111&#39;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;11111111111&#39;</span>
E<span class="w">         </span>-<span class="w"> </span><span class="m">11111111111</span>
E<span class="w">         </span>+<span class="w"> </span><span class="m">1111111111</span>

<span class="nv">original_text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;11111111111&#39;</span>

...
Falsifying<span class="w"> </span>example:<span class="w"> </span>test_encode_decode_is_reversible<span class="o">(</span><span class="nv">original_text</span><span class="o">=</span><span class="s1">&#39;11111111111&#39;</span><span class="o">)</span>
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-failure">Diagnostic Analysis: Reading the Failure</h3>
<p><strong>The complete output</strong>: The output shows that the simple test passed, but the Hypothesis test failed.</p>
<p><strong>Let's parse this section by section</strong>:</p>
<ol>
<li>
<p><strong>The summary line</strong>: <code>Falsifying example: test_encode_decode_is_reversible(original_text='11111111111')</code></p>
<ul>
<li>What this tells us: Hypothesis found a specific input that breaks our property. The input was a string of eleven '1's.</li>
</ul>
</li>
<li>
<p><strong>The assertion introspection</strong>:
    ```
    AssertionError: assert '1111111111' == '11111111111'</p>
<ul>
<li>11111111111</li>
<li>1111111111
```</li>
<li>What this tells us: The decoded string was one character shorter than the original.</li>
</ul>
</li>
</ol>
<p><strong>Root cause identified</strong>: Our <code>custom_decode</code> function assumes the count of a character is always a single digit. When <code>custom_encode</code> sees eleven '1's, it produces the string <code>"111"</code> (meaning "eleven ones"). Our decoder reads the first '1' as the count and the second '1' as the character, producing a single '1'. Then it moves on to the third '1' and gets confused.</p>
<p><strong>Why the current approach can't solve this</strong>: Our simple example (<code>"AAABBC"</code>) didn't have character runs longer than 9, so it never exposed this bug.</p>
<p><strong>What we need</strong>: A more robust decoding algorithm that can handle multi-digit counts.</p>
<p>Hypothesis excels at finding these kinds of edge cases that are tedious or difficult for humans to anticipate. It's an incredibly powerful tool for increasing confidence in your code's correctness.</p>
<h2 id="best-practices-summary">Best Practices Summary</h2>
<h2 id="best-practices-summary_1">Best Practices Summary</h2>
<p>Writing tests is easy; writing good, maintainable, and effective tests is a skill. This section summarizes key principles that distinguish professional-grade test suites from amateur ones.</p>
<h3 id="2031-keep-tests-simple-and-readable">20.3.1 Keep Tests Simple and Readable</h3>
<p>A test should be so simple that you can understand its purpose without having to read the code it's testing. Avoid complex logic, loops, or conditionals within the test function itself.</p>
<p><strong>Bad: Logic in the test</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_user_permissions</span><span class="p">():</span>
    <span class="c1"># Complex setup and logic inside the test</span>
    <span class="n">permissions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">permissions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;read_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">permissions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;write_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">permissions</span><span class="o">=</span><span class="n">permissions</span><span class="p">)</span>

    <span class="c1"># Hard to see the intent here</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">can_access</span><span class="p">(</span><span class="s2">&quot;read_4&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">can_access</span><span class="p">(</span><span class="s2">&quot;write_2&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Good: Use helper functions or fixtures</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_user_with_alternating_permissions</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="c1"># Logic is extracted to a clear helper</span>
    <span class="n">permissions</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;read_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;write_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">User</span><span class="p">(</span><span class="n">permissions</span><span class="o">=</span><span class="n">permissions</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_user_can_access_even_read_permission</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user_with_alternating_permissions</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">can_access</span><span class="p">(</span><span class="s2">&quot;read_4&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_user_cannot_access_even_write_permission</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user_with_alternating_permissions</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">can_access</span><span class="p">(</span><span class="s2">&quot;write_2&quot;</span><span class="p">)</span>
</code></pre></div>

<p>The "Good" version is far more readable. Each test has a clear purpose, and the complex setup is abstracted away.</p>
<h3 id="2032-one-assertion-per-test-usually">20.3.2 One Assertion Per Test (Usually)</h3>
<p>A test function should ideally test one single concept. When a test with multiple assertions fails, it's not immediately clear which assertion was the cause. Splitting them improves failure isolation.</p>
<p><strong>Bad: Multiple unrelated assertions</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_account_creation</span><span class="p">():</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">(</span><span class="n">initial_balance</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">account</span><span class="o">.</span><span class="n">balance</span> <span class="o">==</span> <span class="mi">100</span>

    <span class="n">account</span><span class="o">.</span><span class="n">deposit</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">account</span><span class="o">.</span><span class="n">balance</span> <span class="o">==</span> <span class="mi">150</span>

    <span class="n">account</span><span class="o">.</span><span class="n">withdraw</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">account</span><span class="o">.</span><span class="n">balance</span> <span class="o">==</span> <span class="mi">130</span>
</code></pre></div>

<p>If this test fails, the message <code>AssertionError: assert 140 == 130</code> doesn't tell you if the deposit or the withdrawal failed.</p>
<p><strong>Good: One concept per test</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_account_initial_balance</span><span class="p">():</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">(</span><span class="n">initial_balance</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">account</span><span class="o">.</span><span class="n">balance</span> <span class="o">==</span> <span class="mi">100</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_account_deposit_increases_balance</span><span class="p">():</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">(</span><span class="n">initial_balance</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">account</span><span class="o">.</span><span class="n">deposit</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">account</span><span class="o">.</span><span class="n">balance</span> <span class="o">==</span> <span class="mi">150</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_account_withdrawal_decreases_balance</span><span class="p">():</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">(</span><span class="n">initial_balance</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">account</span><span class="o">.</span><span class="n">withdraw</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">account</span><span class="o">.</span><span class="n">balance</span> <span class="o">==</span> <span class="mi">80</span>
</code></pre></div>

<p>Now, if a test fails, its name tells you exactly which piece of functionality is broken.</p>
<p><strong>The "Usually" Caveat</strong>: Sometimes multiple assertions are needed to verify a single state or object. For example, checking multiple attributes of a returned <code>User</code> object. In these cases, it's acceptable, but the assertions should all be related to one logical outcome.</p>
<h3 id="2033-name-tests-to-describe-what-they-test">20.3.3 Name Tests to Describe What They Test</h3>
<p>Test names should be descriptive sentences. They are your first line of documentation and your best guide when reading failure reports.</p>
<p><strong>Bad: Vague names</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_auth_1</span><span class="p">():</span> <span class="o">...</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_auth_2</span><span class="p">():</span> <span class="o">...</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_login</span><span class="p">():</span> <span class="o">...</span>
</code></pre></div>

<p>If <code>test_login</code> fails, what does that mean? A successful login? A failed one?</p>
<p><strong>Good: Descriptive names</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_login_succeeds_with_valid_credentials</span><span class="p">():</span> <span class="o">...</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_login_fails_with_incorrect_password</span><span class="p">():</span> <span class="o">...</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_login_fails_for_locked_out_user</span><span class="p">():</span> <span class="o">...</span>
</code></pre></div>

<p>When you see <code>FAILED test_auth.py::test_login_fails_for_locked_out_user</code>, you know exactly what the problem is without even looking at the code.</p>
<h3 id="2034-avoid-test-interdependency">20.3.4 Avoid Test Interdependency</h3>
<p>Each test must be able to run independently and in any order. Tests should never rely on the side effects of other tests. This is the cardinal rule that enables parallel execution with <code>pytest-xdist</code> and reliable runs with <code>--lf</code>.</p>
<p><strong>Bad: Tests that depend on order</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># This global state is shared between tests</span>
<span class="n">user_id</span> <span class="o">=</span> <span class="kc">None</span> 

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_user</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">user_id</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">create_user_in_db</span><span class="p">(</span><span class="s2">&quot;testuser&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_delete_user</span><span class="p">():</span>
    <span class="c1"># This test will fail if test_create_user doesn&#39;t run first</span>
    <span class="n">delete_user_from_db</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">get_user_from_db</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
</code></pre></div>

<p><strong>Good: Use fixtures for isolated setup and teardown</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">created_user</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SETUP: Creating user&quot;</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">create_user_in_db</span><span class="p">(</span><span class="s2">&quot;testuser&quot;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">user_id</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TEARDOWN: Deleting user&quot;</span><span class="p">)</span>
    <span class="n">delete_user_from_db</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_user_can_be_created</span><span class="p">(</span><span class="n">created_user</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">get_user_from_db</span><span class="p">(</span><span class="n">created_user</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_user_can_be_deleted</span><span class="p">(</span><span class="n">created_user</span><span class="p">):</span>
    <span class="n">delete_user_from_db</span><span class="p">(</span><span class="n">created_user</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">get_user_from_db</span><span class="p">(</span><span class="n">created_user</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
</code></pre></div>

<p>Here, each test gets its own freshly created user via the <code>created_user</code> fixture, and that user is reliably cleaned up afterward. The tests are completely isolated.</p>
<h3 id="2035-use-fixtures-for-setup-not-test-data">20.3.5 Use Fixtures for Setup, Not Test Data</h3>
<p>This is a subtle but important distinction. Fixtures are for establishing the <em>context</em> or <em>state</em> for a test (e.g., a database connection, a temporary file, a logged-in user object). Parametrization is for providing different <em>data inputs</em> to a test.</p>
<p><strong>Bad: Using a fixture to provide simple data</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">palindrome_example</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;radar&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_is_palindrome</span><span class="p">(</span><span class="n">palindrome_example</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">is_palindrome</span><span class="p">(</span><span class="n">palindrome_example</span><span class="p">)</span>
</code></pre></div>

<p>This is overkill and less clear than just putting the data in the test. It adds a layer of indirection for no real benefit.</p>
<p><strong>Good: Use parametrization for data variations</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;word&quot;</span><span class="p">,</span> <span class="p">[</span>
    <span class="s2">&quot;radar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;level&quot;</span><span class="p">,</span>
    <span class="s2">&quot;A man a plan a canal Panama&quot;</span>
<span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_is_palindrome</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">is_palindrome</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
</code></pre></div>

<p><strong>Good: Using a fixture for context</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">temp_db_connection</span><span class="p">():</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">create_db_connection</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">conn</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_can_write_to_db</span><span class="p">(</span><span class="n">temp_db_connection</span><span class="p">):</span>
    <span class="c1"># The fixture provides the necessary context (a live connection)</span>
    <span class="n">user_repo</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">temp_db_connection</span><span class="p">)</span>
    <span class="n">user_repo</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;testuser&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user_repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;testuser&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</code></pre></div>

<h2 id="common-pitfalls-to-avoid">Common Pitfalls to Avoid</h2>
<h2 id="common-pitfalls-to-avoid_1">Common Pitfalls to Avoid</h2>
<p>Knowing what <em>not</em> to do is as important as knowing what to do. Here are some of the most common traps that developers fall into when writing tests, and how to avoid them.</p>
<h3 id="2041-over-mocking-your-code">20.4.1 Over-Mocking Your Code</h3>
<p><strong>Symptom</strong>: Your tests are extremely brittle. A small, internal refactoring of a function (that doesn't change its public behavior) causes dozens of tests to fail.</p>
<p><strong>Root Cause</strong>: You are mocking every dependency and collaborator of your unit under test. Your tests have become tightly coupled to the <em>implementation details</em> of your code, not its behavior.</p>
<p><strong>Example of Over-Mocking:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_processor.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PaymentProcessor</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gateway</span><span class="p">,</span> <span class="n">notifier</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gateway</span> <span class="o">=</span> <span class="n">gateway</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notifier</span> <span class="o">=</span> <span class="n">notifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logger</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="c1"># ... some logic ...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log_attempt</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_notifier</span><span class="o">.</span><span class="n">send_receipt</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">success</span>

<span class="c1"># test_payment_processor.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_calls_dependencies</span><span class="p">():</span>
    <span class="n">mock_gateway</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_notifier</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_logger</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">mock_gateway</span><span class="p">,</span> <span class="n">mock_notifier</span><span class="p">,</span> <span class="n">mock_logger</span><span class="p">)</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;user1&quot;</span><span class="p">)</span>

    <span class="c1"># This is the problem: we are testing WHICH methods were called.</span>
    <span class="n">mock_logger</span><span class="o">.</span><span class="n">log_attempt</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;user1&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">mock_notifier</span><span class="o">.</span><span class="n">send_receipt</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;user1&quot;</span><span class="p">)</span>
</code></pre></div>

<p>If you later refactor <code>process_payment</code> to log <em>after</em> charging, the test will break, even though the observable behavior is identical.</p>
<p><strong>Solution</strong>: Test the behavior, not the collaboration. Mock only at the boundaries of your system (e.g., external APIs, databases). For internal collaborators, consider using real objects or fakes instead of mocks. Focus on the return value or the state change, not the sequence of internal calls.</p>
<h3 id="2042-testing-implementation-instead-of-behavior">20.4.2 Testing Implementation Instead of Behavior</h3>
<p>This is closely related to over-mocking. It's the mistake of writing tests that verify <em>how</em> a function works, rather than <em>what</em> it accomplishes.</p>
<p><strong>Symptom</strong>: You change a <code>for</code> loop to a list comprehension, and a test fails, even though the function still returns the correct result.</p>
<p><strong>Root Cause</strong>: The test is asserting against private methods, internal attributes, or the specific algorithm used.</p>
<p><strong>Example of Testing Implementation:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># item_list.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ItemList</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span>

<span class="c1"># test_item_list.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_add_appends_to_internal_list</span><span class="p">():</span>
    <span class="n">item_list</span> <span class="o">=</span> <span class="n">ItemList</span><span class="p">()</span>
    <span class="n">item_list</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">)</span>
    <span class="c1"># This is bad: it relies on the internal attribute `_items`</span>
    <span class="k">assert</span> <span class="n">item_list</span><span class="o">.</span><span class="n">_items</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;apple&quot;</span><span class="p">]</span>
</code></pre></div>

<p>If you later decide to rename <code>_items</code> to <code>_data</code> or change the internal storage to a <code>deque</code>, this test will break needlessly.</p>
<p><strong>Solution</strong>: Test only through the public interface.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_item_list.py (Good version)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_get_items_returns_added_item</span><span class="p">():</span>
    <span class="n">item_list</span> <span class="o">=</span> <span class="n">ItemList</span><span class="p">()</span>
    <span class="n">item_list</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">)</span>
    <span class="c1"># This is good: it uses the public `get_items` method</span>
    <span class="k">assert</span> <span class="n">item_list</span><span class="o">.</span><span class="n">get_items</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;apple&quot;</span><span class="p">]</span>
</code></pre></div>

<p>This test is resilient to internal refactoring. It only cares that when you <code>add</code> an item, you can <code>get</code> it back.</p>
<h3 id="2043-flaky-tests-and-timing-issues">20.4.3 Flaky Tests and Timing Issues</h3>
<p><strong>Symptom</strong>: A test passes on your machine but fails intermittently in the CI/CD pipeline. Or a test passes 9 times out of 10 when you run it repeatedly.</p>
<p><strong>Root Cause</strong>: The test has a hidden dependency on something non-deterministic, most commonly:
*   <strong>Real-world time</strong>: Using <code>time.sleep(0.1)</code> to wait for an asynchronous operation to complete.
*   <strong>Network latency</strong>: Depending on a live external service that might be slow or down.
*   <strong>Race conditions</strong>: In multi-threaded code, the test outcome depends on the exact order of thread execution.
*   <strong>Dictionary ordering</strong>: Before Python 3.7, dictionary key order was not guaranteed.</p>
<p><strong>Solution</strong>:
*   <strong>For time</strong>: Use libraries like <code>freezegun</code> to control the flow of time in your tests. Never use <code>time.sleep()</code> to "wait for something to happen."
*   <strong>For external services</strong>: Mock the service. Your unit/integration tests should not depend on the availability of external systems.
*   <strong>For race conditions</strong>: This is a complex topic, but it often involves using synchronization primitives (locks, queues) in your application code and designing tests to deterministically check the outcome.</p>
<h3 id="2044-ignoring-test-maintenance">20.4.4 Ignoring Test Maintenance</h3>
<p><strong>Symptom</strong>: The test suite is slow, brittle, and hard to understand. Developers are reluctant to add new tests because it's too painful. The team starts commenting out failing tests with <code># TODO: fix later</code>.</p>
<p><strong>Root Cause</strong>: Tests are not treated as first-class citizens. They are written quickly and then forgotten. The "broken windows" theory applies: once a few tests are ignored, the quality of the entire suite quickly degrades.</p>
<p><strong>Solution</strong>: Apply the same coding standards to your test code as you do to your production code.
*   <strong>Refactor tests</strong>: If you see duplication, extract it into a fixture or helper function.
*   <strong>Keep them fast</strong>: Regularly profile your test suite and optimize slow tests.
*   <strong>Delete obsolete tests</strong>: When you remove a feature, remove its tests.
*   <strong>Zero tolerance for commented-out tests</strong>: A commented-out test is dead code. Fix it or delete it.</p>
<h3 id="2045-coverage-theater">20.4.5 Coverage Theater</h3>
<p><strong>Symptom</strong>: Your project has 100% test coverage, but bugs are still regularly found in production. The team is focused on the coverage percentage metric above all else.</p>
<p><strong>Root Cause</strong>: Test coverage only tells you which lines of code were <em>executed</em> during a test run. It tells you nothing about the quality of the assertions or whether you've tested different logical branches and edge cases.</p>
<p><strong>Example of High Coverage, Low Value:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_user_status</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;inactive&quot;</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_admin</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;admin&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;member&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_user_status</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">is_active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_admin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">get_user_status</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="c1"># No assertion!</span>
</code></pre></div>

<p>This test will execute lines in the function, increasing coverage. But without an <code>assert</code>, it verifies nothing and is completely useless. A more subtle version is a test that only checks one path:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_get_user_status_for_admin</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">is_active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_admin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">get_user_status</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;admin&quot;</span>
</code></pre></div>

<p>This is a good test, but it doesn't cover the <code>inactive</code> or <code>member</code> paths. You can have 100% line coverage for this function by calling it with an admin user, but you haven't actually tested all the behaviors.</p>
<p><strong>Solution</strong>: Use coverage as a diagnostic tool, not a quality metric. It's excellent for answering the question, "What parts of my code are <em>not</em> tested?" It's terrible for answering, "Is my code well-tested?" Focus on testing behaviors and edge cases, not just hitting lines.</p>
<h3 id="2046-tests-that-pass-when-they-shouldnt">20.4.6 Tests That Pass When They Shouldn't</h3>
<p><strong>Symptom</strong>: You write a test for a new feature or a bug fix, and it passes immediately, even before you've written the implementation or the fix.</p>
<p><strong>Root Cause</strong>: The test is not correctly exercising the code path it's intended to test. This can be due to incorrect setup, a misunderstanding of the feature, or a typo in the test.</p>
<p><strong>Solution</strong>: Practice "Red-Green-Refactor" from Test-Driven Development (TDD).
1.  <strong>Red</strong>: Write the test <em>first</em> and watch it fail. This is the most critical step. It proves that your test is capable of detecting the absence of the feature or the presence of the bug. If it doesn't fail, your test is flawed.
2.  <strong>Green</strong>: Write the simplest possible code to make the test pass.
3.  <strong>Refactor</strong>: Clean up both the production and test code.</p>
<p>Always seeing your test fail for the right reason is the only way to be confident that it's passing for the right reason later.</p>
<h2 id="where-to-go-from-here">Where to Go From Here</h2>
<h2 id="where-to-go-from-here_1">Where to Go From Here</h2>
<p>Congratulations on completing "Pytest: From Zero to Hero"! You now have a solid foundation in modern Python testing, from the basics of writing assertions to advanced patterns for fixtures, mocking, and plugins.</p>
<p>However, the journey of a testing expert is never truly over. The world of software development is constantly evolving, and so are the tools and techniques for ensuring quality. Here are some recommended next steps to continue your learning:</p>
<ol>
<li>
<p><strong>The Official Pytest Documentation</strong>: The official docs are an invaluable resource. They are comprehensive, well-maintained, and contain details on every feature, hook, and configuration option. When you have a specific question, this should be your first stop.</p>
<ul>
<li><a href="https://pytest.org/en/latest/">pytest.org/en/latest/</a></li>
</ul>
</li>
<li>
<p><strong>Explore More Plugins</strong>: The pytest ecosystem is vast. There's a plugin for almost any need you can imagine. Spend some time browsing the plugin list to see what's available.</p>
<ul>
<li><strong><code>pytest-cov</code></strong>: For coverage reporting (which we've used).</li>
<li><strong><code>pytest-django</code> / <code>pytest-flask</code></strong>: For seamless integration with web frameworks.</li>
<li><strong><code>pytest-benchmark</code></strong>: For performance testing and benchmarking your code.</li>
<li><strong><code>pytest-asyncio</code></strong>: For testing <code>asyncio</code> based code.</li>
<li><strong><code>pytest-bdd</code></strong>: For Behavior-Driven Development (BDD) using Gherkin syntax.</li>
</ul>
</li>
<li>
<p><strong>Read "Python Testing with pytest" by Brian Okken</strong>: This book is an excellent companion to what you've learned here, offering another perspective and more in-depth examples. Brian Okken is a prominent voice in the Python testing community.</p>
</li>
<li>
<p><strong>Watch Conference Talks</strong>: PyCon, EuroPython, and various regional Python conferences have years of recorded talks on YouTube. Search for "pytest", "python testing", or talks by prominent community members like the pytest core developers. These often showcase cutting-edge techniques and real-world case studies.</p>
</li>
<li>
<p><strong>Contribute to Open Source</strong>: Find a project you use and look at their test suite. How do they structure their tests? What fixtures do they use? Try contributing a bug fix, which will almost always require writing a new test. This is one of the best ways to learn from experienced developers.</p>
</li>
<li>
<p><strong>Practice, Practice, Practice</strong>: The most important step is to apply what you've learned. Start a new personal project with a TDD approach from day one. Introduce better testing practices at your job. The more you write tests, the more intuitive these patterns will become.</p>
</li>
</ol>
<p>Testing is not a separate discipline from development; it is an integral part of it. By mastering pytest, you've equipped yourself with a tool that will make you a more confident, effective, and valuable Python developer. Happy testing!</p>
<h2 id="cheat-sheet-common-pytest-commands-and-patterns">Cheat Sheet: Common Pytest Commands and Patterns</h2>
<h2 id="cheat-sheet-common-pytest-commands-and-patterns_1">Cheat Sheet: Common Pytest Commands and Patterns</h2>
<p>A quick reference for the commands and code patterns you'll use most frequently.</p>
<h3 id="command-line-invocations">Command-Line Invocations</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">Command</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>pytest</code></td>
<td style="text-align: left;">Runs all tests in the current directory and subdirectories.</td>
</tr>
<tr>
<td style="text-align: left;"><code>pytest -v</code></td>
<td style="text-align: left;">Runs tests in verbose mode, showing one test per line with its status.</td>
</tr>
<tr>
<td style="text-align: left;"><code>pytest -q</code></td>
<td style="text-align: left;">Runs tests in quiet mode, with minimal output.</td>
</tr>
<tr>
<td style="text-align: left;"><code>pytest path/to/test_file.py</code></td>
<td style="text-align: left;">Runs all tests in a specific file.</td>
</tr>
<tr>
<td style="text-align: left;"><code>pytest path/to/test_dir/</code></td>
<td style="text-align: left;">Runs all tests in a specific directory.</td>
</tr>
<tr>
<td style="text-align: left;"><code>pytest path/to/test_file.py::test_name</code></td>
<td style="text-align: left;">Runs a single, specific test function.</td>
</tr>
<tr>
<td style="text-align: left;"><code>pytest -k "expression"</code></td>
<td style="text-align: left;">Runs tests whose names match the given keyword expression.</td>
</tr>
<tr>
<td style="text-align: left;"><code>pytest -m "marker"</code></td>
<td style="text-align: left;">Runs all tests decorated with the given marker.</td>
</tr>
<tr>
<td style="text-align: left;"><code>pytest -x</code></td>
<td style="text-align: left;">Stops the test session immediately on the first failing test.</td>
</tr>
<tr>
<td style="text-align: left;"><code>pytest --lf</code></td>
<td style="text-align: left;"><code>--last-failed</code>: Runs only the tests that failed in the last run.</td>
</tr>
<tr>
<td style="text-align: left;"><code>pytest --ff</code></td>
<td style="text-align: left;"><code>--failed-first</code>: Runs last failed tests first, then the rest.</td>
</tr>
<tr>
<td style="text-align: left;"><code>pytest --cov=my_project</code></td>
<td style="text-align: left;">Runs tests and reports code coverage for <code>my_project</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><code>pytest -n auto</code></td>
<td style="text-align: left;">(Requires <code>pytest-xdist</code>) Runs tests in parallel on all available CPU cores.</td>
</tr>
<tr>
<td style="text-align: left;"><code>pytest --fixtures</code></td>
<td style="text-align: left;">Displays a list of all available fixtures.</td>
</tr>
<tr>
<td style="text-align: left;"><code>pytest --collect-only</code></td>
<td style="text-align: left;">Displays all the tests that would be run, without actually running them.</td>
</tr>
</tbody>
</table>
<h3 id="core-code-patterns">Core Code Patterns</h3>
<h4 id="basic-test-function">Basic Test Function</h4>
<p>A function prefixed with <code>test_</code> in a file prefixed with <code>test_</code> or suffixed with <code>_test</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_addition</span><span class="p">():</span>
    <span class="k">assert</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">2</span>
</code></pre></div>

<h4 id="fixture-definition-and-usage">Fixture Definition and Usage</h4>
<p>Use fixtures to provide context, setup, and teardown for your tests.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sample_list</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A fixture that provides a list for tests.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SETUP: Creating list&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="k">yield</span> <span class="n">data</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TEARDOWN: Clearing list&quot;</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_list_has_initial_length</span><span class="p">(</span><span class="n">sample_list</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
</code></pre></div>

<h4 id="parametrization">Parametrization</h4>
<p>Run the same test logic with multiple different inputs.</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;test_input, expected&quot;</span><span class="p">,</span> <span class="p">[</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
    <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_square</span><span class="p">(</span><span class="n">test_input</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">test_input</span> <span class="o">*</span> <span class="n">test_input</span> <span class="o">==</span> <span class="n">expected</span>
</code></pre></div>

<h4 id="testing-for-expected-exceptions">Testing for Expected Exceptions</h4>
<p>Verify that a piece of code raises an exception under specific conditions.</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_division_by_zero</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ZeroDivisionError</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span>
</code></pre></div>

<h4 id="marking-a-test">Marking a Test</h4>
<p>Apply metadata to tests for selective runs.</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">slow</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_very_long_computation</span><span class="p">():</span>
    <span class="c1"># ...</span>
    <span class="k">pass</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Feature not implemented yet&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_new_feature</span><span class="p">():</span>
    <span class="c1"># ...</span>
    <span class="k">pass</span>
</code></pre></div>

<h4 id="using-tmp_path-fixture">Using <code>tmp_path</code> Fixture</h4>
<p>A built-in fixture for creating temporary files and directories.</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_write_to_file</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
    <span class="c1"># tmp_path is a pathlib.Path object</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;sub&quot;</span>
    <span class="n">d</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">d</span> <span class="o">/</span> <span class="s2">&quot;hello.txt&quot;</span>
    <span class="n">p</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">p</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;content&quot;</span>
</code></pre></div>

<h4 id="mocking-with-monkeypatch">Mocking with <code>monkeypatch</code></h4>
<p>A built-in fixture for safely modifying classes, methods, or functions during tests.</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_get_home_directory</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="c1"># Mock os.path.expanduser to return a fake path</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="s2">&quot;os.path.expanduser&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">path</span><span class="p">:</span> <span class="s2">&quot;/abc&quot;</span><span class="p">)</span>

    <span class="c1"># Code that calls os.path.expanduser(&quot;~&quot;) will now get &quot;/abc&quot;</span>
    <span class="k">assert</span> <span class="n">get_home</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;/abc&quot;</span>
</code></pre></div>
        </div>
        <div class="footer">
            Generated on 2025-11-24 14:31:16 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>