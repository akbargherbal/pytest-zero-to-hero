<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>20 Pro Tips, Best Practices, and Common Pitfalls</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">06 Mastery and Beyond</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-20-pro-tips-best-practices-and-common-pitfalls">Chapter 20: Pro Tips, Best Practices, and Common Pitfalls</h1>
<h2 id="time-saving-tips">Time-Saving Tips</h2>
<p>You've mastered pytest's core features. Now let's explore productivity multipliers that professional developers use daily. These aren't just conveniences‚Äîthey're force multipliers that transform how you work with tests.</p>
<p>We'll build our examples around a realistic scenario: a web API client library with multiple endpoints, authentication, error handling, and data validation. This gives us enough complexity to demonstrate where these tools shine.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/api_client.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="k">class</span><span class="w"> </span><span class="nc">APIClient</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch user by ID.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/users/</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">list_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List users with pagination.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/users&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span> <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="n">limit</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new user.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/users&quot;</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update user fields.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/users/</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">delete_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete a user.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/users/</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">search_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Search users by query string.&quot;&quot;&quot;</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># Simulate slow search</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/users/search&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</code></pre></div>

<p>Our initial test suite covers the basic functionality:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_api_client.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.api_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIClient</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_session</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;src.api_client.requests.Session&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">session</span>
        <span class="k">yield</span> <span class="n">session</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">(</span><span class="n">mock_session</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">APIClient</span><span class="p">(</span><span class="s2">&quot;https://api.example.com&quot;</span><span class="p">,</span> <span class="s2">&quot;test-key&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_user_returns_user_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alice@example.com&quot;</span>
    <span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;alice&quot;</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/users/1&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_list_users_with_pagination</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;bob&quot;</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">list_users</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="s2">&quot;https://api.example.com/users&quot;</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_user_sends_correct_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;charlie&quot;</span><span class="p">,</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;charlie@example.com&quot;</span>
    <span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="s2">&quot;charlie&quot;</span><span class="p">,</span> <span class="s2">&quot;charlie@example.com&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="s2">&quot;https://api.example.com/users&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;charlie&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;charlie@example.com&quot;</span><span class="p">}</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_update_user_patches_fields</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice_updated&quot;</span>
    <span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice_updated&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;alice_updated&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_delete_user_calls_correct_endpoint</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
    <span class="n">client</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">mock_session</span><span class="o">.</span><span class="n">delete</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/users/1&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_search_users_returns_matching_results</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search_users</span><span class="p">(</span><span class="s2">&quot;ali&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;alice&quot;</span>
</code></pre></div>

<p>This test suite works, but running it repeatedly during development is tedious. Let's see how professional developers optimize their workflow.</p>
<h2 id="the-manual-testing-loop-problem">The Manual Testing Loop Problem</h2>
<p>During active development, you make a change, switch to terminal, run pytest, read results, switch back to editor, make another change... This context switching kills flow state.</p>
<p>Let's see what happens when we're actively developing a new feature‚Äîadding rate limiting to our API client:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/api_client.py (adding rate limiting)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="k">class</span><span class="w"> </span><span class="nc">APIClient</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rate_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit</span> <span class="o">=</span> <span class="n">rate_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enforce rate limiting.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="c1"># Remove requests older than 1 minute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span> 
            <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_times</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit</span><span class="p">:</span>
            <span class="n">oldest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">wait_time</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">-</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">oldest</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rate limit exceeded. Wait </span><span class="si">{</span><span class="n">wait_time</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_rate_limit</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/users/</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</code></pre></div>

<p>We write a test for the new rate limiting feature:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_api_client.py (adding rate limit test)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_rate_limit_enforced</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that rate limiting prevents excessive requests.&quot;&quot;&quot;</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

    <span class="c1"># Make requests up to the limit</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="c1"># The 11th request should fail</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Rate limit exceeded&quot;</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
</code></pre></div>

<p>Run the test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_api_client.py::test_rate_limit_enforced<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>tests/test_api_client.py::test_rate_limit_enforced PASSED
</code></pre></div>

<p>Good! But now we realize the error message should be more specific. We update the code:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/api_client.py (improved error message)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_check_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span> 
        <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_times</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit</span><span class="p">:</span>
        <span class="n">oldest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">wait_time</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">-</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">oldest</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">raise</span> <span class="n">RateLimitError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Rate limit of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rate_limit</span><span class="si">}</span><span class="s2"> requests/minute exceeded. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Retry after </span><span class="si">{</span><span class="n">wait_time</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> seconds&quot;</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
</code></pre></div>

<p>Now we need to:
1. Switch to terminal
2. Press up arrow to get previous command
3. Press enter
4. Wait for results
5. Switch back to editor</p>
<p>Repeat this 20 times while refining the feature. The friction adds up.</p>
<h3 id="iteration-1-automatic-test-watching">Iteration 1: Automatic Test Watching</h3>
<p>Install pytest-watch:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pytest-watch
</code></pre></div>

<p>Now start the watcher:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>ptw<span class="w"> </span>tests/test_api_client.py::test_rate_limit_enforced<span class="w"> </span>--<span class="w"> </span>-v
</code></pre></div>

<p><strong>What happens</strong>:</p>
<p>pytest-watch monitors your files. Every time you save a change to either the test file or the source code, it automatically reruns the tests. No manual intervention needed.</p>
<p><strong>Initial output</strong>:</p>
<div class="codehilite"><pre><span></span><code>[PYTEST-WATCH] Running: pytest tests/test_api_client.py::test_rate_limit_enforced -v

tests/test_api_client.py::test_rate_limit_enforced PASSED

[PYTEST-WATCH] Watching for changes...
</code></pre></div>

<p>You make a change to the error message. Save the file. Instantly:</p>
<div class="codehilite"><pre><span></span><code>[PYTEST-WATCH] Change detected: src/api_client.py
[PYTEST-WATCH] Running: pytest tests/test_api_client.py::test_rate_limit_enforced -v

tests/test_api_client.py::test_rate_limit_enforced FAILED

E       AssertionError: Pattern &#39;Rate limit exceeded&#39; not found in &#39;Rate limit of 10 requests/minute exceeded. Retry after 59.8 seconds&#39;

[PYTEST-WATCH] Watching for changes...
</code></pre></div>

<p>The test failed because we changed the error message but didn't update the test. Update the test:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_rate_limit_enforced</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">RateLimitError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Rate limit of 10 requests/minute exceeded&quot;</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
</code></pre></div>

<p>Save. Instantly:</p>
<div class="codehilite"><pre><span></span><code>[PYTEST-WATCH] Change detected: tests/test_api_client.py
[PYTEST-WATCH] Running: pytest tests/test_api_client.py::test_rate_limit_enforced -v

tests/test_api_client.py::test_rate_limit_enforced PASSED

[PYTEST-WATCH] Watching for changes...
</code></pre></div>

<p><strong>The workflow transformation</strong>:</p>
<ul>
<li><strong>Before</strong>: Edit ‚Üí Switch ‚Üí Command ‚Üí Wait ‚Üí Read ‚Üí Switch ‚Üí Edit (6 steps)</li>
<li><strong>After</strong>: Edit ‚Üí Read (2 steps)</li>
</ul>
<p>You stay in your editor. The feedback appears in a terminal window you glance at. Your flow state remains intact.</p>
<h3 id="advanced-pytest-watch-patterns">Advanced pytest-watch Patterns</h3>
<p><strong>Watch specific test patterns</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Watch all tests matching a pattern</span>
$<span class="w"> </span>ptw<span class="w"> </span>tests/<span class="w"> </span>-k<span class="w"> </span>rate_limit<span class="w"> </span>--<span class="w"> </span>-v

<span class="c1"># Watch and run only failed tests on next run</span>
$<span class="w"> </span>ptw<span class="w"> </span>tests/<span class="w"> </span>--<span class="w"> </span>-v<span class="w"> </span>--lf

<span class="c1"># Watch with coverage</span>
$<span class="w"> </span>ptw<span class="w"> </span>tests/<span class="w"> </span>--<span class="w"> </span>--cov<span class="o">=</span>src<span class="w"> </span>--cov-report<span class="o">=</span>term-missing
</code></pre></div>

<p><strong>Clear screen between runs</strong> (reduces visual clutter):</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>ptw<span class="w"> </span>tests/<span class="w"> </span>--clear<span class="w"> </span>--<span class="w"> </span>-v
</code></pre></div>

<p><strong>Run on-pass and on-fail commands</strong> (e.g., notifications):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># macOS notification on failure</span>
$<span class="w"> </span>ptw<span class="w"> </span>tests/<span class="w"> </span>--onpass<span class="w"> </span><span class="s2">&quot;echo &#39;‚úì Tests passed&#39;&quot;</span><span class="w"> </span>--onfail<span class="w"> </span><span class="s2">&quot;osascript -e &#39;display notification \&quot;Tests failed\&quot; with title \&quot;pytest\&quot;&#39;&quot;</span>
</code></pre></div>

<p><strong>Ignore specific paths</strong> (e.g., don't rerun on documentation changes):</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>ptw<span class="w"> </span>tests/<span class="w"> </span>--ignore<span class="w"> </span>./docs<span class="w"> </span>--ignore<span class="w"> </span>./build
</code></pre></div>

<h3 id="when-to-use-pytest-watch">When to Use pytest-watch</h3>
<p><strong>Optimal scenarios</strong>:
- Active feature development with tight feedback loops
- Refactoring existing code with comprehensive tests
- TDD workflows where you write test first, then implementation
- Debugging failing tests where you're making incremental fixes</p>
<p><strong>When to avoid</strong>:
- Slow test suites (&gt;10 seconds) where constant reruns are disruptive
- Tests with external dependencies that can't be mocked (database migrations, API calls)
- When you need to think deeply between changes without immediate feedback</p>
<p><strong>Pro tip</strong>: Use pytest-watch for the specific test you're working on, not the entire suite. This keeps feedback instant:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Good: Fast, focused feedback</span>
$<span class="w"> </span>ptw<span class="w"> </span>tests/test_api_client.py::test_rate_limit_enforced<span class="w"> </span>--<span class="w"> </span>-v

<span class="c1"># Less good: Slow, unfocused feedback</span>
$<span class="w"> </span>ptw<span class="w"> </span>tests/<span class="w"> </span>--<span class="w"> </span>-v
</code></pre></div>

<h2 id="parallel-test-execution-with-pytest-xdist">Parallel Test Execution with pytest-xdist</h2>
<h2 id="the-sequential-execution-bottleneck">The Sequential Execution Bottleneck</h2>
<p>Our API client test suite has grown. We now have 50+ tests covering all endpoints, error cases, and edge conditions. Running them sequentially takes time:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_api_client.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>tests/test_api_client.py::test_get_user_returns_user_data PASSED
tests/test_api_client.py::test_get_user_handles_404 PASSED
tests/test_api_client.py::test_get_user_handles_network_error PASSED
tests/test_api_client.py::test_list_users_with_pagination PASSED
tests/test_api_client.py::test_list_users_empty_result PASSED
tests/test_api_client.py::test_create_user_sends_correct_data PASSED
tests/test_api_client.py::test_create_user_validates_email PASSED
tests/test_api_client.py::test_create_user_handles_duplicate PASSED
... (42 more tests)

======================== 50 passed in 12.34s ========================
</code></pre></div>

<p>12 seconds isn't terrible, but it's long enough to break concentration. And this is just one module. A real project might have hundreds of test files.</p>
<p>Let's add some realistic complexity‚Äîtests that involve actual timing:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_api_client.py (adding slow tests)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_search_users_performance</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify search completes within acceptable time.&quot;&quot;&quot;</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;user</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search_users</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">100</span>
    <span class="k">assert</span> <span class="n">duration</span> <span class="o">&lt;</span> <span class="mf">1.0</span>  <span class="c1"># Should complete in under 1 second</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_rate_limit_reset_after_window</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify rate limit resets after time window.&quot;&quot;&quot;</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

    <span class="c1"># Fill the rate limit</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="c1"># Should fail immediately</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">RateLimitError</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>

    <span class="c1"># Wait for window to pass</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.1</span><span class="p">)</span>

    <span class="c1"># Should succeed now</span>
    <span class="n">client</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>  <span class="c1"># Should not raise</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_retry_logic_with_backoff</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test exponential backoff on retries.&quot;&quot;&quot;</span>
    <span class="c1"># Simulate 3 failures then success</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(),</span>
        <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(),</span>
        <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(),</span>
        <span class="n">Mock</span><span class="p">(</span><span class="n">json</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
    <span class="p">]</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_user_with_retry</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">duration</span> <span class="o">&gt;</span> <span class="mf">0.5</span>  <span class="c1"># Should have waited during backoff</span>
</code></pre></div>

<p>Now our test suite takes significantly longer:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_api_client.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== 53 passed in 18.67s ========================
</code></pre></div>

<p>18 seconds is too long for rapid iteration. The problem: tests run one at a time, even though most are independent and could run simultaneously.</p>
<h3 id="iteration-1-parallel-execution-with-pytest-xdist">Iteration 1: Parallel Execution with pytest-xdist</h3>
<p>Install pytest-xdist:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pytest-xdist
</code></pre></div>

<p>Run tests in parallel using multiple CPU cores:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_api_client.py<span class="w"> </span>-n<span class="w"> </span>auto
</code></pre></div>

<p>The <code>-n auto</code> flag tells pytest-xdist to automatically detect the number of CPU cores and create that many worker processes.</p>
<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== 53 passed in 6.23s ========================
</code></pre></div>

<p><strong>Result</strong>: 18.67s ‚Üí 6.23s (3x speedup on a 4-core machine)</p>
<h3 id="diagnostic-analysis-how-parallel-execution-works">Diagnostic Analysis: How Parallel Execution Works</h3>
<p>Let's understand what just happened. Run with verbose output to see the distribution:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_api_client.py<span class="w"> </span>-n<span class="w"> </span><span class="m">4</span><span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>[gw0] PASSED tests/test_api_client.py::test_get_user_returns_user_data
[gw1] PASSED tests/test_api_client.py::test_list_users_with_pagination
[gw2] PASSED tests/test_api_client.py::test_create_user_sends_correct_data
[gw3] PASSED tests/test_api_client.py::test_update_user_patches_fields
[gw0] PASSED tests/test_api_client.py::test_delete_user_calls_correct_endpoint
[gw1] PASSED tests/test_api_client.py::test_search_users_returns_matching_results
...
</code></pre></div>

<p><strong>What this tells us</strong>:</p>
<ol>
<li><strong><code>[gw0]</code>, <code>[gw1]</code>, etc.</strong>: Gateway workers‚Äîseparate processes running tests</li>
<li><strong>Distribution</strong>: pytest-xdist distributes tests across workers using a scheduling algorithm</li>
<li><strong>Independence</strong>: Each worker has its own Python interpreter, so tests can't interfere with each other</li>
</ol>
<p><strong>The scheduling algorithm</strong>:
- Tests are distributed to workers as they become available
- Slow tests don't block fast tests
- Load balancing happens automatically</p>
<h3 id="iteration-2-handling-test-dependencies">Iteration 2: Handling Test Dependencies</h3>
<p>Not all tests can run in parallel. Some have implicit dependencies. Let's see what breaks:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_api_client_stateful.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.api_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIClient</span>

<span class="c1"># Shared state (BAD PRACTICE - for demonstration)</span>
<span class="n">_test_user_id</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_user_for_subsequent_tests</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a user that other tests will use.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_test_user_id</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">999</span><span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="s2">&quot;testuser&quot;</span><span class="p">,</span> <span class="s2">&quot;test@example.com&quot;</span><span class="p">)</span>
    <span class="n">_test_user_id</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>

    <span class="k">assert</span> <span class="n">_test_user_id</span> <span class="o">==</span> <span class="mi">999</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_update_created_user</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the user created in previous test.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_test_user_id</span>
    <span class="k">assert</span> <span class="n">_test_user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;User must be created first&quot;</span>

    <span class="n">mock_session</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">_test_user_id</span><span class="p">,</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;updated&quot;</span>
    <span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">_test_user_id</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;updated&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;updated&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_delete_created_user</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete the user created in first test.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_test_user_id</span>
    <span class="k">assert</span> <span class="n">_test_user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;User must be created first&quot;</span>

    <span class="n">client</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">_test_user_id</span><span class="p">)</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">delete</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
</code></pre></div>

<p>Run sequentially‚Äîworks fine:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_api_client_stateful.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>tests/test_api_client_stateful.py::test_create_user_for_subsequent_tests PASSED
tests/test_api_client_stateful.py::test_update_created_user PASSED
tests/test_api_client_stateful.py::test_delete_created_user PASSED

======================== 3 passed in 0.12s ========================
</code></pre></div>

<p>Run in parallel‚Äîbreaks:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_api_client_stateful.py<span class="w"> </span>-n<span class="w"> </span><span class="m">2</span><span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>[gw0] PASSED tests/test_api_client_stateful.py::test_create_user_for_subsequent_tests
[gw1] FAILED tests/test_api_client_stateful.py::test_update_created_user

E       AssertionError: User must be created first
E       assert None is not None

[gw0] FAILED tests/test_api_client_stateful.py::test_delete_created_user

E       AssertionError: User must be created first
E       assert None is not None

======================== 1 passed, 2 failed in 0.15s ========================
</code></pre></div>

<p><strong>Root cause</strong>: Each worker process has its own memory space. The global variable <code>_test_user_id</code> set in <code>gw0</code> doesn't exist in <code>gw1</code>.</p>
<p><strong>Solution 1: Make tests independent</strong> (preferred):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_api_client_stateful.py (fixed)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_update_user_independent</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update a user (self-contained test).&quot;&quot;&quot;</span>
    <span class="c1"># Create the user within this test</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="mi">999</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;updated&quot;</span>
    <span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;updated&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;updated&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_delete_user_independent</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete a user (self-contained test).&quot;&quot;&quot;</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="mi">999</span>
    <span class="n">client</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">delete</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="s2">&quot;https://api.example.com/users/999&quot;</span>
    <span class="p">)</span>
</code></pre></div>

<p><strong>Solution 2: Use fixtures for shared setup</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_api_client_stateful.py (using fixtures)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">created_user_id</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture that creates a user and returns its ID.&quot;&quot;&quot;</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">999</span><span class="p">}</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="s2">&quot;testuser&quot;</span><span class="p">,</span> <span class="s2">&quot;test@example.com&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_update_user_with_fixture</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">,</span> <span class="n">created_user_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update a user using fixture.&quot;&quot;&quot;</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">created_user_id</span><span class="p">,</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;updated&quot;</span>
    <span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">created_user_id</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;updated&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;updated&quot;</span>
</code></pre></div>

<p>Now parallel execution works because each test gets its own fixture instance.</p>
<h3 id="iteration-3-controlling-parallelization">Iteration 3: Controlling Parallelization</h3>
<p>Some tests genuinely can't run in parallel‚Äîthey modify shared resources like databases or files. Mark them:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_api_client_integration.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">serial</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_database_migration</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This test modifies the database schema.&quot;&quot;&quot;</span>
    <span class="c1"># Must run alone</span>
    <span class="k">pass</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">serial</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_cache_clear</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This test clears global cache.&quot;&quot;&quot;</span>
    <span class="c1"># Must run alone</span>
    <span class="k">pass</span>
</code></pre></div>

<p>Configure pytest to respect the marker:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># pytest.ini</span>
<span class="k">[pytest]</span>
<span class="na">markers</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="na">serial</span><span class="o">:</span><span class="w"> </span><span class="s">marks tests that must run serially (not in parallel)</span>
</code></pre></div>

<p>Run with a custom hook to enforce serial execution:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">pytest_collection_modifyitems</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Move serial tests to the end and mark them.&quot;&quot;&quot;</span>
    <span class="n">serial_tests</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">parallel_tests</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">get_closest_marker</span><span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">):</span>
            <span class="n">serial_tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parallel_tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="n">items</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">parallel_tests</span> <span class="o">+</span> <span class="n">serial_tests</span>
</code></pre></div>

<p>Or use pytest-xdist's built-in support:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run parallel tests in parallel, serial tests sequentially</span>
$<span class="w"> </span>pytest<span class="w"> </span>-n<span class="w"> </span>auto<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;not serial&quot;</span><span class="w">  </span><span class="c1"># Run parallel tests first</span>
$<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span>serial<span class="w">                 </span><span class="c1"># Then run serial tests</span>
</code></pre></div>

<h3 id="advanced-pytest-xdist-patterns">Advanced pytest-xdist Patterns</h3>
<p><strong>Load balancing strategies</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Default: distribute tests as workers become available</span>
$<span class="w"> </span>pytest<span class="w"> </span>-n<span class="w"> </span>auto

<span class="c1"># Load group: keep tests from same file together (better for fixtures)</span>
$<span class="w"> </span>pytest<span class="w"> </span>-n<span class="w"> </span>auto<span class="w"> </span>--dist<span class="w"> </span>loadgroup

<span class="c1"># Load file: distribute entire files to workers</span>
$<span class="w"> </span>pytest<span class="w"> </span>-n<span class="w"> </span>auto<span class="w"> </span>--dist<span class="w"> </span>loadfile

<span class="c1"># Load scope: distribute by fixture scope</span>
$<span class="w"> </span>pytest<span class="w"> </span>-n<span class="w"> </span>auto<span class="w"> </span>--dist<span class="w"> </span>loadscope
</code></pre></div>

<p><strong>Specify exact number of workers</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Use 4 workers regardless of CPU count</span>
$<span class="w"> </span>pytest<span class="w"> </span>-n<span class="w"> </span><span class="m">4</span>

<span class="c1"># Use half the available CPUs</span>
$<span class="w"> </span>pytest<span class="w"> </span>-n<span class="w"> </span>auto<span class="w"> </span>--maxprocesses<span class="o">=</span><span class="m">2</span>
</code></pre></div>

<p><strong>Remote execution</strong> (run tests on multiple machines):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run tests on remote SSH hosts</span>
$<span class="w"> </span>pytest<span class="w"> </span>-d<span class="w"> </span>--tx<span class="w"> </span><span class="nv">ssh</span><span class="o">=</span>user@host1<span class="w"> </span>--tx<span class="w"> </span><span class="nv">ssh</span><span class="o">=</span>user@host2
</code></pre></div>

<h3 id="performance-comparison-real-numbers">Performance Comparison: Real Numbers</h3>
<p>Let's measure the actual impact on our full test suite:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Sequential execution</span>
$<span class="w"> </span><span class="nb">time</span><span class="w"> </span>pytest<span class="w"> </span>tests/<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== 247 passed in 45.23s ========================
real    0m45.234s
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># Parallel execution (4 cores)</span>
$<span class="w"> </span><span class="nb">time</span><span class="w"> </span>pytest<span class="w"> </span>tests/<span class="w"> </span>-n<span class="w"> </span><span class="m">4</span><span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== 247 passed in 13.67s ========================
real    0m13.671s
</code></pre></div>

<p><strong>Speedup</strong>: 45.23s ‚Üí 13.67s (3.3x faster)</p>
<p><strong>Why not 4x?</strong>: Overhead from process creation, test collection, and result aggregation. The speedup approaches the number of cores as test execution time dominates overhead.</p>
<h3 id="when-to-use-pytest-xdist">When to Use pytest-xdist</h3>
<p><strong>Optimal scenarios</strong>:
- Large test suites (&gt;100 tests) where total runtime exceeds 10 seconds
- CI/CD pipelines where test time directly impacts deployment speed
- Tests that are truly independent (no shared state)
- CPU-bound tests (computation, data processing)</p>
<p><strong>When to avoid</strong>:
- Small test suites (&lt;50 tests) where overhead exceeds benefit
- Tests with shared state that can't be easily isolated
- I/O-bound tests (network, disk) where parallelization doesn't help
- Debugging scenarios where you need predictable execution order</p>
<p><strong>Cost-benefit analysis</strong>:</p>
<table>
<thead>
<tr>
<th>Test Count</th>
<th>Sequential</th>
<th>Parallel (4 cores)</th>
<th>Overhead</th>
<th>Net Benefit</th>
</tr>
</thead>
<tbody>
<tr>
<td>10 tests</td>
<td>2s</td>
<td>1.5s</td>
<td>0.5s</td>
<td>Minimal</td>
</tr>
<tr>
<td>50 tests</td>
<td>10s</td>
<td>3.5s</td>
<td>0.5s</td>
<td>6s saved</td>
</tr>
<tr>
<td>200 tests</td>
<td>45s</td>
<td>13s</td>
<td>1s</td>
<td>31s saved</td>
</tr>
<tr>
<td>1000 tests</td>
<td>240s</td>
<td>65s</td>
<td>5s</td>
<td>170s saved</td>
</tr>
</tbody>
</table>
<p><strong>Pro tip</strong>: Use pytest-xdist in CI, but not necessarily during local development. The predictable execution order of sequential tests makes debugging easier.</p>
<h2 id="test-selection-shortcuts">Test Selection Shortcuts</h2>
<h2 id="the-full-suite-problem">The Full Suite Problem</h2>
<p>You're debugging a specific feature‚Äîthe rate limiting logic. Running the entire test suite to verify your fix is wasteful:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== 247 passed in 45.23s ========================
</code></pre></div>

<p>You only care about 3 tests related to rate limiting, but you just waited 45 seconds to see their results.</p>
<h3 id="iteration-1-running-specific-tests">Iteration 1: Running Specific Tests</h3>
<p><strong>Run a single test file</strong>:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_api_client.py
</code></pre></div>

<p><strong>Run a specific test function</strong>:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_api_client.py::test_rate_limit_enforced
</code></pre></div>

<p><strong>Run a specific test class</strong>:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_api_client.py::TestRateLimiting
</code></pre></div>

<p><strong>Run a specific test method in a class</strong>:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_api_client.py::TestRateLimiting::test_rate_limit_enforced
</code></pre></div>

<p>This works, but requires typing long paths. Let's see better approaches.</p>
<h3 id="iteration-2-keyword-based-selection">Iteration 2: Keyword-Based Selection</h3>
<p>Use <code>-k</code> to match test names by pattern:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run all tests with &quot;rate_limit&quot; in the name</span>
$<span class="w"> </span>pytest<span class="w"> </span>-k<span class="w"> </span>rate_limit
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>collected 247 items / 244 deselected / 3 selected

tests/test_api_client.py::test_rate_limit_enforced PASSED
tests/test_api_client.py::test_rate_limit_reset_after_window PASSED
tests/test_api_client.py::test_rate_limit_custom_window PASSED

======================== 3 passed, 244 deselected in 0.87s ========================
</code></pre></div>

<p><strong>Powerful pattern matching</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run tests matching multiple keywords (OR logic)</span>
$<span class="w"> </span>pytest<span class="w"> </span>-k<span class="w"> </span><span class="s2">&quot;rate_limit or retry&quot;</span>

<span class="c1"># Run tests matching all keywords (AND logic)</span>
$<span class="w"> </span>pytest<span class="w"> </span>-k<span class="w"> </span><span class="s2">&quot;rate_limit and reset&quot;</span>

<span class="c1"># Exclude tests (NOT logic)</span>
$<span class="w"> </span>pytest<span class="w"> </span>-k<span class="w"> </span><span class="s2">&quot;rate_limit and not reset&quot;</span>

<span class="c1"># Complex expressions</span>
$<span class="w"> </span>pytest<span class="w"> </span>-k<span class="w"> </span><span class="s2">&quot;(rate_limit or retry) and not slow&quot;</span>
</code></pre></div>

<p><strong>Real-world example</strong>: You're working on authentication. Run all auth-related tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-k<span class="w"> </span><span class="s2">&quot;auth or login or token&quot;</span>
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>collected 247 items / 231 deselected / 16 selected

tests/test_auth.py::test_login_with_valid_credentials PASSED
tests/test_auth.py::test_login_with_invalid_credentials FAILED
tests/test_auth.py::test_token_generation PASSED
tests/test_auth.py::test_token_expiration PASSED
tests/test_auth.py::test_token_refresh PASSED
...

======================== 15 passed, 1 failed, 231 deselected in 3.21s ========================
</code></pre></div>

<p>One test failed. Now you want to focus only on that failure.</p>
<h3 id="iteration-3-running-failed-tests-only">Iteration 3: Running Failed Tests Only</h3>
<p>After a test run, pytest remembers which tests failed. Use <code>--lf</code> (last failed):</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>--lf
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>run-last-failure: rerun previous 1 failure

collected 247 items / 246 deselected / 1 selected

tests/test_auth.py::test_login_with_invalid_credentials FAILED

E       AssertionError: Expected 401, got 500

======================== 1 failed, 246 deselected in 0.23s ========================
</code></pre></div>

<p>Fix the bug, rerun:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>--lf
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>run-last-failure: rerun previous 1 failure

collected 247 items / 246 deselected / 1 selected

tests/test_auth.py::test_login_with_invalid_credentials PASSED

======================== 1 passed, 246 deselected in 0.19s ========================
</code></pre></div>

<p><strong>Run failed tests first, then the rest</strong> (useful for CI):</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>--ff
</code></pre></div>

<p>This runs previously failed tests first, then continues with the rest if they pass.</p>
<h3 id="iteration-4-running-new-or-modified-tests">Iteration 4: Running New or Modified Tests</h3>
<p>Use <code>--nf</code> (new first) to prioritize tests in recently modified files:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>--nf
</code></pre></div>

<p>This is useful when you've just added new tests or modified existing ones.</p>
<h3 id="iteration-5-directory-and-path-patterns">Iteration 5: Directory and Path Patterns</h3>
<p><strong>Run all tests in a directory</strong>:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/unit/
</code></pre></div>

<p><strong>Run tests matching a path pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run all test files matching pattern</span>
$<span class="w"> </span>pytest<span class="w"> </span>tests/test_api*.py

<span class="c1"># Run tests in multiple directories</span>
$<span class="w"> </span>pytest<span class="w"> </span>tests/unit/<span class="w"> </span>tests/integration/
</code></pre></div>

<p><strong>Combine path and keyword selection</strong>:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/unit/<span class="w"> </span>-k<span class="w"> </span>rate_limit
</code></pre></div>

<h3 id="iteration-6-marker-based-selection">Iteration 6: Marker-Based Selection</h3>
<p>We covered markers in Chapter 6, but they're crucial for test selection. Quick recap with practical examples:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_api_client.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">slow</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_search_users_performance</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This test takes 2+ seconds.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">integration</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_real_api_call</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This test hits a real API.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">unit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_rate_limit_calculation</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fast unit test.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div>

<p><strong>Run only fast tests</strong> (exclude slow ones):</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;not slow&quot;</span>
</code></pre></div>

<p><strong>Run only integration tests</strong>:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span>integration
</code></pre></div>

<p><strong>Combine markers with boolean logic</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run unit tests that aren&#39;t slow</span>
$<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;unit and not slow&quot;</span>

<span class="c1"># Run integration or slow tests</span>
$<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;integration or slow&quot;</span>
</code></pre></div>

<h3 id="iteration-7-the-ultimate-workflow-combination">Iteration 7: The Ultimate Workflow Combination</h3>
<p>Here's how professional developers combine these techniques:</p>
<p><strong>During active development</strong> (fast feedback):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Watch specific tests related to current work</span>
$<span class="w"> </span>ptw<span class="w"> </span>-k<span class="w"> </span>rate_limit<span class="w"> </span>--<span class="w"> </span>-v<span class="w"> </span>--lf
</code></pre></div>

<p>This watches for changes, runs only tests matching "rate_limit", and prioritizes previously failed tests.</p>
<p><strong>Before committing</strong> (verify your changes):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run tests in modified files, then new tests, then failed tests</span>
$<span class="w"> </span>pytest<span class="w"> </span>--nf<span class="w"> </span>--ff<span class="w"> </span>-v
</code></pre></div>

<p><strong>In CI/CD</strong> (comprehensive validation):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run all tests in parallel, generate coverage report</span>
$<span class="w"> </span>pytest<span class="w"> </span>-n<span class="w"> </span>auto<span class="w"> </span>--cov<span class="o">=</span>src<span class="w"> </span>--cov-report<span class="o">=</span>html
</code></pre></div>

<p><strong>Quick smoke test</strong> (verify nothing is broken):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run only fast unit tests</span>
$<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;unit and not slow&quot;</span><span class="w"> </span>-x
</code></pre></div>

<p>The <code>-x</code> flag stops on first failure, giving you immediate feedback.</p>
<h3 id="advanced-selection-patterns">Advanced Selection Patterns</h3>
<p><strong>Run tests that failed in the last N runs</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Requires pytest-cache plugin (built-in)</span>
$<span class="w"> </span>pytest<span class="w"> </span>--lf<span class="w"> </span>--last-failed-no-failures<span class="w"> </span>all
</code></pre></div>

<p><strong>Run tests in random order</strong> (detect hidden dependencies):</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pytest-random-order
$<span class="w"> </span>pytest<span class="w"> </span>--random-order
</code></pre></div>

<p><strong>Run tests until one fails</strong> (useful for flaky test detection):</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>--maxfail<span class="o">=</span><span class="m">1</span>
</code></pre></div>

<p><strong>Run a test multiple times</strong> (detect intermittent failures):</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pytest-repeat
$<span class="w"> </span>pytest<span class="w"> </span>tests/test_api_client.py::test_rate_limit_enforced<span class="w"> </span>--count<span class="o">=</span><span class="m">100</span>
</code></pre></div>

<h3 id="decision-framework-which-selection-method-when">Decision Framework: Which Selection Method When?</h3>
<table>
<thead>
<tr>
<th>Scenario</th>
<th>Command</th>
<th>Why</th>
</tr>
</thead>
<tbody>
<tr>
<td>Working on specific feature</td>
<td><code>pytest -k feature_name</code></td>
<td>Fast, intuitive</td>
</tr>
<tr>
<td>Debugging a failure</td>
<td><code>pytest --lf</code></td>
<td>Focus on broken code</td>
</tr>
<tr>
<td>Just added new tests</td>
<td><code>pytest --nf</code></td>
<td>Verify new code first</td>
</tr>
<tr>
<td>Pre-commit check</td>
<td><code>pytest --ff -x</code></td>
<td>Fast fail on regressions</td>
</tr>
<tr>
<td>CI/CD full validation</td>
<td><code>pytest -n auto</code></td>
<td>Comprehensive, fast</td>
</tr>
<tr>
<td>Smoke test</td>
<td><code>pytest -m "not slow" -x</code></td>
<td>Quick confidence check</td>
</tr>
<tr>
<td>Specific file/function</td>
<td><code>pytest path::test_name</code></td>
<td>Precise targeting</td>
</tr>
</tbody>
</table>
<h3 id="pro-tips-for-test-selection">Pro Tips for Test Selection</h3>
<p><strong>1. Create shell aliases for common patterns</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Add to ~/.bashrc or ~/.zshrc</span>
<span class="nb">alias</span><span class="w"> </span><span class="nv">pt</span><span class="o">=</span><span class="s1">&#39;pytest -v&#39;</span>
<span class="nb">alias</span><span class="w"> </span><span class="nv">ptf</span><span class="o">=</span><span class="s1">&#39;pytest --lf -v&#39;</span>
<span class="nb">alias</span><span class="w"> </span><span class="nv">ptw</span><span class="o">=</span><span class="s1">&#39;ptw -- -v&#39;</span>
<span class="nb">alias</span><span class="w"> </span><span class="nv">pts</span><span class="o">=</span><span class="s1">&#39;pytest -m &quot;not slow&quot; -x&#39;</span>
</code></pre></div>

<p><strong>2. Use pytest.ini for default selection</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># pytest.ini</span>
<span class="k">[pytest]</span>
<span class="c1"># Always exclude slow tests unless explicitly requested</span>
<span class="na">addopts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">-m &quot;not slow&quot;</span>
</code></pre></div>

<p>Override when needed:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w">  </span><span class="c1"># Run all tests, including slow ones</span>
</code></pre></div>

<p><strong>3. Create custom markers for your workflow</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">pytest_configure</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">addinivalue_line</span><span class="p">(</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span> <span class="s2">&quot;wip: work in progress tests&quot;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">addinivalue_line</span><span class="p">(</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span> <span class="s2">&quot;smoke: smoke tests for quick validation&quot;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">addinivalue_line</span><span class="p">(</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span> <span class="s2">&quot;regression: regression tests for known bugs&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Then use them:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run only tests you&#39;re actively working on</span>
$<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span>wip

<span class="c1"># Quick smoke test before commit</span>
$<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span>smoke
</code></pre></div>

<p><strong>4. Combine with pytest-watch for ultimate productivity</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Watch and run only failed tests related to auth</span>
$<span class="w"> </span>ptw<span class="w"> </span>-k<span class="w"> </span>auth<span class="w"> </span>--<span class="w"> </span>--lf<span class="w"> </span>-v
</code></pre></div>

<p>This creates a tight feedback loop: you save a file, and within seconds you see if your fix worked, without running unrelated tests.</p>
<h2 id="using-test-templates">Using Test Templates</h2>
<h2 id="the-repetitive-test-problem">The Repetitive Test Problem</h2>
<p>You're adding a new API endpoint to your client. You need to write tests for:
- Success case
- 404 error
- 401 authentication error
- 500 server error
- Network timeout
- Invalid response format</p>
<p>You find yourself copying and pasting test structure repeatedly:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_api_client.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_get_user_success</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_user_not_found</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">404</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">raise_for_status</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">999</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_user_unauthorized</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">401</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">raise_for_status</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Now repeat this pattern for list_users, create_user, update_user, delete_user...</span>
</code></pre></div>

<p>This is tedious and error-prone. Each endpoint needs the same test structure, but with different method calls and parameters.</p>
<h3 id="iteration-1-fixture-based-templates">Iteration 1: Fixture-Based Templates</h3>
<p>Create reusable test fixtures that encapsulate common patterns:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_http_error</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory fixture for creating HTTP error responses.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_make_error</span><span class="p">(</span><span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span>
            <span class="n">message</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;HTTP </span><span class="si">{</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
    <span class="k">return</span> <span class="n">_make_error</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_success_response</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory fixture for creating successful responses.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_make_response</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">response</span>
    <span class="k">return</span> <span class="n">_make_response</span>
</code></pre></div>

<p>Now use these templates to write tests more concisely:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_api_client.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_get_user_success</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">,</span> <span class="n">mock_success_response</span><span class="p">):</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_success_response</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">})</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;alice&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_user_not_found</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">,</span> <span class="n">mock_http_error</span><span class="p">):</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_http_error</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s2">&quot;User not found&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;404&quot;</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">999</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_user_unauthorized</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">,</span> <span class="n">mock_http_error</span><span class="p">):</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_http_error</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="s2">&quot;Unauthorized&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;401&quot;</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p><strong>Improvement</strong>: Less boilerplate, more readable, consistent error handling.</p>
<h3 id="iteration-2-parameterized-test-templates">Iteration 2: Parameterized Test Templates</h3>
<p>For endpoints that share the same error handling patterns, use parametrization:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_api_client.py</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;status_code,error_message&quot;</span><span class="p">,</span> <span class="p">[</span>
    <span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;Bad Request&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="s2">&quot;Unauthorized&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s2">&quot;Forbidden&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s2">&quot;Not Found&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;Internal Server Error&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">503</span><span class="p">,</span> <span class="s2">&quot;Service Unavailable&quot;</span><span class="p">),</span>
<span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_get_user_http_errors</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">,</span> <span class="n">mock_http_error</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">error_message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that get_user handles various HTTP errors correctly.&quot;&quot;&quot;</span>
    <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_http_error</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">error_message</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">status_code</span><span class="p">)):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p><strong>Result</strong>: One test function covers 6 error scenarios. Add a new error code? Just add a line to the parameter list.</p>
<h3 id="iteration-3-class-based-test-templates">Iteration 3: Class-Based Test Templates</h3>
<p>For complex test scenarios that share setup logic, use test classes with fixtures:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_api_client.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TestAPIEndpoint</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class template for testing API endpoints.&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">endpoint_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override in subclass to specify which method to test.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">success_response_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override in subclass to specify expected success data.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">method_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override in subclass to specify method arguments.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">()</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">method_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override in subclass to specify method keyword arguments.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">,</span> <span class="n">mock_success_response</span><span class="p">,</span> 
                     <span class="n">endpoint_method</span><span class="p">,</span> <span class="n">success_response_data</span><span class="p">,</span> <span class="n">method_args</span><span class="p">,</span> <span class="n">method_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test successful endpoint call.&quot;&quot;&quot;</span>
        <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_success_response</span><span class="p">(</span><span class="n">success_response_data</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">endpoint_method</span><span class="p">(</span><span class="o">*</span><span class="n">method_args</span><span class="p">,</span> <span class="o">**</span><span class="n">method_kwargs</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">success_response_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_not_found</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">,</span> <span class="n">mock_http_error</span><span class="p">,</span>
                       <span class="n">endpoint_method</span><span class="p">,</span> <span class="n">method_args</span><span class="p">,</span> <span class="n">method_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test 404 error handling.&quot;&quot;&quot;</span>
        <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_http_error</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;404&quot;</span><span class="p">):</span>
            <span class="n">endpoint_method</span><span class="p">(</span><span class="o">*</span><span class="n">method_args</span><span class="p">,</span> <span class="o">**</span><span class="n">method_kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_unauthorized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">,</span> <span class="n">mock_http_error</span><span class="p">,</span>
                          <span class="n">endpoint_method</span><span class="p">,</span> <span class="n">method_args</span><span class="p">,</span> <span class="n">method_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test 401 error handling.&quot;&quot;&quot;</span>
        <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_http_error</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;401&quot;</span><span class="p">):</span>
            <span class="n">endpoint_method</span><span class="p">(</span><span class="o">*</span><span class="n">method_args</span><span class="p">,</span> <span class="o">**</span><span class="n">method_kwargs</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestGetUser</span><span class="p">(</span><span class="n">TestAPIEndpoint</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test get_user endpoint using template.&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">endpoint_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">get_user</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">success_response_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">}</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">method_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>  <span class="c1"># user_id</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestListUsers</span><span class="p">(</span><span class="n">TestAPIEndpoint</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test list_users endpoint using template.&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">endpoint_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">list_users</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">success_response_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;bob&quot;</span><span class="p">}</span>
        <span class="p">]</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">method_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
</code></pre></div>

<p><strong>Result</strong>: Each endpoint gets comprehensive error handling tests by inheriting from the template. Add a new endpoint? Create a new subclass with 10 lines of code, get 3+ tests automatically.</p>
<h3 id="iteration-4-pytest-plugin-for-custom-templates">Iteration 4: Pytest Plugin for Custom Templates</h3>
<p>For organization-wide test patterns, create a pytest plugin:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># pytest_api_templates.py (custom plugin)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>

<span class="k">class</span><span class="w"> </span><span class="nc">APITestTemplate</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Template for testing API client methods.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">success_data</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">success_data</span> <span class="o">=</span> <span class="n">success_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">,</span> <span class="n">mock_success_response</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test successful API call.&quot;&quot;&quot;</span>
        <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_success_response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">success_data</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_http_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">,</span> <span class="n">mock_http_error</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test HTTP error handling.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">status_code</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">400</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span> <span class="mi">403</span><span class="p">,</span> <span class="mi">404</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">503</span><span class="p">]:</span>
            <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_http_error</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_network_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test network error handling.&quot;&quot;&quot;</span>
        <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_test_template</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture that returns the template class.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">APITestTemplate</span>
</code></pre></div>

<p>Use the plugin in your tests:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_api_client.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_get_user_suite</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">api_test_template</span><span class="p">,</span> <span class="n">mock_session</span><span class="p">,</span> <span class="n">mock_success_response</span><span class="p">,</span> <span class="n">mock_http_error</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run full test suite for get_user endpoint.&quot;&quot;&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">api_test_template</span><span class="p">(</span>
        <span class="n">method</span><span class="o">=</span><span class="n">client</span><span class="o">.</span><span class="n">get_user</span><span class="p">,</span>
        <span class="n">success_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">},</span>
        <span class="mi">1</span>  <span class="c1"># user_id argument</span>
    <span class="p">)</span>

    <span class="c1"># Run all template tests</span>
    <span class="n">template</span><span class="o">.</span><span class="n">test_success</span><span class="p">(</span><span class="n">mock_session</span><span class="p">,</span> <span class="n">mock_success_response</span><span class="p">)</span>
    <span class="n">template</span><span class="o">.</span><span class="n">test_http_errors</span><span class="p">(</span><span class="n">mock_session</span><span class="p">,</span> <span class="n">mock_http_error</span><span class="p">)</span>
    <span class="n">template</span><span class="o">.</span><span class="n">test_network_error</span><span class="p">(</span><span class="n">mock_session</span><span class="p">)</span>
</code></pre></div>

<h3 id="iteration-5-code-generation-templates">Iteration 5: Code Generation Templates</h3>
<p>For truly repetitive patterns, use code generation:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># generate_tests.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="n">ENDPOINT_TEMPLATE</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">class Test</span><span class="si">{endpoint_class}</span><span class="s1">:</span>
<span class="s1">    &quot;&quot;&quot;Test </span><span class="si">{endpoint_name}</span><span class="s1"> endpoint.&quot;&quot;&quot;</span>

<span class="s1">    def test_success(self, client, mock_session, mock_success_response):</span>
<span class="s1">        mock_session.</span><span class="si">{http_method}</span><span class="s1">.return_value = mock_success_response(</span><span class="si">{success_data}</span><span class="s1">)</span>
<span class="s1">        result = client.</span><span class="si">{endpoint_name}</span><span class="s1">(</span><span class="si">{args}</span><span class="s1">)</span>
<span class="s1">        assert result == </span><span class="si">{success_data}</span>

<span class="s1">    def test_not_found(self, client, mock_session, mock_http_error):</span>
<span class="s1">        mock_session.</span><span class="si">{http_method}</span><span class="s1">.return_value = mock_http_error(404)</span>
<span class="s1">        with pytest.raises(requests.HTTPError, match=&quot;404&quot;):</span>
<span class="s1">            client.</span><span class="si">{endpoint_name}</span><span class="s1">(</span><span class="si">{args}</span><span class="s1">)</span>

<span class="s1">    def test_unauthorized(self, client, mock_session, mock_http_error):</span>
<span class="s1">        mock_session.</span><span class="si">{http_method}</span><span class="s1">.return_value = mock_http_error(401)</span>
<span class="s1">        with pytest.raises(requests.HTTPError, match=&quot;401&quot;):</span>
<span class="s1">            client.</span><span class="si">{endpoint_name}</span><span class="s1">(</span><span class="si">{args}</span><span class="s1">)</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">generate_endpoint_tests</span><span class="p">(</span><span class="n">endpoint_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">http_method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                            <span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">success_data</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate test class for an endpoint.&quot;&quot;&quot;</span>
    <span class="n">endpoint_class</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">endpoint_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">ENDPOINT_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">endpoint_class</span><span class="o">=</span><span class="n">endpoint_class</span><span class="p">,</span>
        <span class="n">endpoint_name</span><span class="o">=</span><span class="n">endpoint_name</span><span class="p">,</span>
        <span class="n">http_method</span><span class="o">=</span><span class="n">http_method</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
        <span class="n">success_data</span><span class="o">=</span><span class="n">success_data</span>
    <span class="p">)</span>

<span class="c1"># Generate tests for all endpoints</span>
<span class="n">endpoints</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;get_user&quot;</span><span class="p">,</span> <span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s1">&#39;{&quot;id&quot;: 1, &quot;username&quot;: &quot;alice&quot;}&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;list_users&quot;</span><span class="p">,</span> <span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s1">&#39;[{&quot;id&quot;: 1}, {&quot;id&quot;: 2}]&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;create_user&quot;</span><span class="p">,</span> <span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;alice&quot;, &quot;alice@example.com&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;{&quot;id&quot;: 3}&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;update_user&quot;</span><span class="p">,</span> <span class="s2">&quot;patch&quot;</span><span class="p">,</span> <span class="s1">&#39;1, username=&quot;alice_updated&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;{&quot;id&quot;: 1}&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;delete_user&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;# Auto-generated tests</span><span class="se">\n</span><span class="s2">import pytest</span><span class="se">\n</span><span class="s2">import requests</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<span class="k">for</span> <span class="n">endpoint_name</span><span class="p">,</span> <span class="n">http_method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">success_data</span> <span class="ow">in</span> <span class="n">endpoints</span><span class="p">:</span>
    <span class="n">output</span> <span class="o">+=</span> <span class="n">generate_endpoint_tests</span><span class="p">(</span><span class="n">endpoint_name</span><span class="p">,</span> <span class="n">http_method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">success_data</span><span class="p">)</span>

<span class="n">Path</span><span class="p">(</span><span class="s2">&quot;tests/test_api_client_generated.py&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generated tests/test_api_client_generated.py&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Run the generator:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>python<span class="w"> </span>generate_tests.py
Generated<span class="w"> </span>tests/test_api_client_generated.py
</code></pre></div>

<p><strong>Result</strong>: 15 tests (3 per endpoint √ó 5 endpoints) generated automatically. Add a new endpoint? Add one line to the <code>endpoints</code> list and regenerate.</p>
<h3 id="when-to-use-each-template-approach">When to Use Each Template Approach</h3>
<table>
<thead>
<tr>
<th>Approach</th>
<th>Best For</th>
<th>Complexity</th>
<th>Flexibility</th>
</tr>
</thead>
<tbody>
<tr>
<td>Fixture-based</td>
<td>Common setup patterns</td>
<td>Low</td>
<td>High</td>
</tr>
<tr>
<td>Parameterized</td>
<td>Multiple similar scenarios</td>
<td>Low</td>
<td>Medium</td>
</tr>
<tr>
<td>Class-based</td>
<td>Endpoint families</td>
<td>Medium</td>
<td>High</td>
</tr>
<tr>
<td>Plugin-based</td>
<td>Organization-wide patterns</td>
<td>High</td>
<td>Medium</td>
</tr>
<tr>
<td>Code generation</td>
<td>Highly repetitive tests</td>
<td>High</td>
<td>Low</td>
</tr>
</tbody>
</table>
<h3 id="decision-framework-template-vs-manual">Decision Framework: Template vs. Manual</h3>
<p><strong>Use templates when</strong>:
- You're writing the same test structure 3+ times
- The pattern is stable and unlikely to change
- New team members need to write similar tests
- You want to enforce consistency across the codebase</p>
<p><strong>Write manual tests when</strong>:
- The test logic is unique
- The pattern is still evolving
- Flexibility is more important than consistency
- The template would be more complex than the tests themselves</p>
<h3 id="pro-tips-for-test-templates">Pro Tips for Test Templates</h3>
<p><strong>1. Start simple, refactor to templates later</strong>:</p>
<p>Write 3-4 manual tests first. Once you see the pattern, extract it into a template. Don't prematurely abstract.</p>
<p><strong>2. Document template usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_test_template</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Template for testing API endpoints.</span>

<span class="sd">    Usage:</span>
<span class="sd">        template = api_test_template(</span>
<span class="sd">            method=client.get_user,</span>
<span class="sd">            success_data={&quot;id&quot;: 1},</span>
<span class="sd">            1  # positional args</span>
<span class="sd">        )</span>
<span class="sd">        template.test_success(mock_session, mock_success_response)</span>

<span class="sd">    Provides:</span>
<span class="sd">        - test_success: Verify successful API call</span>
<span class="sd">        - test_http_errors: Test 4xx/5xx error handling</span>
<span class="sd">        - test_network_error: Test connection failures</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">APITestTemplate</span>
</code></pre></div>

<p><strong>3. Make templates discoverable</strong>:</p>
<p>Create a <code>tests/templates/</code> directory with example usage:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/templates/example_api_endpoint.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Example of using the API test template.</span>

<span class="sd">Copy this file and modify for your endpoint.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">conftest</span><span class="w"> </span><span class="kn">import</span> <span class="n">api_test_template</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestYourEndpoint</span><span class="p">:</span>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">endpoint_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">your_method</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">success_response_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;your&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">}</span>

    <span class="c1"># Tests are inherited from template</span>
</code></pre></div>

<p><strong>4. Version your templates</strong>:</p>
<p>As your API evolves, you might need different template versions:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_test_template_v1</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Template for v1 API endpoints.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">APITestTemplateV1</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_test_template_v2</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Template for v2 API endpoints (includes auth).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">APITestTemplateV2</span>
</code></pre></div>

<p><strong>5. Combine templates with markers</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">pytest_collection_modifyitems</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Auto-mark tests generated from templates.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;template&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">nodeid</span><span class="p">:</span>
            <span class="n">item</span><span class="o">.</span><span class="n">add_marker</span><span class="p">(</span><span class="n">pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">template_generated</span><span class="p">)</span>
</code></pre></div>

<p>Then run or exclude template-generated tests:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run only manually written tests</span>
$<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;not template_generated&quot;</span>

<span class="c1"># Run only template-generated tests</span>
$<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span>template_generated
</code></pre></div>

<h2 id="industry-hacks-and-patterns">Industry Hacks and Patterns</h2>
<p>Professional developers face challenges that textbooks don't cover: legacy code without tests, massive codebases, distributed systems, and non-deterministic behavior. This section reveals battle-tested patterns for these real-world scenarios.</p>
<p>We'll explore these patterns through a realistic scenario: a legacy e-commerce system that's been in production for 5 years, has minimal test coverage, and needs to be modernized without breaking existing functionality.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/legacy_order_system.py (the code we inherited)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">smtplib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>

<span class="k">class</span><span class="w"> </span><span class="nc">OrderProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Legacy order processing system.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email_server</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process an order. This method does EVERYTHING:</span>
<span class="sd">        - Validates order data</span>
<span class="sd">        - Checks inventory</span>
<span class="sd">        - Calculates pricing</span>
<span class="sd">        - Processes payment</span>
<span class="sd">        - Updates database</span>
<span class="sd">        - Sends confirmation email</span>
<span class="sd">        - Updates analytics</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validation</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">order_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;customer_id&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing customer_id&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">order_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;items&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No items in order&quot;</span><span class="p">)</span>

        <span class="c1"># Connect to database (global state!)</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">mysql.connector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_connection</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="s2">&quot;prod-db.company.com&quot;</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="s2">&quot;app_user&quot;</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="s2">&quot;hardcoded_password&quot;</span><span class="p">,</span>  <span class="c1"># Yes, really</span>
            <span class="n">database</span><span class="o">=</span><span class="s2">&quot;orders&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Check inventory (direct DB query)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s2">&quot;SELECT quantity FROM inventory WHERE product_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">],)</span>
            <span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">or</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Insufficient inventory for </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate total (complex business logic)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s2">&quot;SELECT price FROM products WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">],)</span>
            <span class="p">)</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>

            <span class="c1"># Apply discounts (hardcoded rules)</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">price</span> <span class="o">*=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.9&#39;</span><span class="p">)</span>  <span class="c1"># 10% bulk discount</span>
            <span class="k">if</span> <span class="n">order_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;customer_type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;premium&#39;</span><span class="p">:</span>
                <span class="n">price</span> <span class="o">*=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.95&#39;</span><span class="p">)</span>  <span class="c1"># 5% premium discount</span>

            <span class="n">total</span> <span class="o">+=</span> <span class="n">price</span> <span class="o">*</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span>

        <span class="c1"># Apply tax (varies by state)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">order_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shipping_state&#39;</span><span class="p">,</span> <span class="s1">&#39;CA&#39;</span><span class="p">)</span>
        <span class="n">tax_rates</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;CA&#39;</span><span class="p">:</span> <span class="mf">0.0725</span><span class="p">,</span> <span class="s1">&#39;NY&#39;</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">,</span> <span class="s1">&#39;TX&#39;</span><span class="p">:</span> <span class="mf">0.0625</span><span class="p">}</span>
        <span class="n">tax</span> <span class="o">=</span> <span class="n">total</span> <span class="o">*</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tax_rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">)))</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">tax</span>

        <span class="c1"># Process payment (external API call)</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
        <span class="n">payment_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;https://payment-gateway.example.com/charge&quot;</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">total</span><span class="p">),</span>
                <span class="s1">&#39;customer_id&#39;</span><span class="p">:</span> <span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;customer_id&#39;</span><span class="p">],</span>
                <span class="s1">&#39;card_token&#39;</span><span class="p">:</span> <span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;payment_token&#39;</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">payment_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Payment failed&quot;</span><span class="p">)</span>

        <span class="c1"># Insert order into database</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;INSERT INTO orders </span>
<span class="sd">               (customer_id, total, status, created_at) </span>
<span class="sd">               VALUES (%s, %s, %s, %s)&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;customer_id&#39;</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">total</span><span class="p">),</span> <span class="s1">&#39;completed&#39;</span><span class="p">,</span> 
             <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="n">order_id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span>

        <span class="c1"># Insert order items</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;INSERT INTO order_items </span>
<span class="sd">                   (order_id, product_id, quantity, price) </span>
<span class="sd">                   VALUES (%s, %s, %s, %s)&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">],</span> 
                 <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]))</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db_connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Send confirmation email</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email_server</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="s1">&#39;smtp.company.com&#39;</span><span class="p">,</span> <span class="mi">587</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email_server</span><span class="o">.</span><span class="n">starttls</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email_server</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s1">&#39;noreply@company.com&#39;</span><span class="p">,</span> <span class="s1">&#39;email_password&#39;</span><span class="p">)</span>

        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Subject: Order Confirmation #</span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span>

<span class="s2">        Thank you for your order!</span>
<span class="s2">        Order ID: </span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span>
<span class="s2">        Total: $</span><span class="si">{</span><span class="n">total</span><span class="si">}</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">email_server</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span>
            <span class="s1">&#39;noreply@company.com&#39;</span><span class="p">,</span>
            <span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;customer_email&#39;</span><span class="p">],</span>
            <span class="n">message</span>
        <span class="p">)</span>

        <span class="c1"># Update analytics (another external service)</span>
        <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;https://analytics.company.com/event&quot;</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="s1">&#39;order_completed&#39;</span><span class="p">,</span>
                <span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="n">order_id</span><span class="p">,</span>
                <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">total</span><span class="p">),</span>
                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Cleanup</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email_server</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">order_id</span>
</code></pre></div>

<p>This is the reality of legacy code: a 150-line method that does everything, has no tests, uses global state, makes external calls, and contains critical business logic. How do you test this without rewriting it?</p>
<h2 id="the-legacy-code-dilemma">The Legacy Code Dilemma</h2>
<p>You need to add a feature to <code>process_order()</code>: support for promotional codes. But first, you need tests to ensure you don't break existing functionality. The problem: this code is untestable in its current form.</p>
<p><strong>The naive approach</strong> (doesn't work):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_order_processor.py (naive attempt)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.legacy_order_system</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderProcessor</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order</span><span class="p">():</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">OrderProcessor</span><span class="p">()</span>

    <span class="n">order_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;customer_id&#39;</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span>
        <span class="s1">&#39;customer_email&#39;</span><span class="p">:</span> <span class="s1">&#39;test@example.com&#39;</span><span class="p">,</span>
        <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;product_id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mf">10.00</span><span class="p">}</span>
        <span class="p">],</span>
        <span class="s1">&#39;payment_token&#39;</span><span class="p">:</span> <span class="s1">&#39;tok_test&#39;</span>
    <span class="p">}</span>

    <span class="n">order_id</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_order</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">order_id</span> <span class="o">&gt;</span> <span class="mi">0</span>
</code></pre></div>

<p>Run this test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_order_processor.py::test_process_order<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>tests/test_order_processor.py::test_process_order FAILED

E   mysql.connector.errors.InterfaceError: 2003: Can&#39;t connect to MySQL server on &#39;prod-db.company.com&#39;

======================== 1 failed in 2.34s ========================
</code></pre></div>

<p><strong>Root cause</strong>: The test tries to connect to the production database. Even if we had a test database, the test would still:
- Make real HTTP requests to payment gateway
- Send real emails
- Depend on database state
- Take 30+ seconds to run</p>
<h3 id="iteration-1-the-characterization-test-pattern">Iteration 1: The Characterization Test Pattern</h3>
<p>Before refactoring, we need to understand what the code currently does. Create "characterization tests" that document existing behavior:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_order_processor_characterization.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">MagicMock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.legacy_order_system</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderProcessor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_database</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mock the database connection.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;mysql.connector.connect&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_connect</span><span class="p">:</span>
        <span class="n">mock_conn</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>

        <span class="c1"># Setup cursor to return expected data</span>
        <span class="n">mock_cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="mi">100</span><span class="p">,),</span>  <span class="c1"># inventory quantity for first item</span>
            <span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;10.00&#39;</span><span class="p">),),</span>  <span class="c1"># price for first item</span>
        <span class="p">]</span>
        <span class="n">mock_cursor</span><span class="o">.</span><span class="n">lastrowid</span> <span class="o">=</span> <span class="mi">12345</span>  <span class="c1"># order_id after insert</span>

        <span class="n">mock_conn</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_cursor</span>
        <span class="n">mock_connect</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_conn</span>

        <span class="k">yield</span> <span class="n">mock_conn</span><span class="p">,</span> <span class="n">mock_cursor</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_payment</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mock the payment gateway.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;requests.post&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_post</span><span class="p">:</span>
        <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">mock_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">mock_post</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_response</span>
        <span class="k">yield</span> <span class="n">mock_post</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_email</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mock the email server.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;smtplib.SMTP&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_smtp</span><span class="p">:</span>
        <span class="n">mock_server</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">mock_smtp</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_server</span>
        <span class="k">yield</span> <span class="n">mock_server</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_basic_flow</span><span class="p">(</span><span class="n">mock_database</span><span class="p">,</span> <span class="n">mock_payment</span><span class="p">,</span> <span class="n">mock_email</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Characterization test: Document what process_order currently does.</span>

<span class="sd">    This test doesn&#39;t verify correctness‚Äîit verifies current behavior.</span>
<span class="sd">    Once we have this safety net, we can refactor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mock_conn</span><span class="p">,</span> <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">mock_database</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">OrderProcessor</span><span class="p">()</span>

    <span class="n">order_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;customer_id&#39;</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span>
        <span class="s1">&#39;customer_email&#39;</span><span class="p">:</span> <span class="s1">&#39;test@example.com&#39;</span><span class="p">,</span>
        <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;product_id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mf">10.00</span><span class="p">}</span>
        <span class="p">],</span>
        <span class="s1">&#39;payment_token&#39;</span><span class="p">:</span> <span class="s1">&#39;tok_test&#39;</span><span class="p">,</span>
        <span class="s1">&#39;shipping_state&#39;</span><span class="p">:</span> <span class="s1">&#39;CA&#39;</span>
    <span class="p">}</span>

    <span class="n">order_id</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_order</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>

    <span class="c1"># Verify the order ID was returned</span>
    <span class="k">assert</span> <span class="n">order_id</span> <span class="o">==</span> <span class="mi">12345</span>

    <span class="c1"># Verify database interactions (characterize current behavior)</span>
    <span class="k">assert</span> <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">4</span>  <span class="c1"># inventory, price, insert order, insert items</span>

    <span class="c1"># Verify payment was processed</span>
    <span class="n">mock_payment</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">payment_call</span> <span class="o">=</span> <span class="n">mock_payment</span><span class="o">.</span><span class="n">call_args</span>
    <span class="k">assert</span> <span class="n">payment_call</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;json&#39;</span><span class="p">][</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="mf">21.45</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>  <span class="c1"># 20 + 7.25% tax</span>

    <span class="c1"># Verify email was sent</span>
    <span class="n">mock_email</span><span class="o">.</span><span class="n">sendmail</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">email_call</span> <span class="o">=</span> <span class="n">mock_email</span><span class="o">.</span><span class="n">sendmail</span><span class="o">.</span><span class="n">call_args</span>
    <span class="k">assert</span> <span class="s1">&#39;Order Confirmation #12345&#39;</span> <span class="ow">in</span> <span class="n">email_call</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</code></pre></div>

<p>Run the characterization test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_order_processor_characterization.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>tests/test_order_processor_characterization.py::test_process_order_basic_flow PASSED

======================== 1 passed in 0.23s ========================
</code></pre></div>

<p><strong>Success!</strong> We've created a test that runs without external dependencies and documents current behavior.</p>
<h3 id="iteration-2-the-seam-pattern">Iteration 2: The Seam Pattern</h3>
<p>Now we can safely add features. We need to test promotional codes without refactoring the entire method. Use "seams"‚Äîpoints where we can inject test behavior.</p>
<p><strong>Add a seam for discount calculation</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/legacy_order_system.py (minimal change)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OrderProcessor</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email_server</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_discount_calculator</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Seam for testing</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_discount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">order_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Seam: Extract discount logic so it can be overridden in tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discount_calculator</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discount_calculator</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">order_data</span><span class="p">)</span>

        <span class="c1"># Original logic (unchanged)</span>
        <span class="n">discount</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;1.0&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">discount</span> <span class="o">*=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.9&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">order_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;customer_type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;premium&#39;</span><span class="p">:</span>
            <span class="n">discount</span> <span class="o">*=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.95&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">discount</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_data</span><span class="p">):</span>
        <span class="c1"># ... (earlier code unchanged)</span>

        <span class="c1"># Calculate total (now uses seam)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s2">&quot;SELECT price FROM products WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">],)</span>
            <span class="p">)</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>

            <span class="c1"># Use the seam</span>
            <span class="n">discount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_discount</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">order_data</span><span class="p">)</span>
            <span class="n">price</span> <span class="o">*=</span> <span class="n">discount</span>

            <span class="n">total</span> <span class="o">+=</span> <span class="n">price</span> <span class="o">*</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span>

        <span class="c1"># ... (rest unchanged)</span>
</code></pre></div>

<p>Now test the new promotional code feature:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_order_processor_promo_codes.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_promotional_code_applies_discount</span><span class="p">(</span><span class="n">mock_database</span><span class="p">,</span> <span class="n">mock_payment</span><span class="p">,</span> <span class="n">mock_email</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that promotional codes reduce the order total.&quot;&quot;&quot;</span>
    <span class="n">mock_conn</span><span class="p">,</span> <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">mock_database</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">OrderProcessor</span><span class="p">()</span>

    <span class="c1"># Inject test behavior through the seam</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">promo_discount_calculator</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">order_data</span><span class="p">):</span>
        <span class="n">base_discount</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;1.0&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">base_discount</span> <span class="o">*=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.9&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">order_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;customer_type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;premium&#39;</span><span class="p">:</span>
            <span class="n">base_discount</span> <span class="o">*=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.95&#39;</span><span class="p">)</span>

        <span class="c1"># NEW: Apply promo code discount</span>
        <span class="k">if</span> <span class="n">order_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;promo_code&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;SAVE20&#39;</span><span class="p">:</span>
            <span class="n">base_discount</span> <span class="o">*=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.8&#39;</span><span class="p">)</span>  <span class="c1"># 20% off</span>

        <span class="k">return</span> <span class="n">base_discount</span>

    <span class="n">processor</span><span class="o">.</span><span class="n">_discount_calculator</span> <span class="o">=</span> <span class="n">promo_discount_calculator</span>

    <span class="n">order_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;customer_id&#39;</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span>
        <span class="s1">&#39;customer_email&#39;</span><span class="p">:</span> <span class="s1">&#39;test@example.com&#39;</span><span class="p">,</span>
        <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;product_id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mf">10.00</span><span class="p">}</span>
        <span class="p">],</span>
        <span class="s1">&#39;payment_token&#39;</span><span class="p">:</span> <span class="s1">&#39;tok_test&#39;</span><span class="p">,</span>
        <span class="s1">&#39;shipping_state&#39;</span><span class="p">:</span> <span class="s1">&#39;CA&#39;</span><span class="p">,</span>
        <span class="s1">&#39;promo_code&#39;</span><span class="p">:</span> <span class="s1">&#39;SAVE20&#39;</span>  <span class="c1"># NEW</span>
    <span class="p">}</span>

    <span class="n">order_id</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_order</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>

    <span class="c1"># Verify discount was applied</span>
    <span class="n">payment_call</span> <span class="o">=</span> <span class="n">mock_payment</span><span class="o">.</span><span class="n">call_args</span>
    <span class="c1"># Original: 20 + 7.25% tax = 21.45</span>
    <span class="c1"># With 20% promo: 16 + 7.25% tax = 17.16</span>
    <span class="k">assert</span> <span class="n">payment_call</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;json&#39;</span><span class="p">][</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="mf">17.16</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
</code></pre></div>

<p><strong>Result</strong>: We tested the new feature without rewriting the legacy code. The seam allows us to inject test behavior while preserving production behavior.</p>
<h3 id="iteration-3-the-approval-testing-pattern">Iteration 3: The Approval Testing Pattern</h3>
<p>For complex legacy code where you don't fully understand the behavior, use "approval testing" (also called "golden master testing"):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_order_processor_approval.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">MagicMock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.legacy_order_system</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderProcessor</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">approval_test_setup</span><span class="p">(</span><span class="n">mock_database</span><span class="p">,</span> <span class="n">mock_payment</span><span class="p">,</span> <span class="n">mock_email</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Setup for approval testing.&quot;&quot;&quot;</span>
    <span class="n">mock_conn</span><span class="p">,</span> <span class="n">mock_cursor</span> <span class="o">=</span> <span class="n">mock_database</span>

    <span class="c1"># Capture all interactions</span>
    <span class="n">interactions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;database_queries&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;payment_calls&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;email_calls&#39;</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">}</span>

    <span class="c1"># Wrap mocks to capture calls</span>
    <span class="n">original_execute</span> <span class="o">=</span> <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">capture_execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">interactions</span><span class="p">[</span><span class="s1">&#39;database_queries&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">params</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="n">original_execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="n">mock_cursor</span><span class="o">.</span><span class="n">execute</span> <span class="o">=</span> <span class="n">capture_execute</span>

    <span class="n">original_payment</span> <span class="o">=</span> <span class="n">mock_payment</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">capture_payment</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">interactions</span><span class="p">[</span><span class="s1">&#39;payment_calls&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="n">kwargs</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="n">original_payment</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">mock_payment</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">capture_payment</span>

    <span class="n">original_sendmail</span> <span class="o">=</span> <span class="n">mock_email</span><span class="o">.</span><span class="n">sendmail</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">capture_email</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">interactions</span><span class="p">[</span><span class="s1">&#39;email_calls&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="n">kwargs</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="n">original_sendmail</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">mock_email</span><span class="o">.</span><span class="n">sendmail</span> <span class="o">=</span> <span class="n">capture_email</span>

    <span class="k">return</span> <span class="n">interactions</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_order_processing_approval</span><span class="p">(</span><span class="n">approval_test_setup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Approval test: Capture complete behavior and compare to approved baseline.</span>

<span class="sd">    First run: Manually review output and approve it.</span>
<span class="sd">    Subsequent runs: Verify behavior hasn&#39;t changed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interactions</span> <span class="o">=</span> <span class="n">approval_test_setup</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">OrderProcessor</span><span class="p">()</span>

    <span class="n">order_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;customer_id&#39;</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span>
        <span class="s1">&#39;customer_email&#39;</span><span class="p">:</span> <span class="s1">&#39;test@example.com&#39;</span><span class="p">,</span>
        <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;product_id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mf">10.00</span><span class="p">}</span>
        <span class="p">],</span>
        <span class="s1">&#39;payment_token&#39;</span><span class="p">:</span> <span class="s1">&#39;tok_test&#39;</span><span class="p">,</span>
        <span class="s1">&#39;shipping_state&#39;</span><span class="p">:</span> <span class="s1">&#39;CA&#39;</span>
    <span class="p">}</span>

    <span class="n">order_id</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_order</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>

    <span class="c1"># Serialize all interactions</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="n">order_id</span><span class="p">,</span>
        <span class="s1">&#39;database_queries&#39;</span><span class="p">:</span> <span class="n">interactions</span><span class="p">[</span><span class="s1">&#39;database_queries&#39;</span><span class="p">],</span>
        <span class="s1">&#39;payment_calls&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">call</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">][</span><span class="s1">&#39;json&#39;</span><span class="p">][</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">interactions</span><span class="p">[</span><span class="s1">&#39;payment_calls&#39;</span><span class="p">]</span>
        <span class="p">],</span>
        <span class="s1">&#39;email_calls&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;subject_line&#39;</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">interactions</span><span class="p">[</span><span class="s1">&#39;email_calls&#39;</span><span class="p">]</span>
        <span class="p">]</span>
    <span class="p">}</span>

    <span class="c1"># Compare to approved baseline</span>
    <span class="n">approval_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;tests/approvals/order_processing.approved.json&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">approval_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="c1"># First run: Save as baseline</span>
        <span class="n">approval_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">approval_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Baseline created. Review and approve.&quot;</span><span class="p">)</span>

    <span class="c1"># Compare to baseline</span>
    <span class="n">approved</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">approval_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">approved</span><span class="p">,</span> <span class="s2">&quot;Behavior changed! Review differences.&quot;</span>
</code></pre></div>

<p><strong>First run</strong> (creates baseline):</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_order_processor_approval.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>tests/test_order_processor_approval.py::test_order_processing_approval SKIPPED (Baseline created. Review and approve.)
</code></pre></div>

<p>Review the generated file:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;order_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">12345</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;database_queries&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;query&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SELECT quantity FROM inventory WHERE product_id = %s&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;params&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;query&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SELECT price FROM products WHERE id = %s&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;params&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;query&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;INSERT INTO orders (customer_id, total, status, created_at) VALUES (%s, %s, %s, %s)&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;params&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">123</span><span class="p">,</span><span class="w"> </span><span class="mf">21.45</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;completed&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;2024-01-15T10:30:00&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;payment_calls&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://payment-gateway.example.com/charge&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">21.45</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;email_calls&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;to&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;test@example.com&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;subject_line&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Subject: Order Confirmation #12345&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p>If this looks correct, approve it. <strong>Subsequent runs</strong> verify nothing changed:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_order_processor_approval.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>tests/test_order_processor_approval.py::test_order_processing_approval PASSED
</code></pre></div>

<p>If behavior changes (intentionally or not), the test fails and shows the diff.</p>
<h3 id="when-to-use-each-pattern">When to Use Each Pattern</h3>
<table>
<thead>
<tr>
<th>Pattern</th>
<th>Best For</th>
<th>Effort</th>
<th>Safety</th>
</tr>
</thead>
<tbody>
<tr>
<td>Characterization</td>
<td>Understanding existing behavior</td>
<td>Low</td>
<td>Medium</td>
</tr>
<tr>
<td>Seam</td>
<td>Adding features to legacy code</td>
<td>Medium</td>
<td>High</td>
</tr>
<tr>
<td>Approval</td>
<td>Complex behavior you don't fully understand</td>
<td>High</td>
<td>Very High</td>
</tr>
</tbody>
</table>
<h3 id="pro-tips-for-legacy-code-testing">Pro Tips for Legacy Code Testing</h3>
<p><strong>1. Start with the happy path</strong>:</p>
<p>Don't try to test every edge case immediately. Get one end-to-end test working first, then expand coverage.</p>
<p><strong>2. Use pytest's monkeypatch for temporary seams</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_with_temporary_seam</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use monkeypatch to inject test behavior without modifying code.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">OrderProcessor</span><span class="p">()</span>

    <span class="c1"># Temporarily replace a method</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mock_calculate_discount</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">order_data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.8&#39;</span><span class="p">)</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="s1">&#39;_calculate_discount&#39;</span><span class="p">,</span> <span class="n">mock_calculate_discount</span><span class="p">)</span>

    <span class="c1"># Test proceeds with mocked behavior</span>
</code></pre></div>

<p><strong>3. Document what you're NOT testing</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_basic_flow</span><span class="p">(</span><span class="n">mock_database</span><span class="p">,</span> <span class="n">mock_payment</span><span class="p">,</span> <span class="n">mock_email</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test basic order processing flow.</span>

<span class="sd">    NOT TESTED (yet):</span>
<span class="sd">    - Invalid payment tokens</span>
<span class="sd">    - Database connection failures</span>
<span class="sd">    - Email delivery failures</span>
<span class="sd">    - Inventory edge cases (negative quantities, etc.)</span>
<span class="sd">    - Tax calculation for international orders</span>

<span class="sd">    These will be added as we refactor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div>

<p><strong>4. Use coverage to find untested paths</strong>:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_order_processor_characterization.py<span class="w"> </span>--cov<span class="o">=</span>src.legacy_order_system<span class="w"> </span>--cov-report<span class="o">=</span>html
</code></pre></div>

<p>Open <code>htmlcov/index.html</code> to see which lines aren't covered. Prioritize testing the most critical paths first.</p>
<p><strong>5. Refactor incrementally with test coverage</strong>:</p>
<p>Once you have characterization tests:
1. Extract one small piece of logic
2. Write focused tests for it
3. Replace the original code with a call to the extracted function
4. Verify characterization tests still pass
5. Repeat</p>
<p>This is the "Strangler Fig" pattern‚Äîgradually replace legacy code while maintaining functionality.</p>
<h2 id="incremental-testing-for-large-projects">Incremental Testing for Large Projects</h2>
<h2 id="the-large-codebase-problem">The Large Codebase Problem</h2>
<p>Your company has a monolithic application with 500,000 lines of code and 2,000 test files. Running the full test suite takes 45 minutes. You're working on a small feature in the authentication module. How do you get fast feedback without waiting for the entire suite?</p>
<p><strong>The naive approach</strong> (doesn't scale):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run everything every time</span>
$<span class="w"> </span>pytest<span class="w"> </span>tests/
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== 12,847 passed in 2734.23s (45 minutes) ========================
</code></pre></div>

<p>This is untenable for rapid development. You need incremental testing strategies.</p>
<h3 id="iteration-1-test-impact-analysis">Iteration 1: Test Impact Analysis</h3>
<p>Only run tests affected by your changes. First, understand the dependency graph:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tools/test_impact_analyzer.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DependencyAnalyzer</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyze Python files to extract import dependencies.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imports</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imports</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">alias</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_ImportFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">module</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imports</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_dependencies</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract all imports from a Python file.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">file_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
        <span class="n">analyzer</span> <span class="o">=</span> <span class="n">DependencyAnalyzer</span><span class="p">()</span>
        <span class="n">analyzer</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">imports</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">build_dependency_graph</span><span class="p">(</span><span class="n">src_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a graph of which modules depend on which.&quot;&quot;&quot;</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">py_file</span> <span class="ow">in</span> <span class="n">src_dir</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s1">&#39;*.py&#39;</span><span class="p">):</span>
        <span class="n">module_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">py_file</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">src_dir</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">graph</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dependencies</span><span class="p">(</span><span class="n">py_file</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">graph</span>

<span class="k">def</span><span class="w"> </span><span class="nf">find_affected_tests</span><span class="p">(</span><span class="n">changed_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">src_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">test_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find all tests that might be affected by changes to given files.</span>

<span class="sd">    Strategy:</span>
<span class="sd">    1. Build dependency graph</span>
<span class="sd">    2. Find all modules that import changed modules (direct dependencies)</span>
<span class="sd">    3. Find all modules that import those modules (transitive dependencies)</span>
<span class="sd">    4. Find test files that test any affected modules</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">build_dependency_graph</span><span class="p">(</span><span class="n">src_dir</span><span class="p">)</span>

    <span class="c1"># Convert changed files to module names</span>
    <span class="n">changed_modules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">changed_files</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;src/&#39;</span><span class="p">):</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;src/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">changed_modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>

    <span class="c1"># Find all modules affected by changes (transitive closure)</span>
    <span class="n">affected</span> <span class="o">=</span> <span class="n">changed_modules</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="n">changed</span><span class="p">:</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">module</span><span class="p">,</span> <span class="n">deps</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">module</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">affected</span> <span class="ow">and</span> <span class="n">affected</span> <span class="o">&amp;</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">affected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
                <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Find test files for affected modules</span>
    <span class="n">affected_tests</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">test_file</span> <span class="ow">in</span> <span class="n">test_dir</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s1">&#39;test_*.py&#39;</span><span class="p">):</span>
        <span class="n">test_deps</span> <span class="o">=</span> <span class="n">get_dependencies</span><span class="p">(</span><span class="n">test_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">affected</span> <span class="o">&amp;</span> <span class="n">test_deps</span><span class="p">:</span>
            <span class="n">affected_tests</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">test_file</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">affected_tests</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Get changed files from git</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="p">[</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;diff&#39;</span><span class="p">,</span> <span class="s1">&#39;--name-only&#39;</span><span class="p">,</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">],</span>
        <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">changed_files</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">affected_tests</span> <span class="o">=</span> <span class="n">find_affected_tests</span><span class="p">(</span>
        <span class="n">changed_files</span><span class="p">,</span>
        <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">),</span>
        <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;tests&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Changed files: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">changed_files</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Affected tests: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">affected_tests</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Run these tests:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">affected_tests</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">test</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Use the analyzer:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>python<span class="w"> </span>tools/test_impact_analyzer.py
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>Changed files: 3
Affected tests: 47

Run these tests:
  tests/test_auth.py
  tests/test_user_management.py
  tests/test_session_handling.py
  ...
</code></pre></div>

<p>Now run only affected tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span><span class="k">$(</span>python<span class="w"> </span>tools/test_impact_analyzer.py<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;tests/&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="k">)</span>
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== 47 passed in 12.34s ========================
</code></pre></div>

<p><strong>Result</strong>: 45 minutes ‚Üí 12 seconds (220x speedup)</p>
<h3 id="iteration-2-layered-testing-strategy">Iteration 2: Layered Testing Strategy</h3>
<p>Organize tests by speed and scope:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pytest_configure</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">addinivalue_line</span><span class="p">(</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span> <span class="s2">&quot;unit: fast unit tests (&lt; 0.1s each)&quot;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">addinivalue_line</span><span class="p">(</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span> <span class="s2">&quot;integration: integration tests (&lt; 1s each)&quot;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">addinivalue_line</span><span class="p">(</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span> <span class="s2">&quot;e2e: end-to-end tests (&lt; 10s each)&quot;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">addinivalue_line</span><span class="p">(</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span> <span class="s2">&quot;slow: slow tests (&gt; 10s each)&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Mark your tests:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_auth.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">unit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_password_hashing</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fast unit test.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">integration</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_login_with_database</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Integration test with database.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">e2e</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_full_authentication_flow</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;End-to-end test through web interface.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">slow</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_password_reset_email_delivery</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Slow test that sends real email.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div>

<p>Create a testing pyramid:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Level 1: Unit tests (run constantly during development)</span>
$<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span>unit

<span class="c1"># Level 2: Integration tests (run before commit)</span>
$<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;unit or integration&quot;</span>

<span class="c1"># Level 3: E2E tests (run in CI before merge)</span>
$<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;unit or integration or e2e&quot;</span>

<span class="c1"># Level 4: Full suite (run nightly)</span>
$<span class="w"> </span>pytest
</code></pre></div>

<p><strong>Typical results</strong>:</p>
<table>
<thead>
<tr>
<th>Level</th>
<th>Tests</th>
<th>Time</th>
<th>When to Run</th>
</tr>
</thead>
<tbody>
<tr>
<td>Unit</td>
<td>8,000</td>
<td>2 min</td>
<td>Every save (with pytest-watch)</td>
</tr>
<tr>
<td>Integration</td>
<td>3,500</td>
<td>8 min</td>
<td>Before commit</td>
</tr>
<tr>
<td>E2E</td>
<td>1,200</td>
<td>25 min</td>
<td>Before merge (CI)</td>
</tr>
<tr>
<td>Full</td>
<td>12,847</td>
<td>45 min</td>
<td>Nightly (CI)</td>
</tr>
</tbody>
</table>
<h3 id="iteration-3-parallel-test-execution-with-smart-scheduling">Iteration 3: Parallel Test Execution with Smart Scheduling</h3>
<p>Use pytest-xdist with custom scheduling to optimize parallel execution:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pytest_collection_modifyitems</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reorder tests for optimal parallel execution.</span>

<span class="sd">    Strategy:</span>
<span class="sd">    1. Run fast tests first (quick feedback)</span>
<span class="sd">    2. Distribute slow tests evenly across workers</span>
<span class="sd">    3. Group tests by fixture scope (reduce setup/teardown)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Separate tests by speed</span>
    <span class="n">fast_tests</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">medium_tests</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">slow_tests</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="c1"># Estimate test duration from markers or historical data</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">get_closest_marker</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">):</span>
            <span class="n">fast_tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">get_closest_marker</span><span class="p">(</span><span class="s1">&#39;integration&#39;</span><span class="p">):</span>
            <span class="n">medium_tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">slow_tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="c1"># Reorder: fast first, then interleave medium and slow</span>
    <span class="n">items</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">fast_tests</span> <span class="o">+</span> <span class="n">medium_tests</span> <span class="o">+</span> <span class="n">slow_tests</span>
</code></pre></div>

<p>Run with optimal parallelization:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Use all CPU cores, with smart scheduling</span>
$<span class="w"> </span>pytest<span class="w"> </span>-n<span class="w"> </span>auto<span class="w"> </span>--dist<span class="w"> </span>loadscope
</code></pre></div>

<p><strong>Result</strong>: 45 minutes ‚Üí 13 minutes (3.5x speedup on 4-core machine)</p>
<h3 id="iteration-4-test-sharding-for-ci">Iteration 4: Test Sharding for CI</h3>
<p>In CI, run tests across multiple machines:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .github/workflows/test.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Test Suite</span>

<span class="nt">on</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">push</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">pull_request</span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">test</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">strategy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">matrix</span><span class="p">:</span>
<span class="w">        </span><span class="nt">shard</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">4</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">6</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">7</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">8</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set up Python</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-python@v2</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.11</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pip install -r requirements.txt</span>
<span class="w">          </span><span class="no">pip install pytest pytest-xdist pytest-split</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests (shard ${{ matrix.shard }}/8)</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pytest --splits 8 --group ${{ matrix.shard }} --durations-path .test-durations</span>
</code></pre></div>

<p><strong>Result</strong>: 45 minutes ‚Üí 6 minutes (8 machines running in parallel)</p>
<h3 id="iteration-5-caching-test-results">Iteration 5: Caching Test Results</h3>
<p>Cache test results to skip tests that haven't changed:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pytest_collection_modifyitems</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Skip tests whose code and dependencies haven&#39;t changed.&quot;&quot;&quot;</span>
    <span class="n">cache_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;.pytest_cache/test_hashes.json&#39;</span><span class="p">)</span>

    <span class="c1"># Load previous hashes</span>
    <span class="k">if</span> <span class="n">cache_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">previous_hashes</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cache_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">previous_hashes</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">current_hashes</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="c1"># Compute hash of test code + dependencies</span>
        <span class="n">test_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">fspath</span><span class="p">)</span>
        <span class="n">test_code</span> <span class="o">=</span> <span class="n">test_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>

        <span class="c1"># Include imported modules in hash</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="n">get_dependencies</span><span class="p">(</span><span class="n">test_file</span><span class="p">)</span>
        <span class="n">dep_code</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">Path</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span> 
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">dependencies</span> 
            <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">combined</span> <span class="o">=</span> <span class="n">test_code</span> <span class="o">+</span> <span class="n">dep_code</span>
        <span class="n">test_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">combined</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

        <span class="n">current_hashes</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">nodeid</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_hash</span>

        <span class="c1"># Skip if unchanged and previously passed</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">nodeid</span> <span class="ow">in</span> <span class="n">previous_hashes</span> <span class="ow">and</span> 
            <span class="n">previous_hashes</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">nodeid</span><span class="p">]</span> <span class="o">==</span> <span class="n">test_hash</span><span class="p">):</span>
            <span class="n">item</span><span class="o">.</span><span class="n">add_marker</span><span class="p">(</span><span class="n">pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">reason</span><span class="o">=</span><span class="s2">&quot;unchanged since last run&quot;</span><span class="p">))</span>

    <span class="c1"># Save current hashes</span>
    <span class="n">cache_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cache_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">current_hashes</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</code></pre></div>

<p><strong>First run</strong> (no cache):</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== 12,847 passed in 2734.23s ========================
</code></pre></div>

<p><strong>Second run</strong> (with cache, no changes):</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== 12,847 skipped in 23.45s ========================
</code></pre></div>

<p><strong>After making changes</strong> (only affected tests run):</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== 47 passed, 12,800 skipped in 34.56s ========================
</code></pre></div>

<h3 id="iteration-6-focused-test-suites">Iteration 6: Focused Test Suites</h3>
<p>Create focused test suites for common workflows:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># pytest.ini</span>
<span class="k">[pytest]</span>
<span class="na">markers</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="na">smoke</span><span class="o">:</span><span class="w"> </span><span class="s">critical path tests (must pass before any commit)</span>
<span class="w">    </span><span class="na">auth</span><span class="o">:</span><span class="w"> </span><span class="s">authentication and authorization tests</span>
<span class="w">    </span><span class="na">payment</span><span class="o">:</span><span class="w"> </span><span class="s">payment processing tests</span>
<span class="w">    </span><span class="na">api</span><span class="o">:</span><span class="w"> </span><span class="s">API endpoint tests</span>
<span class="w">    </span><span class="na">ui</span><span class="o">:</span><span class="w"> </span><span class="s">user interface tests</span>

<span class="c1"># Define test suites</span>
<span class="k">[pytest:smoke]</span>
<span class="na">testpaths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">tests/smoke</span>
<span class="na">markers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">smoke</span>

<span class="k">[pytest:auth]</span>
<span class="na">testpaths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">tests/auth tests/user_management</span>
<span class="na">markers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">auth</span>

<span class="k">[pytest:payment]</span>
<span class="na">testpaths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">tests/payment tests/billing</span>
<span class="na">markers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">payment</span>
</code></pre></div>

<p>Run focused suites:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Smoke test (2 minutes)</span>
$<span class="w"> </span>pytest<span class="w"> </span>-c<span class="w"> </span>pytest.ini::smoke

<span class="c1"># Auth suite (5 minutes)</span>
$<span class="w"> </span>pytest<span class="w"> </span>-c<span class="w"> </span>pytest.ini::auth

<span class="c1"># Payment suite (8 minutes)</span>
$<span class="w"> </span>pytest<span class="w"> </span>-c<span class="w"> </span>pytest.ini::payment
</code></pre></div>

<h3 id="decision-framework-which-strategy-when">Decision Framework: Which Strategy When?</h3>
<table>
<thead>
<tr>
<th>Scenario</th>
<th>Strategy</th>
<th>Speedup</th>
<th>Complexity</th>
</tr>
</thead>
<tbody>
<tr>
<td>Local development</td>
<td>Test impact analysis</td>
<td>100-1000x</td>
<td>Medium</td>
</tr>
<tr>
<td>Pre-commit</td>
<td>Layered testing (unit + integration)</td>
<td>5-10x</td>
<td>Low</td>
</tr>
<tr>
<td>CI pull request</td>
<td>Parallel execution + sharding</td>
<td>4-8x</td>
<td>Medium</td>
</tr>
<tr>
<td>Nightly CI</td>
<td>Full suite with caching</td>
<td>2-3x</td>
<td>Low</td>
</tr>
<tr>
<td>Debugging</td>
<td>Single test with --lf</td>
<td>‚àû</td>
<td>Low</td>
</tr>
</tbody>
</table>
<h3 id="pro-tips-for-large-codebases">Pro Tips for Large Codebases</h3>
<p><strong>1. Measure test duration and optimize slowest tests</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Find slowest tests</span>
$<span class="w"> </span>pytest<span class="w"> </span>--durations<span class="o">=</span><span class="m">20</span>
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== slowest 20 durations ========================
45.23s call     tests/test_payment.py::test_full_payment_flow
32.11s call     tests/test_email.py::test_send_bulk_emails
28.45s call     tests/test_report.py::test_generate_annual_report
...
</code></pre></div>

<p>Focus optimization efforts on these tests first.</p>
<p><strong>2. Use pytest-timeout to prevent hanging tests</strong>:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pytest-timeout
$<span class="w"> </span>pytest<span class="w"> </span>--timeout<span class="o">=</span><span class="m">10</span><span class="w">  </span><span class="c1"># Fail any test that takes &gt; 10 seconds</span>
</code></pre></div>

<p><strong>3. Create a "quick check" command</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Add to Makefile or package.json scripts</span>
quick-test:
<span class="w">    </span>pytest<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;unit and not slow&quot;</span><span class="w"> </span>-x<span class="w"> </span>--ff
</code></pre></div>

<p><strong>4. Use pytest-monitor to track test performance over time</strong>:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pytest-monitor
$<span class="w"> </span>pytest<span class="w"> </span>--monitor<span class="w">  </span><span class="c1"># Stores metrics in SQLite database</span>
</code></pre></div>

<p>Then analyze trends:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tools/analyze_test_performance.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;.pymon&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    SELECT </span>
<span class="s2">        item_path,</span>
<span class="s2">        AVG(item_total_time) as avg_time,</span>
<span class="s2">        COUNT(*) as run_count</span>
<span class="s2">    FROM TEST_METRICS</span>
<span class="s2">    GROUP BY item_path</span>
<span class="s2">    ORDER BY avg_time DESC</span>
<span class="s2">    LIMIT 20</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tests getting slower over time:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div>

<p><strong>5. Document your testing strategy</strong>:</p>
<h2 id="contract-testing-for-microservices">Contract Testing for Microservices</h2>
<h2 id="the-microservices-testing-problem">The Microservices Testing Problem</h2>
<p>Your application is split into microservices:
- <strong>User Service</strong>: Manages user accounts
- <strong>Order Service</strong>: Processes orders
- <strong>Payment Service</strong>: Handles payments
- <strong>Notification Service</strong>: Sends emails/SMS</p>
<p>Each service has its own test suite, but integration failures still occur in production. The problem: services evolve independently, and their contracts (APIs) drift.</p>
<p><strong>Example failure scenario</strong>:</p>
<p>Order Service expects Payment Service to return:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;transaction_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;txn_123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;completed&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">99.99</span>
<span class="p">}</span>
</code></pre></div>

<p>But Payment Service was updated to return:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;txn_123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;state&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;success&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;total&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">99.99</span>
<span class="p">}</span>
</code></pre></div>

<p>Field names changed. Order Service breaks in production. How do you catch this before deployment?</p>
<h3 id="iteration-1-consumer-driven-contract-testing">Iteration 1: Consumer-Driven Contract Testing</h3>
<p>The consumer (Order Service) defines what it expects from the provider (Payment Service):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># order_service/tests/contracts/test_payment_service_contract.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pact</span><span class="w"> </span><span class="kn">import</span> <span class="n">Consumer</span><span class="p">,</span> <span class="n">Provider</span><span class="p">,</span> <span class="n">Like</span><span class="p">,</span> <span class="n">EachLike</span>

<span class="c1"># Define the contract</span>
<span class="n">pact</span> <span class="o">=</span> <span class="n">Consumer</span><span class="p">(</span><span class="s1">&#39;OrderService&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">has_pact_with</span><span class="p">(</span><span class="n">Provider</span><span class="p">(</span><span class="s1">&#39;PaymentService&#39;</span><span class="p">))</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;module&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">payment_service_contract</span><span class="p">():</span>
    <span class="n">pact</span><span class="o">.</span><span class="n">start_service</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">pact</span>
    <span class="n">pact</span><span class="o">.</span><span class="n">stop_service</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_contract</span><span class="p">(</span><span class="n">payment_service_contract</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Contract: Order Service expects Payment Service to process payments.</span>

<span class="sd">    This test defines what Order Service needs from Payment Service.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expected_response</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;transaction_id&#39;</span><span class="p">:</span> <span class="n">Like</span><span class="p">(</span><span class="s1">&#39;txn_123&#39;</span><span class="p">),</span>  <span class="c1"># String, any value</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">Like</span><span class="p">(</span><span class="s1">&#39;completed&#39;</span><span class="p">),</span>         <span class="c1"># String, any value</span>
        <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">Like</span><span class="p">(</span><span class="mf">99.99</span><span class="p">)</span>                <span class="c1"># Number, any value</span>
    <span class="p">}</span>

    <span class="p">(</span><span class="n">pact</span>
     <span class="o">.</span><span class="n">given</span><span class="p">(</span><span class="s1">&#39;a valid payment request&#39;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">upon_receiving</span><span class="p">(</span><span class="s1">&#39;a request to process payment&#39;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">with_request</span><span class="p">(</span>
         <span class="n">method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
         <span class="n">path</span><span class="o">=</span><span class="s1">&#39;/api/v1/payments&#39;</span><span class="p">,</span>
         <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">},</span>
         <span class="n">body</span><span class="o">=</span><span class="p">{</span>
             <span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="n">Like</span><span class="p">(</span><span class="s1">&#39;ord_123&#39;</span><span class="p">),</span>
             <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">Like</span><span class="p">(</span><span class="mf">99.99</span><span class="p">),</span>
             <span class="s1">&#39;payment_method&#39;</span><span class="p">:</span> <span class="n">Like</span><span class="p">(</span><span class="s1">&#39;credit_card&#39;</span><span class="p">)</span>
         <span class="p">}</span>
     <span class="p">)</span>
     <span class="o">.</span><span class="n">will_respond_with</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">expected_response</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">pact</span><span class="p">:</span>
        <span class="c1"># Make actual request to mock Payment Service</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pact</span><span class="o">.</span><span class="n">uri</span><span class="si">}</span><span class="s1">/api/v1/payments&#39;</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="s1">&#39;ord_456&#39;</span><span class="p">,</span>
                <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="mf">149.99</span><span class="p">,</span>
                <span class="s1">&#39;payment_method&#39;</span><span class="p">:</span> <span class="s1">&#39;credit_card&#39;</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s1">&#39;transaction_id&#39;</span> <span class="ow">in</span> <span class="n">data</span>
        <span class="k">assert</span> <span class="s1">&#39;status&#39;</span> <span class="ow">in</span> <span class="n">data</span>
        <span class="k">assert</span> <span class="s1">&#39;amount&#39;</span> <span class="ow">in</span> <span class="n">data</span>
</code></pre></div>

<p>Run the contract test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>order_service/tests/contracts/test_payment_service_contract.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>order_service/tests/contracts/test_payment_service_contract.py::test_process_payment_contract PASSED

Pact file written to: pacts/orderservice-paymentservice.json
</code></pre></div>

<p>This generates a contract file:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;consumer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OrderService&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;provider&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;PaymentService&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;interactions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a request to process payment&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;providerState&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a valid payment request&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;request&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/api/v1/payments&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;headers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;Content-Type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;application/json&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;body&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;order_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ord_123&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">99.99</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;payment_method&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;credit_card&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;response&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;body&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;transaction_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;txn_123&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;completed&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">99.99</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="iteration-2-provider-verification">Iteration 2: Provider Verification</h3>
<p>Payment Service must verify it satisfies the contract:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_service/tests/contracts/test_contract_verification.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pact</span><span class="w"> </span><span class="kn">import</span> <span class="n">Verifier</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_service_honors_contracts</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify that Payment Service satisfies all consumer contracts.</span>

<span class="sd">    This test runs against the actual Payment Service implementation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">verifier</span> <span class="o">=</span> <span class="n">Verifier</span><span class="p">(</span>
        <span class="n">provider</span><span class="o">=</span><span class="s1">&#39;PaymentService&#39;</span><span class="p">,</span>
        <span class="n">provider_base_url</span><span class="o">=</span><span class="s1">&#39;http://localhost:8001&#39;</span>  <span class="c1"># Payment Service URL</span>
    <span class="p">)</span>

    <span class="c1"># Verify against all consumer contracts</span>
    <span class="n">output</span><span class="p">,</span> <span class="n">logs</span> <span class="o">=</span> <span class="n">verifier</span><span class="o">.</span><span class="n">verify_pacts</span><span class="p">(</span>
        <span class="s1">&#39;./pacts/orderservice-paymentservice.json&#39;</span><span class="p">,</span>
        <span class="n">provider_states_setup_url</span><span class="o">=</span><span class="s1">&#39;http://localhost:8001/_pact/provider_states&#39;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">output</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Contract verification failed:</span><span class="se">\n</span><span class="si">{</span><span class="n">logs</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>

<p><strong>If Payment Service changes its response format</strong>, the verification fails:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>payment_service/tests/contracts/test_contract_verification.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>payment_service/tests/contracts/test_contract_verification.py::test_payment_service_honors_contracts FAILED

E   AssertionError: Contract verification failed:
E   
E   Verifying a pact between OrderService and PaymentService
E     a request to process payment
E       with POST /api/v1/payments
E         returns a response which
E           has status code 200 (FAILED)
E           has a matching body (FAILED)
E   
E   Failures:
E   
E   1) Verifying a pact between OrderService and PaymentService - a request to process payment
E      1.1) has a matching body
E           Expected field &#39;transaction_id&#39; but got &#39;id&#39;
E           Expected field &#39;status&#39; but got &#39;state&#39;
E           Expected field &#39;amount&#39; but got &#39;total&#39;
</code></pre></div>

<p><strong>Root cause identified</strong>: Payment Service changed its response format without updating the contract. This would have caused production failures, but we caught it in testing.</p>
<h3 id="iteration-3-contract-testing-workflow">Iteration 3: Contract Testing Workflow</h3>
<p><strong>Step 1: Consumer defines contract</strong> (Order Service):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># order_service/tests/contracts/test_payment_service_contract.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_contract</span><span class="p">(</span><span class="n">payment_service_contract</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define what Order Service needs from Payment Service.&quot;&quot;&quot;</span>
    <span class="c1"># ... (contract definition from Iteration 1)</span>
</code></pre></div>

<p><strong>Step 2: Consumer publishes contract</strong> to a Pact Broker (central repository):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># In Order Service CI pipeline</span>
$<span class="w"> </span>pact-broker<span class="w"> </span>publish<span class="w"> </span>pacts/<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--consumer-app-version<span class="o">=</span><span class="nv">$GIT_COMMIT</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--broker-base-url<span class="o">=</span>https://pact-broker.company.com<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--broker-token<span class="o">=</span><span class="nv">$PACT_BROKER_TOKEN</span>
</code></pre></div>

<p><strong>Step 3: Provider verifies contract</strong> (Payment Service):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_service/tests/contracts/test_contract_verification.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_service_honors_contracts</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify Payment Service satisfies all consumer contracts.&quot;&quot;&quot;</span>
    <span class="n">verifier</span> <span class="o">=</span> <span class="n">Verifier</span><span class="p">(</span>
        <span class="n">provider</span><span class="o">=</span><span class="s1">&#39;PaymentService&#39;</span><span class="p">,</span>
        <span class="n">provider_base_url</span><span class="o">=</span><span class="s1">&#39;http://localhost:8001&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Fetch contracts from Pact Broker</span>
    <span class="n">output</span><span class="p">,</span> <span class="n">logs</span> <span class="o">=</span> <span class="n">verifier</span><span class="o">.</span><span class="n">verify_with_broker</span><span class="p">(</span>
        <span class="n">broker_url</span><span class="o">=</span><span class="s1">&#39;https://pact-broker.company.com&#39;</span><span class="p">,</span>
        <span class="n">broker_token</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PACT_BROKER_TOKEN&#39;</span><span class="p">],</span>
        <span class="n">provider_version</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;GIT_COMMIT&#39;</span><span class="p">],</span>
        <span class="n">publish_verification_results</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">output</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Contract verification failed:</span><span class="se">\n</span><span class="si">{</span><span class="n">logs</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>

<p><strong>Step 4: Can-I-Deploy check</strong> before deployment:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># In Payment Service CI pipeline, before deploying</span>
$<span class="w"> </span>pact-broker<span class="w"> </span>can-i-deploy<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--pacticipant<span class="w"> </span>PaymentService<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--version<span class="w"> </span><span class="nv">$GIT_COMMIT</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--to<span class="w"> </span>production<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--broker-base-url<span class="w"> </span>https://pact-broker.company.com<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--broker-token<span class="w"> </span><span class="nv">$PACT_BROKER_TOKEN</span>
</code></pre></div>

<p><strong>Output if contracts are satisfied</strong>:</p>
<div class="codehilite"><pre><span></span><code>Computer says yes \o/

PaymentService version abc123 can be deployed to production
All required contracts are verified
</code></pre></div>

<p><strong>Output if contracts are broken</strong>:</p>
<div class="codehilite"><pre><span></span><code>Computer says no ¬Ø\_(„ÉÑ)_/¬Ø

PaymentService version abc123 cannot be deployed to production

Reason: OrderService requires PaymentService to satisfy contract version xyz789
        but verification failed

Details: https://pact-broker.company.com/pacts/...
</code></pre></div>

<h3 id="iteration-4-handling-contract-evolution">Iteration 4: Handling Contract Evolution</h3>
<p>Contracts need to evolve. Use versioning and backward compatibility:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_service/tests/contracts/test_contract_verification.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_service_honors_contracts_v1</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify Payment Service satisfies v1 contracts (legacy).&quot;&quot;&quot;</span>
    <span class="n">verifier</span> <span class="o">=</span> <span class="n">Verifier</span><span class="p">(</span>
        <span class="n">provider</span><span class="o">=</span><span class="s1">&#39;PaymentService&#39;</span><span class="p">,</span>
        <span class="n">provider_base_url</span><span class="o">=</span><span class="s1">&#39;http://localhost:8001&#39;</span>
    <span class="p">)</span>

    <span class="n">output</span><span class="p">,</span> <span class="n">logs</span> <span class="o">=</span> <span class="n">verifier</span><span class="o">.</span><span class="n">verify_with_broker</span><span class="p">(</span>
        <span class="n">broker_url</span><span class="o">=</span><span class="s1">&#39;https://pact-broker.company.com&#39;</span><span class="p">,</span>
        <span class="n">broker_token</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PACT_BROKER_TOKEN&#39;</span><span class="p">],</span>
        <span class="n">provider_version</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;GIT_COMMIT&#39;</span><span class="p">],</span>
        <span class="n">consumer_version_selectors</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;v1&#39;</span><span class="p">,</span> <span class="s1">&#39;latest&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>  <span class="c1"># Only verify v1 contracts</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">output</span> <span class="o">==</span> <span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_service_honors_contracts_v2</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify Payment Service satisfies v2 contracts (current).&quot;&quot;&quot;</span>
    <span class="n">verifier</span> <span class="o">=</span> <span class="n">Verifier</span><span class="p">(</span>
        <span class="n">provider</span><span class="o">=</span><span class="s1">&#39;PaymentService&#39;</span><span class="p">,</span>
        <span class="n">provider_base_url</span><span class="o">=</span><span class="s1">&#39;http://localhost:8001&#39;</span>
    <span class="p">)</span>

    <span class="n">output</span><span class="p">,</span> <span class="n">logs</span> <span class="o">=</span> <span class="n">verifier</span><span class="o">.</span><span class="n">verify_with_broker</span><span class="p">(</span>
        <span class="n">broker_url</span><span class="o">=</span><span class="s1">&#39;https://pact-broker.company.com&#39;</span><span class="p">,</span>
        <span class="n">broker_token</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PACT_BROKER_TOKEN&#39;</span><span class="p">],</span>
        <span class="n">provider_version</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;GIT_COMMIT&#39;</span><span class="p">],</span>
        <span class="n">consumer_version_selectors</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;v2&#39;</span><span class="p">,</span> <span class="s1">&#39;latest&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>  <span class="c1"># Only verify v2 contracts</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">output</span> <span class="o">==</span> <span class="mi">0</span>
</code></pre></div>

<p><strong>Migration strategy</strong>:</p>
<ol>
<li>Payment Service supports both v1 and v2 response formats</li>
<li>Consumers gradually migrate from v1 to v2</li>
<li>Once all consumers are on v2, remove v1 support</li>
<li>Contract tests ensure no consumer is left behind</li>
</ol>
<h3 id="iteration-5-testing-multiple-consumers">Iteration 5: Testing Multiple Consumers</h3>
<p>Payment Service has multiple consumers. Test all contracts:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_service/tests/contracts/test_all_consumer_contracts.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pact</span><span class="w"> </span><span class="kn">import</span> <span class="n">Verifier</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;consumer&#39;</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">&#39;OrderService&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SubscriptionService&#39;</span><span class="p">,</span>
    <span class="s1">&#39;RefundService&#39;</span><span class="p">,</span>
    <span class="s1">&#39;AdminDashboard&#39;</span>
<span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_service_honors_consumer_contract</span><span class="p">(</span><span class="n">consumer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify Payment Service satisfies contract with each consumer.&quot;&quot;&quot;</span>
    <span class="n">verifier</span> <span class="o">=</span> <span class="n">Verifier</span><span class="p">(</span>
        <span class="n">provider</span><span class="o">=</span><span class="s1">&#39;PaymentService&#39;</span><span class="p">,</span>
        <span class="n">provider_base_url</span><span class="o">=</span><span class="s1">&#39;http://localhost:8001&#39;</span>
    <span class="p">)</span>

    <span class="n">output</span><span class="p">,</span> <span class="n">logs</span> <span class="o">=</span> <span class="n">verifier</span><span class="o">.</span><span class="n">verify_with_broker</span><span class="p">(</span>
        <span class="n">broker_url</span><span class="o">=</span><span class="s1">&#39;https://pact-broker.company.com&#39;</span><span class="p">,</span>
        <span class="n">broker_token</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PACT_BROKER_TOKEN&#39;</span><span class="p">],</span>
        <span class="n">provider_version</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;GIT_COMMIT&#39;</span><span class="p">],</span>
        <span class="n">consumer_version_selectors</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;consumer&#39;</span><span class="p">:</span> <span class="n">consumer</span><span class="p">,</span> <span class="s1">&#39;latest&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">output</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Contract with </span><span class="si">{</span><span class="n">consumer</span><span class="si">}</span><span class="s2"> failed:</span><span class="se">\n</span><span class="si">{</span><span class="n">logs</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>

<p>Run all consumer contract tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>payment_service/tests/contracts/test_all_consumer_contracts.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_all_consumer_contracts.py::test_payment_service_honors_consumer_contract[OrderService] PASSED
test_all_consumer_contracts.py::test_payment_service_honors_consumer_contract[SubscriptionService] PASSED
test_all_consumer_contracts.py::test_payment_service_honors_consumer_contract[RefundService] FAILED
test_all_consumer_contracts.py::test_payment_service_honors_consumer_contract[AdminDashboard] PASSED

E   AssertionError: Contract with RefundService failed:
E   Expected field &#39;refund_id&#39; but got &#39;transaction_id&#39;
</code></pre></div>

<p><strong>Diagnostic</strong>: RefundService expects a different response format. We need to either:
1. Update Payment Service to support RefundService's expectations
2. Update RefundService to match Payment Service's format
3. Version the API to support both</p>
<h3 id="when-to-use-contract-testing">When to Use Contract Testing</h3>
<p><strong>Optimal scenarios</strong>:
- Microservices architecture with multiple teams
- Services deployed independently
- API contracts that evolve over time
- Need to prevent integration failures in production</p>
<p><strong>When to avoid</strong>:
- Monolithic applications (use integration tests instead)
- Services that are always deployed together
- Rapidly changing APIs in early development (contracts add overhead)
- Internal services with a single consumer (direct integration tests are simpler)</p>
<h3 id="pro-tips-for-contract-testing">Pro Tips for Contract Testing</h3>
<p><strong>1. Start with critical paths</strong>:</p>
<p>Don't contract-test every endpoint. Focus on:
- Payment processing
- Authentication
- Data synchronization
- Critical business workflows</p>
<p><strong>2. Use provider states for setup</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_service/app.py</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/_pact/provider_states&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">provider_states</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Setup provider state for contract testing.&quot;&quot;&quot;</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;a valid payment request&#39;</span><span class="p">:</span>
        <span class="c1"># Setup: Ensure test data exists</span>
        <span class="n">setup_test_payment_data</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;insufficient funds&#39;</span><span class="p">:</span>
        <span class="c1"># Setup: Configure account with low balance</span>
        <span class="n">setup_insufficient_funds_scenario</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">})</span>
</code></pre></div>

<p><strong>3. Use contract testing alongside integration tests</strong>:</p>
<p>Contract tests verify the interface. Integration tests verify the behavior:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># order_service/tests/integration/test_payment_integration.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_full_payment_flow_integration</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integration test: Verify complete payment flow.</span>

<span class="sd">    This complements contract tests by testing actual behavior,</span>
<span class="sd">    not just the interface.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create order</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">create_test_order</span><span class="p">()</span>

    <span class="c1"># Process payment (calls real Payment Service in test environment)</span>
    <span class="n">payment_result</span> <span class="o">=</span> <span class="n">payment_client</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">order_id</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">total</span><span class="p">,</span>
        <span class="n">payment_method</span><span class="o">=</span><span class="s1">&#39;credit_card&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Verify payment was recorded</span>
    <span class="k">assert</span> <span class="n">payment_result</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;completed&#39;</span>

    <span class="c1"># Verify order was updated</span>
    <span class="n">updated_order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">updated_order</span><span class="o">.</span><span class="n">payment_status</span> <span class="o">==</span> <span class="s1">&#39;paid&#39;</span>
</code></pre></div>

<p><strong>4. Automate contract publishing in CI</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .github/workflows/contracts.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Publish Contracts</span>

<span class="nt">on</span><span class="p">:</span>
<span class="w">  </span><span class="nt">push</span><span class="p">:</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">publish-contracts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run contract tests</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pytest tests/contracts/ -v</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Publish contracts to broker</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pact-broker publish pacts/ \</span>
<span class="w">            </span><span class="no">--consumer-app-version=${{ github.sha }} \</span>
<span class="w">            </span><span class="no">--branch=${{ github.ref_name }} \</span>
<span class="w">            </span><span class="no">--broker-base-url=${{ secrets.PACT_BROKER_URL }} \</span>
<span class="w">            </span><span class="no">--broker-token=${{ secrets.PACT_BROKER_TOKEN }}</span>
</code></pre></div>

<p><strong>5. Document your contracts</strong>:</p>
<p>Pact Broker provides a web UI showing all contracts and their verification status. Use it as living documentation for your microservices architecture.</p>
<h2 id="property-based-testing-with-hypothesis">Property-Based Testing with Hypothesis</h2>
<h2 id="the-example-based-testing-limitation">The Example-Based Testing Limitation</h2>
<p>Traditional tests use specific examples:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_string_utils.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_reverse_string</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;olleh&quot;</span>
    <span class="k">assert</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;world&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;dlrow&quot;</span>
    <span class="k">assert</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
</code></pre></div>

<p>This works, but what about:
- Unicode characters?
- Very long strings?
- Strings with special characters?
- Edge cases you didn't think of?</p>
<p>You can't test every possible input. But you can test <strong>properties</strong> that should hold for all inputs.</p>
<h3 id="iteration-1-introduction-to-property-based-testing">Iteration 1: Introduction to Property-Based Testing</h3>
<p>Instead of testing specific examples, test properties:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_string_utils_property.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hypothesis</span><span class="w"> </span><span class="kn">import</span> <span class="n">given</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hypothesis</span><span class="w"> </span><span class="kn">import</span> <span class="n">strategies</span> <span class="k">as</span> <span class="n">st</span>

<span class="nd">@given</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_reverse_string_property</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Property: Reversing a string twice returns the original string.</span>

<span class="sd">    This should be true for ANY string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">reverse</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">==</span> <span class="n">s</span>
</code></pre></div>

<p>Run the property test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_string_utils_property.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>tests/test_string_utils_property.py::test_reverse_string_property PASSED

Hypothesis ran 100 examples
</code></pre></div>

<p>Hypothesis automatically generated 100 different strings and verified the property holds for all of them.</p>
<p><strong>What if the property doesn't hold?</strong> Let's test a buggy implementation:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/string_utils.py (buggy version)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">reverse</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reverse a string (buggy implementation).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span>  <span class="c1"># Bug: Don&#39;t reverse very long strings</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div>

<p>Run the property test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_string_utils_property.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>tests/test_string_utils_property.py::test_reverse_string_property FAILED

E   AssertionError: assert &#39;aaa...aaa&#39; == &#39;aaa...aaa&#39;
E   
E   Falsifying example: test_reverse_string_property(
E       s=&#39;a&#39; * 1001
E   )
E   
E   You can reproduce this example by temporarily adding @reproduce_failure(&#39;6.92.1&#39;, b&#39;...&#39;)
E   as a decorator on your test case
</code></pre></div>

<p><strong>Hypothesis found the bug!</strong> It automatically generated a string longer than 1000 characters and discovered the property doesn't hold.</p>
<h3 id="iteration-2-testing-complex-data-structures">Iteration 2: Testing Complex Data Structures</h3>
<p>Let's test our API client with property-based testing:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_api_client_properties.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hypothesis</span><span class="w"> </span><span class="kn">import</span> <span class="n">given</span><span class="p">,</span> <span class="n">assume</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hypothesis</span><span class="w"> </span><span class="kn">import</span> <span class="n">strategies</span> <span class="k">as</span> <span class="n">st</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.api_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIClient</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>

<span class="c1"># Define strategies for generating test data</span>
<span class="n">user_strategy</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">fixed_dictionaries</span><span class="p">({</span>
    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">st</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mi">1000000</span><span class="p">),</span>
    <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">alphabet</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">characters</span><span class="p">(</span><span class="n">whitelist_categories</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Lu&#39;</span><span class="p">,</span> <span class="s1">&#39;Ll&#39;</span><span class="p">,</span> <span class="s1">&#39;Nd&#39;</span><span class="p">)),</span>
        <span class="n">min_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">max_size</span><span class="o">=</span><span class="mi">20</span>
    <span class="p">),</span>
    <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">st</span><span class="o">.</span><span class="n">emails</span><span class="p">()</span>
<span class="p">})</span>

<span class="nd">@given</span><span class="p">(</span><span class="n">user_strategy</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_get_user_returns_valid_user</span><span class="p">(</span><span class="n">user_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Property: get_user should always return a user with valid structure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;src.api_client.requests.Session&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_session_class</span><span class="p">:</span>
        <span class="n">mock_session</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">mock_session_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_session</span>
        <span class="n">mock_session</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">user_data</span>

        <span class="n">client</span> <span class="o">=</span> <span class="n">APIClient</span><span class="p">(</span><span class="s2">&quot;https://api.example.com&quot;</span><span class="p">,</span> <span class="s2">&quot;test-key&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>

        <span class="c1"># Properties that should always hold</span>
        <span class="k">assert</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">result</span>
        <span class="k">assert</span> <span class="s1">&#39;username&#39;</span> <span class="ow">in</span> <span class="n">result</span>
        <span class="k">assert</span> <span class="s1">&#39;email&#39;</span> <span class="ow">in</span> <span class="n">result</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39;@&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
</code></pre></div>

<p>Run the property test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_api_client_properties.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>tests/test_api_client_properties.py::test_get_user_returns_valid_user PASSED

Hypothesis ran 100 examples
</code></pre></div>

<h3 id="iteration-3-finding-edge-cases-automatically">Iteration 3: Finding Edge Cases Automatically</h3>
<p>Property-based testing excels at finding edge cases. Let's test order processing:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/order_calculator.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>

<span class="k">def</span><span class="w"> </span><span class="nf">calculate_order_total</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">tax_rate</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0725&#39;</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate order total with tax.&quot;&quot;&quot;</span>
    <span class="n">subtotal</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]))</span> <span class="o">*</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span>
    <span class="p">)</span>
    <span class="n">tax</span> <span class="o">=</span> <span class="n">subtotal</span> <span class="o">*</span> <span class="n">tax_rate</span>
    <span class="k">return</span> <span class="n">subtotal</span> <span class="o">+</span> <span class="n">tax</span>
</code></pre></div>

<p>Test with properties:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_order_calculator_properties.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hypothesis</span><span class="w"> </span><span class="kn">import</span> <span class="n">given</span><span class="p">,</span> <span class="n">assume</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hypothesis</span><span class="w"> </span><span class="kn">import</span> <span class="n">strategies</span> <span class="k">as</span> <span class="n">st</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.order_calculator</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate_order_total</span>

<span class="n">item_strategy</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">fixed_dictionaries</span><span class="p">({</span>
    <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">st</span><span class="o">.</span><span class="n">floats</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mf">10000.0</span><span class="p">),</span>
    <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="n">st</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="p">})</span>

<span class="nd">@given</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">lists</span><span class="p">(</span><span class="n">item_strategy</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_order_total_is_positive</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Property: Order total should always be positive.&quot;&quot;&quot;</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">calculate_order_total</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="nd">@given</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">lists</span><span class="p">(</span><span class="n">item_strategy</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_order_total_increases_with_quantity</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Property: Increasing quantity should increase total.&quot;&quot;&quot;</span>
    <span class="n">original_total</span> <span class="o">=</span> <span class="n">calculate_order_total</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

    <span class="c1"># Double the quantity of the first item</span>
    <span class="n">items_doubled</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">items_doubled</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">],</span>
        <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="p">}</span>

    <span class="n">doubled_total</span> <span class="o">=</span> <span class="n">calculate_order_total</span><span class="p">(</span><span class="n">items_doubled</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">doubled_total</span> <span class="o">&gt;</span> <span class="n">original_total</span>

<span class="nd">@given</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">lists</span><span class="p">(</span><span class="n">item_strategy</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_order_total_with_zero_tax_equals_subtotal</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Property: With 0% tax, total should equal subtotal.&quot;&quot;&quot;</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">calculate_order_total</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">tax_rate</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">))</span>

    <span class="n">expected_subtotal</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]))</span> <span class="o">*</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">total</span> <span class="o">-</span> <span class="n">expected_subtotal</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.01&#39;</span><span class="p">)</span>
</code></pre></div>

<p>Run the property tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_order_calculator_properties.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>tests/test_order_calculator_properties.py::test_order_total_is_positive FAILED

E   AssertionError: assert Decimal(&#39;0&#39;) &gt; 0
E   
E   Falsifying example: test_order_total_is_positive(
E       items=[{&#39;price&#39;: 0.01, &#39;quantity&#39;: 1}]
E   )
</code></pre></div>

<p><strong>Bug found!</strong> With very small prices and rounding, the total can become zero. This is an edge case we wouldn't have thought to test manually.</p>
<h3 id="iteration-4-stateful-testing">Iteration 4: Stateful Testing</h3>
<p>Test sequences of operations:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_shopping_cart_stateful.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hypothesis.stateful</span><span class="w"> </span><span class="kn">import</span> <span class="n">RuleBasedStateMachine</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">invariant</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hypothesis</span><span class="w"> </span><span class="kn">import</span> <span class="n">strategies</span> <span class="k">as</span> <span class="n">st</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.shopping_cart</span><span class="w"> </span><span class="kn">import</span> <span class="n">ShoppingCart</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ShoppingCartStateMachine</span><span class="p">(</span><span class="n">RuleBasedStateMachine</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stateful testing: Generate random sequences of cart operations</span>
<span class="sd">    and verify invariants always hold.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cart</span> <span class="o">=</span> <span class="n">ShoppingCart</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected_items</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@rule</span><span class="p">(</span><span class="n">product_id</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mi">100</span><span class="p">),</span>
          <span class="n">quantity</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_id</span><span class="p">,</span> <span class="n">quantity</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add an item to the cart.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span> <span class="n">quantity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected_items</span><span class="p">[</span><span class="n">product_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">quantity</span>

    <span class="nd">@rule</span><span class="p">(</span><span class="n">product_id</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove an item from the cart.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">product_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_items</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">remove_item</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_items</span><span class="p">[</span><span class="n">product_id</span><span class="p">]</span>

    <span class="nd">@rule</span><span class="p">(</span><span class="n">product_id</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mi">100</span><span class="p">),</span>
          <span class="n">quantity</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_quantity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_id</span><span class="p">,</span> <span class="n">quantity</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update item quantity.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">product_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_items</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">update_quantity</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span> <span class="n">quantity</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expected_items</span><span class="p">[</span><span class="n">product_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">quantity</span>

    <span class="nd">@rule</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_cart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear the cart.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected_items</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="nd">@invariant</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cart_matches_expected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Invariant: Cart contents should always match expected state.&quot;&quot;&quot;</span>
        <span class="n">actual_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">get_items</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">actual_items</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_items</span>

    <span class="nd">@invariant</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cart_total_is_consistent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Invariant: Cart total should equal sum of item totals.&quot;&quot;&quot;</span>
        <span class="n">expected_total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">get_item_price</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span> <span class="o">*</span> <span class="n">quantity</span>
            <span class="k">for</span> <span class="n">product_id</span><span class="p">,</span> <span class="n">quantity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_items</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">get_total</span><span class="p">()</span> <span class="o">-</span> <span class="n">expected_total</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.01</span>

<span class="c1"># Run the state machine</span>
<span class="n">TestShoppingCart</span> <span class="o">=</span> <span class="n">ShoppingCartStateMachine</span><span class="o">.</span><span class="n">TestCase</span>
</code></pre></div>

<p>Run the stateful test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_shopping_cart_stateful.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>tests/test_shopping_cart_stateful.py::TestShoppingCart::test_shopping_cart_state_machine FAILED

E   AssertionError: Cart total doesn&#39;t match expected
E   
E   Falsifying example:
E       state = ShoppingCartStateMachine()
E       state.add_item(product_id=1, quantity=5)
E       state.update_quantity(product_id=1, quantity=3)
E       state.add_item(product_id=1, quantity=2)
E       # Cart total: 10.00, Expected: 15.00
E   
E   Minimal failing sequence found after 47 steps
</code></pre></div>

<p><strong>Bug found!</strong> When updating quantity and then adding more items, the cart total calculation is incorrect. Hypothesis automatically found the minimal sequence of operations that triggers the bug.</p>
<h3 id="when-to-use-property-based-testing">When to Use Property-Based Testing</h3>
<p><strong>Optimal scenarios</strong>:
- Testing pure functions (no side effects)
- Testing data transformations
- Testing parsers and serializers
- Testing mathematical properties
- Finding edge cases in complex logic</p>
<p><strong>When to avoid</strong>:
- Testing UI interactions (too stateful)
- Testing external integrations (non-deterministic)
- Testing business rules that don't have clear properties
- When example-based tests are clearer and sufficient</p>
<h3 id="pro-tips-for-property-based-testing">Pro Tips for Property-Based Testing</h3>
<p><strong>1. Start with simple properties</strong>:</p>
<p>Don't try to test everything with properties. Start with obvious invariants:
- Reversing twice returns original
- Sorting is idempotent (sorting twice = sorting once)
- Encoding then decoding returns original
- Adding then removing returns original state</p>
<p><strong>2. Combine with example-based tests</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_string_utils_combined.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hypothesis</span><span class="w"> </span><span class="kn">import</span> <span class="n">given</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hypothesis</span><span class="w"> </span><span class="kn">import</span> <span class="n">strategies</span> <span class="k">as</span> <span class="n">st</span>

<span class="c1"># Example-based tests for specific cases</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_reverse_empty_string</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_reverse_single_char</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_reverse_palindrome</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;racecar&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;racecar&quot;</span>

<span class="c1"># Property-based test for general behavior</span>
<span class="nd">@given</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_reverse_property</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">reverse</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">==</span> <span class="n">s</span>
</code></pre></div>

<p><strong>3. Use <code>assume()</code> to filter invalid inputs</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">hypothesis</span><span class="w"> </span><span class="kn">import</span> <span class="n">given</span><span class="p">,</span> <span class="n">assume</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hypothesis</span><span class="w"> </span><span class="kn">import</span> <span class="n">strategies</span> <span class="k">as</span> <span class="n">st</span>

<span class="nd">@given</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">integers</span><span class="p">(),</span> <span class="n">st</span><span class="o">.</span><span class="n">integers</span><span class="p">())</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_division_property</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Property: (a / b) * b should equal a.&quot;&quot;&quot;</span>
    <span class="n">assume</span><span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Filter out division by zero</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">result</span> <span class="o">*</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0001</span>
</code></pre></div>

<p><strong>4. Shrink failing examples</strong>:</p>
<p>Hypothesis automatically finds the minimal failing example:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@given</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">lists</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">integers</span><span class="p">()))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_list_property</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Property: Sorting should not change list length.&quot;&quot;&quot;</span>
    <span class="n">sorted_lst</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_lst</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
</code></pre></div>

<p>If this fails, Hypothesis will shrink the failing example from a large list to the smallest list that still fails.</p>
<p><strong>5. Use <code>@reproduce_failure</code> to debug</strong>:</p>
<p>When Hypothesis finds a failure, it provides a decorator to reproduce it:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">hypothesis</span><span class="w"> </span><span class="kn">import</span> <span class="n">reproduce_failure</span>

<span class="nd">@reproduce_failure</span><span class="p">(</span><span class="s1">&#39;6.92.1&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;AXicY2BgYGAAAQAA&#39;</span><span class="p">)</span>
<span class="nd">@given</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_reverse_property</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">reverse</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">==</span> <span class="n">s</span>
</code></pre></div>

<p>This runs the exact same failing example every time, making debugging easier.</p>
<p><strong>6. Configure Hypothesis for different scenarios</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hypothesis</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span><span class="p">,</span> <span class="n">Verbosity</span>

<span class="c1"># Default settings for all tests</span>
<span class="n">settings</span><span class="o">.</span><span class="n">register_profile</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">max_examples</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># Thorough testing for CI</span>
<span class="n">settings</span><span class="o">.</span><span class="n">register_profile</span><span class="p">(</span><span class="s2">&quot;ci&quot;</span><span class="p">,</span> <span class="n">max_examples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">deadline</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># Quick testing for development</span>
<span class="n">settings</span><span class="o">.</span><span class="n">register_profile</span><span class="p">(</span><span class="s2">&quot;dev&quot;</span><span class="p">,</span> <span class="n">max_examples</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Debug mode</span>
<span class="n">settings</span><span class="o">.</span><span class="n">register_profile</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="n">max_examples</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">Verbosity</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

<span class="c1"># Activate profile based on environment</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">settings</span><span class="o">.</span><span class="n">load_profile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;HYPOTHESIS_PROFILE&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">))</span>
</code></pre></div>

<p>Use different profiles:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Quick feedback during development</span>
$<span class="w"> </span><span class="nv">HYPOTHESIS_PROFILE</span><span class="o">=</span>dev<span class="w"> </span>pytest

<span class="c1"># Thorough testing in CI</span>
$<span class="w"> </span><span class="nv">HYPOTHESIS_PROFILE</span><span class="o">=</span>ci<span class="w"> </span>pytest

<span class="c1"># Debug a failing test</span>
$<span class="w"> </span><span class="nv">HYPOTHESIS_PROFILE</span><span class="o">=</span>debug<span class="w"> </span>pytest<span class="w"> </span>tests/test_specific.py<span class="w"> </span>-v
</code></pre></div>

<h2 id="best-practices-summary">Best Practices Summary</h2>
<p>After 19 chapters of pytest techniques, let's distill the essential principles that separate good tests from great tests. These aren't arbitrary rules‚Äîthey're battle-tested patterns that make tests maintainable, reliable, and valuable.</p>
<h2 id="the-complexity-trap">The Complexity Trap</h2>
<p>Tests are code. Code can become complex. But complex tests defeat their purpose: they're hard to understand, hard to maintain, and hard to trust.</p>
<p><strong>Bad example</strong> (complex test):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_order_processing_complex.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_order_processing</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test order processing (too complex).&quot;&quot;&quot;</span>
    <span class="c1"># Setup (50 lines of configuration)</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">setup_database</span><span class="p">()</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">setup_cache</span><span class="p">()</span>
    <span class="n">email_service</span> <span class="o">=</span> <span class="n">setup_email_service</span><span class="p">()</span>
    <span class="n">payment_gateway</span> <span class="o">=</span> <span class="n">setup_payment_gateway</span><span class="p">()</span>
    <span class="n">inventory_system</span> <span class="o">=</span> <span class="n">setup_inventory_system</span><span class="p">()</span>

    <span class="c1"># Create test data (30 lines)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;testuser&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">)</span>
    <span class="n">products</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">create_product</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Product </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mf">10.0</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Test multiple scenarios in one test (100 lines)</span>
    <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">quantity</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">payment_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;credit_card&#39;</span><span class="p">,</span> <span class="s1">&#39;paypal&#39;</span><span class="p">,</span> <span class="s1">&#39;bank_transfer&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">shipping_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span> <span class="s1">&#39;express&#39;</span><span class="p">,</span> <span class="s1">&#39;overnight&#39;</span><span class="p">]:</span>
                    <span class="n">order</span> <span class="o">=</span> <span class="n">create_order</span><span class="p">(</span>
                        <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                        <span class="n">items</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;product&#39;</span><span class="p">:</span> <span class="n">product</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="n">quantity</span><span class="p">}],</span>
                        <span class="n">payment_method</span><span class="o">=</span><span class="n">payment_method</span><span class="p">,</span>
                        <span class="n">shipping_method</span><span class="o">=</span><span class="n">shipping_method</span>
                    <span class="p">)</span>

                    <span class="n">result</span> <span class="o">=</span> <span class="n">process_order</span><span class="p">(</span>
                        <span class="n">order</span><span class="p">,</span>
                        <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
                        <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span>
                        <span class="n">email_service</span><span class="o">=</span><span class="n">email_service</span><span class="p">,</span>
                        <span class="n">payment_gateway</span><span class="o">=</span><span class="n">payment_gateway</span><span class="p">,</span>
                        <span class="n">inventory_system</span><span class="o">=</span><span class="n">inventory_system</span>
                    <span class="p">)</span>

                    <span class="c1"># Assertions (20 lines of complex validation)</span>
                    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;completed&#39;</span>
                    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">payment_status</span> <span class="o">==</span> <span class="s1">&#39;paid&#39;</span>
                    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shipping_status</span> <span class="o">==</span> <span class="s1">&#39;pending&#39;</span>
                    <span class="c1"># ... 17 more assertions</span>
</code></pre></div>

<p><strong>Problems</strong>:
- 200+ lines in one test
- Tests multiple scenarios simultaneously
- When it fails, you don't know which scenario broke
- Hard to understand what's being tested
- Difficult to modify without breaking something</p>
<p><strong>Good example</strong> (simple, focused tests):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_order_processing_simple.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.order_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_order</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">basic_order</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a basic order for testing.&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;testuser&quot;</span><span class="p">)</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">create_product</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Widget&quot;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">create_order</span><span class="p">(</span>
        <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
        <span class="n">items</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;product&#39;</span><span class="p">:</span> <span class="n">product</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}]</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_marks_as_completed</span><span class="p">(</span><span class="n">basic_order</span><span class="p">,</span> <span class="n">order_processor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that processing an order marks it as completed.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">order_processor</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">basic_order</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;completed&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_charges_payment</span><span class="p">(</span><span class="n">basic_order</span><span class="p">,</span> <span class="n">order_processor</span><span class="p">,</span> <span class="n">mock_payment_gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that processing an order charges the payment method.&quot;&quot;&quot;</span>
    <span class="n">order_processor</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">basic_order</span><span class="p">)</span>

    <span class="n">mock_payment_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
        <span class="n">payment_method</span><span class="o">=</span><span class="n">basic_order</span><span class="o">.</span><span class="n">payment_method</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_sends_confirmation_email</span><span class="p">(</span><span class="n">basic_order</span><span class="p">,</span> <span class="n">order_processor</span><span class="p">,</span> <span class="n">mock_email_service</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that processing an order sends a confirmation email.&quot;&quot;&quot;</span>
    <span class="n">order_processor</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">basic_order</span><span class="p">)</span>

    <span class="n">mock_email_service</span><span class="o">.</span><span class="n">send</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">email_call</span> <span class="o">=</span> <span class="n">mock_email_service</span><span class="o">.</span><span class="n">send</span><span class="o">.</span><span class="n">call_args</span>
    <span class="k">assert</span> <span class="s1">&#39;Order Confirmation&#39;</span> <span class="ow">in</span> <span class="n">email_call</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_updates_inventory</span><span class="p">(</span><span class="n">basic_order</span><span class="p">,</span> <span class="n">order_processor</span><span class="p">,</span> <span class="n">db_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that processing an order reduces inventory.&quot;&quot;&quot;</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">basic_order</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">product</span>
    <span class="n">original_quantity</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">inventory_quantity</span>

    <span class="n">order_processor</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">basic_order</span><span class="p">)</span>

    <span class="n">db_session</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">product</span><span class="o">.</span><span class="n">inventory_quantity</span> <span class="o">==</span> <span class="n">original_quantity</span> <span class="o">-</span> <span class="mi">1</span>
</code></pre></div>

<p><strong>Improvements</strong>:
- Each test is 5-10 lines
- Each test has a single, clear purpose
- Test names describe exactly what's being tested
- When a test fails, you immediately know what broke
- Easy to add new tests without affecting existing ones</p>
<h3 id="principles-for-simple-tests">Principles for Simple Tests</h3>
<p><strong>1. One concept per test</strong>:</p>
<p>Test one behavior, one edge case, one error condition. Not all of them at once.</p>
<p><strong>2. Arrange-Act-Assert structure</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_example</span><span class="p">():</span>
    <span class="c1"># Arrange: Set up test data</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>

    <span class="c1"># Act: Perform the action being tested</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;correct_password&quot;</span><span class="p">)</span>

    <span class="c1"># Assert: Verify the outcome</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">is_authenticated</span>
</code></pre></div>

<p><strong>3. Minimize setup code</strong>:</p>
<p>Use fixtures to hide complex setup:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Setup repeated in every test</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_user_login</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">setup_database</span><span class="p">()</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">create_session</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="c1"># ... test code</span>

<span class="c1"># Good: Setup in fixture</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticated_user</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">create_user</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_user_login</span><span class="p">(</span><span class="n">authenticated_user</span><span class="p">):</span>
    <span class="c1"># Test code starts immediately</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">authenticated_user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;correct&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">is_authenticated</span>
</code></pre></div>

<p><strong>4. Avoid test helpers that obscure behavior</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Helper hides what&#39;s being tested</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_order_processing</span><span class="p">():</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">create_test_order_with_all_options</span><span class="p">()</span>  <span class="c1"># What options?</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_and_verify_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>      <span class="c1"># What&#39;s being verified?</span>
    <span class="k">assert</span> <span class="n">result</span>  <span class="c1"># What does True mean?</span>

<span class="c1"># Good: Explicit test</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_order_processing</span><span class="p">():</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">create_order</span><span class="p">(</span>
        <span class="n">items</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;product_id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}],</span>
        <span class="n">payment_method</span><span class="o">=</span><span class="s1">&#39;credit_card&#39;</span>
    <span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;completed&#39;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">payment_status</span> <span class="o">==</span> <span class="s1">&#39;paid&#39;</span>
</code></pre></div>

<p><strong>5. Use descriptive variable names</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Cryptic names</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_x</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">a</span> <span class="o">==</span> <span class="n">d</span>

<span class="c1"># Good: Clear names</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_order_total_with_tax</span><span class="p">():</span>
    <span class="n">order_subtotal</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">)</span>
    <span class="n">tax_rate</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0725&#39;</span><span class="p">)</span>

    <span class="n">total</span> <span class="o">=</span> <span class="n">calculate_total</span><span class="p">(</span><span class="n">order_subtotal</span><span class="p">,</span> <span class="n">tax_rate</span><span class="p">)</span>

    <span class="n">expected_total</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;107.25&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">total</span> <span class="o">==</span> <span class="n">expected_total</span>
</code></pre></div>

<h2 id="one-assertion-per-test-usually">One Assertion Per Test (Usually)</h2>
<h2 id="the-multiple-assertion-debate">The Multiple Assertion Debate</h2>
<p>Should tests have one assertion or multiple? The answer: <strong>it depends on what you're testing</strong>.</p>
<p><strong>The principle</strong>: One <strong>logical assertion</strong> per test. This might be one <code>assert</code> statement, or it might be several <code>assert</code> statements that together verify one concept.</p>
<p><strong>Good: Multiple assertions for one concept</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_create_user_returns_valid_user_object</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that create_user returns a properly structured user.&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>

    <span class="c1"># These assertions all verify the same concept:</span>
    <span class="c1"># &quot;The returned object is a valid user&quot;</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s2">&quot;alice&quot;</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="s2">&quot;alice@example.com&quot;</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">created_at</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span>
</code></pre></div>

<p><strong>Bad: Multiple unrelated assertions</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_user_operations</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test various user operations (too broad).&quot;&quot;&quot;</span>
    <span class="c1"># Creating a user</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s2">&quot;alice&quot;</span>

    <span class="c1"># Updating a user</span>
    <span class="n">update_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;newemail@example.com&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="s2">&quot;newemail@example.com&quot;</span>

    <span class="c1"># Deleting a user</span>
    <span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">get_user</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="c1"># User authentication</span>
    <span class="n">auth_result</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">auth_result</span><span class="o">.</span><span class="n">is_authenticated</span>
</code></pre></div>

<p><strong>Problem</strong>: If the second assertion fails, you never run the third and fourth. You don't know if deletion and authentication work.</p>
<p><strong>Better: Split into focused tests</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_create_user_sets_username</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s2">&quot;alice&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_update_user_changes_email</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>
    <span class="n">update_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;newemail@example.com&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="s2">&quot;newemail@example.com&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_delete_user_removes_from_database</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>
    <span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">get_user</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_user_with_valid_credentials</span><span class="p">():</span>
    <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;password&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">is_authenticated</span>
</code></pre></div>

<h3 id="when-multiple-assertions-are-appropriate">When Multiple Assertions Are Appropriate</h3>
<p><strong>1. Verifying object structure</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_api_response_has_required_fields</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that API response contains all required fields.&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">api_client</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># All assertions verify the same concept: &quot;response structure is valid&quot;</span>
    <span class="k">assert</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">response</span>
    <span class="k">assert</span> <span class="s1">&#39;username&#39;</span> <span class="ow">in</span> <span class="n">response</span>
    <span class="k">assert</span> <span class="s1">&#39;email&#39;</span> <span class="ow">in</span> <span class="n">response</span>
    <span class="k">assert</span> <span class="s1">&#39;created_at&#39;</span> <span class="ow">in</span> <span class="n">response</span>
</code></pre></div>

<p><strong>2. Verifying state transitions</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_order_processing_updates_all_related_entities</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that processing an order updates order, inventory, and payment.&quot;&quot;&quot;</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">create_order</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;product_id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}])</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">get_product</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">original_inventory</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">inventory_quantity</span>

    <span class="n">process_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

    <span class="c1"># All assertions verify the same concept: &quot;order processing updates everything&quot;</span>
    <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;completed&#39;</span>
    <span class="k">assert</span> <span class="n">product</span><span class="o">.</span><span class="n">inventory_quantity</span> <span class="o">==</span> <span class="n">original_inventory</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">payment_status</span> <span class="o">==</span> <span class="s1">&#39;paid&#39;</span>
</code></pre></div>

<p><strong>3. Verifying invariants</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_shopping_cart_maintains_invariants</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that cart operations maintain consistency.&quot;&quot;&quot;</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">ShoppingCart</span><span class="p">()</span>
    <span class="n">cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">product_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
    <span class="n">cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">product_id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mf">20.0</span><span class="p">)</span>

    <span class="c1"># All assertions verify the same concept: &quot;cart is internally consistent&quot;</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="o">.</span><span class="n">item_count</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="o">.</span><span class="n">subtotal</span> <span class="o">==</span> <span class="mf">40.0</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cart</span><span class="o">.</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
</code></pre></div>

<h3 id="when-to-split-assertions">When to Split Assertions</h3>
<p><strong>Split when assertions test different behaviors</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Testing two different behaviors</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_user_creation_and_authentication</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;password&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># Tests creation</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">is_authenticated</span>  <span class="c1"># Tests authentication</span>

<span class="c1"># Good: Separate tests for separate behaviors</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_create_user_assigns_id</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;password&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_user_with_valid_credentials</span><span class="p">():</span>
    <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;password&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">is_authenticated</span>
</code></pre></div>

<h3 id="using-pytest-subtests-for-related-assertions">Using pytest-subtests for Related Assertions</h3>
<p>When you have many related assertions, use subtests to run all of them even if some fail:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_api_response_fields</span><span class="p">(</span><span class="n">subtests</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that API response has all required fields.&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">api_client</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;updated_at&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">required_fields</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">subtests</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">response</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Missing required field: </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>

<p><strong>Output if multiple fields are missing</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_api_response_fields SUBFAIL [email]
test_api_response_fields SUBFAIL [updated_at]

E   AssertionError: Missing required field: email
E   AssertionError: Missing required field: updated_at
</code></pre></div>

<p>You see all failures at once, not just the first one.</p>
<h2 id="name-tests-to-describe-what-they-test">Name Tests to Describe What They Test</h2>
<h2 id="the-naming-problem">The Naming Problem</h2>
<p>Test names are documentation. When a test fails in CI, the name is often the first (and sometimes only) thing you see. A good name tells you exactly what broke.</p>
<p><strong>Bad names</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_user</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_user_2</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_order</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_1</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_edge_case</span><span class="p">():</span>
    <span class="k">pass</span>
</code></pre></div>

<p><strong>When these fail, you have no idea what broke.</strong></p>
<p><strong>Good names</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_create_user_with_valid_email_succeeds</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_user_with_invalid_email_raises_validation_error</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_with_insufficient_inventory_raises_out_of_stock_error</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_order_total_includes_tax</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_user_with_expired_token_returns_unauthorized</span><span class="p">():</span>
    <span class="k">pass</span>
</code></pre></div>

<p><strong>When these fail, you know exactly what to investigate.</strong></p>
<h3 id="naming-patterns">Naming Patterns</h3>
<p><strong>Pattern 1: test_[function]<em>[scenario]</em>[expected_result]</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_user_with_valid_credentials_returns_token</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_user_with_invalid_password_raises_authentication_error</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_user_with_expired_token_returns_unauthorized</span><span class="p">():</span>
    <span class="k">pass</span>
</code></pre></div>

<p><strong>Pattern 2: test_[action]_[condition]</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_payment_processing_succeeds_with_valid_card</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_processing_fails_with_insufficient_funds</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_processing_retries_on_network_error</span><span class="p">():</span>
    <span class="k">pass</span>
</code></pre></div>

<p><strong>Pattern 3: test_[expected_behavior]<em>when</em>[condition]</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_order_total_includes_tax_when_shipping_to_california</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_order_total_excludes_tax_when_shipping_internationally</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_discount_applies_when_order_exceeds_minimum</span><span class="p">():</span>
    <span class="k">pass</span>
</code></pre></div>

<h3 id="real-world-example">Real-World Example</h3>
<p><strong>Bad naming</strong> (actual test suite I encountered):</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_1</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test user creation.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_2</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test user update.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_3</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test user deletion.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_4</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test edge case.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div>

<p><strong>CI output when test_3 fails</strong>:</p>
<div class="codehilite"><pre><span></span><code>FAILED tests/test_users.py::test_3
</code></pre></div>

<p>You have to open the file and read the docstring to understand what failed.</p>
<p><strong>Good naming</strong> (refactored):</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_create_user_with_valid_data_succeeds</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_update_user_email_changes_email_address</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_delete_user_removes_user_from_database</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_delete_user_with_active_orders_raises_integrity_error</span><span class="p">():</span>
    <span class="k">pass</span>
</code></pre></div>

<p><strong>CI output when test fails</strong>:</p>
<div class="codehilite"><pre><span></span><code>FAILED tests/test_users.py::test_delete_user_with_active_orders_raises_integrity_error
</code></pre></div>

<p>You immediately know: "Deleting a user with active orders should raise an integrity error, but it didn't."</p>
<h3 id="naming-for-parametrized-tests">Naming for Parametrized Tests</h3>
<p>Use <code>ids</code> parameter to make parametrized tests readable:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Cryptic test IDs</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;status_code&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">400</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span> <span class="mi">403</span><span class="p">,</span> <span class="mi">404</span><span class="p">,</span> <span class="mi">500</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_http_errors</span><span class="p">(</span><span class="n">status_code</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_http_errors[400] PASSED
test_http_errors[401] PASSED
test_http_errors[403] FAILED
</code></pre></div>

<p>What does 403 mean in this context?</p>
<p><strong>Good: Descriptive test IDs</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;status_code,error_name&quot;</span><span class="p">,</span> <span class="p">[</span>
    <span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;bad_request&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="s2">&quot;unauthorized&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s2">&quot;forbidden&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s2">&quot;not_found&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;internal_server_error&quot;</span><span class="p">),</span>
<span class="p">],</span> <span class="n">ids</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_http_errors</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">error_name</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_http_errors[bad_request] PASSED
test_http_errors[unauthorized] PASSED
test_http_errors[forbidden] FAILED
</code></pre></div>

<p>Now you know exactly which error case failed.</p>
<h3 id="pro-tips-for-test-naming">Pro Tips for Test Naming</h3>
<p><strong>1. Use domain language, not implementation details</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Implementation-focused</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_database_query_returns_list</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="c1"># Good: Behavior-focused</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_search_users_returns_matching_users</span><span class="p">():</span>
    <span class="k">pass</span>
</code></pre></div>

<p><strong>2. Include the failure condition</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Doesn&#39;t say what should happen</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_email</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="c1"># Good: Says what should happen</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_create_user_with_invalid_email_raises_validation_error</span><span class="p">():</span>
    <span class="k">pass</span>
</code></pre></div>

<p><strong>3. Be specific about edge cases</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Vague</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_edge_case</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="c1"># Good: Specific</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_discount_with_zero_quantity_returns_zero</span><span class="p">():</span>
    <span class="k">pass</span>
</code></pre></div>

<p><strong>4. Use consistent naming across the test suite</strong>:</p>
<p>Pick a pattern and stick to it. Don't mix:
- <code>test_user_creation_succeeds</code>
- <code>test_when_updating_user_email_changes</code>
- <code>test_delete_user</code></p>
<p>Choose one pattern for the entire project.</p>
<h2 id="avoid-test-interdependency">Avoid Test Interdependency</h2>
<h2 id="the-interdependency-problem">The Interdependency Problem</h2>
<p>Tests should be independent. Each test should run successfully in isolation, in any order, and regardless of which other tests run.</p>
<p><strong>Bad: Tests depend on execution order</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_user_lifecycle.py (BAD)</span>
<span class="n">_created_user_id</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_1_create_user</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a user (must run first).&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_created_user_id</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>
    <span class="n">_created_user_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_2_update_user</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the user (must run after test_1).&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_created_user_id</span>
    <span class="k">assert</span> <span class="n">_created_user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;test_1_create_user must run first&quot;</span>

    <span class="n">update_user</span><span class="p">(</span><span class="n">_created_user_id</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;newemail@example.com&quot;</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">_created_user_id</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="s2">&quot;newemail@example.com&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_3_delete_user</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete the user (must run after test_2).&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_created_user_id</span>
    <span class="k">assert</span> <span class="n">_created_user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;test_1_create_user must run first&quot;</span>

    <span class="n">delete_user</span><span class="p">(</span><span class="n">_created_user_id</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">get_user</span><span class="p">(</span><span class="n">_created_user_id</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
</code></pre></div>

<p><strong>Problems</strong>:
- Tests must run in order (1, 2, 3)
- If test_1 fails, test_2 and test_3 also fail
- Can't run test_2 or test_3 in isolation
- Parallel execution breaks everything
- Debugging is difficult</p>
<p><strong>Run tests in random order</strong> (they fail):</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_user_lifecycle.py<span class="w"> </span>--random-order
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_user_lifecycle.py::test_3_delete_user FAILED
test_user_lifecycle.py::test_1_create_user PASSED
test_user_lifecycle.py::test_2_update_user FAILED

E   AssertionError: test_1_create_user must run first
</code></pre></div>

<p><strong>Good: Independent tests</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_user_lifecycle.py (GOOD)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">created_user</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a user for testing.&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">user</span>
    <span class="c1"># Cleanup happens automatically after test</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_user_assigns_id</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that creating a user assigns an ID.&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_update_user_changes_email</span><span class="p">(</span><span class="n">created_user</span><span class="p">,</span> <span class="n">db_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that updating a user changes their email.&quot;&quot;&quot;</span>
    <span class="n">update_user</span><span class="p">(</span><span class="n">created_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;newemail@example.com&quot;</span><span class="p">)</span>

    <span class="n">updated_user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">created_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">updated_user</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="s2">&quot;newemail@example.com&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_delete_user_removes_from_database</span><span class="p">(</span><span class="n">created_user</span><span class="p">,</span> <span class="n">db_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that deleting a user removes them from the database.&quot;&quot;&quot;</span>
    <span class="n">delete_user</span><span class="p">(</span><span class="n">created_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">get_user</span><span class="p">(</span><span class="n">created_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
</code></pre></div>

<p><strong>Improvements</strong>:
- Each test is self-contained
- Tests can run in any order
- Tests can run in parallel
- Each test can be run in isolation
- If one test fails, others still run</p>
<p><strong>Run tests in random order</strong> (they pass):</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_user_lifecycle.py<span class="w"> </span>--random-order
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_user_lifecycle.py::test_delete_user_removes_from_database PASSED
test_user_lifecycle.py::test_create_user_assigns_id PASSED
test_user_lifecycle.py::test_update_user_changes_email PASSED

======================== 3 passed in 0.23s ========================
</code></pre></div>

<h3 id="common-sources-of-test-interdependency">Common Sources of Test Interdependency</h3>
<p><strong>1. Shared global state</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Global state</span>
<span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cache_stores_value</span><span class="p">():</span>
    <span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;value&#39;</span>
    <span class="k">assert</span> <span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;value&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cache_is_empty</span><span class="p">():</span>
    <span class="c1"># Fails if test_cache_stores_value ran first</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">_cache</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</code></pre></div>

<p><strong>Fix: Use fixtures to isolate state</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cache</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a fresh cache for each test.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cache_stores_value</span><span class="p">(</span><span class="n">cache</span><span class="p">):</span>
    <span class="n">cache</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;value&#39;</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;value&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cache_is_empty</span><span class="p">(</span><span class="n">cache</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</code></pre></div>

<p><strong>2. Database state</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Tests modify shared database</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_create_user</span><span class="p">():</span>
    <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">get_user_by_username</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_user_does_not_exist</span><span class="p">():</span>
    <span class="c1"># Fails if test_create_user ran first</span>
    <span class="k">assert</span> <span class="n">get_user_by_username</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
</code></pre></div>

<p><strong>Fix: Use transactions or database cleanup</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_session</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a database session that rolls back after each test.&quot;&quot;&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">create_session</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">session</span>
    <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_user</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
    <span class="n">create_user</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">get_user_by_username</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="s2">&quot;alice&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_user_does_not_exist</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">get_user_by_username</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="s2">&quot;alice&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
</code></pre></div>

<p><strong>3. File system state</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Tests modify shared files</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_write_config</span><span class="p">():</span>
    <span class="n">write_config_file</span><span class="p">(</span><span class="s2">&quot;config.json&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">})</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;config.json&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_config_file_does_not_exist</span><span class="p">():</span>
    <span class="c1"># Fails if test_write_config ran first</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;config.json&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Fix: Use temporary directories</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_write_config</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;config.json&quot;</span>
    <span class="n">write_config_file</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">})</span>
    <span class="k">assert</span> <span class="n">config_file</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_config_file_does_not_exist</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;config.json&quot;</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">config_file</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
</code></pre></div>

<p><strong>4. Time-dependent tests</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Tests depend on current time</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_token_expires_after_one_hour</span><span class="p">():</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">create_token</span><span class="p">(</span><span class="n">expires_in</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3601</span><span class="p">)</span>  <span class="c1"># Wait for expiration</span>
    <span class="k">assert</span> <span class="n">is_token_expired</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</code></pre></div>

<p><strong>Fix: Mock time or use explicit timestamps</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_token_expires_after_one_hour</span><span class="p">(</span><span class="n">freezer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test token expiration (using pytest-freezegun).&quot;&quot;&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">create_token</span><span class="p">(</span><span class="n">expires_in</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>

    <span class="c1"># Fast-forward time</span>
    <span class="n">freezer</span><span class="o">.</span><span class="n">move_to</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">assert</span> <span class="n">is_token_expired</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</code></pre></div>

<h3 id="detecting-test-interdependency">Detecting Test Interdependency</h3>
<p><strong>Run tests in random order</strong>:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pytest-random-order
$<span class="w"> </span>pytest<span class="w"> </span>--random-order
</code></pre></div>

<p>If tests fail with random order but pass with normal order, you have interdependency.</p>
<p><strong>Run tests in isolation</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run each test individually</span>
$<span class="w"> </span>pytest<span class="w"> </span>tests/test_users.py::test_create_user
$<span class="w"> </span>pytest<span class="w"> </span>tests/test_users.py::test_update_user
$<span class="w"> </span>pytest<span class="w"> </span>tests/test_users.py::test_delete_user
</code></pre></div>

<p>If a test passes when run with others but fails in isolation, it depends on another test.</p>
<p><strong>Run tests in parallel</strong>:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-n<span class="w"> </span>auto
</code></pre></div>

<p>If tests fail with parallel execution but pass sequentially, they share state.</p>
<h2 id="use-fixtures-for-setup-not-test-data">Use Fixtures for Setup, Not Test Data</h2>
<h2 id="the-fixture-misuse-problem">The Fixture Misuse Problem</h2>
<p>Fixtures are for <strong>setup and teardown</strong>, not for defining test data. Test data should be visible in the test itself.</p>
<p><strong>Bad: Test data hidden in fixtures</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (BAD)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a user with specific attributes.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">create_user</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s2">&quot;alice@example.com&quot;</span><span class="p">,</span>
        <span class="n">age</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">country</span><span class="o">=</span><span class="s2">&quot;US&quot;</span><span class="p">,</span>
        <span class="n">subscription_type</span><span class="o">=</span><span class="s2">&quot;premium&quot;</span><span class="p">,</span>
        <span class="n">account_balance</span><span class="o">=</span><span class="mf">100.00</span>
    <span class="p">)</span>

<span class="c1"># tests/test_user.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_user_can_purchase_premium_content</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that user can purchase premium content.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">purchase_content</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">content_id</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span>
</code></pre></div>

<p><strong>Problem</strong>: When this test fails, you have to look at the fixture to understand why. What attributes of the user matter for this test? Is it the subscription type? The account balance? The country?</p>
<p><strong>Good: Test data visible in test</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (GOOD)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_session</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a database session (setup only).&quot;&quot;&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">create_session</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">session</span>
    <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># tests/test_user.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_premium_user_can_purchase_premium_content</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that premium users can purchase premium content.&quot;&quot;&quot;</span>
    <span class="c1"># Test data is visible here</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span>
        <span class="n">db_session</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span>
        <span class="n">subscription_type</span><span class="o">=</span><span class="s2">&quot;premium&quot;</span><span class="p">,</span>
        <span class="n">account_balance</span><span class="o">=</span><span class="mf">100.00</span>
    <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">purchase_content</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">content_id</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_free_user_cannot_purchase_premium_content</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that free users cannot purchase premium content.&quot;&quot;&quot;</span>
    <span class="c1"># Different test data, clearly visible</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span>
        <span class="n">db_session</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;bob&quot;</span><span class="p">,</span>
        <span class="n">subscription_type</span><span class="o">=</span><span class="s2">&quot;free&quot;</span><span class="p">,</span>
        <span class="n">account_balance</span><span class="o">=</span><span class="mf">100.00</span>
    <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">purchase_content</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">content_id</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="o">==</span> <span class="s2">&quot;Premium subscription required&quot;</span>
</code></pre></div>

<p><strong>Improvements</strong>:
- Test data is visible in the test
- Each test creates exactly the data it needs
- When a test fails, you can see immediately what data was used
- Tests are self-documenting</p>
<h3 id="when-to-use-fixtures-for-data">When to Use Fixtures for Data</h3>
<p><strong>Use fixtures for data when</strong>:</p>
<ol>
<li><strong>The data is complex to create</strong>:</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">complex_order</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create an order with multiple items, discounts, and shipping.&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">db_session</span><span class="p">)</span>
    <span class="n">products</span> <span class="o">=</span> <span class="p">[</span><span class="n">create_product</span><span class="p">(</span><span class="n">db_session</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">create_order</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
        <span class="n">add_order_item</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">apply_discount</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="s2">&quot;SAVE10&quot;</span><span class="p">)</span>
    <span class="n">set_shipping_address</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="n">create_address</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">order</span>
</code></pre></div>

<ol>
<li><strong>The data is reused across many tests</strong>:</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sample_products</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a standard set of products for testing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">create_product</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Widget&quot;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mf">10.0</span><span class="p">),</span>
        <span class="n">create_product</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Gadget&quot;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mf">20.0</span><span class="p">),</span>
        <span class="n">create_product</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Doohickey&quot;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mf">30.0</span><span class="p">),</span>
    <span class="p">]</span>
</code></pre></div>

<ol>
<li><strong>The data represents a standard scenario</strong>:</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticated_user</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a user and authenticate them.&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;password&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="n">token</span>
</code></pre></div>

<h3 id="factory-fixtures-the-best-of-both-worlds">Factory Fixtures: The Best of Both Worlds</h3>
<p>Use factory fixtures to combine fixture convenience with test-visible data:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user_factory</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for creating users with custom attributes.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_user</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;testuser&#39;</span><span class="p">,</span>
            <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;test@example.com&#39;</span><span class="p">,</span>
            <span class="s1">&#39;subscription_type&#39;</span><span class="p">:</span> <span class="s1">&#39;free&#39;</span><span class="p">,</span>
            <span class="s1">&#39;account_balance&#39;</span><span class="p">:</span> <span class="mf">0.00</span>
        <span class="p">}</span>
        <span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">create_user</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="o">**</span><span class="n">defaults</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_create_user</span>

<span class="c1"># tests/test_user.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_premium_user_can_purchase_premium_content</span><span class="p">(</span><span class="n">user_factory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that premium users can purchase premium content.&quot;&quot;&quot;</span>
    <span class="c1"># Create user with specific attributes (visible in test)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">user_factory</span><span class="p">(</span>
        <span class="n">subscription_type</span><span class="o">=</span><span class="s2">&quot;premium&quot;</span><span class="p">,</span>
        <span class="n">account_balance</span><span class="o">=</span><span class="mf">100.00</span>
    <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">purchase_content</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">content_id</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_user_with_insufficient_balance_cannot_purchase</span><span class="p">(</span><span class="n">user_factory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that users with insufficient balance cannot purchase.&quot;&quot;&quot;</span>
    <span class="c1"># Create user with different attributes (visible in test)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">user_factory</span><span class="p">(</span>
        <span class="n">subscription_type</span><span class="o">=</span><span class="s2">&quot;premium&quot;</span><span class="p">,</span>
        <span class="n">account_balance</span><span class="o">=</span><span class="mf">5.00</span>  <span class="c1"># Not enough for $10 content</span>
    <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">purchase_content</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">content_id</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="o">==</span> <span class="s2">&quot;Insufficient balance&quot;</span>
</code></pre></div>

<p><strong>Benefits</strong>:
- Fixture handles the complex creation logic
- Test data is still visible in the test
- Easy to create variations for different test scenarios
- Reduces duplication without hiding information</p>
<h3 id="pro-tips-for-fixture-usage">Pro Tips for Fixture Usage</h3>
<p><strong>1. Name fixtures by what they provide, not what they do</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Named by action</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">setup_database</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="c1"># Good: Named by what it provides</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_session</span><span class="p">():</span>
    <span class="k">pass</span>
</code></pre></div>

<p><strong>2. Use fixture scopes appropriately</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Function scope (default): New instance for each test</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">create_user</span><span class="p">(</span><span class="n">db_session</span><span class="p">)</span>

<span class="c1"># Module scope: Shared across all tests in the module</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">database_connection</span><span class="p">():</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">conn</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Session scope: Shared across entire test session</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_config</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">load_config</span><span class="p">(</span><span class="s2">&quot;test_config.yaml&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>3. Use autouse sparingly</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Autouse for everything</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">setup_everything</span><span class="p">():</span>
    <span class="c1"># Runs before every test, even if not needed</span>
    <span class="k">pass</span>

<span class="c1"># Good: Autouse only for essential setup</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">reset_global_state</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reset global state before each test.&quot;&quot;&quot;</span>
    <span class="n">global_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">yield</span>
    <span class="n">global_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></pre></div>

<p><strong>4. Document fixture purpose and usage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticated_api_client</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provide an API client authenticated as a test user.</span>

<span class="sd">    Creates a test user, authenticates them, and returns a client</span>
<span class="sd">    with the authentication token set.</span>

<span class="sd">    Usage:</span>
<span class="sd">        def test_api_endpoint(authenticated_api_client):</span>
<span class="sd">            response = authenticated_api_client.get(&#39;/api/users/me&#39;)</span>
<span class="sd">            assert response.status_code == 200</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;testuser&quot;</span><span class="p">)</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;password&quot;</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">APIClient</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">client</span>
</code></pre></div>

<h2 id="common-pitfalls-to-avoid">Common Pitfalls to Avoid</h2>
<p>These are the mistakes that even experienced developers make. Learn to recognize and avoid them.</p>
<h2 id="the-mocking-trap">The Mocking Trap</h2>
<p>Mocks are powerful, but overuse leads to tests that pass even when the code is broken.</p>
<p><strong>Bad: Over-mocked test</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_order_processor_overmocked.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test order processing (over-mocked).&quot;&quot;&quot;</span>
    <span class="c1"># Mock everything</span>
    <span class="n">mock_db</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_payment</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_email</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_inventory</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_analytics</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="c1"># Configure mocks</span>
    <span class="n">mock_db</span><span class="o">.</span><span class="n">get_user</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">)</span>
    <span class="n">mock_db</span><span class="o">.</span><span class="n">get_product</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">inventory</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">mock_payment</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transaction_id</span><span class="o">=</span><span class="s2">&quot;txn_123&quot;</span><span class="p">)</span>
    <span class="n">mock_email</span><span class="o">.</span><span class="n">send</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">mock_inventory</span><span class="o">.</span><span class="n">reduce</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">mock_analytics</span><span class="o">.</span><span class="n">track</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Create processor with all mocks</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">OrderProcessor</span><span class="p">(</span>
        <span class="n">db</span><span class="o">=</span><span class="n">mock_db</span><span class="p">,</span>
        <span class="n">payment</span><span class="o">=</span><span class="n">mock_payment</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="n">mock_email</span><span class="p">,</span>
        <span class="n">inventory</span><span class="o">=</span><span class="n">mock_inventory</span><span class="p">,</span>
        <span class="n">analytics</span><span class="o">=</span><span class="n">mock_analytics</span>
    <span class="p">)</span>

    <span class="c1"># Process order</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_order</span><span class="p">({</span>
        <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;product_id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}]</span>
    <span class="p">})</span>

    <span class="c1"># Verify mocks were called</span>
    <span class="k">assert</span> <span class="n">mock_db</span><span class="o">.</span><span class="n">get_user</span><span class="o">.</span><span class="n">called</span>
    <span class="k">assert</span> <span class="n">mock_payment</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">called</span>
    <span class="k">assert</span> <span class="n">mock_email</span><span class="o">.</span><span class="n">send</span><span class="o">.</span><span class="n">called</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span>
</code></pre></div>

<p><strong>Problem</strong>: This test passes, but it doesn't test anything meaningful. The entire business logic is mocked away. The test verifies that mocks were called, not that the code works correctly.</p>
<p><strong>What this test doesn't catch</strong>:
- Incorrect price calculation
- Wrong tax rate
- Inventory not actually reduced
- Email sent with wrong content
- Payment charged wrong amount</p>
<p><strong>Better: Mock only external dependencies</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_order_processor_better.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_calculates_correct_total</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">mock_payment_gateway</span><span class="p">,</span> <span class="n">mock_email_service</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that order processing calculates the correct total.&quot;&quot;&quot;</span>
    <span class="c1"># Real database, real business logic</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">)</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">create_product</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Widget&quot;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">inventory</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="c1"># Mock only external services</span>
    <span class="n">mock_payment_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;transaction_id&#39;</span><span class="p">:</span> <span class="s1">&#39;txn_123&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="n">mock_email_service</span><span class="o">.</span><span class="n">send</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">OrderProcessor</span><span class="p">(</span>
        <span class="n">db</span><span class="o">=</span><span class="n">db_session</span><span class="p">,</span>
        <span class="n">payment_gateway</span><span class="o">=</span><span class="n">mock_payment_gateway</span><span class="p">,</span>
        <span class="n">email_service</span><span class="o">=</span><span class="n">mock_email_service</span>
    <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_order</span><span class="p">({</span>
        <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;product_id&#39;</span><span class="p">:</span> <span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}],</span>
        <span class="s1">&#39;shipping_state&#39;</span><span class="p">:</span> <span class="s1">&#39;CA&#39;</span>
    <span class="p">})</span>

    <span class="c1"># Verify actual business logic</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">subtotal</span> <span class="o">==</span> <span class="mf">20.0</span>  <span class="c1"># 2 * $10</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">tax</span> <span class="o">==</span> <span class="mf">1.45</span>  <span class="c1"># 7.25% of $20</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">total</span> <span class="o">==</span> <span class="mf">21.45</span>

    <span class="c1"># Verify external services called correctly</span>
    <span class="n">mock_payment_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">21.45</span><span class="p">,</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
    <span class="p">)</span>

    <span class="c1"># Verify inventory was actually reduced</span>
    <span class="n">db_session</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">product</span><span class="o">.</span><span class="n">inventory</span> <span class="o">==</span> <span class="mi">98</span>
</code></pre></div>

<p><strong>Improvements</strong>:
- Real business logic is tested
- Only external dependencies are mocked
- Test catches calculation errors
- Test verifies side effects (inventory reduction)</p>
<h3 id="when-to-mock-vs-when-to-use-real-objects">When to Mock vs. When to Use Real Objects</h3>
<p><strong>Mock</strong>:
- External APIs (payment gateways, email services, SMS)
- Slow operations (network calls, file I/O)
- Non-deterministic behavior (random number generation, current time)
- Third-party services you don't control</p>
<p><strong>Use real objects</strong>:
- Business logic
- Data transformations
- Calculations
- Internal services you control
- Database operations (use test database or transactions)</p>
<h3 id="the-mocking-spectrum">The Mocking Spectrum</h3>
<table>
<thead>
<tr>
<th>Level</th>
<th>What to Mock</th>
<th>What to Test</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Unit</td>
<td>Everything except the function under test</td>
<td>Single function logic</td>
<td><code>test_calculate_tax()</code></td>
</tr>
<tr>
<td>Integration</td>
<td>External services only</td>
<td>Multiple components working together</td>
<td><code>test_order_processing_flow()</code></td>
</tr>
<tr>
<td>E2E</td>
<td>Nothing (or minimal)</td>
<td>Entire system</td>
<td><code>test_complete_checkout_flow()</code></td>
</tr>
</tbody>
</table>
<h3 id="signs-youre-over-mocking">Signs You're Over-Mocking</h3>
<p><strong>1. Tests pass but production fails</strong>:</p>
<p>If your tests are green but users report bugs, you're probably mocking too much.</p>
<p><strong>2. Tests are harder to write than the code</strong>:</p>
<p>If setting up mocks takes more code than the function being tested, you're over-mocking.</p>
<p><strong>3. Tests don't fail when you break the code</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Break the code</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_total</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># Always return 0 (obviously wrong)</span>

<span class="c1"># Test still passes (because everything is mocked)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_total</span><span class="p">():</span>
    <span class="n">mock_items</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_items</span><span class="o">.</span><span class="n">sum</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">calculate_total</span><span class="p">(</span><span class="n">mock_items</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">mock_items</span><span class="o">.</span><span class="n">sum</span><span class="o">.</span><span class="n">return_value</span>  <span class="c1"># Passes!</span>
</code></pre></div>

<p><strong>4. You're mocking your own code</strong>:</p>
<p>If you're mocking functions in the same module you're testing, you're testing the wrong thing.</p>
<h3 id="how-to-reduce-mocking">How to Reduce Mocking</h3>
<p><strong>1. Use dependency injection</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Hard to test without mocking</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OrderProcessor</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">payment_gateway</span> <span class="o">=</span> <span class="n">PaymentGateway</span><span class="p">()</span>  <span class="c1"># Hard-coded dependency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email_service</span> <span class="o">=</span> <span class="n">EmailService</span><span class="p">()</span>      <span class="c1"># Hard-coded dependency</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="c1"># Uses hard-coded dependencies</span>
        <span class="k">pass</span>

<span class="c1"># Good: Easy to test with real or mock dependencies</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OrderProcessor</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payment_gateway</span><span class="p">,</span> <span class="n">email_service</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">payment_gateway</span> <span class="o">=</span> <span class="n">payment_gateway</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email_service</span> <span class="o">=</span> <span class="n">email_service</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="c1"># Uses injected dependencies</span>
        <span class="k">pass</span>
</code></pre></div>

<p><strong>2. Use test doubles instead of mocks</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Instead of mocking, create a test implementation</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FakePaymentGateway</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test double for payment gateway.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charges</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">charge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charges</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">})</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;transaction_id&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;txn_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charges</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_with_fake_gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test with fake implementation instead of mock.&quot;&quot;&quot;</span>
    <span class="n">fake_gateway</span> <span class="o">=</span> <span class="n">FakePaymentGateway</span><span class="p">()</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">OrderProcessor</span><span class="p">(</span><span class="n">payment_gateway</span><span class="o">=</span><span class="n">fake_gateway</span><span class="p">)</span>

    <span class="n">processor</span><span class="o">.</span><span class="n">process_order</span><span class="p">({</span><span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">...</span><span class="p">]})</span>

    <span class="c1"># Verify using the fake&#39;s state</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fake_gateway</span><span class="o">.</span><span class="n">charges</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">fake_gateway</span><span class="o">.</span><span class="n">charges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">21.45</span>
</code></pre></div>

<p><strong>3. Use integration tests for complex interactions</strong>:</p>
<p>Instead of mocking everything in a unit test, write an integration test that uses real components.</p>
<h2 id="testing-implementation-instead-of-behavior">Testing Implementation Instead of Behavior</h2>
<h2 id="the-implementation-testing-trap">The Implementation Testing Trap</h2>
<p>Tests should verify <strong>what</strong> the code does, not <strong>how</strong> it does it. Testing implementation details makes tests brittle‚Äîthey break when you refactor, even if behavior is unchanged.</p>
<p><strong>Bad: Testing implementation</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/user_service.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserService</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="c1"># Check cache first</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span>

        <span class="c1"># Fetch from database</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="c1"># Store in cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>

        <span class="k">return</span> <span class="n">user</span>

<span class="c1"># tests/test_user_service_implementation.py (BAD)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_get_user_checks_cache_first</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that get_user checks cache before database.&quot;&quot;&quot;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="c1"># Verify cache is checked</span>
    <span class="n">service</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Test implementation detail: cache was checked</span>
    <span class="k">assert</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">0</span>  <span class="c1"># Database not queried</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s2">&quot;alice&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_user_stores_in_cache</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that get_user stores result in cache.&quot;&quot;&quot;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">filter_by</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="n">service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Test implementation detail: cache was updated</span>
    <span class="k">assert</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">service</span><span class="o">.</span><span class="n">_cache</span>
</code></pre></div>

<p><strong>Problem</strong>: These tests break if you change the caching implementation, even if the behavior is identical. For example, if you switch from a dict to Redis, these tests fail.</p>
<p><strong>Good: Testing behavior</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_user_service_behavior.py (GOOD)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_get_user_returns_user_by_id</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that get_user returns the correct user.&quot;&quot;&quot;</span>
    <span class="c1"># Setup</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db_session</span><span class="p">)</span>

    <span class="c1"># Act</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Assert behavior, not implementation</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s2">&quot;alice&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_user_returns_none_for_nonexistent_user</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that get_user returns None for nonexistent user.&quot;&quot;&quot;</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db_session</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">999</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_user_is_efficient_with_repeated_calls</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that repeated calls don&#39;t cause excessive database queries.&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db_session</span><span class="p">)</span>

    <span class="c1"># Make multiple calls</span>
    <span class="n">result1</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">result2</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">result3</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Verify behavior: all calls return the same user</span>
    <span class="k">assert</span> <span class="n">result1</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">result2</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">result3</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="c1"># Optional: Verify efficiency (but not implementation)</span>
    <span class="c1"># This is acceptable because it tests a performance characteristic</span>
    <span class="n">query_count</span> <span class="o">=</span> <span class="n">count_queries</span><span class="p">(</span><span class="n">db_session</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">query_count</span> <span class="o">&lt;=</span> <span class="mi">1</span>  <span class="c1"># At most one query, regardless of implementation</span>
</code></pre></div>

<p><strong>Improvements</strong>:
- Tests verify what the code does (returns correct user)
- Tests don't care how caching is implemented
- Tests remain valid if you switch from dict to Redis
- Tests focus on observable behavior</p>
<h3 id="examples-of-implementation-vs-behavior">Examples of Implementation vs. Behavior</h3>
<p><strong>Implementation testing</strong> (brittle):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Testing that a specific method is called</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_calls_validate</span><span class="p">():</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">OrderProcessor</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="s1">&#39;_validate_order&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_validate</span><span class="p">:</span>
        <span class="n">processor</span><span class="o">.</span><span class="n">process_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="n">mock_validate</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

<span class="c1"># Testing internal state</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_order_processor_sets_internal_flag</span><span class="p">():</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">OrderProcessor</span><span class="p">()</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">process_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">processor</span><span class="o">.</span><span class="n">_processing_flag</span> <span class="ow">is</span> <span class="kc">True</span>

<span class="c1"># Testing method call order</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_methods_called_in_correct_order</span><span class="p">():</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">OrderProcessor</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="s1">&#39;step1&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock1</span><span class="p">,</span> \
         <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="s1">&#39;step2&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock2</span><span class="p">:</span>
        <span class="n">processor</span><span class="o">.</span><span class="n">process_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">mock1</span><span class="o">.</span><span class="n">called</span>
        <span class="k">assert</span> <span class="n">mock2</span><span class="o">.</span><span class="n">called</span>
        <span class="k">assert</span> <span class="n">mock1</span><span class="o">.</span><span class="n">call_args</span> <span class="o">&lt;</span> <span class="n">mock2</span><span class="o">.</span><span class="n">call_args</span>  <span class="c1"># Order matters</span>
</code></pre></div>

<p><strong>Behavior testing</strong> (robust):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Testing observable outcomes</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_marks_order_as_completed</span><span class="p">():</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">OrderProcessor</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;completed&#39;</span>

<span class="c1"># Testing side effects</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_reduces_inventory</span><span class="p">():</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">OrderProcessor</span><span class="p">()</span>
    <span class="n">original_inventory</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">inventory</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">process_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">product</span><span class="o">.</span><span class="n">inventory</span> <span class="o">==</span> <span class="n">original_inventory</span> <span class="o">-</span> <span class="n">order</span><span class="o">.</span><span class="n">quantity</span>

<span class="c1"># Testing error conditions</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_with_invalid_payment_raises_error</span><span class="p">():</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">OrderProcessor</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">PaymentError</span><span class="p">):</span>
        <span class="n">processor</span><span class="o">.</span><span class="n">process_order</span><span class="p">(</span><span class="n">order_with_invalid_payment</span><span class="p">)</span>
</code></pre></div>

<h3 id="when-implementation-testing-is-acceptable">When Implementation Testing Is Acceptable</h3>
<p><strong>1. Testing performance characteristics</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_search_uses_index_for_performance</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that search uses database index (performance requirement).&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">assert_query_uses_index</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;username_idx&#39;</span><span class="p">):</span>
        <span class="n">search_users</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>2. Testing security requirements</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_password_is_hashed_before_storage</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that passwords are hashed (security requirement).&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;plaintext&quot;</span><span class="p">)</span>

    <span class="c1"># Verify password is not stored in plaintext</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">password_hash</span> <span class="o">!=</span> <span class="s2">&quot;plaintext&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">password_hash</span><span class="p">)</span> <span class="o">==</span> <span class="mi">60</span>  <span class="c1"># bcrypt hash length</span>
</code></pre></div>

<p><strong>3. Testing that expensive operations are avoided</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_get_user_does_not_query_database_on_cache_hit</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that cached users don&#39;t cause database queries.&quot;&quot;&quot;</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db_session</span><span class="p">)</span>

    <span class="c1"># First call: cache miss</span>
    <span class="n">service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Second call: should use cache</span>
    <span class="k">with</span> <span class="n">assert_no_database_queries</span><span class="p">():</span>
        <span class="n">service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<h3 id="how-to-refactor-implementation-tests">How to Refactor Implementation Tests</h3>
<p><strong>Step 1: Identify what behavior the test is trying to verify</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Implementation test</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_order_processor_calls_payment_gateway</span><span class="p">():</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">OrderProcessor</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="s1">&#39;payment_gateway&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock</span><span class="p">:</span>
        <span class="n">processor</span><span class="o">.</span><span class="n">process_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="n">mock</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
</code></pre></div>

<p><strong>Question</strong>: What behavior does this test verify?
<strong>Answer</strong>: That payment is processed when an order is processed.</p>
<p><strong>Step 2: Rewrite to test the behavior</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Behavior test</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order_charges_payment</span><span class="p">():</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">OrderProcessor</span><span class="p">(</span><span class="n">payment_gateway</span><span class="o">=</span><span class="n">FakePaymentGateway</span><span class="p">())</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">payment_status</span> <span class="o">==</span> <span class="s1">&#39;paid&#39;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">transaction_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</code></pre></div>

<p><strong>Step 3: Verify the test still catches bugs</strong>:</p>
<p>Change the code to break the behavior:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="c1"># Bug: Forgot to process payment</span>
    <span class="c1"># self.payment_gateway.charge(order.total)</span>
    <span class="k">return</span> <span class="n">OrderResult</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;completed&#39;</span><span class="p">,</span> <span class="n">payment_status</span><span class="o">=</span><span class="s1">&#39;paid&#39;</span><span class="p">)</span>
</code></pre></div>

<p>The behavior test should fail. If it doesn't, the test isn't testing the right thing.</p>
<h2 id="flaky-tests-and-timing-issues">Flaky Tests and Timing Issues</h2>
<h2 id="the-flaky-test-problem">The Flaky Test Problem</h2>
<p>Flaky tests pass sometimes and fail sometimes, without any code changes. They erode trust in the test suite and waste developer time.</p>
<p><strong>Common causes of flakiness</strong>:</p>
<ol>
<li><strong>Race conditions</strong></li>
<li><strong>Timing dependencies</strong></li>
<li><strong>Non-deterministic behavior</strong></li>
<li><strong>External dependencies</strong></li>
<li><strong>Test order dependencies</strong></li>
</ol>
<h3 id="cause-1-race-conditions">Cause 1: Race Conditions</h3>
<p><strong>Bad: Test with race condition</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_async_processing.py (FLAKY)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_process_items_concurrently</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test concurrent item processing (flaky).&quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_item</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>  <span class="c1"># Simulate async work</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">process_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">])</span>

    <span class="c1"># Flaky: Order is non-deterministic</span>
    <span class="k">assert</span> <span class="n">results</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
</code></pre></div>

<p><strong>Why it's flaky</strong>: The order in which async tasks complete is non-deterministic. Sometimes the test passes, sometimes it fails.</p>
<p><strong>Fix: Test behavior, not order</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_async_processing.py (FIXED)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_process_items_concurrently</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test concurrent item processing.&quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_item</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">process_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">])</span>

    <span class="c1"># Test behavior: all items processed (order doesn&#39;t matter)</span>
    <span class="k">assert</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
</code></pre></div>

<h3 id="cause-2-timing-dependencies">Cause 2: Timing Dependencies</h3>
<p><strong>Bad: Test with timing dependency</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_cache_expiration.py (FLAKY)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cache_expires_after_timeout</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that cache entries expire (flaky).&quot;&quot;&quot;</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="n">ttl</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># 1 second TTL</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;value&#39;</span>

    <span class="c1"># Wait for expiration</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># Flaky: Timing is imprecise</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
</code></pre></div>

<p><strong>Why it's flaky</strong>: <code>time.sleep(1.0)</code> doesn't guarantee exactly 1 second. On a slow CI server, it might be 0.99 seconds, and the test fails.</p>
<p><strong>Fix: Use explicit time control</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_cache_expiration.py (FIXED)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_cache_expires_after_timeout</span><span class="p">(</span><span class="n">freezer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that cache entries expire.&quot;&quot;&quot;</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="n">ttl</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;value&#39;</span>

    <span class="c1"># Fast-forward time (no actual waiting)</span>
    <span class="n">freezer</span><span class="o">.</span><span class="n">move_to</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mf">1.1</span><span class="p">))</span>

    <span class="c1"># Deterministic: Time is controlled</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
</code></pre></div>

<p><strong>Alternative: Use timeouts with margin</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_cache_expires_after_timeout</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that cache entries expire.&quot;&quot;&quot;</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="n">ttl</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;value&#39;</span>

    <span class="c1"># Wait longer than TTL with margin</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>

    <span class="c1"># More reliable with margin</span>
    <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
</code></pre></div>

<h3 id="cause-3-non-deterministic-behavior">Cause 3: Non-Deterministic Behavior</h3>
<p><strong>Bad: Test with random behavior</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_random_selection.py (FLAKY)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_select_random_item</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test random item selection (flaky).&quot;&quot;&quot;</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

    <span class="n">selected</span> <span class="o">=</span> <span class="n">select_random_item</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

    <span class="c1"># Flaky: Random selection</span>
    <span class="k">assert</span> <span class="n">selected</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>

<p><strong>Fix: Control randomness</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_random_selection.py (FIXED)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_select_random_item</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test random item selection.&quot;&quot;&quot;</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

    <span class="c1"># Seed random number generator for deterministic behavior</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

    <span class="n">selected</span> <span class="o">=</span> <span class="n">select_random_item</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

    <span class="c1"># Deterministic with seeded RNG</span>
    <span class="k">assert</span> <span class="n">selected</span> <span class="o">==</span> <span class="mi">3</span>  <span class="c1"># Known result with seed 42</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_select_random_item_returns_valid_item</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that random selection returns a valid item.&quot;&quot;&quot;</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

    <span class="n">selected</span> <span class="o">=</span> <span class="n">select_random_item</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

    <span class="c1"># Test behavior, not specific value</span>
    <span class="k">assert</span> <span class="n">selected</span> <span class="ow">in</span> <span class="n">items</span>
</code></pre></div>

<h3 id="cause-4-external-dependencies">Cause 4: External Dependencies</h3>
<p><strong>Bad: Test with external dependency</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_api_client.py (FLAKY)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_fetch_user_data</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test fetching user data from API (flaky).&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">APIClient</span><span class="p">(</span><span class="s2">&quot;https://api.example.com&quot;</span><span class="p">)</span>

    <span class="c1"># Flaky: Depends on external API being available</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;alice&#39;</span>
</code></pre></div>

<p><strong>Why it's flaky</strong>: External API might be down, slow, or return different data.</p>
<p><strong>Fix: Mock external dependencies</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_api_client.py (FIXED)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_fetch_user_data</span><span class="p">(</span><span class="n">mock_requests</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test fetching user data from API.&quot;&quot;&quot;</span>
    <span class="n">mock_requests</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;alice&#39;</span>
    <span class="p">}</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">APIClient</span><span class="p">(</span><span class="s2">&quot;https://api.example.com&quot;</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;alice&#39;</span>
</code></pre></div>

<h3 id="cause-5-test-order-dependencies">Cause 5: Test Order Dependencies</h3>
<p><strong>Bad: Tests depend on execution order</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_user_lifecycle.py (FLAKY)</span>
<span class="n">_user_id</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_user</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_user_id</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>
    <span class="n">_user_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_update_user</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_user_id</span>
    <span class="c1"># Flaky: Depends on test_create_user running first</span>
    <span class="n">update_user</span><span class="p">(</span><span class="n">_user_id</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;newemail@example.com&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Fix: Make tests independent</strong> (see section 20.3.4).</p>
<h3 id="detecting-flaky-tests">Detecting Flaky Tests</h3>
<p><strong>Run tests multiple times</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run each test 100 times</span>
$<span class="w"> </span>pytest<span class="w"> </span>--count<span class="o">=</span><span class="m">100</span><span class="w"> </span>tests/test_flaky.py
</code></pre></div>

<p><strong>Run tests in random order</strong>:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>--random-order<span class="w"> </span>tests/
</code></pre></div>

<p><strong>Run tests in parallel</strong>:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-n<span class="w"> </span>auto<span class="w"> </span>tests/
</code></pre></div>

<p>If tests fail with any of these approaches but pass normally, they're flaky.</p>
<h3 id="quarantining-flaky-tests">Quarantining Flaky Tests</h3>
<p>While fixing flaky tests, quarantine them so they don't block CI:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">pytest_configure</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">addinivalue_line</span><span class="p">(</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span> <span class="s2">&quot;flaky: known flaky test (quarantined)&quot;</span><span class="p">)</span>

<span class="c1"># tests/test_flaky.py</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">flaky</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_sometimes_fails</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This test is flaky and needs fixing.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div>

<p>Run tests excluding flaky ones:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;not flaky&quot;</span>
</code></pre></div>

<p>Run only flaky tests to debug them:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span>flaky<span class="w"> </span>--count<span class="o">=</span><span class="m">100</span>
</code></pre></div>

<h2 id="ignoring-test-maintenance">Ignoring Test Maintenance</h2>
<h2 id="the-technical-debt-problem">The Technical Debt Problem</h2>
<p>Tests are code. Like all code, they need maintenance. Ignoring test maintenance leads to:
- Slow test suites
- Brittle tests that break on refactoring
- Duplicate test code
- Outdated tests that don't reflect current behavior</p>
<h3 id="symptom-1-slow-test-suite">Symptom 1: Slow Test Suite</h3>
<p><strong>Problem</strong>: Test suite takes 45 minutes to run, slowing down development.</p>
<p><strong>Diagnosis</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Find slowest tests</span>
$<span class="w"> </span>pytest<span class="w"> </span>--durations<span class="o">=</span><span class="m">20</span>
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== slowest 20 durations ========================
45.23s call     tests/test_report_generation.py::test_generate_annual_report
32.11s call     tests/test_email.py::test_send_bulk_emails
28.45s call     tests/test_data_import.py::test_import_large_dataset
12.34s call     tests/test_api_integration.py::test_full_api_flow
...
</code></pre></div>

<p><strong>Solutions</strong>:</p>
<ol>
<li><strong>Optimize slow tests</strong>:</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># Before: Slow test</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_generate_annual_report</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate report for entire year (45 seconds).&quot;&quot;&quot;</span>
    <span class="n">report</span> <span class="o">=</span> <span class="n">generate_report</span><span class="p">(</span>
        <span class="n">start_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">end_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">report</span><span class="o">.</span><span class="n">total_revenue</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="c1"># After: Fast test</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_generate_report_calculates_revenue</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate report for one day (0.5 seconds).&quot;&quot;&quot;</span>
    <span class="n">report</span> <span class="o">=</span> <span class="n">generate_report</span><span class="p">(</span>
        <span class="n">start_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">end_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">report</span><span class="o">.</span><span class="n">total_revenue</span> <span class="o">&gt;</span> <span class="mi">0</span>
</code></pre></div>

<ol>
<li><strong>Mark slow tests and run them separately</strong>:</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">slow</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_generate_annual_report</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate report for entire year.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># Fast tests (run constantly)</span>
$<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;not slow&quot;</span>

<span class="c1"># Slow tests (run nightly)</span>
$<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span>slow
</code></pre></div>

<ol>
<li><strong>Use fixtures to share expensive setup</strong>:</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># Before: Each test creates database</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_query_users</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">create_test_database</span><span class="p">()</span>  <span class="c1"># 5 seconds</span>
    <span class="c1"># ... test</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_query_orders</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">create_test_database</span><span class="p">()</span>  <span class="c1"># 5 seconds</span>
    <span class="c1"># ... test</span>

<span class="c1"># After: Share database across tests</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_database</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">create_test_database</span><span class="p">()</span>  <span class="c1"># 5 seconds once</span>
    <span class="k">yield</span> <span class="n">db</span>
    <span class="n">db</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_query_users</span><span class="p">(</span><span class="n">test_database</span><span class="p">):</span>
    <span class="c1"># ... test (no setup time)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_query_orders</span><span class="p">(</span><span class="n">test_database</span><span class="p">):</span>
    <span class="c1"># ... test (no setup time)</span>
</code></pre></div>

<h3 id="symptom-2-duplicate-test-code">Symptom 2: Duplicate Test Code</h3>
<p><strong>Problem</strong>: Same test logic repeated across multiple files.</p>
<p><strong>Example</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_user_api.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_create_user_api</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s2">&quot;alice&quot;</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="s2">&quot;alice@example.com&quot;</span>

<span class="c1"># tests/test_user_service.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_create_user_service</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s2">&quot;alice&quot;</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="s2">&quot;alice@example.com&quot;</span>

<span class="c1"># tests/test_user_model.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_create_user_model</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s2">&quot;alice&quot;</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="s2">&quot;alice@example.com&quot;</span>
</code></pre></div>

<p><strong>Solution: Extract common assertions</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/helpers.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">assert_valid_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">expected_username</span><span class="p">,</span> <span class="n">expected_email</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Assert that user object is valid.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">expected_username</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">expected_email</span>

<span class="c1"># tests/test_user_api.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_create_user_api</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="n">assert_valid_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>

<span class="c1"># tests/test_user_service.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_create_user_service</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="n">assert_valid_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="symptom-3-outdated-tests">Symptom 3: Outdated Tests</h3>
<p><strong>Problem</strong>: Tests pass but don't reflect current behavior.</p>
<p><strong>Example</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_order_processing.py (written 2 years ago)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test order processing.&quot;&quot;&quot;</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">create_order</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;product_id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}])</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">process_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

    <span class="c1"># Test written before we added tax calculation</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">total</span> <span class="o">==</span> <span class="mf">20.0</span>  <span class="c1"># Wrong: Doesn&#39;t include tax</span>
</code></pre></div>

<p><strong>Solution: Regular test review</strong>:</p>
<ol>
<li><strong>Review tests when code changes</strong>:</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># When adding tax calculation, update tests</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test order processing with tax.&quot;&quot;&quot;</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">create_order</span><span class="p">(</span>
        <span class="n">items</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;product_id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}],</span>
        <span class="n">shipping_state</span><span class="o">=</span><span class="s1">&#39;CA&#39;</span>
    <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">process_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

    <span class="c1"># Updated to include tax</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">subtotal</span> <span class="o">==</span> <span class="mf">20.0</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">tax</span> <span class="o">==</span> <span class="mf">1.45</span>  <span class="c1"># 7.25% of $20</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">total</span> <span class="o">==</span> <span class="mf">21.45</span>
</code></pre></div>

<ol>
<li><strong>Add tests for new features</strong>:</li>
</ol>
<p>When adding a feature, add tests for it. Don't just modify existing tests.</p>
<ol>
<li><strong>Remove obsolete tests</strong>:</li>
</ol>
<p>If a feature is removed, remove its tests. Don't leave dead code.</p>
<h3 id="symptom-4-brittle-tests">Symptom 4: Brittle Tests</h3>
<p><strong>Problem</strong>: Tests break when you refactor, even though behavior is unchanged.</p>
<p><strong>Example</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Before refactoring</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OrderProcessor</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_total</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_charge_payment</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">order</span>

<span class="c1"># Brittle test</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order</span><span class="p">():</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">OrderProcessor</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="s1">&#39;_validate&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_validate</span><span class="p">,</span> \
         <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="s1">&#39;_calculate_total&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_calc</span><span class="p">,</span> \
         <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="s1">&#39;_charge_payment&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_charge</span><span class="p">:</span>

        <span class="n">processor</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

        <span class="c1"># Tests implementation details</span>
        <span class="n">mock_validate</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
        <span class="n">mock_calc</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
        <span class="n">mock_charge</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
</code></pre></div>

<p><strong>After refactoring</strong> (behavior unchanged):</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">OrderProcessor</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="c1"># Refactored: Combined validation and calculation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_charge_payment</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">order</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_total</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
</code></pre></div>

<p><strong>Test breaks</strong> even though behavior is identical.</p>
<p><strong>Solution: Test behavior, not implementation</strong> (see section 20.4.2).</p>
<h3 id="test-maintenance-checklist">Test Maintenance Checklist</h3>
<p><strong>Weekly</strong>:
- [ ] Review failed tests in CI
- [ ] Fix or quarantine flaky tests
- [ ] Check test execution time</p>
<p><strong>Monthly</strong>:
- [ ] Review slowest tests
- [ ] Identify and remove duplicate test code
- [ ] Update tests for new features</p>
<p><strong>Quarterly</strong>:
- [ ] Review test coverage
- [ ] Remove obsolete tests
- [ ] Refactor brittle tests
- [ ] Update test documentation</p>
<h2 id="coverage-theater">Coverage Theater</h2>
<h2 id="the-coverage-illusion">The Coverage Illusion</h2>
<p>High code coverage doesn't guarantee good tests. You can have 100% coverage with tests that don't actually verify anything.</p>
<p><strong>Bad: High coverage, low value</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/calculator.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_total</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">tax_rate</span><span class="o">=</span><span class="mf">0.0725</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate order total with tax.&quot;&quot;&quot;</span>
    <span class="n">subtotal</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">)</span>
    <span class="n">tax</span> <span class="o">=</span> <span class="n">subtotal</span> <span class="o">*</span> <span class="n">tax_rate</span>
    <span class="k">return</span> <span class="n">subtotal</span> <span class="o">+</span> <span class="n">tax</span>

<span class="c1"># tests/test_calculator.py (BAD)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_total</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test calculate_total function.&quot;&quot;&quot;</span>
    <span class="c1"># This test achieves 100% coverage but doesn&#39;t verify correctness</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">calculate_total</span><span class="p">([{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}])</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># Useless assertion</span>
</code></pre></div>

<p><strong>Coverage report</strong>:</p>
<div class="codehilite"><pre><span></span><code>src/calculator.py    100%    (all lines covered)
</code></pre></div>

<p><strong>But the test doesn't verify</strong>:
- Correct calculation
- Tax rate application
- Edge cases (empty list, zero prices, etc.)</p>
<p><strong>Good: Meaningful tests</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_calculator.py (GOOD)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_total_with_single_item</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test total calculation with one item.&quot;&quot;&quot;</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">calculate_total</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">tax_rate</span><span class="o">=</span><span class="mf">0.0725</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="mf">21.45</span>  <span class="c1"># 20.00 + 1.45 tax</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_total_with_multiple_items</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test total calculation with multiple items.&quot;&quot;&quot;</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">calculate_total</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">tax_rate</span><span class="o">=</span><span class="mf">0.0725</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="mf">37.54</span>  <span class="c1"># 35.00 + 2.54 tax</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_total_with_zero_tax</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test total calculation with no tax.&quot;&quot;&quot;</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">calculate_total</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">tax_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="mf">20.0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_total_with_empty_list</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test total calculation with no items.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">calculate_total</span><span class="p">([],</span> <span class="n">tax_rate</span><span class="o">=</span><span class="mf">0.0725</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="mf">0.0</span>
</code></pre></div>

<p><strong>Coverage report</strong> (same 100%, but meaningful):</p>
<div class="codehilite"><pre><span></span><code>src/calculator.py    100%    (all lines covered with meaningful tests)
</code></pre></div>

<h3 id="signs-of-coverage-theater">Signs of Coverage Theater</h3>
<p><strong>1. Tests that don't assert anything meaningful</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Achieves coverage but doesn&#39;t test anything</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_function_runs</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">complex_function</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># Useless</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>  <span class="c1"># Barely useful</span>
</code></pre></div>

<p><strong>2. Tests that only test happy paths</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Only tests success case</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_divide</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">divide</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>

<span class="c1"># Missing: What about divide(10, 0)?</span>
</code></pre></div>

<p><strong>3. Tests that mock everything</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Mocks away all logic</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_order</span><span class="p">():</span>
    <span class="n">mock_everything</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_everything</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">process_order</span><span class="p">(</span><span class="n">mock_everything</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span>  <span class="c1"># Tests nothing</span>
</code></pre></div>

<p><strong>4. Coverage goals without quality goals</strong>:</p>
<div class="codehilite"><pre><span></span><code># Bad: Focus on coverage percentage
&quot;We need 90% coverage!&quot;

# Good: Focus on test quality
&quot;We need tests that catch bugs and document behavior.&quot;
</code></pre></div>

<h3 id="meaningful-coverage-metrics">Meaningful Coverage Metrics</h3>
<p><strong>Instead of raw coverage percentage, track</strong>:</p>
<ol>
<li><strong>Mutation testing score</strong>: How many bugs do your tests catch?</li>
</ol>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>mutmut
$<span class="w"> </span>mutmut<span class="w"> </span>run
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>Mutations: 100
Killed: 85 (85%)
Survived: 15 (15%)
</code></pre></div>

<p><strong>Interpretation</strong>: Your tests catch 85% of introduced bugs. The 15% that survive indicate gaps in test quality.</p>
<ol>
<li><strong>Branch coverage</strong>: Are all code paths tested?</li>
</ol>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>--cov<span class="o">=</span>src<span class="w"> </span>--cov-report<span class="o">=</span>term-missing<span class="w"> </span>--cov-branch
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>src/calculator.py    85%    (missing branches: 23-&gt;25, 30-&gt;32)
</code></pre></div>

<p><strong>Interpretation</strong>: Lines 23-25 and 30-32 have untested branches (e.g., if/else conditions).</p>
<ol>
<li><strong>Critical path coverage</strong>: Are the most important features tested?</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># Mark critical paths</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">critical</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_processing</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test payment processing (critical path).&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">critical</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_user_authentication</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test user authentication (critical path).&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div>

<p><strong>Verify critical paths are covered</strong>:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-m<span class="w"> </span>critical<span class="w"> </span>--cov<span class="o">=</span>src<span class="w"> </span>--cov-report<span class="o">=</span>term
</code></pre></div>

<h3 id="using-coverage-correctly">Using Coverage Correctly</h3>
<p><strong>1. Use coverage to find untested code</strong>:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>--cov<span class="o">=</span>src<span class="w"> </span>--cov-report<span class="o">=</span>html
$<span class="w"> </span>open<span class="w"> </span>htmlcov/index.html
</code></pre></div>

<p>Look for red (untested) lines. Ask: "Should this code be tested?"</p>
<p><strong>2. Don't aim for 100% coverage</strong>:</p>
<p>Some code doesn't need tests:
- Trivial getters/setters
- Framework boilerplate
- Code that's tested indirectly</p>
<p><strong>3. Focus on coverage of critical code</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># High-value tests</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_payment_processing</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test payment processing (critical).&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_data_validation</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test data validation (prevents corruption).&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="c1"># Low-value tests</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_getter</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test simple getter (low value).&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Alice&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Alice&quot;</span>  <span class="c1"># Trivial</span>
</code></pre></div>

<p><strong>4. Use coverage as a guide, not a goal</strong>:</p>
<div class="codehilite"><pre><span></span><code># Bad: Coverage-driven development
&quot;We need 90% coverage, so let&#39;s write tests until we hit 90%.&quot;

# Good: Quality-driven development
&quot;Let&#39;s write tests that verify critical behavior and catch bugs.
 Coverage will naturally increase as a side effect.&quot;
</code></pre></div>

<h2 id="tests-that-pass-when-they-shouldnt">Tests That Pass When They Shouldn't</h2>
<h2 id="the-false-positive-problem">The False Positive Problem</h2>
<p>The worst kind of test is one that passes when the code is broken. These tests give false confidence and hide bugs.</p>
<p><strong>Example 1: Incorrect assertion</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_user_creation.py (BAD)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_create_user_assigns_id</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that creating a user assigns an ID.&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>

    <span class="c1"># Bug: This always passes</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">or</span> <span class="kc">True</span>  <span class="c1"># Always True!</span>
</code></pre></div>

<p><strong>The code could be completely broken, but the test passes.</strong></p>
<p><strong>Fix</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_create_user_assigns_id</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that creating a user assigns an ID.&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">0</span>
</code></pre></div>

<p><strong>Example 2: Catching wrong exception</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_validation.py (BAD)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_email_raises_error</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that invalid email raises ValidationError.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>  <span class="c1"># Too broad!</span>
        <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Problem</strong>: This test passes if ANY exception is raised, not just ValidationError. If the code raises KeyError or AttributeError, the test still passes.</p>
<p><strong>Fix</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_email_raises_validation_error</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that invalid email raises ValidationError.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Invalid email&quot;</span><span class="p">):</span>
        <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Example 3: Mock that doesn't match reality</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_payment.py (BAD)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test payment processing.&quot;&quot;&quot;</span>
    <span class="n">mock_gateway</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="c1"># Mock returns success, but real gateway returns different structure</span>
    <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">gateway</span><span class="o">=</span><span class="n">mock_gateway</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">amount</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span>
</code></pre></div>

<p><strong>Problem</strong>: Real payment gateway returns <code>{'status': 'completed', 'transaction_id': '...'}</code>, not <code>{'success': True}</code>. Test passes, but production code breaks.</p>
<p><strong>Fix: Use realistic mocks</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test payment processing.&quot;&quot;&quot;</span>
    <span class="n">mock_gateway</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="c1"># Mock matches real gateway response</span>
    <span class="n">mock_gateway</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;completed&#39;</span><span class="p">,</span>
        <span class="s1">&#39;transaction_id&#39;</span><span class="p">:</span> <span class="s1">&#39;txn_123&#39;</span><span class="p">,</span>
        <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="mf">100.0</span>
    <span class="p">}</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">gateway</span><span class="o">=</span><span class="n">mock_gateway</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">amount</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;completed&#39;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">transaction_id</span> <span class="o">==</span> <span class="s1">&#39;txn_123&#39;</span>
</code></pre></div>

<p><strong>Example 4: Test that doesn't actually call the code</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_calculator.py (BAD)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_total</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test total calculation.&quot;&quot;&quot;</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}]</span>

    <span class="c1"># Bug: Forgot to call the function!</span>
    <span class="c1"># result = calculate_total(items)</span>

    <span class="c1"># This assertion always passes</span>
    <span class="k">assert</span> <span class="kc">True</span>
</code></pre></div>

<p><strong>Fix: Actually call the function</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_total</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test total calculation.&quot;&quot;&quot;</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">calculate_total</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="mf">21.45</span>
</code></pre></div>

<h3 id="detecting-false-positives">Detecting False Positives</h3>
<p><strong>1. Mutation testing</strong>:</p>
<p>Introduce bugs and verify tests fail:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>mutmut
$<span class="w"> </span>mutmut<span class="w"> </span>run
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>Mutation survived: Changed &#39;return subtotal + tax&#39; to &#39;return subtotal - tax&#39;
Test test_calculate_total still passed!
</code></pre></div>

<p><strong>Interpretation</strong>: The test doesn't catch this bug. It's a false positive.</p>
<p><strong>2. Temporarily break the code</strong>:</p>
<p>Manually introduce a bug and verify the test fails:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># src/calculator.py (temporarily broken)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_total</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">tax_rate</span><span class="o">=</span><span class="mf">0.0725</span><span class="p">):</span>
    <span class="n">subtotal</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">)</span>
    <span class="n">tax</span> <span class="o">=</span> <span class="n">subtotal</span> <span class="o">*</span> <span class="n">tax_rate</span>
    <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># Bug: Always return 0</span>
</code></pre></div>

<p>Run the test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_calculator.py::test_calculate_total
</code></pre></div>

<p><strong>If the test passes, it's a false positive.</strong></p>
<p><strong>3. Review test assertions</strong>:</p>
<p>Look for weak assertions:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Weak assertions (likely false positives)</span>
<span class="k">assert</span> <span class="n">result</span>  <span class="c1"># Too vague</span>
<span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># Barely useful</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>  <span class="c1"># Doesn&#39;t verify content</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="c1"># Doesn&#39;t verify correctness</span>

<span class="c1"># Strong assertions</span>
<span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">expected_value</span>
<span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;completed&#39;</span>
<span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">total</span> <span class="o">==</span> <span class="mf">21.45</span>
</code></pre></div>

<h3 id="preventing-false-positives">Preventing False Positives</h3>
<p><strong>1. Write the test first (TDD)</strong>:</p>
<p>If you write the test before the code, you'll see it fail first:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Step 1: Write test (it fails because code doesn&#39;t exist)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_total</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">calculate_total</span><span class="p">([{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}])</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="mf">21.45</span>

<span class="c1"># Step 2: Write code to make it pass</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_total</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">tax_rate</span><span class="o">=</span><span class="mf">0.0725</span><span class="p">):</span>
    <span class="n">subtotal</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">)</span>
    <span class="n">tax</span> <span class="o">=</span> <span class="n">subtotal</span> <span class="o">*</span> <span class="n">tax_rate</span>
    <span class="k">return</span> <span class="n">subtotal</span> <span class="o">+</span> <span class="n">tax</span>

<span class="c1"># Step 3: Verify test passes</span>
</code></pre></div>

<p><strong>2. Use specific assertions</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Vague assertion</span>
<span class="k">assert</span> <span class="n">result</span>

<span class="c1"># Good: Specific assertion</span>
<span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;completed&#39;</span>
<span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">transaction_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;txn_&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">amount</span> <span class="o">==</span> <span class="mf">100.0</span>
</code></pre></div>

<p><strong>3. Test error cases</strong>:</p>
<p>Don't just test success. Test failures too:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_divide_by_zero_raises_error</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that division by zero raises an error.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ZeroDivisionError</span><span class="p">):</span>
        <span class="n">divide</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_input_raises_validation_error</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that invalid input raises ValidationError.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Invalid email&quot;</span><span class="p">):</span>
        <span class="n">create_user</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>4. Use pytest's strict mode</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># pytest.ini</span>
<span class="k">[pytest]</span>
<span class="c1"># Fail on warnings</span>
<span class="na">filterwarnings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">error</span>

<span class="c1"># Fail on unraisable exceptions</span>
<span class="na">pythonwarnings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">error</span>
</code></pre></div>

<p>This catches issues that might otherwise be silently ignored.</p>
<h2 id="where-to-go-from-here">Where to Go From Here</h2>
<p>You've completed the journey from pytest beginner to advanced practitioner. You've learned:</p>
<ul>
<li>Core pytest features (fixtures, parametrization, markers)</li>
<li>Advanced techniques (mocking, async testing, property-based testing)</li>
<li>Real-world patterns (legacy code testing, microservices, large codebases)</li>
<li>Best practices and common pitfalls</li>
</ul>
<h2 id="continuing-your-testing-journey">Continuing Your Testing Journey</h2>
<h3 id="1-practice-deliberately">1. Practice Deliberately</h3>
<p><strong>Apply what you've learned</strong>:
- Refactor one test file in your current project using best practices
- Add property-based tests to a critical function
- Set up contract testing for a microservice
- Implement test impact analysis for faster feedback</p>
<p><strong>Start small</strong>: Don't try to apply everything at once. Pick one technique per week and master it.</p>
<h3 id="2-contribute-to-open-source">2. Contribute to Open Source</h3>
<p><strong>Learn from others</strong>:
- Read test suites of popular Python projects (Django, Flask, Requests)
- Contribute tests to open source projects
- Review pull requests that add or modify tests</p>
<p><strong>Projects with excellent test suites</strong>:
- <strong>pytest itself</strong>: https://github.com/pytest-dev/pytest
- <strong>Requests</strong>: https://github.com/psf/requests
- <strong>Django</strong>: https://github.com/django/django
- <strong>FastAPI</strong>: https://github.com/tiangolo/fastapi</p>
<h3 id="3-explore-advanced-topics">3. Explore Advanced Topics</h3>
<p><strong>Beyond this book</strong>:</p>
<p><strong>Property-Based Testing</strong>:
- Hypothesis documentation: https://hypothesis.readthedocs.io/
- "Property-Based Testing with PropEr, Erlang, and Elixir" by Fred Hebert</p>
<p><strong>Mutation Testing</strong>:
- mutmut: https://github.com/boxed/mutmut
- cosmic-ray: https://github.com/sixty-north/cosmic-ray</p>
<p><strong>Contract Testing</strong>:
- Pact documentation: https://docs.pact.io/
- Spring Cloud Contract (for polyglot systems)</p>
<p><strong>Performance Testing</strong>:
- pytest-benchmark: https://pytest-benchmark.readthedocs.io/
- locust (load testing): https://locust.io/</p>
<h3 id="4-build-your-testing-toolkit">4. Build Your Testing Toolkit</h3>
<p><strong>Essential pytest plugins</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Core plugins</span>
pip<span class="w"> </span>install<span class="w"> </span>pytest-cov<span class="w">          </span><span class="c1"># Coverage reporting</span>
pip<span class="w"> </span>install<span class="w"> </span>pytest-xdist<span class="w">        </span><span class="c1"># Parallel execution</span>
pip<span class="w"> </span>install<span class="w"> </span>pytest-asyncio<span class="w">      </span><span class="c1"># Async test support</span>
pip<span class="w"> </span>install<span class="w"> </span>pytest-mock<span class="w">         </span><span class="c1"># Enhanced mocking</span>

<span class="c1"># Productivity plugins</span>
pip<span class="w"> </span>install<span class="w"> </span>pytest-watch<span class="w">        </span><span class="c1"># Auto-run tests</span>
pip<span class="w"> </span>install<span class="w"> </span>pytest-sugar<span class="w">        </span><span class="c1"># Better output</span>
pip<span class="w"> </span>install<span class="w"> </span>pytest-html<span class="w">         </span><span class="c1"># HTML reports</span>

<span class="c1"># Advanced plugins</span>
pip<span class="w"> </span>install<span class="w"> </span>pytest-benchmark<span class="w">   </span><span class="c1"># Performance testing</span>
pip<span class="w"> </span>install<span class="w"> </span>hypothesis<span class="w">         </span><span class="c1"># Property-based testing</span>
pip<span class="w"> </span>install<span class="w"> </span>pytest-timeout<span class="w">     </span><span class="c1"># Prevent hanging tests</span>
pip<span class="w"> </span>install<span class="w"> </span>pytest-randomly<span class="w">    </span><span class="c1"># Randomize test order</span>
</code></pre></div>

<h3 id="5-stay-current">5. Stay Current</h3>
<p><strong>Follow pytest development</strong>:
- pytest changelog: https://docs.pytest.org/en/stable/changelog.html
- pytest blog: https://pytest.org/blog/
- pytest on Twitter: @pytestdotorg</p>
<p><strong>Join the community</strong>:
- pytest Discord: https://discord.gg/pytest
- pytest mailing list: pytest-dev@python.org
- Stack Overflow: [pytest] tag</p>
<h3 id="6-teach-others">6. Teach Others</h3>
<p><strong>The best way to master testing</strong>:
- Write blog posts about testing techniques you've learned
- Give talks at local Python meetups
- Mentor junior developers on testing practices
- Conduct code reviews focused on test quality</p>
<p><strong>Teaching solidifies your understanding and helps the community.</strong></p>
<h3 id="7-measure-your-progress">7. Measure Your Progress</h3>
<p><strong>Track your testing maturity</strong>:</p>
<p><strong>Level 1: Beginner</strong>
- [ ] Can write basic test functions
- [ ] Understands assertions
- [ ] Can run tests with pytest</p>
<p><strong>Level 2: Intermediate</strong>
- [ ] Uses fixtures effectively
- [ ] Writes parametrized tests
- [ ] Understands test organization
- [ ] Can mock external dependencies</p>
<p><strong>Level 3: Advanced</strong>
- [ ] Writes property-based tests
- [ ] Implements contract testing
- [ ] Optimizes test suite performance
- [ ] Mentors others on testing</p>
<p><strong>Level 4: Expert</strong>
- [ ] Designs testing strategies for large systems
- [ ] Contributes to pytest or plugins
- [ ] Writes about testing practices
- [ ] Influences team testing culture</p>
<h2 id="final-thoughts">Final Thoughts</h2>
<p>Testing is not just about finding bugs‚Äîit's about:
- <strong>Confidence</strong>: Knowing your code works
- <strong>Documentation</strong>: Tests describe how code should behave
- <strong>Design</strong>: Tests reveal design problems
- <strong>Refactoring</strong>: Tests enable safe changes
- <strong>Communication</strong>: Tests communicate intent to other developers</p>
<p><strong>The best tests are</strong>:
- <strong>Fast</strong>: Run in milliseconds, not minutes
- <strong>Isolated</strong>: Independent of each other
- <strong>Repeatable</strong>: Same result every time
- <strong>Self-validating</strong>: Pass or fail clearly
- <strong>Timely</strong>: Written close to the code they test</p>
<p><strong>Remember</strong>:
- Perfect is the enemy of good. Start with simple tests and improve over time.
- Tests are code. Apply the same quality standards to tests as to production code.
- Coverage is a tool, not a goal. Focus on meaningful tests, not percentages.
- Flaky tests are worse than no tests. Fix or remove them.
- Tests should help you move faster, not slower. If they don't, something is wrong.</p>
<p><strong>You now have the knowledge to write excellent tests. Go forth and test with confidence!</strong></p>
<h2 id="cheat-sheet-common-pytest-commands-and-patterns">Cheat Sheet: Common Pytest Commands and Patterns</h2>
<h2 id="quick-reference">Quick Reference</h2>
<h3 id="running-tests">Running Tests</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run all tests</span>
pytest

<span class="c1"># Run tests in a specific file</span>
pytest<span class="w"> </span>tests/test_user.py

<span class="c1"># Run a specific test function</span>
pytest<span class="w"> </span>tests/test_user.py::test_create_user

<span class="c1"># Run tests matching a pattern</span>
pytest<span class="w"> </span>-k<span class="w"> </span><span class="s2">&quot;user and not delete&quot;</span>

<span class="c1"># Run tests with a specific marker</span>
pytest<span class="w"> </span>-m<span class="w"> </span>slow

<span class="c1"># Run tests in parallel</span>
pytest<span class="w"> </span>-n<span class="w"> </span>auto

<span class="c1"># Run with verbose output</span>
pytest<span class="w"> </span>-v

<span class="c1"># Run with extra verbose output</span>
pytest<span class="w"> </span>-vv

<span class="c1"># Stop on first failure</span>
pytest<span class="w"> </span>-x

<span class="c1"># Run last failed tests</span>
pytest<span class="w"> </span>--lf

<span class="c1"># Run failed tests first, then others</span>
pytest<span class="w"> </span>--ff

<span class="c1"># Show local variables in tracebacks</span>
pytest<span class="w"> </span>-l

<span class="c1"># Drop into debugger on failure</span>
pytest<span class="w"> </span>--pdb

<span class="c1"># Run tests and show coverage</span>
pytest<span class="w"> </span>--cov<span class="o">=</span>src<span class="w"> </span>--cov-report<span class="o">=</span>term-missing
</code></pre></div>

<h3 id="writing-tests">Writing Tests</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Basic test</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_example</span><span class="p">():</span>
    <span class="k">assert</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">2</span>

<span class="c1"># Test with fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_with_fixture</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">db_session</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="c1"># Parametrized test</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;input,expected&quot;</span><span class="p">,</span> <span class="p">[</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
<span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_double</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">double</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected</span>

<span class="c1"># Test exception</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_raises_error</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Invalid&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid input&quot;</span><span class="p">)</span>

<span class="c1"># Test with multiple assertions</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_user_creation</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s2">&quot;alice&quot;</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">created_at</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="c1"># Skip test</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Not implemented yet&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_future_feature</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="c1"># Skip test conditionally</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">skipif</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Requires Python 3.8+&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_new_feature</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="c1"># Expected failure</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">xfail</span><span class="p">(</span><span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Known bug&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_known_bug</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">buggy_function</span><span class="p">()</span> <span class="o">==</span> <span class="n">expected_value</span>
</code></pre></div>

<h3 id="fixtures">Fixtures</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Basic fixture</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>

<span class="c1"># Fixture with setup and teardown</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_session</span><span class="p">():</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">create_session</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">session</span>
    <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Fixture with scope</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">database</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">create_database</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">db</span>
    <span class="n">db</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span>

<span class="c1"># Fixture that uses another fixture</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticated_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">auth_service</span><span class="p">):</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">auth_service</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="n">token</span>

<span class="c1"># Factory fixture</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user_factory</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_user</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">create_user</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_create_user</span>

<span class="c1"># Autouse fixture</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">reset_state</span><span class="p">():</span>
    <span class="n">global_state</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">yield</span>
    <span class="n">global_state</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></pre></div>

<h3 id="mocking">Mocking</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Mock with unittest.mock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>

<span class="c1"># Create a mock</span>
<span class="n">mock_service</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
<span class="n">mock_service</span><span class="o">.</span><span class="n">get_user</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;alice&#39;</span><span class="p">}</span>

<span class="c1"># Patch a function</span>
<span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;module.function&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_func</span><span class="p">:</span>
    <span class="n">mock_func</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">42</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">call_function_that_uses_function</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">42</span>

<span class="c1"># Patch as decorator</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;module.function&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_with_patch</span><span class="p">(</span><span class="n">mock_func</span><span class="p">):</span>
    <span class="n">mock_func</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">42</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">call_function_that_uses_function</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">42</span>

<span class="c1"># Mock side effects</span>
<span class="n">mock_service</span><span class="o">.</span><span class="n">get_user</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
    <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
<span class="p">]</span>

<span class="c1"># Assert mock was called</span>
<span class="n">mock_service</span><span class="o">.</span><span class="n">get_user</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
<span class="n">mock_service</span><span class="o">.</span><span class="n">get_user</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">mock_service</span><span class="o">.</span><span class="n">get_user</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Check call count</span>
<span class="k">assert</span> <span class="n">mock_service</span><span class="o">.</span><span class="n">get_user</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">3</span>
</code></pre></div>

<h3 id="markers">Markers</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Built-in markers</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">skip</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">skipif</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">xfail</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;arg&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

<span class="c1"># Custom markers (define in pytest.ini)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">slow</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">integration</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">unit</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">smoke</span>

<span class="c1"># Multiple markers</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">slow</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">integration</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_complex_integration</span><span class="p">():</span>
    <span class="k">pass</span>
</code></pre></div>

<h3 id="configuration-pytestini">Configuration (pytest.ini)</h3>
<div class="codehilite"><pre><span></span><code><span class="k">[pytest]</span>
<span class="c1"># Test discovery patterns</span>
<span class="na">python_files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">test_*.py *_test.py</span>
<span class="na">python_classes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">Test*</span>
<span class="na">python_functions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">test_*</span>

<span class="c1"># Add options to all test runs</span>
<span class="na">addopts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">-v --strict-markers --cov=src</span>

<span class="c1"># Markers</span>
<span class="na">markers</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="na">slow</span><span class="o">:</span><span class="w"> </span><span class="s">marks tests as slow (deselect with &#39;-m &quot;not slow&quot;&#39;)</span>
<span class="w">    </span><span class="na">integration</span><span class="o">:</span><span class="w"> </span><span class="s">marks tests as integration tests</span>
<span class="w">    </span><span class="na">unit</span><span class="o">:</span><span class="w"> </span><span class="s">marks tests as unit tests</span>

<span class="c1"># Minimum Python version</span>
<span class="na">minversion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">3.8</span>

<span class="c1"># Test paths</span>
<span class="na">testpaths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">tests</span>

<span class="c1"># Ignore paths</span>
<span class="na">norecursedirs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">.git .tox dist build *.egg</span>
</code></pre></div>

<h3 id="common-patterns">Common Patterns</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Test database operations</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_session</span><span class="p">():</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">create_session</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">session</span>
    <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_create_user</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="c1"># Test async code</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_async_function</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">async_function</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">expected</span>

<span class="c1"># Test with temporary files</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_file_operations</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;test.txt&quot;</span>
    <span class="n">file_path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">file_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;content&quot;</span>

<span class="c1"># Test with environment variables</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_with_env_var</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;API_KEY&quot;</span><span class="p">,</span> <span class="s2">&quot;test_key&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">function_that_uses_env_var</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="c1"># Test with time control</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_with_frozen_time</span><span class="p">(</span><span class="n">freezer</span><span class="p">):</span>
    <span class="n">freezer</span><span class="o">.</span><span class="n">move_to</span><span class="p">(</span><span class="s2">&quot;2024-01-01 12:00:00&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">function_that_uses_current_time</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="n">date</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Test with captured output</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_print_output</span><span class="p">(</span><span class="n">capsys</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hello, World!&quot;</span><span class="p">)</span>
    <span class="n">captured</span> <span class="o">=</span> <span class="n">capsys</span><span class="o">.</span><span class="n">readouterr</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s2">&quot;Hello&quot;</span> <span class="ow">in</span> <span class="n">captured</span><span class="o">.</span><span class="n">out</span>
</code></pre></div>

<h3 id="debugging-tests">Debugging Tests</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Show print statements</span>
pytest<span class="w"> </span>-s

<span class="c1"># Show local variables on failure</span>
pytest<span class="w"> </span>-l

<span class="c1"># Drop into debugger on failure</span>
pytest<span class="w"> </span>--pdb

<span class="c1"># Drop into debugger at start of test</span>
pytest<span class="w"> </span>--trace

<span class="c1"># Show full diff on assertion failure</span>
pytest<span class="w"> </span>-vv

<span class="c1"># Show test durations</span>
pytest<span class="w"> </span>--durations<span class="o">=</span><span class="m">10</span>

<span class="c1"># Run with warnings</span>
pytest<span class="w"> </span>-W<span class="w"> </span>error

<span class="c1"># Verbose output with full tracebacks</span>
pytest<span class="w"> </span>-vv<span class="w"> </span>--tb<span class="o">=</span>long
</code></pre></div>

<h3 id="performance-optimization">Performance Optimization</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run tests in parallel</span>
pytest<span class="w"> </span>-n<span class="w"> </span>auto

<span class="c1"># Run only fast tests</span>
pytest<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;not slow&quot;</span>

<span class="c1"># Run with test impact analysis</span>
pytest<span class="w"> </span>--lf<span class="w"> </span>--ff

<span class="c1"># Profile test execution</span>
pytest<span class="w"> </span>--durations<span class="o">=</span><span class="m">0</span>

<span class="c1"># Use pytest-xdist with load balancing</span>
pytest<span class="w"> </span>-n<span class="w"> </span>auto<span class="w"> </span>--dist<span class="w"> </span>loadscope
</code></pre></div>

<h3 id="coverage">Coverage</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Basic coverage</span>
pytest<span class="w"> </span>--cov<span class="o">=</span>src

<span class="c1"># Coverage with missing lines</span>
pytest<span class="w"> </span>--cov<span class="o">=</span>src<span class="w"> </span>--cov-report<span class="o">=</span>term-missing

<span class="c1"># HTML coverage report</span>
pytest<span class="w"> </span>--cov<span class="o">=</span>src<span class="w"> </span>--cov-report<span class="o">=</span>html

<span class="c1"># Coverage with branch coverage</span>
pytest<span class="w"> </span>--cov<span class="o">=</span>src<span class="w"> </span>--cov-branch

<span class="c1"># Fail if coverage below threshold</span>
pytest<span class="w"> </span>--cov<span class="o">=</span>src<span class="w"> </span>--cov-fail-under<span class="o">=</span><span class="m">80</span>
</code></pre></div>

<h3 id="cicd-integration">CI/CD Integration</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># GitHub Actions</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Tests</span>
<span class="nt">on</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">push</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">pull_request</span><span class="p p-Indicator">]</span>
<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">test</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-python@v2</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.11</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip install -r requirements.txt</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pytest --cov=src --cov-report=xml</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">codecov/codecov-action@v2</span>
</code></pre></div>

<h3 id="quick-tips">Quick Tips</h3>
<p><strong>Test Organization</strong>:
- One test file per source file: <code>src/user.py</code> ‚Üí <code>tests/test_user.py</code>
- Group related tests in classes: <code>class TestUserCreation:</code>
- Use descriptive test names: <code>test_create_user_with_invalid_email_raises_error</code></p>
<p><strong>Fixture Best Practices</strong>:
- Use fixtures for setup, not test data
- Keep fixtures simple and focused
- Use factory fixtures for flexibility
- Document fixture purpose and usage</p>
<p><strong>Assertion Best Practices</strong>:
- One logical assertion per test
- Use specific assertions: <code>assert x == 5</code>, not <code>assert x</code>
- Include helpful error messages: <code>assert x == 5, f"Expected 5, got {x}"</code></p>
<p><strong>Mocking Best Practices</strong>:
- Mock external dependencies only
- Use realistic mock data
- Verify mock calls when behavior matters
- Prefer test doubles over mocks when possible</p>
<p><strong>Performance Best Practices</strong>:
- Mark slow tests: <code>@pytest.mark.slow</code>
- Use fixtures with appropriate scope
- Run tests in parallel: <code>pytest -n auto</code>
- Use test impact analysis: <code>pytest --lf --ff</code></p>
<p><strong>Debugging Best Practices</strong>:
- Use <code>pytest -vv</code> for detailed output
- Use <code>pytest --pdb</code> to debug failures
- Use <code>pytest -l</code> to see local variables
- Use <code>pytest -s</code> to see print statements</p>
<p>This cheat sheet covers the most common pytest commands and patterns. Keep it handy for quick reference!</p>
        </div>
        <div class="footer">
            Generated on 2025-12-03 10:37:13 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>