<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10 Testing Synchronous Code</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">04 Testing Patterns and Advanced Scenarios</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-10-testing-synchronous-code">Chapter 10: Testing Synchronous Code</h1>
<h2 id="testing-functions-and-methods">Testing Functions and Methods</h2>
<h2 id="testing-functions-and-methods_1">Testing Functions and Methods</h2>
<p>At the heart of any Python application are functions and methods. They are the fundamental units of logic, and learning to test them effectively is the cornerstone of building reliable software. In this section, we'll start with the simplest case‚Äîa pure function‚Äîand see how the principles extend directly to testing methods on an object.</p>
<h3 id="the-anatomy-of-a-function-test">The Anatomy of a Function Test</h3>
<p>A test for a function follows a simple, universal pattern:</p>
<ol>
<li><strong>Arrange</strong>: Set up the necessary preconditions and inputs.</li>
<li><strong>Act</strong>: Call the function or method you want to test.</li>
<li><strong>Assert</strong>: Verify that the outcome (the return value, a change in state, etc.) is what you expected.</li>
</ol>
<p>Let's apply this to a concrete example. Imagine we have a utility function in our application that formats user names for display.</p>
<p>Here's the function we want to test, located in a file named <code>app/utils.py</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># app/utils.py</span>

<span class="k">def</span><span class="w"> </span><span class="nf">format_user_display_name</span><span class="p">(</span><span class="n">first_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Formats a user&#39;s name for display, handling potential whitespace</span>
<span class="sd">    and capitalizing both names.</span>
<span class="sd">    Example: format_user_display_name(&quot;  john &quot;, &quot;DOE&quot;) -&gt; &quot;John Doe&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">first_name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">last_name</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># Clean up whitespace and ensure proper capitalization</span>
    <span class="n">formatted_first</span> <span class="o">=</span> <span class="n">first_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
    <span class="n">formatted_last</span> <span class="o">=</span> <span class="n">last_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>

    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">formatted_first</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">formatted_last</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>

<p>Now, let's write our tests in <code>tests/test_utils.py</code>.</p>
<h3 id="testing-the-happy-path">Testing the "Happy Path"</h3>
<p>First, we test the most common, expected use case. This is often called the "happy path."</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_utils.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">format_user_display_name</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_format_user_display_name_happy_path</span><span class="p">():</span>
    <span class="c1"># Arrange: Define the inputs</span>
    <span class="n">first</span> <span class="o">=</span> <span class="s2">&quot;ada&quot;</span>
    <span class="n">last</span> <span class="o">=</span> <span class="s2">&quot;lovelace&quot;</span>

    <span class="c1"># Act: Call the function</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">format_user_display_name</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">)</span>

    <span class="c1"># Assert: Check the output</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;Ada Lovelace&quot;</span>
</code></pre></div>

<p>This test is simple, readable, and directly verifies the function's core purpose.</p>
<h3 id="testing-edge-cases">Testing Edge Cases</h3>
<p>Good tests don't just check the happy path; they probe the boundaries and handle unexpected inputs gracefully. What happens if the inputs have extra whitespace or inconsistent capitalization? Our function's docstring claims to handle this, so let's verify it.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_utils.py</span>

<span class="c1"># ... (previous test)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_format_user_display_name_with_whitespace_and_mixed_case</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify that the function correctly handles leading/trailing whitespace</span>
<span class="sd">    and different character cases.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Arrange</span>
    <span class="n">first</span> <span class="o">=</span> <span class="s2">&quot;  GRACE &quot;</span>
    <span class="n">last</span> <span class="o">=</span> <span class="s2">&quot;hopper  &quot;</span>

    <span class="c1"># Act</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">format_user_display_name</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;Grace Hopper&quot;</span>
</code></pre></div>

<p>What about invalid or empty inputs? The function's logic returns an empty string. This is a business rule we must test.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_utils.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">format_user_display_name</span>

<span class="c1"># ... (previous tests)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s2">&quot;first, last, expected&quot;</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Lovelace&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Ada&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Hopper&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="c1"># Assuming the function should handle None</span>
        <span class="p">(</span><span class="s2">&quot;Grace&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_format_user_display_name_empty_or_none_inputs</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify that empty or None inputs result in an empty string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The function as written will raise an AttributeError for None.</span>
    <span class="c1"># This test reveals a bug or an unhandled case!</span>
    <span class="c1"># Let&#39;s pretend our goal is to fix the function to handle this.</span>
    <span class="c1"># After fixing format_user_display_name to check for None, this test will pass.</span>

    <span class="c1"># For now, let&#39;s test only empty strings which the current code handles.</span>
    <span class="k">if</span> <span class="n">first</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">last</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Skipping None test until function is updated&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">format_user_display_name</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected</span>
</code></pre></div>

<p>Notice how writing the test for <code>None</code> immediately revealed a flaw in our function! It would raise an <code>AttributeError</code> because you can't call <code>.strip()</code> on <code>None</code>. This is a perfect example of <strong>Test-Driven Development (TDD)</strong>: writing a test that fails, then writing the code to make it pass.</p>
<h3 id="from-functions-to-methods">From Functions to Methods</h3>
<p>Now, let's consider a method. A method is simply a function that is bound to an instance of a class. Testing it is nearly identical, with one extra step in the "Arrange" phase: creating an instance of the object.</p>
<p>Let's create a simple <code>User</code> class in <code>app/models.py</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># app/models.py</span>

<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="n">first_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="n">last_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_display_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the formatted full name of the user.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_email_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the domain part of the user&#39;s email.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div>

<p>To test the <code>get_display_name</code> method, we follow the same Arrange-Act-Assert pattern.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_models.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_user_get_display_name</span><span class="p">():</span>
    <span class="c1"># Arrange: Create an instance of the User class</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">first_name</span><span class="o">=</span><span class="s2">&quot;ada&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s2">&quot;lovelace&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;ada@example.com&quot;</span><span class="p">)</span>

    <span class="c1"># Act: Call the method on the instance</span>
    <span class="n">display_name</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">()</span>

    <span class="c1"># Assert: Check the result</span>
    <span class="k">assert</span> <span class="n">display_name</span> <span class="o">==</span> <span class="s2">&quot;Ada Lovelace&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_user_get_email_domain</span><span class="p">():</span>
    <span class="c1"># Arrange</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">first_name</span><span class="o">=</span><span class="s2">&quot;grace&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s2">&quot;hopper&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;grace.hopper@navy.mil&quot;</span><span class="p">)</span>

    <span class="c1"># Act</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_email_domain</span><span class="p">()</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">domain</span> <span class="o">==</span> <span class="s2">&quot;navy.mil&quot;</span>
</code></pre></div>

<p>As you can see, the core logic is the same. Whether it's a standalone function or a method on an object, you set up the context, call the code, and assert the result.</p>
<h2 id="testing-classes-and-object-oriented-code">Testing Classes and Object-Oriented Code</h2>
<h2 id="testing-classes-and-object-oriented-code_1">Testing Classes and Object-Oriented Code</h2>
<p>Testing a class is more than just testing its methods in isolation. It's about verifying the object's behavior, state, and interactions over its entire lifecycle. A class is a blueprint for objects that hold state, and our tests must confirm that this state is managed correctly.</p>
<p>To explore this, let's build a <code>ShoppingCart</code> class. This is a classic example because it involves adding items, removing them, and calculating totals‚Äîall actions that modify the object's internal state.</p>
<p>Here is our class in <code>app/models.py</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># app/models.py</span>

<span class="c1"># ... (User class from before)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ShoppingCart</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Using a dict to store item_id -&gt; quantity</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Return a copy to prevent external modification</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">quantity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Quantity must be positive.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">quantity</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remove_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">quantity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Quantity must be positive.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">quantity</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not enough items in the cart to remove.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span> <span class="o">-=</span> <span class="n">quantity</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_total_items</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</code></pre></div>

<h3 id="the-wrong-way-repetitive-setup">The Wrong Way: Repetitive Setup</h3>
<p>You might be tempted to write tests like this, creating a new cart inside every single test function.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_models.py</span>

<span class="c1"># ... (User tests)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ShoppingCart</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cart_add_item_repetitive</span><span class="p">():</span>
    <span class="c1"># Arrange</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">ShoppingCart</span><span class="p">()</span>

    <span class="c1"># Act</span>
    <span class="n">cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="o">.</span><span class="n">items</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;apple&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="o">.</span><span class="n">get_total_items</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cart_add_multiple_items_repetitive</span><span class="p">():</span>
    <span class="c1"># Arrange</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">ShoppingCart</span><span class="p">()</span>

    <span class="c1"># Act</span>
    <span class="n">cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s2">&quot;banana&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="o">.</span><span class="n">items</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;apple&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;banana&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
    <span class="k">assert</span> <span class="n">cart</span><span class="o">.</span><span class="n">get_total_items</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span>
</code></pre></div>

<p>This works, but it violates the <strong>Don't Repeat Yourself (DRY)</strong> principle. The line <code>cart = ShoppingCart()</code> will appear in every test. If the <code>ShoppingCart</code> constructor ever changes (e.g., to require a user ID), you'd have to update every single test. This is where fixtures, which you learned about in Chapter 4, become essential.</p>
<h3 id="the-right-way-using-fixtures-for-clean-state">The Right Way: Using Fixtures for Clean State</h3>
<p>A fixture can provide a clean, empty <code>ShoppingCart</code> instance to every test that needs one. This isolates tests from each other and centralizes the setup logic.</p>
<p>Let's create a fixture in <code>tests/test_models.py</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_models.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ShoppingCart</span><span class="p">,</span> <span class="n">User</span> <span class="c1"># Assuming all models are in one file</span>

<span class="c1"># ... (User tests)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">empty_cart</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ShoppingCart</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides an empty shopping cart for tests.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ShoppingCart</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cart_add_item</span><span class="p">(</span><span class="n">empty_cart</span><span class="p">:</span> <span class="n">ShoppingCart</span><span class="p">):</span>
    <span class="c1"># Arrange: The empty_cart fixture handles this</span>

    <span class="c1"># Act</span>
    <span class="n">empty_cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">empty_cart</span><span class="o">.</span><span class="n">items</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;apple&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="k">assert</span> <span class="n">empty_cart</span><span class="o">.</span><span class="n">get_total_items</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cart_add_multiple_of_same_item</span><span class="p">(</span><span class="n">empty_cart</span><span class="p">:</span> <span class="n">ShoppingCart</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">empty_cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">empty_cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># Add more of the same item</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">empty_cart</span><span class="o">.</span><span class="n">items</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;apple&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
    <span class="k">assert</span> <span class="n">empty_cart</span><span class="o">.</span><span class="n">get_total_items</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span>
</code></pre></div>

<p>Now our tests are cleaner and focused only on the "Act" and "Assert" steps.</p>
<h3 id="testing-state-transitions">Testing State Transitions</h3>
<p>The most important aspect of testing a class is verifying how its state changes in response to method calls. We need to test sequences of actions.</p>
<p>Let's test adding and then removing an item.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_models.py</span>

<span class="c1"># ... (previous cart tests)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cart_remove_item</span><span class="p">(</span><span class="n">empty_cart</span><span class="p">:</span> <span class="n">ShoppingCart</span><span class="p">):</span>
    <span class="c1"># Arrange: Add items to the cart first</span>
    <span class="n">empty_cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">empty_cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s2">&quot;banana&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Act: Remove some of one item</span>
    <span class="n">empty_cart</span><span class="o">.</span><span class="n">remove_item</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Assert: Check the new state</span>
    <span class="k">assert</span> <span class="n">empty_cart</span><span class="o">.</span><span class="n">items</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;apple&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;banana&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
    <span class="k">assert</span> <span class="n">empty_cart</span><span class="o">.</span><span class="n">get_total_items</span><span class="p">()</span> <span class="o">==</span> <span class="mi">4</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cart_remove_all_of_one_item</span><span class="p">(</span><span class="n">empty_cart</span><span class="p">:</span> <span class="n">ShoppingCart</span><span class="p">):</span>
    <span class="c1"># Arrange</span>
    <span class="n">empty_cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">empty_cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s2">&quot;banana&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Act: Remove all of one item</span>
    <span class="n">empty_cart</span><span class="o">.</span><span class="n">remove_item</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="c1"># Assert: The item should be completely gone from the cart</span>
    <span class="k">assert</span> <span class="s2">&quot;apple&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">empty_cart</span><span class="o">.</span><span class="n">items</span>
    <span class="k">assert</span> <span class="n">empty_cart</span><span class="o">.</span><span class="n">items</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;banana&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
    <span class="k">assert</span> <span class="n">empty_cart</span><span class="o">.</span><span class="n">get_total_items</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>
</code></pre></div>

<h3 id="testing-for-expected-errors">Testing for Expected Errors</h3>
<p>Our <code>ShoppingCart</code> class is designed to raise <code>ValueError</code> for invalid operations, like removing an item that isn't there. As we saw in Chapter 7, <code>pytest.raises</code> is the perfect tool for this.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_models.py</span>

<span class="c1"># ... (previous cart tests)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cart_remove_too_many_items_raises_error</span><span class="p">(</span><span class="n">empty_cart</span><span class="p">:</span> <span class="n">ShoppingCart</span><span class="p">):</span>
    <span class="n">empty_cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="n">empty_cart</span><span class="o">.</span><span class="n">remove_item</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1"># Try to remove more than available</span>

    <span class="k">assert</span> <span class="s2">&quot;Not enough items&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cart_add_negative_quantity_raises_error</span><span class="p">(</span><span class="n">empty_cart</span><span class="p">:</span> <span class="n">ShoppingCart</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Quantity must be positive&quot;</span><span class="p">):</span>
        <span class="n">empty_cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p>By testing the happy paths, state transitions, and error conditions, we build a comprehensive and robust test suite for our class, ensuring it behaves exactly as designed.</p>
<h2 id="testing-private-methods-and-why-you-might-not-want-to">Testing Private Methods (And Why You Might Not Want To)</h2>
<h2 id="testing-private-methods-and-why-you-might-not-want-to_1">Testing Private Methods (And Why You Might Not Want To)</h2>
<p>As you build complex classes, you'll often create "helper" methods to break down logic into smaller, manageable pieces. In Python, the convention is to prefix these internal-use-only methods with a single underscore (e.g., <code>_calculate_tax</code>). This signals to other developers, "This is an implementation detail, don't rely on it."</p>
<p>A common question then arises: "Should I write tests for my private methods?"</p>
<p>The short answer is: <strong>No, you should test the public interface, not the implementation details.</strong></p>
<p>Let's explore why this philosophy leads to more robust and maintainable tests.</p>
<h3 id="the-temptation-to-test-everything">The Temptation to Test Everything</h3>
<p>Imagine we add a tax calculation feature to our <code>ShoppingCart</code>. The implementation uses a private helper method.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># app/models.py</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ShoppingCart</span><span class="p">:</span>
    <span class="c1"># ... (previous methods)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tax_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tax_rate</span> <span class="o">=</span> <span class="n">tax_rate</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_subtotal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates total price before tax.&quot;&quot;&quot;</span>
        <span class="n">subtotal</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">quantity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">subtotal</span> <span class="o">+=</span> <span class="n">prices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item_id</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">quantity</span>
        <span class="k">return</span> <span class="n">subtotal</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates the total price including tax.&quot;&quot;&quot;</span>
        <span class="n">subtotal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_subtotal</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="n">tax</span> <span class="o">=</span> <span class="n">subtotal</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tax_rate</span>
        <span class="k">return</span> <span class="n">subtotal</span> <span class="o">+</span> <span class="n">tax</span>
</code></pre></div>

<p>You might be tempted to write a test directly for <code>_calculate_subtotal</code> to ensure it works correctly. You <em>can</em> do this, as Python doesn't truly enforce privacy.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_models.py</span>

<span class="c1"># ...</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cart_private_calculate_subtotal_directly</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is an example of a BRITTLE test. Avoid this pattern.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Arrange</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">ShoppingCart</span><span class="p">()</span>
    <span class="n">cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s2">&quot;banana&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;apple&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;banana&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>

    <span class="c1"># Act: Call the private method directly</span>
    <span class="n">subtotal</span> <span class="o">=</span> <span class="n">cart</span><span class="o">.</span><span class="n">_calculate_subtotal</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">subtotal</span> <span class="o">==</span> <span class="mf">3.50</span> <span class="c1"># (2 * 1.0) + (3 * 0.5)</span>
</code></pre></div>

<p>This test passes. So what's the problem?</p>
<h3 id="the-pitfall-brittle-tests-coupled-to-implementation">The Pitfall: Brittle Tests Coupled to Implementation</h3>
<p>The problem arises when you refactor your code. Good developers constantly refactor to improve clarity and performance. Let's say you realize the <code>_calculate_subtotal</code> logic is simple enough to be inlined directly into <code>get_total_price</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># app/models.py (Refactored)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ShoppingCart</span><span class="p">:</span>
    <span class="c1"># ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates the total price including tax (refactored).&quot;&quot;&quot;</span>
        <span class="n">subtotal</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">quantity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">subtotal</span> <span class="o">+=</span> <span class="n">prices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item_id</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">quantity</span>

        <span class="n">tax</span> <span class="o">=</span> <span class="n">subtotal</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tax_rate</span>
        <span class="k">return</span> <span class="n">subtotal</span> <span class="o">+</span> <span class="n">tax</span>

    <span class="c1"># The _calculate_subtotal method has been removed!</span>
</code></pre></div>

<p>The public behavior of <code>get_total_price</code> is <strong>exactly the same</strong>. The class works perfectly. But what happens when you run your tests?</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_models.py
...
_________________<span class="w"> </span>test_cart_private_calculate_subtotal_directly<span class="w"> </span>__________________

<span class="w">    </span>def<span class="w"> </span>test_cart_private_calculate_subtotal_directly<span class="o">()</span>:
<span class="w">        </span><span class="c1"># ...</span>
<span class="w">        </span><span class="c1"># Act: Call the private method directly</span>
&gt;<span class="w">       </span><span class="nv">subtotal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>cart._calculate_subtotal<span class="o">(</span>prices<span class="o">)</span>
E<span class="w">       </span>AttributeError:<span class="w"> </span><span class="s1">&#39;ShoppingCart&#39;</span><span class="w"> </span>object<span class="w"> </span>has<span class="w"> </span>no<span class="w"> </span>attribute<span class="w"> </span><span class="s1">&#39;_calculate_subtotal&#39;</span>

tests/test_models.py:123:<span class="w"> </span>AttributeError
</code></pre></div>

<p>Your test suite fails! Your test for <code>_calculate_subtotal</code> is now broken, even though the class's public functionality is unchanged. This is a <strong>false negative</strong>. The test failed not because of a bug in the application code, but because it was too tightly coupled to a specific implementation detail that was free to change.</p>
<h3 id="the-solution-test-the-behavior">The Solution: Test the Behavior</h3>
<p>The correct approach is to test the public method (<code>get_total_price</code>) in a way that implicitly covers the logic that <em>was</em> in the private method.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_models.py</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cart_with_items</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ShoppingCart</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides a cart with some items already in it.&quot;&quot;&quot;</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">ShoppingCart</span><span class="p">(</span><span class="n">tax_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> <span class="c1"># Use a known tax rate</span>
    <span class="n">cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># 2 * $1.00 = $2.00</span>
    <span class="n">cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s2">&quot;banana&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1"># 3 * $0.50 = $1.50</span>
    <span class="k">return</span> <span class="n">cart</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_total_price</span><span class="p">(</span><span class="n">cart_with_items</span><span class="p">:</span> <span class="n">ShoppingCart</span><span class="p">):</span>
    <span class="c1"># Arrange</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;apple&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;banana&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
    <span class="c1"># Subtotal should be $3.50</span>
    <span class="c1"># Tax should be $0.35 (10% of 3.50)</span>
    <span class="c1"># Total should be $3.85</span>

    <span class="c1"># Act</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">cart_with_items</span><span class="o">.</span><span class="n">get_total_price</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">total</span> <span class="o">==</span> <span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="mf">3.85</span><span class="p">)</span>
</code></pre></div>

<p>This test verifies the correct final price. It doesn't care <em>how</em> the subtotal was calculated, only that the final result is correct. Now, you are free to refactor the internal implementation of <code>ShoppingCart</code> as much as you want. As long as <code>get_total_price</code> returns the correct value, this test will pass.</p>
<p>Your tests now protect the <strong>what</strong> (the object's behavior) and not the <strong>how</strong> (the object's internal implementation), leading to a more resilient and valuable test suite.</p>
<h2 id="testing-code-with-side-effects">Testing Code with Side Effects</h2>
<h2 id="testing-code-with-side-effects_1">Testing Code with Side Effects</h2>
<p>A "pure function" is a developer's dream: for a given input, it always returns the same output and has no observable effects on the outside world. The <code>format_user_display_name</code> function from earlier is a good example.</p>
<p>However, most real-world code is not pure. It has <strong>side effects</strong>: actions that change state outside the function's scope. Common side effects include:</p>
<ul>
<li>Writing to a file or database.</li>
<li>Making an HTTP request to an external API.</li>
<li>Printing to the console.</li>
<li>Modifying a global variable.</li>
</ul>
<p>Side effects make testing harder because they introduce dependencies on external systems (like the filesystem or the network) and can make tests slow, unreliable, and difficult to set up. The key to testing code with side effects is to <strong>isolate your code from the side effect itself</strong>.</p>
<h3 id="the-problem-a-function-that-writes-to-a-file">The Problem: A Function That Writes to a File</h3>
<p>Let's consider a function that logs an event message to a file.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># app/logging.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span><span class="w"> </span><span class="nf">log_event</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">log_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes a timestamped event message to a log file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>How would we test this? We could run the function and then read the file to see if the message was written.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_logging_bad.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">log_event</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_log_event_writes_to_file_bad_approach</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This test works, but has several problems.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Arrange</span>
    <span class="n">log_file</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;events.log&quot;</span>

    <span class="c1"># Act</span>
    <span class="n">log_event</span><span class="p">(</span><span class="s2">&quot;User logged in&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">log_file</span><span class="p">))</span>

    <span class="c1"># Assert</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">assert</span> <span class="s2">&quot;User logged in&quot;</span> <span class="ow">in</span> <span class="n">content</span>

    <span class="c1"># Teardown is handled by tmp_path, but in other cases</span>
    <span class="c1"># you might need manual cleanup.</span>
    <span class="c1"># os.remove(log_file)</span>
</code></pre></div>

<p>While pytest's built-in <code>tmp_path</code> fixture helps, this approach has drawbacks:
1.  <strong>It's slow</strong>: Filesystem I/O is orders of magnitude slower than in-memory operations.
2.  <strong>It's complex</strong>: The test has to perform file operations just to verify the result.
3.  <strong>It's not a true unit test</strong>: It depends on the filesystem being available and working correctly.</p>
<h3 id="the-solution-mocking-the-side-effect">The Solution: Mocking the Side Effect</h3>
<p>The solution is to use a <strong>mock</strong>. As we'll cover in depth in Chapters 8 and 9, a mock is a test double that replaces a real object or function. We can replace the built-in <code>open</code> function with a mock object that we control and inspect.</p>
<p>Pytest integrates seamlessly with Python's standard <code>unittest.mock</code> library. The <code>mocker</code> fixture, provided by the <code>pytest-mock</code> plugin (a common dependency), is the standard way to do this.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># You&#39;ll likely need to install this</span>
pip<span class="w"> </span>install<span class="w"> </span>pytest-mock
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_logging.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">log_event</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span><span class="p">,</span> <span class="n">mock_open</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_log_event_with_mocker</span><span class="p">(</span><span class="n">mocker</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests the log_event function by mocking the &#39;open&#39; call.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Arrange: We want to mock &#39;open&#39; inside the &#39;app.logging&#39; module</span>
    <span class="c1"># where it is being called.</span>
    <span class="n">mock_file</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">mock_open</span><span class="p">()</span>
    <span class="n">mocker</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s2">&quot;app.logging.open&quot;</span><span class="p">,</span> <span class="n">mock_file</span><span class="p">)</span>

    <span class="c1"># Act</span>
    <span class="n">log_event</span><span class="p">(</span><span class="s2">&quot;User logged out&quot;</span><span class="p">,</span> <span class="s2">&quot;any/file/path.log&quot;</span><span class="p">)</span>

    <span class="c1"># Assert: Check that &#39;open&#39; was called correctly</span>
    <span class="n">mock_file</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;any/file/path.log&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>

    <span class="c1"># Assert: Check that &#39;write&#39; was called on the file handle</span>
    <span class="c1"># We can&#39;t easily check the timestamp, so we check for the message.</span>
    <span class="c1"># The call is a bit complex: handle.write(string)</span>
    <span class="n">written_content</span> <span class="o">=</span> <span class="n">mock_file</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">call_args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="s2">&quot;User logged out&quot;</span> <span class="ow">in</span> <span class="n">written_content</span>
    <span class="k">assert</span> <span class="n">written_content</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Let's break down what happened:
1.  <code>mocker.patch("app.logging.open", ...)</code>: We told pytest to replace the <code>open</code> function <em>within the <code>app.logging</code> namespace</em> with our mock. This is a critical detail‚Äîyou must patch the object where it is <em>looked up</em>, not where it is defined.
2.  <code>mocker.mock_open()</code>: This is a convenient helper that creates a mock that behaves like a file handle.
3.  <code>mock_file.assert_called_once_with(...)</code>: We assert that the <code>open</code> function was called exactly once with the expected filename and mode (<code>"a"</code> for append).
4.  <code>mock_file().write.call_args</code>: We inspect the arguments that were passed to the <code>write</code> method on the mocked file handle to ensure our message was part of it.</p>
<p>This test is fast, runs entirely in memory, and precisely verifies that our function tried to perform the correct side effect without actually doing it. This technique is fundamental for testing code that interacts with databases, APIs, or any other external system.</p>
<h2 id="integration-testing-within-your-codebase">Integration Testing Within Your Codebase</h2>
<h2 id="integration-testing-within-your-codebase_1">Integration Testing Within Your Codebase</h2>
<p>So far, we've focused on <strong>unit tests</strong>, which test a single component (a function or a class) in isolation. This is the foundation of a solid testing strategy. However, a real application is a collection of many units working together. A bug might not be in any single unit, but in the interaction <em>between</em> them.</p>
<p>This is where <strong>integration tests</strong> come in. An integration test verifies that two or more components of your application can communicate and work together correctly.</p>
<h3 id="from-unit-to-integration">From Unit to Integration</h3>
<p>Let's evolve our <code>ShoppingCart</code> example. In a real e-commerce system, product prices aren't hardcoded in the test; they come from a database or another service. Let's create a <code>ProductDB</code> class to represent this.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># app/db.py</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ProductDB</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># In a real app, this would connect to a database.</span>
        <span class="c1"># Here, it&#39;s just an in-memory dictionary.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prices</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;apple&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s2">&quot;banana&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="s2">&quot;orange&quot;</span><span class="p">:</span> <span class="mf">0.75</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the price of an item.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item_id</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</code></pre></div>

<p>Now, we'll refactor <code>ShoppingCart</code> to use this <code>ProductDB</code>. This is a common pattern called <strong>Dependency Injection</strong>, where a component's dependencies are provided from the outside rather than created internally.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># app/models.py (Refactored ShoppingCart)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProductDB</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ShoppingCart</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">ProductDB</span><span class="p">,</span> <span class="n">tax_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tax_rate</span> <span class="o">=</span> <span class="n">tax_rate</span>

    <span class="c1"># ... add_item, remove_item, etc. remain the same ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates the total price using the product database.&quot;&quot;&quot;</span>
        <span class="n">subtotal</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">quantity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">item_id</span><span class="p">)</span>
            <span class="n">subtotal</span> <span class="o">+=</span> <span class="n">price</span> <span class="o">*</span> <span class="n">quantity</span>

        <span class="n">tax</span> <span class="o">=</span> <span class="n">subtotal</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tax_rate</span>
        <span class="k">return</span> <span class="n">subtotal</span> <span class="o">+</span> <span class="n">tax</span>
</code></pre></div>

<p>Our <code>ShoppingCart</code> now depends on <code>ProductDB</code>. We have two units that need to collaborate.</p>
<h3 id="path-1-the-unit-test-with-mocks">Path 1: The Unit Test (with Mocks)</h3>
<p>We can still write a unit test for <code>ShoppingCart</code> in isolation. To do this, we provide a <em>mock</em> <code>ProductDB</code> instead of a real one. This allows us to test the cart's calculation logic without any dependency on the actual database.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_models_integration.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ShoppingCart</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProductDB</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cart_total_price_unit_test</span><span class="p">(</span><span class="n">mocker</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unit test for ShoppingCart, mocking the ProductDB dependency.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Arrange</span>
    <span class="c1"># Create a mock ProductDB that returns specific prices for our test</span>
    <span class="n">mock_db</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">ProductDB</span><span class="p">)</span>
    <span class="n">mock_db</span><span class="o">.</span><span class="n">get_price</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">item_id</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;apple&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;banana&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item_id</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="n">cart</span> <span class="o">=</span> <span class="n">ShoppingCart</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">mock_db</span><span class="p">,</span> <span class="n">tax_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s2">&quot;banana&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Act</span>
    <span class="n">total_price</span> <span class="o">=</span> <span class="n">cart</span><span class="o">.</span><span class="n">get_total_price</span><span class="p">()</span>

    <span class="c1"># Assert</span>
    <span class="c1"># Subtotal = (2 * 1.0) + (3 * 0.5) = 3.5</span>
    <span class="c1"># Total = 3.5 * 1.1 = 3.85</span>
    <span class="k">assert</span> <span class="n">total_price</span> <span class="o">==</span> <span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="mf">3.85</span><span class="p">)</span>

    <span class="c1"># We can also assert that the dependency was called correctly</span>
    <span class="k">assert</span> <span class="n">mock_db</span><span class="o">.</span><span class="n">get_price</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="n">mock_db</span><span class="o">.</span><span class="n">get_price</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">)</span>
    <span class="n">mock_db</span><span class="o">.</span><span class="n">get_price</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="s2">&quot;banana&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Advantages of this unit test:</strong>
*   <strong>Fast</strong>: No real database connection.
*   <strong>Isolated</strong>: A failure here points directly to a bug in <code>ShoppingCart</code>, not <code>ProductDB</code>.
*   <strong>Controllable</strong>: We can easily simulate any scenario, like an item not being in the database, by configuring our mock.</p>
<h3 id="path-2-the-integration-test-with-real-objects">Path 2: The Integration Test (with Real Objects)</h3>
<p>The unit test gives us confidence that <code>ShoppingCart</code>'s logic is correct. But does it work with the <em>real</em> <code>ProductDB</code>? An integration test will answer that.</p>
<p>For this test, we instantiate <em>both</em> real objects and have them interact.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_models_integration.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ShoppingCart</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProductDB</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cart_and_db_integration</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integration test verifying ShoppingCart and ProductDB work together.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Arrange: Create real instances of both classes</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">ProductDB</span><span class="p">()</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">ShoppingCart</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">tax_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="n">cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">cart</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="c1"># Act</span>
    <span class="n">total_price</span> <span class="o">=</span> <span class="n">cart</span><span class="o">.</span><span class="n">get_total_price</span><span class="p">()</span>

    <span class="c1"># Assert</span>
    <span class="c1"># Subtotal = (2 * 1.0) + (4 * 0.75) = 2.0 + 3.0 = 5.0</span>
    <span class="c1"># Total = 5.0 * 1.1 = 5.5</span>
    <span class="k">assert</span> <span class="n">total_price</span> <span class="o">==</span> <span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="mf">5.5</span><span class="p">)</span>
</code></pre></div>

<p><strong>Advantages of this integration test:</strong>
*   <strong>High Confidence</strong>: It proves the two components are correctly wired together and can communicate. It tests the contract between them.
*   <strong>Realistic</strong>: It more closely simulates how the application will run in production.</p>
<h3 id="the-testing-pyramid">The Testing Pyramid</h3>
<p>In a professional project, you need both types of tests. The general guideline is the "Testing Pyramid":</p>
<ol>
<li><strong>Lots of fast Unit Tests</strong> at the base, providing detailed coverage of individual components.</li>
<li><strong>Fewer, slightly slower Integration Tests</strong> in the middle, ensuring components work together.</li>
<li><strong>Very few End-to-End Tests</strong> at the top, which test the entire application through its user interface.</li>
</ol>
<p>By testing your synchronous code at both the unit and integration levels, you create a safety net that catches bugs in individual components and in the critical connections between them.</p>
        </div>
        <div class="footer">
            Generated on 2025-11-22 16:29:18 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>