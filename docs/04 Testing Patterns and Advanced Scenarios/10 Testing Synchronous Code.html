<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10 Testing Synchronous Code</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">04 Testing Patterns and Advanced Scenarios</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-10-testing-synchronous-code">Chapter 10: Testing Synchronous Code</h1>
<h2 id="testing-functions-and-methods">Testing Functions and Methods</h2>
<h2 id="testing-functions-and-methods_1">Testing Functions and Methods</h2>
<p>Before we explore the complexities of asynchronous code, external dependencies, or advanced mocking patterns, we must master the foundation: testing synchronous functions and methods. This is where most of your testing work happens, and where solid patterns pay dividends for years.</p>
<p>In this chapter, we'll build a complete testing strategy for a realistic payment processing system. We'll start with simple functions, encounter real failure modes, and progressively refine our approach until we have production-ready tests that catch bugs before they reach users.</p>
<h3 id="the-reference-implementation-a-payment-processor">The Reference Implementation: A Payment Processor</h3>
<p>Our anchor example will be a payment processing module that validates credit cards, calculates fees, and processes transactions. This is substantial enough to demonstrate real-world testing challenges while remaining focused on synchronous code patterns.</p>
<p>Here's our initial implementation:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_processor.py</span>

<span class="k">def</span><span class="w"> </span><span class="nf">validate_credit_card</span><span class="p">(</span><span class="n">card_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate credit card number using Luhn algorithm.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">card_number</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">card_number</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">13</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">card_number</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">19</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Luhn algorithm</span>
    <span class="n">digits</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">card_number</span><span class="p">]</span>
    <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">doubled</span> <span class="o">=</span> <span class="n">digits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">checksum</span> <span class="o">+=</span> <span class="n">doubled</span> <span class="k">if</span> <span class="n">doubled</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="n">doubled</span> <span class="o">-</span> <span class="mi">9</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">checksum</span> <span class="o">+=</span> <span class="n">digits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">checksum</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">calculate_processing_fee</span><span class="p">(</span><span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">card_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate processing fee based on amount and card type.&quot;&quot;&quot;</span>
    <span class="n">base_fee</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="mf">0.029</span>  <span class="c1"># 2.9% base rate</span>

    <span class="k">if</span> <span class="n">card_type</span> <span class="o">==</span> <span class="s2">&quot;amex&quot;</span><span class="p">:</span>
        <span class="n">base_fee</span> <span class="o">+=</span> <span class="n">amount</span> <span class="o">*</span> <span class="mf">0.005</span>  <span class="c1"># Additional 0.5% for Amex</span>

    <span class="n">transaction_fee</span> <span class="o">=</span> <span class="mf">0.30</span>  <span class="c1"># Fixed $0.30 per transaction</span>

    <span class="k">return</span> <span class="n">base_fee</span> <span class="o">+</span> <span class="n">transaction_fee</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="n">card_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">card_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process a payment transaction.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">validate_credit_card</span><span class="p">(</span><span class="n">card_number</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid credit card number&quot;</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Amount must be positive&quot;</span>
        <span class="p">}</span>

    <span class="n">fee</span> <span class="o">=</span> <span class="n">calculate_processing_fee</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">card_type</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">+</span> <span class="n">fee</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
        <span class="s2">&quot;fee&quot;</span><span class="p">:</span> <span class="n">fee</span><span class="p">,</span>
        <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span>
        <span class="s2">&quot;card_last_four&quot;</span><span class="p">:</span> <span class="n">card_number</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span>
    <span class="p">}</span>
</code></pre></div>

<p>This is our starting point. It works, but we have no tests. Let's begin testing it and discover what problems emerge.</p>
<h3 id="iteration-0-the-naive-first-test">Iteration 0: The Naive First Test</h3>
<p>Let's write the most obvious test we can think of:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_processor.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_payment</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
</code></pre></div>

<p>Running this test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_processor.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_processor.py::test_process_payment PASSED                   [100%]

========================== 1 passed in 0.01s ===========================
</code></pre></div>

<p>Great! Our test passes. But what have we actually verified? Only that <code>success</code> is <code>True</code>. We haven't checked:</p>
<ul>
<li>The calculated fee</li>
<li>The total amount</li>
<li>The card number masking</li>
<li>Error handling for invalid inputs</li>
</ul>
<p><strong>Current limitation</strong>: This test is too shallow. It passes, but it doesn't give us confidence that the payment processor actually works correctly.</p>
<h3 id="iteration-1-testing-the-complete-success-case">Iteration 1: Testing the Complete Success Case</h3>
<p>Let's write a more thorough test that verifies all aspects of a successful payment:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_processor.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_payment</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_success</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">100.00</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;fee&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">3.20</span>  <span class="c1"># 2.9% + $0.30</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">103.20</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;card_last_four&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0366&quot;</span>
</code></pre></div>

<p>Running this test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_processor.py::test_process_payment_success<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_processor.py::test_process_payment_success PASSED           [100%]

========================== 1 passed in 0.01s ===========================
</code></pre></div>

<p>Excellent! Now we're verifying the complete behavior. But what happens when things go wrong?</p>
<p><strong>Current limitation</strong>: We're only testing the happy path. We haven't verified error handling.</p>
<h3 id="iteration-2-testing-error-cases">Iteration 2: Testing Error Cases</h3>
<p>Let's test what happens with an invalid card number:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_processor.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_payment</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_success</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">100.00</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;fee&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">3.20</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">103.20</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;card_last_four&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0366&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_invalid_card</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;1234567890123456&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Invalid credit card number&quot;</span>
</code></pre></div>

<p>Running this test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_processor.py::test_process_payment_invalid_card<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_processor.py::test_process_payment_invalid_card PASSED      [100%]

========================== 1 passed in 0.01s ===========================
</code></pre></div>

<p>Good! But now we have a problem: we're repeating the card number "4532015112830366" in multiple tests. What if we need to change it? What if we want to test with different valid cards?</p>
<p><strong>Current limitation</strong>: Test data is hardcoded and duplicated across tests.</p>
<h3 id="iteration-3-extracting-test-data">Iteration 3: Extracting Test Data</h3>
<p>Let's use module-level constants for our test data:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_processor.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_payment</span>

<span class="c1"># Test data</span>
<span class="n">VALID_VISA</span> <span class="o">=</span> <span class="s2">&quot;4532015112830366&quot;</span>
<span class="n">INVALID_CARD</span> <span class="o">=</span> <span class="s2">&quot;1234567890123456&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_success</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="n">VALID_VISA</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">100.00</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;fee&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">3.20</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">103.20</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;card_last_four&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0366&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_invalid_card</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="n">INVALID_CARD</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Invalid credit card number&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_negative_amount</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="n">VALID_VISA</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Amount must be positive&quot;</span>
</code></pre></div>

<p>Running all tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_processor.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_processor.py::test_process_payment_success PASSED           [ 33%]
test_payment_processor.py::test_process_payment_invalid_card PASSED      [ 66%]
test_payment_processor.py::test_process_payment_negative_amount PASSED   [100%]

========================== 3 passed in 0.02s ===========================
</code></pre></div>

<p>Better! Our test data is now centralized. But look at the repetition in our assertions. Every test follows the same pattern: call the function, assert multiple fields. Can we make this cleaner?</p>
<p><strong>Current limitation</strong>: Repetitive assertion patterns make tests verbose and harder to maintain.</p>
<h3 id="iteration-4-helper-functions-for-common-assertions">Iteration 4: Helper Functions for Common Assertions</h3>
<p>Let's create helper functions to reduce repetition:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_processor.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_payment</span>

<span class="c1"># Test data</span>
<span class="n">VALID_VISA</span> <span class="o">=</span> <span class="s2">&quot;4532015112830366&quot;</span>
<span class="n">INVALID_CARD</span> <span class="o">=</span> <span class="s2">&quot;1234567890123456&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">assert_successful_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">expected_amount</span><span class="p">,</span> <span class="n">expected_fee</span><span class="p">,</span> <span class="n">expected_last_four</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper to verify successful payment results.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_amount</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;fee&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_fee</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_amount</span> <span class="o">+</span> <span class="n">expected_fee</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;card_last_four&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_last_four</span>

<span class="k">def</span><span class="w"> </span><span class="nf">assert_failed_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">expected_error</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper to verify failed payment results.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_error</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_success</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="n">VALID_VISA</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="n">assert_successful_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="mf">3.20</span><span class="p">,</span> <span class="s2">&quot;0366&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_invalid_card</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="n">INVALID_CARD</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="n">assert_failed_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;Invalid credit card number&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_negative_amount</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="n">VALID_VISA</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="n">assert_failed_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;Amount must be positive&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Running all tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_processor.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_processor.py::test_process_payment_success PASSED           [ 33%]
test_payment_processor.py::test_process_payment_invalid_card PASSED      [ 66%]
test_payment_processor.py::test_process_payment_negative_amount PASSED   [100%]

========================== 3 passed in 0.02s ===========================
</code></pre></div>

<p>Much cleaner! Our tests are now more readable and maintainable. But we still have a problem: we're only testing one card type (Visa). What about American Express, which has different fees?</p>
<p><strong>Current limitation</strong>: We're not testing the card type fee variations.</p>
<h3 id="iteration-5-testing-different-card-types">Iteration 5: Testing Different Card Types</h3>
<p>Let's add tests for American Express:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_processor.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_payment</span>

<span class="c1"># Test data</span>
<span class="n">VALID_VISA</span> <span class="o">=</span> <span class="s2">&quot;4532015112830366&quot;</span>
<span class="n">VALID_AMEX</span> <span class="o">=</span> <span class="s2">&quot;378282246310005&quot;</span>
<span class="n">INVALID_CARD</span> <span class="o">=</span> <span class="s2">&quot;1234567890123456&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">assert_successful_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">expected_amount</span><span class="p">,</span> <span class="n">expected_fee</span><span class="p">,</span> <span class="n">expected_last_four</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper to verify successful payment results.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_amount</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;fee&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_fee</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_amount</span> <span class="o">+</span> <span class="n">expected_fee</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;card_last_four&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_last_four</span>

<span class="k">def</span><span class="w"> </span><span class="nf">assert_failed_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">expected_error</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper to verify failed payment results.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_error</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_visa</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="n">VALID_VISA</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="c1"># Visa: 2.9% + $0.30 = $2.90 + $0.30 = $3.20</span>
    <span class="n">assert_successful_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="mf">3.20</span><span class="p">,</span> <span class="s2">&quot;0366&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_amex</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="n">VALID_AMEX</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;amex&quot;</span><span class="p">)</span>
    <span class="c1"># Amex: 3.4% + $0.30 = $3.40 + $0.30 = $3.70</span>
    <span class="n">assert_successful_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="mf">3.70</span><span class="p">,</span> <span class="s2">&quot;0005&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_invalid_card</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="n">INVALID_CARD</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="n">assert_failed_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;Invalid credit card number&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_negative_amount</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="n">VALID_VISA</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="n">assert_failed_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;Amount must be positive&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Running all tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_processor.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_processor.py::test_process_payment_visa PASSED              [ 25%]
test_payment_processor.py::test_process_payment_amex PASSED              [ 50%]
test_payment_processor.py::test_process_payment_invalid_card PASSED      [ 75%]
test_payment_processor.py::test_process_payment_negative_amount PASSED   [100%]

========================== 4 passed in 0.02s ===========================
</code></pre></div>

<p>Excellent! Now we're testing both card types. But wait‚Äîlet's verify that our fee calculation is actually correct. Let me run the Amex test again with verbose output to see the actual values:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_processor.py::test_process_payment_amex<span class="w"> </span>-v
</code></pre></div>

<p>The test passes, which means our fee calculation is working. But there's a subtle issue here: we're calculating the expected fee in our heads and hardcoding it. What if we make a mistake? What if the fee structure changes?</p>
<p><strong>Current limitation</strong>: Fee calculations are hardcoded in tests, making them brittle and error-prone.</p>
<h3 id="diagnostic-analysis-when-tests-pass-but-shouldnt">Diagnostic Analysis: When Tests Pass But Shouldn't</h3>
<p>Let's intentionally introduce a bug to see what happens. Suppose we accidentally change the Amex fee calculation:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_processor.py (with bug)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">calculate_processing_fee</span><span class="p">(</span><span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">card_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate processing fee based on amount and card type.&quot;&quot;&quot;</span>
    <span class="n">base_fee</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="mf">0.029</span>  <span class="c1"># 2.9% base rate</span>

    <span class="k">if</span> <span class="n">card_type</span> <span class="o">==</span> <span class="s2">&quot;amex&quot;</span><span class="p">:</span>
        <span class="n">base_fee</span> <span class="o">+=</span> <span class="n">amount</span> <span class="o">*</span> <span class="mf">0.010</span>  <span class="c1"># BUG: Should be 0.005, not 0.010</span>

    <span class="n">transaction_fee</span> <span class="o">=</span> <span class="mf">0.30</span>

    <span class="k">return</span> <span class="n">base_fee</span> <span class="o">+</span> <span class="n">transaction_fee</span>
</code></pre></div>

<p>Now let's run our test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_processor.py::test_process_payment_amex<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_processor.py::test_process_payment_amex FAILED              [100%]

================================= FAILURES =================================
_______________________ test_process_payment_amex __________________________

    def test_process_payment_amex():
        result = process_payment(VALID_AMEX, 100.00, &quot;amex&quot;)
&gt;       assert_successful_payment(result, 100.00, 3.70, &quot;0005&quot;)

test_payment_processor.py:30: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

result = {&#39;success&#39;: True, &#39;amount&#39;: 100.0, &#39;fee&#39;: 4.2, &#39;total&#39;: 104.2, ...}
expected_amount = 100.0, expected_fee = 3.7, expected_last_four = &#39;0005&#39;

    def assert_successful_payment(result, expected_amount, expected_fee, expected_last_four):
        &quot;&quot;&quot;Helper to verify successful payment results.&quot;&quot;&quot;
        assert result[&quot;success&quot;] == True
        assert result[&quot;amount&quot;] == expected_amount
&gt;       assert result[&quot;fee&quot;] == expected_fee
E       AssertionError: assert 4.2 == 3.7
E        +  where 4.2 = {&#39;success&#39;: True, &#39;amount&#39;: 100.0, &#39;fee&#39;: 4.2, &#39;total&#39;: 104.2, &#39;card_last_four&#39;: &#39;0005&#39;}[&#39;fee&#39;]

test_payment_processor.py:16: AssertionError
========================== 1 failed in 0.03s ===========================
</code></pre></div>

<h3 id="reading-the-failure">Reading the Failure</h3>
<p><strong>The summary line</strong>: <code>FAILED test_payment_processor.py::test_process_payment_amex - AssertionError</code>
- What this tells us: The test failed due to an assertion error, not an exception in the code</p>
<p><strong>The traceback</strong>:</p>
<div class="codehilite"><pre><span></span><code>    def assert_successful_payment(result, expected_amount, expected_fee, expected_last_four):
        &quot;&quot;&quot;Helper to verify successful payment results.&quot;&quot;&quot;
        assert result[&quot;success&quot;] == True
        assert result[&quot;amount&quot;] == expected_amount
<span class="k">&gt; </span><span class="ge">      assert result[&quot;fee&quot;] == expected_fee</span>
E       AssertionError: assert 4.2 == 3.7
</code></pre></div>

<ul>
<li>What this tells us: The failure occurred in our helper function at the fee assertion</li>
<li>Key line: <code>assert 4.2 == 3.7</code> - The actual fee is $4.20, but we expected $3.70</li>
</ul>
<p><strong>The assertion introspection</strong>:</p>
<div class="codehilite"><pre><span></span><code>E       AssertionError: assert 4.2 == 3.7
E        +  where 4.2 = {&#39;success&#39;: True, &#39;amount&#39;: 100.0, &#39;fee&#39;: 4.2, &#39;total&#39;: 104.2, &#39;card_last_four&#39;: &#39;0005&#39;}[&#39;fee&#39;]
</code></pre></div>

<ul>
<li>What this tells us: Pytest shows us the complete result dictionary, revealing that the fee is $4.20 instead of $3.70</li>
</ul>
<p><strong>Root cause identified</strong>: The Amex fee calculation is incorrect‚Äîit's charging 1% extra instead of 0.5% extra.</p>
<p><strong>Why the current approach caught this</strong>: Our hardcoded expected value (3.70) acted as a specification. When the implementation deviated, the test failed.</p>
<p>Good! Our test caught the bug. Let's fix it:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_processor.py (fixed)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">calculate_processing_fee</span><span class="p">(</span><span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">card_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate processing fee based on amount and card type.&quot;&quot;&quot;</span>
    <span class="n">base_fee</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="mf">0.029</span>  <span class="c1"># 2.9% base rate</span>

    <span class="k">if</span> <span class="n">card_type</span> <span class="o">==</span> <span class="s2">&quot;amex&quot;</span><span class="p">:</span>
        <span class="n">base_fee</span> <span class="o">+=</span> <span class="n">amount</span> <span class="o">*</span> <span class="mf">0.005</span>  <span class="c1"># Fixed: 0.5% for Amex</span>

    <span class="n">transaction_fee</span> <span class="o">=</span> <span class="mf">0.30</span>

    <span class="k">return</span> <span class="n">base_fee</span> <span class="o">+</span> <span class="n">transaction_fee</span>
</code></pre></div>

<p>Now all tests pass again. But this raises an important question: should we calculate the expected fee in our tests, or hardcode it?</p>
<h3 id="when-to-apply-this-solution">When to Apply This Solution</h3>
<p><strong>What it optimizes for</strong>:
- Clarity: Hardcoded values make expectations explicit
- Specification: Tests document the exact behavior
- Bug detection: Changes to calculations are immediately visible</p>
<p><strong>What it sacrifices</strong>:
- Maintainability: If fee structure changes, all tests need updates
- Duplication: Fee calculation logic exists in both code and tests</p>
<p><strong>When to choose this approach</strong>:
- Testing business logic with specific requirements
- When the calculation is the core behavior being tested
- When you want tests to serve as documentation</p>
<p><strong>When to avoid this approach</strong>:
- Testing helper functions where the calculation itself isn't critical
- When the calculation is complex and likely to change
- When you're testing the calculation logic itself (use property-based testing instead)</p>
<p><strong>Current state</strong>: We have solid tests for our payment processor. We've tested success cases, error cases, and different card types. Our tests are readable and maintainable.</p>
<h3 id="testing-individual-functions">Testing Individual Functions</h3>
<p>So far, we've been testing <code>process_payment()</code>, which is a high-level function that calls other functions. But what about testing <code>validate_credit_card()</code> and <code>calculate_processing_fee()</code> directly?</p>
<p>Let's add tests for these lower-level functions:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_processor.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">process_payment</span><span class="p">,</span>
    <span class="n">validate_credit_card</span><span class="p">,</span>
    <span class="n">calculate_processing_fee</span>
<span class="p">)</span>

<span class="c1"># Test data</span>
<span class="n">VALID_VISA</span> <span class="o">=</span> <span class="s2">&quot;4532015112830366&quot;</span>
<span class="n">VALID_AMEX</span> <span class="o">=</span> <span class="s2">&quot;378282246310005&quot;</span>
<span class="n">INVALID_CARD</span> <span class="o">=</span> <span class="s2">&quot;1234567890123456&quot;</span>

<span class="c1"># Helper functions</span>
<span class="k">def</span><span class="w"> </span><span class="nf">assert_successful_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">expected_amount</span><span class="p">,</span> <span class="n">expected_fee</span><span class="p">,</span> <span class="n">expected_last_four</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper to verify successful payment results.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_amount</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;fee&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_fee</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_amount</span> <span class="o">+</span> <span class="n">expected_fee</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;card_last_four&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_last_four</span>

<span class="k">def</span><span class="w"> </span><span class="nf">assert_failed_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">expected_error</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper to verify failed payment results.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_error</span>

<span class="c1"># Tests for validate_credit_card()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_credit_card_valid_visa</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">validate_credit_card</span><span class="p">(</span><span class="n">VALID_VISA</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_credit_card_valid_amex</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">validate_credit_card</span><span class="p">(</span><span class="n">VALID_AMEX</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_credit_card_invalid_luhn</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">validate_credit_card</span><span class="p">(</span><span class="n">INVALID_CARD</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_credit_card_non_numeric</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">validate_credit_card</span><span class="p">(</span><span class="s2">&quot;1234-5678-9012-3456&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_credit_card_too_short</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">validate_credit_card</span><span class="p">(</span><span class="s2">&quot;123456789012&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_credit_card_too_long</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">validate_credit_card</span><span class="p">(</span><span class="s2">&quot;12345678901234567890&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span>

<span class="c1"># Tests for calculate_processing_fee()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_processing_fee_visa</span><span class="p">():</span>
    <span class="n">fee</span> <span class="o">=</span> <span class="n">calculate_processing_fee</span><span class="p">(</span><span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fee</span> <span class="o">==</span> <span class="mf">3.20</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_processing_fee_amex</span><span class="p">():</span>
    <span class="n">fee</span> <span class="o">=</span> <span class="n">calculate_processing_fee</span><span class="p">(</span><span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;amex&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fee</span> <span class="o">==</span> <span class="mf">3.70</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_processing_fee_small_amount</span><span class="p">():</span>
    <span class="n">fee</span> <span class="o">=</span> <span class="n">calculate_processing_fee</span><span class="p">(</span><span class="mf">1.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fee</span> <span class="o">==</span> <span class="mf">0.33</span>  <span class="c1"># $0.029 + $0.30 = $0.329, rounded</span>

<span class="c1"># Tests for process_payment()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_visa</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="n">VALID_VISA</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="n">assert_successful_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="mf">3.20</span><span class="p">,</span> <span class="s2">&quot;0366&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_amex</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="n">VALID_AMEX</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;amex&quot;</span><span class="p">)</span>
    <span class="n">assert_successful_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="mf">3.70</span><span class="p">,</span> <span class="s2">&quot;0005&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_invalid_card</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="n">INVALID_CARD</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="n">assert_failed_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;Invalid credit card number&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_negative_amount</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="n">VALID_VISA</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="n">assert_failed_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;Amount must be positive&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Running all tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_processor.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_processor.py::test_validate_credit_card_valid_visa PASSED   [  7%]
test_payment_processor.py::test_validate_credit_card_valid_amex PASSED   [ 14%]
test_payment_processor.py::test_validate_credit_card_invalid_luhn PASSED [ 21%]
test_payment_processor.py::test_validate_credit_card_non_numeric PASSED  [ 28%]
test_payment_processor.py::test_validate_credit_card_too_short PASSED    [ 35%]
test_payment_processor.py::test_validate_credit_card_too_long PASSED     [ 42%]
test_payment_processor.py::test_calculate_processing_fee_visa PASSED     [ 50%]
test_payment_processor.py::test_calculate_processing_fee_amex PASSED     [ 57%]
test_payment_processor.py::test_calculate_processing_fee_small_amount FAILED [ 64%]
test_payment_processor.py::test_process_payment_visa PASSED              [ 71%]
test_payment_processor.py::test_process_payment_amex PASSED              [ 78%]
test_payment_processor.py::test_process_payment_invalid_card PASSED      [ 85%]
test_payment_processor.py::test_process_payment_negative_amount PASSED   [ 92%]

================================= FAILURES =================================
_________________ test_calculate_processing_fee_small_amount ________________

    def test_calculate_processing_fee_small_amount():
        fee = calculate_processing_fee(1.00, &quot;visa&quot;)
&gt;       assert fee == 0.33
E       AssertionError: assert 0.329 == 0.33

test_payment_processor.py:52: AssertionError
========================== 1 failed, 12 passed in 0.04s =======================
</code></pre></div>

<h3 id="diagnostic-analysis-floating-point-precision">Diagnostic Analysis: Floating Point Precision</h3>
<p><strong>The complete output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_processor.py::test_calculate_processing_fee_small_amount FAILED [ 64%]

================================= FAILURES =================================
_________________ test_calculate_processing_fee_small_amount ________________

    def test_calculate_processing_fee_small_amount():
        fee = calculate_processing_fee(1.00, &quot;visa&quot;)
<span class="k">&gt; </span><span class="ge">      assert fee == 0.33</span>
E       AssertionError: assert 0.329 == 0.33

test_payment_processor.py:52: AssertionError
</code></pre></div>

<p><strong>Let's parse this section by section</strong>:</p>
<ol>
<li><strong>The summary line</strong>: <code>FAILED test_payment_processor.py::test_calculate_processing_fee_small_amount - AssertionError</code></li>
<li>
<p>What this tells us: The test failed on an assertion, not an exception</p>
</li>
<li>
<p><strong>The traceback</strong>:</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code>    def test_calculate_processing_fee_small_amount():
        fee = calculate_processing_fee(1.00, &quot;visa&quot;)
<span class="k">&gt; </span><span class="ge">      assert fee == 0.33</span>
E       AssertionError: assert 0.329 == 0.33
</code></pre></div>

<ul>
<li>What this tells us: We expected 0.33, but got 0.329</li>
<li>
<p>Key line: The actual value is 0.329, which is the mathematically correct result ($1.00 * 0.029 + $0.30 = $0.329)</p>
</li>
<li>
<p><strong>The assertion introspection</strong>:</p>
</li>
</ul>
<div class="codehilite"><pre><span></span><code>E       AssertionError: assert 0.329 == 0.33
</code></pre></div>

<ul>
<li>What this tells us: This is a floating-point comparison issue</li>
</ul>
<p><strong>Root cause identified</strong>: We're comparing floating-point numbers with exact equality, which is problematic. The actual fee is $0.329, which we incorrectly rounded to $0.33 in our test.</p>
<p><strong>Why the current approach can't solve this</strong>: Exact equality (<code>==</code>) for floating-point numbers is fragile. We need approximate comparison.</p>
<p><strong>What we need</strong>: Pytest's <code>approx()</code> function for floating-point comparisons.</p>
<p>Let's fix this test:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_processor.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pytest</span><span class="w"> </span><span class="kn">import</span> <span class="n">approx</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">process_payment</span><span class="p">,</span>
    <span class="n">validate_credit_card</span><span class="p">,</span>
    <span class="n">calculate_processing_fee</span>
<span class="p">)</span>

<span class="c1"># ... (previous code remains the same)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_processing_fee_small_amount</span><span class="p">():</span>
    <span class="n">fee</span> <span class="o">=</span> <span class="n">calculate_processing_fee</span><span class="p">(</span><span class="mf">1.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fee</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="mf">0.329</span><span class="p">)</span>  <span class="c1"># Use approx for floating-point comparison</span>
</code></pre></div>

<p>Running the test again:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_processor.py::test_calculate_processing_fee_small_amount<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_processor.py::test_calculate_processing_fee_small_amount PASSED [100%]

========================== 1 passed in 0.01s ===========================
</code></pre></div>

<p>Perfect! Now all our tests pass. Let's run the complete test suite:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_processor.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_processor.py::test_validate_credit_card_valid_visa PASSED   [  7%]
test_payment_processor.py::test_validate_credit_card_valid_amex PASSED   [ 14%]
test_payment_processor.py::test_validate_credit_card_invalid_luhn PASSED [ 21%]
test_payment_processor.py::test_validate_credit_card_non_numeric PASSED  [ 28%]
test_payment_processor.py::test_validate_credit_card_too_short PASSED    [ 35%]
test_payment_processor.py::test_validate_credit_card_too_long PASSED     [ 42%]
test_payment_processor.py::test_calculate_processing_fee_visa PASSED     [ 50%]
test_payment_processor.py::test_calculate_processing_fee_amex PASSED     [ 57%]
test_payment_processor.py::test_calculate_processing_fee_small_amount PASSED [ 64%]
test_payment_processor.py::test_process_payment_visa PASSED              [ 71%]
test_payment_processor.py::test_process_payment_amex PASSED              [ 78%]
test_payment_processor.py::test_process_payment_invalid_card PASSED      [ 85%]
test_payment_processor.py::test_process_payment_negative_amount PASSED   [ 92%]

========================== 13 passed in 0.03s ==========================
</code></pre></div>

<h3 id="the-journey-from-problem-to-solution">The Journey: From Problem to Solution</h3>
<table>
<thead>
<tr>
<th>Iteration</th>
<th>Problem</th>
<th>Solution Applied</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>No tests</td>
<td>Write first test</td>
<td>Basic coverage</td>
</tr>
<tr>
<td>1</td>
<td>Shallow assertions</td>
<td>Test all return fields</td>
<td>Complete verification</td>
</tr>
<tr>
<td>2</td>
<td>Only happy path tested</td>
<td>Add error case tests</td>
<td>Error handling verified</td>
</tr>
<tr>
<td>3</td>
<td>Hardcoded test data</td>
<td>Extract constants</td>
<td>Better maintainability</td>
</tr>
<tr>
<td>4</td>
<td>Repetitive assertions</td>
<td>Create helper functions</td>
<td>Cleaner tests</td>
</tr>
<tr>
<td>5</td>
<td>Single card type tested</td>
<td>Add Amex tests</td>
<td>Multiple scenarios</td>
</tr>
<tr>
<td>6</td>
<td>Floating-point comparison issues</td>
<td>Use pytest.approx()</td>
<td>Robust numeric tests</td>
</tr>
<tr>
<td>7</td>
<td>Only high-level function tested</td>
<td>Test individual functions</td>
<td>Comprehensive coverage</td>
</tr>
</tbody>
</table>
<h3 id="final-implementation">Final Implementation</h3>
<p>Here's our complete test suite:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_processor.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pytest</span><span class="w"> </span><span class="kn">import</span> <span class="n">approx</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">process_payment</span><span class="p">,</span>
    <span class="n">validate_credit_card</span><span class="p">,</span>
    <span class="n">calculate_processing_fee</span>
<span class="p">)</span>

<span class="c1"># Test data</span>
<span class="n">VALID_VISA</span> <span class="o">=</span> <span class="s2">&quot;4532015112830366&quot;</span>
<span class="n">VALID_AMEX</span> <span class="o">=</span> <span class="s2">&quot;378282246310005&quot;</span>
<span class="n">INVALID_CARD</span> <span class="o">=</span> <span class="s2">&quot;1234567890123456&quot;</span>

<span class="c1"># Helper functions</span>
<span class="k">def</span><span class="w"> </span><span class="nf">assert_successful_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">expected_amount</span><span class="p">,</span> <span class="n">expected_fee</span><span class="p">,</span> <span class="n">expected_last_four</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper to verify successful payment results.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_amount</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;fee&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="n">expected_fee</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="n">expected_amount</span> <span class="o">+</span> <span class="n">expected_fee</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;card_last_four&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_last_four</span>

<span class="k">def</span><span class="w"> </span><span class="nf">assert_failed_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">expected_error</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper to verify failed payment results.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_error</span>

<span class="c1"># Tests for validate_credit_card()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_credit_card_valid_visa</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">validate_credit_card</span><span class="p">(</span><span class="n">VALID_VISA</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_credit_card_valid_amex</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">validate_credit_card</span><span class="p">(</span><span class="n">VALID_AMEX</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_credit_card_invalid_luhn</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">validate_credit_card</span><span class="p">(</span><span class="n">INVALID_CARD</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_credit_card_non_numeric</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">validate_credit_card</span><span class="p">(</span><span class="s2">&quot;1234-5678-9012-3456&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_credit_card_too_short</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">validate_credit_card</span><span class="p">(</span><span class="s2">&quot;123456789012&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_credit_card_too_long</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">validate_credit_card</span><span class="p">(</span><span class="s2">&quot;12345678901234567890&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span>

<span class="c1"># Tests for calculate_processing_fee()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_processing_fee_visa</span><span class="p">():</span>
    <span class="n">fee</span> <span class="o">=</span> <span class="n">calculate_processing_fee</span><span class="p">(</span><span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fee</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="mf">3.20</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_processing_fee_amex</span><span class="p">():</span>
    <span class="n">fee</span> <span class="o">=</span> <span class="n">calculate_processing_fee</span><span class="p">(</span><span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;amex&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fee</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="mf">3.70</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_processing_fee_small_amount</span><span class="p">():</span>
    <span class="n">fee</span> <span class="o">=</span> <span class="n">calculate_processing_fee</span><span class="p">(</span><span class="mf">1.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fee</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="mf">0.329</span><span class="p">)</span>

<span class="c1"># Tests for process_payment()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_visa</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="n">VALID_VISA</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="n">assert_successful_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="mf">3.20</span><span class="p">,</span> <span class="s2">&quot;0366&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_amex</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="n">VALID_AMEX</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;amex&quot;</span><span class="p">)</span>
    <span class="n">assert_successful_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="mf">3.70</span><span class="p">,</span> <span class="s2">&quot;0005&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_invalid_card</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="n">INVALID_CARD</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="n">assert_failed_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;Invalid credit card number&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_negative_amount</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span><span class="n">VALID_VISA</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="n">assert_failed_payment</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;Amount must be positive&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="decision-framework-testing-granularity">Decision Framework: Testing Granularity</h3>
<p><strong>When to test individual functions</strong>:
- The function has complex logic worth testing in isolation
- The function is reused in multiple places
- You want to test edge cases that are hard to trigger through high-level functions
- The function's behavior is independent of other functions</p>
<p><strong>When to test only high-level functions</strong>:
- Individual functions are simple and unlikely to fail independently
- The integration between functions is the primary concern
- Testing individual functions would duplicate coverage
- The functions are private implementation details</p>
<p><strong>For our payment processor</strong>:
- We test <code>validate_credit_card()</code> individually because it has complex logic (Luhn algorithm)
- We test <code>calculate_processing_fee()</code> individually because it has business logic worth documenting
- We test <code>process_payment()</code> to verify the integration of all components</p>
<h3 id="lessons-learned">Lessons Learned</h3>
<ol>
<li><strong>Start simple, then refine</strong>: Begin with basic tests and progressively add coverage</li>
<li><strong>Test both success and failure paths</strong>: Don't just test the happy path</li>
<li><strong>Use helper functions to reduce repetition</strong>: Extract common assertion patterns</li>
<li><strong>Use pytest.approx() for floating-point comparisons</strong>: Never use <code>==</code> for floats</li>
<li><strong>Test at multiple levels</strong>: Test both individual functions and their integration</li>
<li><strong>Make test data explicit</strong>: Use constants for test data to improve maintainability</li>
<li><strong>Let failures guide you</strong>: Each failure reveals what needs to be tested next</li>
</ol>
<h2 id="testing-classes-and-object-oriented-code">Testing Classes and Object-Oriented Code</h2>
<h2 id="testing-classes-and-object-oriented-code_1">Testing Classes and Object-Oriented Code</h2>
<p>Functions are the foundation, but most real-world Python code is organized into classes. Testing classes introduces new challenges: managing object state, testing methods that interact with each other, and handling inheritance hierarchies.</p>
<p>Let's extend our payment processor into a class-based design and discover how to test it effectively.</p>
<h3 id="the-reference-implementation-a-payment-gateway-class">The Reference Implementation: A Payment Gateway Class</h3>
<p>We'll refactor our payment processor into a <code>PaymentGateway</code> class that maintains state and provides a more realistic API:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_gateway.py</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentGateway</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A payment gateway that processes credit card transactions.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">merchant_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merchant_id</span> <span class="o">=</span> <span class="n">merchant_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transaction_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_processed</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_credit_card</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate credit card number using Luhn algorithm.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">card_number</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">card_number</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">13</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">card_number</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">19</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Luhn algorithm</span>
        <span class="n">digits</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">card_number</span><span class="p">]</span>
        <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">doubled</span> <span class="o">=</span> <span class="n">digits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">checksum</span> <span class="o">+=</span> <span class="n">doubled</span> <span class="k">if</span> <span class="n">doubled</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="n">doubled</span> <span class="o">-</span> <span class="mi">9</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">checksum</span> <span class="o">+=</span> <span class="n">digits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">checksum</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_fee</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">card_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate processing fee based on amount and card type.&quot;&quot;&quot;</span>
        <span class="n">base_fee</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="mf">0.029</span>

        <span class="k">if</span> <span class="n">card_type</span> <span class="o">==</span> <span class="s2">&quot;amex&quot;</span><span class="p">:</span>
            <span class="n">base_fee</span> <span class="o">+=</span> <span class="n">amount</span> <span class="o">*</span> <span class="mf">0.005</span>

        <span class="k">return</span> <span class="n">base_fee</span> <span class="o">+</span> <span class="mf">0.30</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">card_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a payment transaction.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_credit_card</span><span class="p">(</span><span class="n">card_number</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid credit card number&quot;</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Amount must be positive&quot;</span>
            <span class="p">}</span>

        <span class="n">fee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fee</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">card_type</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">+</span> <span class="n">fee</span>

        <span class="c1"># Record transaction</span>
        <span class="n">transaction</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;card_last_four&quot;</span><span class="p">:</span> <span class="n">card_number</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:],</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s2">&quot;fee&quot;</span><span class="p">:</span> <span class="n">fee</span><span class="p">,</span>
            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">total</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transaction_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_processed</span> <span class="o">+=</span> <span class="n">total</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s2">&quot;fee&quot;</span><span class="p">:</span> <span class="n">fee</span><span class="p">,</span>
            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span>
            <span class="s2">&quot;card_last_four&quot;</span><span class="p">:</span> <span class="n">card_number</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_transaction_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the number of processed transactions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction_history</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_total_processed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the total amount processed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_processed</span>
</code></pre></div>

<p>This is our new reference implementation. It's more realistic: it maintains state, tracks transaction history, and provides methods to query that state.</p>
<h3 id="iteration-0-the-naive-first-test_1">Iteration 0: The Naive First Test</h3>
<p>Let's write the most obvious test:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_gateway.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">payment_gateway</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentGateway</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment</span><span class="p">():</span>
    <span class="n">gateway</span> <span class="o">=</span> <span class="n">PaymentGateway</span><span class="p">(</span><span class="s2">&quot;MERCHANT123&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_key&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
</code></pre></div>

<p>Running this test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_gateway.py::test_process_payment<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_gateway.py::test_process_payment PASSED                     [100%]

========================== 1 passed in 0.01s ===========================
</code></pre></div>

<p>Good! But we have a problem: we're creating a new <code>PaymentGateway</code> instance in every test. This is repetitive and makes our tests harder to maintain.</p>
<p><strong>Current limitation</strong>: Gateway instantiation is duplicated across tests.</p>
<h3 id="iteration-1-using-a-fixture-for-setup">Iteration 1: Using a Fixture for Setup</h3>
<p>Let's create a fixture to provide a gateway instance:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_gateway.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_gateway</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentGateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a PaymentGateway instance for testing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentGateway</span><span class="p">(</span><span class="s2">&quot;MERCHANT123&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_key&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
</code></pre></div>

<p>Running this test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_gateway.py::test_process_payment<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_gateway.py::test_process_payment PASSED                     [100%]

========================== 1 passed in 0.01s ===========================
</code></pre></div>

<p>Much better! Now we can reuse the gateway fixture across multiple tests. But there's a subtle issue: what happens if one test modifies the gateway's state? Will it affect other tests?</p>
<p><strong>Current limitation</strong>: We don't know if our fixture provides test isolation.</p>
<h3 id="iteration-2-testing-state-isolation">Iteration 2: Testing State Isolation</h3>
<p>Let's write two tests that modify the gateway's state:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_gateway.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_gateway</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentGateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a PaymentGateway instance for testing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentGateway</span><span class="p">(</span><span class="s2">&quot;MERCHANT123&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_key&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_first_transaction</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_second_transaction</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
    <span class="c1"># This test should start with a clean gateway</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">50.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>

<p>Running these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_gateway.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_gateway.py::test_first_transaction PASSED                   [ 50%]
test_payment_gateway.py::test_second_transaction PASSED                  [100%]

========================== 2 passed in 0.01s ===========================
</code></pre></div>

<p>Excellent! Both tests pass, which means each test gets a fresh gateway instance. This is because pytest fixtures have <strong>function scope</strong> by default‚Äîthey're recreated for each test function.</p>
<p><strong>Verification</strong>: Our fixture provides proper test isolation. Each test starts with a clean gateway.</p>
<h3 id="iteration-3-testing-state-accumulation">Iteration 3: Testing State Accumulation</h3>
<p>Now let's test that the gateway correctly accumulates state across multiple transactions:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_gateway.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pytest</span><span class="w"> </span><span class="kn">import</span> <span class="n">approx</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_gateway</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentGateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a PaymentGateway instance for testing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentGateway</span><span class="p">(</span><span class="s2">&quot;MERCHANT123&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_key&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_transaction_count_accumulates</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">50.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">25.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_total_processed_accumulates</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">get_total_processed</span><span class="p">()</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># First transaction: $100 + $3.20 fee = $103.20</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">get_total_processed</span><span class="p">()</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="mf">103.20</span><span class="p">)</span>

    <span class="c1"># Second transaction: $50 + $1.75 fee = $51.75</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">50.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">get_total_processed</span><span class="p">()</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="mf">103.20</span> <span class="o">+</span> <span class="mf">51.75</span><span class="p">)</span>
</code></pre></div>

<p>Running these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_gateway.py::test_transaction_count_accumulates<span class="w"> </span>-v
$<span class="w"> </span>pytest<span class="w"> </span>test_payment_gateway.py::test_total_processed_accumulates<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_gateway.py::test_transaction_count_accumulates PASSED       [100%]

========================== 1 passed in 0.01s ===========================

test_payment_gateway.py::test_total_processed_accumulates PASSED         [100%]

========================== 1 passed in 0.01s ===========================
</code></pre></div>

<p>Perfect! Our tests verify that the gateway correctly maintains state across multiple transactions within a single test.</p>
<p><strong>Current state</strong>: We can test both state isolation (between tests) and state accumulation (within tests).</p>
<h3 id="iteration-4-testing-method-interactions">Iteration 4: Testing Method Interactions</h3>
<p>Our gateway has methods that depend on each other. Let's test that they interact correctly:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_gateway.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pytest</span><span class="w"> </span><span class="kn">import</span> <span class="n">approx</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_gateway</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentGateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a PaymentGateway instance for testing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentGateway</span><span class="p">(</span><span class="s2">&quot;MERCHANT123&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_key&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_failed_transaction_not_recorded</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Failed transactions should not be added to history.&quot;&quot;&quot;</span>
    <span class="c1"># Try to process with invalid card</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;1234567890123456&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">get_total_processed</span><span class="p">()</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_successful_transaction_recorded</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Successful transactions should be added to history.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">get_total_processed</span><span class="p">()</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="mf">103.20</span><span class="p">)</span>
</code></pre></div>

<p>Running these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_gateway.py::test_failed_transaction_not_recorded<span class="w"> </span>-v
$<span class="w"> </span>pytest<span class="w"> </span>test_payment_gateway.py::test_successful_transaction_recorded<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_gateway.py::test_failed_transaction_not_recorded PASSED     [100%]

========================== 1 passed in 0.01s ===========================

test_payment_gateway.py::test_successful_transaction_recorded PASSED     [100%]

========================== 1 passed in 0.01s ===========================
</code></pre></div>

<p>Excellent! We're now testing the interaction between <code>process_payment()</code> and the state-tracking methods.</p>
<p><strong>Current limitation</strong>: We're testing the gateway's public interface, but what about testing individual methods in isolation?</p>
<h3 id="iteration-5-testing-individual-methods">Iteration 5: Testing Individual Methods</h3>
<p>Let's add tests for the individual methods:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_gateway.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pytest</span><span class="w"> </span><span class="kn">import</span> <span class="n">approx</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_gateway</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentGateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a PaymentGateway instance for testing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentGateway</span><span class="p">(</span><span class="s2">&quot;MERCHANT123&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_key&quot;</span><span class="p">)</span>

<span class="c1"># Tests for validate_credit_card()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_credit_card_valid</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">validate_credit_card</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_credit_card_invalid</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">validate_credit_card</span><span class="p">(</span><span class="s2">&quot;1234567890123456&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_credit_card_non_numeric</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">validate_credit_card</span><span class="p">(</span><span class="s2">&quot;1234-5678-9012-3456&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span>

<span class="c1"># Tests for calculate_fee()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_fee_visa</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
    <span class="n">fee</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">calculate_fee</span><span class="p">(</span><span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fee</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="mf">3.20</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_fee_amex</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
    <span class="n">fee</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">calculate_fee</span><span class="p">(</span><span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;amex&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fee</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="mf">3.70</span><span class="p">)</span>

<span class="c1"># Tests for process_payment()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_success</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="mf">100.00</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;fee&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="mf">3.20</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_invalid_card</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;1234567890123456&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Invalid credit card number&quot;</span>

<span class="c1"># Tests for state management</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_transaction_count_accumulates</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">50.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_failed_transaction_not_recorded</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;1234567890123456&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
</code></pre></div>

<p>Running all tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_gateway.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_gateway.py::test_validate_credit_card_valid PASSED          [ 10%]
test_payment_gateway.py::test_validate_credit_card_invalid PASSED        [ 20%]
test_payment_gateway.py::test_validate_credit_card_non_numeric PASSED    [ 30%]
test_payment_gateway.py::test_calculate_fee_visa PASSED                  [ 40%]
test_payment_gateway.py::test_calculate_fee_amex PASSED                  [ 50%]
test_payment_gateway.py::test_process_payment_success PASSED             [ 60%]
test_payment_gateway.py::test_process_payment_invalid_card PASSED        [ 70%]
test_payment_gateway.py::test_transaction_count_accumulates PASSED       [ 80%]
test_payment_gateway.py::test_failed_transaction_not_recorded PASSED     [ 90%]

========================== 9 passed in 0.03s ==========================
</code></pre></div>

<p>Perfect! We now have comprehensive coverage of our <code>PaymentGateway</code> class.</p>
<h3 id="testing-class-initialization">Testing Class Initialization</h3>
<p>We should also test that the gateway is initialized correctly:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_gateway.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pytest</span><span class="w"> </span><span class="kn">import</span> <span class="n">approx</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_gateway</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentGateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a PaymentGateway instance for testing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentGateway</span><span class="p">(</span><span class="s2">&quot;MERCHANT123&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_key&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_gateway_initialization</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that gateway is initialized with correct state.&quot;&quot;&quot;</span>
    <span class="n">gateway</span> <span class="o">=</span> <span class="n">PaymentGateway</span><span class="p">(</span><span class="s2">&quot;MERCHANT123&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_key&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">merchant_id</span> <span class="o">==</span> <span class="s2">&quot;MERCHANT123&quot;</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">api_key</span> <span class="o">==</span> <span class="s2">&quot;secret_key&quot;</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">transaction_history</span> <span class="o">==</span> <span class="p">[]</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">total_processed</span> <span class="o">==</span> <span class="mf">0.0</span>

<span class="c1"># ... (rest of the tests remain the same)</span>
</code></pre></div>

<p>Running this test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_gateway.py::test_gateway_initialization<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_gateway.py::test_gateway_initialization PASSED              [100%]

========================== 1 passed in 0.01s ===========================
</code></pre></div>

<h3 id="testing-class-inheritance">Testing Class Inheritance</h3>
<p>Let's extend our gateway with a subclass that adds fraud detection:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_gateway.py</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentGateway</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A payment gateway that processes credit card transactions.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">merchant_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merchant_id</span> <span class="o">=</span> <span class="n">merchant_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transaction_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_processed</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># ... (previous methods remain the same)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FraudDetectionGateway</span><span class="p">(</span><span class="n">PaymentGateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A payment gateway with fraud detection capabilities.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">merchant_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fraud_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1000.0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">merchant_id</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fraud_threshold</span> <span class="o">=</span> <span class="n">fraud_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flagged_transactions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_suspicious</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">card_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a transaction is suspicious.&quot;&quot;&quot;</span>
        <span class="c1"># Flag transactions over threshold</span>
        <span class="k">if</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraud_threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Flag if same card used multiple times in short period</span>
        <span class="n">recent_cards</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;card_last_four&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_history</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]]</span>
        <span class="k">if</span> <span class="n">recent_cards</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">card_number</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:])</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">card_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a payment with fraud detection.&quot;&quot;&quot;</span>
        <span class="c1"># Check for fraud before processing</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_suspicious</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">card_number</span><span class="p">):</span>
            <span class="n">transaction</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;card_last_four&quot;</span><span class="p">:</span> <span class="n">card_number</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:],</span>
                <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
                <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;Suspicious activity detected&quot;</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flagged_transactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Transaction flagged for review&quot;</span>
            <span class="p">}</span>

        <span class="c1"># Process normally if not suspicious</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">card_number</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">card_type</span><span class="p">)</span>
</code></pre></div>

<p>Now let's test the subclass:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_gateway.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pytest</span><span class="w"> </span><span class="kn">import</span> <span class="n">approx</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_gateway</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentGateway</span><span class="p">,</span> <span class="n">FraudDetectionGateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a PaymentGateway instance for testing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentGateway</span><span class="p">(</span><span class="s2">&quot;MERCHANT123&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_key&quot;</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fraud_gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a FraudDetectionGateway instance for testing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">FraudDetectionGateway</span><span class="p">(</span><span class="s2">&quot;MERCHANT123&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_key&quot;</span><span class="p">,</span> <span class="n">fraud_threshold</span><span class="o">=</span><span class="mf">500.0</span><span class="p">)</span>

<span class="c1"># ... (previous tests remain the same)</span>

<span class="c1"># Tests for FraudDetectionGateway</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_fraud_gateway_initialization</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that fraud gateway is initialized correctly.&quot;&quot;&quot;</span>
    <span class="n">gateway</span> <span class="o">=</span> <span class="n">FraudDetectionGateway</span><span class="p">(</span><span class="s2">&quot;MERCHANT123&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_key&quot;</span><span class="p">,</span> <span class="n">fraud_threshold</span><span class="o">=</span><span class="mf">500.0</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">merchant_id</span> <span class="o">==</span> <span class="s2">&quot;MERCHANT123&quot;</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">api_key</span> <span class="o">==</span> <span class="s2">&quot;secret_key&quot;</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">fraud_threshold</span> <span class="o">==</span> <span class="mf">500.0</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">flagged_transactions</span> <span class="o">==</span> <span class="p">[]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_fraud_detection_high_amount</span><span class="p">(</span><span class="n">fraud_gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that high-value transactions are flagged.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">fraud_gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">1000.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Transaction flagged for review&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fraud_gateway</span><span class="o">.</span><span class="n">flagged_transactions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_fraud_detection_normal_amount</span><span class="p">(</span><span class="n">fraud_gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that normal transactions are not flagged.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">fraud_gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fraud_gateway</span><span class="o">.</span><span class="n">flagged_transactions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_fraud_detection_repeated_card</span><span class="p">(</span><span class="n">fraud_gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that repeated card usage is flagged.&quot;&quot;&quot;</span>
    <span class="n">card</span> <span class="o">=</span> <span class="s2">&quot;4532015112830366&quot;</span>

    <span class="c1"># Process 3 transactions with same card</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">fraud_gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="c1"># Fourth transaction should be flagged</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">fraud_gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Transaction flagged for review&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fraud_gateway</span><span class="o">.</span><span class="n">flagged_transactions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>

<p>Running the fraud detection tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_gateway.py<span class="w"> </span>-k<span class="w"> </span>fraud<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_gateway.py::test_fraud_gateway_initialization PASSED        [ 25%]
test_payment_gateway.py::test_fraud_detection_high_amount PASSED         [ 50%]
test_payment_gateway.py::test_fraud_detection_normal_amount PASSED       [ 75%]
test_payment_gateway.py::test_fraud_detection_repeated_card PASSED       [100%]

========================== 4 passed in 0.02s ==========================
</code></pre></div>

<p>Excellent! Our tests verify that:
1. The subclass inherits base functionality correctly
2. The subclass adds new behavior (fraud detection)
3. The subclass overrides methods appropriately</p>
<h3 id="the-journey-from-problem-to-solution_1">The Journey: From Problem to Solution</h3>
<table>
<thead>
<tr>
<th>Iteration</th>
<th>Problem</th>
<th>Solution Applied</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>No tests for class</td>
<td>Write first test</td>
<td>Basic coverage</td>
</tr>
<tr>
<td>1</td>
<td>Repeated instantiation</td>
<td>Create fixture</td>
<td>Reusable setup</td>
</tr>
<tr>
<td>2</td>
<td>Unknown isolation behavior</td>
<td>Test state isolation</td>
<td>Verified isolation</td>
</tr>
<tr>
<td>3</td>
<td>Need to test state accumulation</td>
<td>Test multiple transactions</td>
<td>State tracking verified</td>
</tr>
<tr>
<td>4</td>
<td>Need to test method interactions</td>
<td>Test success/failure recording</td>
<td>Integration verified</td>
</tr>
<tr>
<td>5</td>
<td>Need individual method tests</td>
<td>Test each method separately</td>
<td>Complete coverage</td>
</tr>
<tr>
<td>6</td>
<td>Need to test inheritance</td>
<td>Create subclass and test it</td>
<td>Inheritance verified</td>
</tr>
</tbody>
</table>
<h3 id="decision-framework-testing-class-methods">Decision Framework: Testing Class Methods</h3>
<p><strong>When to test methods individually</strong>:
- The method has complex logic independent of other methods
- The method is public API that users will call directly
- You want to test edge cases that are hard to trigger through high-level methods
- The method's behavior is worth documenting separately</p>
<p><strong>When to test methods through integration</strong>:
- Methods are simple and unlikely to fail independently
- The interaction between methods is the primary concern
- Testing individually would duplicate coverage
- Methods are private implementation details</p>
<p><strong>For our payment gateway</strong>:
- We test <code>validate_credit_card()</code> and <code>calculate_fee()</code> individually because they have independent logic
- We test <code>process_payment()</code> both individually and through state-tracking methods
- We test state-tracking methods (<code>get_transaction_count()</code>, <code>get_total_processed()</code>) through integration</p>
<h3 id="lessons-learned_1">Lessons Learned</h3>
<ol>
<li><strong>Use fixtures for class instantiation</strong>: Avoid repeating setup code</li>
<li><strong>Test state isolation</strong>: Verify that tests don't interfere with each other</li>
<li><strong>Test state accumulation</strong>: Verify that objects maintain state correctly</li>
<li><strong>Test method interactions</strong>: Verify that methods work together correctly</li>
<li><strong>Test inheritance carefully</strong>: Verify both inherited and overridden behavior</li>
<li><strong>Test initialization</strong>: Verify that objects start in the correct state</li>
<li><strong>Use descriptive test names</strong>: Make it clear what each test verifies</li>
</ol>
<h2 id="testing-private-methods-and-why-you-might-not-want-to">Testing Private Methods (And Why You Might Not Want To)</h2>
<h2 id="testing-private-methods-and-why-you-might-not-want-to_1">Testing Private Methods (And Why You Might Not Want To)</h2>
<p>Python doesn't have true private methods‚Äîthe single underscore (<code>_method</code>) and double underscore (<code>__method</code>) are conventions, not enforcement. This raises a question: should we test methods marked as "private"?</p>
<p>The short answer: <strong>usually not directly</strong>. But let's explore why, and when you might make exceptions.</p>
<h3 id="the-reference-implementation-a-gateway-with-private-methods">The Reference Implementation: A Gateway with Private Methods</h3>
<p>Let's refactor our payment gateway to use private methods for internal logic:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_gateway.py</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentGateway</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A payment gateway that processes credit card transactions.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">merchant_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merchant_id</span> <span class="o">=</span> <span class="n">merchant_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transaction_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_processed</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_luhn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Private: Validate using Luhn algorithm.&quot;&quot;&quot;</span>
        <span class="n">digits</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">card_number</span><span class="p">]</span>
        <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">doubled</span> <span class="o">=</span> <span class="n">digits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">checksum</span> <span class="o">+=</span> <span class="n">doubled</span> <span class="k">if</span> <span class="n">doubled</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="n">doubled</span> <span class="o">-</span> <span class="mi">9</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">checksum</span> <span class="o">+=</span> <span class="n">digits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">checksum</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Private: Validate card number format.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">card_number</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">card_number</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">13</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">card_number</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">19</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_credit_card</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Public: Validate credit card number.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_format</span><span class="p">(</span><span class="n">card_number</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_luhn</span><span class="p">(</span><span class="n">card_number</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_base_fee</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Private: Calculate base processing fee.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">amount</span> <span class="o">*</span> <span class="mf">0.029</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_card_type_fee</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">card_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Private: Calculate card-type-specific fee.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">card_type</span> <span class="o">==</span> <span class="s2">&quot;amex&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">amount</span> <span class="o">*</span> <span class="mf">0.005</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_fee</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">card_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Public: Calculate total processing fee.&quot;&quot;&quot;</span>
        <span class="n">base_fee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_base_fee</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
        <span class="n">card_fee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_card_type_fee</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">card_type</span><span class="p">)</span>
        <span class="n">transaction_fee</span> <span class="o">=</span> <span class="mf">0.30</span>
        <span class="k">return</span> <span class="n">base_fee</span> <span class="o">+</span> <span class="n">card_fee</span> <span class="o">+</span> <span class="n">transaction_fee</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_record_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">fee</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Private: Record a successful transaction.&quot;&quot;&quot;</span>
        <span class="n">transaction</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;card_last_four&quot;</span><span class="p">:</span> <span class="n">card_number</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:],</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s2">&quot;fee&quot;</span><span class="p">:</span> <span class="n">fee</span><span class="p">,</span>
            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">amount</span> <span class="o">+</span> <span class="n">fee</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transaction_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_processed</span> <span class="o">+=</span> <span class="n">amount</span> <span class="o">+</span> <span class="n">fee</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">card_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Public: Process a payment transaction.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_credit_card</span><span class="p">(</span><span class="n">card_number</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid credit card number&quot;</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Amount must be positive&quot;</span>
            <span class="p">}</span>

        <span class="n">fee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fee</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">card_type</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">+</span> <span class="n">fee</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_record_transaction</span><span class="p">(</span><span class="n">card_number</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">fee</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s2">&quot;fee&quot;</span><span class="p">:</span> <span class="n">fee</span><span class="p">,</span>
            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span>
            <span class="s2">&quot;card_last_four&quot;</span><span class="p">:</span> <span class="n">card_number</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_transaction_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Public: Get the number of processed transactions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction_history</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_total_processed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Public: Get the total amount processed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_processed</span>
</code></pre></div>

<p>Now we have several private methods:
- <code>_validate_luhn()</code> - Luhn algorithm implementation
- <code>_validate_format()</code> - Format validation
- <code>_calculate_base_fee()</code> - Base fee calculation
- <code>_calculate_card_type_fee()</code> - Card-type-specific fee
- <code>_record_transaction()</code> - Transaction recording</p>
<h3 id="iteration-0-testing-only-public-methods">Iteration 0: Testing Only Public Methods</h3>
<p>Let's write tests that only use the public API:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_gateway.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pytest</span><span class="w"> </span><span class="kn">import</span> <span class="n">approx</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_gateway</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentGateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a PaymentGateway instance for testing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentGateway</span><span class="p">(</span><span class="s2">&quot;MERCHANT123&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_key&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_credit_card_valid</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test validation with valid card.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">validate_credit_card</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_credit_card_invalid_luhn</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test validation with invalid Luhn checksum.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">validate_credit_card</span><span class="p">(</span><span class="s2">&quot;1234567890123456&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_credit_card_invalid_format</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test validation with invalid format.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">validate_credit_card</span><span class="p">(</span><span class="s2">&quot;1234-5678-9012-3456&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_fee_visa</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test fee calculation for Visa.&quot;&quot;&quot;</span>
    <span class="n">fee</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">calculate_fee</span><span class="p">(</span><span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fee</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="mf">3.20</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_fee_amex</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test fee calculation for Amex.&quot;&quot;&quot;</span>
    <span class="n">fee</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">calculate_fee</span><span class="p">(</span><span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;amex&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fee</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="mf">3.70</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_records_transaction</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that successful payment is recorded.&quot;&quot;&quot;</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">get_total_processed</span><span class="p">()</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="mf">103.20</span><span class="p">)</span>
</code></pre></div>

<p>Running these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_gateway.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_gateway.py::test_validate_credit_card_valid PASSED          [ 16%]
test_payment_gateway.py::test_validate_credit_card_invalid_luhn PASSED   [ 33%]
test_payment_gateway.py::test_validate_credit_card_invalid_format PASSED [ 50%]
test_payment_gateway.py::test_calculate_fee_visa PASSED                  [ 66%]
test_payment_gateway.py::test_calculate_fee_amex PASSED                  [ 83%]
test_payment_gateway.py::test_process_payment_records_transaction PASSED [100%]

========================== 6 passed in 0.02s ==========================
</code></pre></div>

<p>Perfect! All our tests pass, and we've achieved good coverage without testing private methods directly.</p>
<p><strong>Key insight</strong>: By testing the public API, we've indirectly tested all the private methods. If <code>_validate_luhn()</code> is broken, <code>validate_credit_card()</code> will fail. If <code>_record_transaction()</code> is broken, our state-tracking tests will fail.</p>
<h3 id="when-testing-private-methods-makes-sense">When Testing Private Methods Makes Sense</h3>
<p>But what if a private method has complex logic that's hard to test through the public API? Let's add a more complex private method:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_gateway.py</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentGateway</span><span class="p">:</span>
    <span class="c1"># ... (previous code remains the same)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_detect_card_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Private: Detect card type from card number.&quot;&quot;&quot;</span>
        <span class="c1"># Visa: starts with 4</span>
        <span class="k">if</span> <span class="n">card_number</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;visa&quot;</span>

        <span class="c1"># Mastercard: starts with 51-55 or 2221-2720</span>
        <span class="k">if</span> <span class="n">card_number</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;51&quot;</span><span class="p">,</span> <span class="s2">&quot;52&quot;</span><span class="p">,</span> <span class="s2">&quot;53&quot;</span><span class="p">,</span> <span class="s2">&quot;54&quot;</span><span class="p">,</span> <span class="s2">&quot;55&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s2">&quot;mastercard&quot;</span>
        <span class="k">if</span> <span class="mi">2221</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">card_number</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">2720</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;mastercard&quot;</span>

        <span class="c1"># Amex: starts with 34 or 37</span>
        <span class="k">if</span> <span class="n">card_number</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;34&quot;</span><span class="p">,</span> <span class="s2">&quot;37&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s2">&quot;amex&quot;</span>

        <span class="c1"># Discover: starts with 6011, 622126-622925, 644-649, or 65</span>
        <span class="k">if</span> <span class="n">card_number</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;6011&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;discover&quot;</span>
        <span class="k">if</span> <span class="mi">622126</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">card_number</span><span class="p">[:</span><span class="mi">6</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">622925</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;discover&quot;</span>
        <span class="k">if</span> <span class="n">card_number</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;644&quot;</span><span class="p">,</span> <span class="s2">&quot;645&quot;</span><span class="p">,</span> <span class="s2">&quot;646&quot;</span><span class="p">,</span> <span class="s2">&quot;647&quot;</span><span class="p">,</span> <span class="s2">&quot;648&quot;</span><span class="p">,</span> <span class="s2">&quot;649&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s2">&quot;discover&quot;</span>
        <span class="k">if</span> <span class="n">card_number</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;65&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;discover&quot;</span>

        <span class="k">return</span> <span class="s2">&quot;unknown&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">card_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Public: Process a payment transaction.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_credit_card</span><span class="p">(</span><span class="n">card_number</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid credit card number&quot;</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Amount must be positive&quot;</span>
            <span class="p">}</span>

        <span class="c1"># Auto-detect card type if not provided</span>
        <span class="k">if</span> <span class="n">card_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">card_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_card_type</span><span class="p">(</span><span class="n">card_number</span><span class="p">)</span>

        <span class="n">fee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fee</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">card_type</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">+</span> <span class="n">fee</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_record_transaction</span><span class="p">(</span><span class="n">card_number</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">fee</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s2">&quot;fee&quot;</span><span class="p">:</span> <span class="n">fee</span><span class="p">,</span>
            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span>
            <span class="s2">&quot;card_last_four&quot;</span><span class="p">:</span> <span class="n">card_number</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:],</span>
            <span class="s2">&quot;card_type&quot;</span><span class="p">:</span> <span class="n">card_type</span>
        <span class="p">}</span>
</code></pre></div>

<p>Now we have a complex private method <code>_detect_card_type()</code> with many edge cases. Testing all these cases through <code>process_payment()</code> would require many valid card numbers for each type.</p>
<h3 id="iteration-1-testing-private-methods-directly">Iteration 1: Testing Private Methods Directly</h3>
<p>Let's test the private method directly:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_gateway.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pytest</span><span class="w"> </span><span class="kn">import</span> <span class="n">approx</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_gateway</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentGateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a PaymentGateway instance for testing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentGateway</span><span class="p">(</span><span class="s2">&quot;MERCHANT123&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_key&quot;</span><span class="p">)</span>

<span class="c1"># Tests for private method _detect_card_type()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_detect_card_type_visa</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test Visa detection.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">_detect_card_type</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;visa&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_detect_card_type_mastercard_51</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test Mastercard detection (51-55 range).&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">_detect_card_type</span><span class="p">(</span><span class="s2">&quot;5425233430109903&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;mastercard&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_detect_card_type_mastercard_2221</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test Mastercard detection (2221-2720 range).&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">_detect_card_type</span><span class="p">(</span><span class="s2">&quot;2221000000000009&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;mastercard&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_detect_card_type_amex</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test Amex detection.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">_detect_card_type</span><span class="p">(</span><span class="s2">&quot;378282246310005&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;amex&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_detect_card_type_discover_6011</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test Discover detection (6011 prefix).&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">_detect_card_type</span><span class="p">(</span><span class="s2">&quot;6011111111111117&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;discover&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_detect_card_type_discover_65</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test Discover detection (65 prefix).&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">_detect_card_type</span><span class="p">(</span><span class="s2">&quot;6500000000000002&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;discover&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_detect_card_type_unknown</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test unknown card type.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">_detect_card_type</span><span class="p">(</span><span class="s2">&quot;9999999999999999&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;unknown&quot;</span>
</code></pre></div>

<p>Running these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_gateway.py<span class="w"> </span>-k<span class="w"> </span>detect<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_gateway.py::test_detect_card_type_visa PASSED               [ 14%]
test_payment_gateway.py::test_detect_card_type_mastercard_51 PASSED      [ 28%]
test_payment_gateway.py::test_detect_card_type_mastercard_2221 PASSED    [ 42%]
test_payment_gateway.py::test_detect_card_type_amex PASSED               [ 57%]
test_payment_gateway.py::test_detect_card_type_discover_6011 PASSED      [ 71%]
test_payment_gateway.py::test_detect_card_type_discover_65 PASSED        [ 85%]
test_payment_gateway.py::test_detect_card_type_unknown PASSED            [100%]

========================== 7 passed in 0.02s ==========================
</code></pre></div>

<p>Good! We've tested the complex private method directly. But now we have a problem: we're testing implementation details. If we refactor <code>_detect_card_type()</code> to use a different algorithm, our tests will break even if the public behavior is unchanged.</p>
<h3 id="the-trade-off-implementation-testing-vs-behavior-testing">The Trade-off: Implementation Testing vs. Behavior Testing</h3>
<p><strong>Testing private methods directly</strong>:</p>
<p><strong>Pros</strong>:
- Easier to test complex logic in isolation
- More granular failure messages
- Can test edge cases that are hard to trigger through public API</p>
<p><strong>Cons</strong>:
- Tests become coupled to implementation
- Refactoring becomes harder
- Tests may pass even if public behavior is broken</p>
<p><strong>Testing only public methods</strong>:</p>
<p><strong>Pros</strong>:
- Tests verify actual user-facing behavior
- Refactoring is easier (tests don't break)
- Tests document the public API</p>
<p><strong>Cons</strong>:
- Complex private logic may be under-tested
- Failure messages may be less specific
- May require more setup to trigger edge cases</p>
<h3 id="iteration-2-a-hybrid-approach">Iteration 2: A Hybrid Approach</h3>
<p>Let's use a hybrid approach: test the public API thoroughly, but add a few targeted tests for complex private methods:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_gateway.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pytest</span><span class="w"> </span><span class="kn">import</span> <span class="n">approx</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_gateway</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentGateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a PaymentGateway instance for testing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentGateway</span><span class="p">(</span><span class="s2">&quot;MERCHANT123&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_key&quot;</span><span class="p">)</span>

<span class="c1"># Primary tests: Public API</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_auto_detect_visa</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test payment processing with auto-detected Visa.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;card_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;visa&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;fee&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="mf">3.20</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_auto_detect_amex</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test payment processing with auto-detected Amex.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;378282246310005&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;card_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;amex&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;fee&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="mf">3.70</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_explicit_card_type</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test payment processing with explicit card type.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="n">card_type</span><span class="o">=</span><span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;card_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;visa&quot;</span>

<span class="c1"># Supplementary tests: Complex private method</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_detect_card_type_edge_cases</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test card type detection edge cases.&quot;&quot;&quot;</span>
    <span class="c1"># These are hard to test through public API because they require</span>
    <span class="c1"># valid card numbers for each edge case</span>

    <span class="c1"># Mastercard 2221-2720 range (new BIN range)</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">_detect_card_type</span><span class="p">(</span><span class="s2">&quot;2221000000000009&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;mastercard&quot;</span>

    <span class="c1"># Discover 622126-622925 range</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">_detect_card_type</span><span class="p">(</span><span class="s2">&quot;6221260000000000&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;discover&quot;</span>

    <span class="c1"># Unknown card type</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">_detect_card_type</span><span class="p">(</span><span class="s2">&quot;9999999999999999&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;unknown&quot;</span>
</code></pre></div>

<p>Running all tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_gateway.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_gateway.py::test_process_payment_auto_detect_visa PASSED    [ 33%]
test_payment_gateway.py::test_process_payment_auto_detect_amex PASSED    [ 66%]
test_payment_gateway.py::test_process_payment_explicit_card_type PASSED  [100%]
test_payment_gateway.py::test_detect_card_type_edge_cases PASSED         [100%]

========================== 4 passed in 0.02s ==========================
</code></pre></div>

<p>This hybrid approach gives us:
1. <strong>Primary coverage</strong> through public API tests
2. <strong>Supplementary coverage</strong> for complex edge cases in private methods
3. <strong>Flexibility</strong> to refactor without breaking most tests</p>
<h3 id="when-to-test-private-methods">When to Test Private Methods</h3>
<p><strong>Test private methods directly when</strong>:
- The method has complex logic with many edge cases
- Testing through public API would require excessive setup
- The method is critical to correctness (e.g., security, financial calculations)
- The method is unlikely to change (stable implementation)</p>
<p><strong>Don't test private methods when</strong>:
- The logic is simple and well-covered by public API tests
- The method is likely to be refactored
- Testing through public API is straightforward
- The method is just a helper for code organization</p>
<h3 id="alternative-make-it-public">Alternative: Make It Public</h3>
<p>If you find yourself wanting to test a private method extensively, consider whether it should be public:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_gateway.py</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CardTypeDetector</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Utility class for detecting card types.&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">detect</span><span class="p">(</span><span class="n">card_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detect card type from card number.&quot;&quot;&quot;</span>
        <span class="c1"># Visa: starts with 4</span>
        <span class="k">if</span> <span class="n">card_number</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;visa&quot;</span>

        <span class="c1"># Mastercard: starts with 51-55 or 2221-2720</span>
        <span class="k">if</span> <span class="n">card_number</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;51&quot;</span><span class="p">,</span> <span class="s2">&quot;52&quot;</span><span class="p">,</span> <span class="s2">&quot;53&quot;</span><span class="p">,</span> <span class="s2">&quot;54&quot;</span><span class="p">,</span> <span class="s2">&quot;55&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s2">&quot;mastercard&quot;</span>
        <span class="k">if</span> <span class="mi">2221</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">card_number</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">2720</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;mastercard&quot;</span>

        <span class="c1"># Amex: starts with 34 or 37</span>
        <span class="k">if</span> <span class="n">card_number</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;34&quot;</span><span class="p">,</span> <span class="s2">&quot;37&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s2">&quot;amex&quot;</span>

        <span class="c1"># Discover: starts with 6011, 622126-622925, 644-649, or 65</span>
        <span class="k">if</span> <span class="n">card_number</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;6011&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;discover&quot;</span>
        <span class="k">if</span> <span class="mi">622126</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">card_number</span><span class="p">[:</span><span class="mi">6</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">622925</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;discover&quot;</span>
        <span class="k">if</span> <span class="n">card_number</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;644&quot;</span><span class="p">,</span> <span class="s2">&quot;645&quot;</span><span class="p">,</span> <span class="s2">&quot;646&quot;</span><span class="p">,</span> <span class="s2">&quot;647&quot;</span><span class="p">,</span> <span class="s2">&quot;648&quot;</span><span class="p">,</span> <span class="s2">&quot;649&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s2">&quot;discover&quot;</span>
        <span class="k">if</span> <span class="n">card_number</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;65&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;discover&quot;</span>

        <span class="k">return</span> <span class="s2">&quot;unknown&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentGateway</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A payment gateway that processes credit card transactions.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">merchant_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merchant_id</span> <span class="o">=</span> <span class="n">merchant_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transaction_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_processed</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">card_detector</span> <span class="o">=</span> <span class="n">CardTypeDetector</span><span class="p">()</span>

    <span class="c1"># ... (other methods remain the same)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">card_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Public: Process a payment transaction.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_credit_card</span><span class="p">(</span><span class="n">card_number</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid credit card number&quot;</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Amount must be positive&quot;</span>
            <span class="p">}</span>

        <span class="c1"># Auto-detect card type if not provided</span>
        <span class="k">if</span> <span class="n">card_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">card_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">card_detector</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">card_number</span><span class="p">)</span>

        <span class="n">fee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fee</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">card_type</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">+</span> <span class="n">fee</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_record_transaction</span><span class="p">(</span><span class="n">card_number</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">fee</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s2">&quot;fee&quot;</span><span class="p">:</span> <span class="n">fee</span><span class="p">,</span>
            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span>
            <span class="s2">&quot;card_last_four&quot;</span><span class="p">:</span> <span class="n">card_number</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:],</span>
            <span class="s2">&quot;card_type&quot;</span><span class="p">:</span> <span class="n">card_type</span>
        <span class="p">}</span>
</code></pre></div>

<p>Now we can test <code>CardTypeDetector</code> as a public utility class:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_card_detector.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">payment_gateway</span><span class="w"> </span><span class="kn">import</span> <span class="n">CardTypeDetector</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_detect_visa</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">CardTypeDetector</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;visa&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_detect_mastercard_51</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">CardTypeDetector</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="s2">&quot;5425233430109903&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;mastercard&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_detect_mastercard_2221</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">CardTypeDetector</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="s2">&quot;2221000000000009&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;mastercard&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_detect_amex</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">CardTypeDetector</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="s2">&quot;378282246310005&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;amex&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_detect_discover</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">CardTypeDetector</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="s2">&quot;6011111111111117&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;discover&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_detect_unknown</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">CardTypeDetector</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="s2">&quot;9999999999999999&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;unknown&quot;</span>
</code></pre></div>

<p>This approach:
- Makes the complex logic testable without breaking encapsulation
- Allows the logic to be reused elsewhere
- Makes the code more modular and maintainable</p>
<h3 id="lessons-learned_2">Lessons Learned</h3>
<ol>
<li><strong>Prefer testing public API</strong>: Test behavior, not implementation</li>
<li><strong>Private methods are tested indirectly</strong>: If public tests pass, private methods work</li>
<li><strong>Test complex private methods sparingly</strong>: Only when necessary for edge case coverage</li>
<li><strong>Consider making it public</strong>: If you need extensive testing, maybe it should be public</li>
<li><strong>Use hybrid approach</strong>: Primary coverage through public API, supplementary for edge cases</li>
<li><strong>Extract to utility classes</strong>: Complex logic often deserves its own testable class</li>
<li><strong>Balance pragmatism and purity</strong>: Sometimes testing private methods is the practical choice</li>
</ol>
<h2 id="testing-code-with-side-effects">Testing Code with Side Effects</h2>
<h2 id="testing-code-with-side-effects_1">Testing Code with Side Effects</h2>
<p>So far, we've tested pure functions and methods that return values. But real-world code has side effects: it writes to databases, sends emails, logs messages, modifies files, and makes network requests. How do we test code that changes the world outside our program?</p>
<h3 id="the-reference-implementation-a-payment-gateway-with-side-effects">The Reference Implementation: A Payment Gateway with Side Effects</h3>
<p>Let's extend our payment gateway to include realistic side effects:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_gateway.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentGateway</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A payment gateway that processes credit card transactions.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">merchant_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merchant_id</span> <span class="o">=</span> <span class="n">merchant_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transaction_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_processed</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_credit_card</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate credit card number using Luhn algorithm.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">card_number</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid card format: non-numeric characters&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">card_number</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">13</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">card_number</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">19</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid card format: length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">card_number</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Luhn algorithm</span>
        <span class="n">digits</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">card_number</span><span class="p">]</span>
        <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">doubled</span> <span class="o">=</span> <span class="n">digits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">checksum</span> <span class="o">+=</span> <span class="n">doubled</span> <span class="k">if</span> <span class="n">doubled</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="n">doubled</span> <span class="o">-</span> <span class="mi">9</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">checksum</span> <span class="o">+=</span> <span class="n">digits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">is_valid</span> <span class="o">=</span> <span class="n">checksum</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid card: failed Luhn check&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">is_valid</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_fee</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">card_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate processing fee based on amount and card type.&quot;&quot;&quot;</span>
        <span class="n">base_fee</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="mf">0.029</span>

        <span class="k">if</span> <span class="n">card_type</span> <span class="o">==</span> <span class="s2">&quot;amex&quot;</span><span class="p">:</span>
            <span class="n">base_fee</span> <span class="o">+=</span> <span class="n">amount</span> <span class="o">*</span> <span class="mf">0.005</span>

        <span class="k">return</span> <span class="n">base_fee</span> <span class="o">+</span> <span class="mf">0.30</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_send_receipt_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send receipt email to customer.&quot;&quot;&quot;</span>
        <span class="c1"># In real code, this would send an actual email</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending receipt to </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2"> for transaction </span><span class="si">{</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;card_last_four&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_notify_fraud_team</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Notify fraud team of suspicious transaction.&quot;&quot;&quot;</span>
        <span class="c1"># In real code, this would send a notification</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FRAUD ALERT: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2"> - Card </span><span class="si">{</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;card_last_four&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">card_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                       <span class="n">customer_email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a payment transaction.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing payment: $</span><span class="si">{</span><span class="n">amount</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">card_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_credit_card</span><span class="p">(</span><span class="n">card_number</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Payment failed: invalid card&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid credit card number&quot;</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Payment failed: invalid amount $</span><span class="si">{</span><span class="n">amount</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Amount must be positive&quot;</span>
            <span class="p">}</span>

        <span class="c1"># Check for suspicious activity</span>
        <span class="k">if</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>
            <span class="n">transaction</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;card_last_four&quot;</span><span class="p">:</span> <span class="n">card_number</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:],</span>
                <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_notify_fraud_team</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="s2">&quot;High-value transaction&quot;</span><span class="p">)</span>

        <span class="n">fee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fee</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">card_type</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">+</span> <span class="n">fee</span>

        <span class="c1"># Record transaction</span>
        <span class="n">transaction</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;card_last_four&quot;</span><span class="p">:</span> <span class="n">card_number</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:],</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s2">&quot;fee&quot;</span><span class="p">:</span> <span class="n">fee</span><span class="p">,</span>
            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transaction_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_processed</span> <span class="o">+=</span> <span class="n">total</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Payment successful: $</span><span class="si">{</span><span class="n">total</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> total&quot;</span><span class="p">)</span>

        <span class="c1"># Send receipt if email provided</span>
        <span class="k">if</span> <span class="n">customer_email</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send_receipt_email</span><span class="p">(</span><span class="n">customer_email</span><span class="p">,</span> <span class="n">transaction</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s2">&quot;fee&quot;</span><span class="p">:</span> <span class="n">fee</span><span class="p">,</span>
            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span>
            <span class="s2">&quot;card_last_four&quot;</span><span class="p">:</span> <span class="n">card_number</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_transaction_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the number of processed transactions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction_history</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_total_processed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the total amount processed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_processed</span>
</code></pre></div>

<p>Now our gateway has several side effects:
- <strong>Logging</strong>: Records events at various log levels
- <strong>Email sending</strong>: Sends receipts to customers
- <strong>Fraud notifications</strong>: Alerts the fraud team
- <strong>Timestamps</strong>: Records when transactions occur</p>
<h3 id="iteration-0-testing-without-considering-side-effects">Iteration 0: Testing Without Considering Side Effects</h3>
<p>Let's write a basic test:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_gateway.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_gateway</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentGateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a PaymentGateway instance for testing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentGateway</span><span class="p">(</span><span class="s2">&quot;MERCHANT123&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_key&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_success</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
</code></pre></div>

<p>Running this test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_gateway.py::test_process_payment_success<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_gateway.py::test_process_payment_success INFO:payment_gateway:Processing payment: $100.00 on visa
INFO:payment_gateway:Payment successful: $103.20 total
PASSED

========================== 1 passed in 0.01s ===========================
</code></pre></div>

<p>The test passes, but notice the log messages appearing in the output. This is a side effect we're not controlling or verifying.</p>
<p><strong>Current limitation</strong>: We're not testing that logging happens correctly, and log messages clutter our test output.</p>
<h3 id="iteration-1-capturing-and-verifying-log-messages">Iteration 1: Capturing and Verifying Log Messages</h3>
<p>Let's use pytest's <code>caplog</code> fixture to capture and verify log messages:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_gateway.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_gateway</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentGateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a PaymentGateway instance for testing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentGateway</span><span class="p">(</span><span class="s2">&quot;MERCHANT123&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_key&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_logs_success</span><span class="p">(</span><span class="n">gateway</span><span class="p">,</span> <span class="n">caplog</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that successful payment is logged.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">caplog</span><span class="o">.</span><span class="n">at_level</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>

    <span class="c1"># Verify log messages</span>
    <span class="k">assert</span> <span class="s2">&quot;Processing payment: $100.00 on visa&quot;</span> <span class="ow">in</span> <span class="n">caplog</span><span class="o">.</span><span class="n">text</span>
    <span class="k">assert</span> <span class="s2">&quot;Payment successful: $103.20 total&quot;</span> <span class="ow">in</span> <span class="n">caplog</span><span class="o">.</span><span class="n">text</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_logs_invalid_card</span><span class="p">(</span><span class="n">gateway</span><span class="p">,</span> <span class="n">caplog</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that invalid card is logged.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">caplog</span><span class="o">.</span><span class="n">at_level</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;1234567890123456&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>

    <span class="c1"># Verify warning was logged</span>
    <span class="k">assert</span> <span class="s2">&quot;Invalid card: failed Luhn check&quot;</span> <span class="ow">in</span> <span class="n">caplog</span><span class="o">.</span><span class="n">text</span>
    <span class="k">assert</span> <span class="s2">&quot;Payment failed: invalid card&quot;</span> <span class="ow">in</span> <span class="n">caplog</span><span class="o">.</span><span class="n">text</span>
</code></pre></div>

<p>Running these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_gateway.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_gateway.py::test_process_payment_logs_success PASSED        [ 50%]
test_payment_gateway.py::test_process_payment_logs_invalid_card PASSED   [100%]

========================== 2 passed in 0.02s ==========================
</code></pre></div>

<p>Excellent! We're now verifying that logging happens correctly. The <code>caplog</code> fixture captures all log messages, and we can assert on their content.</p>
<p><strong>Current state</strong>: We can test logging side effects. But what about other side effects like email sending?</p>
<h3 id="iteration-2-testing-email-side-effects-with-mocking">Iteration 2: Testing Email Side Effects with Mocking</h3>
<p>We can't send real emails in tests, so we need to mock the email sending:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_gateway.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_gateway</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentGateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a PaymentGateway instance for testing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentGateway</span><span class="p">(</span><span class="s2">&quot;MERCHANT123&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_key&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_sends_receipt</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that receipt email is sent when email provided.&quot;&quot;&quot;</span>
    <span class="c1"># Mock the email sending method</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">_send_receipt_email</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> 
        <span class="mf">100.00</span><span class="p">,</span> 
        <span class="s2">&quot;visa&quot;</span><span class="p">,</span>
        <span class="n">customer_email</span><span class="o">=</span><span class="s2">&quot;customer@example.com&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>

    <span class="c1"># Verify email was sent</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">_send_receipt_email</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="c1"># Verify email was sent with correct arguments</span>
    <span class="n">call_args</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">_send_receipt_email</span><span class="o">.</span><span class="n">call_args</span>
    <span class="k">assert</span> <span class="n">call_args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;customer@example.com&quot;</span>  <span class="c1"># First positional arg</span>
    <span class="k">assert</span> <span class="n">call_args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;card_last_four&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0366&quot;</span>  <span class="c1"># Second positional arg</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_no_receipt_without_email</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that no receipt is sent when email not provided.&quot;&quot;&quot;</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">_send_receipt_email</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>

    <span class="c1"># Verify email was NOT sent</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">_send_receipt_email</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</code></pre></div>

<p>Running these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_gateway.py<span class="w"> </span>-k<span class="w"> </span>receipt<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_gateway.py::test_process_payment_sends_receipt PASSED       [ 50%]
test_payment_gateway.py::test_process_payment_no_receipt_without_email PASSED [100%]

========================== 2 passed in 0.02s ==========================
</code></pre></div>

<p>Perfect! We're now testing that email sending happens (or doesn't happen) correctly without actually sending emails.</p>
<p><strong>Current state</strong>: We can test both logging and email side effects. But what about fraud notifications?</p>
<h3 id="iteration-3-testing-conditional-side-effects">Iteration 3: Testing Conditional Side Effects</h3>
<p>Let's test that fraud notifications are sent for high-value transactions:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_gateway.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_gateway</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentGateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a PaymentGateway instance for testing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentGateway</span><span class="p">(</span><span class="s2">&quot;MERCHANT123&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_key&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_high_value_transaction_triggers_fraud_alert</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that high-value transactions trigger fraud alerts.&quot;&quot;&quot;</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">_notify_fraud_team</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">15000.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>

    <span class="c1"># Verify fraud team was notified</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">_notify_fraud_team</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="c1"># Verify notification details</span>
    <span class="n">call_args</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">_notify_fraud_team</span><span class="o">.</span><span class="n">call_args</span>
    <span class="n">transaction</span> <span class="o">=</span> <span class="n">call_args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">reason</span> <span class="o">=</span> <span class="n">call_args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">assert</span> <span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;card_last_four&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0366&quot;</span>
    <span class="k">assert</span> <span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">15000.00</span>
    <span class="k">assert</span> <span class="n">reason</span> <span class="o">==</span> <span class="s2">&quot;High-value transaction&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_normal_transaction_no_fraud_alert</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that normal transactions don&#39;t trigger fraud alerts.&quot;&quot;&quot;</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">_notify_fraud_team</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>

    <span class="c1"># Verify fraud team was NOT notified</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">_notify_fraud_team</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</code></pre></div>

<p>Running these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_gateway.py<span class="w"> </span>-k<span class="w"> </span>fraud<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_gateway.py::test_high_value_transaction_triggers_fraud_alert PASSED [ 50%]
test_payment_gateway.py::test_normal_transaction_no_fraud_alert PASSED   [100%]

========================== 2 passed in 0.02s ==========================
</code></pre></div>

<p>Excellent! We're now testing conditional side effects‚Äîside effects that only happen under certain conditions.</p>
<h3 id="iteration-4-testing-time-dependent-side-effects">Iteration 4: Testing Time-Dependent Side Effects</h3>
<p>Our gateway records timestamps for transactions. How do we test this without making our tests dependent on the current time?</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_gateway.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_gateway</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentGateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a PaymentGateway instance for testing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentGateway</span><span class="p">(</span><span class="s2">&quot;MERCHANT123&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_key&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_transaction_includes_timestamp</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that transactions include timestamps.&quot;&quot;&quot;</span>
    <span class="c1"># Mock datetime to return a fixed time</span>
    <span class="n">fixed_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;payment_gateway.datetime&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_datetime</span><span class="p">:</span>
        <span class="n">mock_datetime</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fixed_time</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>

    <span class="c1"># Verify transaction has timestamp</span>
    <span class="n">transaction</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">transaction_history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2024-01-15T10:30:00&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_multiple_transactions_have_different_timestamps</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that multiple transactions have different timestamps.&quot;&quot;&quot;</span>
    <span class="c1"># Mock datetime to return incrementing times</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;payment_gateway.datetime&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_datetime</span><span class="p">:</span>
        <span class="n">mock_datetime</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">times</span>

        <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
        <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">50.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
        <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">25.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="c1"># Verify each transaction has correct timestamp</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">transaction_history</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2024-01-15T10:30:00&quot;</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">transaction_history</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2024-01-15T10:31:00&quot;</span>
    <span class="k">assert</span> <span class="n">gateway</span><span class="o">.</span><span class="n">transaction_history</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2024-01-15T10:32:00&quot;</span>
</code></pre></div>

<p>Running these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_gateway.py<span class="w"> </span>-k<span class="w"> </span>timestamp<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_gateway.py::test_transaction_includes_timestamp PASSED      [ 50%]
test_payment_gateway.py::test_multiple_transactions_have_different_timestamps PASSED [100%]

========================== 2 passed in 0.02s ==========================
</code></pre></div>

<p>Perfect! We're now testing time-dependent side effects by mocking the datetime module.</p>
<h3 id="common-failure-modes-and-their-signatures">Common Failure Modes and Their Signatures</h3>
<h4 id="symptom-test-passes-but-side-effect-doesnt-happen-in-production">Symptom: Test passes but side effect doesn't happen in production</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_gateway.py::test_email_sent PASSED
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Test passes but users report not receiving emails
- Mock was called but real implementation wasn't tested</p>
<p><strong>Root cause</strong>: Over-mocking‚Äîwe mocked the side effect but never verified the real implementation works</p>
<p><strong>Solution</strong>: Add integration tests that verify real side effects in a test environment</p>
<h4 id="symptom-tests-fail-intermittently-due-to-timing">Symptom: Tests fail intermittently due to timing</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_gateway.py::test_timestamp FAILED
AssertionError: assert &#39;2024-01-15T10:30:00.123456&#39; == &#39;2024-01-15T10:30:00.123457&#39;
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Timestamp assertions fail randomly
- Tests pass when run individually but fail in suite</p>
<p><strong>Root cause</strong>: Time-dependent code without mocking</p>
<p><strong>Solution</strong>: Mock datetime or use approximate assertions for timestamps</p>
<h4 id="symptom-log-messages-not-captured">Symptom: Log messages not captured</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_gateway.py::test_logging FAILED
AssertionError: assert &#39;Payment successful&#39; in &#39;&#39;
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- <code>caplog.text</code> is empty
- Log messages appear in console but not in caplog</p>
<p><strong>Root cause</strong>: Logger not configured correctly or wrong log level</p>
<p><strong>Solution</strong>: Use <code>caplog.at_level()</code> with correct log level</p>
<h3 id="the-journey-from-problem-to-solution_2">The Journey: From Problem to Solution</h3>
<table>
<thead>
<tr>
<th>Iteration</th>
<th>Problem</th>
<th>Solution Applied</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Side effects not tested</td>
<td>Basic test</td>
<td>Test passes but incomplete</td>
</tr>
<tr>
<td>1</td>
<td>Logging not verified</td>
<td>Use caplog fixture</td>
<td>Logging verified</td>
</tr>
<tr>
<td>2</td>
<td>Email sending not tested</td>
<td>Mock email method</td>
<td>Email behavior verified</td>
</tr>
<tr>
<td>3</td>
<td>Conditional side effects</td>
<td>Mock and verify conditions</td>
<td>Conditional logic tested</td>
</tr>
<tr>
<td>4</td>
<td>Time-dependent side effects</td>
<td>Mock datetime</td>
<td>Timestamps testable</td>
</tr>
</tbody>
</table>
<h3 id="final-implementation_1">Final Implementation</h3>
<p>Here's our complete test suite for side effects:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_gateway.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_gateway</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentGateway</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">gateway</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a PaymentGateway instance for testing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PaymentGateway</span><span class="p">(</span><span class="s2">&quot;MERCHANT123&quot;</span><span class="p">,</span> <span class="s2">&quot;secret_key&quot;</span><span class="p">)</span>

<span class="c1"># Logging tests</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_logs_success</span><span class="p">(</span><span class="n">gateway</span><span class="p">,</span> <span class="n">caplog</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that successful payment is logged.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">caplog</span><span class="o">.</span><span class="n">at_level</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="s2">&quot;Processing payment: $100.00 on visa&quot;</span> <span class="ow">in</span> <span class="n">caplog</span><span class="o">.</span><span class="n">text</span>
    <span class="k">assert</span> <span class="s2">&quot;Payment successful: $103.20 total&quot;</span> <span class="ow">in</span> <span class="n">caplog</span><span class="o">.</span><span class="n">text</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_logs_invalid_card</span><span class="p">(</span><span class="n">gateway</span><span class="p">,</span> <span class="n">caplog</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that invalid card is logged.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">caplog</span><span class="o">.</span><span class="n">at_level</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;1234567890123456&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="s2">&quot;Invalid card: failed Luhn check&quot;</span> <span class="ow">in</span> <span class="n">caplog</span><span class="o">.</span><span class="n">text</span>

<span class="c1"># Email tests</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_sends_receipt</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that receipt email is sent when email provided.&quot;&quot;&quot;</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">_send_receipt_email</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> 
        <span class="mf">100.00</span><span class="p">,</span> 
        <span class="s2">&quot;visa&quot;</span><span class="p">,</span>
        <span class="n">customer_email</span><span class="o">=</span><span class="s2">&quot;customer@example.com&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">_send_receipt_email</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_payment_no_receipt_without_email</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that no receipt is sent when email not provided.&quot;&quot;&quot;</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">_send_receipt_email</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">_send_receipt_email</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>

<span class="c1"># Fraud detection tests</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_high_value_transaction_triggers_fraud_alert</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that high-value transactions trigger fraud alerts.&quot;&quot;&quot;</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">_notify_fraud_team</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">15000.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">_notify_fraud_team</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_normal_transaction_no_fraud_alert</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that normal transactions don&#39;t trigger fraud alerts.&quot;&quot;&quot;</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">_notify_fraud_team</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="n">gateway</span><span class="o">.</span><span class="n">_notify_fraud_team</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>

<span class="c1"># Timestamp tests</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_transaction_includes_timestamp</span><span class="p">(</span><span class="n">gateway</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that transactions include timestamps.&quot;&quot;&quot;</span>
    <span class="n">fixed_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;payment_gateway.datetime&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_datetime</span><span class="p">:</span>
        <span class="n">mock_datetime</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fixed_time</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="n">transaction</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">transaction_history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2024-01-15T10:30:00&quot;</span>
</code></pre></div>

<h3 id="decision-framework-testing-side-effects">Decision Framework: Testing Side Effects</h3>
<p><strong>When to use caplog</strong>:
- Testing that logging happens at correct levels
- Verifying log message content
- Testing error logging and warnings</p>
<p><strong>When to use mocks</strong>:
- Testing external service calls (email, SMS, API)
- Testing file system operations
- Testing database writes
- Testing any side effect that shouldn't happen in tests</p>
<p><strong>When to use patches</strong>:
- Testing time-dependent code (datetime, time.sleep)
- Testing random behavior (random.random, uuid.uuid4)
- Testing environment-dependent code (os.environ)</p>
<p><strong>When to use real implementations</strong>:
- Integration tests in test environment
- Testing critical paths end-to-end
- Verifying that mocked behavior matches reality</p>
<h3 id="lessons-learned_3">Lessons Learned</h3>
<ol>
<li><strong>Use caplog for logging</strong>: Pytest's caplog fixture makes testing logs easy</li>
<li><strong>Mock external side effects</strong>: Don't send real emails or make real API calls in tests</li>
<li><strong>Verify mock calls</strong>: Use <code>assert_called_once()</code>, <code>assert_called_with()</code>, etc.</li>
<li><strong>Mock time-dependent code</strong>: Use <code>patch</code> to control datetime and other time sources</li>
<li><strong>Test conditional side effects</strong>: Verify side effects happen (or don't) based on conditions</li>
<li><strong>Balance mocking and integration</strong>: Mock for unit tests, use real implementations for integration tests</li>
<li><strong>Document what you're mocking</strong>: Make it clear why each mock exists</li>
</ol>
<h2 id="integration-testing-within-your-codebase">Integration Testing Within Your Codebase</h2>
<h2 id="integration-testing-within-your-codebase_1">Integration Testing Within Your Codebase</h2>
<p>We've tested individual functions, classes, and side effects. But real applications are systems of components working together. Integration testing verifies that these components interact correctly.</p>
<p>Unlike unit tests that isolate components, integration tests verify the <strong>seams</strong> between components‚Äîthe places where things can go wrong even when individual pieces work correctly.</p>
<h3 id="the-reference-implementation-a-complete-payment-system">The Reference Implementation: A Complete Payment System</h3>
<p>Let's build a complete payment system with multiple components:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_system.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CardValidator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validates credit card numbers.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate card number. Returns (is_valid, error_message).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">card_number</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Card validation failed: non-numeric&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Card number must contain only digits&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">card_number</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">13</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">card_number</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">19</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Card validation failed: invalid length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">card_number</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Card number must be 13-19 digits&quot;</span>

        <span class="c1"># Luhn algorithm</span>
        <span class="n">digits</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">card_number</span><span class="p">]</span>
        <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">doubled</span> <span class="o">=</span> <span class="n">digits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">checksum</span> <span class="o">+=</span> <span class="n">doubled</span> <span class="k">if</span> <span class="n">doubled</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="n">doubled</span> <span class="o">-</span> <span class="mi">9</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">checksum</span> <span class="o">+=</span> <span class="n">digits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">checksum</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Card validation failed: Luhn check&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Invalid card number&quot;</span>

        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FeeCalculator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates processing fees.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.029</span><span class="p">,</span> <span class="n">transaction_fee</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.30</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_rate</span> <span class="o">=</span> <span class="n">base_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transaction_fee</span> <span class="o">=</span> <span class="n">transaction_fee</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">card_type_rates</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;amex&quot;</span><span class="p">:</span> <span class="mf">0.005</span><span class="p">,</span>
            <span class="s2">&quot;visa&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;mastercard&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;discover&quot;</span><span class="p">:</span> <span class="mf">0.0</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">card_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate total fee for transaction.&quot;&quot;&quot;</span>
        <span class="n">base_fee</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_rate</span>
        <span class="n">card_fee</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">card_type_rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">card_type</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">base_fee</span> <span class="o">+</span> <span class="n">card_fee</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_fee</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TransactionRepository</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stores transaction records.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transactions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save transaction and return transaction ID.&quot;&quot;&quot;</span>
        <span class="n">transaction_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;TXN</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transactions</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transaction_id</span>
        <span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">transaction_id</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve transaction by ID.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">txn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transactions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">txn</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">transaction_id</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">txn</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve all transactions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transactions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_total_processed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get total amount processed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">txn</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">txn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transactions</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">NotificationService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sends notifications about transactions.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sent_notifications</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">send_receipt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send receipt email.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending receipt to </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2"> for transaction </span><span class="si">{</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sent_notifications</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;receipt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
            <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">send_fraud_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send fraud alert.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FRAUD ALERT: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2"> - Transaction </span><span class="si">{</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sent_notifications</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;fraud_alert&quot;</span><span class="p">,</span>
            <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
            <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">reason</span>
        <span class="p">})</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Orchestrates payment processing using multiple components.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">validator</span><span class="p">:</span> <span class="n">CardValidator</span><span class="p">,</span>
        <span class="n">fee_calculator</span><span class="p">:</span> <span class="n">FeeCalculator</span><span class="p">,</span>
        <span class="n">repository</span><span class="p">:</span> <span class="n">TransactionRepository</span><span class="p">,</span>
        <span class="n">notification_service</span><span class="p">:</span> <span class="n">NotificationService</span><span class="p">,</span>
        <span class="n">fraud_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10000.0</span><span class="p">,</span>
        <span class="n">logger</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validator</span> <span class="o">=</span> <span class="n">validator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fee_calculator</span> <span class="o">=</span> <span class="n">fee_calculator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repository</span> <span class="o">=</span> <span class="n">repository</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notification_service</span> <span class="o">=</span> <span class="n">notification_service</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fraud_threshold</span> <span class="o">=</span> <span class="n">fraud_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">card_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">card_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">customer_email</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a payment transaction.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing payment: $</span><span class="si">{</span><span class="n">amount</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">card_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Validate card</span>
        <span class="n">is_valid</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">card_number</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Payment failed: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span>
            <span class="p">}</span>

        <span class="c1"># Validate amount</span>
        <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Payment failed: invalid amount $</span><span class="si">{</span><span class="n">amount</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Amount must be positive&quot;</span>
            <span class="p">}</span>

        <span class="c1"># Calculate fee</span>
        <span class="n">fee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fee_calculator</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">card_type</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">+</span> <span class="n">fee</span>

        <span class="c1"># Create transaction record</span>
        <span class="n">transaction</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;card_last_four&quot;</span><span class="p">:</span> <span class="n">card_number</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:],</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s2">&quot;fee&quot;</span><span class="p">:</span> <span class="n">fee</span><span class="p">,</span>
            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span>
            <span class="s2">&quot;card_type&quot;</span><span class="p">:</span> <span class="n">card_type</span>
        <span class="p">}</span>

        <span class="c1"># Save transaction</span>
        <span class="n">transaction_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
        <span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transaction_id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Payment successful: </span><span class="si">{</span><span class="n">transaction_id</span><span class="si">}</span><span class="s2"> - $</span><span class="si">{</span><span class="n">total</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check for fraud</span>
        <span class="k">if</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraud_threshold</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notification_service</span><span class="o">.</span><span class="n">send_fraud_alert</span><span class="p">(</span>
                <span class="n">transaction</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;High-value transaction: $</span><span class="si">{</span><span class="n">amount</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Send receipt</span>
        <span class="k">if</span> <span class="n">customer_email</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notification_service</span><span class="o">.</span><span class="n">send_receipt</span><span class="p">(</span><span class="n">customer_email</span><span class="p">,</span> <span class="n">transaction</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">transaction_id</span><span class="p">,</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s2">&quot;fee&quot;</span><span class="p">:</span> <span class="n">fee</span><span class="p">,</span>
            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span>
            <span class="s2">&quot;card_last_four&quot;</span><span class="p">:</span> <span class="n">card_number</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve a transaction by ID.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">transaction_id</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_total_processed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get total amount processed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">get_total_processed</span><span class="p">()</span>
</code></pre></div>

<p>This is a realistic payment system with five components:
1. <strong>CardValidator</strong>: Validates credit cards
2. <strong>FeeCalculator</strong>: Calculates fees
3. <strong>TransactionRepository</strong>: Stores transactions
4. <strong>NotificationService</strong>: Sends notifications
5. <strong>PaymentProcessor</strong>: Orchestrates everything</p>
<h3 id="iteration-0-testing-components-in-isolation">Iteration 0: Testing Components in Isolation</h3>
<p>First, let's verify each component works independently:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_system.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_system</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CardValidator</span><span class="p">,</span>
    <span class="n">FeeCalculator</span><span class="p">,</span>
    <span class="n">TransactionRepository</span><span class="p">,</span>
    <span class="n">NotificationService</span><span class="p">,</span>
    <span class="n">PaymentProcessor</span>
<span class="p">)</span>

<span class="c1"># Unit tests for CardValidator</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_card_validator_valid_card</span><span class="p">():</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">CardValidator</span><span class="p">()</span>
    <span class="n">is_valid</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">is_valid</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_card_validator_invalid_card</span><span class="p">():</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">CardValidator</span><span class="p">()</span>
    <span class="n">is_valid</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="s2">&quot;1234567890123456&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">is_valid</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">error</span> <span class="o">==</span> <span class="s2">&quot;Invalid card number&quot;</span>

<span class="c1"># Unit tests for FeeCalculator</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_fee_calculator_visa</span><span class="p">():</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">FeeCalculator</span><span class="p">()</span>
    <span class="n">fee</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fee</span> <span class="o">==</span> <span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="mf">3.20</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_fee_calculator_amex</span><span class="p">():</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">FeeCalculator</span><span class="p">()</span>
    <span class="n">fee</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;amex&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fee</span> <span class="o">==</span> <span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="mf">3.70</span><span class="p">)</span>

<span class="c1"># Unit tests for TransactionRepository</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_repository_save_transaction</span><span class="p">():</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">TransactionRepository</span><span class="p">()</span>
    <span class="n">transaction</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;fee&quot;</span><span class="p">:</span> <span class="mf">3.20</span><span class="p">,</span> <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mf">103.20</span><span class="p">}</span>

    <span class="n">transaction_id</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">transaction_id</span> <span class="o">==</span> <span class="s2">&quot;TXN000001&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">get_all</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_repository_get_by_id</span><span class="p">():</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">TransactionRepository</span><span class="p">()</span>
    <span class="n">transaction</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;fee&quot;</span><span class="p">:</span> <span class="mf">3.20</span><span class="p">,</span> <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mf">103.20</span><span class="p">}</span>

    <span class="n">transaction_id</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
    <span class="n">retrieved</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">transaction_id</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">retrieved</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">retrieved</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">100.00</span>

<span class="c1"># Unit tests for NotificationService</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_notification_service_send_receipt</span><span class="p">():</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">NotificationService</span><span class="p">()</span>
    <span class="n">transaction</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;TXN000001&quot;</span><span class="p">,</span> <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">100.00</span><span class="p">}</span>

    <span class="n">service</span><span class="o">.</span><span class="n">send_receipt</span><span class="p">(</span><span class="s2">&quot;customer@example.com&quot;</span><span class="p">,</span> <span class="n">transaction</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">sent_notifications</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">service</span><span class="o">.</span><span class="n">sent_notifications</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;receipt&quot;</span>
</code></pre></div>

<p>Running these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_system.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_system.py::test_card_validator_valid_card PASSED            [ 14%]
test_payment_system.py::test_card_validator_invalid_card PASSED          [ 28%]
test_payment_system.py::test_fee_calculator_visa PASSED                  [ 42%]
test_payment_system.py::test_fee_calculator_amex PASSED                  [ 57%]
test_payment_system.py::test_repository_save_transaction PASSED          [ 71%]
test_payment_system.py::test_repository_get_by_id PASSED                 [ 85%]
test_payment_system.py::test_notification_service_send_receipt PASSED    [100%]

========================== 7 passed in 0.03s ==========================
</code></pre></div>

<p>Good! Each component works in isolation. But do they work together?</p>
<p><strong>Current limitation</strong>: We've only tested components independently. We haven't verified their integration.</p>
<h3 id="iteration-1-testing-component-integration">Iteration 1: Testing Component Integration</h3>
<p>Let's test that the <code>PaymentProcessor</code> correctly integrates all components:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_system.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_system</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CardValidator</span><span class="p">,</span>
    <span class="n">FeeCalculator</span><span class="p">,</span>
    <span class="n">TransactionRepository</span><span class="p">,</span>
    <span class="n">NotificationService</span><span class="p">,</span>
    <span class="n">PaymentProcessor</span>
<span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">payment_system</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a complete payment system for testing.&quot;&quot;&quot;</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">CardValidator</span><span class="p">()</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">FeeCalculator</span><span class="p">()</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">TransactionRepository</span><span class="p">()</span>
    <span class="n">notifications</span> <span class="o">=</span> <span class="n">NotificationService</span><span class="p">()</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">(</span>
        <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">,</span>
        <span class="n">fee_calculator</span><span class="o">=</span><span class="n">calculator</span><span class="p">,</span>
        <span class="n">repository</span><span class="o">=</span><span class="n">repository</span><span class="p">,</span>
        <span class="n">notification_service</span><span class="o">=</span><span class="n">notifications</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;processor&quot;</span><span class="p">:</span> <span class="n">processor</span><span class="p">,</span>
        <span class="s2">&quot;validator&quot;</span><span class="p">:</span> <span class="n">validator</span><span class="p">,</span>
        <span class="s2">&quot;calculator&quot;</span><span class="p">:</span> <span class="n">calculator</span><span class="p">,</span>
        <span class="s2">&quot;repository&quot;</span><span class="p">:</span> <span class="n">repository</span><span class="p">,</span>
        <span class="s2">&quot;notifications&quot;</span><span class="p">:</span> <span class="n">notifications</span>
    <span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_successful_payment_integration</span><span class="p">(</span><span class="n">payment_system</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test complete payment flow with all components.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;processor&quot;</span><span class="p">]</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;repository&quot;</span><span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">card_number</span><span class="o">=</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">100.00</span><span class="p">,</span>
        <span class="n">card_type</span><span class="o">=</span><span class="s2">&quot;visa&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Verify payment succeeded</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;TXN000001&quot;</span>

    <span class="c1"># Verify transaction was saved</span>
    <span class="n">saved_txn</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="s2">&quot;TXN000001&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">saved_txn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">saved_txn</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">100.00</span>
    <span class="k">assert</span> <span class="n">saved_txn</span><span class="p">[</span><span class="s2">&quot;fee&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="mf">3.20</span><span class="p">)</span>

    <span class="c1"># Verify total processed is correct</span>
    <span class="k">assert</span> <span class="n">processor</span><span class="o">.</span><span class="n">get_total_processed</span><span class="p">()</span> <span class="o">==</span> <span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="mf">103.20</span><span class="p">)</span>
</code></pre></div>

<p>Running this test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_system.py::test_successful_payment_integration<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_system.py::test_successful_payment_integration PASSED       [100%]

========================== 1 passed in 0.01s ==========================
</code></pre></div>

<p>Excellent! The components work together correctly. But what happens when validation fails? Does the transaction still get saved?</p>
<p><strong>Current limitation</strong>: We haven't tested error paths in the integration.</p>
<h3 id="iteration-2-testing-error-propagation">Iteration 2: Testing Error Propagation</h3>
<p>Let's test that errors in one component are handled correctly by the system:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_system.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_system</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CardValidator</span><span class="p">,</span>
    <span class="n">FeeCalculator</span><span class="p">,</span>
    <span class="n">TransactionRepository</span><span class="p">,</span>
    <span class="n">NotificationService</span><span class="p">,</span>
    <span class="n">PaymentProcessor</span>
<span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">payment_system</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a complete payment system for testing.&quot;&quot;&quot;</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">CardValidator</span><span class="p">()</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">FeeCalculator</span><span class="p">()</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">TransactionRepository</span><span class="p">()</span>
    <span class="n">notifications</span> <span class="o">=</span> <span class="n">NotificationService</span><span class="p">()</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">(</span>
        <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">,</span>
        <span class="n">fee_calculator</span><span class="o">=</span><span class="n">calculator</span><span class="p">,</span>
        <span class="n">repository</span><span class="o">=</span><span class="n">repository</span><span class="p">,</span>
        <span class="n">notification_service</span><span class="o">=</span><span class="n">notifications</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;processor&quot;</span><span class="p">:</span> <span class="n">processor</span><span class="p">,</span>
        <span class="s2">&quot;validator&quot;</span><span class="p">:</span> <span class="n">validator</span><span class="p">,</span>
        <span class="s2">&quot;calculator&quot;</span><span class="p">:</span> <span class="n">calculator</span><span class="p">,</span>
        <span class="s2">&quot;repository&quot;</span><span class="p">:</span> <span class="n">repository</span><span class="p">,</span>
        <span class="s2">&quot;notifications&quot;</span><span class="p">:</span> <span class="n">notifications</span>
    <span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_failed_validation_no_transaction_saved</span><span class="p">(</span><span class="n">payment_system</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that failed validation doesn&#39;t save transaction.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;processor&quot;</span><span class="p">]</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;repository&quot;</span><span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">card_number</span><span class="o">=</span><span class="s2">&quot;1234567890123456&quot;</span><span class="p">,</span>  <span class="c1"># Invalid card</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">100.00</span><span class="p">,</span>
        <span class="n">card_type</span><span class="o">=</span><span class="s2">&quot;visa&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Verify payment failed</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Invalid card number&quot;</span>

    <span class="c1"># Verify no transaction was saved</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">repository</span><span class="o">.</span><span class="n">get_all</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">processor</span><span class="o">.</span><span class="n">get_total_processed</span><span class="p">()</span> <span class="o">==</span> <span class="mf">0.0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_amount_no_transaction_saved</span><span class="p">(</span><span class="n">payment_system</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that invalid amount doesn&#39;t save transaction.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;processor&quot;</span><span class="p">]</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;repository&quot;</span><span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">card_number</span><span class="o">=</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=-</span><span class="mf">50.00</span><span class="p">,</span>  <span class="c1"># Invalid amount</span>
        <span class="n">card_type</span><span class="o">=</span><span class="s2">&quot;visa&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Verify payment failed</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Amount must be positive&quot;</span>

    <span class="c1"># Verify no transaction was saved</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">repository</span><span class="o">.</span><span class="n">get_all</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span>
</code></pre></div>

<p>Running these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_system.py<span class="w"> </span>-k<span class="w"> </span><span class="s2">&quot;failed_validation or invalid_amount&quot;</span><span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_system.py::test_failed_validation_no_transaction_saved PASSED [ 50%]
test_payment_system.py::test_invalid_amount_no_transaction_saved PASSED  [100%]

========================== 2 passed in 0.02s ==========================
</code></pre></div>

<p>Perfect! Errors are handled correctly‚Äîfailed payments don't create transactions.</p>
<p><strong>Current state</strong>: We've verified that components integrate correctly and errors propagate properly.</p>
<h3 id="iteration-3-testing-notification-integration">Iteration 3: Testing Notification Integration</h3>
<p>Let's test that notifications are sent correctly:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_system.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_system</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CardValidator</span><span class="p">,</span>
    <span class="n">FeeCalculator</span><span class="p">,</span>
    <span class="n">TransactionRepository</span><span class="p">,</span>
    <span class="n">NotificationService</span><span class="p">,</span>
    <span class="n">PaymentProcessor</span>
<span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">payment_system</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a complete payment system for testing.&quot;&quot;&quot;</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">CardValidator</span><span class="p">()</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">FeeCalculator</span><span class="p">()</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">TransactionRepository</span><span class="p">()</span>
    <span class="n">notifications</span> <span class="o">=</span> <span class="n">NotificationService</span><span class="p">()</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">(</span>
        <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">,</span>
        <span class="n">fee_calculator</span><span class="o">=</span><span class="n">calculator</span><span class="p">,</span>
        <span class="n">repository</span><span class="o">=</span><span class="n">repository</span><span class="p">,</span>
        <span class="n">notification_service</span><span class="o">=</span><span class="n">notifications</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;processor&quot;</span><span class="p">:</span> <span class="n">processor</span><span class="p">,</span>
        <span class="s2">&quot;validator&quot;</span><span class="p">:</span> <span class="n">validator</span><span class="p">,</span>
        <span class="s2">&quot;calculator&quot;</span><span class="p">:</span> <span class="n">calculator</span><span class="p">,</span>
        <span class="s2">&quot;repository&quot;</span><span class="p">:</span> <span class="n">repository</span><span class="p">,</span>
        <span class="s2">&quot;notifications&quot;</span><span class="p">:</span> <span class="n">notifications</span>
    <span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_receipt_sent_with_email</span><span class="p">(</span><span class="n">payment_system</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that receipt is sent when email provided.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;processor&quot;</span><span class="p">]</span>
    <span class="n">notifications</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;notifications&quot;</span><span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">card_number</span><span class="o">=</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">100.00</span><span class="p">,</span>
        <span class="n">card_type</span><span class="o">=</span><span class="s2">&quot;visa&quot;</span><span class="p">,</span>
        <span class="n">customer_email</span><span class="o">=</span><span class="s2">&quot;customer@example.com&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>

    <span class="c1"># Verify receipt was sent</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">notifications</span><span class="o">.</span><span class="n">sent_notifications</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">notification</span> <span class="o">=</span> <span class="n">notifications</span><span class="o">.</span><span class="n">sent_notifications</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">notification</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;receipt&quot;</span>
    <span class="k">assert</span> <span class="n">notification</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;customer@example.com&quot;</span>
    <span class="k">assert</span> <span class="n">notification</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_no_receipt_without_email</span><span class="p">(</span><span class="n">payment_system</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that no receipt is sent without email.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;processor&quot;</span><span class="p">]</span>
    <span class="n">notifications</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;notifications&quot;</span><span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">card_number</span><span class="o">=</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">100.00</span><span class="p">,</span>
        <span class="n">card_type</span><span class="o">=</span><span class="s2">&quot;visa&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>

    <span class="c1"># Verify no receipt was sent</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">notifications</span><span class="o">.</span><span class="n">sent_notifications</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_fraud_alert_for_high_value</span><span class="p">(</span><span class="n">payment_system</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that fraud alert is sent for high-value transactions.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;processor&quot;</span><span class="p">]</span>
    <span class="n">notifications</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;notifications&quot;</span><span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">card_number</span><span class="o">=</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">15000.00</span><span class="p">,</span>
        <span class="n">card_type</span><span class="o">=</span><span class="s2">&quot;visa&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>

    <span class="c1"># Verify fraud alert was sent</span>
    <span class="n">fraud_alerts</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">notifications</span><span class="o">.</span><span class="n">sent_notifications</span> <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;fraud_alert&quot;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fraud_alerts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">fraud_alerts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span>
</code></pre></div>

<p>Running these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_system.py<span class="w"> </span>-k<span class="w"> </span><span class="s2">&quot;receipt or fraud&quot;</span><span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_system.py::test_receipt_sent_with_email PASSED              [ 33%]
test_payment_system.py::test_no_receipt_without_email PASSED             [ 66%]
test_payment_system.py::test_fraud_alert_for_high_value PASSED           [100%]

========================== 3 passed in 0.02s ==========================
</code></pre></div>

<p>Excellent! Notifications are integrated correctly.</p>
<h3 id="iteration-4-testing-multiple-transactions">Iteration 4: Testing Multiple Transactions</h3>
<p>Let's test that the system handles multiple transactions correctly:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_system.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_system</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CardValidator</span><span class="p">,</span>
    <span class="n">FeeCalculator</span><span class="p">,</span>
    <span class="n">TransactionRepository</span><span class="p">,</span>
    <span class="n">NotificationService</span><span class="p">,</span>
    <span class="n">PaymentProcessor</span>
<span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">payment_system</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a complete payment system for testing.&quot;&quot;&quot;</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">CardValidator</span><span class="p">()</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">FeeCalculator</span><span class="p">()</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">TransactionRepository</span><span class="p">()</span>
    <span class="n">notifications</span> <span class="o">=</span> <span class="n">NotificationService</span><span class="p">()</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">(</span>
        <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">,</span>
        <span class="n">fee_calculator</span><span class="o">=</span><span class="n">calculator</span><span class="p">,</span>
        <span class="n">repository</span><span class="o">=</span><span class="n">repository</span><span class="p">,</span>
        <span class="n">notification_service</span><span class="o">=</span><span class="n">notifications</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;processor&quot;</span><span class="p">:</span> <span class="n">processor</span><span class="p">,</span>
        <span class="s2">&quot;validator&quot;</span><span class="p">:</span> <span class="n">validator</span><span class="p">,</span>
        <span class="s2">&quot;calculator&quot;</span><span class="p">:</span> <span class="n">calculator</span><span class="p">,</span>
        <span class="s2">&quot;repository&quot;</span><span class="p">:</span> <span class="n">repository</span><span class="p">,</span>
        <span class="s2">&quot;notifications&quot;</span><span class="p">:</span> <span class="n">notifications</span>
    <span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_multiple_transactions_accumulate</span><span class="p">(</span><span class="n">payment_system</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that multiple transactions are tracked correctly.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;processor&quot;</span><span class="p">]</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;repository&quot;</span><span class="p">]</span>

    <span class="c1"># Process three transactions</span>
    <span class="n">result1</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="n">result2</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">50.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="n">result3</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;378282246310005&quot;</span><span class="p">,</span> <span class="mf">200.00</span><span class="p">,</span> <span class="s2">&quot;amex&quot;</span><span class="p">)</span>

    <span class="c1"># Verify all succeeded</span>
    <span class="k">assert</span> <span class="n">result1</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result2</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result3</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>

    <span class="c1"># Verify transaction IDs are sequential</span>
    <span class="k">assert</span> <span class="n">result1</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;TXN000001&quot;</span>
    <span class="k">assert</span> <span class="n">result2</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;TXN000002&quot;</span>
    <span class="k">assert</span> <span class="n">result3</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;TXN000003&quot;</span>

    <span class="c1"># Verify all transactions are saved</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">repository</span><span class="o">.</span><span class="n">get_all</span><span class="p">())</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="c1"># Verify total processed is correct</span>
    <span class="c1"># $103.20 + $51.75 + $207.40 = $362.35</span>
    <span class="n">expected_total</span> <span class="o">=</span> <span class="mf">103.20</span> <span class="o">+</span> <span class="mf">51.75</span> <span class="o">+</span> <span class="mf">207.40</span>
    <span class="k">assert</span> <span class="n">processor</span><span class="o">.</span><span class="n">get_total_processed</span><span class="p">()</span> <span class="o">==</span> <span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="n">expected_total</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_mixed_success_and_failure</span><span class="p">(</span><span class="n">payment_system</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that failed transactions don&#39;t affect successful ones.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;processor&quot;</span><span class="p">]</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;repository&quot;</span><span class="p">]</span>

    <span class="c1"># Process mix of valid and invalid transactions</span>
    <span class="n">result1</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="n">result2</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;1234567890123456&quot;</span><span class="p">,</span> <span class="mf">50.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>  <span class="c1"># Invalid</span>
    <span class="n">result3</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">75.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="c1"># Verify results</span>
    <span class="k">assert</span> <span class="n">result1</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result2</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result3</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>

    <span class="c1"># Verify only successful transactions are saved</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">repository</span><span class="o">.</span><span class="n">get_all</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="c1"># Verify transaction IDs skip failed transaction</span>
    <span class="k">assert</span> <span class="n">result1</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;TXN000001&quot;</span>
    <span class="k">assert</span> <span class="n">result3</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;TXN000002&quot;</span>

    <span class="c1"># Verify total only includes successful transactions</span>
    <span class="n">expected_total</span> <span class="o">=</span> <span class="mf">103.20</span> <span class="o">+</span> <span class="mf">77.45</span>  <span class="c1"># $100 + $3.20 + $75 + $2.45</span>
    <span class="k">assert</span> <span class="n">processor</span><span class="o">.</span><span class="n">get_total_processed</span><span class="p">()</span> <span class="o">==</span> <span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="n">expected_total</span><span class="p">)</span>
</code></pre></div>

<p>Running these tests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_payment_system.py<span class="w"> </span>-k<span class="w"> </span><span class="s2">&quot;multiple or mixed&quot;</span><span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_system.py::test_multiple_transactions_accumulate PASSED     [ 50%]
test_payment_system.py::test_mixed_success_and_failure PASSED            [100%]

========================== 2 passed in 0.02s ==========================
</code></pre></div>

<p>Perfect! The system handles multiple transactions correctly, including mixed success and failure scenarios.</p>
<h3 id="the-journey-from-problem-to-solution_3">The Journey: From Problem to Solution</h3>
<table>
<thead>
<tr>
<th>Iteration</th>
<th>Problem</th>
<th>Solution Applied</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Components not tested together</td>
<td>Test components in isolation</td>
<td>Unit tests pass</td>
</tr>
<tr>
<td>1</td>
<td>Integration not verified</td>
<td>Test complete payment flow</td>
<td>Integration verified</td>
</tr>
<tr>
<td>2</td>
<td>Error handling not tested</td>
<td>Test error propagation</td>
<td>Errors handled correctly</td>
</tr>
<tr>
<td>3</td>
<td>Notifications not verified</td>
<td>Test notification integration</td>
<td>Notifications work</td>
</tr>
<tr>
<td>4</td>
<td>Multiple transactions not tested</td>
<td>Test transaction accumulation</td>
<td>System scales correctly</td>
</tr>
</tbody>
</table>
<h3 id="final-implementation_2">Final Implementation</h3>
<p>Here's our complete integration test suite:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_system.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_system</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CardValidator</span><span class="p">,</span>
    <span class="n">FeeCalculator</span><span class="p">,</span>
    <span class="n">TransactionRepository</span><span class="p">,</span>
    <span class="n">NotificationService</span><span class="p">,</span>
    <span class="n">PaymentProcessor</span>
<span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">payment_system</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a complete payment system for testing.&quot;&quot;&quot;</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">CardValidator</span><span class="p">()</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">FeeCalculator</span><span class="p">()</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">TransactionRepository</span><span class="p">()</span>
    <span class="n">notifications</span> <span class="o">=</span> <span class="n">NotificationService</span><span class="p">()</span>

    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">(</span>
        <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">,</span>
        <span class="n">fee_calculator</span><span class="o">=</span><span class="n">calculator</span><span class="p">,</span>
        <span class="n">repository</span><span class="o">=</span><span class="n">repository</span><span class="p">,</span>
        <span class="n">notification_service</span><span class="o">=</span><span class="n">notifications</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;processor&quot;</span><span class="p">:</span> <span class="n">processor</span><span class="p">,</span>
        <span class="s2">&quot;validator&quot;</span><span class="p">:</span> <span class="n">validator</span><span class="p">,</span>
        <span class="s2">&quot;calculator&quot;</span><span class="p">:</span> <span class="n">calculator</span><span class="p">,</span>
        <span class="s2">&quot;repository&quot;</span><span class="p">:</span> <span class="n">repository</span><span class="p">,</span>
        <span class="s2">&quot;notifications&quot;</span><span class="p">:</span> <span class="n">notifications</span>
    <span class="p">}</span>

<span class="c1"># Integration tests</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_successful_payment_integration</span><span class="p">(</span><span class="n">payment_system</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test complete payment flow with all components.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;processor&quot;</span><span class="p">]</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;repository&quot;</span><span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">card_number</span><span class="o">=</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">100.00</span><span class="p">,</span>
        <span class="n">card_type</span><span class="o">=</span><span class="s2">&quot;visa&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;TXN000001&quot;</span>

    <span class="n">saved_txn</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="s2">&quot;TXN000001&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">saved_txn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">saved_txn</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">100.00</span>
    <span class="k">assert</span> <span class="n">processor</span><span class="o">.</span><span class="n">get_total_processed</span><span class="p">()</span> <span class="o">==</span> <span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="mf">103.20</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_failed_validation_no_transaction_saved</span><span class="p">(</span><span class="n">payment_system</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that failed validation doesn&#39;t save transaction.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;processor&quot;</span><span class="p">]</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;repository&quot;</span><span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">card_number</span><span class="o">=</span><span class="s2">&quot;1234567890123456&quot;</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">100.00</span><span class="p">,</span>
        <span class="n">card_type</span><span class="o">=</span><span class="s2">&quot;visa&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">repository</span><span class="o">.</span><span class="n">get_all</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_receipt_sent_with_email</span><span class="p">(</span><span class="n">payment_system</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that receipt is sent when email provided.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;processor&quot;</span><span class="p">]</span>
    <span class="n">notifications</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;notifications&quot;</span><span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">card_number</span><span class="o">=</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">100.00</span><span class="p">,</span>
        <span class="n">card_type</span><span class="o">=</span><span class="s2">&quot;visa&quot;</span><span class="p">,</span>
        <span class="n">customer_email</span><span class="o">=</span><span class="s2">&quot;customer@example.com&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">notifications</span><span class="o">.</span><span class="n">sent_notifications</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">notifications</span><span class="o">.</span><span class="n">sent_notifications</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;receipt&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_fraud_alert_for_high_value</span><span class="p">(</span><span class="n">payment_system</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that fraud alert is sent for high-value transactions.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;processor&quot;</span><span class="p">]</span>
    <span class="n">notifications</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;notifications&quot;</span><span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">card_number</span><span class="o">=</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span>
        <span class="n">amount</span><span class="o">=</span><span class="mf">15000.00</span><span class="p">,</span>
        <span class="n">card_type</span><span class="o">=</span><span class="s2">&quot;visa&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="n">fraud_alerts</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">notifications</span><span class="o">.</span><span class="n">sent_notifications</span> <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;fraud_alert&quot;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fraud_alerts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_multiple_transactions_accumulate</span><span class="p">(</span><span class="n">payment_system</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that multiple transactions are tracked correctly.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;processor&quot;</span><span class="p">]</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;repository&quot;</span><span class="p">]</span>

    <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">50.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;378282246310005&quot;</span><span class="p">,</span> <span class="mf">200.00</span><span class="p">,</span> <span class="s2">&quot;amex&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">repository</span><span class="o">.</span><span class="n">get_all</span><span class="p">())</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="n">expected_total</span> <span class="o">=</span> <span class="mf">103.20</span> <span class="o">+</span> <span class="mf">51.75</span> <span class="o">+</span> <span class="mf">207.40</span>
    <span class="k">assert</span> <span class="n">processor</span><span class="o">.</span><span class="n">get_total_processed</span><span class="p">()</span> <span class="o">==</span> <span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="n">expected_total</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_mixed_success_and_failure</span><span class="p">(</span><span class="n">payment_system</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that failed transactions don&#39;t affect successful ones.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;processor&quot;</span><span class="p">]</span>
    <span class="n">repository</span> <span class="o">=</span> <span class="n">payment_system</span><span class="p">[</span><span class="s2">&quot;repository&quot;</span><span class="p">]</span>

    <span class="n">result1</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="n">result2</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;1234567890123456&quot;</span><span class="p">,</span> <span class="mf">50.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>
    <span class="n">result3</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="s2">&quot;4532015112830366&quot;</span><span class="p">,</span> <span class="mf">75.00</span><span class="p">,</span> <span class="s2">&quot;visa&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result1</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result2</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">result3</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">repository</span><span class="o">.</span><span class="n">get_all</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span>
</code></pre></div>

<h3 id="decision-framework-unit-vs-integration-tests">Decision Framework: Unit vs. Integration Tests</h3>
<p><strong>Unit tests</strong>:
- Test components in isolation
- Fast execution
- Pinpoint failures to specific components
- Use mocks for dependencies</p>
<p><strong>Integration tests</strong>:
- Test components working together
- Slower execution
- Verify component interactions
- Use real implementations</p>
<p><strong>For our payment system</strong>:
- <strong>Unit tests</strong>: Test each component (CardValidator, FeeCalculator, etc.) independently
- <strong>Integration tests</strong>: Test PaymentProcessor with all real components
- <strong>Balance</strong>: More unit tests (fast feedback), fewer integration tests (verify integration)</p>
<h3 id="when-to-write-integration-tests">When to Write Integration Tests</h3>
<p><strong>Write integration tests when</strong>:
- Components have complex interactions
- Data flows through multiple components
- Error handling crosses component boundaries
- State is shared between components
- You need to verify the complete user flow</p>
<p><strong>Don't write integration tests when</strong>:
- Components are completely independent
- Unit tests provide sufficient coverage
- Integration would be too slow or complex
- The integration is trivial (simple delegation)</p>
<h3 id="lessons-learned_4">Lessons Learned</h3>
<ol>
<li><strong>Test components in isolation first</strong>: Verify each piece works before testing integration</li>
<li><strong>Use fixtures for system setup</strong>: Create complete systems with all dependencies</li>
<li><strong>Test error propagation</strong>: Verify errors in one component are handled correctly by others</li>
<li><strong>Test state accumulation</strong>: Verify that shared state is managed correctly</li>
<li><strong>Test both success and failure paths</strong>: Integration tests should cover error scenarios</li>
<li><strong>Keep integration tests focused</strong>: Test specific integration points, not everything</li>
<li><strong>Balance unit and integration tests</strong>: More unit tests, fewer integration tests</li>
<li><strong>Use real implementations</strong>: Integration tests should use real components, not mocks</li>
</ol>
        </div>
        <div class="footer">
            Generated on 2025-12-03 10:37:04 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>