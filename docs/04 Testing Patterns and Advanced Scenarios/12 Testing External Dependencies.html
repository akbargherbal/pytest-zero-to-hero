<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>12 Testing External Dependencies</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">04 Testing Patterns and Advanced Scenarios</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-12-testing-external-dependencies">Chapter 12: Testing External Dependencies</h1>
<h2 id="database-testing-strategies">Database Testing Strategies</h2>
<h2 id="the-challenge-of-the-outside-world">The Challenge of the Outside World</h2>
<p>So far, we have focused on testing "pure" functions‚Äîcode whose output depends only on its input. This is the ideal scenario for testing. However, most real-world applications are not so simple. They interact with the outside world: they query databases, call external APIs, read from the filesystem, and send emails.</p>
<p>These interactions, known as <strong>side effects</strong> or <strong>I/O (Input/Output)</strong>, introduce significant challenges for testing:</p>
<ul>
<li><strong>Slowness:</strong> A network request or database query can take hundreds of milliseconds, orders of magnitude slower than a pure function call. A suite with hundreds of such tests can become unusably slow.</li>
<li><strong>Unreliability:</strong> What if the network is down? The database is offline for maintenance? The API rate limit is exceeded? External systems can fail for reasons completely outside your control, causing your tests to fail sporadically. This is known as "flakiness."</li>
<li><strong>Statefulness:</strong> A test that writes data to a database might affect the outcome of the next test that reads from it. This lack of <strong>test isolation</strong> makes tests order-dependent and hard to debug.</li>
<li><strong>Cost &amp; Complexity:</strong> Setting up a dedicated test database or paying for API calls during testing can be expensive and complicated.</li>
</ul>
<p>The goal of this chapter is to learn strategies for taming these external dependencies, allowing us to write fast, reliable, and isolated tests for complex, real-world code.</p>
<h3 id="phase-1-establish-the-reference-implementation">Phase 1: Establish the Reference Implementation</h3>
<p>We will build our chapter around a single, realistic function that incorporates three common types of external dependencies: a database, an external API, and the filesystem.</p>
<p>Our anchor example is a function called <code>process_user_report</code>. Its job is to:
1.  Fetch a user's details from a <strong>database</strong>.
2.  Use the user's IP address to get their geographical location from an external <strong>API</strong>.
3.  Write a combined report to a <strong>file</strong>.</p>
<p>Let's start by defining the components of our system. We'll place this code in a new directory <code>user_reporter</code>.</p>
<div class="codehilite"><pre><span></span><code>mkdir<span class="w"> </span>user_reporter
touch<span class="w"> </span>user_reporter/__init__.py
touch<span class="w"> </span>user_reporter/main.py
touch<span class="w"> </span>user_reporter/db.py
touch<span class="w"> </span>user_reporter/api.py
</code></pre></div>

<p>First, the database interaction logic in <code>user_reporter/db.py</code>. We'll use SQLite for simplicity.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_reporter/db.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">:</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserDatabase</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_path</span> <span class="o">=</span> <span class="n">db_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">User</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;SELECT id, name, ip_address FROM users WHERE id = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">User</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">setup_database</span><span class="p">(</span><span class="n">db_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A helper to create and populate the database for our example.&quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS users&quot;</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE users (</span>
<span class="s2">            id INTEGER PRIMARY KEY,</span>
<span class="s2">            name TEXT NOT NULL,</span>
<span class="s2">            ip_address TEXT NOT NULL</span>
<span class="s2">        )</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;INSERT INTO users (id, name, ip_address) VALUES (?, ?, ?)&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="s2">&quot;192.168.1.100&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>

<p>Next, the API client in <code>user_reporter/api.py</code>. It calls a fictional geolocation API.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_reporter/api.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="k">class</span><span class="w"> </span><span class="nc">GeolocationClient</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://api.geolocation.com&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_country_for_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetches the country for a given IP address.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/ip/</span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>  <span class="c1"># Raise an exception for bad status codes</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;country&quot;</span><span class="p">]</span>
</code></pre></div>

<p>Finally, the main logic that ties everything together in <code>user_reporter/main.py</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_reporter/main.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserDatabase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">GeolocationClient</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_user_report</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetches user data, enriches it with geo IP info, and writes a report.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">UserDatabase</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User with ID </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>

    <span class="n">api_client</span> <span class="o">=</span> <span class="n">GeolocationClient</span><span class="p">()</span>
    <span class="n">country</span> <span class="o">=</span> <span class="n">api_client</span><span class="o">.</span><span class="n">get_country_for_ip</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">ip_address</span><span class="p">)</span>

    <span class="n">report_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;user_report_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">.txt&quot;</span>
    <span class="n">report_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User Report for </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">report_content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;IP Address: </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">ip_address</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">report_content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Country: </span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">report_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">report_content</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Report generated at </span><span class="si">{</span><span class="n">report_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="the-naive-integration-test">The Naive Integration Test</h3>
<p>Now, let's write our first test for <code>process_user_report</code>. This test will be an <em>integration test</em>‚Äîit will interact with a real database file and attempt to make a real network call. This is the most straightforward, but also the most problematic, way to test our function.</p>
<p>We'll create a <code>tests</code> directory and our test file.</p>
<div class="codehilite"><pre><span></span><code>mkdir<span class="w"> </span>tests
touch<span class="w"> </span>tests/test_user_reporter.py
</code></pre></div>

<p>Here is our initial, problematic test.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_user_reporter.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_reporter.main</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_user_report</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_reporter.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_database</span>

<span class="c1"># --- WARNING: This is a problematic test setup! ---</span>

<span class="n">DB_PATH</span> <span class="o">=</span> <span class="s2">&quot;test_users.db&quot;</span>
<span class="n">OUTPUT_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./test_reports&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_user_report_naive</span><span class="p">():</span>
    <span class="c1"># 1. Setup: Create a real database file and output directory</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">DB_PATH</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">DB_PATH</span><span class="p">)</span>
    <span class="n">setup_database</span><span class="p">(</span><span class="n">DB_PATH</span><span class="p">)</span>
    <span class="n">OUTPUT_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># 2. Execute the function under test</span>
    <span class="c1"># This will make a REAL network request to a non-existent API!</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">process_user_report</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">db_path</span><span class="o">=</span><span class="n">DB_PATH</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">OUTPUT_DIR</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># We expect this to fail because the API doesn&#39;t exist.</span>
        <span class="c1"># For now, we&#39;ll just print the error to see what happens.</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;API call failed as expected: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># In a real scenario, this test would just fail unpredictably.</span>

    <span class="c1"># 3. Teardown: Clean up the created files</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">DB_PATH</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">DB_PATH</span><span class="p">)</span>

    <span class="c1"># We are not cleaning up the report file, which is another problem.</span>
</code></pre></div>

<p>This test has numerous problems that we will solve one by one throughout this chapter:</p>
<ol>
<li><strong>Database Coupling:</strong> It creates a real file (<code>test_users.db</code>) on disk. If two tests run in parallel, they could interfere with each other. Cleaning up this file manually is error-prone.</li>
<li><strong>Network Dependency:</strong> It tries to make a real HTTP request to <code>https://api.geolocation.com</code>. This will fail because the domain doesn't exist, but more importantly, it makes our test suite dependent on the network. It's slow and unreliable.</li>
<li><strong>Filesystem Pollution:</strong> It creates a <code>test_reports</code> directory and writes a file into it. It doesn't clean up this file, leaving artifacts behind after the test run.</li>
</ol>
<p>In the following sections, we will systematically replace each of these real dependencies with test-friendly replacements, transforming this brittle integration test into a fast and reliable unit test.</p>
<h2 id="using-fixtures-for-database-setup">Using Fixtures for Database Setup</h2>
<h2 id="iteration-1-isolating-the-database">Iteration 1: Isolating the Database</h2>
<p>Our first problem is the hardcoded database file (<code>test_users.db</code>). Tests should never share state, and writing to a fixed file path is a classic example of shared state. If one test modifies the database, it could cause another test to fail.</p>
<h3 id="the-problem-test-interference">The Problem: Test Interference</h3>
<p>Let's demonstrate this problem. Imagine we have two tests. The first test processes a user report, and a second test checks how many users are in the database.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_user_reporter_db_problem.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_reporter.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_database</span>

<span class="n">DB_PATH</span> <span class="o">=</span> <span class="s2">&quot;shared_test.db&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">setup_module</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up the database once for all tests in this file.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">DB_PATH</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">DB_PATH</span><span class="p">)</span>
    <span class="n">setup_database</span><span class="p">(</span><span class="n">DB_PATH</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Database &#39;</span><span class="si">{</span><span class="n">DB_PATH</span><span class="si">}</span><span class="s2">&#39; set up ---&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">teardown_module</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tear down the database once after all tests.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">DB_PATH</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">DB_PATH</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Database &#39;</span><span class="si">{</span><span class="n">DB_PATH</span><span class="si">}</span><span class="s2">&#39; torn down ---&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_adds_a_new_user</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This test modifies the database state.&quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DB_PATH</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;INSERT INTO users (id, name, ip_address) VALUES (?, ?, ?)&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Bob&quot;</span><span class="p">,</span> <span class="s2">&quot;10.0.0.5&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Check that the user was added</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DB_PATH</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*) FROM users&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_initial_user_count_is_one</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This test assumes a clean initial state.&quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DB_PATH</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*) FROM users&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>

<p>Let's run this file with <code>pytest -v -s</code>. The <code>-s</code> flag is important to see our <code>print</code> statements. Pytest will run tests in alphabetical order, so <code>test_adds_a_new_user</code> runs first.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v<span class="w"> </span>-s<span class="w"> </span>tests/test_user_reporter_db_problem.py
<span class="o">===========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">============================</span>
...
collected<span class="w"> </span><span class="m">2</span><span class="w"> </span>items

---<span class="w"> </span>Database<span class="w"> </span><span class="s1">&#39;shared_test.db&#39;</span><span class="w"> </span><span class="nb">set</span><span class="w"> </span>up<span class="w"> </span>---
tests/test_user_reporter_db_problem.py::test_adds_a_new_user<span class="w"> </span>PASSED
tests/test_user_reporter_db_problem.py::test_initial_user_count_is_one<span class="w"> </span><span class="nv">FAILED</span>

<span class="o">=================================</span><span class="w"> </span><span class="nv">FAILURES</span><span class="w"> </span><span class="o">=================================</span>
____________<span class="w"> </span>test_initial_user_count_is_one<span class="w"> </span>____________

<span class="w">    </span>def<span class="w"> </span>test_initial_user_count_is_one<span class="o">()</span>:
<span class="w">        </span><span class="s2">&quot;&quot;&quot;This test assumes a clean initial state.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="nv">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>sqlite3.connect<span class="o">(</span>DB_PATH<span class="o">)</span>
<span class="w">        </span><span class="nv">cursor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>conn.cursor<span class="o">()</span>
<span class="w">        </span><span class="nv">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>cursor.execute<span class="o">(</span><span class="s2">&quot;SELECT COUNT(*) FROM users&quot;</span><span class="o">)</span>.fetchone<span class="o">()[</span><span class="m">0</span><span class="o">]</span>
<span class="w">        </span>conn.close<span class="o">()</span>
&gt;<span class="w">       </span>assert<span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span>
E<span class="w">       </span>assert<span class="w"> </span><span class="nv">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span>

tests/test_user_reporter_db_problem.py:40:<span class="w"> </span>AssertionError
---<span class="w"> </span>Database<span class="w"> </span><span class="s1">&#39;shared_test.db&#39;</span><span class="w"> </span>torn<span class="w"> </span>down<span class="w"> </span>---
<span class="o">=========================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>failed,<span class="w"> </span><span class="m">1</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span>...s<span class="w"> </span><span class="o">=========================</span>
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-failure">Diagnostic Analysis: Reading the Failure</h3>
<p><strong>The complete output</strong>: The output clearly shows one test passing and one failing with an <code>AssertionError</code>.</p>
<p><strong>Let's parse this section by section</strong>:</p>
<ol>
<li>
<p><strong>The summary line</strong>: <code>FAILED tests/test_user_reporter_db_problem.py::test_initial_user_count_is_one - AssertionError</code></p>
<ul>
<li>What this tells us: The test named <code>test_initial_user_count_is_one</code> failed because an <code>assert</code> statement was false.</li>
</ul>
</li>
<li>
<p><strong>The traceback</strong>: The traceback is very short, pointing directly to the failing line: <code>assert count == 1</code>.</p>
</li>
<li>
<p><strong>The assertion introspection</strong>:
    <code>E       assert 2 == 1</code></p>
<ul>
<li>What this tells us: Pytest's excellent introspection shows us the values at the time of the assertion. The variable <code>count</code> was <code>2</code>, but the test expected it to be <code>1</code>.</li>
</ul>
</li>
</ol>
<p><strong>Root cause identified</strong>: The <code>test_adds_a_new_user</code> test ran first and added a user to the database. The <code>test_initial_user_count_is_one</code> test ran second and saw the modified database, not the clean state it expected. The tests are not isolated.</p>
<p><strong>Why the current approach can't solve this</strong>: Using <code>setup_module</code> and <code>teardown_module</code> creates a shared database for all tests in the file. This is efficient but leads to state pollution.</p>
<p><strong>What we need</strong>: A mechanism to provide each test function with its own, clean, isolated database session, and automatically clean up any changes after the test finishes. This is a perfect job for fixtures.</p>
<h3 id="the-solution-transactional-database-fixtures">The Solution: Transactional Database Fixtures</h3>
<p>We will create a fixture that provides a database session. For each test, it will:
1.  Begin a transaction.
2.  Yield the database session to the test.
3.  After the test completes, roll back the transaction.</p>
<p>Rolling back the transaction effectively erases any changes the test made to the database, ensuring the next test starts from a pristine state. We'll use an in-memory SQLite database to avoid creating files altogether.</p>
<p>Let's create a <code>conftest.py</code> file to hold our new fixture.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/conftest.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_reporter.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_connection</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A session-scoped fixture for a single in-memory DB connection.&quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE users (</span>
<span class="s2">            id INTEGER PRIMARY KEY,</span>
<span class="s2">            name TEXT NOT NULL,</span>
<span class="s2">            ip_address TEXT NOT NULL</span>
<span class="s2">        )</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">conn</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_session</span><span class="p">(</span><span class="n">db_connection</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function-scoped fixture to provide a clean database state for each test.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Seed the database with initial data for each test</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">db_connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;INSERT INTO users (id, name, ip_address) VALUES (?, ?, ?)&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="s2">&quot;192.168.1.100&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">db_connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">yield</span> <span class="n">db_connection</span>

    <span class="c1"># Teardown: Clean up by deleting all data</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM users&quot;</span><span class="p">)</span>
    <span class="n">db_connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>

<p>Let's break this down:
*   <code>db_connection</code>: This is a <code>session</code>-scoped fixture. It creates a single in-memory database connection that lasts for the entire test run. This is efficient. It also creates the <code>users</code> table just once.
*   <code>db_session</code>: This is a <code>function</code>-scoped fixture (the default scope). It runs for <em>every single test function</em> that requests it.
    *   It depends on <code>db_connection</code> to get the shared connection.
    *   Before yielding to the test, it inserts our initial "Alice" user. This ensures every test starts with the exact same known data.
    *   After the test finishes, the <code>yield</code> statement resumes, and it runs the teardown code: <code>DELETE FROM users</code>. This wipes the table clean, guaranteeing isolation for the next test.</p>
<p>Now, let's rewrite our failing tests to use this fixture.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_user_reporter_db_solution.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_adds_a_new_user_isolated</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This test modifies the database state, but changes are isolated.&quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">db_session</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;INSERT INTO users (id, name, ip_address) VALUES (?, ?, ?)&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Bob&quot;</span><span class="p">,</span> <span class="s2">&quot;10.0.0.5&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">db_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="n">count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*) FROM users&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_initial_user_count_is_one_isolated</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This test now gets a clean state and passes.&quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">db_session</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*) FROM users&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>

<h3 id="verification">Verification</h3>
<p>Let's run the new test file.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v<span class="w"> </span>tests/test_user_reporter_db_solution.py
<span class="o">===========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">============================</span>
...
collected<span class="w"> </span><span class="m">2</span><span class="w"> </span>items

tests/test_user_reporter_db_solution.py::test_adds_a_new_user_isolated<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">50</span>%<span class="o">]</span>
tests/test_user_reporter_db_solution.py::test_initial_user_count_is_one_isolated<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">============================</span><span class="w"> </span><span class="m">2</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span>...s<span class="w"> </span><span class="o">==============================</span>
</code></pre></div>

<p>Success! Both tests pass, regardless of the order they are run in. The <code>db_session</code> fixture ensures that <code>test_initial_user_count_is_one_isolated</code> sees only the single "Alice" user that was set up for it, because the "Bob" user added by the other test was cleaned up automatically.</p>
<p>We have successfully isolated our tests from the database state. Now, let's apply this to our main <code>process_user_report</code> function. But first, we need to make a small but critical change to our application code to make it more testable. This pattern is called <strong>Dependency Injection</strong>.</p>
<h2 id="testing-api-calls">Testing API Calls</h2>
<h2 id="iteration-2-taming-the-network">Iteration 2: Taming the Network</h2>
<p>Our tests are now isolated from the database, but our main function <code>process_user_report</code> still has a major problem: it instantiates its own <code>GeolocationClient</code> and makes a real network call.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_reporter/main.py (Original)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_user_report</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="n">api_client</span> <span class="o">=</span> <span class="n">GeolocationClient</span><span class="p">()</span> <span class="c1"># Problem: Hardcoded dependency</span>
    <span class="n">country</span> <span class="o">=</span> <span class="n">api_client</span><span class="o">.</span><span class="n">get_country_for_ip</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">ip_address</span><span class="p">)</span>
    <span class="c1"># ...</span>
</code></pre></div>

<p>This makes testing difficult. We can't easily replace the real <code>GeolocationClient</code> with a fake one for testing. The solution is to refactor the function to accept its dependencies as arguments.</p>
<h3 id="refactoring-for-testability-dependency-injection">Refactoring for Testability: Dependency Injection</h3>
<p>Let's modify <code>process_user_report</code> and the other components to allow dependencies to be "injected".</p>
<p>First, we'll update <code>UserDatabase</code> to accept a connection object instead of creating its own. This allows our fixture to provide the connection.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_reporter/db.py (Updated)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">:</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserDatabase</span><span class="p">:</span>
    <span class="c1"># It now accepts an existing connection</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">connection</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">User</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># ... (rest of the method is the same)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;SELECT id, name, ip_address FROM users WHERE id = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">User</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># No longer needs a close() method, as the connection is managed externally</span>
</code></pre></div>

<p>Now, the main function. It will now accept instances of <code>UserDatabase</code> and <code>GeolocationClient</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_reporter/main.py (Updated)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserDatabase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">GeolocationClient</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_user_report</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
    <span class="n">db</span><span class="p">:</span> <span class="n">UserDatabase</span><span class="p">,</span> 
    <span class="n">api_client</span><span class="p">:</span> <span class="n">GeolocationClient</span><span class="p">,</span> 
    <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetches user data, enriches it with geo IP info, and writes a report.</span>
<span class="sd">    Dependencies are now injected.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User with ID </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>

    <span class="n">country</span> <span class="o">=</span> <span class="n">api_client</span><span class="o">.</span><span class="n">get_country_for_ip</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">ip_address</span><span class="p">)</span>

    <span class="n">report_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;user_report_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">.txt&quot;</span>
    <span class="n">report_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User Report for </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">report_content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;IP Address: </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">ip_address</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">report_content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Country: </span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">report_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">report_content</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Report generated at </span><span class="si">{</span><span class="n">report_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>This refactoring is a game-changer. Our function is no longer responsible for creating its dependencies; it just uses the ones it's given. In production, we'll pass in real objects. In testing, we can pass in fakes.</p>
<h3 id="the-problem-unreliable-network-calls">The Problem: Unreliable Network Calls</h3>
<p>Let's write a test for our refactored function. We'll use our <code>db_session</code> fixture, but for now, we'll still use a real <code>GeolocationClient</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_user_reporter.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_reporter.main</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_user_report</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_reporter.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserDatabase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_reporter.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">GeolocationClient</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_user_report_network_problem</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
    <span class="c1"># Arrange: Use our DB fixture and a real API client</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">UserDatabase</span><span class="p">(</span><span class="n">db_session</span><span class="p">)</span>
    <span class="n">api_client</span> <span class="o">=</span> <span class="n">GeolocationClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://api.geolocation.com&quot;</span><span class="p">)</span> <span class="c1"># Non-existent API</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./reports&quot;</span><span class="p">)</span> <span class="c1"># Another problem: writing to a real directory</span>
    <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Act &amp; Assert: This will fail because of the network call</span>
    <span class="n">process_user_report</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
        <span class="n">api_client</span><span class="o">=</span><span class="n">api_client</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span>
    <span class="p">)</span>
</code></pre></div>

<p>Let's run this test. It will fail, but the failure is informative.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v<span class="w"> </span>tests/test_user_reporter.py::test_process_user_report_network_problem
<span class="o">===========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">============================</span>
...
collected<span class="w"> </span><span class="m">1</span><span class="w"> </span>item

tests/test_user_reporter.py::test_process_user_report_network_problem<span class="w"> </span>FAILED<span class="w"> </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">=================================</span><span class="w"> </span><span class="nv">FAILURES</span><span class="w"> </span><span class="o">=================================</span>
_______<span class="w"> </span>test_process_user_report_network_problem<span class="w"> </span>_______

<span class="nv">db_session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>&lt;sqlite3.Connection<span class="w"> </span>object<span class="w"> </span>at<span class="w"> </span>0x...&gt;

<span class="w">    </span>def<span class="w"> </span>test_process_user_report_network_problem<span class="o">(</span>db_session<span class="o">)</span>:
<span class="w">        </span><span class="c1"># ... (Arrange)</span>

<span class="w">        </span><span class="c1"># Act &amp; Assert: This will fail because of the network call</span>
&gt;<span class="w">       </span>process_user_report<span class="o">(</span>
<span class="w">            </span><span class="nv">user_id</span><span class="o">=</span><span class="m">1</span>,
<span class="w">            </span><span class="nv">db</span><span class="o">=</span>db,
<span class="w">            </span><span class="nv">api_client</span><span class="o">=</span>api_client,
<span class="w">            </span><span class="nv">output_dir</span><span class="o">=</span>output_dir
<span class="w">        </span><span class="o">)</span>

tests/test_user_reporter.py:16:<span class="w"> </span>
_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>
user_reporter/main.py:17:<span class="w"> </span><span class="k">in</span><span class="w"> </span>process_user_report
<span class="w">    </span><span class="nv">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>api_client.get_country_for_ip<span class="o">(</span>user.ip_address<span class="o">)</span>
user_reporter/api.py:9:<span class="w"> </span><span class="k">in</span><span class="w"> </span>get_country_for_ip
<span class="w">    </span><span class="nv">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>requests.get<span class="o">(</span>f<span class="s2">&quot;{self.base_url}/ip/{ip_address}&quot;</span><span class="o">)</span>
...
<span class="w">    </span>raise<span class="w"> </span>ConnectionError<span class="o">(</span>e,<span class="w"> </span><span class="nv">request</span><span class="o">=</span>request<span class="o">)</span>
E<span class="w">   </span>requests.exceptions.ConnectionError:<span class="w"> </span>HTTPSConnectionPool<span class="o">(</span><span class="nv">host</span><span class="o">=</span><span class="s1">&#39;api.geolocation.com&#39;</span>,<span class="w"> </span><span class="nv">port</span><span class="o">=</span><span class="m">443</span><span class="o">)</span>:<span class="w"> </span>Max<span class="w"> </span>retries<span class="w"> </span>exceeded<span class="w"> </span>with<span class="w"> </span>url:<span class="w"> </span>/ip/192.168.1.100<span class="w"> </span><span class="o">(</span>Caused<span class="w"> </span>by<span class="w"> </span>NameResolutionError<span class="o">(</span><span class="s2">&quot;&lt;urllib3.connection.HTTPSConnection object at 0x...&gt;: Failed to resolve &#39;api.geolocation.com&#39; ([Errno 8] nodename nor servname provided, or not known)&quot;</span><span class="o">))</span>
<span class="o">=========================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>failed<span class="w"> </span><span class="k">in</span><span class="w"> </span>...s<span class="w"> </span><span class="o">=========================</span>
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-failure_1">Diagnostic Analysis: Reading the Failure</h3>
<p><strong>The complete output</strong>: The test fails with a <code>requests.exceptions.ConnectionError</code>.</p>
<p><strong>Let's parse this section by section</strong>:</p>
<ol>
<li>
<p><strong>The summary line</strong>: <code>FAILED ... - requests.exceptions.ConnectionError</code></p>
<ul>
<li>What this tells us: The test failed because the <code>requests</code> library couldn't connect to the server.</li>
</ul>
</li>
<li>
<p><strong>The traceback</strong>:
    <code>user_reporter/main.py:17: in process_user_report
        country = api_client.get_country_for_ip(user.ip_address)
    user_reporter/api.py:9: in get_country_for_ip
        response = requests.get(f"{self.base_url}/ip/{ip_address}")</code></p>
<ul>
<li>What this tells us: The failure originated deep inside the <code>requests</code> library, but the call chain shows it was triggered by <code>api_client.get_country_for_ip</code> inside our <code>process_user_report</code> function.</li>
</ul>
</li>
<li>
<p><strong>The exception details</strong>: <code>Failed to resolve 'api.geolocation.com'</code></p>
<ul>
<li>What this tells us: The specific reason for the connection error is that the domain name could not be found. This is expected, as we made it up. If it were a real API that was temporarily down, we might see a timeout error or a different connection error.</li>
</ul>
</li>
</ol>
<p><strong>Root cause identified</strong>: The test is attempting to make a real HTTP request to an external service, making it slow and subject to network failures.</p>
<p><strong>Why the current approach can't solve this</strong>: We are passing a real <code>GeolocationClient</code> to our function. Its entire purpose is to make real network calls.</p>
<p><strong>What we need</strong>: A way to intercept the outgoing HTTP request made by the <code>requests</code> library and return a fake, predefined response without ever touching the network. This is called <strong>mocking</strong>.</p>
<h2 id="mocking-http-requests-with-responses">Mocking HTTP Requests with responses</h2>
<h2 id="the-solution-mocking-with-the-responses-library">The Solution: Mocking with the <code>responses</code> Library</h2>
<p>While <code>unittest.mock</code> (covered in Chapter 11) can be used to patch the <code>requests</code> library, there are specialized tools that make mocking HTTP requests much cleaner and more powerful. One of the best is the <code>responses</code> library.</p>
<p>First, let's install it.</p>
<div class="codehilite"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>responses
</code></pre></div>

<p>The <code>responses</code> library works as a context manager or a decorator that patches <code>requests</code> for you. Inside its context, any call to <code>requests.get</code>, <code>requests.post</code>, etc., is intercepted. If the call matches a URL you've registered, your predefined fake response is returned. If it doesn't match, it raises an error.</p>
<h3 id="creating-a-mocking-fixture">Creating a Mocking Fixture</h3>
<p>We can wrap the <code>responses</code> functionality in a pytest fixture for easy reuse. Let's add this to our <code>tests/conftest.py</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/conftest.py (additions)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">responses</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_responses</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A fixture to mock out the requests library.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">responses</span><span class="o">.</span><span class="n">RequestsMock</span><span class="p">()</span> <span class="k">as</span> <span class="n">rsps</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">rsps</span>
</code></pre></div>

<p>This fixture starts a <code>RequestsMock</code> context, yields the mock object (<code>rsps</code>) to the test so it can register fake URLs, and ensures everything is cleaned up afterward.</p>
<h3 id="iteration-2-solution-applying-the-mock">Iteration 2 Solution: Applying the Mock</h3>
<p>Now we can rewrite our failing test to use this fixture. We will inject a real <code>GeolocationClient</code>, but because our <code>mock_responses</code> fixture is active, the client's call to <code>requests.get</code> will be intercepted and never reach the network.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_user_reporter.py (updated test)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">responses</span> <span class="c1"># Import the library</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_reporter.main</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_user_report</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_reporter.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserDatabase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_reporter.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">GeolocationClient</span>

<span class="c1"># We still have the filesystem problem, which we&#39;ll fix next.</span>
<span class="c1"># For now, we&#39;ll just use a dummy path and not check the file contents.</span>
<span class="n">DUMMY_OUTPUT_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./dummy_reports&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_user_report_with_mock_api</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">mock_responses</span><span class="p">):</span>
    <span class="c1"># Arrange (Database)</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">UserDatabase</span><span class="p">(</span><span class="n">db_session</span><span class="p">)</span>

    <span class="c1"># Arrange (API Mock)</span>
    <span class="c1"># We tell `responses` that any GET request to this specific URL...</span>
    <span class="n">mock_responses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;https://api.geolocation.com/ip/192.168.1.100&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="s2">&quot;USA&quot;</span><span class="p">},</span> <span class="c1"># ...should return this JSON payload...</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="c1"># ...with a 200 OK status code.</span>
    <span class="p">)</span>
    <span class="c1"># We still pass a real API client, but its requests will be intercepted.</span>
    <span class="n">api_client</span> <span class="o">=</span> <span class="n">GeolocationClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://api.geolocation.com&quot;</span><span class="p">)</span>

    <span class="c1"># Arrange (Filesystem)</span>
    <span class="n">DUMMY_OUTPUT_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Act</span>
    <span class="n">process_user_report</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
        <span class="n">api_client</span><span class="o">=</span><span class="n">api_client</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">DUMMY_OUTPUT_DIR</span>
    <span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="c1"># For now, we can&#39;t easily check the file. We&#39;ll just assert the test runs without error.</span>
    <span class="c1"># We will add a proper file assertion in the next section.</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mock_responses</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">mock_responses</span><span class="o">.</span><span class="n">calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="o">==</span> <span class="s2">&quot;https://api.geolocation.com/ip/192.168.1.100&quot;</span>
    <span class="k">assert</span> <span class="n">mock_responses</span><span class="o">.</span><span class="n">calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
</code></pre></div>

<h3 id="verification_1">Verification</h3>
<p>Let's run our new test.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v<span class="w"> </span>tests/test_user_reporter.py::test_process_user_report_with_mock_api
<span class="o">===========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">============================</span>
...
collected<span class="w"> </span><span class="m">1</span><span class="w"> </span>item

tests/test_user_reporter.py::test_process_user_report_with_mock_api<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">============================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span>...s<span class="w"> </span><span class="o">==============================</span>
</code></pre></div>

<p>It passes! And it does so almost instantly. The <code>requests.exceptions.ConnectionError</code> is gone. We have successfully isolated our test from the network.</p>
<p>The assertions at the end are also very powerful. The <code>mock_responses</code> object records all intercepted calls, so we can assert that:
*   Exactly one API call was made (<code>len(mock_responses.calls) == 1</code>).
*   The correct URL was called.
*   The response we received was the one we mocked.</p>
<h3 id="testing-failure-cases">Testing Failure Cases</h3>
<p>Mocking is not just for simulating success. It's crucial for testing how your code handles API errors. What if the API returns a 404 Not Found? Our current <code>GeolocationClient</code> would raise an exception via <code>response.raise_for_status()</code>. Let's test that our main function propagates this error correctly.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_user_reporter.py (new test for API failure)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_user_report_api_error</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">mock_responses</span><span class="p">):</span>
    <span class="c1"># Arrange</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">UserDatabase</span><span class="p">(</span><span class="n">db_session</span><span class="p">)</span>
    <span class="n">mock_responses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;https://api.geolocation.com/ip/192.168.1.100&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;IP not found&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="c1"># Simulate a 404 Not Found error</span>
    <span class="p">)</span>
    <span class="n">api_client</span> <span class="o">=</span> <span class="n">GeolocationClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://api.geolocation.com&quot;</span><span class="p">)</span>

    <span class="c1"># Act &amp; Assert</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">)</span> <span class="k">as</span> <span class="n">excinfo</span><span class="p">:</span>
        <span class="n">process_user_report</span><span class="p">(</span>
            <span class="n">user_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
            <span class="n">api_client</span><span class="o">=</span><span class="n">api_client</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">DUMMY_OUTPUT_DIR</span>
        <span class="p">)</span>

    <span class="c1"># Optionally, assert on the error message or status code</span>
    <span class="k">assert</span> <span class="s2">&quot;404 Client Error: Not Found&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">excinfo</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>

<p>This test also passes instantly, giving us confidence that our application behaves correctly even when its dependencies fail. This kind of negative testing is extremely difficult and unreliable without mocking.</p>
<h2 id="testing-file-io">Testing File I/O</h2>
<h2 id="iteration-3-controlling-the-filesystem">Iteration 3: Controlling the Filesystem</h2>
<p>We have isolated our database and network interactions. The last remaining dependency is the filesystem. Our function currently writes a report to a directory that we create manually.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_user_reporter.py (current state)</span>
<span class="n">DUMMY_OUTPUT_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./dummy_reports&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_user_report_with_mock_api</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="n">DUMMY_OUTPUT_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">process_user_report</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">DUMMY_OUTPUT_DIR</span><span class="p">)</span>
    <span class="c1"># ...</span>
</code></pre></div>

<p>This has several problems:
*   <strong>State Pollution:</strong> The <code>dummy_reports</code> directory and its contents are left behind after the test run, cluttering your project.
*   <strong>Test Interference:</strong> If two tests write to the same filename, they can overwrite each other's output, leading to flaky tests.
*   <strong>Assertion Difficulty:</strong> To check the report's contents, we have to manually construct the file path, open it, read it, and then remember to clean it up. This is tedious and error-prone.</p>
<h3 id="the-problem-shared-filesystem-state">The Problem: Shared Filesystem State</h3>
<p>Let's demonstrate the interference problem. Imagine two tests that process reports for the same user ID, but expect different content (perhaps due to different API responses).</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_file_problem.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>

<span class="c1"># A simplified function that just writes a file</span>
<span class="k">def</span><span class="w"> </span><span class="nf">write_report</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
    <span class="n">report_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;user_report_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">.txt&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">report_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

<span class="n">OUTPUT_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./shared_reports&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">setup_function</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
    <span class="n">OUTPUT_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">teardown_function</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">OUTPUT_DIR</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_report_for_usa</span><span class="p">():</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">write_report</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;Country: USA&quot;</span><span class="p">,</span> <span class="n">OUTPUT_DIR</span><span class="p">)</span>

    <span class="n">report_path</span> <span class="o">=</span> <span class="n">OUTPUT_DIR</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;user_report_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">.txt&quot;</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">report_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s2">&quot;Country: USA&quot;</span> <span class="ow">in</span> <span class="n">content</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_report_for_canada</span><span class="p">():</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Same user ID!</span>
    <span class="n">write_report</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;Country: Canada&quot;</span><span class="p">,</span> <span class="n">OUTPUT_DIR</span><span class="p">)</span>

    <span class="n">report_path</span> <span class="o">=</span> <span class="n">OUTPUT_DIR</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;user_report_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">.txt&quot;</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">report_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s2">&quot;Country: Canada&quot;</span> <span class="ow">in</span> <span class="n">content</span>
</code></pre></div>

<p>These tests will pass if run individually. But what if we run them together and a test runner decides to run them in parallel in the future? Or if one test fails after writing the file but before its assertion? The file from one test can be read by another.</p>
<p>Let's simulate a more direct conflict. What if <code>test_report_for_usa</code> also checked that the file <em>doesn't</em> contain "Canada"?</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_file_problem_fail.py</span>
<span class="c1"># ... (setup is the same as above) ...</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_report_for_canada_first</span><span class="p">():</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">write_report</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;Country: Canada&quot;</span><span class="p">,</span> <span class="n">OUTPUT_DIR</span><span class="p">)</span>
    <span class="c1"># This test passes, but leaves behind a file.</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_report_for_usa_reads_stale_file</span><span class="p">():</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># Let&#39;s assume this test runs second, but the teardown from the first failed.</span>
    <span class="c1"># To simulate, we&#39;ll just check the state of the file.</span>
    <span class="n">report_path</span> <span class="o">=</span> <span class="n">OUTPUT_DIR</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;user_report_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">.txt&quot;</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">report_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s2">&quot;Country: USA&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">content</span> <span class="c1"># This should pass</span>
    <span class="k">assert</span> <span class="s2">&quot;Country: Canada&quot;</span> <span class="ow">in</span> <span class="n">content</span> <span class="c1"># This will fail!</span>
</code></pre></div>

<p>This is a contrived example, but it shows the core issue: when tests share a writable directory, they are no longer independent.</p>
<p><strong>Root cause identified</strong>: Tests are writing to a hardcoded, shared directory on the filesystem, breaking test isolation.</p>
<p><strong>Why the current approach can't solve this</strong>: Manual setup and teardown of directories is brittle. If a test fails unexpectedly, the teardown code might not run, leaving artifacts that poison subsequent test runs.</p>
<p><strong>What we need</strong>: A mechanism that provides each test function with its own unique, empty, temporary directory that is automatically and reliably cleaned up after the test, regardless of whether it passes or fails.</p>
<h2 id="working-with-temporary-files-and-directories">Working with Temporary Files and Directories</h2>
<h2 id="the-solution-pytests-tmp_path-fixture">The Solution: Pytest's <code>tmp_path</code> Fixture</h2>
<p>Pytest provides a fantastic built-in fixture for this exact problem: <code>tmp_path</code>.</p>
<p>The <code>tmp_path</code> fixture is a <code>pathlib.Path</code> object that points to a unique temporary directory created for each individual test function. Pytest guarantees that this directory will be removed after the test finishes.</p>
<h3 id="iteration-3-solution-applying-tmp_path">Iteration 3 Solution: Applying <code>tmp_path</code></h3>
<p>Using <code>tmp_path</code> is incredibly simple. You just add it as an argument to your test function, and pytest provides the path.</p>
<p>Let's write the final, fully isolated version of our test for <code>process_user_report</code>. It will use all three of our techniques:
1.  <code>db_session</code> for database isolation.
2.  <code>mock_responses</code> for network isolation.
3.  <code>tmp_path</code> for filesystem isolation.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_user_reporter_final.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">responses</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_reporter.main</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_user_report</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_reporter.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserDatabase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_reporter.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">GeolocationClient</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_user_report_final</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">mock_responses</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
    <span class="c1"># Arrange (Database)</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">UserDatabase</span><span class="p">(</span><span class="n">db_session</span><span class="p">)</span>

    <span class="c1"># Arrange (API Mock)</span>
    <span class="n">mock_responses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;https://api.geolocation.com/ip/192.168.1.100&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="s2">&quot;USA&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">api_client</span> <span class="o">=</span> <span class="n">GeolocationClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://api.geolocation.com&quot;</span><span class="p">)</span>

    <span class="c1"># Arrange (Filesystem)</span>
    <span class="c1"># `tmp_path` is a Path object to a unique temp directory.</span>
    <span class="c1"># We pass it directly to our function.</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">tmp_path</span>

    <span class="c1"># Act</span>
    <span class="n">process_user_report</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
        <span class="n">api_client</span><span class="o">=</span><span class="n">api_client</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span>
    <span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="c1"># The report file should exist inside the temporary directory.</span>
    <span class="n">expected_report_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;user_report_1.txt&quot;</span>
    <span class="k">assert</span> <span class="n">expected_report_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

    <span class="c1"># We can now safely read the content and assert on it.</span>
    <span class="n">report_content</span> <span class="o">=</span> <span class="n">expected_report_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s2">&quot;User Report for Alice&quot;</span> <span class="ow">in</span> <span class="n">report_content</span>
    <span class="k">assert</span> <span class="s2">&quot;IP Address: 192.168.1.100&quot;</span> <span class="ow">in</span> <span class="n">report_content</span>
    <span class="k">assert</span> <span class="s2">&quot;Country: USA&quot;</span> <span class="ow">in</span> <span class="n">report_content</span>
</code></pre></div>

<h3 id="verification_2">Verification</h3>
<p>Let's run this final version.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v<span class="w"> </span>tests/test_user_reporter_final.py
<span class="o">===========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">============================</span>
...
collected<span class="w"> </span><span class="m">1</span><span class="w"> </span>item

tests/test_user_reporter_final.py::test_process_user_report_final<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">============================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span>...s<span class="w"> </span><span class="o">==============================</span>
</code></pre></div>

<p>Perfect. The test passes, and we can be confident that it:
*   Ran instantly because it didn't touch the network.
*   Started with a clean, predictable database state.
*   Wrote its output to a safe, temporary location.
*   Left no trace behind after it finished.</p>
<p>This test is fast, reliable, and robust. It is a high-quality unit test that precisely verifies the logic of <code>process_user_report</code> without being coupled to the availability or state of its external dependencies.</p>
<h3 id="tmp_path-vs-tmpdir"><code>tmp_path</code> vs <code>tmpdir</code></h3>
<p>You may also see an older fixture called <code>tmpdir</code>.
*   <code>tmpdir</code>: Returns a <code>py.path.local</code> object from the <code>py</code> library.
*   <code>tmp_path</code>: Returns a standard <code>pathlib.Path</code> object.</p>
<p>The <code>pathlib</code> module is the modern, standard way to handle filesystem paths in Python. <strong>You should always prefer <code>tmp_path</code> over <code>tmpdir</code> in new code.</strong></p>
<h3 id="synthesis-the-complete-journey">Synthesis: The Complete Journey</h3>
<p>We have taken a complex function with multiple external dependencies and systematically made it testable.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Iteration</th>
<th style="text-align: left;">Failure Mode</th>
<th style="text-align: left;">Technique Applied</th>
<th style="text-align: left;">Result</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">0</td>
<td style="text-align: left;">Brittle integration test</td>
<td style="text-align: left;">None</td>
<td style="text-align: left;">Slow, unreliable, stateful test that pollutes the environment.</td>
</tr>
<tr>
<td style="text-align: left;">1</td>
<td style="text-align: left;">Database state pollution</td>
<td style="text-align: left;"><code>db_session</code> fixture with transactions</td>
<td style="text-align: left;">Tests are isolated from each other's database changes.</td>
</tr>
<tr>
<td style="text-align: left;">2</td>
<td style="text-align: left;">Network dependency (slowness, flakiness)</td>
<td style="text-align: left;"><code>responses</code> library and <code>mock_responses</code> fixture</td>
<td style="text-align: left;">Network calls are mocked, making tests fast and deterministic.</td>
</tr>
<tr>
<td style="text-align: left;">3</td>
<td style="text-align: left;">Filesystem pollution &amp; interference</td>
<td style="text-align: left;"><code>tmp_path</code> built-in fixture</td>
<td style="text-align: left;">File I/O is redirected to a clean, temporary, isolated directory.</td>
</tr>
</tbody>
</table>
<h3 id="final-implementation">Final Implementation</h3>
<p>Here is the final, testable application code, incorporating the dependency injection patterns we established.</p>
<p><strong><code>user_reporter/db.py</code></strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">:</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserDatabase</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">connection</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">User</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;SELECT id, name, ip_address FROM users WHERE id = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">User</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>

<p><strong><code>user_reporter/api.py</code></strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="k">class</span><span class="w"> </span><span class="nc">GeolocationClient</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://api.geolocation.com&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_country_for_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/ip/</span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;country&quot;</span><span class="p">]</span>
</code></pre></div>

<p><strong><code>user_reporter/main.py</code></strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserDatabase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">GeolocationClient</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_user_report</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
    <span class="n">db</span><span class="p">:</span> <span class="n">UserDatabase</span><span class="p">,</span> 
    <span class="n">api_client</span><span class="p">:</span> <span class="n">GeolocationClient</span><span class="p">,</span> 
    <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span>
<span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User with ID </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>

    <span class="n">country</span> <span class="o">=</span> <span class="n">api_client</span><span class="o">.</span><span class="n">get_country_for_ip</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">ip_address</span><span class="p">)</span>

    <span class="n">report_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;user_report_</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">.txt&quot;</span>
    <span class="n">report_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;User Report for </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">report_content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;IP Address: </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">ip_address</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">report_content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Country: </span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">report_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">report_content</span><span class="p">)</span>
</code></pre></div>

<h3 id="lessons-learned">Lessons Learned</h3>
<ul>
<li><strong>Isolate Your Tests:</strong> The primary goal when testing code with side effects is to isolate your test from the external dependency. This makes your tests fast, reliable, and deterministic.</li>
<li><strong>Dependency Injection is Key:</strong> The most powerful pattern for enabling testability is Dependency Injection. By passing dependencies (like database connections or API clients) into your functions, you create "seams" where you can substitute real objects with test doubles (fakes, mocks) during testing.</li>
<li><strong>Use the Right Tool for the Job:</strong><ul>
<li>For <strong>databases</strong>, use fixtures to manage connections and transactions for isolation.</li>
<li>For <strong>HTTP requests</strong>, use specialized libraries like <code>responses</code> to cleanly mock the network layer.</li>
<li>For the <strong>filesystem</strong>, use pytest's built-in <code>tmp_path</code> fixture to get a safe, clean, temporary workspace.</li>
</ul>
</li>
<li><strong>Test the Logic, Not the Framework:</strong> Our final test verifies the business logic of <code>process_user_report</code> (that it correctly combines data and formats a string) without actually testing SQLite, the <code>requests</code> library, or the operating system's filesystem. We trust that those well-tested components work and focus our tests on our own code.</li>
</ul>
        </div>
        <div class="footer">
            Generated on 2025-11-24 14:31:16 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>