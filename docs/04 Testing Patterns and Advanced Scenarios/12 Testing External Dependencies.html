<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>12 Testing External Dependencies</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">04 Testing Patterns and Advanced Scenarios</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-12-testing-external-dependencies">Chapter 12: Testing External Dependencies</h1>
<h2 id="database-testing-strategies">Database Testing Strategies</h2>
<h2 id="the-challenge-of-testing-database-code">The Challenge of Testing Database Code</h2>
<p>Testing code that interacts with databases presents a fundamental tension: databases are stateful, persistent, and often shared resources. Your tests need to be isolated, repeatable, and fast. These requirements seem incompatible.</p>
<p>Consider a user registration system. The production code looks straightforward:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_service.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserService</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_path</span> <span class="o">=</span> <span class="n">db_path</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">register_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;INSERT INTO users (username, email) VALUES (?, ?)&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">user_id</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;SELECT id, username, email FROM users WHERE id = ?&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">user_id</span><span class="p">,)</span>
        <span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>

<p>But how do you test this? If you point it at a real database, each test run leaves data behind. Tests interfere with each other. You can't run tests in parallel. The database might not even exist in your CI environment.</p>
<p>Let's start with the naive approach and watch it fail.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_user_service_naive.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserService</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_register_user</span><span class="p">():</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="s2">&quot;production.db&quot;</span><span class="p">)</span>  <span class="c1"># Using real database!</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">user_id</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_user</span><span class="p">():</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="s2">&quot;production.db&quot;</span><span class="p">)</span>

    <span class="c1"># Assumes alice exists from previous test</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;alice&quot;</span>
    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;alice@example.com&quot;</span>
</code></pre></div>

<p>Run this twice:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_user_service_naive.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>First run output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_user_service_naive.py::test_register_user PASSED
test_user_service_naive.py::test_get_user PASSED
</code></pre></div>

<p><strong>Second run output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_user_service_naive.py::test_register_user FAILED
test_user_service_naive.py::test_get_user PASSED

================================ FAILURES =================================
_________________________ test_register_user __________________________

    def test_register_user():
        service = UserService(&quot;production.db&quot;)

        user_id = service.register_user(&quot;alice&quot;, &quot;alice@example.com&quot;)
&gt;       assert user_id is not None
E       sqlite3.IntegrityError: UNIQUE constraint failed: users.username

test_user_service_naive.py:8: IntegrityError
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-failure">Diagnostic Analysis: Reading the Failure</h3>
<p><strong>The complete output</strong>:</p>
<p>The test passed the first time but failed the second time with <code>sqlite3.IntegrityError: UNIQUE constraint failed: users.username</code>.</p>
<p><strong>Let's parse this section by section</strong>:</p>
<ol>
<li><strong>The error type</strong>: <code>sqlite3.IntegrityError</code></li>
<li>What this tells us: The database rejected our operation due to a constraint violation</li>
<li>
<p>This is a database-level error, not a Python assertion failure</p>
</li>
<li>
<p><strong>The constraint violation</strong>: <code>UNIQUE constraint failed: users.username</code></p>
</li>
<li>What this tells us: We tried to insert a username that already exists</li>
<li>The database has a UNIQUE constraint on the username column</li>
<li>
<p>Our first test run left "alice" in the database</p>
</li>
<li>
<p><strong>The test interdependency</strong>:</p>
</li>
<li><code>test_get_user</code> assumes user ID 1 exists (from the previous test)</li>
<li>If we run tests in a different order, <code>test_get_user</code> will fail</li>
<li>Tests are not isolated‚Äîthey share state through the database</li>
</ol>
<p><strong>Root cause identified</strong>: Tests are writing to a persistent database, creating state that survives between test runs.</p>
<p><strong>Why the current approach can't solve this</strong>: We need each test to start with a clean database state, but we're using a shared, persistent database file.</p>
<p><strong>What we need</strong>: A strategy to give each test its own isolated database that gets cleaned up automatically.</p>
<h2 id="strategy-1-in-memory-sqlite-database">Strategy 1: In-Memory SQLite Database</h2>
<p>The simplest solution for SQLite: use an in-memory database that exists only for the duration of the test.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_user_service_memory.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserService</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_register_user_isolated</span><span class="p">():</span>
    <span class="c1"># Use in-memory database</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>

    <span class="c1"># Create schema</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE users (</span>
<span class="s2">            id INTEGER PRIMARY KEY,</span>
<span class="s2">            username TEXT UNIQUE NOT NULL,</span>
<span class="s2">            email TEXT NOT NULL</span>
<span class="s2">        )</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">user_id</span> <span class="o">&gt;</span> <span class="mi">0</span>
</code></pre></div>

<p>Run this multiple times:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_user_service_memory.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_user_service_memory.py::test_register_user_isolated FAILED

================================ FAILURES =================================
__________________ test_register_user_isolated ________________________

    def test_register_user_isolated():
        service = UserService(&quot;:memory:&quot;)

        conn = sqlite3.connect(&quot;:memory:&quot;)
&gt;       conn.execute(&quot;&quot;&quot;
            CREATE TABLE users (
                id INTEGER PRIMARY KEY,
                username TEXT UNIQUE NOT NULL,
                email TEXT NOT NULL
            )
        &quot;&quot;&quot;)
E       sqlite3.OperationalError: no such table: users

test_user_service_memory.py:15: OperationalError
</code></pre></div>

<h3 id="diagnostic-analysis-the-in-memory-database-problem">Diagnostic Analysis: The In-Memory Database Problem</h3>
<p><strong>The complete output</strong>:</p>
<p>The test fails with <code>sqlite3.OperationalError: no such table: users</code> even though we just created the table.</p>
<p><strong>Let's parse this section by section</strong>:</p>
<ol>
<li><strong>The error location</strong>: The error occurs in <code>register_user()</code>, not in our schema creation code</li>
<li>
<p>What this tells us: The schema creation succeeded, but the service can't see the table</p>
</li>
<li>
<p><strong>The in-memory database behavior</strong>: Each call to <code>sqlite3.connect(":memory:")</code> creates a <strong>new, separate</strong> in-memory database</p>
</li>
<li>What this tells us: Our schema creation and our service are using different databases</li>
<li>Line 6: <code>service = UserService(":memory:")</code> creates database #1</li>
<li>Line 9: <code>conn = sqlite3.connect(":memory:")</code> creates database #2</li>
<li>We created the schema in database #2, but the service writes to database #1</li>
</ol>
<p><strong>Root cause identified</strong>: In-memory databases are not shared across connections. Each <code>:memory:</code> connection is isolated.</p>
<p><strong>Why the current approach can't solve this</strong>: We need to share the same in-memory database between our setup code and the service.</p>
<p><strong>What we need</strong>: A way to create one in-memory database and pass the same connection to both our setup and our service.</p>
<h2 id="strategy-2-shared-in-memory-database-with-connection-passing">Strategy 2: Shared In-Memory Database with Connection Passing</h2>
<p>SQLite allows sharing in-memory databases using a named URI:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_user_service_shared.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserService</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_register_user_shared_memory</span><span class="p">():</span>
    <span class="c1"># Use named in-memory database (shareable)</span>
    <span class="n">db_uri</span> <span class="o">=</span> <span class="s2">&quot;file::memory:?cache=shared&quot;</span>

    <span class="c1"># Create schema</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_uri</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE users (</span>
<span class="s2">            id INTEGER PRIMARY KEY,</span>
<span class="s2">            username TEXT UNIQUE NOT NULL,</span>
<span class="s2">            email TEXT NOT NULL</span>
<span class="s2">        )</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Now service can use the same database</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db_uri</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">user_id</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="c1"># Verify it was actually stored</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;alice&quot;</span>
    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;alice@example.com&quot;</span>
</code></pre></div>

<p>But wait‚Äîour <code>UserService</code> uses <code>sqlite3.connect(self.db_path)</code> without the <code>uri=True</code> parameter. Let's fix that:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_service.py (updated)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserService</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_path</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_path</span> <span class="o">=</span> <span class="n">db_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">register_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">()</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;INSERT INTO users (username, email) VALUES (?, ?)&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">user_id</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">()</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;SELECT id, username, email FROM users WHERE id = ?&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">user_id</span><span class="p">,)</span>
        <span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>

<p>Now update the test:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_user_service_shared.py (updated)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserService</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_register_user_shared_memory</span><span class="p">():</span>
    <span class="n">db_uri</span> <span class="o">=</span> <span class="s2">&quot;file::memory:?cache=shared&quot;</span>

    <span class="c1"># Create schema</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_uri</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE users (</span>
<span class="s2">            id INTEGER PRIMARY KEY,</span>
<span class="s2">            username TEXT UNIQUE NOT NULL,</span>
<span class="s2">            email TEXT NOT NULL</span>
<span class="s2">        )</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Pass uri=True to service</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db_uri</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">user_id</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;alice&quot;</span>
    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;alice@example.com&quot;</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_user_service_shared.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_user_service_shared.py::test_register_user_shared_memory PASSED
</code></pre></div>

<p>Success! But notice the duplication: every test needs to create the schema. This is where fixtures become essential.</p>
<h2 id="strategy-3-database-fixture-pattern">Strategy 3: Database Fixture Pattern</h2>
<p>The professional approach: use fixtures to manage database lifecycle.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_user_service_fixture.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserService</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_connection</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a clean in-memory database with schema.&quot;&quot;&quot;</span>
    <span class="n">db_uri</span> <span class="o">=</span> <span class="s2">&quot;file::memory:?cache=shared&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_uri</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Create schema</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE users (</span>
<span class="s2">            id INTEGER PRIMARY KEY,</span>
<span class="s2">            username TEXT UNIQUE NOT NULL,</span>
<span class="s2">            email TEXT NOT NULL</span>
<span class="s2">        )</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">yield</span> <span class="n">conn</span>

    <span class="c1"># Cleanup</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user_service</span><span class="p">(</span><span class="n">db_connection</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a UserService connected to the test database.&quot;&quot;&quot;</span>
    <span class="c1"># Extract the database URI from the connection</span>
    <span class="n">db_uri</span> <span class="o">=</span> <span class="s2">&quot;file::memory:?cache=shared&quot;</span>
    <span class="k">return</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db_uri</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_register_user</span><span class="p">(</span><span class="n">user_service</span><span class="p">):</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">user_id</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_user</span><span class="p">(</span><span class="n">user_service</span><span class="p">):</span>
    <span class="c1"># Each test gets a fresh database</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;bob&quot;</span><span class="p">,</span> <span class="s2">&quot;bob@example.com&quot;</span><span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bob&quot;</span>
    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bob@example.com&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_user_not_found</span><span class="p">(</span><span class="n">user_service</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">999</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_user_service_fixture.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_user_service_fixture.py::test_register_user PASSED
test_user_service_fixture.py::test_get_user PASSED
test_user_service_fixture.py::test_user_not_found PASSED
</code></pre></div>

<p>Each test gets a clean database. But there's still a problem: tests can interfere with each other if they run in the same process. Let's verify:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_user_service_interference.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserService</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_connection</span><span class="p">():</span>
    <span class="n">db_uri</span> <span class="o">=</span> <span class="s2">&quot;file::memory:?cache=shared&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_uri</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS users (</span>
<span class="s2">            id INTEGER PRIMARY KEY,</span>
<span class="s2">            username TEXT UNIQUE NOT NULL,</span>
<span class="s2">            email TEXT NOT NULL</span>
<span class="s2">        )</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">yield</span> <span class="n">conn</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user_service</span><span class="p">(</span><span class="n">db_connection</span><span class="p">):</span>
    <span class="n">db_uri</span> <span class="o">=</span> <span class="s2">&quot;file::memory:?cache=shared&quot;</span>
    <span class="k">return</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db_uri</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_first_user</span><span class="p">(</span><span class="n">user_service</span><span class="p">):</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user_id</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_second_user</span><span class="p">(</span><span class="n">user_service</span><span class="p">):</span>
    <span class="c1"># This test expects to be first, but alice might already exist</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user_id</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_user_service_interference.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_user_service_interference.py::test_first_user PASSED
test_user_service_interference.py::test_second_user FAILED

================================ FAILURES =================================
________________________ test_second_user _____________________________

    def test_second_user(user_service):
&gt;       user_id = user_service.register_user(&quot;alice&quot;, &quot;alice@example.com&quot;)
E       sqlite3.IntegrityError: UNIQUE constraint failed: users.username

test_user_service_interference.py:32: IntegrityError
</code></pre></div>

<h3 id="diagnostic-analysis-fixture-scope-problem">Diagnostic Analysis: Fixture Scope Problem</h3>
<p><strong>The complete output</strong>:</p>
<p>The second test fails with the same <code>UNIQUE constraint failed</code> error we saw at the beginning.</p>
<p><strong>Let's parse this section by section</strong>:</p>
<ol>
<li><strong>The fixture behavior</strong>: Our <code>db_connection</code> fixture creates the database once and reuses it</li>
<li>What this tells us: The default fixture scope is <code>function</code>, but the in-memory database persists across function calls</li>
<li>
<p>The <code>CREATE TABLE IF NOT EXISTS</code> prevents errors, but doesn't clear data</p>
</li>
<li>
<p><strong>The data persistence</strong>: Alice from <code>test_first_user</code> still exists when <code>test_second_user</code> runs</p>
</li>
<li>What this tells us: We're not cleaning up data between tests</li>
<li>The fixture's <code>yield</code> and cleanup only close the connection, they don't clear the database</li>
</ol>
<p><strong>Root cause identified</strong>: We need to clear the database between tests, not just close the connection.</p>
<p><strong>Why the current approach can't solve this</strong>: Closing and reopening the connection doesn't clear an in-memory database.</p>
<p><strong>What we need</strong>: Either (1) create a new database for each test, or (2) explicitly clear data between tests.</p>
<h2 id="strategy-4-transaction-rollback-pattern">Strategy 4: Transaction Rollback Pattern</h2>
<p>The most elegant solution: wrap each test in a transaction and roll it back.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_user_service_transaction.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserService</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_schema</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create schema once for all tests.&quot;&quot;&quot;</span>
    <span class="n">db_uri</span> <span class="o">=</span> <span class="s2">&quot;file:test_db?mode=memory&amp;cache=shared&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_uri</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE users (</span>
<span class="s2">            id INTEGER PRIMARY KEY,</span>
<span class="s2">            username TEXT UNIQUE NOT NULL,</span>
<span class="s2">            email TEXT NOT NULL</span>
<span class="s2">        )</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">db_uri</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_connection</span><span class="p">(</span><span class="n">db_schema</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a connection with automatic rollback.&quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_schema</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;BEGIN&quot;</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">conn</span>

    <span class="c1"># Rollback any changes made during the test</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user_service</span><span class="p">(</span><span class="n">db_connection</span><span class="p">,</span> <span class="n">db_schema</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a UserService that uses the transactional connection.&quot;&quot;&quot;</span>
    <span class="c1"># This is tricky: UserService creates its own connections</span>
    <span class="c1"># We need to modify our approach</span>
    <span class="k">return</span> <span class="n">UserService</span><span class="p">(</span><span class="n">db_schema</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_first_user</span><span class="p">(</span><span class="n">user_service</span><span class="p">,</span> <span class="n">db_connection</span><span class="p">):</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user_id</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_second_user</span><span class="p">(</span><span class="n">user_service</span><span class="p">,</span> <span class="n">db_connection</span><span class="p">):</span>
    <span class="c1"># Should work because previous test was rolled back</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user_id</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_user_service_transaction.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_user_service_transaction.py::test_first_user PASSED
test_user_service_transaction.py::test_second_user FAILED

================================ FAILURES =================================
________________________ test_second_user _____________________________

    def test_second_user(user_service, db_connection):
&gt;       user_id = user_service.register_user(&quot;alice&quot;, &quot;alice@example.com&quot;)
E       sqlite3.IntegrityError: UNIQUE constraint failed: users.username

test_user_service_transaction.py:42: IntegrityError
</code></pre></div>

<h3 id="diagnostic-analysis-connection-isolation-problem">Diagnostic Analysis: Connection Isolation Problem</h3>
<p><strong>The complete output</strong>:</p>
<p>Still failing with the same constraint violation.</p>
<p><strong>Let's parse this section by section</strong>:</p>
<ol>
<li><strong>The transaction scope</strong>: We created a transaction on <code>db_connection</code>, but <code>UserService</code> creates its own connections</li>
<li>What this tells us: The rollback on our fixture's connection doesn't affect the service's connections</li>
<li>
<p>Each <code>sqlite3.connect()</code> call gets its own transaction context</p>
</li>
<li>
<p><strong>The architectural mismatch</strong>: Our service is designed to manage its own connections</p>
</li>
<li>What this tells us: The transaction rollback pattern requires the service to use our provided connection</li>
<li>We can't inject our transactional connection into the service as currently designed</li>
</ol>
<p><strong>Root cause identified</strong>: The service creates its own connections, so our fixture's transaction rollback has no effect.</p>
<p><strong>Why the current approach can't solve this</strong>: We need to either (1) redesign the service to accept connections, or (2) use a different isolation strategy.</p>
<p><strong>What we need</strong>: A service design that accepts database connections as dependencies.</p>
<h2 id="strategy-5-connection-injection-pattern">Strategy 5: Connection Injection Pattern</h2>
<p>Redesign the service to accept connections:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_service_injectable.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserService</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize with either a database path or an existing connection.</span>

<span class="sd">        Args:</span>
<span class="sd">            db_path: Path to database file</span>
<span class="sd">            uri: Whether db_path is a URI</span>
<span class="sd">            connection: Existing connection to use (overrides db_path)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_path</span> <span class="o">=</span> <span class="n">db_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_external_connection</span> <span class="o">=</span> <span class="n">connection</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_connection</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_connection</span>
        <span class="k">return</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_should_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Only close connections we created.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_connection</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">register_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">()</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;INSERT INTO users (username, email) VALUES (?, ?)&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_close</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">user_id</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">()</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;SELECT id, username, email FROM users WHERE id = ?&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">user_id</span><span class="p">,)</span>
        <span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_close</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>

<p>Now the transaction rollback pattern works:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_user_service_injectable.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_service_injectable</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserService</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_schema</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create schema once for all tests.&quot;&quot;&quot;</span>
    <span class="n">db_uri</span> <span class="o">=</span> <span class="s2">&quot;file:test_db?mode=memory&amp;cache=shared&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_uri</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE users (</span>
<span class="s2">            id INTEGER PRIMARY KEY,</span>
<span class="s2">            username TEXT UNIQUE NOT NULL,</span>
<span class="s2">            email TEXT NOT NULL</span>
<span class="s2">        )</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">db_uri</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_connection</span><span class="p">(</span><span class="n">db_schema</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a connection with automatic rollback.&quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_schema</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Disable autocommit to enable rollback</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">isolation_level</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;BEGIN&quot;</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">conn</span>

    <span class="c1"># Rollback any changes made during the test</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user_service</span><span class="p">(</span><span class="n">db_connection</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a UserService using the transactional connection.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">UserService</span><span class="p">(</span><span class="n">connection</span><span class="o">=</span><span class="n">db_connection</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_first_user</span><span class="p">(</span><span class="n">user_service</span><span class="p">):</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user_id</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_second_user</span><span class="p">(</span><span class="n">user_service</span><span class="p">):</span>
    <span class="c1"># Works because previous test was rolled back</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user_id</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_user</span><span class="p">(</span><span class="n">user_service</span><span class="p">):</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;bob&quot;</span><span class="p">,</span> <span class="s2">&quot;bob@example.com&quot;</span><span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bob&quot;</span>
    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bob@example.com&quot;</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_user_service_injectable.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_user_service_injectable.py::test_first_user PASSED
test_user_service_injectable.py::test_second_user PASSED
test_user_service_injectable.py::test_get_user PASSED
</code></pre></div>

<p>Perfect isolation! Each test gets a clean database state through transaction rollback.</p>
<h2 id="decision-framework-which-database-testing-strategy">Decision Framework: Which Database Testing Strategy?</h2>
<table>
<thead>
<tr>
<th>Strategy</th>
<th>Setup Complexity</th>
<th>Isolation</th>
<th>Speed</th>
<th>Best For</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>In-Memory SQLite</strong></td>
<td>Low</td>
<td>Perfect</td>
<td>Fastest</td>
<td>Unit tests, SQLite-based apps</td>
</tr>
<tr>
<td><strong>Transaction Rollback</strong></td>
<td>Medium</td>
<td>Perfect</td>
<td>Fast</td>
<td>Any SQL database, requires connection injection</td>
</tr>
<tr>
<td><strong>Temporary Database Files</strong></td>
<td>Low</td>
<td>Perfect</td>
<td>Medium</td>
<td>Testing migrations, file-based operations</td>
</tr>
<tr>
<td><strong>Docker Test Containers</strong></td>
<td>High</td>
<td>Perfect</td>
<td>Slow</td>
<td>Integration tests, production-like environment</td>
</tr>
<tr>
<td><strong>Mocking Database Calls</strong></td>
<td>Medium</td>
<td>N/A</td>
<td>Fastest</td>
<td>Testing business logic without database</td>
</tr>
</tbody>
</table>
<h3 id="when-to-apply-each-solution">When to Apply Each Solution</h3>
<p><strong>In-Memory SQLite</strong>:
- ‚úÖ Your application uses SQLite
- ‚úÖ Tests don't need to persist data between runs
- ‚úÖ You want maximum speed
- ‚ùå Your production database is PostgreSQL/MySQL (behavior differences)</p>
<p><strong>Transaction Rollback</strong>:
- ‚úÖ You need perfect isolation between tests
- ‚úÖ Your service can accept connection injection
- ‚úÖ You want to test actual database interactions
- ‚ùå Your code has complex transaction management</p>
<p><strong>Temporary Database Files</strong>:
- ‚úÖ You need to test database file operations
- ‚úÖ You need to test migrations
- ‚úÖ You want simple setup without connection management
- ‚ùå You need maximum speed (file I/O is slower)</p>
<p><strong>Docker Test Containers</strong>:
- ‚úÖ You need production-like database behavior
- ‚úÖ You're testing database-specific features
- ‚úÖ Integration tests are more important than speed
- ‚ùå You need fast feedback loops</p>
<h2 id="common-failure-modes-and-their-signatures">Common Failure Modes and Their Signatures</h2>
<h3 id="symptom-tests-pass-individually-but-fail-when-run-together">Symptom: Tests pass individually but fail when run together</h3>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>$ pytest test_file.py::test_first -v  # PASSES
$ pytest test_file.py::test_second -v  # PASSES
$ pytest test_file.py -v  # test_second FAILS with IntegrityError
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Tests share database state
- No cleanup between tests
- Constraint violations on second run</p>
<p><strong>Root cause</strong>: Missing transaction rollback or database cleanup</p>
<p><strong>Solution</strong>: Implement transaction rollback pattern or use function-scoped database fixtures</p>
<h3 id="symptom-tests-fail-with-database-is-locked">Symptom: Tests fail with "database is locked"</h3>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>sqlite3.OperationalError: database is locked
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Multiple connections to the same SQLite database
- Connections not being closed properly
- Concurrent writes without proper transaction management</p>
<p><strong>Root cause</strong>: SQLite doesn't handle concurrent writes well</p>
<p><strong>Solution</strong>: Use in-memory databases for tests, or ensure proper connection cleanup</p>
<h3 id="symptom-schema-changes-dont-appear-in-tests">Symptom: Schema changes don't appear in tests</h3>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>sqlite3.OperationalError: no such column: new_column
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Schema created in one connection
- Service using a different connection
- In-memory database not shared</p>
<p><strong>Root cause</strong>: Multiple in-memory databases created</p>
<p><strong>Solution</strong>: Use named in-memory databases with <code>cache=shared</code></p>
<h2 id="using-fixtures-for-database-setup">Using Fixtures for Database Setup</h2>
<h2 id="from-ad-hoc-setup-to-fixture-architecture">From Ad-Hoc Setup to Fixture Architecture</h2>
<p>In the previous section, we saw how transaction rollback provides perfect test isolation. But we also saw the complexity: session-scoped schema creation, function-scoped connections, service injection. Let's build a complete fixture architecture that handles all of this systematically.</p>
<p>Our reference implementation from 12.1 works, but it's scattered across multiple fixtures. Let's consolidate and extend it to handle real-world scenarios.</p>
<h2 id="iteration-1-basic-fixture-hierarchy">Iteration 1: Basic Fixture Hierarchy</h2>
<p>Start with the simplest fixture structure:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a clean database for each test.&quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>

    <span class="c1"># Create schema</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE users (</span>
<span class="s2">            id INTEGER PRIMARY KEY,</span>
<span class="s2">            username TEXT UNIQUE NOT NULL,</span>
<span class="s2">            email TEXT NOT NULL</span>
<span class="s2">        )</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">yield</span> <span class="n">conn</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_basic_fixture.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_service_injectable</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserService</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_register_user</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">connection</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user_id</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_multiple_users</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">connection</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>

    <span class="n">alice_id</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="n">bob_id</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;bob&quot;</span><span class="p">,</span> <span class="s2">&quot;bob@example.com&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">alice_id</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">bob_id</span> <span class="o">==</span> <span class="mi">2</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_basic_fixture.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_basic_fixture.py::test_register_user PASSED
test_basic_fixture.py::test_multiple_users PASSED
</code></pre></div>

<p>This works, but every test needs to create its own <code>UserService</code>. Let's add a service fixture.</p>
<h2 id="iteration-2-service-fixture">Iteration 2: Service Fixture</h2>
<p>Add a fixture that provides the service:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (updated)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_service_injectable</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserService</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a clean database for each test.&quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE users (</span>
<span class="s2">            id INTEGER PRIMARY KEY,</span>
<span class="s2">            username TEXT UNIQUE NOT NULL,</span>
<span class="s2">            email TEXT NOT NULL</span>
<span class="s2">        )</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">yield</span> <span class="n">conn</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user_service</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a UserService connected to the test database.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">UserService</span><span class="p">(</span><span class="n">connection</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_service_fixture.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_register_user</span><span class="p">(</span><span class="n">user_service</span><span class="p">):</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user_id</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_user</span><span class="p">(</span><span class="n">user_service</span><span class="p">):</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;bob&quot;</span><span class="p">,</span> <span class="s2">&quot;bob@example.com&quot;</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bob&quot;</span>
    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bob@example.com&quot;</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_service_fixture.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_service_fixture.py::test_register_user PASSED
test_service_fixture.py::test_get_user PASSED
</code></pre></div>

<p>Much cleaner! But what if we need to test with existing data? Let's add that capability.</p>
<h2 id="iteration-3-seed-data-fixtures">Iteration 3: Seed Data Fixtures</h2>
<p>Add fixtures that provide pre-populated databases:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (updated)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_service_injectable</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserService</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a clean database for each test.&quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE users (</span>
<span class="s2">            id INTEGER PRIMARY KEY,</span>
<span class="s2">            username TEXT UNIQUE NOT NULL,</span>
<span class="s2">            email TEXT NOT NULL</span>
<span class="s2">        )</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">yield</span> <span class="n">conn</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_with_users</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a database with sample users.&quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;INSERT INTO users (username, email) VALUES (?, ?)&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;INSERT INTO users (username, email) VALUES (?, ?)&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">&quot;bob&quot;</span><span class="p">,</span> <span class="s2">&quot;bob@example.com&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">db</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user_service</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a UserService connected to the test database.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">UserService</span><span class="p">(</span><span class="n">connection</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user_service_with_data</span><span class="p">(</span><span class="n">db_with_users</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a UserService with pre-populated data.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">UserService</span><span class="p">(</span><span class="n">connection</span><span class="o">=</span><span class="n">db_with_users</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_seed_data.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_get_existing_user</span><span class="p">(</span><span class="n">user_service_with_data</span><span class="p">):</span>
    <span class="c1"># Alice was created by the fixture</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">user_service_with_data</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;alice&quot;</span>
    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;alice@example.com&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_add_to_existing_users</span><span class="p">(</span><span class="n">user_service_with_data</span><span class="p">):</span>
    <span class="c1"># Alice and Bob exist, add Charlie</span>
    <span class="n">charlie_id</span> <span class="o">=</span> <span class="n">user_service_with_data</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span>
        <span class="s2">&quot;charlie&quot;</span><span class="p">,</span> <span class="s2">&quot;charlie@example.com&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">charlie_id</span> <span class="o">==</span> <span class="mi">3</span>  <span class="c1"># After alice (1) and bob (2)</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_seed_data.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_seed_data.py::test_get_existing_user PASSED
test_seed_data.py::test_add_to_existing_users PASSED
</code></pre></div>

<p>Great! But this approach has a limitation: what if different tests need different seed data? Creating a fixture for every combination becomes unwieldy.</p>
<h2 id="iteration-4-parameterized-seed-data">Iteration 4: Parameterized Seed Data</h2>
<p>Use fixture parameters to provide flexible seed data:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (updated)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_service_injectable</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserService</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a clean database for each test.&quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE users (</span>
<span class="s2">            id INTEGER PRIMARY KEY,</span>
<span class="s2">            username TEXT UNIQUE NOT NULL,</span>
<span class="s2">            email TEXT NOT NULL</span>
<span class="s2">        )</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">yield</span> <span class="n">conn</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">seed_users</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Seed the database with users.</span>

<span class="sd">    Usage:</span>
<span class="sd">        @pytest.mark.seed_users([</span>
<span class="sd">            (&quot;alice&quot;, &quot;alice@example.com&quot;),</span>
<span class="sd">            (&quot;bob&quot;, &quot;bob@example.com&quot;)</span>
<span class="sd">        ])</span>
<span class="sd">        def test_something(seed_users):</span>
<span class="sd">            ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_closest_marker</span><span class="p">(</span><span class="s2">&quot;seed_users&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">users</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">username</span><span class="p">,</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">users</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s2">&quot;INSERT INTO users (username, email) VALUES (?, ?)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">db</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user_service</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a UserService connected to the test database.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">UserService</span><span class="p">(</span><span class="n">connection</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_parameterized_seed.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">seed_users</span><span class="p">([</span>
    <span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;bob&quot;</span><span class="p">,</span> <span class="s2">&quot;bob@example.com&quot;</span><span class="p">)</span>
<span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_with_two_users</span><span class="p">(</span><span class="n">seed_users</span><span class="p">,</span> <span class="n">user_service</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;alice&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bob&quot;</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">seed_users</span><span class="p">([</span>
    <span class="p">(</span><span class="s2">&quot;charlie&quot;</span><span class="p">,</span> <span class="s2">&quot;charlie@example.com&quot;</span><span class="p">)</span>
<span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_with_one_user</span><span class="p">(</span><span class="n">seed_users</span><span class="p">,</span> <span class="n">user_service</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;charlie&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_with_no_users</span><span class="p">(</span><span class="n">seed_users</span><span class="p">,</span> <span class="n">user_service</span><span class="p">):</span>
    <span class="c1"># No marker, so no seed data</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_parameterized_seed.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_parameterized_seed.py::test_with_two_users PASSED
test_parameterized_seed.py::test_with_one_user PASSED
test_parameterized_seed.py::test_with_no_users PASSED
</code></pre></div>

<p>Excellent flexibility! But we're still creating a new database for every test. For large test suites, this can be slow. Let's optimize with session-scoped fixtures.</p>
<h2 id="iteration-5-session-scoped-schema-with-transaction-rollback">Iteration 5: Session-Scoped Schema with Transaction Rollback</h2>
<p>Combine session-scoped schema creation with function-scoped transaction rollback:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (updated)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_service_injectable</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserService</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_schema</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create database schema once for all tests.&quot;&quot;&quot;</span>
    <span class="n">db_uri</span> <span class="o">=</span> <span class="s2">&quot;file:test_db?mode=memory&amp;cache=shared&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_uri</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE users (</span>
<span class="s2">            id INTEGER PRIMARY KEY,</span>
<span class="s2">            username TEXT UNIQUE NOT NULL,</span>
<span class="s2">            email TEXT NOT NULL</span>
<span class="s2">        )</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">db_uri</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">(</span><span class="n">db_schema</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a transactional connection that auto-rolls back.&quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_schema</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">isolation_level</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Disable autocommit</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;BEGIN&quot;</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">conn</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">seed_users</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Seed the database with users.&quot;&quot;&quot;</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_closest_marker</span><span class="p">(</span><span class="s2">&quot;seed_users&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">users</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">username</span><span class="p">,</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">users</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s2">&quot;INSERT INTO users (username, email) VALUES (?, ?)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">db</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user_service</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a UserService connected to the test database.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">UserService</span><span class="p">(</span><span class="n">connection</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
</code></pre></div>

<p>Now let's verify that transaction rollback actually works:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_transaction_rollback.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_first_insert</span><span class="p">(</span><span class="n">user_service</span><span class="p">):</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user_id</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_second_insert</span><span class="p">(</span><span class="n">user_service</span><span class="p">):</span>
    <span class="c1"># Should also get ID 1 because previous test was rolled back</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user_id</span> <span class="o">==</span> <span class="mi">1</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">seed_users</span><span class="p">([</span>
    <span class="p">(</span><span class="s2">&quot;bob&quot;</span><span class="p">,</span> <span class="s2">&quot;bob@example.com&quot;</span><span class="p">)</span>
<span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_with_seed_data</span><span class="p">(</span><span class="n">seed_users</span><span class="p">,</span> <span class="n">user_service</span><span class="p">):</span>
    <span class="c1"># Bob gets ID 1</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bob&quot;</span>

    <span class="c1"># Alice gets ID 2</span>
    <span class="n">alice_id</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">alice_id</span> <span class="o">==</span> <span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_after_seed_data</span><span class="p">(</span><span class="n">user_service</span><span class="p">):</span>
    <span class="c1"># Previous test&#39;s data was rolled back</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="s2">&quot;charlie&quot;</span><span class="p">,</span> <span class="s2">&quot;charlie@example.com&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user_id</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_transaction_rollback.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_transaction_rollback.py::test_first_insert PASSED
test_transaction_rollback.py::test_second_insert PASSED
test_transaction_rollback.py::test_with_seed_data PASSED
test_transaction_rollback.py::test_after_seed_data PASSED
</code></pre></div>

<p>Perfect! Each test gets a clean slate through transaction rollback, but we only create the schema once.</p>
<h2 id="iteration-6-multiple-tables-and-foreign-keys">Iteration 6: Multiple Tables and Foreign Keys</h2>
<p>Real applications have multiple related tables. Let's extend our schema:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (updated with posts table)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_service_injectable</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserService</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_schema</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create database schema once for all tests.&quot;&quot;&quot;</span>
    <span class="n">db_uri</span> <span class="o">=</span> <span class="s2">&quot;file:test_db?mode=memory&amp;cache=shared&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_uri</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Enable foreign keys</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys = ON&quot;</span><span class="p">)</span>

    <span class="c1"># Users table</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE users (</span>
<span class="s2">            id INTEGER PRIMARY KEY,</span>
<span class="s2">            username TEXT UNIQUE NOT NULL,</span>
<span class="s2">            email TEXT NOT NULL</span>
<span class="s2">        )</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># Posts table with foreign key to users</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE posts (</span>
<span class="s2">            id INTEGER PRIMARY KEY,</span>
<span class="s2">            user_id INTEGER NOT NULL,</span>
<span class="s2">            title TEXT NOT NULL,</span>
<span class="s2">            content TEXT NOT NULL,</span>
<span class="s2">            FOREIGN KEY (user_id) REFERENCES users(id)</span>
<span class="s2">        )</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">db_uri</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">(</span><span class="n">db_schema</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a transactional connection that auto-rolls back.&quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_schema</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys = ON&quot;</span><span class="p">)</span>  <span class="c1"># Enable for this connection</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">isolation_level</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;BEGIN&quot;</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">conn</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">seed_users</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Seed the database with users.&quot;&quot;&quot;</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_closest_marker</span><span class="p">(</span><span class="s2">&quot;seed_users&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">users</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">username</span><span class="p">,</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">users</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s2">&quot;INSERT INTO users (username, email) VALUES (?, ?)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">db</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user_service</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a UserService connected to the test database.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">UserService</span><span class="p">(</span><span class="n">connection</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
</code></pre></div>

<p>Now add a PostService:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># post_service.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PostService</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">connection</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;INSERT INTO posts (user_id, title, content) VALUES (?, ?, ?)&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user_posts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;SELECT id, title, content FROM posts WHERE user_id = ?&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">user_id</span><span class="p">,)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="p">]</span>
</code></pre></div>

<p>Add a fixture for PostService:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (add this fixture)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">post_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">PostService</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">post_service</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a PostService connected to the test database.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PostService</span><span class="p">(</span><span class="n">connection</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
</code></pre></div>

<p>Test the relationship:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_foreign_keys.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">seed_users</span><span class="p">([</span>
    <span class="p">(</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>
<span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_create_post_for_user</span><span class="p">(</span><span class="n">seed_users</span><span class="p">,</span> <span class="n">user_service</span><span class="p">,</span> <span class="n">post_service</span><span class="p">):</span>
    <span class="c1"># Alice exists from seed data</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">user_service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;alice&quot;</span>

    <span class="c1"># Create a post for Alice</span>
    <span class="n">post_id</span> <span class="o">=</span> <span class="n">post_service</span><span class="o">.</span><span class="n">create_post</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;My First Post&quot;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="s2">&quot;Hello, world!&quot;</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">post_id</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="c1"># Verify the post</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="n">post_service</span><span class="o">.</span><span class="n">get_user_posts</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">posts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">posts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;My First Post&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_foreign_key_constraint</span><span class="p">(</span><span class="n">post_service</span><span class="p">):</span>
    <span class="c1"># Try to create a post for non-existent user</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="n">post_service</span><span class="o">.</span><span class="n">create_post</span><span class="p">(</span>
            <span class="n">user_id</span><span class="o">=</span><span class="mi">999</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Orphan Post&quot;</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="s2">&quot;This should fail&quot;</span>
        <span class="p">)</span>

    <span class="k">assert</span> <span class="s2">&quot;FOREIGN KEY constraint failed&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_foreign_keys.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_foreign_keys.py::test_create_post_for_user PASSED
test_foreign_keys.py::test_foreign_key_constraint PASSED
</code></pre></div>

<p>Excellent! Our fixture architecture now handles:
- Session-scoped schema creation
- Function-scoped transaction rollback
- Flexible seed data via markers
- Multiple related tables with foreign keys
- Multiple service fixtures sharing the same connection</p>
<h2 id="the-complete-fixture-architecture">The Complete Fixture Architecture</h2>
<p>Here's the final, production-ready fixture setup:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (complete version)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_service_injectable</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">post_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">PostService</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_schema</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create database schema once for all tests.</span>

<span class="sd">    Uses a named in-memory database that can be shared across connections.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db_uri</span> <span class="o">=</span> <span class="s2">&quot;file:test_db?mode=memory&amp;cache=shared&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_uri</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Enable foreign keys</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys = ON&quot;</span><span class="p">)</span>

    <span class="c1"># Create all tables</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE users (</span>
<span class="s2">            id INTEGER PRIMARY KEY,</span>
<span class="s2">            username TEXT UNIQUE NOT NULL,</span>
<span class="s2">            email TEXT NOT NULL</span>
<span class="s2">        )</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE posts (</span>
<span class="s2">            id INTEGER PRIMARY KEY,</span>
<span class="s2">            user_id INTEGER NOT NULL,</span>
<span class="s2">            title TEXT NOT NULL,</span>
<span class="s2">            content TEXT NOT NULL,</span>
<span class="s2">            FOREIGN KEY (user_id) REFERENCES users(id)</span>
<span class="s2">        )</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">db_uri</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">(</span><span class="n">db_schema</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provide a transactional connection that auto-rolls back.</span>

<span class="sd">    Each test gets a clean database state through transaction rollback.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_schema</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys = ON&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">isolation_level</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Disable autocommit</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;BEGIN&quot;</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">conn</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">seed_users</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Seed the database with users.</span>

<span class="sd">    Usage:</span>
<span class="sd">        @pytest.mark.seed_users([</span>
<span class="sd">            (&quot;alice&quot;, &quot;alice@example.com&quot;),</span>
<span class="sd">            (&quot;bob&quot;, &quot;bob@example.com&quot;)</span>
<span class="sd">        ])</span>
<span class="sd">        def test_something(seed_users, user_service):</span>
<span class="sd">            ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_closest_marker</span><span class="p">(</span><span class="s2">&quot;seed_users&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">users</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">username</span><span class="p">,</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">users</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s2">&quot;INSERT INTO users (username, email) VALUES (?, ?)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">db</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user_service</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a UserService connected to the test database.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">UserService</span><span class="p">(</span><span class="n">connection</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">post_service</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a PostService connected to the test database.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PostService</span><span class="p">(</span><span class="n">connection</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
</code></pre></div>

<h2 id="decision-framework-fixture-scope-selection">Decision Framework: Fixture Scope Selection</h2>
<table>
<thead>
<tr>
<th>Scope</th>
<th>Lifetime</th>
<th>Use Case</th>
<th>Trade-offs</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>function</strong></td>
<td>One test</td>
<td>Default, maximum isolation</td>
<td>Slowest, most setup overhead</td>
</tr>
<tr>
<td><strong>class</strong></td>
<td>All tests in a class</td>
<td>Related tests sharing setup</td>
<td>Medium speed, class coupling</td>
</tr>
<tr>
<td><strong>module</strong></td>
<td>All tests in a file</td>
<td>File-level shared resources</td>
<td>Faster, risk of interference</td>
</tr>
<tr>
<td><strong>session</strong></td>
<td>Entire test run</td>
<td>Expensive setup (schema, connections)</td>
<td>Fastest, requires careful cleanup</td>
</tr>
</tbody>
</table>
<h3 id="when-to-apply-each-scope">When to Apply Each Scope</h3>
<p><strong>Function scope</strong> (default):
- ‚úÖ Maximum test isolation
- ‚úÖ Each test gets fresh state
- ‚úÖ Safe default choice
- ‚ùå Slowest for expensive setup</p>
<p><strong>Session scope</strong>:
- ‚úÖ One-time expensive operations (schema creation)
- ‚úÖ Read-only shared resources
- ‚úÖ Maximum speed for large test suites
- ‚ùå Requires careful state management</p>
<p><strong>Transaction rollback pattern</strong>:
- ‚úÖ Combines session-scoped schema with function-scoped isolation
- ‚úÖ Best of both worlds: fast + isolated
- ‚úÖ Professional standard for database testing
- ‚ùå Requires connection injection support</p>
<h2 id="common-failure-modes-and-their-signatures_1">Common Failure Modes and Their Signatures</h2>
<h3 id="symptom-fixture-not-found">Symptom: Fixture not found</h3>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>E       fixture &#39;user_service&#39; not found
&gt;       available fixtures: cache, capfd, capfdbinary, ...
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Fixture defined in wrong file
- Fixture not in conftest.py or same file as test
- Typo in fixture name</p>
<p><strong>Root cause</strong>: Pytest can't find the fixture definition</p>
<p><strong>Solution</strong>: Move fixture to conftest.py or import it properly</p>
<h3 id="symptom-fixture-executed-multiple-times-unexpectedly">Symptom: Fixture executed multiple times unexpectedly</h3>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code># Debug output shows:
Creating database schema...
Creating database schema...
Creating database schema...
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Fixture scope is too narrow
- Expensive operation running for each test
- Performance degradation</p>
<p><strong>Root cause</strong>: Fixture scope doesn't match usage pattern</p>
<p><strong>Solution</strong>: Use session scope for expensive one-time setup</p>
<h3 id="symptom-tests-interfere-with-each-other">Symptom: Tests interfere with each other</h3>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_first PASSED
test_second FAILED  # Expects clean state but sees data from test_first
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Tests pass individually but fail together
- Order-dependent failures
- Data from previous tests visible</p>
<p><strong>Root cause</strong>: Missing transaction rollback or cleanup</p>
<p><strong>Solution</strong>: Implement transaction rollback pattern or add explicit cleanup</p>
<h2 id="testing-api-calls">Testing API Calls</h2>
<h2 id="the-challenge-of-testing-http-clients">The Challenge of Testing HTTP Clients</h2>
<p>Testing code that makes HTTP requests presents unique challenges: external services are unreliable, slow, and may have rate limits or costs. You can't depend on them for your test suite. Yet you need to verify that your code handles responses correctly.</p>
<p>Consider an API client for a weather service:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># weather_client.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="k">class</span><span class="w"> </span><span class="nc">WeatherClient</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://api.weather.com&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_weather</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">city</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current weather for a city.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/current&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="n">city</span><span class="p">,</span> <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_forecast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">city</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get weather forecast for a city.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/forecast&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="n">city</span><span class="p">,</span> <span class="s2">&quot;days&quot;</span><span class="p">:</span> <span class="n">days</span><span class="p">,</span> <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</code></pre></div>

<p>How do you test this without making real API calls? Let's start with the naive approach and watch it fail.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_weather_client_naive.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">weather_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">WeatherClient</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_current_weather</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">WeatherClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test_key&quot;</span><span class="p">)</span>

    <span class="n">weather</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_current_weather</span><span class="p">(</span><span class="s2">&quot;London&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">weather</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="s2">&quot;temperature&quot;</span> <span class="ow">in</span> <span class="n">weather</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_weather_client_naive.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_weather_client_naive.py::test_get_current_weather FAILED

================================ FAILURES =================================
__________________ test_get_current_weather ___________________________

    def test_get_current_weather():
        client = WeatherClient(api_key=&quot;test_key&quot;)

&gt;       weather = client.get_current_weather(&quot;London&quot;)

test_weather_client_naive.py:6: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
weather_client.py:12: in get_current_weather
    response.raise_for_status()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

&gt;   raise HTTPError(http_error_msg, response=self)
E   requests.exceptions.HTTPError: 401 Client Error: Unauthorized
</code></pre></div>

<h3 id="diagnostic-analysis-real-api-call-failure">Diagnostic Analysis: Real API Call Failure</h3>
<p><strong>The complete output</strong>:</p>
<p>The test fails with <code>requests.exceptions.HTTPError: 401 Client Error: Unauthorized</code>.</p>
<p><strong>Let's parse this section by section</strong>:</p>
<ol>
<li><strong>The error type</strong>: <code>requests.exceptions.HTTPError</code></li>
<li>What this tells us: The HTTP request completed, but the server rejected it</li>
<li>
<p>This is a real network call that reached the actual API</p>
</li>
<li>
<p><strong>The status code</strong>: <code>401 Client Error: Unauthorized</code></p>
</li>
<li>What this tells us: Our test API key is invalid</li>
<li>
<p>The real API rejected our authentication</p>
</li>
<li>
<p><strong>The test dependency</strong>: Our test depends on:</p>
</li>
<li>Network connectivity</li>
<li>The external API being available</li>
<li>A valid API key</li>
<li>The API's current behavior</li>
</ol>
<p><strong>Root cause identified</strong>: We're making real HTTP requests to an external service in our tests.</p>
<p><strong>Why the current approach can't solve this</strong>: We can't control external services, and we shouldn't depend on them for tests.</p>
<p><strong>What we need</strong>: A way to intercept HTTP requests and return controlled responses without hitting the real API.</p>
<h2 id="strategy-1-mocking-with-unittestmock">Strategy 1: Mocking with unittest.mock</h2>
<p>Use <code>unittest.mock</code> to replace the <code>requests.get</code> function:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_weather_client_mock.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">weather_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">WeatherClient</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_current_weather_mocked</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">WeatherClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test_key&quot;</span><span class="p">)</span>

    <span class="c1"># Create a mock response</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;Sunny&quot;</span><span class="p">,</span>
        <span class="s2">&quot;humidity&quot;</span><span class="p">:</span> <span class="mi">65</span>
    <span class="p">}</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Patch requests.get to return our mock</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;requests.get&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_response</span><span class="p">):</span>
        <span class="n">weather</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_current_weather</span><span class="p">(</span><span class="s2">&quot;London&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">weather</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">20</span>
    <span class="k">assert</span> <span class="n">weather</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Sunny&quot;</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_weather_client_mock.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_weather_client_mock.py::test_get_current_weather_mocked FAILED

================================ FAILURES =================================
______________ test_get_current_weather_mocked ________________________

    def test_get_current_weather_mocked():
        client = WeatherClient(api_key=&quot;test_key&quot;)

        mock_response = Mock()
        mock_response.json.return_value = {
            &quot;temperature&quot;: 20,
            &quot;condition&quot;: &quot;Sunny&quot;,
            &quot;humidity&quot;: 65
        }
        mock_response.raise_for_status.return_value = None

        with patch(&quot;requests.get&quot;, return_value=mock_response):
&gt;           weather = client.get_current_weather(&quot;London&quot;)

test_weather_client_mock.py:18: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

&gt;   raise HTTPError(http_error_msg, response=self)
E   requests.exceptions.HTTPError: 401 Client Error: Unauthorized
</code></pre></div>

<h3 id="diagnostic-analysis-patch-target-problem">Diagnostic Analysis: Patch Target Problem</h3>
<p><strong>The complete output</strong>:</p>
<p>Still getting the real HTTP error, even though we patched <code>requests.get</code>.</p>
<p><strong>Let's parse this section by section</strong>:</p>
<ol>
<li><strong>The patch location</strong>: We patched <code>requests.get</code> in the global namespace</li>
<li>What this tells us: The patch didn't intercept the call</li>
<li>
<p>The real <code>requests.get</code> is still being called</p>
</li>
<li>
<p><strong>The import mechanism</strong>: <code>weather_client.py</code> imports <code>requests</code> at the module level</p>
</li>
<li>What this tells us: When Python imports <code>weather_client</code>, it creates a reference to <code>requests.get</code></li>
<li>Our patch of the global <code>requests.get</code> doesn't affect the reference in <code>weather_client</code></li>
</ol>
<p><strong>Root cause identified</strong>: We patched the wrong location. We need to patch where the function is used, not where it's defined.</p>
<p><strong>Why the current approach can't solve this</strong>: Patching <code>requests.get</code> globally doesn't affect the already-imported reference in <code>weather_client</code>.</p>
<p><strong>What we need</strong>: Patch <code>requests.get</code> in the <code>weather_client</code> module's namespace.</p>
<h2 id="strategy-2-correct-patch-target">Strategy 2: Correct Patch Target</h2>
<p>Patch where the function is used:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_weather_client_correct_patch.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">weather_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">WeatherClient</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_current_weather_correct_patch</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">WeatherClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test_key&quot;</span><span class="p">)</span>

    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;Sunny&quot;</span><span class="p">,</span>
        <span class="s2">&quot;humidity&quot;</span><span class="p">:</span> <span class="mi">65</span>
    <span class="p">}</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Patch requests.get in the weather_client module</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;weather_client.requests.get&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_response</span><span class="p">):</span>
        <span class="n">weather</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_current_weather</span><span class="p">(</span><span class="s2">&quot;London&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">weather</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">20</span>
    <span class="k">assert</span> <span class="n">weather</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Sunny&quot;</span>
    <span class="k">assert</span> <span class="n">weather</span><span class="p">[</span><span class="s2">&quot;humidity&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">65</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_weather_client_correct_patch.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_weather_client_correct_patch.py::test_get_current_weather_correct_patch PASSED
</code></pre></div>

<p>Success! But this approach has limitations. Let's test error handling:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_weather_client_errors.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">weather_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">WeatherClient</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_handles_404_error</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">WeatherClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test_key&quot;</span><span class="p">)</span>

    <span class="c1"># Create a mock that raises HTTPError</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span>
        <span class="s2">&quot;404 Client Error: Not Found&quot;</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;weather_client.requests.get&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">mock_response</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">get_current_weather</span><span class="p">(</span><span class="s2">&quot;NonexistentCity&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_handles_network_error</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">WeatherClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test_key&quot;</span><span class="p">)</span>

    <span class="c1"># Mock a network failure</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;weather_client.requests.get&quot;</span><span class="p">,</span> <span class="n">side_effect</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">get_current_weather</span><span class="p">(</span><span class="s2">&quot;London&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_weather_client_errors.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_weather_client_errors.py::test_handles_404_error PASSED
test_weather_client_errors.py::test_handles_network_error PASSED
</code></pre></div>

<p>Good! But notice the repetition: every test needs to create a mock response and patch <code>requests.get</code>. This is where fixtures help.</p>
<h2 id="strategy-3-mock-fixtures">Strategy 3: Mock Fixtures</h2>
<p>Create reusable fixtures for common mock scenarios:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_requests_get</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a patcher for requests.get.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;weather_client.requests.get&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_get</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">mock_get</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_weather_response</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a mock successful weather response.&quot;&quot;&quot;</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;Sunny&quot;</span><span class="p">,</span>
        <span class="s2">&quot;humidity&quot;</span><span class="p">:</span> <span class="mi">65</span>
    <span class="p">}</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">mock_response</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_forecast_response</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a mock forecast response.&quot;&quot;&quot;</span>
    <span class="n">mock_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;forecast&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;Sunny&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span> <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;Cloudy&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span> <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;Sunny&quot;</span><span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
    <span class="n">mock_response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">mock_response</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_weather_client_fixtures.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">weather_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">WeatherClient</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_current_weather</span><span class="p">(</span><span class="n">mock_requests_get</span><span class="p">,</span> <span class="n">mock_weather_response</span><span class="p">):</span>
    <span class="n">mock_requests_get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_weather_response</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">WeatherClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test_key&quot;</span><span class="p">)</span>
    <span class="n">weather</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_current_weather</span><span class="p">(</span><span class="s2">&quot;London&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">weather</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">20</span>
    <span class="k">assert</span> <span class="n">weather</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Sunny&quot;</span>

    <span class="c1"># Verify the request was made correctly</span>
    <span class="n">mock_requests_get</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="s2">&quot;https://api.weather.com/current&quot;</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="s2">&quot;London&quot;</span><span class="p">,</span> <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="s2">&quot;test_key&quot;</span><span class="p">}</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_forecast</span><span class="p">(</span><span class="n">mock_requests_get</span><span class="p">,</span> <span class="n">mock_forecast_response</span><span class="p">):</span>
    <span class="n">mock_requests_get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_forecast_response</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">WeatherClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test_key&quot;</span><span class="p">)</span>
    <span class="n">forecast</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_forecast</span><span class="p">(</span><span class="s2">&quot;London&quot;</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">forecast</span><span class="p">[</span><span class="s2">&quot;forecast&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">forecast</span><span class="p">[</span><span class="s2">&quot;forecast&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">20</span>

    <span class="n">mock_requests_get</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
        <span class="s2">&quot;https://api.weather.com/forecast&quot;</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="s2">&quot;London&quot;</span><span class="p">,</span> <span class="s2">&quot;days&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="s2">&quot;test_key&quot;</span><span class="p">}</span>
    <span class="p">)</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_weather_client_fixtures.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_weather_client_fixtures.py::test_get_current_weather PASSED
test_weather_client_fixtures.py::test_get_forecast PASSED
</code></pre></div>

<p>Much cleaner! But there's a better way: the <code>responses</code> library, which is specifically designed for mocking HTTP requests.</p>
<h2 id="strategy-4-using-the-responses-library">Strategy 4: Using the responses Library</h2>
<p>The <code>responses</code> library provides a cleaner API for mocking HTTP requests:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>responses
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_weather_client_responses.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">responses</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">weather_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">WeatherClient</span>

<span class="nd">@responses</span><span class="o">.</span><span class="n">activate</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_get_current_weather</span><span class="p">():</span>
    <span class="c1"># Register a mock response</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.weather.com/current&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;Sunny&quot;</span><span class="p">,</span>
            <span class="s2">&quot;humidity&quot;</span><span class="p">:</span> <span class="mi">65</span>
        <span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">WeatherClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test_key&quot;</span><span class="p">)</span>
    <span class="n">weather</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_current_weather</span><span class="p">(</span><span class="s2">&quot;London&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">weather</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">20</span>
    <span class="k">assert</span> <span class="n">weather</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Sunny&quot;</span>

    <span class="c1"># Verify the request</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">responses</span><span class="o">.</span><span class="n">calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="o">==</span> <span class="p">(</span>
        <span class="s2">&quot;https://api.weather.com/current?city=London&amp;api_key=test_key&quot;</span>
    <span class="p">)</span>

<span class="nd">@responses</span><span class="o">.</span><span class="n">activate</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_handles_404</span><span class="p">():</span>
    <span class="c1"># Register a 404 response</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.weather.com/current&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;City not found&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">404</span>
    <span class="p">)</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">WeatherClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test_key&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="n">client</span><span class="o">.</span><span class="n">get_current_weather</span><span class="p">(</span><span class="s2">&quot;NonexistentCity&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="s2">&quot;404&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_weather_client_responses.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_weather_client_responses.py::test_get_current_weather PASSED
test_weather_client_responses.py::test_handles_404 PASSED
</code></pre></div>

<p>Much cleaner! The <code>responses</code> library handles the patching automatically and provides a more intuitive API.</p>
<h2 id="strategy-5-fixture-based-responses-setup">Strategy 5: Fixture-Based responses Setup</h2>
<p>Combine <code>responses</code> with fixtures for maximum reusability:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (updated)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">responses</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_weather_api</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Activate responses and provide helper for registering endpoints.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">responses</span><span class="o">.</span><span class="n">RequestsMock</span><span class="p">()</span> <span class="k">as</span> <span class="n">rsps</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">rsps</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">weather_api_success</span><span class="p">(</span><span class="n">mock_weather_api</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Register successful weather API responses.&quot;&quot;&quot;</span>
    <span class="n">mock_weather_api</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.weather.com/current&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;Sunny&quot;</span><span class="p">,</span>
            <span class="s2">&quot;humidity&quot;</span><span class="p">:</span> <span class="mi">65</span>
        <span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="n">mock_weather_api</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.weather.com/forecast&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;forecast&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;Sunny&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span> <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;Cloudy&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span> <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;Sunny&quot;</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">mock_weather_api</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_weather_client_fixture_responses.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">weather_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">WeatherClient</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_current_weather</span><span class="p">(</span><span class="n">weather_api_success</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">WeatherClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test_key&quot;</span><span class="p">)</span>
    <span class="n">weather</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_current_weather</span><span class="p">(</span><span class="s2">&quot;London&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">weather</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">20</span>
    <span class="k">assert</span> <span class="n">weather</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Sunny&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_forecast</span><span class="p">(</span><span class="n">weather_api_success</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">WeatherClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test_key&quot;</span><span class="p">)</span>
    <span class="n">forecast</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_forecast</span><span class="p">(</span><span class="s2">&quot;London&quot;</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">forecast</span><span class="p">[</span><span class="s2">&quot;forecast&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">forecast</span><span class="p">[</span><span class="s2">&quot;forecast&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">20</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_multiple_calls</span><span class="p">(</span><span class="n">weather_api_success</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">WeatherClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test_key&quot;</span><span class="p">)</span>

    <span class="c1"># Make multiple calls</span>
    <span class="n">weather</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_current_weather</span><span class="p">(</span><span class="s2">&quot;London&quot;</span><span class="p">)</span>
    <span class="n">forecast</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_forecast</span><span class="p">(</span><span class="s2">&quot;London&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">weather</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">20</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">forecast</span><span class="p">[</span><span class="s2">&quot;forecast&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="c1"># Verify both calls were made</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">weather_api_success</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_weather_client_fixture_responses.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_weather_client_fixture_responses.py::test_get_current_weather PASSED
test_weather_client_fixture_responses.py::test_get_forecast PASSED
test_weather_client_fixture_responses.py::test_multiple_calls PASSED
</code></pre></div>

<p>Perfect! Now tests are clean, focused, and don't depend on external services.</p>
<h2 id="decision-framework-api-testing-strategies">Decision Framework: API Testing Strategies</h2>
<table>
<thead>
<tr>
<th>Strategy</th>
<th>Setup Complexity</th>
<th>Flexibility</th>
<th>Best For</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>unittest.mock</strong></td>
<td>Medium</td>
<td>High</td>
<td>Complex mocking scenarios, custom behavior</td>
</tr>
<tr>
<td><strong>responses library</strong></td>
<td>Low</td>
<td>Medium</td>
<td>HTTP-specific testing, standard REST APIs</td>
</tr>
<tr>
<td><strong>VCR.py</strong></td>
<td>Low</td>
<td>Low</td>
<td>Recording real API interactions, regression tests</td>
</tr>
<tr>
<td><strong>Test doubles</strong></td>
<td>High</td>
<td>High</td>
<td>Full control, complex protocols</td>
</tr>
</tbody>
</table>
<h3 id="when-to-apply-each-solution_1">When to Apply Each Solution</h3>
<p><strong>unittest.mock</strong>:
- ‚úÖ Need fine-grained control over mock behavior
- ‚úÖ Testing error conditions and edge cases
- ‚úÖ Already using mocks elsewhere in codebase
- ‚ùå HTTP-specific features (status codes, headers) are verbose</p>
<p><strong>responses library</strong>:
- ‚úÖ Testing HTTP clients specifically
- ‚úÖ Need to verify request parameters
- ‚úÖ Want clean, readable test code
- ‚ùå Non-HTTP protocols (WebSockets, gRPC)</p>
<p><strong>VCR.py</strong> (record/replay):
- ‚úÖ Want to test against real API responses
- ‚úÖ Need to capture complex response structures
- ‚úÖ Regression testing against API changes
- ‚ùå API requires authentication or has side effects</p>
<h2 id="common-failure-modes-and-their-signatures_2">Common Failure Modes and Their Signatures</h2>
<h3 id="symptom-mock-not-intercepting-requests">Symptom: Mock not intercepting requests</h3>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>requests.exceptions.HTTPError: 401 Client Error: Unauthorized
# Even though you patched requests.get
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Real HTTP error despite mocking
- Patch applied but not working
- Network calls still happening</p>
<p><strong>Root cause</strong>: Patching wrong location (global vs. module namespace)</p>
<p><strong>Solution</strong>: Patch where the function is used: <code>patch("module_name.requests.get")</code></p>
<h3 id="symptom-responses-not-activating">Symptom: responses not activating</h3>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>ConnectionError: Connection refused
# When using responses library
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- responses.add() called but requests still fail
- Missing @responses.activate decorator
- Fixture not properly activating responses</p>
<p><strong>Root cause</strong>: responses not activated for the test</p>
<p><strong>Solution</strong>: Use <code>@responses.activate</code> decorator or <code>responses.RequestsMock()</code> context manager</p>
<h3 id="symptom-request-parameters-not-matching">Symptom: Request parameters not matching</h3>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>ConnectionError: Connection refused
# responses registered but not matching
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- responses.add() called with URL
- Request made to slightly different URL
- Query parameters in different order</p>
<p><strong>Root cause</strong>: URL or parameter mismatch between registered mock and actual request</p>
<p><strong>Solution</strong>: Use <code>responses.matchers</code> for flexible parameter matching or verify exact URL construction</p>
<h2 id="mocking-http-requests-with-responses">Mocking HTTP Requests with responses</h2>
<h2 id="deep-dive-the-responses-library">Deep Dive: The responses Library</h2>
<p>In the previous section, we introduced the <code>responses</code> library for mocking HTTP requests. Now let's explore its full capabilities and learn how to handle complex real-world scenarios.</p>
<p>The <code>responses</code> library intercepts HTTP requests at the <code>requests</code> library level, allowing you to define expected requests and their responses without making actual network calls.</p>
<h2 id="iteration-1-basic-response-registration">Iteration 1: Basic Response Registration</h2>
<p>Start with the simplest case‚Äîregistering a single response:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_responses_basic.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">responses</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="nd">@responses</span><span class="o">.</span><span class="n">activate</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_simple_get</span><span class="p">():</span>
    <span class="c1"># Register a mock response</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/users/1&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="c1"># Make the request</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/users/1&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">}</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_responses_basic.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_responses_basic.py::test_simple_get PASSED
</code></pre></div>

<p>Good! But what if the URL doesn't match exactly?</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_responses_mismatch.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">responses</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="nd">@responses</span><span class="o">.</span><span class="n">activate</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_url_mismatch</span><span class="p">():</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/users/1&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="c1"># Request a different user ID</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/users/2&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_responses_mismatch.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_responses_mismatch.py::test_url_mismatch FAILED

================================ FAILURES =================================
________________________ test_url_mismatch ____________________________

    @responses.activate
    def test_url_mismatch():
        responses.add(
            responses.GET,
            &quot;https://api.example.com/users/1&quot;,
            json={&quot;id&quot;: 1, &quot;name&quot;: &quot;Alice&quot;},
            status=200
        )

&gt;       response = requests.get(&quot;https://api.example.com/users/2&quot;)

test_responses_mismatch.py:13: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

&gt;   raise ConnectionError(msg)
E   requests.exceptions.ConnectionError: Connection refused by Responses
</code></pre></div>

<h3 id="diagnostic-analysis-url-matching-failure">Diagnostic Analysis: URL Matching Failure</h3>
<p><strong>The complete output</strong>:</p>
<p>The test fails with <code>requests.exceptions.ConnectionError: Connection refused by Responses</code>.</p>
<p><strong>Let's parse this section by section</strong>:</p>
<ol>
<li><strong>The error type</strong>: <code>ConnectionError</code> from the <code>responses</code> library</li>
<li>What this tells us: responses is active, but no registered mock matched the request</li>
<li>
<p>This is not a real network error‚Äîit's responses refusing to handle the request</p>
</li>
<li>
<p><strong>The URL mismatch</strong>: We registered <code>/users/1</code> but requested <code>/users/2</code></p>
</li>
<li>What this tells us: responses requires exact URL matches by default</li>
<li>Each unique URL needs its own registration</li>
</ol>
<p><strong>Root cause identified</strong>: responses uses exact URL matching, and we didn't register a mock for <code>/users/2</code>.</p>
<p><strong>Why the current approach can't solve this</strong>: We need to either register multiple URLs or use pattern matching.</p>
<p><strong>What we need</strong>: A way to match URLs dynamically or register multiple similar endpoints.</p>
<h2 id="iteration-2-multiple-responses-and-dynamic-urls">Iteration 2: Multiple Responses and Dynamic URLs</h2>
<p>Register multiple responses for different URLs:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_responses_multiple.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">responses</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="nd">@responses</span><span class="o">.</span><span class="n">activate</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_multiple_users</span><span class="p">():</span>
    <span class="c1"># Register responses for multiple users</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/users/1&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/users/2&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Bob&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="c1"># Request both users</span>
    <span class="n">alice</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/users/1&quot;</span><span class="p">)</span>
    <span class="n">bob</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/users/2&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">alice</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Alice&quot;</span>
    <span class="k">assert</span> <span class="n">bob</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bob&quot;</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_responses_multiple.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_responses_multiple.py::test_multiple_users PASSED
</code></pre></div>

<p>This works, but it's tedious for many endpoints. Let's use regex matching:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_responses_regex.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">responses</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="nd">@responses</span><span class="o">.</span><span class="n">activate</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_regex_matching</span><span class="p">():</span>
    <span class="c1"># Use regex to match any user ID</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;https://api\.example\.com/users/\d+&quot;</span><span class="p">),</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">999</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Generic User&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="c1"># Request any user ID</span>
    <span class="n">user1</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/users/1&quot;</span><span class="p">)</span>
    <span class="n">user2</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/users/2&quot;</span><span class="p">)</span>
    <span class="n">user100</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/users/100&quot;</span><span class="p">)</span>

    <span class="c1"># All get the same response</span>
    <span class="k">assert</span> <span class="n">user1</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Generic User&quot;</span>
    <span class="k">assert</span> <span class="n">user2</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Generic User&quot;</span>
    <span class="k">assert</span> <span class="n">user100</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Generic User&quot;</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_responses_regex.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_responses_regex.py::test_regex_matching PASSED
</code></pre></div>

<p>Good! But returning the same response for all IDs isn't realistic. We need dynamic responses.</p>
<h2 id="iteration-3-dynamic-response-callbacks">Iteration 3: Dynamic Response Callbacks</h2>
<p>Use callbacks to generate responses dynamically:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_responses_callback.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">responses</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="k">def</span><span class="w"> </span><span class="nf">user_callback</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># Extract user ID from URL</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Generate response based on ID</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="mi">200</span><span class="p">,</span>
        <span class="p">{},</span>
        <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;user</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">@example.com&quot;</span>
        <span class="p">}</span>
    <span class="p">)</span>

<span class="nd">@responses</span><span class="o">.</span><span class="n">activate</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_dynamic_responses</span><span class="p">():</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;https://api\.example\.com/users/\d+&quot;</span><span class="p">),</span>
        <span class="n">callback</span><span class="o">=</span><span class="n">user_callback</span><span class="p">,</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Request different users</span>
    <span class="n">user1</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/users/1&quot;</span><span class="p">)</span>
    <span class="n">user2</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/users/2&quot;</span><span class="p">)</span>

    <span class="c1"># Each gets a unique response</span>
    <span class="k">assert</span> <span class="n">user1</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;User 1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;user1@example.com&quot;</span>
    <span class="p">}</span>

    <span class="k">assert</span> <span class="n">user2</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;User 2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;user2@example.com&quot;</span>
    <span class="p">}</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_responses_callback.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_responses_callback.py::test_dynamic_responses PASSED
</code></pre></div>

<p>Excellent! Now let's handle query parameters.</p>
<h2 id="iteration-4-matching-query-parameters">Iteration 4: Matching Query Parameters</h2>
<p>Test endpoints that use query parameters:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_responses_query_params.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">responses</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="nd">@responses</span><span class="o">.</span><span class="n">activate</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_query_params_exact</span><span class="p">():</span>
    <span class="c1"># Register response for specific query params</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/search?q=python&amp;limit=10&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;result1&quot;</span><span class="p">,</span> <span class="s2">&quot;result2&quot;</span><span class="p">]},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="c1"># Request with exact params</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;https://api.example.com/search&quot;</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;result1&quot;</span><span class="p">,</span> <span class="s2">&quot;result2&quot;</span><span class="p">]}</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_responses_query_params.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_responses_query_params.py::test_query_params_exact FAILED

================================ FAILURES =================================
_________________ test_query_params_exact _____________________________

    @responses.activate
    def test_query_params_exact():
        responses.add(
            responses.GET,
            &quot;https://api.example.com/search?q=python&amp;limit=10&quot;,
            json={&quot;results&quot;: [&quot;result1&quot;, &quot;result2&quot;]},
            status=200
        )

&gt;       response = requests.get(
            &quot;https://api.example.com/search&quot;,
            params={&quot;q&quot;: &quot;python&quot;, &quot;limit&quot;: 10}
        )

test_responses_query_params.py:12: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

&gt;   raise ConnectionError(msg)
E   requests.exceptions.ConnectionError: Connection refused by Responses
</code></pre></div>

<h3 id="diagnostic-analysis-query-parameter-order">Diagnostic Analysis: Query Parameter Order</h3>
<p><strong>The complete output</strong>:</p>
<p>The test fails even though we provided the exact query parameters.</p>
<p><strong>Let's parse this section by section</strong>:</p>
<ol>
<li><strong>The URL construction</strong>: <code>requests</code> builds the URL as <code>?q=python&amp;limit=10</code></li>
<li>What this tells us: The order of query parameters matters for exact matching</li>
<li>
<p>We registered <code>?q=python&amp;limit=10</code> but requests might construct <code>?limit=10&amp;q=python</code></p>
</li>
<li>
<p><strong>The matching behavior</strong>: responses uses string comparison for URLs</p>
</li>
<li>What this tells us: Query parameter order affects matching</li>
<li>Dictionary iteration order can vary</li>
</ol>
<p><strong>Root cause identified</strong>: Query parameter order is not guaranteed, causing URL mismatch.</p>
<p><strong>Why the current approach can't solve this</strong>: String-based URL matching is too brittle for query parameters.</p>
<p><strong>What we need</strong>: A way to match query parameters regardless of order.</p>
<h2 id="iteration-5-flexible-query-parameter-matching">Iteration 5: Flexible Query Parameter Matching</h2>
<p>Use matchers for flexible parameter matching:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_responses_matchers.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">responses</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">matchers</span>

<span class="nd">@responses</span><span class="o">.</span><span class="n">activate</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_query_params_matcher</span><span class="p">():</span>
    <span class="c1"># Use matcher for query params (order-independent)</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/search&quot;</span><span class="p">,</span>
        <span class="n">match</span><span class="o">=</span><span class="p">[</span>
            <span class="n">matchers</span><span class="o">.</span><span class="n">query_param_matcher</span><span class="p">({</span><span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="s2">&quot;10&quot;</span><span class="p">})</span>
        <span class="p">],</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;result1&quot;</span><span class="p">,</span> <span class="s2">&quot;result2&quot;</span><span class="p">]},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="c1"># Request with params in any order</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;https://api.example.com/search&quot;</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">}</span>  <span class="c1"># Different order</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;result1&quot;</span><span class="p">,</span> <span class="s2">&quot;result2&quot;</span><span class="p">]}</span>

<span class="nd">@responses</span><span class="o">.</span><span class="n">activate</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_partial_query_params</span><span class="p">():</span>
    <span class="c1"># Match only specific params, ignore others</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/search&quot;</span><span class="p">,</span>
        <span class="n">match</span><span class="o">=</span><span class="p">[</span>
            <span class="n">matchers</span><span class="o">.</span><span class="n">query_param_matcher</span><span class="p">({</span><span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">},</span> <span class="n">strict_match</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">],</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;result1&quot;</span><span class="p">,</span> <span class="s2">&quot;result2&quot;</span><span class="p">]},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="c1"># Request with extra params</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;https://api.example.com/search&quot;</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;result1&quot;</span><span class="p">,</span> <span class="s2">&quot;result2&quot;</span><span class="p">]}</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_responses_matchers.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_responses_matchers.py::test_query_params_matcher PASSED
test_responses_matchers.py::test_partial_query_params PASSED
</code></pre></div>

<p>Perfect! Now let's handle POST requests with JSON bodies.</p>
<h2 id="iteration-6-matching-request-bodies">Iteration 6: Matching Request Bodies</h2>
<p>Test POST requests with JSON payloads:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_responses_post.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">responses</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">matchers</span>

<span class="nd">@responses</span><span class="o">.</span><span class="n">activate</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_post_with_json</span><span class="p">():</span>
    <span class="c1"># Match POST request with specific JSON body</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/users&quot;</span><span class="p">,</span>
        <span class="n">match</span><span class="o">=</span><span class="p">[</span>
            <span class="n">matchers</span><span class="o">.</span><span class="n">json_params_matcher</span><span class="p">({</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span>
                <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alice@example.com&quot;</span>
            <span class="p">})</span>
        <span class="p">],</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">201</span>
    <span class="p">)</span>

    <span class="c1"># Make POST request</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;https://api.example.com/users&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

<span class="nd">@responses</span><span class="o">.</span><span class="n">activate</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_post_with_partial_match</span><span class="p">():</span>
    <span class="c1"># Match only specific fields in JSON body</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/users&quot;</span><span class="p">,</span>
        <span class="n">match</span><span class="o">=</span><span class="p">[</span>
            <span class="n">matchers</span><span class="o">.</span><span class="n">json_params_matcher</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Bob&quot;</span><span class="p">},</span>
                <span class="n">strict_match</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="p">],</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Bob&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">201</span>
    <span class="p">)</span>

    <span class="c1"># Request with extra fields</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;https://api.example.com/users&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Bob&quot;</span><span class="p">,</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;bob@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">30</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bob&quot;</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_responses_post.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_responses_post.py::test_post_with_json PASSED
test_responses_post.py::test_post_with_partial_match PASSED
</code></pre></div>

<p>Great! Now let's handle headers.</p>
<h2 id="iteration-7-matching-and-returning-headers">Iteration 7: Matching and Returning Headers</h2>
<p>Test requests that require specific headers:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_responses_headers.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">responses</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">matchers</span>

<span class="nd">@responses</span><span class="o">.</span><span class="n">activate</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_request_headers</span><span class="p">():</span>
    <span class="c1"># Match request with specific headers</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/protected&quot;</span><span class="p">,</span>
        <span class="n">match</span><span class="o">=</span><span class="p">[</span>
            <span class="n">matchers</span><span class="o">.</span><span class="n">header_matcher</span><span class="p">({</span>
                <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer secret-token&quot;</span>
            <span class="p">})</span>
        <span class="p">],</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;protected content&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="c1"># Request with correct header</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;https://api.example.com/protected&quot;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer secret-token&quot;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;protected content&quot;</span>

<span class="nd">@responses</span><span class="o">.</span><span class="n">activate</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_response_headers</span><span class="p">():</span>
    <span class="c1"># Return specific headers in response</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/data&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;content&quot;</span><span class="p">},</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;X-RateLimit-Remaining&quot;</span><span class="p">:</span> <span class="s2">&quot;99&quot;</span><span class="p">,</span>
            <span class="s2">&quot;X-RateLimit-Reset&quot;</span><span class="p">:</span> <span class="s2">&quot;1234567890&quot;</span>
        <span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/data&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-RateLimit-Remaining&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;99&quot;</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-RateLimit-Reset&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1234567890&quot;</span>

<span class="nd">@responses</span><span class="o">.</span><span class="n">activate</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_missing_auth_header</span><span class="p">():</span>
    <span class="c1"># Require auth header</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/protected&quot;</span><span class="p">,</span>
        <span class="n">match</span><span class="o">=</span><span class="p">[</span>
            <span class="n">matchers</span><span class="o">.</span><span class="n">header_matcher</span><span class="p">({</span>
                <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="n">matchers</span><span class="o">.</span><span class="n">ANY</span>
            <span class="p">})</span>
        <span class="p">],</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;protected content&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="c1"># Request without auth header should fail</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ConnectionError</span><span class="p">):</span>
        <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/protected&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_responses_headers.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_responses_headers.py::test_request_headers PASSED
test_responses_headers.py::test_response_headers PASSED
test_responses_headers.py::test_missing_auth_header PASSED
</code></pre></div>

<p>Excellent! Now let's handle sequential responses.</p>
<h2 id="iteration-8-sequential-responses-for-repeated-calls">Iteration 8: Sequential Responses for Repeated Calls</h2>
<p>Test code that makes the same request multiple times:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_responses_sequential.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">responses</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="nd">@responses</span><span class="o">.</span><span class="n">activate</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_sequential_responses</span><span class="p">():</span>
    <span class="c1"># First call returns one result</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/status&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;pending&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="c1"># Second call returns different result</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/status&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;processing&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="c1"># Third call returns final result</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/status&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;complete&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="c1"># Make three requests</span>
    <span class="n">response1</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/status&quot;</span><span class="p">)</span>
    <span class="n">response2</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/status&quot;</span><span class="p">)</span>
    <span class="n">response3</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/status&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response1</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;pending&quot;</span>
    <span class="k">assert</span> <span class="n">response2</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;processing&quot;</span>
    <span class="k">assert</span> <span class="n">response3</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;complete&quot;</span>

<span class="nd">@responses</span><span class="o">.</span><span class="n">activate</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_polling_until_complete</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulate polling an async operation.&quot;&quot;&quot;</span>
    <span class="c1"># Register multiple responses</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
            <span class="s2">&quot;https://api.example.com/job/123&quot;</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;running&quot;</span><span class="p">},</span>
            <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
        <span class="p">)</span>

    <span class="c1"># Final response</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/job/123&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;complete&quot;</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="c1"># Poll until complete</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;running&quot;</span>
    <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;running&quot;</span> <span class="ow">and</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/job/123&quot;</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>
        <span class="n">attempts</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">assert</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;complete&quot;</span>
    <span class="k">assert</span> <span class="n">attempts</span> <span class="o">==</span> <span class="mi">4</span>  <span class="c1"># 3 running + 1 complete</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_responses_sequential.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_responses_sequential.py::test_sequential_responses PASSED
test_responses_sequential.py::test_polling_until_complete PASSED
</code></pre></div>

<p>Perfect! Now let's verify request details.</p>
<h2 id="iteration-9-inspecting-captured-requests">Iteration 9: Inspecting Captured Requests</h2>
<p>Verify that your code makes the correct requests:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_responses_inspection.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">responses</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="nd">@responses</span><span class="o">.</span><span class="n">activate</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_request_inspection</span><span class="p">():</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/users&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">201</span>
    <span class="p">)</span>

    <span class="c1"># Make request</span>
    <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;https://api.example.com/users&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">},</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;X-Client-Version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># Inspect the captured request</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="n">call</span> <span class="o">=</span> <span class="n">responses</span><span class="o">.</span><span class="n">calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">call</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="o">==</span> <span class="s2">&quot;https://api.example.com/users&quot;</span>
    <span class="k">assert</span> <span class="n">call</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span>
    <span class="k">assert</span> <span class="n">call</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Client-Version&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1.0&quot;</span>

    <span class="c1"># Inspect request body</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Alice&quot;</span>
    <span class="k">assert</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;alice@example.com&quot;</span>

<span class="nd">@responses</span><span class="o">.</span><span class="n">activate</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_multiple_requests</span><span class="p">():</span>
    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/users/1&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="n">responses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/users/2&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Bob&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="c1"># Make multiple requests</span>
    <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/users/1&quot;</span><span class="p">)</span>
    <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.example.com/users/2&quot;</span><span class="p">)</span>

    <span class="c1"># Verify both were made</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="o">.</span><span class="n">calls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="s2">&quot;users/1&quot;</span> <span class="ow">in</span> <span class="n">responses</span><span class="o">.</span><span class="n">calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span>
    <span class="k">assert</span> <span class="s2">&quot;users/2&quot;</span> <span class="ow">in</span> <span class="n">responses</span><span class="o">.</span><span class="n">calls</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_responses_inspection.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_responses_inspection.py::test_request_inspection PASSED
test_responses_inspection.py::test_multiple_requests PASSED
</code></pre></div>

<h2 id="the-complete-responses-toolkit">The Complete responses Toolkit</h2>
<p>Here's a comprehensive fixture setup for real-world API testing:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (complete responses setup)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">responses</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">matchers</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_api</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Activate responses for the test.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">responses</span><span class="o">.</span><span class="n">RequestsMock</span><span class="p">()</span> <span class="k">as</span> <span class="n">rsps</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">rsps</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_user_api</span><span class="p">(</span><span class="n">mock_api</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mock a complete user API.&quot;&quot;&quot;</span>

    <span class="c1"># GET /users - list users</span>
    <span class="n">mock_api</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/users&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Bob&quot;</span><span class="p">}</span>
        <span class="p">]},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="c1"># GET /users/:id - get specific user (dynamic)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">user_callback</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;user</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">@example.com&quot;</span>
        <span class="p">})</span>

    <span class="n">mock_api</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;https://api\.example\.com/users/\d+&quot;</span><span class="p">),</span>
        <span class="n">callback</span><span class="o">=</span><span class="n">user_callback</span><span class="p">,</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span>
    <span class="p">)</span>

    <span class="c1"># POST /users - create user</span>
    <span class="n">mock_api</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/users&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">999</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;New User&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">201</span>
    <span class="p">)</span>

    <span class="c1"># PUT /users/:id - update user</span>
    <span class="n">mock_api</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">PUT</span><span class="p">,</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;https://api\.example\.com/users/\d+&quot;</span><span class="p">),</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Updated User&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="c1"># DELETE /users/:id - delete user</span>
    <span class="n">mock_api</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;https://api\.example\.com/users/\d+&quot;</span><span class="p">),</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">204</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">mock_api</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_auth_api</span><span class="p">(</span><span class="n">mock_api</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mock an authenticated API.&quot;&quot;&quot;</span>

    <span class="c1"># Successful auth</span>
    <span class="n">mock_api</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/auth/login&quot;</span><span class="p">,</span>
        <span class="n">match</span><span class="o">=</span><span class="p">[</span>
            <span class="n">matchers</span><span class="o">.</span><span class="n">json_params_matcher</span><span class="p">({</span>
                <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
                <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;secret&quot;</span>
            <span class="p">})</span>
        <span class="p">],</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;valid-token-123&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="c1"># Failed auth</span>
    <span class="n">mock_api</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/auth/login&quot;</span><span class="p">,</span>
        <span class="n">match</span><span class="o">=</span><span class="p">[</span>
            <span class="n">matchers</span><span class="o">.</span><span class="n">json_params_matcher</span><span class="p">({</span>
                <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span>
                <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;wrong&quot;</span>
            <span class="p">})</span>
        <span class="p">],</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid credentials&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">401</span>
    <span class="p">)</span>

    <span class="c1"># Protected endpoint</span>
    <span class="n">mock_api</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span>
        <span class="s2">&quot;https://api.example.com/protected&quot;</span><span class="p">,</span>
        <span class="n">match</span><span class="o">=</span><span class="p">[</span>
            <span class="n">matchers</span><span class="o">.</span><span class="n">header_matcher</span><span class="p">({</span>
                <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer valid-token-123&quot;</span>
            <span class="p">})</span>
        <span class="p">],</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;secret content&quot;</span><span class="p">},</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">mock_api</span>
</code></pre></div>

<h2 id="decision-framework-responses-features">Decision Framework: responses Features</h2>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Use Case</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Exact URL</strong></td>
<td>Simple, static endpoints</td>
<td><code>responses.add(GET, "https://api.com/users")</code></td>
</tr>
<tr>
<td><strong>Regex URL</strong></td>
<td>Dynamic IDs in path</td>
<td><code>re.compile(r"https://api\.com/users/\d+")</code></td>
</tr>
<tr>
<td><strong>Callbacks</strong></td>
<td>Dynamic response generation</td>
<td><code>responses.add_callback(GET, url, callback=func)</code></td>
</tr>
<tr>
<td><strong>Query matchers</strong></td>
<td>Order-independent params</td>
<td><code>matchers.query_param_matcher({"q": "python"})</code></td>
</tr>
<tr>
<td><strong>JSON matchers</strong></td>
<td>POST/PUT body validation</td>
<td><code>matchers.json_params_matcher({"name": "Alice"})</code></td>
</tr>
<tr>
<td><strong>Header matchers</strong></td>
<td>Auth, content-type checks</td>
<td><code>matchers.header_matcher({"Authorization": "Bearer X"})</code></td>
</tr>
<tr>
<td><strong>Sequential</strong></td>
<td>Polling, state changes</td>
<td>Multiple <code>responses.add()</code> for same URL</td>
</tr>
</tbody>
</table>
<h3 id="when-to-apply-each-feature">When to Apply Each Feature</h3>
<p><strong>Exact URL matching</strong>:
- ‚úÖ Simple, static endpoints
- ‚úÖ No dynamic parameters
- ‚úÖ Maximum clarity
- ‚ùå Many similar endpoints (use regex)</p>
<p><strong>Regex matching</strong>:
- ‚úÖ Dynamic IDs in URL path
- ‚úÖ Multiple similar endpoints
- ‚úÖ Flexible matching
- ‚ùå Complex response logic (use callbacks)</p>
<p><strong>Callbacks</strong>:
- ‚úÖ Response depends on request data
- ‚úÖ Complex business logic
- ‚úÖ Stateful simulations
- ‚ùå Simple static responses (overkill)</p>
<p><strong>Matchers</strong>:
- ‚úÖ Query parameters (order-independent)
- ‚úÖ JSON body validation
- ‚úÖ Header requirements
- ‚úÖ Partial matching
- ‚ùå Exact string matching is sufficient</p>
<h2 id="common-failure-modes-and-their-signatures_3">Common Failure Modes and Their Signatures</h2>
<h3 id="symptom-connectionerror-despite-registered-mock">Symptom: ConnectionError despite registered mock</h3>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>requests.exceptions.ConnectionError: Connection refused by Responses
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Mock registered but not matching
- URL, method, or parameters don't match exactly
- Missing @responses.activate decorator</p>
<p><strong>Root cause</strong>: Request doesn't match any registered mock</p>
<p><strong>Solution</strong>: Use <code>responses.calls</code> to inspect what was actually requested, compare with registered mocks</p>
<h3 id="symptom-wrong-response-returned">Symptom: Wrong response returned</h3>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>AssertionError: assert &#39;pending&#39; == &#39;complete&#39;
# Expected &#39;complete&#39; but got &#39;pending&#39;
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Sequential responses registered
- Test made more/fewer calls than expected
- Response order matters</p>
<p><strong>Root cause</strong>: Response consumed in wrong order or test logic error</p>
<p><strong>Solution</strong>: Verify number of calls with <code>len(responses.calls)</code>, check response order</p>
<h3 id="symptom-matcher-not-working">Symptom: Matcher not working</h3>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>ConnectionError: Connection refused by Responses
# Even with matcher configured
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Matcher configured but not matching
- Query params as strings vs. integers
- Strict vs. non-strict matching</p>
<p><strong>Root cause</strong>: Type mismatch or strict matching when partial needed</p>
<p><strong>Solution</strong>: Use <code>strict_match=False</code> for partial matching, ensure type consistency</p>
<h2 id="testing-file-io">Testing File I/O</h2>
<h2 id="the-challenge-of-testing-file-operations">The Challenge of Testing File Operations</h2>
<p>Testing code that reads and writes files presents unique challenges: file operations have side effects, tests can interfere with each other through the filesystem, and cleanup is critical. You need to ensure tests don't leave files behind or depend on specific filesystem state.</p>
<p>Consider a configuration file manager:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># config_manager.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ConfigManager</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_path</span> <span class="o">=</span> <span class="n">config_path</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load configuration from file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save configuration to file.&quot;&quot;&quot;</span>
        <span class="c1"># Create directory if it doesn&#39;t exist</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update a single configuration value.&quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">delete_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete the configuration file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_path</span><span class="p">)</span>
</code></pre></div>

<p>How do you test this without polluting your filesystem? Let's start with the naive approach.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_config_manager_naive.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">config_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigManager</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_save_and_load</span><span class="p">():</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="s2">&quot;test_config.json&quot;</span><span class="p">)</span>

    <span class="c1"># Save config</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">5432</span><span class="p">}</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">save_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># Load it back</span>
    <span class="n">loaded</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">loaded</span> <span class="o">==</span> <span class="n">config</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_update_config</span><span class="p">():</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="s2">&quot;test_config.json&quot;</span><span class="p">)</span>

    <span class="c1"># Update a value</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">update_config</span><span class="p">(</span><span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;production.db&quot;</span><span class="p">)</span>

    <span class="c1"># Verify</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;production.db&quot;</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_config_manager_naive.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_config_manager_naive.py::test_save_and_load PASSED
test_config_manager_naive.py::test_update_config PASSED
</code></pre></div>

<p>Tests pass! But check your directory:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>ls<span class="w"> </span>-la
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>-rw-r--r-- 1 user user   45 Dec 10 10:30 test_config.json
</code></pre></div>

<p>The test left a file behind. Run the tests again:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_config_manager_naive.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_config_manager_naive.py::test_save_and_load PASSED
test_config_manager_naive.py::test_update_config FAILED

================================ FAILURES =================================
__________________ test_update_config _________________________________

    def test_update_config():
        manager = ConfigManager(&quot;test_config.json&quot;)

        manager.update_config(&quot;database&quot;, &quot;production.db&quot;)

        config = manager.load_config()
&gt;       assert config[&quot;database&quot;] == &quot;production.db&quot;
E       AssertionError: assert &#39;production.db&#39; == &#39;production.db&#39;
E       + where {&#39;database&#39;: &#39;production.db&#39;, &#39;port&#39;: 5432} = ...
</code></pre></div>

<h3 id="diagnostic-analysis-file-state-pollution">Diagnostic Analysis: File State Pollution</h3>
<p><strong>The complete output</strong>:</p>
<p>The second test fails because it sees data from the first test.</p>
<p><strong>Let's parse this section by section</strong>:</p>
<ol>
<li><strong>The assertion failure</strong>: The config has both <code>database</code> and <code>port</code> keys</li>
<li>What this tells us: The file from <code>test_save_and_load</code> still exists</li>
<li>
<p><code>test_update_config</code> loaded the existing file and added to it</p>
</li>
<li>
<p><strong>The test interdependency</strong>: Tests share state through the filesystem</p>
</li>
<li>What this tells us: No cleanup between tests</li>
<li>File persists across test runs</li>
</ol>
<p><strong>Root cause identified</strong>: Tests write to real files that persist between runs.</p>
<p><strong>Why the current approach can't solve this</strong>: We need automatic cleanup after each test.</p>
<p><strong>What we need</strong>: A way to create temporary files that are automatically cleaned up.</p>
<h2 id="strategy-1-manual-cleanup-with-fixtures">Strategy 1: Manual Cleanup with Fixtures</h2>
<p>Add cleanup using fixtures:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_config_manager_cleanup.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">config_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigManager</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">config_file</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a config file path and clean it up after the test.&quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;test_config.json&quot;</span>

    <span class="k">yield</span> <span class="n">path</span>

    <span class="c1"># Cleanup</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_save_and_load</span><span class="p">(</span><span class="n">config_file</span><span class="p">):</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">5432</span><span class="p">}</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">save_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="n">loaded</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">loaded</span> <span class="o">==</span> <span class="n">config</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_update_config</span><span class="p">(</span><span class="n">config_file</span><span class="p">):</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

    <span class="n">manager</span><span class="o">.</span><span class="n">update_config</span><span class="p">(</span><span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;production.db&quot;</span><span class="p">)</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;production.db&quot;</span>
</code></pre></div>

<p>Run this multiple times:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_config_manager_cleanup.py<span class="w"> </span>-v
$<span class="w"> </span>pytest<span class="w"> </span>test_config_manager_cleanup.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_config_manager_cleanup.py::test_save_and_load PASSED
test_config_manager_cleanup.py::test_update_config PASSED

test_config_manager_cleanup.py::test_save_and_load PASSED
test_config_manager_cleanup.py::test_update_config PASSED
</code></pre></div>

<p>Good! Tests are now isolated. But what if tests run in parallel? Or what if we need multiple test files?</p>
<h2 id="strategy-2-unique-file-names">Strategy 2: Unique File Names</h2>
<p>Generate unique file names for each test:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_config_manager_unique.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">config_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigManager</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">config_file</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a unique config file path.&quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;test_config_</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="si">}</span><span class="s2">.json&quot;</span>

    <span class="k">yield</span> <span class="n">path</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_save_and_load</span><span class="p">(</span><span class="n">config_file</span><span class="p">):</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">5432</span><span class="p">}</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">save_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="n">loaded</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">loaded</span> <span class="o">==</span> <span class="n">config</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_update_config</span><span class="p">(</span><span class="n">config_file</span><span class="p">):</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

    <span class="n">manager</span><span class="o">.</span><span class="n">update_config</span><span class="p">(</span><span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;production.db&quot;</span><span class="p">)</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;production.db&quot;</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_config_manager_unique.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_config_manager_unique.py::test_save_and_load PASSED
test_config_manager_unique.py::test_update_config PASSED
</code></pre></div>

<p>This works, but we're still writing to the current directory. What if we need to test directory creation? Or test with nested paths?</p>
<h2 id="strategy-3-temporary-directories">Strategy 3: Temporary Directories</h2>
<p>Use Python's <code>tempfile</code> module for proper temporary file handling:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_config_manager_tempfile.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">config_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigManager</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">temp_config_file</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a temporary config file in a temp directory.&quot;&quot;&quot;</span>
    <span class="c1"># Create a temporary directory</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdir</span><span class="p">:</span>
        <span class="n">config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;config.json&quot;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">config_path</span>
        <span class="c1"># Directory and all contents automatically cleaned up</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_save_and_load</span><span class="p">(</span><span class="n">temp_config_file</span><span class="p">):</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="n">temp_config_file</span><span class="p">)</span>

    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">5432</span><span class="p">}</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">save_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="n">loaded</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">loaded</span> <span class="o">==</span> <span class="n">config</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_nested_directory</span><span class="p">(</span><span class="n">temp_config_file</span><span class="p">):</span>
    <span class="c1"># Test with nested path</span>
    <span class="n">nested_path</span> <span class="o">=</span> <span class="n">temp_config_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;config.json&quot;</span><span class="p">,</span> <span class="s2">&quot;nested/dir/config.json&quot;</span><span class="p">)</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="n">nested_path</span><span class="p">)</span>

    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">}</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">save_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># Verify directory was created</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">nested_path</span><span class="p">))</span>

    <span class="n">loaded</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">loaded</span> <span class="o">==</span> <span class="n">config</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_config_manager_tempfile.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_config_manager_tempfile.py::test_save_and_load PASSED
test_config_manager_tempfile.py::test_nested_directory PASSED
</code></pre></div>

<p>Perfect! But there's an even better way: pytest's built-in <code>tmp_path</code> fixture.</p>
<h2 id="strategy-4-pytests-tmp_path-fixture">Strategy 4: pytest's tmp_path Fixture</h2>
<p>Use pytest's built-in temporary directory fixture:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_config_manager_tmp_path.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">config_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigManager</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_save_and_load</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;tmp_path is a pathlib.Path object to a temporary directory.&quot;&quot;&quot;</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;config.json&quot;</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">config_file</span><span class="p">))</span>

    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">5432</span><span class="p">}</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">save_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="n">loaded</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">loaded</span> <span class="o">==</span> <span class="n">config</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_nested_directory</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;nested&quot;</span> <span class="o">/</span> <span class="s2">&quot;dir&quot;</span> <span class="o">/</span> <span class="s2">&quot;config.json&quot;</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">config_file</span><span class="p">))</span>

    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">}</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">save_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">config_file</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

    <span class="n">loaded</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">loaded</span> <span class="o">==</span> <span class="n">config</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_multiple_files</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test with multiple config files.&quot;&quot;&quot;</span>
    <span class="n">config1</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;config1.json&quot;</span>
    <span class="n">config2</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;config2.json&quot;</span>

    <span class="n">manager1</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">config1</span><span class="p">))</span>
    <span class="n">manager2</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">config2</span><span class="p">))</span>

    <span class="n">manager1</span><span class="o">.</span><span class="n">save_config</span><span class="p">({</span><span class="s2">&quot;env&quot;</span><span class="p">:</span> <span class="s2">&quot;dev&quot;</span><span class="p">})</span>
    <span class="n">manager2</span><span class="o">.</span><span class="n">save_config</span><span class="p">({</span><span class="s2">&quot;env&quot;</span><span class="p">:</span> <span class="s2">&quot;prod&quot;</span><span class="p">})</span>

    <span class="k">assert</span> <span class="n">manager1</span><span class="o">.</span><span class="n">load_config</span><span class="p">()[</span><span class="s2">&quot;env&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;dev&quot;</span>
    <span class="k">assert</span> <span class="n">manager2</span><span class="o">.</span><span class="n">load_config</span><span class="p">()[</span><span class="s2">&quot;env&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;prod&quot;</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_config_manager_tmp_path.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_config_manager_tmp_path.py::test_save_and_load PASSED
test_config_manager_tmp_path.py::test_nested_directory PASSED
test_config_manager_tmp_path.py::test_multiple_files PASSED
</code></pre></div>

<p>Excellent! Now let's test reading existing files.</p>
<h2 id="strategy-5-pre-populating-test-files">Strategy 5: Pre-Populating Test Files</h2>
<p>Test code that reads existing files:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_config_manager_existing.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">config_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigManager</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">existing_config</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a config file with existing data.&quot;&quot;&quot;</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;config.json&quot;</span>

    <span class="c1"># Write initial config</span>
    <span class="n">initial_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
        <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="s2">&quot;debug&quot;</span><span class="p">:</span> <span class="kc">True</span>
    <span class="p">}</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">initial_config</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">config_file</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_load_existing_config</span><span class="p">(</span><span class="n">existing_config</span><span class="p">):</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">existing_config</span><span class="p">))</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;localhost&quot;</span>
    <span class="k">assert</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;port&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5432</span>
    <span class="k">assert</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;debug&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_update_existing_config</span><span class="p">(</span><span class="n">existing_config</span><span class="p">):</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">existing_config</span><span class="p">))</span>

    <span class="c1"># Update one value</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">update_config</span><span class="p">(</span><span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="mi">3306</span><span class="p">)</span>

    <span class="c1"># Verify other values preserved</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;localhost&quot;</span>  <span class="c1"># Unchanged</span>
    <span class="k">assert</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;port&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3306</span>  <span class="c1"># Updated</span>
    <span class="k">assert</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;debug&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>  <span class="c1"># Unchanged</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_delete_config</span><span class="p">(</span><span class="n">existing_config</span><span class="p">):</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">existing_config</span><span class="p">))</span>

    <span class="c1"># Verify file exists</span>
    <span class="k">assert</span> <span class="n">existing_config</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

    <span class="c1"># Delete it</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">delete_config</span><span class="p">()</span>

    <span class="c1"># Verify it&#39;s gone</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">existing_config</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

    <span class="c1"># Loading should return empty dict</span>
    <span class="k">assert</span> <span class="n">manager</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span> <span class="o">==</span> <span class="p">{}</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_config_manager_existing.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_config_manager_existing.py::test_load_existing_config PASSED
test_config_manager_existing.py::test_update_existing_config PASSED
test_config_manager_existing.py::test_delete_config PASSED
</code></pre></div>

<p>Great! Now let's test error conditions.</p>
<h2 id="strategy-6-testing-file-io-errors">Strategy 6: Testing File I/O Errors</h2>
<p>Test how code handles file system errors:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_config_manager_errors.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">config_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigManager</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_load_nonexistent_file</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loading a nonexistent file should return empty dict.&quot;&quot;&quot;</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;nonexistent.json&quot;</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">config_file</span><span class="p">))</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">config</span> <span class="o">==</span> <span class="p">{}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_load_invalid_json</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loading invalid JSON should raise an error.&quot;&quot;&quot;</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;invalid.json&quot;</span>

    <span class="c1"># Write invalid JSON</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;{ invalid json }&quot;</span><span class="p">)</span>

    <span class="n">manager</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">config_file</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">):</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_save_to_readonly_directory</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Saving to a read-only directory should raise an error.&quot;&quot;&quot;</span>
    <span class="n">readonly_dir</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;readonly&quot;</span>
    <span class="n">readonly_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

    <span class="c1"># Make directory read-only</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">readonly_dir</span><span class="p">,</span> <span class="mo">0o444</span><span class="p">)</span>

    <span class="n">config_file</span> <span class="o">=</span> <span class="n">readonly_dir</span> <span class="o">/</span> <span class="s2">&quot;config.json&quot;</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">config_file</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">PermissionError</span><span class="p">):</span>
            <span class="n">manager</span><span class="o">.</span><span class="n">save_config</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">})</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Restore permissions for cleanup</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">readonly_dir</span><span class="p">,</span> <span class="mo">0o755</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_save_creates_parent_directories</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Saving should create parent directories if they don&#39;t exist.&quot;&quot;&quot;</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;a&quot;</span> <span class="o">/</span> <span class="s2">&quot;b&quot;</span> <span class="o">/</span> <span class="s2">&quot;c&quot;</span> <span class="o">/</span> <span class="s2">&quot;config.json&quot;</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">config_file</span><span class="p">))</span>

    <span class="c1"># Parent directories don&#39;t exist yet</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">config_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

    <span class="c1"># Save should create them</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">save_config</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">})</span>

    <span class="k">assert</span> <span class="n">config_file</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">config_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_config_manager_errors.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_config_manager_errors.py::test_load_nonexistent_file PASSED
test_config_manager_errors.py::test_load_invalid_json PASSED
test_config_manager_errors.py::test_save_to_readonly_directory PASSED
test_config_manager_errors.py::test_save_creates_parent_directories PASSED
</code></pre></div>

<p>Perfect! Now let's test with different file formats.</p>
<h2 id="strategy-7-testing-multiple-file-formats">Strategy 7: Testing Multiple File Formats</h2>
<p>Test code that handles different file types:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># file_processor.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FileProcessor</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read JSON file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">write_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write JSON file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read CSV file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">write_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">fieldnames</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write CSV file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read text file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">write_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write text file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_file_processor.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">file_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">FileProcessor</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_json_roundtrip</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test reading and writing JSON.&quot;&quot;&quot;</span>
    <span class="n">json_file</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;data.json&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">FileProcessor</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">json_file</span><span class="p">))</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">loaded</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">read_json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">loaded</span> <span class="o">==</span> <span class="n">data</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_csv_roundtrip</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test reading and writing CSV.&quot;&quot;&quot;</span>
    <span class="n">csv_file</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;data.csv&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">FileProcessor</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">csv_file</span><span class="p">))</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="s2">&quot;30&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Bob&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="s2">&quot;25&quot;</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">processor</span><span class="o">.</span><span class="n">write_csv</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">])</span>

    <span class="n">loaded</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">read_csv</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">loaded</span> <span class="o">==</span> <span class="n">data</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_text_roundtrip</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test reading and writing text.&quot;&quot;&quot;</span>
    <span class="n">text_file</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;data.txt&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">FileProcessor</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">text_file</span><span class="p">))</span>

    <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;Hello, World!</span><span class="se">\n</span><span class="s2">This is a test.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

    <span class="n">loaded</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">loaded</span> <span class="o">==</span> <span class="n">content</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_multiline_text</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test text file with multiple lines.&quot;&quot;&quot;</span>
    <span class="n">text_file</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;multiline.txt&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">FileProcessor</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">text_file</span><span class="p">))</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Line 1&quot;</span><span class="p">,</span> <span class="s2">&quot;Line 2&quot;</span><span class="p">,</span> <span class="s2">&quot;Line 3&quot;</span><span class="p">]</span>
    <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="n">processor</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

    <span class="n">loaded</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">loaded</span> <span class="o">==</span> <span class="n">content</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_file_processor.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_file_processor.py::test_json_roundtrip PASSED
test_file_processor.py::test_csv_roundtrip PASSED
test_file_processor.py::test_text_roundtrip PASSED
test_file_processor.py::test_multiline_text PASSED
</code></pre></div>

<h2 id="decision-framework-file-testing-strategies">Decision Framework: File Testing Strategies</h2>
<table>
<thead>
<tr>
<th>Strategy</th>
<th>Setup Complexity</th>
<th>Isolation</th>
<th>Best For</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Manual cleanup</strong></td>
<td>Low</td>
<td>Good</td>
<td>Simple tests, learning</td>
</tr>
<tr>
<td><strong>Unique filenames</strong></td>
<td>Low</td>
<td>Good</td>
<td>Parallel tests, quick fixes</td>
</tr>
<tr>
<td><strong>tempfile module</strong></td>
<td>Medium</td>
<td>Perfect</td>
<td>Cross-platform, production code</td>
</tr>
<tr>
<td><strong>tmp_path fixture</strong></td>
<td>Low</td>
<td>Perfect</td>
<td>Pytest tests, recommended</td>
</tr>
<tr>
<td><strong>tmp_path_factory</strong></td>
<td>Medium</td>
<td>Perfect</td>
<td>Session-scoped files, shared fixtures</td>
</tr>
</tbody>
</table>
<h3 id="when-to-apply-each-solution_2">When to Apply Each Solution</h3>
<p><strong>tmp_path fixture</strong> (recommended):
- ‚úÖ Function-scoped temporary directory
- ‚úÖ Automatic cleanup
- ‚úÖ pathlib.Path object (modern Python)
- ‚úÖ Isolated per test
- ‚ùå Can't share files between tests</p>
<p><strong>tmp_path_factory</strong>:
- ‚úÖ Create temporary directories with custom scope
- ‚úÖ Share files between tests
- ‚úÖ More control over lifecycle
- ‚ùå More complex setup</p>
<p><strong>Manual cleanup</strong>:
- ‚úÖ Simple to understand
- ‚úÖ Full control
- ‚ùå Easy to forget cleanup
- ‚ùå Not parallel-safe</p>
<h2 id="common-failure-modes-and-their-signatures_4">Common Failure Modes and Their Signatures</h2>
<h3 id="symptom-file-not-found-after-test">Symptom: File not found after test</h3>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>FileNotFoundError: [Errno 2] No such file or directory: &#39;/tmp/pytest-123/test_file.txt&#39;
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- File path from temporary directory
- File existed during test but gone after
- Cleanup happened too early</p>
<p><strong>Root cause</strong>: Temporary directory cleaned up before test finished</p>
<p><strong>Solution</strong>: Ensure fixture scope matches test needs, use <code>yield</code> correctly</p>
<h3 id="symptom-tests-interfere-with-each-other_1">Symptom: Tests interfere with each other</h3>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>AssertionError: assert {&#39;key&#39;: &#39;value1&#39;, &#39;key2&#39;: &#39;value2&#39;} == {&#39;key&#39;: &#39;value1&#39;}
# Extra data from previous test
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Tests pass individually but fail together
- File contains data from previous test
- Shared file path</p>
<p><strong>Root cause</strong>: Tests using same file path without cleanup</p>
<p><strong>Solution</strong>: Use <code>tmp_path</code> fixture for per-test isolation</p>
<h3 id="symptom-permission-denied-errors">Symptom: Permission denied errors</h3>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>PermissionError: [Errno 13] Permission denied: &#39;/tmp/readonly/file.txt&#39;
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Permission error on file or directory
- Test modifying permissions
- Cleanup failing</p>
<p><strong>Root cause</strong>: Test changed permissions and didn't restore them</p>
<p><strong>Solution</strong>: Use try/finally to restore permissions, or use <code>tmp_path</code> which handles cleanup</p>
<h2 id="working-with-temporary-files-and-directories">Working with Temporary Files and Directories</h2>
<h2 id="advanced-temporary-file-patterns">Advanced Temporary File Patterns</h2>
<p>In the previous section, we introduced <code>tmp_path</code> for basic file testing. Now let's explore advanced patterns for complex scenarios: sharing files between tests, testing with large file structures, and handling binary files.</p>
<h2 id="iteration-1-session-scoped-temporary-directories">Iteration 1: Session-Scoped Temporary Directories</h2>
<p>Sometimes you need to share files across multiple tests:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_shared_temp.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">shared_data_dir</span><span class="p">(</span><span class="n">tmp_path_factory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a session-scoped temporary directory.&quot;&quot;&quot;</span>
    <span class="n">data_dir</span> <span class="o">=</span> <span class="n">tmp_path_factory</span><span class="o">.</span><span class="n">mktemp</span><span class="p">(</span><span class="s2">&quot;shared_data&quot;</span><span class="p">)</span>

    <span class="c1"># Create some shared test data</span>
    <span class="p">(</span><span class="n">data_dir</span> <span class="o">/</span> <span class="s2">&quot;reference.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;Reference data&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">data_dir</span> <span class="o">/</span> <span class="s2">&quot;config.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s1">&#39;{&quot;version&quot;: &quot;1.0&quot;}&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data_dir</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_read_reference</span><span class="p">(</span><span class="n">shared_data_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;First test reads reference data.&quot;&quot;&quot;</span>
    <span class="n">content</span> <span class="o">=</span> <span class="p">(</span><span class="n">shared_data_dir</span> <span class="o">/</span> <span class="s2">&quot;reference.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">content</span> <span class="o">==</span> <span class="s2">&quot;Reference data&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_read_config</span><span class="p">(</span><span class="n">shared_data_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Second test reads config.&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">((</span><span class="n">shared_data_dir</span> <span class="o">/</span> <span class="s2">&quot;config.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
    <span class="k">assert</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1.0&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_both_files_exist</span><span class="p">(</span><span class="n">shared_data_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Third test verifies both files exist.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">shared_data_dir</span> <span class="o">/</span> <span class="s2">&quot;reference.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">shared_data_dir</span> <span class="o">/</span> <span class="s2">&quot;config.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_shared_temp.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_shared_temp.py::test_read_reference PASSED
test_shared_temp.py::test_read_config PASSED
test_shared_temp.py::test_both_files_exist PASSED
</code></pre></div>

<p>Good! But what if tests need to modify files? Let's see what happens:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_shared_temp_modification.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">shared_data_dir</span><span class="p">(</span><span class="n">tmp_path_factory</span><span class="p">):</span>
    <span class="n">data_dir</span> <span class="o">=</span> <span class="n">tmp_path_factory</span><span class="o">.</span><span class="n">mktemp</span><span class="p">(</span><span class="s2">&quot;shared_data&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">data_dir</span> <span class="o">/</span> <span class="s2">&quot;counter.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_dir</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_increment_counter_first</span><span class="p">(</span><span class="n">shared_data_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;First test increments counter.&quot;&quot;&quot;</span>
    <span class="n">counter_file</span> <span class="o">=</span> <span class="n">shared_data_dir</span> <span class="o">/</span> <span class="s2">&quot;counter.txt&quot;</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">counter_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
    <span class="n">counter_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">assert</span> <span class="nb">int</span><span class="p">(</span><span class="n">counter_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_increment_counter_second</span><span class="p">(</span><span class="n">shared_data_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Second test also increments counter.&quot;&quot;&quot;</span>
    <span class="n">counter_file</span> <span class="o">=</span> <span class="n">shared_data_dir</span> <span class="o">/</span> <span class="s2">&quot;counter.txt&quot;</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">counter_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
    <span class="n">counter_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># What value do we expect?</span>
    <span class="k">assert</span> <span class="nb">int</span><span class="p">(</span><span class="n">counter_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_shared_temp_modification.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_shared_temp_modification.py::test_increment_counter_first PASSED
test_shared_temp_modification.py::test_increment_counter_second PASSED
</code></pre></div>

<h3 id="diagnostic-analysis-shared-state-in-session-fixtures">Diagnostic Analysis: Shared State in Session Fixtures</h3>
<p><strong>The complete output</strong>:</p>
<p>Both tests pass, but they're sharing state through the file.</p>
<p><strong>Let's parse this section by section</strong>:</p>
<ol>
<li><strong>The session scope</strong>: The fixture creates the directory once for all tests</li>
<li>What this tells us: All tests see the same files</li>
<li>
<p>Modifications persist across tests</p>
</li>
<li>
<p><strong>The test order dependency</strong>: <code>test_increment_counter_second</code> expects the counter to be 1 (from the first test)</p>
</li>
<li>What this tells us: Tests are not isolated</li>
<li>Test order matters</li>
</ol>
<p><strong>Root cause identified</strong>: Session-scoped fixtures create shared state, which can lead to test interdependencies.</p>
<p><strong>Why the current approach can't solve this</strong>: Session scope is intentional for sharing, but we need to be careful about modifications.</p>
<p><strong>What we need</strong>: Either (1) read-only shared data, or (2) per-test copies of shared data.</p>
<h2 id="iteration-2-read-only-shared-data-with-per-test-copies">Iteration 2: Read-Only Shared Data with Per-Test Copies</h2>
<p>Create shared reference data but give each test its own copy:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_copy_pattern.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">reference_data</span><span class="p">(</span><span class="n">tmp_path_factory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create reference data once.&quot;&quot;&quot;</span>
    <span class="n">data_dir</span> <span class="o">=</span> <span class="n">tmp_path_factory</span><span class="o">.</span><span class="n">mktemp</span><span class="p">(</span><span class="s2">&quot;reference&quot;</span><span class="p">)</span>

    <span class="c1"># Create reference files</span>
    <span class="p">(</span><span class="n">data_dir</span> <span class="o">/</span> <span class="s2">&quot;template.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;Template content&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">data_dir</span> <span class="o">/</span> <span class="s2">&quot;schema.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s1">&#39;{&quot;type&quot;: &quot;object&quot;}&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data_dir</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_data</span><span class="p">(</span><span class="n">reference_data</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Copy reference data for each test.&quot;&quot;&quot;</span>
    <span class="c1"># Copy all files from reference to test-specific directory</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">reference_data</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tmp_path</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_modify_template</span><span class="p">(</span><span class="n">test_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Modify template without affecting other tests.&quot;&quot;&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">test_data</span> <span class="o">/</span> <span class="s2">&quot;template.txt&quot;</span>
    <span class="n">template</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;Modified content&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">template</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Modified content&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_template_unchanged</span><span class="p">(</span><span class="n">test_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify template is unchanged from reference.&quot;&quot;&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">test_data</span> <span class="o">/</span> <span class="s2">&quot;template.txt&quot;</span>

    <span class="c1"># Should be original content, not modified</span>
    <span class="k">assert</span> <span class="n">template</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Template content&quot;</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_copy_pattern.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_copy_pattern.py::test_modify_template PASSED
test_copy_pattern.py::test_template_unchanged PASSED
</code></pre></div>

<p>Perfect isolation! Each test gets its own copy of the reference data.</p>
<h2 id="iteration-3-complex-directory-structures">Iteration 3: Complex Directory Structures</h2>
<p>Test code that works with nested directories:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># directory_scanner.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DirectoryScanner</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">count_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Count files, optionally filtered by extension.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">extension</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;*.</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)))</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*.*&quot;</span><span class="p">)))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find files matching a pattern.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="n">pattern</span><span class="p">)]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_directory_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a tree structure of directories.&quot;&quot;&quot;</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">relative</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_path</span><span class="p">)</span>
                <span class="n">tree</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">relative</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()</span>
                <span class="p">]</span>
        <span class="k">return</span> <span class="n">tree</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_directory_scanner.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">directory_scanner</span><span class="w"> </span><span class="kn">import</span> <span class="n">DirectoryScanner</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">complex_directory</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a complex directory structure.&quot;&quot;&quot;</span>
    <span class="c1"># Create directory structure</span>
    <span class="p">(</span><span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
    <span class="p">(</span><span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span> <span class="o">/</span> <span class="s2">&quot;main.py&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;# main&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span> <span class="o">/</span> <span class="s2">&quot;utils.py&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;# utils&quot;</span><span class="p">)</span>

    <span class="p">(</span><span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;tests&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
    <span class="p">(</span><span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;tests&quot;</span> <span class="o">/</span> <span class="s2">&quot;test_main.py&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;# test&quot;</span><span class="p">)</span>

    <span class="p">(</span><span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;docs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
    <span class="p">(</span><span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;docs&quot;</span> <span class="o">/</span> <span class="s2">&quot;readme.md&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;# README&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;docs&quot;</span> <span class="o">/</span> <span class="s2">&quot;guide.md&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;# Guide&quot;</span><span class="p">)</span>

    <span class="p">(</span><span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
    <span class="p">(</span><span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;input.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;output.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tmp_path</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_count_all_files</span><span class="p">(</span><span class="n">complex_directory</span><span class="p">):</span>
    <span class="n">scanner</span> <span class="o">=</span> <span class="n">DirectoryScanner</span><span class="p">(</span><span class="n">complex_directory</span><span class="p">)</span>

    <span class="c1"># Should find all 7 files</span>
    <span class="k">assert</span> <span class="n">scanner</span><span class="o">.</span><span class="n">count_files</span><span class="p">()</span> <span class="o">==</span> <span class="mi">7</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_count_python_files</span><span class="p">(</span><span class="n">complex_directory</span><span class="p">):</span>
    <span class="n">scanner</span> <span class="o">=</span> <span class="n">DirectoryScanner</span><span class="p">(</span><span class="n">complex_directory</span><span class="p">)</span>

    <span class="c1"># Should find 3 .py files</span>
    <span class="k">assert</span> <span class="n">scanner</span><span class="o">.</span><span class="n">count_files</span><span class="p">(</span><span class="s2">&quot;py&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_count_markdown_files</span><span class="p">(</span><span class="n">complex_directory</span><span class="p">):</span>
    <span class="n">scanner</span> <span class="o">=</span> <span class="n">DirectoryScanner</span><span class="p">(</span><span class="n">complex_directory</span><span class="p">)</span>

    <span class="c1"># Should find 2 .md files</span>
    <span class="k">assert</span> <span class="n">scanner</span><span class="o">.</span><span class="n">count_files</span><span class="p">(</span><span class="s2">&quot;md&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_find_test_files</span><span class="p">(</span><span class="n">complex_directory</span><span class="p">):</span>
    <span class="n">scanner</span> <span class="o">=</span> <span class="n">DirectoryScanner</span><span class="p">(</span><span class="n">complex_directory</span><span class="p">)</span>

    <span class="c1"># Find all test files</span>
    <span class="n">test_files</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="n">find_files</span><span class="p">(</span><span class="s2">&quot;test_*.py&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="s2">&quot;test_main.py&quot;</span> <span class="ow">in</span> <span class="n">test_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_directory_tree</span><span class="p">(</span><span class="n">complex_directory</span><span class="p">):</span>
    <span class="n">scanner</span> <span class="o">=</span> <span class="n">DirectoryScanner</span><span class="p">(</span><span class="n">complex_directory</span><span class="p">)</span>

    <span class="n">tree</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="n">get_directory_tree</span><span class="p">()</span>

    <span class="c1"># Verify structure</span>
    <span class="k">assert</span> <span class="s2">&quot;src&quot;</span> <span class="ow">in</span> <span class="n">tree</span>
    <span class="k">assert</span> <span class="s2">&quot;tests&quot;</span> <span class="ow">in</span> <span class="n">tree</span>
    <span class="k">assert</span> <span class="s2">&quot;docs&quot;</span> <span class="ow">in</span> <span class="n">tree</span>
    <span class="k">assert</span> <span class="s2">&quot;data&quot;</span> <span class="ow">in</span> <span class="n">tree</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_directory_scanner.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_directory_scanner.py::test_count_all_files PASSED
test_directory_scanner.py::test_count_python_files PASSED
test_directory_scanner.py::test_count_markdown_files PASSED
test_directory_scanner.py::test_find_test_files PASSED
test_directory_scanner.py::test_directory_tree PASSED
</code></pre></div>

<p>Excellent! Now let's test with binary files.</p>
<h2 id="iteration-4-binary-file-handling">Iteration 4: Binary File Handling</h2>
<p>Test code that works with binary files:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># image_processor.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ImageProcessor</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_file_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get file size in bytes.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_bytes</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read the first N bytes of the file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">num_bytes</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_png</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if file is a PNG image.&quot;&quot;&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_header</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="c1"># PNG signature: 89 50 4E 47 0D 0A 1A 0A</span>
        <span class="k">return</span> <span class="n">header</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x89</span><span class="s1">PNG</span><span class="se">\r\n\x1a\n</span><span class="s1">&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_jpeg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if file is a JPEG image.&quot;&quot;&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_header</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># JPEG signature: FF D8</span>
        <span class="k">return</span> <span class="n">header</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xff\xd8</span><span class="s1">&#39;</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_image_processor.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">image_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageProcessor</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">png_file</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a minimal PNG file.&quot;&quot;&quot;</span>
    <span class="n">png_path</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;test.png&quot;</span>

    <span class="c1"># PNG signature + minimal IHDR chunk</span>
    <span class="n">png_data</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x89</span><span class="s1">PNG</span><span class="se">\r\n\x1a\n</span><span class="s1">&#39;</span>  <span class="c1"># PNG signature</span>
        <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00\x00\r</span><span class="s1">IHDR&#39;</span>  <span class="c1"># IHDR chunk</span>
        <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00\x00\x01</span><span class="s1">&#39;</span>  <span class="c1"># Width: 1</span>
        <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00\x00\x01</span><span class="s1">&#39;</span>  <span class="c1"># Height: 1</span>
        <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x08\x02\x00\x00\x00</span><span class="s1">&#39;</span>  <span class="c1"># Bit depth, color type, etc.</span>
        <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x90</span><span class="s1">wS</span><span class="se">\xde</span><span class="s1">&#39;</span>  <span class="c1"># CRC</span>
    <span class="p">)</span>

    <span class="n">png_path</span><span class="o">.</span><span class="n">write_bytes</span><span class="p">(</span><span class="n">png_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">png_path</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">jpeg_file</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a minimal JPEG file.&quot;&quot;&quot;</span>
    <span class="n">jpeg_path</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;test.jpg&quot;</span>

    <span class="c1"># JPEG signature + minimal structure</span>
    <span class="n">jpeg_data</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xff\xd8</span><span class="s1">&#39;</span>  <span class="c1"># JPEG signature (SOI)</span>
        <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xff\xe0</span><span class="s1">&#39;</span>  <span class="c1"># APP0 marker</span>
        <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x10</span><span class="s1">&#39;</span>  <span class="c1"># Length</span>
        <span class="sa">b</span><span class="s1">&#39;JFIF</span><span class="se">\x00</span><span class="s1">&#39;</span>  <span class="c1"># Identifier</span>
        <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x01\x01</span><span class="s1">&#39;</span>  <span class="c1"># Version</span>
        <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span>  <span class="c1"># Units</span>
        <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x01\x00\x01</span><span class="s1">&#39;</span>  <span class="c1"># X/Y density</span>
        <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00</span><span class="s1">&#39;</span>  <span class="c1"># Thumbnail</span>
        <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xff\xd9</span><span class="s1">&#39;</span>  <span class="c1"># EOI marker</span>
    <span class="p">)</span>

    <span class="n">jpeg_path</span><span class="o">.</span><span class="n">write_bytes</span><span class="p">(</span><span class="n">jpeg_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jpeg_path</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_png_detection</span><span class="p">(</span><span class="n">png_file</span><span class="p">):</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">ImageProcessor</span><span class="p">(</span><span class="n">png_file</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">processor</span><span class="o">.</span><span class="n">is_png</span><span class="p">()</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">processor</span><span class="o">.</span><span class="n">is_jpeg</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_jpeg_detection</span><span class="p">(</span><span class="n">jpeg_file</span><span class="p">):</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">ImageProcessor</span><span class="p">(</span><span class="n">jpeg_file</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">processor</span><span class="o">.</span><span class="n">is_jpeg</span><span class="p">()</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">processor</span><span class="o">.</span><span class="n">is_png</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_file_size</span><span class="p">(</span><span class="n">png_file</span><span class="p">):</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">ImageProcessor</span><span class="p">(</span><span class="n">png_file</span><span class="p">)</span>

    <span class="c1"># Our minimal PNG is 33 bytes</span>
    <span class="k">assert</span> <span class="n">processor</span><span class="o">.</span><span class="n">get_file_size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">33</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_read_header</span><span class="p">(</span><span class="n">png_file</span><span class="p">):</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">ImageProcessor</span><span class="p">(</span><span class="n">png_file</span><span class="p">)</span>

    <span class="n">header</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">read_header</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">header</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x89</span><span class="s1">PNG</span><span class="se">\r\n\x1a\n</span><span class="s1">&#39;</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_image_processor.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_image_processor.py::test_png_detection PASSED
test_image_processor.py::test_jpeg_detection PASSED
test_image_processor.py::test_file_size PASSED
test_image_processor.py::test_read_header PASSED
</code></pre></div>

<p>Perfect! Now let's test with large files.</p>
<h2 id="iteration-5-large-file-handling">Iteration 5: Large File Handling</h2>
<p>Test code that processes large files efficiently:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># file_chunker.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FileChunker</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span> <span class="o">=</span> <span class="n">chunk_size</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">count_chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Count how many chunks the file contains.&quot;&quot;&quot;</span>
        <span class="n">file_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">file_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_number</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read a specific chunk.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">chunk_number</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_in_chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor_func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process file in chunks.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">processor_func</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_file_chunker.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">file_chunker</span><span class="w"> </span><span class="kn">import</span> <span class="n">FileChunker</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">large_file</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a large test file.&quot;&quot;&quot;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;large.bin&quot;</span>

    <span class="c1"># Create a 10KB file</span>
    <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;A&#39;</span> <span class="o">*</span> <span class="mi">10240</span>
    <span class="n">file_path</span><span class="o">.</span><span class="n">write_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">file_path</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_count_chunks</span><span class="p">(</span><span class="n">large_file</span><span class="p">):</span>
    <span class="n">chunker</span> <span class="o">=</span> <span class="n">FileChunker</span><span class="p">(</span><span class="n">large_file</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>

    <span class="c1"># 10KB / 1KB = 10 chunks</span>
    <span class="k">assert</span> <span class="n">chunker</span><span class="o">.</span><span class="n">count_chunks</span><span class="p">()</span> <span class="o">==</span> <span class="mi">10</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_read_first_chunk</span><span class="p">(</span><span class="n">large_file</span><span class="p">):</span>
    <span class="n">chunker</span> <span class="o">=</span> <span class="n">FileChunker</span><span class="p">(</span><span class="n">large_file</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>

    <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunker</span><span class="o">.</span><span class="n">read_chunk</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1024</span>
    <span class="k">assert</span> <span class="n">chunk</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;A&#39;</span> <span class="o">*</span> <span class="mi">1024</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_read_last_chunk</span><span class="p">(</span><span class="n">large_file</span><span class="p">):</span>
    <span class="n">chunker</span> <span class="o">=</span> <span class="n">FileChunker</span><span class="p">(</span><span class="n">large_file</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>

    <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunker</span><span class="o">.</span><span class="n">read_chunk</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>  <span class="c1"># Last chunk</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1024</span>
    <span class="k">assert</span> <span class="n">chunk</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;A&#39;</span> <span class="o">*</span> <span class="mi">1024</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_process_in_chunks</span><span class="p">(</span><span class="n">large_file</span><span class="p">):</span>
    <span class="n">chunker</span> <span class="o">=</span> <span class="n">FileChunker</span><span class="p">(</span><span class="n">large_file</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>

    <span class="c1"># Count bytes in each chunk</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">chunker</span><span class="o">.</span><span class="n">process_in_chunks</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1024</span> <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">results</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_uneven_chunks</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test file that doesn&#39;t divide evenly into chunks.&quot;&quot;&quot;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;uneven.bin&quot;</span>
    <span class="n">file_path</span><span class="o">.</span><span class="n">write_bytes</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;B&#39;</span> <span class="o">*</span> <span class="mi">2500</span><span class="p">)</span>  <span class="c1"># 2.5 KB</span>

    <span class="n">chunker</span> <span class="o">=</span> <span class="n">FileChunker</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>

    <span class="c1"># Should be 3 chunks (1024 + 1024 + 452)</span>
    <span class="k">assert</span> <span class="n">chunker</span><span class="o">.</span><span class="n">count_chunks</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="c1"># Last chunk should be partial</span>
    <span class="n">last_chunk</span> <span class="o">=</span> <span class="n">chunker</span><span class="o">.</span><span class="n">read_chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">last_chunk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">452</span>
</code></pre></div>

<p>Run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test_file_chunker.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_file_chunker.py::test_count_chunks PASSED
test_file_chunker.py::test_read_first_chunk PASSED
test_file_chunker.py::test_read_last_chunk PASSED
test_file_chunker.py::test_process_in_chunks PASSED
test_file_chunker.py::test_uneven_chunks PASSED
</code></pre></div>

<h2 id="the-complete-temporary-file-toolkit">The Complete Temporary File Toolkit</h2>
<p>Here's a comprehensive fixture setup for file testing:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (complete file testing setup)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">reference_files</span><span class="p">(</span><span class="n">tmp_path_factory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create reference files once for all tests.&quot;&quot;&quot;</span>
    <span class="n">ref_dir</span> <span class="o">=</span> <span class="n">tmp_path_factory</span><span class="o">.</span><span class="n">mktemp</span><span class="p">(</span><span class="s2">&quot;reference&quot;</span><span class="p">)</span>

    <span class="c1"># Text files</span>
    <span class="p">(</span><span class="n">ref_dir</span> <span class="o">/</span> <span class="s2">&quot;template.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;Template content&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">ref_dir</span> <span class="o">/</span> <span class="s2">&quot;config.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s1">&#39;{&quot;version&quot;: &quot;1.0&quot;}&#39;</span><span class="p">)</span>

    <span class="c1"># Binary files</span>
    <span class="p">(</span><span class="n">ref_dir</span> <span class="o">/</span> <span class="s2">&quot;data.bin&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_bytes</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x01\x02\x03</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ref_dir</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_files</span><span class="p">(</span><span class="n">reference_files</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Copy reference files for each test.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">reference_files</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tmp_path</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">empty_directory</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide an empty directory.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">tmp_path</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">nested_directory</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a nested directory structure.&quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;level1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
    <span class="p">(</span><span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;level1&quot;</span> <span class="o">/</span> <span class="s2">&quot;level2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
    <span class="p">(</span><span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;level1&quot;</span> <span class="o">/</span> <span class="s2">&quot;level2&quot;</span> <span class="o">/</span> <span class="s2">&quot;level3&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">tmp_path</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">project_structure</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a typical project structure.&quot;&quot;&quot;</span>
    <span class="c1"># Source directory</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span>
    <span class="n">src</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
    <span class="p">(</span><span class="n">src</span> <span class="o">/</span> <span class="s2">&quot;__init__.py&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">src</span> <span class="o">/</span> <span class="s2">&quot;main.py&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;# main&quot;</span><span class="p">)</span>

    <span class="c1"># Tests directory</span>
    <span class="n">tests</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;tests&quot;</span>
    <span class="n">tests</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
    <span class="p">(</span><span class="n">tests</span> <span class="o">/</span> <span class="s2">&quot;__init__.py&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">tests</span> <span class="o">/</span> <span class="s2">&quot;test_main.py&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;# test&quot;</span><span class="p">)</span>

    <span class="c1"># Docs directory</span>
    <span class="n">docs</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;docs&quot;</span>
    <span class="n">docs</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
    <span class="p">(</span><span class="n">docs</span> <span class="o">/</span> <span class="s2">&quot;README.md&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;# README&quot;</span><span class="p">)</span>

    <span class="c1"># Config files</span>
    <span class="p">(</span><span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;setup.py&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;# setup&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;requirements.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;pytest</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tmp_path</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">binary_file</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a binary file with known content.&quot;&quot;&quot;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;binary.dat&quot;</span>
    <span class="n">file_path</span><span class="o">.</span><span class="n">write_bytes</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">file_path</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">large_text_file</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a large text file.&quot;&quot;&quot;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;large.txt&quot;</span>

    <span class="c1"># Create 1MB of text</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Line </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100000</span><span class="p">)]</span>
    <span class="n">file_path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">file_path</span>
</code></pre></div>

<h2 id="decision-framework-temporary-file-strategies">Decision Framework: Temporary File Strategies</h2>
<table>
<thead>
<tr>
<th>Strategy</th>
<th>Scope</th>
<th>Isolation</th>
<th>Best For</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>tmp_path</strong></td>
<td>Function</td>
<td>Perfect</td>
<td>Most tests, default choice</td>
</tr>
<tr>
<td><strong>tmp_path_factory</strong></td>
<td>Custom</td>
<td>Perfect</td>
<td>Session-scoped, shared reference data</td>
</tr>
<tr>
<td><strong>Reference + Copy</strong></td>
<td>Mixed</td>
<td>Perfect</td>
<td>Expensive setup, read-mostly data</td>
</tr>
<tr>
<td><strong>In-memory (io.BytesIO)</strong></td>
<td>Function</td>
<td>Perfect</td>
<td>Small files, no disk I/O needed</td>
</tr>
</tbody>
</table>
<h3 id="when-to-apply-each-solution_3">When to Apply Each Solution</h3>
<p><strong>tmp_path</strong> (recommended default):
- ‚úÖ Function-scoped isolation
- ‚úÖ Automatic cleanup
- ‚úÖ pathlib.Path interface
- ‚úÖ Simple and clear
- ‚ùå Can't share between tests</p>
<p><strong>tmp_path_factory + session scope</strong>:
- ‚úÖ Share expensive setup across tests
- ‚úÖ Create reference data once
- ‚úÖ Custom scope control
- ‚ùå Risk of test interdependency
- ‚ùå More complex</p>
<p><strong>Reference + Copy pattern</strong>:
- ‚úÖ Best of both worlds: shared setup, isolated tests
- ‚úÖ Each test gets fresh copy
- ‚úÖ Safe for modifications
- ‚ùå Extra copy overhead</p>
<p><strong>In-memory files (io.BytesIO)</strong>:
- ‚úÖ No disk I/O
- ‚úÖ Fastest
- ‚úÖ No cleanup needed
- ‚ùå Limited to small files
- ‚ùå Can't test actual file operations</p>
<h2 id="common-failure-modes-and-their-signatures_5">Common Failure Modes and Their Signatures</h2>
<h3 id="symptom-temporary-directory-not-cleaned-up">Symptom: Temporary directory not cleaned up</h3>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>$ ls /tmp/pytest-of-user/
pytest-0  pytest-1  pytest-2  pytest-3  # Many old directories
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Multiple pytest temporary directories
- Directories not being removed
- Disk space growing</p>
<p><strong>Root cause</strong>: Pytest cleanup failed (crash, interrupt, or permission issue)</p>
<p><strong>Solution</strong>: Pytest cleans up automatically on normal exit; manual cleanup: <code>pytest --basetemp=/tmp/pytest-custom</code></p>
<h3 id="symptom-tests-fail-due-to-file-permissions">Symptom: Tests fail due to file permissions</h3>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>PermissionError: [Errno 13] Permission denied: &#39;/tmp/pytest-123/readonly/file.txt&#39;
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Permission error in temporary directory
- Test modified permissions
- Cleanup failing</p>
<p><strong>Root cause</strong>: Test changed file/directory permissions and didn't restore them</p>
<p><strong>Solution</strong>: Always restore permissions in finally block or use context managers</p>
<h3 id="symptom-session-scoped-fixture-causing-test-interdependency">Symptom: Session-scoped fixture causing test interdependency</h3>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_first PASSED
test_second FAILED  # Expects different state than test_first left
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Tests pass individually
- Fail when run together
- Session-scoped fixture involved</p>
<p><strong>Root cause</strong>: Tests modifying shared session-scoped files</p>
<p><strong>Solution</strong>: Use reference + copy pattern, or switch to function-scoped fixtures</p>
        </div>
        <div class="footer">
            Generated on 2025-12-03 10:37:06 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>