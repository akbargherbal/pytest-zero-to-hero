<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>13 Coverage and Metrics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">04 Testing Patterns and Advanced Scenarios</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-13-coverage-and-metrics">Chapter 13: Coverage and Metrics</h1>
<h2 id="introduction-to-code-coverage">Introduction to Code Coverage</h2>
<h2 id="what-code-coverage-actually-measures">What Code Coverage Actually Measures</h2>
<p>Code coverage is a metric that tells you <strong>which lines of your code were executed during your test run</strong>. It's not a measure of test quality‚Äîit's a measure of test reach.</p>
<p>Think of it this way: if you have a function with 10 lines of code, and your tests only execute 7 of those lines, you have 70% coverage. The other 3 lines? They might contain bugs, edge cases, or dead code‚Äîand you'd never know because your tests never touch them.</p>
<h3 id="the-mental-model-coverage-as-a-flashlight">The Mental Model: Coverage as a Flashlight</h3>
<p>Imagine your codebase is a dark room. Each test is a flashlight beam. Coverage tells you which parts of the room your flashlights have illuminated. High coverage means you've lit up most of the room. But here's the critical insight: <strong>just because you've shined light on something doesn't mean you've examined it carefully</strong>.</p>
<p>You could have 100% coverage and still have bugs. Coverage tells you where you've looked, not whether you looked carefully.</p>
<h3 id="what-coverage-measures-and-doesnt">What Coverage Measures (and Doesn't)</h3>
<p><strong>Coverage measures</strong>:
- Which lines of code were executed
- Which branches (if/else paths) were taken
- Which functions were called</p>
<p><strong>Coverage does NOT measure</strong>:
- Whether your assertions are correct
- Whether you tested edge cases thoroughly
- Whether your tests are meaningful
- Code quality or design</p>
<h3 id="why-coverage-matters-despite-its-limitations">Why Coverage Matters Despite Its Limitations</h3>
<p>Coverage is valuable because:</p>
<ol>
<li><strong>It reveals blind spots</strong>: If a function has 0% coverage, you definitely haven't tested it</li>
<li><strong>It guides test writing</strong>: Low coverage areas are candidates for more tests</li>
<li><strong>It prevents regression</strong>: When coverage drops, you know something changed</li>
<li><strong>It's measurable</strong>: Unlike "test quality," coverage is objective and automatable</li>
</ol>
<p>But remember: <strong>coverage is a necessary condition for good testing, not a sufficient one</strong>. You need high coverage AND good tests.</p>
<h3 id="the-reference-implementation-a-payment-processor">The Reference Implementation: A Payment Processor</h3>
<p>Throughout this chapter, we'll work with a realistic payment processing system. This will be our anchor example‚Äîwe'll measure its coverage, identify gaps, and progressively improve our test suite.</p>
<p>Here's our production code:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_processor.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base exception for payment processing errors.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">InsufficientFundsError</span><span class="p">(</span><span class="n">PaymentError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when account has insufficient funds.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">InvalidAmountError</span><span class="p">(</span><span class="n">PaymentError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when payment amount is invalid.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Processes payments with validation and fraud detection.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fraud_threshold</span><span class="p">:</span> <span class="n">Decimal</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10000.00&quot;</span><span class="p">)):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fraud_threshold</span> <span class="o">=</span> <span class="n">fraud_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transaction_log</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">amount</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span>
        <span class="n">account_balance</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">bypass_fraud_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process a payment transaction.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict with keys: success, transaction_id, timestamp, message</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate amount</span>
        <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidAmountError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Amount must be positive, got </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check for suspicious amounts</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bypass_fraud_check</span> <span class="ow">and</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraud_threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Transaction flagged for fraud review: amount </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2"> exceeds threshold&quot;</span>
            <span class="p">}</span>

        <span class="c1"># Check sufficient funds</span>
        <span class="k">if</span> <span class="n">account_balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InsufficientFundsError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Insufficient funds: balance </span><span class="si">{</span><span class="n">account_balance</span><span class="si">}</span><span class="s2">, required </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Process the payment</span>
        <span class="n">transaction_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_transaction_id</span><span class="p">()</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transaction_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">transaction_id</span><span class="p">,</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">transaction_id</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Payment processed successfully&quot;</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_transaction_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a unique transaction ID.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;TXN-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction_log</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_transaction_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve transaction history, optionally limited to most recent N.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_log</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_log</span><span class="p">[</span><span class="o">-</span><span class="n">limit</span><span class="p">:]</span> <span class="k">if</span> <span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_total_processed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decimal</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate total amount processed across all transactions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="p">(</span><span class="n">tx</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_log</span><span class="p">),</span>
            <span class="n">start</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div>

<p>This is a realistic payment processor with multiple code paths:
- Amount validation
- Fraud detection
- Balance checking
- Transaction logging
- History retrieval</p>
<p>Now let's write some initial tests‚Äîintentionally incomplete‚Äîso we can see what coverage reveals:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_processor.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">PaymentProcessor</span><span class="p">,</span>
    <span class="n">InvalidAmountError</span><span class="p">,</span>
    <span class="n">InsufficientFundsError</span>
<span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_successful_payment</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test a basic successful payment.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
        <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;500.00&quot;</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Test payment&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;TXN-000001&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Payment processed successfully&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_amount_raises_error</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that negative amounts are rejected.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">InvalidAmountError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
            <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;-50.00&quot;</span><span class="p">),</span>
            <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;500.00&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">assert</span> <span class="s2">&quot;must be positive&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_insufficient_funds_raises_error</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that payments exceeding balance are rejected.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">InsufficientFundsError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
            <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;600.00&quot;</span><span class="p">),</span>
            <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;500.00&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">assert</span> <span class="s2">&quot;Insufficient funds&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>

<p>These tests look reasonable‚Äîthey test success and two error cases. But how much of our code are they actually exercising? That's what coverage will tell us.</p>
<h3 id="the-question-coverage-answers">The Question Coverage Answers</h3>
<p>Before we measure coverage, ask yourself: <strong>What parts of <code>PaymentProcessor</code> do these three tests actually execute?</strong></p>
<ul>
<li>Do they test fraud detection?</li>
<li>Do they test transaction history?</li>
<li>Do they test the total calculation?</li>
<li>Do they test the <code>bypass_fraud_check</code> parameter?</li>
<li>Do they test the <code>limit</code> parameter in <code>get_transaction_history()</code>?</li>
</ul>
<p>Coverage will give us the definitive answer. In the next section, we'll install the tools to measure it.</p>
<h2 id="installing-and-using-pytest-cov">Installing and Using pytest-cov</h2>
<h2 id="installing-pytest-cov">Installing pytest-cov</h2>
<p>The standard tool for measuring coverage in pytest is <code>pytest-cov</code>, which integrates the <code>coverage.py</code> library with pytest's test runner.</p>
<p>Install it via pip:</p>
<div class="codehilite"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>pytest-cov
</code></pre></div>

<p>This installs both <code>coverage</code> (the underlying measurement engine) and <code>pytest-cov</code> (the pytest plugin that makes it easy to use).</p>
<h3 id="your-first-coverage-run">Your First Coverage Run</h3>
<p>Let's measure the coverage of our initial test suite. Run pytest with the <code>--cov</code> flag:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>--cov<span class="o">=</span>payment_processor<span class="w"> </span>test_payment_processor.py
</code></pre></div>

<p><strong>Breaking down this command</strong>:
- <code>pytest</code> - Run the test suite
- <code>--cov=payment_processor</code> - Measure coverage for the <code>payment_processor</code> module
- <code>test_payment_processor.py</code> - Run tests from this file</p>
<p><strong>The output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 3 items

test_payment_processor.py ...                                            [100%]

---------- coverage: platform linux, python 3.11.0 -----------
Name                    Stmts   Miss  Cover
-------------------------------------------
payment_processor.py       45     18    60%
-------------------------------------------
TOTAL                      45     18    60%

============================== 3 passed in 0.12s ===============================
</code></pre></div>

<h3 id="reading-the-coverage-summary">Reading the Coverage Summary</h3>
<p>Let's parse this output:</p>
<p><strong>The test results</strong>: <code>3 passed</code> - All our tests work</p>
<p><strong>The coverage report</strong>:
- <code>Stmts: 45</code> - Our module has 45 executable statements
- <code>Miss: 18</code> - 18 of those statements were never executed
- <code>Cover: 60%</code> - We're testing 60% of our code</p>
<p><strong>What this tells us</strong>: We have 40% of our code that's completely untested. Those 18 missed statements could contain bugs, and we'd never know.</p>
<h3 id="seeing-which-lines-were-missed">Seeing Which Lines Were Missed</h3>
<p>The summary is useful, but it doesn't tell us <strong>which</strong> lines we missed. For that, we need a detailed report:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>--cov<span class="o">=</span>payment_processor<span class="w"> </span>--cov-report<span class="o">=</span>term-missing<span class="w"> </span>test_payment_processor.py
</code></pre></div>

<p><strong>The <code>--cov-report=term-missing</code> flag</strong> adds line numbers to the output:</p>
<div class="codehilite"><pre><span></span><code>---------- coverage: platform linux, python 3.11.0 -----------
Name                    Stmts   Miss  Cover   Missing
-----------------------------------------------------
payment_processor.py       45     18    60%   28-35, 52-58, 61-67
-----------------------------------------------------
TOTAL                      45     18    60%
</code></pre></div>

<p>Now we can see exactly which line ranges were never executed:
- <strong>Lines 28-35</strong>: The fraud detection block
- <strong>Lines 52-58</strong>: The <code>get_transaction_history()</code> method
- <strong>Lines 61-67</strong>: The <code>calculate_total_processed()</code> method</p>
<p>This is actionable information. We now know exactly where our test gaps are.</p>
<h3 id="generating-an-html-report">Generating an HTML Report</h3>
<p>Terminal output is great for quick checks, but for detailed analysis, HTML reports are superior:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>--cov<span class="o">=</span>payment_processor<span class="w"> </span>--cov-report<span class="o">=</span>html<span class="w"> </span>test_payment_processor.py
</code></pre></div>

<p>This creates a <code>htmlcov/</code> directory with an interactive report. Open <code>htmlcov/index.html</code> in your browser:</p>
<p><strong>What you'll see</strong>:
- A file-by-file breakdown of coverage
- Color-coded source code (green = covered, red = missed)
- Branch coverage visualization
- Sortable columns for quick identification of problem areas</p>
<p>The HTML report makes it trivial to see exactly which code paths your tests never touch. You can click through to any file and see line-by-line highlighting.</p>
<h3 id="common-coverage-report-formats">Common Coverage Report Formats</h3>
<p><code>pytest-cov</code> supports multiple output formats:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Terminal output with missing lines</span>
pytest<span class="w"> </span>--cov<span class="o">=</span>payment_processor<span class="w"> </span>--cov-report<span class="o">=</span>term-missing

<span class="c1"># HTML report (most detailed)</span>
pytest<span class="w"> </span>--cov<span class="o">=</span>payment_processor<span class="w"> </span>--cov-report<span class="o">=</span>html

<span class="c1"># XML report (for CI/CD systems)</span>
pytest<span class="w"> </span>--cov<span class="o">=</span>payment_processor<span class="w"> </span>--cov-report<span class="o">=</span>xml

<span class="c1"># No terminal output, only HTML</span>
pytest<span class="w"> </span>--cov<span class="o">=</span>payment_processor<span class="w"> </span>--cov-report<span class="o">=</span>html<span class="w"> </span>--cov-report<span class="o">=</span>term-missing:skip-covered

<span class="c1"># Multiple formats at once</span>
pytest<span class="w"> </span>--cov<span class="o">=</span>payment_processor<span class="w"> </span>--cov-report<span class="o">=</span>term-missing<span class="w"> </span>--cov-report<span class="o">=</span>html
</code></pre></div>

<h3 id="configuring-coverage-in-pytestini">Configuring Coverage in pytest.ini</h3>
<p>Instead of typing long command-line flags every time, configure coverage in your <code>pytest.ini</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># pytest.ini</span>
<span class="k">[pytest]</span>
<span class="na">addopts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">--cov</span><span class="o">=</span><span class="s">payment_processor</span>
<span class="w">    </span><span class="na">--cov-report</span><span class="o">=</span><span class="s">term-missing</span>
<span class="w">    </span><span class="na">--cov-report</span><span class="o">=</span><span class="s">html</span>
<span class="w">    </span><span class="na">--cov-fail-under</span><span class="o">=</span><span class="s">80</span>
</code></pre></div>

<p>Now you can just run <code>pytest</code> and coverage is automatically measured.</p>
<p><strong>The <code>--cov-fail-under=80</code> option</strong> makes the test suite fail if coverage drops below 80%. This is useful for CI/CD pipelines (we'll explore this in section 13.4).</p>
<h3 id="measuring-coverage-for-multiple-modules">Measuring Coverage for Multiple Modules</h3>
<p>If your project has multiple modules, specify them all:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>--cov<span class="o">=</span>payment_processor<span class="w"> </span>--cov<span class="o">=</span>user_auth<span class="w"> </span>--cov<span class="o">=</span>api_client
</code></pre></div>

<p>Or use a pattern to cover everything in a package:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>--cov<span class="o">=</span>myproject
</code></pre></div>

<p>This measures coverage for all modules under <code>myproject/</code>.</p>
<h3 id="the-coverage-workflow">The Coverage Workflow</h3>
<p>Here's the typical workflow for using coverage:</p>
<ol>
<li><strong>Run tests with coverage</strong>: <code>pytest --cov=mymodule --cov-report=html</code></li>
<li><strong>Open the HTML report</strong>: <code>open htmlcov/index.html</code></li>
<li><strong>Identify untested code</strong>: Look for red lines in the report</li>
<li><strong>Write tests for missed lines</strong>: Focus on the most critical paths first</li>
<li><strong>Re-run coverage</strong>: Verify your new tests increased coverage</li>
<li><strong>Repeat</strong>: Continue until you reach your target coverage percentage</li>
</ol>
<h3 id="what-weve-learned">What We've Learned</h3>
<p>We now know:
- Our initial test suite has 60% coverage
- Lines 28-35, 52-58, and 61-67 are completely untested
- We can generate detailed reports to guide test writing</p>
<p>In the next section, we'll learn how to read these reports like an expert and understand what they're really telling us.</p>
<h2 id="understanding-coverage-reports">Understanding Coverage Reports</h2>
<h2 id="anatomy-of-a-coverage-report">Anatomy of a Coverage Report</h2>
<p>Let's dissect a coverage report systematically to understand every piece of information it provides. We'll use our payment processor as the reference.</p>
<h3 id="the-terminal-report-line-by-line">The Terminal Report: Line by Line</h3>
<p>Here's our current coverage output:</p>
<div class="codehilite"><pre><span></span><code>---------- coverage: platform linux, python 3.11.0 -----------
Name                    Stmts   Miss  Cover   Missing
-----------------------------------------------------
payment_processor.py       45     18    60%   28-35, 52-58, 61-67
-----------------------------------------------------
TOTAL                      45     18    60%
</code></pre></div>

<p><strong>Column 1: Name</strong> - The module being measured</p>
<p><strong>Column 2: Stmts (Statements)</strong> - Total number of executable statements
- This counts lines that actually do something (assignments, function calls, returns)
- It does NOT count blank lines, comments, or docstrings
- It does NOT count class/function definitions themselves (only their bodies)</p>
<p><strong>Column 3: Miss</strong> - Number of statements that were never executed during tests</p>
<p><strong>Column 4: Cover</strong> - Percentage of statements that were executed
- Formula: <code>Cover = ((Stmts - Miss) / Stmts) * 100</code>
- In our case: <code>((45 - 18) / 45) * 100 = 60%</code></p>
<p><strong>Column 5: Missing</strong> - Line numbers or ranges that were never executed
- <code>28-35</code> means lines 28 through 35 (inclusive)
- Individual lines are listed separately: <code>28, 30, 35</code></p>
<h3 id="what-missing-really-means">What "Missing" Really Means</h3>
<p>Let's look at the actual code for lines 28-35 (the fraud detection block):</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Lines 28-35 in payment_processor.py</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">bypass_fraud_check</span> <span class="ow">and</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraud_threshold</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Transaction flagged for fraud review: amount </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2"> exceeds threshold&quot;</span>
    <span class="p">}</span>
</code></pre></div>

<p>These lines are marked as "missing" because <strong>none of our tests ever triggered the fraud detection logic</strong>. We never tested:
- A payment amount exceeding the fraud threshold
- The <code>bypass_fraud_check</code> parameter</p>
<p>This is a critical gap. If there's a bug in fraud detection, our tests won't catch it.</p>
<h3 id="branch-coverage-vs-line-coverage">Branch Coverage vs. Line Coverage</h3>
<p>Our current report shows <strong>line coverage</strong> (also called statement coverage). But there's a more sophisticated metric: <strong>branch coverage</strong>.</p>
<p><strong>Line coverage</strong> asks: "Was this line executed?"</p>
<p><strong>Branch coverage</strong> asks: "Were all possible paths through this line executed?"</p>
<p>Consider this code:</p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">process_payment</span><span class="p">()</span>
</code></pre></div>

<p><strong>Line coverage</strong>: If we test with <code>amount = 100</code>, the <code>if</code> line is executed ‚Üí 100% line coverage</p>
<p><strong>Branch coverage</strong>: But we never tested the <code>False</code> branch (when <code>amount &lt;= 0</code>) ‚Üí only 50% branch coverage</p>
<p>To enable branch coverage:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>--cov<span class="o">=</span>payment_processor<span class="w"> </span>--cov-branch<span class="w"> </span>--cov-report<span class="o">=</span>term-missing
</code></pre></div>

<p><strong>The output with branch coverage</strong>:</p>
<div class="codehilite"><pre><span></span><code>---------- coverage: platform linux, python 3.11.0 -----------
Name                    Stmts   Miss Branch BrPart  Cover   Missing
--------------------------------------------------------------------
payment_processor.py       45     18     12      6    52%   28-35, 52-58, 61-67
--------------------------------------------------------------------
TOTAL                      45     18     12      6    52%
</code></pre></div>

<p><strong>New columns</strong>:
- <code>Branch: 12</code> - Total number of decision points (if/else, loops, etc.)
- <code>BrPart: 6</code> - Number of branches that were only partially covered
- <code>Cover: 52%</code> - Overall coverage including branches (lower than line coverage!)</p>
<p><strong>What this tells us</strong>: Even though we executed 60% of lines, we only tested 52% of all possible paths through the code. We have conditional logic where we only tested one branch.</p>
<h3 id="the-html-report-visual-analysis">The HTML Report: Visual Analysis</h3>
<p>The HTML report (<code>htmlcov/index.html</code>) provides the richest view. Let's walk through what you see:</p>
<p><strong>The index page</strong> shows:
- All modules sorted by coverage percentage
- Color coding: green (high coverage), yellow (medium), red (low)
- Clickable file names to drill into details</p>
<p><strong>Clicking on <code>payment_processor.py</code></strong> shows the source code with highlighting:
- <strong>Green background</strong>: Lines that were executed
- <strong>Red background</strong>: Lines that were never executed
- <strong>Yellow background</strong>: Lines with partial branch coverage
- <strong>Line numbers in margin</strong>: Execution counts (how many times each line ran)</p>
<h3 id="reading-execution-counts">Reading Execution Counts</h3>
<p>The HTML report shows a number next to each line indicating how many times it was executed:</p>
<div class="codehilite"><pre><span></span><code>3  def test_successful_payment():
    3      processor = PaymentProcessor()
    3      result = processor.process_payment(...)
    3      assert result[&quot;success&quot;] is True
</code></pre></div>

<p>This tells us <code>test_successful_payment()</code> ran 3 times (once per test run). If you see a line executed 1000 times, it might be in a loop‚Äîuseful for identifying performance hotspots.</p>
<h3 id="partial-branch-coverage-example">Partial Branch Coverage Example</h3>
<p>Let's add a test that triggers fraud detection but doesn't test the bypass:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_fraud_detection_triggers</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that large amounts trigger fraud review.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">fraud_threshold</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1000.00&quot;</span><span class="p">))</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;5000.00&quot;</span><span class="p">),</span>
        <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10000.00&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="s2">&quot;fraud review&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
</code></pre></div>

<p>Now run coverage with branch tracking:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>--cov<span class="o">=</span>payment_processor<span class="w"> </span>--cov-branch<span class="w"> </span>--cov-report<span class="o">=</span>term-missing
</code></pre></div>

<p><strong>The output</strong>:</p>
<div class="codehilite"><pre><span></span><code>Name                    Stmts   Miss Branch BrPart  Cover   Missing
--------------------------------------------------------------------
payment_processor.py       45     14     12      1    65%   52-58, 61-67
--------------------------------------------------------------------
</code></pre></div>

<p><strong>What changed</strong>:
- <code>Miss</code> dropped from 18 to 14 (we covered lines 28-35)
- <code>BrPart</code> is now 1 instead of 6 (we still have one partially covered branch)
- <code>Cover</code> increased to 65%</p>
<p><strong>The remaining partial branch</strong>: The <code>bypass_fraud_check</code> parameter. We tested <code>bypass_fraud_check=False</code> (the default), but never <code>bypass_fraud_check=True</code>.</p>
<h3 id="the-coveragepy-data-file">The Coverage.py Data File</h3>
<p>When you run coverage, it creates a <code>.coverage</code> file in your project root. This is a SQLite database containing the raw measurement data.</p>
<p>You can query it directly:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Show summary</span>
coverage<span class="w"> </span>report

<span class="c1"># Show missing lines</span>
coverage<span class="w"> </span>report<span class="w"> </span>--show-missing

<span class="c1"># Generate HTML from existing data</span>
coverage<span class="w"> </span>html
</code></pre></div>

<p>This is useful when you want to generate reports in different formats without re-running tests.</p>
<h3 id="combining-coverage-from-multiple-test-runs">Combining Coverage from Multiple Test Runs</h3>
<p>If you run tests in multiple stages (unit tests, integration tests, etc.), you can combine coverage:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run unit tests</span>
pytest<span class="w"> </span>tests/unit<span class="w"> </span>--cov<span class="o">=</span>payment_processor<span class="w"> </span>--cov-append

<span class="c1"># Run integration tests (append to existing coverage)</span>
pytest<span class="w"> </span>tests/integration<span class="w"> </span>--cov<span class="o">=</span>payment_processor<span class="w"> </span>--cov-append

<span class="c1"># Generate combined report</span>
coverage<span class="w"> </span>report
coverage<span class="w"> </span>html
</code></pre></div>

<p>The <code>--cov-append</code> flag tells coverage to add to the existing <code>.coverage</code> file instead of overwriting it.</p>
<h3 id="what-coverage-reports-dont-show">What Coverage Reports Don't Show</h3>
<p>Coverage reports are powerful, but they have blind spots:</p>
<p><strong>They don't show</strong>:
1. <strong>Assertion quality</strong>: A line can be executed without being properly tested
2. <strong>Edge cases</strong>: You might test the happy path but miss boundary conditions
3. <strong>Error handling</strong>: Exception paths might be untested even with high coverage
4. <strong>Integration issues</strong>: Unit test coverage doesn't guarantee components work together</p>
<p><strong>Example of misleading coverage</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_discount</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">customer_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">customer_type</span> <span class="o">==</span> <span class="s2">&quot;premium&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">price</span> <span class="o">*</span> <span class="mf">0.8</span>
    <span class="k">return</span> <span class="n">price</span>

<span class="c1"># This test gives 100% line coverage but is useless</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_discount</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">calculate_discount</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;premium&quot;</span><span class="p">)</span>
    <span class="c1"># No assertion! The line was executed but not verified</span>
</code></pre></div>

<p>Coverage would show 100%, but the test doesn't actually verify anything.</p>
<h3 id="the-coverage-report-checklist">The Coverage Report Checklist</h3>
<p>When analyzing a coverage report, ask:</p>
<ol>
<li><strong>What's the overall percentage?</strong> (Target: 80%+ for critical code)</li>
<li><strong>Which files have the lowest coverage?</strong> (Prioritize these)</li>
<li><strong>Are there entire functions with 0% coverage?</strong> (Critical gap)</li>
<li><strong>Are error handling paths covered?</strong> (Look for <code>except</code> blocks)</li>
<li><strong>Are edge cases covered?</strong> (Look for boundary conditions)</li>
<li><strong>Is branch coverage significantly lower than line coverage?</strong> (Indicates untested paths)</li>
</ol>
<h3 id="iteration-1-improving-our-coverage">Iteration 1: Improving Our Coverage</h3>
<p>Let's systematically address the gaps in our payment processor tests. We'll add tests for the missing functionality:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_fraud_bypass_allows_large_payment</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that bypass flag allows payments above threshold.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">fraud_threshold</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1000.00&quot;</span><span class="p">))</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;5000.00&quot;</span><span class="p">),</span>
        <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10000.00&quot;</span><span class="p">),</span>
        <span class="n">bypass_fraud_check</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># This is the untested branch</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_transaction_history_retrieval</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test retrieving transaction history.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">()</span>

    <span class="c1"># Process multiple payments</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1000.00&quot;</span><span class="p">))</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;200.00&quot;</span><span class="p">),</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1000.00&quot;</span><span class="p">))</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;300.00&quot;</span><span class="p">),</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1000.00&quot;</span><span class="p">))</span>

    <span class="c1"># Get all history</span>
    <span class="n">history</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">get_transaction_history</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="c1"># Get limited history</span>
    <span class="n">recent</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">get_transaction_history</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">recent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;200.00&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_total_processed</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test total amount calculation.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">()</span>

    <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1000.00&quot;</span><span class="p">))</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;250.50&quot;</span><span class="p">),</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1000.00&quot;</span><span class="p">))</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;75.25&quot;</span><span class="p">),</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1000.00&quot;</span><span class="p">))</span>

    <span class="n">total</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">calculate_total_processed</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">total</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;425.75&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_transaction_history_with_zero_limit</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that limit=0 returns empty list.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">()</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1000.00&quot;</span><span class="p">))</span>

    <span class="n">history</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">get_transaction_history</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">history</span> <span class="o">==</span> <span class="p">[]</span>
</code></pre></div>

<p><strong>Run coverage again</strong>:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>--cov<span class="o">=</span>payment_processor<span class="w"> </span>--cov-branch<span class="w"> </span>--cov-report<span class="o">=</span>term-missing
</code></pre></div>

<p><strong>The new output</strong>:</p>
<div class="codehilite"><pre><span></span><code>---------- coverage: platform linux, python 3.11.0 -----------
Name                    Stmts   Miss Branch BrPart  Cover   Missing
--------------------------------------------------------------------
payment_processor.py       45      0     12      0   100%
--------------------------------------------------------------------
TOTAL                      45      0     12      0   100%

============================== 8 passed in 0.15s ===============================
</code></pre></div>

<p><strong>Achievement unlocked</strong>: 100% coverage! Every line and every branch in our payment processor is now tested.</p>
<h3 id="what-100-coverage-means-and-doesnt-mean">What 100% Coverage Means (and Doesn't Mean)</h3>
<p><strong>What we've achieved</strong>:
- Every line of code has been executed at least once
- Every conditional branch has been tested
- No dead code exists (or if it does, we know about it)</p>
<p><strong>What we haven't guaranteed</strong>:
- That our assertions are correct
- That we've tested all edge cases
- That the code is bug-free
- That the code is well-designed</p>
<p>Coverage is a <strong>necessary but not sufficient</strong> condition for a good test suite. In the next section, we'll explore how to use coverage as a quality gate in your development workflow.</p>
<h2 id="coverage-as-a-quality-gate">Coverage as a Quality Gate</h2>
<h2 id="using-coverage-to-enforce-testing-standards">Using Coverage to Enforce Testing Standards</h2>
<p>A <strong>quality gate</strong> is an automated check that prevents code from being merged or deployed if it doesn't meet certain standards. Coverage makes an excellent quality gate because it's objective and measurable.</p>
<h3 id="the-coverage-threshold-strategy">The Coverage Threshold Strategy</h3>
<p>The most common approach is to set a <strong>minimum coverage threshold</strong>. If coverage falls below this threshold, the build fails.</p>
<p><strong>Configure this in pytest.ini</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># pytest.ini</span>
<span class="k">[pytest]</span>
<span class="na">addopts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">--cov</span><span class="o">=</span><span class="s">payment_processor</span>
<span class="w">    </span><span class="na">--cov-report</span><span class="o">=</span><span class="s">term-missing</span>
<span class="w">    </span><span class="na">--cov-report</span><span class="o">=</span><span class="s">html</span>
<span class="w">    </span><span class="na">--cov-fail-under</span><span class="o">=</span><span class="s">80</span>
</code></pre></div>

<p>The <code>--cov-fail-under=80</code> flag means: <strong>fail the test run if coverage is below 80%</strong>.</p>
<h3 id="seeing-the-quality-gate-in-action">Seeing the Quality Gate in Action</h3>
<p>Let's intentionally break our coverage to see what happens. Comment out one of our tests:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># def test_calculate_total_processed():</span>
<span class="c1">#     &quot;&quot;&quot;Test total amount calculation.&quot;&quot;&quot;</span>
<span class="c1">#     processor = PaymentProcessor()</span>
<span class="c1">#     </span>
<span class="c1">#     processor.process_payment(Decimal(&quot;100.00&quot;), Decimal(&quot;1000.00&quot;))</span>
<span class="c1">#     processor.process_payment(Decimal(&quot;250.50&quot;), Decimal(&quot;1000.00&quot;))</span>
<span class="c1">#     processor.process_payment(Decimal(&quot;75.25&quot;), Decimal(&quot;1000.00&quot;))</span>
<span class="c1">#     </span>
<span class="c1">#     total = processor.calculate_total_processed()</span>
<span class="c1">#     assert total == Decimal(&quot;425.75&quot;)</span>
</code></pre></div>

<p><strong>Run the tests</strong>:</p>
<div class="codehilite"><pre><span></span><code>pytest
</code></pre></div>

<p><strong>The output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 7 items

test_payment_processor.py .......                                        [100%]

---------- coverage: platform linux, python 3.11.0 -----------
Name                    Stmts   Miss  Cover   Missing
-----------------------------------------------------
payment_processor.py       45      4    91%   61-67
-----------------------------------------------------
TOTAL                      45      4    91%

Required test coverage of 80% reached. Total coverage: 91.11%

============================== 7 passed in 0.12s ===============================
</code></pre></div>

<p><strong>Result</strong>: Tests pass because 91% &gt; 80%. The quality gate allows this through.</p>
<p>Now let's comment out more tests to drop below 80%:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Comment out multiple tests</span>
<span class="c1"># def test_fraud_bypass_allows_large_payment(): ...</span>
<span class="c1"># def test_transaction_history_retrieval(): ...</span>
<span class="c1"># def test_calculate_total_processed(): ...</span>
</code></pre></div>

<p><strong>Run again</strong>:</p>
<div class="codehilite"><pre><span></span><code>pytest
</code></pre></div>

<p><strong>The output</strong>:</p>
<div class="codehilite"><pre><span></span><code>============================= test session starts ==============================
collected 4 items

test_payment_processor.py ....                                           [100%]

---------- coverage: platform linux, python 3.11.0 -----------
Name                    Stmts   Miss  Cover   Missing
-----------------------------------------------------
payment_processor.py       45     18    60%   28-35, 52-58, 61-67
-----------------------------------------------------
TOTAL                      45     18    60%

FAIL Required test coverage of 80% not reached. Total coverage: 60.00%

============================== 4 passed in 0.11s ===============================
</code></pre></div>

<p><strong>Result</strong>: The test run <strong>fails</strong> even though all tests passed. The exit code is non-zero, which will fail CI/CD pipelines.</p>
<p>This is the quality gate in action: <strong>you cannot merge code that drops coverage below the threshold</strong>.</p>
<h3 id="choosing-the-right-threshold">Choosing the Right Threshold</h3>
<p><strong>Common thresholds</strong>:
- <strong>60-70%</strong>: Minimum acceptable for legacy codebases
- <strong>80%</strong>: Industry standard for new projects
- <strong>90%+</strong>: High-quality projects, critical systems
- <strong>100%</strong>: Rarely practical (and often counterproductive)</p>
<p><strong>Factors to consider</strong>:
1. <strong>Project maturity</strong>: New projects can aim higher
2. <strong>Code criticality</strong>: Payment systems need higher coverage than internal tools
3. <strong>Team size</strong>: Larger teams benefit from stricter gates
4. <strong>Technical debt</strong>: Legacy code may need gradual improvement</p>
<h3 id="the-ratchet-strategy-never-go-backwards">The Ratchet Strategy: Never Go Backwards</h3>
<p>Instead of setting an arbitrary threshold, use the <strong>ratchet approach</strong>: coverage can only increase, never decrease.</p>
<p><strong>How it works</strong>:
1. Measure current coverage (e.g., 65%)
2. Set threshold to current coverage: <code>--cov-fail-under=65</code>
3. When someone adds tests and coverage increases to 68%, update threshold to 68%
4. Coverage can never drop below the highest point reached</p>
<p><strong>Implementation in CI/CD</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># In your CI script</span>
<span class="nv">current_coverage</span><span class="o">=</span><span class="k">$(</span>pytest<span class="w"> </span>--cov<span class="o">=</span>myproject<span class="w"> </span>--cov-report<span class="o">=</span>term<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>TOTAL<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $4}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/%//&#39;</span><span class="k">)</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Current coverage: </span><span class="nv">$current_coverage</span><span class="s2">%&quot;</span>

<span class="c1"># Update threshold in pytest.ini if coverage increased</span>
<span class="c1"># (This requires a commit back to the repo)</span>
</code></pre></div>

<p>This approach is gentler than a fixed high threshold but still prevents regression.</p>
<h3 id="per-file-coverage-requirements">Per-File Coverage Requirements</h3>
<p>You can set different thresholds for different parts of your codebase:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># pytest.ini</span>
<span class="k">[pytest]</span>
<span class="na">addopts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">    </span><span class="na">--cov</span><span class="o">=</span><span class="s">payment_processor</span>
<span class="w">    </span><span class="na">--cov</span><span class="o">=</span><span class="s">user_auth</span>
<span class="w">    </span><span class="na">--cov-fail-under</span><span class="o">=</span><span class="s">80</span>

<span class="k">[coverage:report]</span>
<span class="c1"># Fail if any individual file is below 70%</span>
<span class="na">fail_under</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">70</span>

<span class="k">[coverage:paths]</span>
<span class="c1"># Critical modules must have 95% coverage</span>
<span class="na">critical</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="na">payment_processor.py</span>
<span class="w">    </span><span class="na">user_auth.py</span>
</code></pre></div>

<p>This allows you to enforce stricter standards on critical code while being more lenient on less important modules.</p>
<h3 id="coverage-in-pull-request-reviews">Coverage in Pull Request Reviews</h3>
<p>Many teams use coverage as a <strong>PR review criterion</strong>:</p>
<p><strong>GitHub Actions example</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .github/workflows/test.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Tests</span>

<span class="nt">on</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">pull_request</span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">test</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-python@v2</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.11&#39;</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pip install pytest pytest-cov</span>
<span class="w">          </span><span class="no">pip install -e .</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests with coverage</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pytest --cov=myproject --cov-report=xml --cov-fail-under=80</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload coverage to Codecov</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">codecov/codecov-action@v2</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./coverage.xml</span>
<span class="w">          </span><span class="nt">fail_ci_if_error</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>

<p>This workflow:
1. Runs tests on every PR
2. Fails if coverage is below 80%
3. Uploads coverage report to Codecov for visualization
4. Blocks merging if coverage drops</p>
<h3 id="coverage-diff-focusing-on-new-code">Coverage Diff: Focusing on New Code</h3>
<p>A sophisticated approach is to require <strong>new code</strong> to have high coverage, even if overall coverage is lower:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Compare coverage between main branch and PR branch</span>
pytest<span class="w"> </span>--cov<span class="o">=</span>myproject<span class="w"> </span>--cov-report<span class="o">=</span>json
coverage<span class="w"> </span>json<span class="w"> </span>--diff<span class="o">=</span>origin/main
</code></pre></div>

<p>This shows coverage only for lines that changed in the PR. You can require 100% coverage of new code while allowing legacy code to remain at lower coverage.</p>
<p><strong>Tools that support this</strong>:
- <strong>Codecov</strong>: Shows coverage diff in PR comments
- <strong>Coveralls</strong>: Highlights uncovered lines in new code
- <strong>SonarQube</strong>: Tracks coverage trends over time</p>
<h3 id="the-coverage-dashboard">The Coverage Dashboard</h3>
<p>For teams, a coverage dashboard provides visibility:</p>
<p><strong>What to track</strong>:
- Overall coverage percentage
- Coverage trend over time (is it improving?)
- Per-module coverage breakdown
- Coverage of recently changed files
- Number of untested functions</p>
<p><strong>Example dashboard metrics</strong>:</p>
<div class="codehilite"><pre><span></span><code>Project Coverage Dashboard
==========================
Overall: 87% (‚Üë 2% from last week)

By Module:
  payment_processor.py:  100% ‚úì
  user_auth.py:          95%  ‚úì
  api_client.py:         78%  ‚ö†
  legacy_utils.py:       45%  ‚úó

Recent Changes:
  PR #123: +3% coverage (added fraud tests)
  PR #122: -1% coverage (added untested feature) ‚úó
  PR #121: +0% coverage (refactoring only)

Untested Functions: 12
Critical Untested: 2 ‚ö†
</code></pre></div>

<h3 id="when-to-override-the-quality-gate">When to Override the Quality Gate</h3>
<p>Sometimes you need to merge code that drops coverage. <strong>Valid reasons</strong>:</p>
<ol>
<li><strong>Removing dead code</strong>: Deleting untested code drops coverage percentage but improves codebase</li>
<li><strong>Adding experimental features</strong>: Prototypes might not be fully tested initially</li>
<li><strong>Emergency hotfixes</strong>: Critical bugs might need immediate fixes</li>
</ol>
<p><strong>How to override</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Temporarily disable coverage check</span>
pytest<span class="w"> </span>--no-cov

<span class="c1"># Or set a lower threshold for this run</span>
pytest<span class="w"> </span>--cov-fail-under<span class="o">=</span><span class="m">70</span>
</code></pre></div>

<p><strong>Important</strong>: Document why you're overriding and create a ticket to add tests later.</p>
<h3 id="the-coverage-contract">The Coverage Contract</h3>
<p>Establish a team agreement on coverage standards:</p>
<p><strong>Example coverage contract</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">All</span><span class="w"> </span><span class="kr">new</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="mf">90</span><span class="err">%</span><span class="o">+</span><span class="w"> </span><span class="n">coverage</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">Bug</span><span class="w"> </span><span class="n">fixes</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">include</span><span class="w"> </span><span class="n">tests</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">would</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">caught</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">bug</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">Refactoring</span><span class="w"> </span><span class="n">cannot</span><span class="w"> </span><span class="n">decrease</span><span class="w"> </span><span class="n">coverage</span>
<span class="mf">4.</span><span class="w"> </span><span class="n">PRs</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">drop</span><span class="w"> </span><span class="n">coverage</span><span class="w"> </span><span class="n">below</span><span class="w"> </span><span class="mf">80</span><span class="err">%</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">rejected</span>
<span class="mf">5.</span><span class="w"> </span><span class="n">Critical</span><span class="w"> </span><span class="n">modules</span><span class="w"> </span><span class="p">(</span><span class="n">payment</span><span class="p">,</span><span class="w"> </span><span class="n">auth</span><span class="p">)</span><span class="w"> </span><span class="n">require</span><span class="w"> </span><span class="mf">95</span><span class="err">%</span><span class="o">+</span><span class="w"> </span><span class="n">coverage</span>
<span class="mf">6.</span><span class="w"> </span><span class="n">Coverage</span><span class="w"> </span><span class="n">reports</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">reviewed</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">every</span><span class="w"> </span><span class="n">PR</span>
</code></pre></div>

<p>This makes expectations explicit and reduces friction in code reviews.</p>
<h3 id="measuring-coverage-impact">Measuring Coverage Impact</h3>
<p>Track how coverage correlates with bugs:</p>
<div class="codehilite"><pre><span></span><code>Coverage vs. Bugs Analysis
==========================
Modules with 90%+ coverage: 2 bugs in 6 months
Modules with 70-90% coverage: 8 bugs in 6 months
Modules with &lt;70% coverage: 23 bugs in 6 months

Conclusion: High coverage correlates with fewer production bugs
</code></pre></div>

<p>This data justifies the investment in maintaining high coverage.</p>
<h3 id="the-quality-gate-checklist">The Quality Gate Checklist</h3>
<p>Before merging code, verify:</p>
<ul>
<li>[ ] Coverage is above the threshold (80%+)</li>
<li>[ ] No critical functions are untested</li>
<li>[ ] New code has 90%+ coverage</li>
<li>[ ] Coverage trend is stable or improving</li>
<li>[ ] HTML report has been reviewed for gaps</li>
<li>[ ] Branch coverage is close to line coverage</li>
</ul>
<h3 id="what-weve-learned_1">What We've Learned</h3>
<p>Coverage as a quality gate:
- Prevents untested code from being merged
- Enforces team standards automatically
- Provides objective metrics for code review
- Tracks quality trends over time</p>
<p>But remember: <strong>passing the coverage gate doesn't mean your tests are good</strong>. It only means your code is executed. In the next section, we'll explore how to identify and fix coverage gaps.</p>
<h2 id="coverage-gaps-and-dead-code">Coverage Gaps and Dead Code</h2>
<h2 id="identifying-and-addressing-coverage-gaps">Identifying and Addressing Coverage Gaps</h2>
<p>Coverage reports reveal two types of problems: <strong>coverage gaps</strong> (code that should be tested but isn't) and <strong>dead code</strong> (code that should be deleted). Learning to distinguish between them is crucial.</p>
<h3 id="the-reference-implementation-extended-payment-processor">The Reference Implementation: Extended Payment Processor</h3>
<p>Let's extend our payment processor with more realistic complexity:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_processor.py (extended version)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentStatus</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">PENDING</span> <span class="o">=</span> <span class="s2">&quot;pending&quot;</span>
    <span class="n">COMPLETED</span> <span class="o">=</span> <span class="s2">&quot;completed&quot;</span>
    <span class="n">FAILED</span> <span class="o">=</span> <span class="s2">&quot;failed&quot;</span>
    <span class="n">REFUNDED</span> <span class="o">=</span> <span class="s2">&quot;refunded&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Processes payments with validation, fraud detection, and refunds.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fraud_threshold</span><span class="p">:</span> <span class="n">Decimal</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10000.00&quot;</span><span class="p">)):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fraud_threshold</span> <span class="o">=</span> <span class="n">fraud_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transaction_log</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refund_log</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">amount</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span>
        <span class="n">account_balance</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">bypass_fraud_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">customer_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a payment transaction.&quot;&quot;&quot;</span>
        <span class="c1"># Validate amount</span>
        <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidAmountError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Amount must be positive, got </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check for suspicious amounts</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bypass_fraud_check</span> <span class="ow">and</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraud_threshold</span><span class="p">:</span>
            <span class="c1"># Log suspicious transaction for review</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_suspicious_transaction</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">PaymentStatus</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Transaction flagged for fraud review&quot;</span>
            <span class="p">}</span>

        <span class="c1"># Check sufficient funds</span>
        <span class="k">if</span> <span class="n">account_balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InsufficientFundsError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Insufficient funds: balance </span><span class="si">{</span><span class="n">account_balance</span><span class="si">}</span><span class="s2">, required </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Process the payment</span>
        <span class="n">transaction_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_transaction_id</span><span class="p">()</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="n">transaction</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">transaction_id</span><span class="p">,</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">PaymentStatus</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">,</span>
            <span class="s2">&quot;customer_id&quot;</span><span class="p">:</span> <span class="n">customer_id</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transaction_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">transaction_id</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">PaymentStatus</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Payment processed successfully&quot;</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">refund_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Refund a previously completed payment.&quot;&quot;&quot;</span>
        <span class="c1"># Find the original transaction</span>
        <span class="n">transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_transaction</span><span class="p">(</span><span class="n">transaction_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">transaction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Transaction </span><span class="si">{</span><span class="n">transaction_id</span><span class="si">}</span><span class="s2"> not found&quot;</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">PaymentStatus</span><span class="o">.</span><span class="n">REFUNDED</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Transaction already refunded&quot;</span>
            <span class="p">}</span>

        <span class="c1"># Check if refund window has expired (30 days)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_refund_expired</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Refund window expired (30 days)&quot;</span>
            <span class="p">}</span>

        <span class="c1"># Process refund</span>
        <span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PaymentStatus</span><span class="o">.</span><span class="n">REFUNDED</span>
        <span class="n">refund_record</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">transaction_id</span><span class="p">,</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">],</span>
            <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refund_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">refund_record</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Refund processed successfully&quot;</span><span class="p">,</span>
            <span class="s2">&quot;refund_amount&quot;</span><span class="p">:</span> <span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">]</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_customer_transactions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all transactions for a specific customer.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">tx</span> <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_log</span>
            <span class="k">if</span> <span class="n">tx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;customer_id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">customer_id</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_suspicious_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log suspicious transactions for fraud review.&quot;&quot;&quot;</span>
        <span class="c1"># In production, this would write to a database or alert system</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FRAUD ALERT: Amount </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">, Customer </span><span class="si">{</span><span class="n">customer_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_find_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find a transaction by ID.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_log</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tx</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">transaction_id</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">tx</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_refund_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if refund window has expired.&quot;&quot;&quot;</span>
        <span class="n">expiry_date</span> <span class="o">=</span> <span class="n">transaction_timestamp</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">expiry_date</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_transaction_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a unique transaction ID.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;TXN-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction_log</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># DEAD CODE: This method is never called</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_customer_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate customer ID format.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">customer_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">customer_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;CUST-&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># DEAD CODE: This was for a feature that was never implemented</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">schedule_recurring_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">frequency</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Schedule a recurring payment (NOT IMPLEMENTED).&quot;&quot;&quot;</span>
        <span class="c1"># This was planned but never finished</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Recurring payments not yet implemented&quot;</span>
        <span class="p">}</span>
</code></pre></div>

<p>Now let's write tests for the new functionality:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_processor_extended.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processor</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">PaymentProcessor</span><span class="p">,</span>
    <span class="n">PaymentStatus</span><span class="p">,</span>
    <span class="n">InvalidAmountError</span><span class="p">,</span>
    <span class="n">InsufficientFundsError</span>
<span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_refund_successful_payment</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test refunding a completed payment.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">()</span>

    <span class="c1"># Process a payment</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
        <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;500.00&quot;</span><span class="p">),</span>
        <span class="n">customer_id</span><span class="o">=</span><span class="s2">&quot;CUST-12345&quot;</span>
    <span class="p">)</span>

    <span class="n">transaction_id</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span>

    <span class="c1"># Refund it</span>
    <span class="n">refund_result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">refund_payment</span><span class="p">(</span>
        <span class="n">transaction_id</span><span class="o">=</span><span class="n">transaction_id</span><span class="p">,</span>
        <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Customer request&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">refund_result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">refund_result</span><span class="p">[</span><span class="s2">&quot;refund_amount&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_refund_nonexistent_transaction</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test refunding a transaction that doesn&#39;t exist.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">refund_payment</span><span class="p">(</span><span class="n">transaction_id</span><span class="o">=</span><span class="s2">&quot;TXN-999999&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="s2">&quot;not found&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_refund_already_refunded</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that double refunds are prevented.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">()</span>

    <span class="c1"># Process and refund</span>
    <span class="n">payment</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
        <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;500.00&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">refund_payment</span><span class="p">(</span><span class="n">payment</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">])</span>

    <span class="c1"># Try to refund again</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">refund_payment</span><span class="p">(</span><span class="n">payment</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">])</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="s2">&quot;already refunded&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_customer_transactions</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test retrieving transactions for a specific customer.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">()</span>

    <span class="c1"># Process payments for different customers</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;500.00&quot;</span><span class="p">),</span> <span class="n">customer_id</span><span class="o">=</span><span class="s2">&quot;CUST-001&quot;</span>
    <span class="p">)</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;200.00&quot;</span><span class="p">),</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;500.00&quot;</span><span class="p">),</span> <span class="n">customer_id</span><span class="o">=</span><span class="s2">&quot;CUST-002&quot;</span>
    <span class="p">)</span>
    <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;300.00&quot;</span><span class="p">),</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;500.00&quot;</span><span class="p">),</span> <span class="n">customer_id</span><span class="o">=</span><span class="s2">&quot;CUST-001&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Get transactions for CUST-001</span>
    <span class="n">transactions</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">get_customer_transactions</span><span class="p">(</span><span class="s2">&quot;CUST-001&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">tx</span><span class="p">[</span><span class="s2">&quot;customer_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CUST-001&quot;</span> <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">transactions</span><span class="p">)</span>
</code></pre></div>

<p><strong>Run coverage</strong>:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>--cov<span class="o">=</span>payment_processor<span class="w"> </span>--cov-report<span class="o">=</span>term-missing<span class="w"> </span>--cov-report<span class="o">=</span>html
</code></pre></div>

<p><strong>The output</strong>:</p>
<div class="codehilite"><pre><span></span><code>---------- coverage: platform linux, python 3.11.0 -----------
Name                    Stmts   Miss  Cover   Missing
-----------------------------------------------------
payment_processor.py       89     15    83%   95-98, 105-112, 118-125
-----------------------------------------------------
TOTAL                      89     15    83%

============================== 4 passed in 0.14s ===============================
</code></pre></div>

<p>We have 83% coverage, but 15 statements are untested. Let's analyze what's missing.</p>
<h3 id="diagnostic-analysis-reading-the-coverage-gaps">Diagnostic Analysis: Reading the Coverage Gaps</h3>
<p><strong>The missing lines</strong>:
- <strong>Lines 95-98</strong>: <code>_log_suspicious_transaction()</code> method
- <strong>Lines 105-112</strong>: <code>_is_refund_expired()</code> method
- <strong>Lines 118-125</strong>: <code>_validate_customer_id()</code> method (dead code)
- <strong>Lines 128-135</strong>: <code>schedule_recurring_payment()</code> method (dead code)</p>
<p><strong>Let's categorize these gaps</strong>:</p>
<h3 id="gap-type-1-untested-private-methods-lines-95-98">Gap Type 1: Untested Private Methods (Lines 95-98)</h3>
<p>The <code>_log_suspicious_transaction()</code> method is called when fraud detection triggers, but we never tested the fraud detection path with a <code>customer_id</code>.</p>
<p><strong>Current test</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_fraud_detection_triggers</span><span class="p">():</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">fraud_threshold</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1000.00&quot;</span><span class="p">))</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;5000.00&quot;</span><span class="p">),</span>
        <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10000.00&quot;</span><span class="p">)</span>
        <span class="c1"># Missing: customer_id parameter</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
</code></pre></div>

<p><strong>The gap</strong>: We tested fraud detection, but without a <code>customer_id</code>, so <code>_log_suspicious_transaction()</code> receives <code>None</code> and the logging logic isn't fully exercised.</p>
<p><strong>The fix</strong>: Add a test with a customer ID:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_fraud_detection_logs_customer</span><span class="p">(</span><span class="n">capsys</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that fraud detection logs customer information.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">(</span><span class="n">fraud_threshold</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1000.00&quot;</span><span class="p">))</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;5000.00&quot;</span><span class="p">),</span>
        <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10000.00&quot;</span><span class="p">),</span>
        <span class="n">customer_id</span><span class="o">=</span><span class="s2">&quot;CUST-12345&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Verify fraud was detected</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>

    <span class="c1"># Verify logging occurred (using capsys to capture print output)</span>
    <span class="n">captured</span> <span class="o">=</span> <span class="n">capsys</span><span class="o">.</span><span class="n">readouterr</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s2">&quot;FRAUD ALERT&quot;</span> <span class="ow">in</span> <span class="n">captured</span><span class="o">.</span><span class="n">out</span>
    <span class="k">assert</span> <span class="s2">&quot;CUST-12345&quot;</span> <span class="ow">in</span> <span class="n">captured</span><span class="o">.</span><span class="n">out</span>
</code></pre></div>

<p><strong>Note</strong>: We use pytest's <code>capsys</code> fixture to capture the print output and verify the logging happened.</p>
<h3 id="gap-type-2-untested-edge-cases-lines-105-112">Gap Type 2: Untested Edge Cases (Lines 105-112)</h3>
<p>The <code>_is_refund_expired()</code> method checks if 30 days have passed since the transaction. Our tests only refund immediately after payment, so this path is never tested.</p>
<p><strong>The gap</strong>: We never tested refunding an old transaction.</p>
<p><strong>The fix</strong>: Test the expiry logic:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_refund_expired_transaction</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that refunds are rejected after 30 days.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">()</span>

    <span class="c1"># Process a payment</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
        <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
        <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;500.00&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">transaction_id</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">]</span>

    <span class="c1"># Manually set the transaction timestamp to 31 days ago</span>
    <span class="n">transaction</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">_find_transaction</span><span class="p">(</span><span class="n">transaction_id</span><span class="p">)</span>
    <span class="n">transaction</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">31</span><span class="p">)</span>

    <span class="c1"># Try to refund</span>
    <span class="n">refund_result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">refund_payment</span><span class="p">(</span><span class="n">transaction_id</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">refund_result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="s2">&quot;expired&quot;</span> <span class="ow">in</span> <span class="n">refund_result</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
</code></pre></div>

<p><strong>Why this works</strong>: We manipulate the transaction timestamp to simulate an old transaction, allowing us to test the expiry logic without waiting 30 days.</p>
<h3 id="gap-type-3-dead-code-lines-118-125-128-135">Gap Type 3: Dead Code (Lines 118-125, 128-135)</h3>
<p><strong>Lines 118-125</strong>: <code>_validate_customer_id()</code> is never called anywhere in the codebase.</p>
<p><strong>Lines 128-135</strong>: <code>schedule_recurring_payment()</code> returns a "not implemented" message.</p>
<p><strong>How to identify dead code</strong>:
1. Search the codebase for calls to these methods
2. Check git history to see if they were ever used
3. Ask the team if these are planned features or abandoned code</p>
<p><strong>Decision framework</strong>:</p>
<table>
<thead>
<tr>
<th>Scenario</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>Method is never called and has no clear purpose</td>
<td>Delete it</td>
</tr>
<tr>
<td>Method is planned for future use</td>
<td>Add a test that documents the intended behavior</td>
</tr>
<tr>
<td>Method is part of a public API</td>
<td>Keep it but mark as deprecated</td>
</tr>
<tr>
<td>Method is called only in commented-out code</td>
<td>Delete both</td>
</tr>
</tbody>
</table>
<p><strong>For our case</strong>: Let's assume <code>_validate_customer_id()</code> was meant to be used but was forgotten, and <code>schedule_recurring_payment()</code> is genuinely unfinished.</p>
<p><strong>Action 1</strong>: Delete <code>_validate_customer_id()</code> (it's dead code)</p>
<p><strong>Action 2</strong>: Either implement <code>schedule_recurring_payment()</code> or delete it. If keeping it, add a test:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_recurring_payments_not_implemented</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that recurring payments return not-implemented message.&quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">PaymentProcessor</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">schedule_recurring_payment</span><span class="p">(</span>
        <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
        <span class="n">frequency</span><span class="o">=</span><span class="s2">&quot;monthly&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="s2">&quot;not yet implemented&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
</code></pre></div>

<p>This test documents that the feature is intentionally unfinished.</p>
<h3 id="running-coverage-after-fixes">Running Coverage After Fixes</h3>
<p>After adding the missing tests and deleting dead code:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>--cov<span class="o">=</span>payment_processor<span class="w"> </span>--cov-report<span class="o">=</span>term-missing
</code></pre></div>

<p><strong>The output</strong>:</p>
<div class="codehilite"><pre><span></span><code>---------- coverage: platform linux, python 3.11.0 -----------
Name                    Stmts   Miss  Cover   Missing
-----------------------------------------------------
payment_processor.py       82      0   100%
-----------------------------------------------------
TOTAL                      82      0   100%

============================== 6 passed in 0.16s ===============================
</code></pre></div>

<p><strong>Achievement</strong>: 100% coverage with no dead code.</p>
<h3 id="the-coverage-gap-analysis-workflow">The Coverage Gap Analysis Workflow</h3>
<p>When you see untested code, follow this process:</p>
<p><strong>Step 1: Identify the gap</strong>
- Which lines are untested?
- What functionality do they implement?</p>
<p><strong>Step 2: Determine the gap type</strong>
- <strong>Untested feature</strong>: Add tests
- <strong>Untested edge case</strong>: Add boundary tests
- <strong>Untested error path</strong>: Add failure tests
- <strong>Dead code</strong>: Delete or document</p>
<p><strong>Step 3: Assess criticality</strong>
- Is this code in a critical path (payment, auth, data integrity)?
- What's the risk if this code has bugs?
- How likely is this code to be executed in production?</p>
<p><strong>Step 4: Take action</strong>
- High criticality + untested = Write tests immediately
- Low criticality + untested = Add to backlog
- Dead code = Delete or document as intentional</p>
<p><strong>Step 5: Verify</strong>
- Re-run coverage
- Confirm the gap is closed
- Update documentation if needed</p>
<h3 id="common-coverage-gap-patterns">Common Coverage Gap Patterns</h3>
<p><strong>Pattern 1: Error handling paths</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">expensive_operation</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># This except block is often untested</span>
        <span class="n">log_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>

<p><strong>Why it's missed</strong>: Tests focus on the happy path.</p>
<p><strong>How to test it</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_process_data_handles_value_error</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">expensive_operation</span><span class="p">(</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">process_data</span><span class="p">(</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span>
</code></pre></div>

<p><strong>Pattern 2: Conditional branches</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_discount</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">is_premium</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">is_premium</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">price</span> <span class="o">*</span> <span class="mf">0.8</span>  <span class="c1"># Often tested</span>
    <span class="k">return</span> <span class="n">price</span>  <span class="c1"># Often forgotten</span>
</code></pre></div>

<p><strong>Why it's missed</strong>: Tests focus on the interesting case (premium discount).</p>
<p><strong>How to test it</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_no_discount_for_regular_customers</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">calculate_discount</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">is_premium</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">100</span>
</code></pre></div>

<p><strong>Pattern 3: Default parameter values</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">send_email</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">cc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bcc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># cc and bcc paths are often untested</span>
    <span class="k">if</span> <span class="n">cc</span><span class="p">:</span>
        <span class="n">add_cc_recipients</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bcc</span><span class="p">:</span>
        <span class="n">add_bcc_recipients</span><span class="p">(</span><span class="n">bcc</span><span class="p">)</span>
    <span class="n">send</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
</code></pre></div>

<p><strong>Why it's missed</strong>: Tests use the most common case (no cc/bcc).</p>
<p><strong>How to test it</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_send_email_with_cc</span><span class="p">():</span>
    <span class="n">send_email</span><span class="p">(</span><span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">,</span> <span class="s2">&quot;Body&quot;</span><span class="p">,</span> <span class="n">cc</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cc@example.com&quot;</span><span class="p">])</span>
    <span class="c1"># Verify cc was added</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_send_email_with_bcc</span><span class="p">():</span>
    <span class="n">send_email</span><span class="p">(</span><span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">,</span> <span class="s2">&quot;Body&quot;</span><span class="p">,</span> <span class="n">bcc</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;bcc@example.com&quot;</span><span class="p">])</span>
    <span class="c1"># Verify bcc was added</span>
</code></pre></div>

<p><strong>Pattern 4: Early returns</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_user</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Often tested</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Sometimes missed</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Often missed</span>

    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<p><strong>Why it's missed</strong>: Tests focus on the first validation failure.</p>
<p><strong>How to test it</strong>: Test each early return separately:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_validate_user_rejects_none</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">validate_user</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_user_rejects_no_email</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">validate_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_user_rejects_inactive</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">,</span> <span class="n">is_active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">validate_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>
</code></pre></div>

<h3 id="the-dead-code-identification-checklist">The Dead Code Identification Checklist</h3>
<p>When you find untested code, ask:</p>
<ul>
<li>[ ] Is this method/function called anywhere?</li>
<li>[ ] Does it appear in git history as recently used?</li>
<li>[ ] Is it part of a public API that external code might use?</li>
<li>[ ] Is it documented as a planned feature?</li>
<li>[ ] Does it have a clear, current purpose?</li>
</ul>
<p>If all answers are "no," it's dead code. Delete it.</p>
<h3 id="coverage-gaps-in-legacy-code">Coverage Gaps in Legacy Code</h3>
<p>When working with legacy code, you'll often find large coverage gaps. <strong>Don't try to fix everything at once.</strong></p>
<p><strong>Prioritization strategy</strong>:</p>
<ol>
<li><strong>Critical paths first</strong>: Payment, authentication, data integrity</li>
<li><strong>Recently changed code</strong>: If it was just modified, test it now</li>
<li><strong>Bug-prone areas</strong>: Code that has caused production issues</li>
<li><strong>Public APIs</strong>: Code that external systems depend on</li>
<li><strong>Everything else</strong>: Gradually improve over time</li>
</ol>
<p><strong>The strangler pattern</strong>: When adding new features to legacy code, require 90%+ coverage for the new code, even if overall coverage is low. Over time, coverage improves as the codebase evolves.</p>
<h3 id="what-weve-learned_2">What We've Learned</h3>
<p>Coverage gaps fall into categories:
- <strong>Untested features</strong>: Add tests
- <strong>Untested edge cases</strong>: Add boundary tests
- <strong>Untested error paths</strong>: Add failure tests
- <strong>Dead code</strong>: Delete or document</p>
<p>The key is systematic analysis: identify the gap, determine its type, assess criticality, and take appropriate action. In the next section, we'll explore how to achieve meaningful coverage‚Äînot just high percentages.</p>
<h2 id="achieving-meaningful-coverage-not-just-high-percentages">Achieving Meaningful Coverage (Not Just High Percentages)</h2>
<h2 id="beyond-the-numbers-what-makes-coverage-meaningful">Beyond the Numbers: What Makes Coverage Meaningful</h2>
<p>You can have 100% coverage and still have a terrible test suite. Coverage measures <strong>execution</strong>, not <strong>verification</strong>. This section teaches you how to write tests that are both comprehensive and meaningful.</p>
<h3 id="the-illusion-of-high-coverage">The Illusion of High Coverage</h3>
<p>Consider this code:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_validator.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_payment_amount</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate payment amount and currency.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Amount must be positive&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">currency</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;USD&quot;</span><span class="p">,</span> <span class="s2">&quot;EUR&quot;</span><span class="p">,</span> <span class="s2">&quot;GBP&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported currency: </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Amount exceeds maximum limit&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<p>Now look at this test:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_validate_payment_amount</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test payment validation.&quot;&quot;&quot;</span>
    <span class="c1"># This gives 100% line coverage!</span>
    <span class="n">validate_payment_amount</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
    <span class="n">validate_payment_amount</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>  <span class="c1"># Raises ValueError</span>
    <span class="n">validate_payment_amount</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;JPY&quot;</span><span class="p">)</span>  <span class="c1"># Raises ValueError</span>
    <span class="n">validate_payment_amount</span><span class="p">(</span><span class="mi">2000000</span><span class="p">,</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>  <span class="c1"># Raises ValueError</span>
</code></pre></div>

<p><strong>Run coverage</strong>:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>--cov<span class="o">=</span>payment_validator<span class="w"> </span>--cov-report<span class="o">=</span>term-missing
</code></pre></div>

<p><strong>The output</strong>:</p>
<div class="codehilite"><pre><span></span><code>Name                    Stmts   Miss  Cover
-------------------------------------------
payment_validator.py        8      0   100%
-------------------------------------------
TOTAL                       8      0   100%
</code></pre></div>

<p><strong>100% coverage!</strong> But this test is <strong>completely useless</strong>. Why?</p>
<p><strong>It never checks the results</strong>. The exceptions are raised but never caught or verified. The test passes even though it doesn't assert anything about the behavior.</p>
<h3 id="diagnostic-analysis-the-problem-with-execution-only-coverage">Diagnostic Analysis: The Problem with Execution-Only Coverage</h3>
<p><strong>Run the test</strong>:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_validator.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>The output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_validator.py::test_validate_payment_amount FAILED          [100%]

================================== FAILURES ===================================
______________________ test_validate_payment_amount _______________________

    def test_validate_payment_amount():
        &quot;&quot;&quot;Test payment validation.&quot;&quot;&quot;
        validate_payment_amount(100, &quot;USD&quot;)
&gt;       validate_payment_amount(-50, &quot;USD&quot;)
E       ValueError: Amount must be positive

test_payment_validator.py:5: ValueError
=========================== short test summary info ===========================
FAILED test_payment_validator.py::test_validate_payment_amount - ValueError...
========================== 1 failed in 0.03s ===============================
</code></pre></div>

<p><strong>What happened</strong>: The test failed because the exception was raised but not handled. Yet coverage reported 100% because all lines were executed before the failure.</p>
<p><strong>The lesson</strong>: <strong>Coverage measures execution, not correctness</strong>. You can execute every line and still have no idea if the code works.</p>
<h3 id="meaningful-coverage-the-three-requirements">Meaningful Coverage: The Three Requirements</h3>
<p>For coverage to be meaningful, tests must:</p>
<ol>
<li><strong>Execute the code</strong> (what coverage measures)</li>
<li><strong>Verify the behavior</strong> (what assertions do)</li>
<li><strong>Test realistic scenarios</strong> (what good test design does)</li>
</ol>
<p>Let's rewrite the test properly:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_validate_payment_amount_accepts_valid_input</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that valid amounts and currencies are accepted.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">validate_payment_amount</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">validate_payment_amount</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="s2">&quot;EUR&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">validate_payment_amount</span><span class="p">(</span><span class="mi">999999</span><span class="p">,</span> <span class="s2">&quot;GBP&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_payment_amount_rejects_negative</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that negative amounts are rejected.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;must be positive&quot;</span><span class="p">):</span>
        <span class="n">validate_payment_amount</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;must be positive&quot;</span><span class="p">):</span>
        <span class="n">validate_payment_amount</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;EUR&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_payment_amount_rejects_invalid_currency</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that unsupported currencies are rejected.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Unsupported currency: JPY&quot;</span><span class="p">):</span>
        <span class="n">validate_payment_amount</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;JPY&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Unsupported currency: CAD&quot;</span><span class="p">):</span>
        <span class="n">validate_payment_amount</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;CAD&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validate_payment_amount_rejects_excessive</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that amounts over the limit are rejected.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;exceeds maximum limit&quot;</span><span class="p">):</span>
        <span class="n">validate_payment_amount</span><span class="p">(</span><span class="mi">1000001</span><span class="p">,</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;exceeds maximum limit&quot;</span><span class="p">):</span>
        <span class="n">validate_payment_amount</span><span class="p">(</span><span class="mi">2000000</span><span class="p">,</span> <span class="s2">&quot;EUR&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>What changed</strong>:
1. <strong>Explicit assertions</strong>: Every test verifies expected behavior
2. <strong>Proper exception handling</strong>: Using <code>pytest.raises()</code> with message matching
3. <strong>Focused tests</strong>: Each test verifies one specific behavior
4. <strong>Boundary testing</strong>: Testing edge cases (0.01, 999999, 1000001)</p>
<p><strong>Run coverage again</strong>:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>--cov<span class="o">=</span>payment_validator<span class="w"> </span>--cov-report<span class="o">=</span>term-missing<span class="w"> </span>-v
</code></pre></div>

<p><strong>The output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_payment_validator.py::test_validate_payment_amount_accepts_valid_input PASSED
test_payment_validator.py::test_validate_payment_amount_rejects_negative PASSED
test_payment_validator.py::test_validate_payment_amount_rejects_invalid_currency PASSED
test_payment_validator.py::test_validate_payment_amount_rejects_excessive PASSED

---------- coverage: platform linux, python 3.11.0 -----------
Name                    Stmts   Miss  Cover
-------------------------------------------
payment_validator.py        8      0   100%
-------------------------------------------
TOTAL                       8      0   100%

============================== 4 passed in 0.05s ===============================
</code></pre></div>

<p><strong>Still 100% coverage</strong>, but now the tests are <strong>meaningful</strong>. They verify behavior, not just execution.</p>
<h3 id="the-reference-implementation-a-complex-business-rule">The Reference Implementation: A Complex Business Rule</h3>
<p>Let's work with a more realistic example‚Äîa discount calculator with complex business logic:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># discount_calculator.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DiscountCalculator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate discounts based on complex business rules.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_discount</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">base_price</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span>
        <span class="n">customer_tier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">purchase_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
        <span class="n">is_first_purchase</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">promo_code</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decimal</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate final discount based on multiple factors.</span>

<span class="sd">        Rules:</span>
<span class="sd">        - Premium customers: 20% discount</span>
<span class="sd">        - Gold customers: 15% discount</span>
<span class="sd">        - Silver customers: 10% discount</span>
<span class="sd">        - Regular customers: 5% discount</span>
<span class="sd">        - First purchase: Additional 5% discount</span>
<span class="sd">        - Holiday season (Dec 1-31): Additional 10% discount</span>
<span class="sd">        - Promo code &quot;SAVE20&quot;: Additional 20% discount (max one promo)</span>
<span class="sd">        - Maximum total discount: 50%</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">discount_percentage</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>

        <span class="c1"># Base tier discount</span>
        <span class="n">tier_discounts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;premium&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.20&quot;</span><span class="p">),</span>
            <span class="s2">&quot;gold&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.15&quot;</span><span class="p">),</span>
            <span class="s2">&quot;silver&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.10&quot;</span><span class="p">),</span>
            <span class="s2">&quot;regular&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.05&quot;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">discount_percentage</span> <span class="o">+=</span> <span class="n">tier_discounts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">customer_tier</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
            <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.05&quot;</span><span class="p">)</span>  <span class="c1"># Default to regular</span>
        <span class="p">)</span>

        <span class="c1"># First purchase bonus</span>
        <span class="k">if</span> <span class="n">is_first_purchase</span><span class="p">:</span>
            <span class="n">discount_percentage</span> <span class="o">+=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.05&quot;</span><span class="p">)</span>

        <span class="c1"># Holiday season bonus</span>
        <span class="k">if</span> <span class="n">purchase_date</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">discount_percentage</span> <span class="o">+=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.10&quot;</span><span class="p">)</span>

        <span class="c1"># Promo code</span>
        <span class="k">if</span> <span class="n">promo_code</span> <span class="o">==</span> <span class="s2">&quot;SAVE20&quot;</span><span class="p">:</span>
            <span class="n">discount_percentage</span> <span class="o">+=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.20&quot;</span><span class="p">)</span>

        <span class="c1"># Cap at 50% maximum discount</span>
        <span class="k">if</span> <span class="n">discount_percentage</span> <span class="o">&gt;</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.50&quot;</span><span class="p">):</span>
            <span class="n">discount_percentage</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.50&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate final price</span>
        <span class="n">discount_amount</span> <span class="o">=</span> <span class="n">base_price</span> <span class="o">*</span> <span class="n">discount_percentage</span>
        <span class="k">return</span> <span class="n">base_price</span> <span class="o">-</span> <span class="n">discount_amount</span>
</code></pre></div>

<p>This is complex business logic with multiple interacting rules. Let's write tests that achieve meaningful coverage.</p>
<h3 id="iteration-1-naive-testing-approach">Iteration 1: Naive Testing Approach</h3>
<p>A naive approach might test each rule in isolation:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_premium_customer_discount</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test premium customer gets 20% discount.&quot;&quot;&quot;</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">DiscountCalculator</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">calculate_discount</span><span class="p">(</span>
        <span class="n">base_price</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
        <span class="n">customer_tier</span><span class="o">=</span><span class="s2">&quot;premium&quot;</span><span class="p">,</span>
        <span class="n">purchase_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;80.00&quot;</span><span class="p">)</span>  <span class="c1"># 20% off</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_first_purchase_bonus</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test first purchase gets additional 5% discount.&quot;&quot;&quot;</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">DiscountCalculator</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">calculate_discount</span><span class="p">(</span>
        <span class="n">base_price</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
        <span class="n">customer_tier</span><span class="o">=</span><span class="s2">&quot;regular&quot;</span><span class="p">,</span>
        <span class="n">purchase_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
        <span class="n">is_first_purchase</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;90.00&quot;</span><span class="p">)</span>  <span class="c1"># 5% + 5% = 10% off</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_holiday_season_bonus</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test December purchases get additional 10% discount.&quot;&quot;&quot;</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">DiscountCalculator</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">calculate_discount</span><span class="p">(</span>
        <span class="n">base_price</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
        <span class="n">customer_tier</span><span class="o">=</span><span class="s2">&quot;regular&quot;</span><span class="p">,</span>
        <span class="n">purchase_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;85.00&quot;</span><span class="p">)</span>  <span class="c1"># 5% + 10% = 15% off</span>
</code></pre></div>

<p><strong>Run coverage</strong>:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>--cov<span class="o">=</span>discount_calculator<span class="w"> </span>--cov-report<span class="o">=</span>term-missing
</code></pre></div>

<p><strong>The output</strong>:</p>
<div class="codehilite"><pre><span></span><code>Name                      Stmts   Miss  Cover   Missing
-------------------------------------------------------
discount_calculator.py       24      3    88%   52-54
-------------------------------------------------------
TOTAL                        24      3    88%
</code></pre></div>

<p><strong>88% coverage</strong>‚Äînot bad! But we're missing lines 52-54 (the promo code logic). More importantly, <strong>we haven't tested the interactions between rules</strong>.</p>
<h3 id="the-problem-missing-interaction-testing">The Problem: Missing Interaction Testing</h3>
<p>Our tests verify individual rules, but real-world scenarios involve <strong>multiple rules interacting</strong>:</p>
<ul>
<li>What happens when a premium customer makes a first purchase in December with a promo code?</li>
<li>Does the 50% cap work correctly when multiple discounts stack?</li>
<li>What happens with invalid customer tiers?</li>
</ul>
<p><strong>These interactions are where bugs hide</strong>, and our current tests don't cover them.</p>
<h3 id="iteration-2-comprehensive-interaction-testing">Iteration 2: Comprehensive Interaction Testing</h3>
<p>Let's add tests for rule interactions:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_maximum_discount_cap</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that discount is capped at 50% even when rules stack higher.&quot;&quot;&quot;</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">DiscountCalculator</span><span class="p">()</span>

    <span class="c1"># Premium (20%) + First purchase (5%) + Holiday (10%) + Promo (20%) = 55%</span>
    <span class="c1"># Should be capped at 50%</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">calculate_discount</span><span class="p">(</span>
        <span class="n">base_price</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
        <span class="n">customer_tier</span><span class="o">=</span><span class="s2">&quot;premium&quot;</span><span class="p">,</span>
        <span class="n">purchase_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
        <span class="n">is_first_purchase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">promo_code</span><span class="o">=</span><span class="s2">&quot;SAVE20&quot;</span>
    <span class="p">)</span>

    <span class="c1"># 50% cap means final price is $50.00</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;50.00&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_multiple_discounts_stack_correctly</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that multiple discounts combine additively.&quot;&quot;&quot;</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">DiscountCalculator</span><span class="p">()</span>

    <span class="c1"># Gold (15%) + First purchase (5%) + Holiday (10%) = 30%</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">calculate_discount</span><span class="p">(</span>
        <span class="n">base_price</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
        <span class="n">customer_tier</span><span class="o">=</span><span class="s2">&quot;gold&quot;</span><span class="p">,</span>
        <span class="n">purchase_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
        <span class="n">is_first_purchase</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;70.00&quot;</span><span class="p">)</span>  <span class="c1"># 30% off</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_promo_code_ignored</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that invalid promo codes don&#39;t affect discount.&quot;&quot;&quot;</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">DiscountCalculator</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">calculate_discount</span><span class="p">(</span>
        <span class="n">base_price</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
        <span class="n">customer_tier</span><span class="o">=</span><span class="s2">&quot;regular&quot;</span><span class="p">,</span>
        <span class="n">purchase_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
        <span class="n">promo_code</span><span class="o">=</span><span class="s2">&quot;INVALID&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Only regular 5% discount applies</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;95.00&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_unknown_customer_tier_defaults_to_regular</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that unknown tiers get regular discount.&quot;&quot;&quot;</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">DiscountCalculator</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">calculate_discount</span><span class="p">(</span>
        <span class="n">base_price</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
        <span class="n">customer_tier</span><span class="o">=</span><span class="s2">&quot;platinum&quot;</span><span class="p">,</span>  <span class="c1"># Not in the tier list</span>
        <span class="n">purchase_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Should default to 5% regular discount</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;95.00&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_non_december_no_holiday_bonus</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that non-December purchases don&#39;t get holiday bonus.&quot;&quot;&quot;</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">DiscountCalculator</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">calculate_discount</span><span class="p">(</span>
        <span class="n">base_price</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
        <span class="n">customer_tier</span><span class="o">=</span><span class="s2">&quot;premium&quot;</span><span class="p">,</span>
        <span class="n">purchase_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>  <span class="c1"># November 30</span>
    <span class="p">)</span>

    <span class="c1"># Only premium 20% discount</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;80.00&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Run coverage again</strong>:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>--cov<span class="o">=</span>discount_calculator<span class="w"> </span>--cov-report<span class="o">=</span>term-missing<span class="w"> </span>-v
</code></pre></div>

<p><strong>The output</strong>:</p>
<div class="codehilite"><pre><span></span><code>test_discount_calculator.py::test_premium_customer_discount PASSED
test_discount_calculator.py::test_first_purchase_bonus PASSED
test_discount_calculator.py::test_holiday_season_bonus PASSED
test_discount_calculator.py::test_maximum_discount_cap PASSED
test_discount_calculator.py::test_multiple_discounts_stack_correctly PASSED
test_discount_calculator.py::test_invalid_promo_code_ignored PASSED
test_discount_calculator.py::test_unknown_customer_tier_defaults_to_regular PASSED
test_discount_calculator.py::test_non_december_no_holiday_bonus PASSED

---------- coverage: platform linux, python 3.11.0 -----------
Name                      Stmts   Miss  Cover
----------------------------------------------
discount_calculator.py       24      0   100%
----------------------------------------------
TOTAL                        24      0   100%

============================== 8 passed in 0.08s ===============================
</code></pre></div>

<p><strong>100% coverage</strong> with <strong>meaningful tests</strong> that verify:
- Individual rules work correctly
- Rules interact correctly when combined
- Edge cases are handled (invalid inputs, boundary conditions)
- The maximum cap prevents excessive discounts</p>
<h3 id="the-meaningful-coverage-checklist">The Meaningful Coverage Checklist</h3>
<p>When writing tests for high-value coverage, ensure:</p>
<p><strong>1. Behavior Verification</strong>
- [ ] Every test has explicit assertions
- [ ] Assertions verify the expected outcome, not just execution
- [ ] Exception tests use <code>pytest.raises()</code> with message matching</p>
<p><strong>2. Boundary Testing</strong>
- [ ] Test minimum valid values (e.g., 0.01, empty list)
- [ ] Test maximum valid values (e.g., 999999, list size limits)
- [ ] Test just below boundaries (e.g., -0.01, 1000001)
- [ ] Test just above boundaries (e.g., 0, 1000000)</p>
<p><strong>3. Interaction Testing</strong>
- [ ] Test how multiple features interact
- [ ] Test rule combinations that might conflict
- [ ] Test cascading effects (A affects B affects C)</p>
<p><strong>4. Error Path Testing</strong>
- [ ] Test all exception paths
- [ ] Test validation failures
- [ ] Test resource exhaustion scenarios
- [ ] Test timeout and retry logic</p>
<p><strong>5. Realistic Scenarios</strong>
- [ ] Test with production-like data
- [ ] Test common user workflows
- [ ] Test edge cases that have occurred in production</p>
<h3 id="property-based-testing-for-comprehensive-coverage">Property-Based Testing for Comprehensive Coverage</h3>
<p>For complex logic, consider <strong>property-based testing</strong> with Hypothesis:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">hypothesis</span><span class="w"> </span><span class="kn">import</span> <span class="n">given</span><span class="p">,</span> <span class="n">strategies</span> <span class="k">as</span> <span class="n">st</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>

<span class="nd">@given</span><span class="p">(</span>
    <span class="n">base_price</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">decimals</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.01&quot;</span><span class="p">),</span> <span class="n">max_value</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10000&quot;</span><span class="p">)),</span>
    <span class="n">customer_tier</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">sampled_from</span><span class="p">([</span><span class="s2">&quot;premium&quot;</span><span class="p">,</span> <span class="s2">&quot;gold&quot;</span><span class="p">,</span> <span class="s2">&quot;silver&quot;</span><span class="p">,</span> <span class="s2">&quot;regular&quot;</span><span class="p">]),</span>
    <span class="n">purchase_date</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">datetimes</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
    <span class="n">is_first_purchase</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">booleans</span><span class="p">(),</span>
    <span class="n">promo_code</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">one_of</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">none</span><span class="p">(),</span> <span class="n">st</span><span class="o">.</span><span class="n">just</span><span class="p">(</span><span class="s2">&quot;SAVE20&quot;</span><span class="p">),</span> <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_discount_never_exceeds_50_percent</span><span class="p">(</span>
    <span class="n">base_price</span><span class="p">,</span> <span class="n">customer_tier</span><span class="p">,</span> <span class="n">purchase_date</span><span class="p">,</span> <span class="n">is_first_purchase</span><span class="p">,</span> <span class="n">promo_code</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Property: Final price should never be less than 50% of base price.&quot;&quot;&quot;</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">DiscountCalculator</span><span class="p">()</span>

    <span class="n">final_price</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">calculate_discount</span><span class="p">(</span>
        <span class="n">base_price</span><span class="o">=</span><span class="n">base_price</span><span class="p">,</span>
        <span class="n">customer_tier</span><span class="o">=</span><span class="n">customer_tier</span><span class="p">,</span>
        <span class="n">purchase_date</span><span class="o">=</span><span class="n">purchase_date</span><span class="p">,</span>
        <span class="n">is_first_purchase</span><span class="o">=</span><span class="n">is_first_purchase</span><span class="p">,</span>
        <span class="n">promo_code</span><span class="o">=</span><span class="n">promo_code</span>
    <span class="p">)</span>

    <span class="c1"># The discount cap should ensure final price &gt;= 50% of base</span>
    <span class="k">assert</span> <span class="n">final_price</span> <span class="o">&gt;=</span> <span class="n">base_price</span> <span class="o">*</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.50&quot;</span><span class="p">)</span>

<span class="nd">@given</span><span class="p">(</span>
    <span class="n">base_price</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">decimals</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.01&quot;</span><span class="p">),</span> <span class="n">max_value</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10000&quot;</span><span class="p">)),</span>
    <span class="n">customer_tier</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">sampled_from</span><span class="p">([</span><span class="s2">&quot;premium&quot;</span><span class="p">,</span> <span class="s2">&quot;gold&quot;</span><span class="p">,</span> <span class="s2">&quot;silver&quot;</span><span class="p">,</span> <span class="s2">&quot;regular&quot;</span><span class="p">]),</span>
    <span class="n">purchase_date</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">datetimes</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_discount_is_monotonic_with_tier</span><span class="p">(</span><span class="n">base_price</span><span class="p">,</span> <span class="n">customer_tier</span><span class="p">,</span> <span class="n">purchase_date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Property: Higher tiers should never result in higher prices.&quot;&quot;&quot;</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">DiscountCalculator</span><span class="p">()</span>

    <span class="n">tier_order</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;regular&quot;</span><span class="p">,</span> <span class="s2">&quot;silver&quot;</span><span class="p">,</span> <span class="s2">&quot;gold&quot;</span><span class="p">,</span> <span class="s2">&quot;premium&quot;</span><span class="p">]</span>
    <span class="n">current_tier_index</span> <span class="o">=</span> <span class="n">tier_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">customer_tier</span><span class="p">)</span>

    <span class="n">current_price</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">calculate_discount</span><span class="p">(</span>
        <span class="n">base_price</span><span class="o">=</span><span class="n">base_price</span><span class="p">,</span>
        <span class="n">customer_tier</span><span class="o">=</span><span class="n">customer_tier</span><span class="p">,</span>
        <span class="n">purchase_date</span><span class="o">=</span><span class="n">purchase_date</span>
    <span class="p">)</span>

    <span class="c1"># Check that upgrading tier never increases price</span>
    <span class="k">for</span> <span class="n">higher_tier</span> <span class="ow">in</span> <span class="n">tier_order</span><span class="p">[</span><span class="n">current_tier_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]:</span>
        <span class="n">higher_price</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">calculate_discount</span><span class="p">(</span>
            <span class="n">base_price</span><span class="o">=</span><span class="n">base_price</span><span class="p">,</span>
            <span class="n">customer_tier</span><span class="o">=</span><span class="n">higher_tier</span><span class="p">,</span>
            <span class="n">purchase_date</span><span class="o">=</span><span class="n">purchase_date</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">higher_price</span> <span class="o">&lt;=</span> <span class="n">current_price</span>
</code></pre></div>

<p><strong>What property-based testing adds</strong>:
- Tests thousands of random input combinations
- Finds edge cases you didn't think of
- Verifies invariants (properties that should always hold)
- Complements example-based tests</p>
<h3 id="coverage-anti-patterns-to-avoid">Coverage Anti-Patterns to Avoid</h3>
<p><strong>Anti-Pattern 1: Testing implementation details</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># BAD: Testing internal state</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_discount_calculator_internal_state</span><span class="p">():</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">DiscountCalculator</span><span class="p">()</span>
    <span class="n">calculator</span><span class="o">.</span><span class="n">calculate_discount</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100&quot;</span><span class="p">),</span> <span class="s2">&quot;premium&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

    <span class="c1"># Don&#39;t test internal variables that aren&#39;t part of the public API</span>
    <span class="k">assert</span> <span class="n">calculator</span><span class="o">.</span><span class="n">_last_discount_percentage</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.20&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Why it's bad</strong>: Tests break when you refactor internal implementation, even if behavior is unchanged.</p>
<p><strong>Anti-Pattern 2: Assertion-free tests</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># BAD: No assertions</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_discount</span><span class="p">():</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">DiscountCalculator</span><span class="p">()</span>
    <span class="n">calculator</span><span class="o">.</span><span class="n">calculate_discount</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100&quot;</span><span class="p">),</span> <span class="s2">&quot;premium&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="c1"># Test passes but verifies nothing</span>
</code></pre></div>

<p><strong>Why it's bad</strong>: 100% coverage but 0% verification.</p>
<p><strong>Anti-Pattern 3: Testing only happy paths</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># BAD: Only tests success cases</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_all_tiers</span><span class="p">():</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">DiscountCalculator</span><span class="p">()</span>

    <span class="n">calculator</span><span class="o">.</span><span class="n">calculate_discount</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100&quot;</span><span class="p">),</span> <span class="s2">&quot;premium&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="n">calculator</span><span class="o">.</span><span class="n">calculate_discount</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100&quot;</span><span class="p">),</span> <span class="s2">&quot;gold&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="n">calculator</span><span class="o">.</span><span class="n">calculate_discount</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100&quot;</span><span class="p">),</span> <span class="s2">&quot;silver&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="c1"># Never tests invalid tier, negative price, etc.</span>
</code></pre></div>

<p><strong>Why it's bad</strong>: Real bugs often occur in error paths and edge cases.</p>
<p><strong>Anti-Pattern 4: Over-mocking</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># BAD: Mocking everything</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_discount</span><span class="p">(</span><span class="n">mocker</span><span class="p">):</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">DiscountCalculator</span><span class="p">()</span>

    <span class="c1"># Mocking internal methods defeats the purpose of integration testing</span>
    <span class="n">mocker</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">calculator</span><span class="p">,</span> <span class="s1">&#39;_get_tier_discount&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.20&quot;</span><span class="p">))</span>
    <span class="n">mocker</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">calculator</span><span class="p">,</span> <span class="s1">&#39;_apply_first_purchase_bonus&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.05&quot;</span><span class="p">))</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">calculate_discount</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100&quot;</span><span class="p">),</span> <span class="s2">&quot;premium&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="c1"># You&#39;re testing mocks, not real behavior</span>
</code></pre></div>

<p><strong>Why it's bad</strong>: You're testing that mocks return what you told them to return, not that the real code works.</p>
<h3 id="the-meaningful-coverage-workflow">The Meaningful Coverage Workflow</h3>
<p><strong>Step 1: Write tests for the happy path</strong>
- Test the most common, successful scenarios
- Verify expected outputs with explicit assertions</p>
<p><strong>Step 2: Add boundary tests</strong>
- Test minimum and maximum valid values
- Test just outside valid ranges</p>
<p><strong>Step 3: Add error path tests</strong>
- Test all exception conditions
- Test validation failures
- Test resource exhaustion</p>
<p><strong>Step 4: Add interaction tests</strong>
- Test how features combine
- Test rule conflicts and priorities
- Test cascading effects</p>
<p><strong>Step 5: Add property-based tests (optional)</strong>
- Define invariants that should always hold
- Let Hypothesis find edge cases</p>
<p><strong>Step 6: Review coverage report</strong>
- Identify any remaining gaps
- Assess whether gaps are critical
- Add tests or document why gaps are acceptable</p>
<h3 id="when-to-stop-adding-tests">When to Stop Adding Tests</h3>
<p>You've achieved meaningful coverage when:</p>
<ol>
<li><strong>All critical paths are tested</strong> with explicit assertions</li>
<li><strong>All error conditions are tested</strong> and verified</li>
<li><strong>Boundary conditions are tested</strong> at edges and just beyond</li>
<li><strong>Feature interactions are tested</strong> for common combinations</li>
<li><strong>Coverage is high</strong> (80%+ for critical code)</li>
<li><strong>Tests are maintainable</strong> (not brittle, not over-mocked)</li>
<li><strong>Tests document behavior</strong> (readable, well-named)</li>
</ol>
<p><strong>Don't chase 100% coverage</strong> if it means:
- Testing trivial getters/setters
- Testing framework code
- Testing generated code
- Writing tests that don't add value</p>
<h3 id="the-final-wisdom-coverage-as-a-tool-not-a-goal">The Final Wisdom: Coverage as a Tool, Not a Goal</h3>
<p><strong>Coverage is a means to an end</strong>, not the end itself. The goal is <strong>confidence that your code works correctly</strong>.</p>
<p><strong>Good coverage</strong>:
- Executes all critical code paths
- Verifies expected behavior with assertions
- Tests realistic scenarios and edge cases
- Finds bugs before production</p>
<p><strong>Bad coverage</strong>:
- Executes code without verifying behavior
- Tests only happy paths
- Ignores error handling and edge cases
- Gives false confidence</p>
<p><strong>The ultimate test</strong>: If you deleted a line of production code, would a test fail? If not, your coverage isn't meaningful.</p>
<h3 id="what-weve-learned_3">What We've Learned</h3>
<p>Meaningful coverage requires:
- <strong>Execution</strong> (what coverage measures)
- <strong>Verification</strong> (what assertions provide)
- <strong>Realistic scenarios</strong> (what good test design ensures)</p>
<p>High coverage percentage is necessary but not sufficient. Focus on:
- Testing behavior, not implementation
- Testing interactions, not just isolated features
- Testing error paths, not just happy paths
- Testing boundaries, not just typical values</p>
<p>When you combine high coverage with meaningful tests, you get what really matters: <strong>confidence that your code works</strong>.</p>
        </div>
        <div class="footer">
            Generated on 2025-12-03 10:37:06 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>