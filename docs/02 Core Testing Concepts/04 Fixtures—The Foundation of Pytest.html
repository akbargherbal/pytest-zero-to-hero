<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>04 Fixtures‚ÄîThe Foundation of Pytest</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">02 Core Testing Concepts</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-4-fixturesthe-foundation-of-pytest">Chapter 4: Fixtures‚ÄîThe Foundation of Pytest</h1>
<h2 id="what-are-fixtures">What Are Fixtures?</h2>
<h2 id="what-are-fixtures_1">What Are Fixtures?</h2>
<p>In the world of testing, a "test fixture" is a standardized context in which tests are run. It's everything your test needs to be in place <em>before</em> it can execute and be cleaned up <em>after</em> it finishes. This includes:</p>
<ul>
<li><strong>Data</strong>: Loading a specific dataset from a file or database.</li>
<li><strong>Objects</strong>: Creating instances of classes your test will interact with.</li>
<li><strong>Connections</strong>: Establishing a connection to a database or a network service.</li>
<li><strong>State</strong>: Putting the system into a known state, like logging in a user.</li>
<li><strong>Resources</strong>: Creating temporary files or directories.</li>
</ul>
<p>Without a fixture system, you would have to manually write setup and teardown code for every single test function. This leads to two major problems:</p>
<ol>
<li><strong>Repetition</strong>: You end up copy-pasting the same setup code over and over again.</li>
<li><strong>Brittleness</strong>: If the setup logic needs to change, you have to find and update it in dozens of places.</li>
</ol>
<p>Pytest's fixture system is its most powerful and distinctive feature. It solves these problems by providing a modular, reusable, and elegant way to manage the context of your tests.</p>
<h3 id="the-philosophy-composition-over-inheritance">The Philosophy: Composition over Inheritance</h3>
<p>Unlike older testing frameworks (like Python's built-in <code>unittest</code>) that rely on <code>setUp</code> and <code>tearDown</code> methods within large test classes, pytest encourages a different approach. Pytest fixtures are standalone functions that you "request" by name in your test's arguments.</p>
<p>This is a shift from <strong>inheritance</strong> (where a test class inherits its setup from a base class) to <strong>composition</strong> (where a test function composes its context from the fixtures it needs).</p>
<p>This approach has several advantages:
-   <strong>Explicit</strong>: You can see exactly what a test needs just by looking at its signature.
-   <strong>Modular</strong>: Fixtures are small, independent, and focused on doing one thing well.
-   <strong>Reusable</strong>: The same fixture can be used by any number of tests across your entire test suite.
-   <strong>Scalable</strong>: You can build complex fixtures by combining simpler ones, just like building with LEGO bricks.</p>
<p>In this chapter, we will build a test suite for a simple data processing utility. We'll start by doing everything the "wrong" way‚Äîmanually‚Äîto feel the pain. Then, we will progressively refactor our code, introducing one fixture concept at a time to solve each problem we encounter. This journey will transform our messy, repetitive tests into a clean, maintainable, and professional test suite.</p>
<h2 id="simple-fixtures-setup-and-teardown">Simple Fixtures: Setup and Teardown</h2>
<h2 id="simple-fixtures-setup-and-teardown_1">Simple Fixtures: Setup and Teardown</h2>
<p>Before we dive into pytest's decorator-based fixture system, let's establish our anchor example and see what testing looks like without a proper fixture system. This will help us understand the exact problems that fixtures are designed to solve.</p>
<h3 id="the-anchor-example-a-simple-data-processor">The Anchor Example: A Simple Data Processor</h3>
<p>Imagine we have a utility class, <code>DataProcessor</code>, that reads numerical data from a file, calculates the average, and can tell us the total number of data points.</p>
<p>Here is the code we need to test. Save this in a file named <code>data_processor.py</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># data_processor.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DataProcessor</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the processor with the path to a data file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="n">data_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_data</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads data from a JSON file.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">record_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the number of records.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_average</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates the average of a given column.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">or</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">total</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_count</span>
</code></pre></div>

<h3 id="iteration-0-the-manual-approach">Iteration 0: The "Manual" Approach</h3>
<p>To test this class, we need a temporary file with some known data. Our first attempt at a test might look like this. We'll create a <code>tests</code> directory and save this file as <code>tests/test_data_processor_manual.py</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_data_processor_manual.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">data_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataProcessor</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_record_count</span><span class="p">():</span>
    <span class="c1"># --- Setup ---</span>
    <span class="c1"># 1. Create a temporary directory</span>
    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
    <span class="c1"># 2. Define the path for our temporary data file</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;test_data.json&quot;</span><span class="p">)</span>
    <span class="c1"># 3. Define our test data</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="c1"># 4. Write the data to the file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="c1"># --- Test Execution ---</span>
    <span class="c1"># 5. Create an instance of our class</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">DataProcessor</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="c1"># 6. Assert the behavior</span>
    <span class="k">assert</span> <span class="n">processor</span><span class="o">.</span><span class="n">record_count</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="c1"># --- Teardown ---</span>
    <span class="c1"># 7. Clean up the file and directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_average</span><span class="p">():</span>
    <span class="c1"># --- Setup (Repetitive!) ---</span>
    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;test_data.json&quot;</span><span class="p">)</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="c1"># --- Test Execution ---</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">DataProcessor</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">processor</span><span class="o">.</span><span class="n">calculate_average</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mf">20.0</span>

    <span class="c1"># --- Teardown (Repetitive!) ---</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
</code></pre></div>

<p>Let's run this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v
<span class="o">=========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==========================</span>
...
collected<span class="w"> </span><span class="m">2</span><span class="w"> </span>items

tests/test_data_processor_manual.py::test_record_count<span class="w"> </span>PASSED<span class="w">    </span><span class="o">[</span><span class="w"> </span><span class="m">50</span>%<span class="o">]</span>
tests/test_data_processor_manual.py::test_calculate_average<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">==========================</span><span class="w"> </span><span class="m">2</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span>...s<span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>The tests pass, but the code is deeply flawed.</p>
<h3 id="current-limitation-repetition-and-fragility">Current Limitation: Repetition and Fragility</h3>
<ol>
<li><strong>Violation of DRY (Don't Repeat Yourself)</strong>: The setup and teardown logic is duplicated in both tests. If we need to add a third test, we'll have to copy it all again. If the data format changes, we have to update it in multiple places.</li>
<li><strong>Fragile Teardown</strong>: What happens if the assertion in <code>test_record_count</code> fails? The test function will exit immediately, and the teardown code (<code>os.remove</code>, <code>os.rmdir</code>) will <strong>never run</strong>. This leaves orphaned temporary files on our system.</li>
</ol>
<p>This is the core problem that fixtures solve: providing <strong>reusable</strong> and <strong>robust</strong> setup and teardown.</p>
<h2 id="the-pytestfixture-decorator">The @pytest.fixture Decorator</h2>
<h2 id="the-pytestfixture-decorator_1">The @pytest.fixture Decorator</h2>
<p>Pytest provides a simple and powerful way to extract setup and teardown logic into a reusable component: the <code>@pytest.fixture</code> decorator.</p>
<p>A fixture is just a Python function decorated with <code>@pytest.fixture</code>. This function can perform setup, return or <code>yield</code> a value to the test, and perform teardown.</p>
<h3 id="iteration-1-refactoring-to-a-basic-fixture">Iteration 1: Refactoring to a Basic Fixture</h3>
<p>Let's fix the problems from our previous iteration. We will create a single fixture to handle the creation and cleanup of our temporary data file.</p>
<p><strong>The <code>yield</code> Keyword: The Key to Teardown</strong></p>
<p>The <code>yield</code> statement is the magic that separates setup from teardown.
-   Everything <strong>before</strong> the <code>yield</code> is <strong>setup</strong> code.
-   The value that is <code>yield</code>ed is what gets passed to the test function.
-   Everything <strong>after</strong> the <code>yield</code> is <strong>teardown</strong> code. Pytest guarantees this code will run, even if the test fails.</p>
<p>Here is the refactored code. We'll create a new file, <code>tests/test_data_processor_v1.py</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_data_processor_v1.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">data_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataProcessor</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">temp_data_file</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A fixture that creates a temporary data file with sample data</span>
<span class="sd">    and cleans it up after the test.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># --- Setup ---</span>
    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;test_data.json&quot;</span><span class="p">)</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="c1"># --- Yield the resource to the test ---</span>
    <span class="k">yield</span> <span class="n">file_path</span>

    <span class="c1"># --- Teardown ---</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Cleaning up temporary file and directory...&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_record_count</span><span class="p">(</span><span class="n">temp_data_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests that the record_count property is correct.</span>
<span class="sd">    The &#39;temp_data_file&#39; argument tells pytest to run the fixture.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The fixture provides the file_path</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">DataProcessor</span><span class="p">(</span><span class="n">temp_data_file</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">processor</span><span class="o">.</span><span class="n">record_count</span> <span class="o">==</span> <span class="mi">3</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_average</span><span class="p">(</span><span class="n">temp_data_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests that the calculate_average method is correct.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">DataProcessor</span><span class="p">(</span><span class="n">temp_data_file</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">processor</span><span class="o">.</span><span class="n">calculate_average</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mf">20.0</span>
</code></pre></div>

<h3 id="how-it-works">How It Works</h3>
<ol>
<li><strong>Declaration</strong>: We defined a function <code>temp_data_file</code> and decorated it with <code>@pytest.fixture</code>.</li>
<li><strong>Requesting</strong>: Our test functions now accept an argument with the <em>exact same name</em> as the fixture function (<code>temp_data_file</code>). This is how you "request" a fixture.</li>
<li><strong>Execution</strong>: Before running <code>test_record_count</code>, pytest sees the <code>temp_data_file</code> parameter. It finds the fixture with that name, executes it up to the <code>yield</code> statement, and passes the yielded value (<code>file_path</code>) into the test function as the argument.</li>
<li><strong>Teardown</strong>: After <code>test_record_count</code> completes (whether it passes or fails), pytest resumes the fixture function and executes the code after the <code>yield</code> statement, ensuring our temporary file is cleaned up.</li>
</ol>
<p>Let's run it. The <code>-s</code> flag tells pytest to show any <code>print</code> statements.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v<span class="w"> </span>-s<span class="w"> </span>tests/test_data_processor_v1.py
<span class="o">=========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==========================</span>
...
collected<span class="w"> </span><span class="m">2</span><span class="w"> </span>items

tests/test_data_processor_v1.py::test_record_count<span class="w"> </span>PASSED
Cleaning<span class="w"> </span>up<span class="w"> </span>temporary<span class="w"> </span>file<span class="w"> </span>and<span class="w"> </span>directory...
tests/test_data_processor_v1.py::test_calculate_average<span class="w"> </span>PASSED
Cleaning<span class="w"> </span>up<span class="w"> </span>temporary<span class="w"> </span>file<span class="w"> </span>and<span class="w"> </span>directory...

<span class="o">==========================</span><span class="w"> </span><span class="m">2</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span>...s<span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<h3 id="expected-vs-actual-improvement">Expected vs. Actual Improvement</h3>
<ul>
<li><strong>Expected</strong>: We wanted to remove code duplication and ensure cleanup happens.</li>
<li><strong>Actual</strong>: We have achieved exactly that. The setup/teardown logic is now in one place. The tests are clean, readable, and focused only on the "execution" and "assertion" parts. The <code>print</code> statement confirms our cleanup code ran for each test.</li>
</ul>
<p>This is a massive improvement, but we can already spot a new limitation.</p>
<h2 id="fixture-scope-function-class-module-and-session">Fixture Scope: Function, Class, Module, and Session</h2>
<h2 id="fixture-scope-function-class-module-and-session_1">Fixture Scope: Function, Class, Module, and Session</h2>
<h3 id="current-limitation-inefficient-setup">Current Limitation: Inefficient Setup</h3>
<p>Look at the output from the last run. The line "Cleaning up temporary file and directory..." appeared twice. This means our <code>temp_data_file</code> fixture ran once for <code>test_record_count</code> and then <em>again</em> for <code>test_calculate_average</code>.</p>
<p>For a small temporary file, this is no big deal. But what if our setup involved:
-   Creating a large, multi-megabyte file?
-   Connecting to a database?
-   Starting an external service?</p>
<p>Running this expensive setup before <em>every single test function</em> would make our test suite incredibly slow. The data in our file is read-only; both tests could have safely shared the same file.</p>
<p>This is where <strong>fixture scope</strong> comes in. The scope controls how often a fixture is created and destroyed.</p>
<h3 id="the-four-fixture-scopes">The Four Fixture Scopes</h3>
<p>Pytest defines four scopes, from narrowest to broadest:</p>
<table>
<thead>
<tr>
<th>Scope</th>
<th>Description</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>function</code></td>
<td><strong>(Default)</strong> The fixture is set up and torn down for each individual test function.</td>
<td>When a test needs a clean, isolated object that it might modify.</td>
</tr>
<tr>
<td><code>class</code></td>
<td>The fixture is set up once per test class. All methods in the class share the same fixture instance.</td>
<td>Grouping tests that operate on the same expensive-to-create resource.</td>
</tr>
<tr>
<td><code>module</code></td>
<td>The fixture is set up once per module (i.e., once per <code>.py</code> file). All tests in the file share it.</td>
<td>When all tests in a file can share a read-only resource.</td>
</tr>
<tr>
<td><code>session</code></td>
<td>The fixture is set up once at the beginning of the entire test session and torn down at the very end.</td>
<td>A global resource like a database connection pool for the whole suite.</td>
</tr>
</tbody>
</table>
<p>You define the scope by passing the <code>scope</code> argument to the decorator: <code>@pytest.fixture(scope="module")</code>.</p>
<h3 id="iteration-2-optimizing-with-scopemodule">Iteration 2: Optimizing with <code>scope="module"</code></h3>
<p>Since our tests only read from the data file, they can safely share it. Let's change the scope to <code>module</code> and see the effect.</p>
<p>Create a new file <code>tests/test_data_processor_v2.py</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_data_processor_v2.py</span>

<span class="c1"># ... (imports are the same) ...</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">data_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataProcessor</span>

<span class="c1"># --- BEFORE: The original fixture (default function scope) ---</span>
<span class="c1"># @pytest.fixture</span>
<span class="c1"># def temp_data_file():</span>
<span class="c1">#     ...</span>

<span class="c1"># --- AFTER: The improved fixture with module scope ---</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">temp_data_file</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A module-scoped fixture that creates a temporary data file.</span>
<span class="sd">    It runs only ONCE for all tests in this file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Setting up module-scoped temporary file...&quot;</span><span class="p">)</span>
    <span class="c1"># --- Setup ---</span>
    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;test_data.json&quot;</span><span class="p">)</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">file_path</span>

    <span class="c1"># --- Teardown ---</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Cleaning up module-scoped temporary file...&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_record_count</span><span class="p">(</span><span class="n">temp_data_file</span><span class="p">):</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">DataProcessor</span><span class="p">(</span><span class="n">temp_data_file</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">processor</span><span class="o">.</span><span class="n">record_count</span> <span class="o">==</span> <span class="mi">3</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_average</span><span class="p">(</span><span class="n">temp_data_file</span><span class="p">):</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">DataProcessor</span><span class="p">(</span><span class="n">temp_data_file</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">processor</span><span class="o">.</span><span class="n">calculate_average</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mf">20.0</span>
</code></pre></div>

<p>Now, let's run this version and pay close attention to the output.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v<span class="w"> </span>-s<span class="w"> </span>tests/test_data_processor_v2.py
<span class="o">=========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==========================</span>
...
collected<span class="w"> </span><span class="m">2</span><span class="w"> </span>items

tests/test_data_processor_v2.py::test_record_count
Setting<span class="w"> </span>up<span class="w"> </span>module-scoped<span class="w"> </span>temporary<span class="w"> </span>file...
PASSED
tests/test_data_processor_v2.py::test_calculate_average<span class="w"> </span><span class="nv">PASSED</span>

<span class="o">==============================</span><span class="w"> </span><span class="nv">teardown</span><span class="w"> </span><span class="o">==============================</span>
Cleaning<span class="w"> </span>up<span class="w"> </span>module-scoped<span class="w"> </span>temporary<span class="w"> </span>file...

<span class="o">==========================</span><span class="w"> </span><span class="m">2</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span>...s<span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-output">Diagnostic Analysis: Reading the Output</h3>
<p><strong>The output</strong>:</p>
<div class="codehilite"><pre><span></span><code>Setting<span class="w"> </span>up<span class="w"> </span>module-scoped<span class="w"> </span>temporary<span class="w"> </span>file...
PASSED
PASSED
Cleaning<span class="w"> </span>up<span class="w"> </span>module-scoped<span class="w"> </span>temporary<span class="w"> </span>file...
</code></pre></div>

<p><strong>Let's parse this</strong>:</p>
<ol>
<li><strong>The setup line</strong>: <code>Setting up module-scoped temporary file...</code> appears only <strong>once</strong>, before any tests are run.</li>
<li><strong>The test results</strong>: Both tests pass as expected.</li>
<li><strong>The teardown line</strong>: <code>Cleaning up module-scoped temporary file...</code> appears only <strong>once</strong>, after all tests in the module have completed.</li>
</ol>
<p><strong>Root cause identified</strong>: By changing the scope from <code>function</code> to <code>module</code>, we instructed pytest to run the setup and teardown logic only once for the entire <code>test_data_processor_v2.py</code> file.</p>
<p><strong>Why the previous approach was inefficient</strong>: The default <code>function</code> scope is safe but can be slow if the setup is expensive and the resource can be shared.</p>
<p><strong>What we gained</strong>: A significantly faster and more efficient test suite.</p>
<h3 id="when-to-apply-this-solution">When to Apply This Solution</h3>
<ul>
<li><strong>What it optimizes for</strong>: Performance. It dramatically reduces redundant setup/teardown operations.</li>
<li><strong>What it sacrifices</strong>: Isolation. All tests using the fixture now share the <em>same instance</em> of the resource. If one test modifies the resource (e.g., writes to the file), it will affect subsequent tests.</li>
<li><strong>When to choose <code>module</code> or <code>session</code> scope</strong>: When the resource is read-only, or when the tests are explicitly designed to build on each other's state (which is generally an anti-pattern, but sometimes necessary).</li>
<li><strong>When to stick with <code>function</code> scope</strong>: When each test needs a pristine, completely isolated version of the resource. This is the safest default.</li>
</ul>
<h2 id="using-fixtures-in-your-tests">Using Fixtures in Your Tests</h2>
<h2 id="using-fixtures-in-your-tests_1">Using Fixtures in Your Tests</h2>
<p>We've already seen the primary way to use a fixture: by adding a parameter to your test function with the same name as the fixture.</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_fixture</span><span class="p">():</span>
    <span class="k">return</span> <span class="mi">42</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_something</span><span class="p">(</span><span class="n">my_fixture</span><span class="p">):</span>  <span class="c1"># Requesting the fixture</span>
    <span class="k">assert</span> <span class="n">my_fixture</span> <span class="o">==</span> <span class="mi">42</span>
</code></pre></div>

<p>However, there are other ways to use fixtures that solve different problems.</p>
<h3 id="using-fixtures-without-a-return-value-autouse">Using Fixtures Without a Return Value (<code>autouse</code>)</h3>
<p>Sometimes, you have a fixture that needs to run for every test, but it doesn't return a value. For example, a fixture that resets a database connection or ensures a directory is clean. It would be tedious to add it as an argument to every single test.</p>
<p>For this, you can use <code>autouse=True</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">clean_directory_before_each_test</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">(AUTOUSE) Ensuring directory is clean...&quot;</span><span class="p">)</span>
    <span class="c1"># ... logic to clean a directory ...</span>
    <span class="k">yield</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">(AUTOUSE) Post-test cleanup.&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_one</span><span class="p">():</span>
    <span class="c1"># This test will use the autouse fixture automatically</span>
    <span class="k">assert</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_two</span><span class="p">():</span>
    <span class="c1"># This one too, without needing to request it</span>
    <span class="k">assert</span> <span class="kc">True</span>
</code></pre></div>

<p>Running this with <code>-s</code> shows the autouse fixture wrapping each test:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v<span class="w"> </span>-s
...
collected<span class="w"> </span><span class="m">2</span><span class="w"> </span>items

test_file.py::test_one
<span class="o">(</span>AUTOUSE<span class="o">)</span><span class="w"> </span>Ensuring<span class="w"> </span>directory<span class="w"> </span>is<span class="w"> </span>clean...
PASSED
<span class="o">(</span>AUTOUSE<span class="o">)</span><span class="w"> </span>Post-test<span class="w"> </span>cleanup.

test_file.py::test_two
<span class="o">(</span>AUTOUSE<span class="o">)</span><span class="w"> </span>Ensuring<span class="w"> </span>directory<span class="w"> </span>is<span class="w"> </span>clean...
PASSED
<span class="o">(</span>AUTOUSE<span class="o">)</span><span class="w"> </span>Post-test<span class="w"> </span>cleanup.
...
</code></pre></div>

<p><strong>Warning</strong>: Use <code>autouse</code> fixtures with caution. They can make your tests harder to understand because they introduce "magic" behavior. It's no longer obvious from a test's signature what setup is being performed. They are best used for broad, cross-cutting concerns within a <code>conftest.py</code> file (which we'll cover later).</p>
<h3 id="marking-fixtures-pytestmarkusefixtures">Marking Fixtures (<code>pytest.mark.usefixtures</code>)</h3>
<p>An alternative to <code>autouse</code> that is more explicit is the <code>@pytest.mark.usefixtures</code> marker. This allows you to apply a fixture to a test (or class) without adding it to the function signature. This is useful for fixtures that don't return a value but where you want to be explicit about their use.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">non_returning_fixture</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Setting up non-returning fixture...&quot;</span><span class="p">)</span>
    <span class="k">yield</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Tearing down non-returning fixture...&quot;</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s2">&quot;non_returning_fixture&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_with_marker</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Running test_with_marker...&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="kc">True</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s2">&quot;non_returning_fixture&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TestAClass</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_method_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Running test_method_one...&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="kc">True</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_method_two</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Running test_method_two...&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="kc">True</span>
</code></pre></div>

<p>This approach keeps the function signature clean while still explicitly stating the test's dependencies via the marker.</p>
<h2 id="fixture-dependencies-and-composition">Fixture Dependencies and Composition</h2>
<h2 id="fixture-dependencies-and-composition_1">Fixture Dependencies and Composition</h2>
<h3 id="current-limitation-the-monolithic-fixture">Current Limitation: The Monolithic Fixture</h3>
<p>Our <code>temp_data_file</code> fixture is doing okay, but it's not very modular. It's responsible for:
1.  Creating a temporary directory.
2.  Constructing a file path.
3.  Defining test data.
4.  Writing the data to the file.</p>
<p>What if another test needs just an empty temporary directory? Or what if we want to test our <code>DataProcessor</code> with different sets of data? Our current fixture is a monolith; it's all or nothing.</p>
<p>The true power of pytest fixtures is that they can <strong>request other fixtures</strong>, just like tests can. This allows you to build a dependency graph of small, single-purpose fixtures that compose into a complex test context.</p>
<h3 id="iteration-3-decomposing-into-composable-fixtures">Iteration 3: Decomposing into Composable Fixtures</h3>
<p>Let's break down our monolithic fixture into smaller, more reusable parts.</p>
<ol>
<li>A <code>temp_dir</code> fixture: <code>session</code>-scoped, as we can probably use the same temp directory for the whole run.</li>
<li>A <code>sample_data</code> fixture: A simple fixture that just returns the data dictionary. This makes it easy to override for other tests.</li>
<li>A <code>temp_data_file</code> fixture: This will now <em>depend on</em> <code>temp_dir</code> and <code>sample_data</code> to do its job.</li>
<li>A <code>data_processor</code> fixture: This is the highest level. It will depend on <code>temp_data_file</code> and give our tests a ready-to-use <code>DataProcessor</code> instance.</li>
</ol>
<p>Here is the new, beautifully composed implementation in <code>tests/test_data_processor_v3.py</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/test_data_processor_v3.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">data_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataProcessor</span>

<span class="c1"># Fixture 1: Lowest level - a session-scoped temporary directory</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">temp_dir</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A session-scoped temporary directory.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tempdir</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">Path</span><span class="p">(</span><span class="n">tempdir</span><span class="p">)</span>

<span class="c1"># Fixture 2: Just returns data, easy to override</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sample_data</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sample data for testing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">},</span>
    <span class="p">]</span>

<span class="c1"># Fixture 3: Depends on temp_dir and sample_data</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">temp_data_file</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">sample_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A module-scoped file, built from other fixtures.&quot;&quot;&quot;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">temp_dir</span> <span class="o">/</span> <span class="s2">&quot;test_data.json&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sample_data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">file_path</span>

<span class="c1"># Fixture 4: The highest level, depends on temp_data_file</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">data_processor</span><span class="p">(</span><span class="n">temp_data_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A DataProcessor instance ready for testing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">DataProcessor</span><span class="p">(</span><span class="n">temp_data_file</span><span class="p">)</span>

<span class="c1"># --- The tests are now incredibly simple and readable ---</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_record_count</span><span class="p">(</span><span class="n">data_processor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The test now requests the high-level object it needs.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">data_processor</span><span class="o">.</span><span class="n">record_count</span> <span class="o">==</span> <span class="mi">3</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculate_average</span><span class="p">(</span><span class="n">data_processor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The complexity is hidden in the composed fixtures.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">data_processor</span><span class="o">.</span><span class="n">calculate_average</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mf">20.0</span>
</code></pre></div>

<h3 id="banish-magic-visualizing-the-dependency-graph">Banish Magic: Visualizing the Dependency Graph</h3>
<p>How does pytest figure this out? It builds a dependency graph and executes fixtures in the correct order. We can ask pytest to show us this setup plan using the <code>--setup-show</code> flag.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>tests/test_data_processor_v3.py<span class="w"> </span>--setup-show
<span class="o">=========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==========================</span>
...
collected<span class="w"> </span><span class="m">2</span><span class="w"> </span>items

tests/test_data_processor_v3.py
SETUP<span class="w">    </span>S<span class="w"> </span>temp_dir<span class="w"> </span><span class="o">(</span>session<span class="o">)</span>
<span class="w">        </span>SETUP<span class="w">    </span>M<span class="w"> </span>temp_data_file<span class="w"> </span><span class="o">(</span>module<span class="o">)</span>
<span class="w">                </span>SETUP<span class="w">    </span>F<span class="w"> </span>sample_data<span class="w"> </span><span class="o">(</span><span class="k">function</span><span class="o">)</span>
<span class="w">                </span>SETUP<span class="w">    </span>F<span class="w"> </span>data_processor<span class="w"> </span><span class="o">(</span><span class="k">function</span><span class="o">)</span>
<span class="w">                        </span>tests/test_data_processor_v3.py::test_record_count<span class="w"> </span><span class="o">(</span>fixtures<span class="w"> </span>used:<span class="w"> </span>data_processor,<span class="w"> </span>sample_data,<span class="w"> </span>temp_data_file,<span class="w"> </span>temp_dir<span class="o">)</span>
<span class="w">                </span>TEARDOWN<span class="w"> </span>F<span class="w"> </span>data_processor
<span class="w">                </span>TEARDOWN<span class="w"> </span>F<span class="w"> </span>sample_data
<span class="w">                </span>SETUP<span class="w">    </span>F<span class="w"> </span>sample_data<span class="w"> </span><span class="o">(</span><span class="k">function</span><span class="o">)</span>
<span class="w">                </span>SETUP<span class="w">    </span>F<span class="w"> </span>data_processor<span class="w"> </span><span class="o">(</span><span class="k">function</span><span class="o">)</span>
<span class="w">                        </span>tests/test_data_processor_v3.py::test_calculate_average<span class="w"> </span><span class="o">(</span>fixtures<span class="w"> </span>used:<span class="w"> </span>data_processor,<span class="w"> </span>sample_data,<span class="w"> </span>temp_data_file,<span class="w"> </span>temp_dir<span class="o">)</span>
<span class="w">                </span>TEARDOWN<span class="w"> </span>F<span class="w"> </span>data_processor
<span class="w">                </span>TEARDOWN<span class="w"> </span>F<span class="w"> </span>sample_data
<span class="w">        </span>TEARDOWN<span class="w"> </span>M<span class="w"> </span>temp_data_file
TEARDOWN<span class="w"> </span>S<span class="w"> </span><span class="nv">temp_dir</span>

<span class="o">==========================</span><span class="w"> </span><span class="m">2</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span>...s<span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<h3 id="analysis-of-setup-show">Analysis of <code>--setup-show</code></h3>
<ul>
<li><code>SETUP S temp_dir</code>: The <code>session</code>-scoped <code>temp_dir</code> is set up first and only once.</li>
<li><code>SETUP M temp_data_file</code>: The <code>module</code>-scoped <code>temp_data_file</code> is set up next, also only once. It can use <code>temp_dir</code>.</li>
<li><code>SETUP F data_processor</code>: Before each test, the <code>function</code>-scoped <code>data_processor</code> is set up. It can use <code>temp_data_file</code>.</li>
<li>The tests run.</li>
<li>Teardown happens in the reverse order of setup: <code>F</code>unction -&gt; <code>M</code>odule -&gt; <code>S</code>ession.</li>
</ul>
<h3 id="expected-vs-actual-improvement_1">Expected vs. Actual Improvement</h3>
<ul>
<li><strong>Expected</strong>: We wanted more modular and reusable setup components.</li>
<li><strong>Actual</strong>: We achieved this perfectly. Our tests are now incredibly declarative. They simply ask for the object they need (<code>data_processor</code>), and pytest handles the complex chain of dependencies required to build it. We can now easily reuse <code>temp_dir</code> or <code>sample_data</code> in other tests for different purposes.</li>
</ul>
        </div>
        <div class="footer">
            Generated on 2025-11-24 14:31:15 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>