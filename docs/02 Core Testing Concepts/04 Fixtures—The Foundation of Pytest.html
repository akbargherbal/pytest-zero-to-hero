<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>04 Fixtures‚ÄîThe Foundation of Pytest</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">02 Core Testing Concepts</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-4-fixturesthe-foundation-of-pytest">Chapter 4: Fixtures‚ÄîThe Foundation of Pytest</h1>
<h2 id="what-are-fixtures">What Are Fixtures?</h2>
<h2 id="the-problem-fixtures-solve">The Problem Fixtures Solve</h2>
<p>Before we define what fixtures are, let's understand the problem they solve. Consider testing a user authentication system. Every test needs a database connection, a user account, and perhaps some test data. Without fixtures, you'd write this setup code in every single test function.</p>
<p>Let's see this problem in action with a concrete example: testing a <code>UserAuthenticator</code> class that validates user credentials against a database.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># auth.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserAuthenticator</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_connection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db_connection</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify username and password against database.&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">password</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if user has admin privileges.&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;admin&#39;</span>
</code></pre></div>

<p>Now let's write tests for this authenticator. Here's the naive approach‚Äîthe way you might write tests before learning about fixtures:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_auth_naive.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAuthenticator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MockDatabase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple in-memory database for testing.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_valid_user</span><span class="p">():</span>
    <span class="c1"># Setup: Create database and add test user</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
    <span class="n">authenticator</span> <span class="o">=</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="c1"># Test: Valid credentials should authenticate</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_invalid_password</span><span class="p">():</span>
    <span class="c1"># Setup: Create database and add test user</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
    <span class="n">authenticator</span> <span class="o">=</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="c1"># Test: Wrong password should fail</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;wrong_password&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_nonexistent_user</span><span class="p">():</span>
    <span class="c1"># Setup: Create database and add test user</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
    <span class="n">authenticator</span> <span class="o">=</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="c1"># Test: Unknown user should fail</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="s1">&#39;any_password&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_is_admin_for_admin_user</span><span class="p">():</span>
    <span class="c1"># Setup: Create database and add admin user</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;admin_user&#39;</span><span class="p">,</span> <span class="s1">&#39;admin_pass&#39;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>
    <span class="n">authenticator</span> <span class="o">=</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="c1"># Test: Admin user should be identified</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">is_admin</span><span class="p">(</span><span class="s1">&#39;admin_user&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_is_admin_for_regular_user</span><span class="p">():</span>
    <span class="c1"># Setup: Create database and add regular user</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>
    <span class="n">authenticator</span> <span class="o">=</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="c1"># Test: Regular user should not be admin</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">is_admin</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">False</span>
</code></pre></div>

<p>Let's run these tests to verify they work:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_auth_naive.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mh">5</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_auth_naive</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_authenticate_valid_user</span><span class="w"> </span><span class="n">PASSED</span><span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="mh">20</span><span class="o">%</span><span class="p">]</span>
<span class="n">test_auth_naive</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_authenticate_invalid_password</span><span class="w"> </span><span class="n">PASSED</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mh">40</span><span class="o">%</span><span class="p">]</span>
<span class="n">test_auth_naive</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_authenticate_nonexistent_user</span><span class="w"> </span><span class="n">PASSED</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mh">60</span><span class="o">%</span><span class="p">]</span>
<span class="n">test_auth_naive</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_is_admin_for_admin_user</span><span class="w"> </span><span class="n">PASSED</span><span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="mh">80</span><span class="o">%</span><span class="p">]</span>
<span class="n">test_auth_naive</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_is_admin_for_regular_user</span><span class="w"> </span><span class="n">PASSED</span><span class="w">      </span><span class="p">[</span><span class="mh">100</span><span class="o">%</span><span class="p">]</span>

<span class="o">=========================</span><span class="w"> </span><span class="mh">5</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="mf">0.02</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>The tests pass! But look closely at the code. Notice the problem?</p>
<h3 id="the-code-duplication-problem">The Code Duplication Problem</h3>
<p>Every single test repeats these three lines:</p>
<div class="codehilite"><pre><span></span><code><span class="n">db</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
<span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
<span class="n">authenticator</span> <span class="o">=</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre></div>

<p>This is <strong>setup code</strong>‚Äîthe scaffolding needed before you can test the actual behavior. In our five tests, we've written these setup lines 15 times. This creates several problems:</p>
<ol>
<li><strong>Maintenance burden</strong>: If we need to change how the database is initialized, we must update every test</li>
<li><strong>Inconsistency risk</strong>: It's easy to accidentally create different setups in different tests</li>
<li><strong>Obscured intent</strong>: The actual test logic is buried among setup code</li>
<li><strong>Scaling nightmare</strong>: With 50 tests, you'd have 150 lines of duplicated setup</li>
</ol>
<h3 id="what-if-we-need-more-complex-setup">What If We Need More Complex Setup?</h3>
<p>The problem gets worse as setup becomes more complex. Imagine if our authenticator also needed:
- A configuration object
- A logging system
- A cache layer
- A password hashing service</p>
<p>Each test would need 10-15 lines of setup before getting to the actual assertion. The test file would become unreadable.</p>
<h2 id="fixtures-the-solution">Fixtures: The Solution</h2>
<p><strong>A fixture is a function that provides setup (and optionally teardown) for your tests.</strong> Instead of copying setup code into every test, you write it once in a fixture, and pytest automatically runs that fixture before each test that needs it.</p>
<p>Here's the key insight: <strong>Fixtures turn setup code into reusable components.</strong></p>
<p>Think of fixtures as:
- <strong>Ingredients</strong> that your tests consume
- <strong>Dependencies</strong> that pytest automatically provides
- <strong>Building blocks</strong> that compose together</p>
<p>When you write a test that needs a database connection, you don't create the database yourself‚Äîyou declare that your test needs a <code>db</code> fixture, and pytest handles the rest.</p>
<h3 id="the-fixture-mental-model">The Fixture Mental Model</h3>
<p>Before we see the syntax, understand the concept:</p>
<ol>
<li><strong>You define a fixture</strong>: A function decorated with <code>@pytest.fixture</code> that returns the setup object</li>
<li><strong>You declare dependencies</strong>: Tests request fixtures by name as function parameters</li>
<li><strong>Pytest handles execution</strong>: Before running your test, pytest automatically calls the fixture and passes the result to your test</li>
</ol>
<p>This is <strong>dependency injection</strong>‚Äîyour test declares what it needs, and pytest provides it.</p>
<p>Let's see this in action by refactoring our authentication tests to use fixtures.</p>
<h2 id="simple-fixtures-setup-and-teardown">Simple Fixtures: Setup and Teardown</h2>
<h2 id="refactoring-to-fixtures-first-attempt">Refactoring to Fixtures: First Attempt</h2>
<p>Let's transform our duplicated setup code into a fixture. We'll start with the simplest possible fixture‚Äîone that just provides the database.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_auth_with_fixtures.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAuthenticator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MockDatabase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple in-memory database for testing.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a clean database for each test.&quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">database</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_valid_user</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="n">authenticator</span> <span class="o">=</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_invalid_password</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="n">authenticator</span> <span class="o">=</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;wrong_password&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">False</span>
</code></pre></div>

<p>Let's break down what just happened:</p>
<h3 id="anatomy-of-a-fixture">Anatomy of a Fixture</h3>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">database</span>
</code></pre></div>

<ol>
<li><strong><code>@pytest.fixture</code></strong>: This decorator tells pytest "this function is a fixture"</li>
<li><strong><code>def db():</code></strong>: The fixture name becomes the parameter name tests use</li>
<li><strong>Setup code</strong>: Everything before <code>return</code> runs before each test</li>
<li><strong><code>return database</code></strong>: The fixture provides this object to tests</li>
</ol>
<h3 id="using-a-fixture">Using a Fixture</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_valid_user</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="n">authenticator</span> <span class="o">=</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span>
</code></pre></div>

<p>Notice the test function now has a parameter: <code>db</code>. This is <strong>not</strong> a normal function parameter. When pytest sees this:</p>
<ol>
<li>It looks for a fixture named <code>db</code></li>
<li>It calls that fixture function</li>
<li>It passes the return value to your test</li>
</ol>
<p>You never call <code>db()</code> yourself. Pytest handles it automatically.</p>
<p>Let's run these tests to verify the fixture works:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_auth_with_fixtures.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 2 items

test_auth_with_fixtures.py::test_authenticate_valid_user PASSED [ 50%]
test_auth_with_fixtures.py::test_authenticate_invalid_password PASSED [100%]

========================= 2 passed in 0.01s ==========================
</code></pre></div>

<p>Perfect! The tests pass. But we can improve this further.</p>
<h2 id="composing-fixtures-building-on-top-of-other-fixtures">Composing Fixtures: Building on Top of Other Fixtures</h2>
<p>Our tests still repeat this line:</p>
<div class="codehilite"><pre><span></span><code><span class="n">authenticator</span> <span class="o">=</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre></div>

<p>Let's create a fixture for the authenticator itself. Here's where fixtures become powerful‚Äî<strong>fixtures can use other fixtures</strong>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_auth_composed.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAuthenticator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MockDatabase</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a clean database for each test.&quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;admin_user&#39;</span><span class="p">,</span> <span class="s1">&#39;admin_pass&#39;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">database</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticator</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide an authenticator connected to the test database.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_valid_user</span><span class="p">(</span><span class="n">authenticator</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_invalid_password</span><span class="p">(</span><span class="n">authenticator</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;wrong_password&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_nonexistent_user</span><span class="p">(</span><span class="n">authenticator</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="s1">&#39;any_password&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_is_admin_for_admin_user</span><span class="p">(</span><span class="n">authenticator</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">is_admin</span><span class="p">(</span><span class="s1">&#39;admin_user&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_is_admin_for_regular_user</span><span class="p">(</span><span class="n">authenticator</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">is_admin</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">False</span>
</code></pre></div>

<h3 id="fixture-composition-in-action">Fixture Composition in Action</h3>
<p>Look at the <code>authenticator</code> fixture:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticator</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre></div>

<p>This fixture <strong>depends on</strong> the <code>db</code> fixture. When pytest runs a test that needs <code>authenticator</code>:</p>
<ol>
<li>Pytest sees the test needs <code>authenticator</code></li>
<li>Pytest sees <code>authenticator</code> needs <code>db</code></li>
<li>Pytest calls <code>db()</code> first</li>
<li>Pytest passes the result to <code>authenticator(db)</code></li>
<li>Pytest passes the authenticator to your test</li>
</ol>
<p>This is <strong>fixture composition</strong>‚Äîbuilding complex setup from simple pieces.</p>
<p>Now look at our tests:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_valid_user</span><span class="p">(</span><span class="n">authenticator</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span>
</code></pre></div>

<p>The test is now <strong>pure test logic</strong>. No setup code at all. The test clearly states what it's testing and what the expected outcome is.</p>
<p>Let's verify this works:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_auth_composed.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mh">5</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_auth_composed</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_authenticate_valid_user</span><span class="w"> </span><span class="n">PASSED</span><span class="w">      </span><span class="p">[</span><span class="w"> </span><span class="mh">20</span><span class="o">%</span><span class="p">]</span>
<span class="n">test_auth_composed</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_authenticate_invalid_password</span><span class="w"> </span><span class="n">PASSED</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">40</span><span class="o">%</span><span class="p">]</span>
<span class="n">test_auth_composed</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_authenticate_nonexistent_user</span><span class="w"> </span><span class="n">PASSED</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">60</span><span class="o">%</span><span class="p">]</span>
<span class="n">test_auth_composed</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_is_admin_for_admin_user</span><span class="w"> </span><span class="n">PASSED</span><span class="w">      </span><span class="p">[</span><span class="w"> </span><span class="mh">80</span><span class="o">%</span><span class="p">]</span>
<span class="n">test_auth_composed</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_is_admin_for_regular_user</span><span class="w"> </span><span class="n">PASSED</span><span class="w">    </span><span class="p">[</span><span class="mh">100</span><span class="o">%</span><span class="p">]</span>

<span class="o">=========================</span><span class="w"> </span><span class="mh">5</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="mf">0.02</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<h2 id="teardown-cleaning-up-after-tests">Teardown: Cleaning Up After Tests</h2>
<p>So far, our fixtures only do <strong>setup</strong>‚Äîthey create objects before tests run. But what about <strong>teardown</strong>‚Äîcleaning up after tests finish?</p>
<p>Consider a fixture that opens a real database connection or creates temporary files. You need to close the connection or delete the files after each test. This is where teardown comes in.</p>
<h3 id="the-yield-pattern">The Yield Pattern</h3>
<p>Fixtures can use <code>yield</code> instead of <code>return</code> to provide both setup and teardown:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_auth_with_teardown.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAuthenticator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MockDatabase</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_open</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_open</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Database connection closed&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_open</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Database connection closed&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulate closing a database connection.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_open</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a database with automatic cleanup.&quot;&quot;&quot;</span>
    <span class="c1"># Setup: Create and populate database</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;admin_user&#39;</span><span class="p">,</span> <span class="s1">&#39;admin_pass&#39;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>

    <span class="c1"># Provide the database to the test</span>
    <span class="k">yield</span> <span class="n">database</span>

    <span class="c1"># Teardown: Clean up after test completes</span>
    <span class="n">database</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticator</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_valid_user</span><span class="p">(</span><span class="n">authenticator</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_database_is_fresh_for_each_test</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify each test gets a clean database.&quot;&quot;&quot;</span>
    <span class="c1"># This test modifies the database</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;temporary_user&#39;</span><span class="p">,</span> <span class="s1">&#39;temp_pass&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="s1">&#39;temporary_user&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_previous_test_modifications_are_gone</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify the previous test&#39;s changes don&#39;t persist.&quot;&quot;&quot;</span>
    <span class="c1"># The temporary_user from the previous test should not exist</span>
    <span class="k">assert</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="s1">&#39;temporary_user&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
</code></pre></div>

<h3 id="how-yield-works-in-fixtures">How Yield Works in Fixtures</h3>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">database</span>  <span class="c1"># Pause here, run the test</span>

    <span class="n">database</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Resume here after test completes</span>
</code></pre></div>

<p>The execution flow:</p>
<ol>
<li><strong>Setup phase</strong>: Everything before <code>yield</code> runs</li>
<li><strong>Test execution</strong>: Pytest runs your test with the yielded value</li>
<li><strong>Teardown phase</strong>: Everything after <code>yield</code> runs (even if the test fails)</li>
</ol>
<p>The teardown code <strong>always runs</strong>, even if:
- The test fails with an assertion error
- The test raises an exception
- The test is skipped</p>
<p>This guarantees cleanup happens.</p>
<p>Let's run these tests to see the teardown in action:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_auth_with_teardown.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 3 items

test_auth_with_teardown.py::test_authenticate_valid_user PASSED [ 33%]
test_auth_with_teardown.py::test_database_is_fresh_for_each_test PASSED [ 66%]
test_auth_with_teardown.py::test_previous_test_modifications_are_gone PASSED [100%]

========================= 3 passed in 0.01s ==========================
</code></pre></div>

<p>The third test passes, proving that each test gets a fresh database. The <code>temporary_user</code> added in the second test doesn't exist in the third test because the fixture's teardown code ran between them.</p>
<h2 id="visualizing-fixture-execution">Visualizing Fixture Execution</h2>
<p>To make fixture execution visible, let's add print statements:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_fixture_execution_order.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAuthenticator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MockDatabase</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FIXTURE] Setting up database&quot;</span><span class="p">)</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">database</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FIXTURE] Tearing down database&quot;</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticator</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FIXTURE] Creating authenticator&quot;</span><span class="p">)</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">auth</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FIXTURE] Cleaning up authenticator&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_first</span><span class="p">(</span><span class="n">authenticator</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] Running test_first&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_second</span><span class="p">(</span><span class="n">authenticator</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] Running test_second&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;wrong&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>
</code></pre></div>

<p>Run with <code>-s</code> to see print output:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_fixture_execution_order.py<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_fixture_execution_order</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_first</span><span class="w"> </span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Setting</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="k">database</span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Creating</span><span class="w"> </span><span class="n">authenticator</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">Running</span><span class="w"> </span><span class="n">test_first</span>
<span class="n">PASSED</span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Cleaning</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">authenticator</span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Tearing</span><span class="w"> </span><span class="n">down</span><span class="w"> </span><span class="k">database</span>

<span class="n">test_fixture_execution_order</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_second</span><span class="w"> </span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Setting</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="k">database</span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Creating</span><span class="w"> </span><span class="n">authenticator</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">Running</span><span class="w"> </span><span class="n">test_second</span>
<span class="n">PASSED</span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Cleaning</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">authenticator</span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Tearing</span><span class="w"> </span><span class="n">down</span><span class="w"> </span><span class="k">database</span>

<span class="o">=========================</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.02</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>This reveals the execution order:</p>
<p><strong>For each test:</strong>
1. Setup <code>db</code> fixture
2. Setup <code>authenticator</code> fixture (which uses <code>db</code>)
3. Run the test
4. Teardown <code>authenticator</code> fixture
5. Teardown <code>db</code> fixture</p>
<p>Notice that teardown happens in <strong>reverse order</strong> of setup. This is crucial‚Äîthe authenticator is cleaned up before the database it depends on.</p>
<h2 id="when-to-use-return-vs-yield">When to Use Return vs. Yield</h2>
<p><strong>Use <code>return</code></strong> when:
- No cleanup is needed
- The fixture creates simple objects (strings, numbers, lists)
- The fixture creates objects that Python's garbage collector will handle</p>
<p><strong>Use <code>yield</code></strong> when:
- You need to close connections (database, network, files)
- You need to delete temporary resources (files, directories)
- You need to restore state (environment variables, global settings)
- You want to verify post-test conditions</p>
<p>Most fixtures in real projects use <code>yield</code> because cleanup is usually necessary.</p>
<h2 id="the-pytestfixture-decorator">The @pytest.fixture Decorator</h2>
<h2 id="understanding-the-pytestfixture-decorator">Understanding the @pytest.fixture Decorator</h2>
<p>We've been using <code>@pytest.fixture</code> without fully explaining what it does. Let's explore the decorator's capabilities and options.</p>
<h3 id="basic-decorator-usage">Basic Decorator Usage</h3>
<p>The simplest form we've already seen:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_fixture</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;some value&quot;</span>
</code></pre></div>

<p>This creates a fixture with default settings. But the decorator accepts several parameters that control fixture behavior.</p>
<h2 id="fixture-names-and-aliasing">Fixture Names and Aliasing</h2>
<p>By default, the fixture name is the function name. But you can override this:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_fixture_naming.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;database&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_fixture</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The fixture is called &#39;database&#39;, not &#39;db_fixture&#39;.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[]}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_with_renamed_fixture</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
    <span class="c1"># We use &#39;database&#39;, not &#39;db_fixture&#39;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
</code></pre></div>

<p>This is useful when:
- The fixture function name is verbose for internal clarity
- You want a shorter name for tests to use
- You're refactoring and want to maintain backward compatibility</p>
<p>However, <strong>most fixtures should use the default name</strong>. Explicit naming is rarely necessary.</p>
<h2 id="fixture-parameters-controlling-behavior">Fixture Parameters: Controlling Behavior</h2>
<p>The <code>@pytest.fixture</code> decorator accepts several parameters. Let's explore them systematically.</p>
<h3 id="the-scope-parameter">The <code>scope</code> Parameter</h3>
<p>We'll cover scope in detail in section 4.4, but here's a preview:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>  <span class="c1"># Default: runs for each test</span>
<span class="k">def</span><span class="w"> </span><span class="nf">per_test_fixture</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;fresh for each test&quot;</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>  <span class="c1"># Runs once per test file</span>
<span class="k">def</span><span class="w"> </span><span class="nf">per_module_fixture</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;shared across all tests in this file&quot;</span>
</code></pre></div>

<h3 id="the-autouse-parameter">The <code>autouse</code> Parameter</h3>
<p>Normally, fixtures only run when tests explicitly request them. But <code>autouse=True</code> makes a fixture run automatically for all tests:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_autouse.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">reset_global_state</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This runs before EVERY test automatically.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[AUTO] Resetting global state&quot;</span><span class="p">)</span>
    <span class="c1"># Reset some global state here</span>
    <span class="k">yield</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[AUTO] Cleanup complete&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_first</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] test_first&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_second</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] test_second&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="kc">True</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_autouse.py<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_autouse</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_first</span><span class="w"> </span>
<span class="o">[</span><span class="n">AUTO</span><span class="o">]</span><span class="w"> </span><span class="n">Resetting</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="k">state</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">test_first</span>
<span class="n">PASSED</span>
<span class="o">[</span><span class="n">AUTO</span><span class="o">]</span><span class="w"> </span><span class="n">Cleanup</span><span class="w"> </span><span class="n">complete</span>

<span class="n">test_autouse</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_second</span><span class="w"> </span>
<span class="o">[</span><span class="n">AUTO</span><span class="o">]</span><span class="w"> </span><span class="n">Resetting</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="k">state</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">test_second</span>
<span class="n">PASSED</span>
<span class="o">[</span><span class="n">AUTO</span><span class="o">]</span><span class="w"> </span><span class="n">Cleanup</span><span class="w"> </span><span class="n">complete</span>

<span class="o">=========================</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.01</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>Notice that <code>reset_global_state</code> ran for both tests even though neither test requested it.</p>
<p><strong>When to use <code>autouse=True</code>:</strong>
- Resetting global state between tests
- Setting up logging or monitoring
- Configuring test environment variables
- Ensuring consistent test isolation</p>
<p><strong>When NOT to use <code>autouse=True</code>:</strong>
- When only some tests need the fixture (wastes resources)
- When the fixture is expensive to create
- When the fixture's purpose isn't obvious (makes tests harder to understand)</p>
<h3 id="the-params-parameter">The <code>params</code> Parameter</h3>
<p>This enables <strong>fixture parametrization</strong>‚Äîrunning tests with multiple fixture values. We'll explore this in depth in section 4.4, but here's a taste:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_fixture_params.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="s1">&#39;charlie&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">username</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This fixture will run tests three times, once per username.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_username_length</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This test runs three times with different usernames.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] Testing with username: </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_fixture_params.py<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_fixture_params</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_username_length</span><span class="o">[</span><span class="n">alice</span><span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">Testing</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nl">username</span><span class="p">:</span><span class="w"> </span><span class="n">alice</span>
<span class="n">PASSED</span>
<span class="n">test_fixture_params</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_username_length</span><span class="o">[</span><span class="n">bob</span><span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">Testing</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nl">username</span><span class="p">:</span><span class="w"> </span><span class="n">bob</span>
<span class="n">PASSED</span>
<span class="n">test_fixture_params</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_username_length</span><span class="o">[</span><span class="n">charlie</span><span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">Testing</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nl">username</span><span class="p">:</span><span class="w"> </span><span class="n">charlie</span>
<span class="n">PASSED</span>

<span class="o">=========================</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.01</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>One test function became three test executions. We'll explore this powerful feature in section 4.4.</p>
<h2 id="the-special-request-fixture">The Special <code>request</code> Fixture</h2>
<p>You may have noticed <code>request</code> appearing in the parametrized fixture above. This is a <strong>built-in fixture</strong> that pytest provides automatically. It gives fixtures access to metadata about the test requesting them.</p>
<h3 id="accessing-test-information">Accessing Test Information</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_request_fixture.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_metadata</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate accessing test information.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FIXTURE] Test function: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[FIXTURE] Test module: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[FIXTURE] Test node: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;fixture value&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_example</span><span class="p">(</span><span class="n">test_metadata</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] Received: </span><span class="si">{</span><span class="n">test_metadata</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="kc">True</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_request_fixture.py<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">item</span>

<span class="n">test_request_fixture</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_example</span><span class="w"> </span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="k">function</span><span class="err">:</span><span class="w"> </span><span class="n">test_example</span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="k">module</span><span class="err">:</span><span class="w"> </span><span class="n">test_request_fixture</span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="nl">node</span><span class="p">:</span><span class="w"> </span><span class="n">test_example</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="nl">Received</span><span class="p">:</span><span class="w"> </span><span class="n">fixture</span><span class="w"> </span><span class="k">value</span>
<span class="n">PASSED</span>

<span class="o">=========================</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.01</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>The <code>request</code> object provides:
- <code>request.function</code>: The test function object
- <code>request.module</code>: The test module object
- <code>request.node</code>: The pytest test node (contains test name, markers, etc.)
- <code>request.param</code>: The current parameter value (for parametrized fixtures)</p>
<h3 id="using-request-for-dynamic-fixtures">Using <code>request</code> for Dynamic Fixtures</h3>
<p>The <code>request</code> object enables fixtures to adapt based on test context:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_dynamic_fixture.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">database</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a database with a name based on the test.&quot;&quot;&quot;</span>
    <span class="n">test_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">db_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;test_db_</span><span class="si">{</span><span class="n">test_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FIXTURE] Creating database: </span><span class="si">{</span><span class="n">db_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Simulate database creation</span>
    <span class="n">db</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">db_name</span><span class="p">,</span> <span class="s2">&quot;tables&quot;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">yield</span> <span class="n">db</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FIXTURE] Dropping database: </span><span class="si">{</span><span class="n">db_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_users</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] Using database: </span><span class="si">{</span><span class="n">database</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">database</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;test_db_test_users&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_products</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] Using database: </span><span class="si">{</span><span class="n">database</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">database</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;test_db_test_products&quot;</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_dynamic_fixture.py<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_dynamic_fixture</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_users</span><span class="w"> </span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Creating</span><span class="w"> </span><span class="k">database</span><span class="err">:</span><span class="w"> </span><span class="n">test_db_test_users</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">database</span><span class="err">:</span><span class="w"> </span><span class="n">test_db_test_users</span>
<span class="n">PASSED</span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Dropping</span><span class="w"> </span><span class="k">database</span><span class="err">:</span><span class="w"> </span><span class="n">test_db_test_users</span>

<span class="n">test_dynamic_fixture</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_products</span><span class="w"> </span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Creating</span><span class="w"> </span><span class="k">database</span><span class="err">:</span><span class="w"> </span><span class="n">test_db_test_products</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">database</span><span class="err">:</span><span class="w"> </span><span class="n">test_db_test_products</span>
<span class="n">PASSED</span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Dropping</span><span class="w"> </span><span class="k">database</span><span class="err">:</span><span class="w"> </span><span class="n">test_db_test_products</span>

<span class="o">=========================</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.01</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>Each test gets a database with a unique name derived from the test function name.</p>
<h2 id="fixture-finalization-with-requestaddfinalizer">Fixture Finalization with <code>request.addfinalizer</code></h2>
<p>Besides <code>yield</code>, there's another way to register teardown code: <code>request.addfinalizer()</code>. This is useful when you need multiple cleanup steps or conditional cleanup:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_addfinalizer.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">resource_with_finalizer</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate request.addfinalizer for cleanup.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FIXTURE] Acquiring resource&quot;</span><span class="p">)</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;active&quot;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FINALIZER] Releasing resource&quot;</span><span class="p">)</span>
        <span class="n">resource</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;released&quot;</span>

    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">cleanup</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resource</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_resource_usage</span><span class="p">(</span><span class="n">resource_with_finalizer</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] Resource status: </span><span class="si">{</span><span class="n">resource_with_finalizer</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">resource_with_finalizer</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_addfinalizer.py<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">item</span>

<span class="n">test_addfinalizer</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_resource_usage</span><span class="w"> </span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Acquiring</span><span class="w"> </span><span class="n">resource</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">Resource</span><span class="w"> </span><span class="nl">status</span><span class="p">:</span><span class="w"> </span><span class="n">active</span>
<span class="n">PASSED</span>
<span class="o">[</span><span class="n">FINALIZER</span><span class="o">]</span><span class="w"> </span><span class="n">Releasing</span><span class="w"> </span><span class="n">resource</span>

<span class="o">=========================</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.01</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<h3 id="when-to-use-addfinalizer-vs-yield">When to Use <code>addfinalizer</code> vs. <code>yield</code></h3>
<p><strong>Use <code>yield</code></strong> (preferred):
- Single cleanup step
- Simple, linear setup/teardown
- Most common case</p>
<p><strong>Use <code>addfinalizer</code></strong>:
- Multiple cleanup steps that might be registered conditionally
- Need to register cleanup from within a helper function
- Complex cleanup logic that doesn't fit the yield pattern</p>
<p>Example of conditional cleanup:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_conditional_cleanup.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">conditional_resource</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Only clean up if resource was actually created.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FIXTURE] Starting setup&quot;</span><span class="p">)</span>

    <span class="c1"># Simulate conditional resource creation</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;test_with_&quot;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[FIXTURE] Creating expensive resource&quot;</span><span class="p">)</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;expensive&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FINALIZER] Cleaning up expensive resource&quot;</span><span class="p">)</span>

        <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">cleanup</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[FIXTURE] Using lightweight resource&quot;</span><span class="p">)</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;lightweight&quot;</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">resource</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_with_expensive_resource</span><span class="p">(</span><span class="n">conditional_resource</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] Resource type: </span><span class="si">{</span><span class="n">conditional_resource</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">conditional_resource</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;expensive&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_without_expensive_resource</span><span class="p">(</span><span class="n">conditional_resource</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] Resource type: </span><span class="si">{</span><span class="n">conditional_resource</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">conditional_resource</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;lightweight&quot;</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_conditional_cleanup.py<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_conditional_cleanup</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_with_expensive_resource</span><span class="w"> </span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="n">setup</span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Creating</span><span class="w"> </span><span class="n">expensive</span><span class="w"> </span><span class="n">resource</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">Resource</span><span class="w"> </span><span class="nl">type</span><span class="p">:</span><span class="w"> </span><span class="n">expensive</span>
<span class="n">PASSED</span>
<span class="o">[</span><span class="n">FINALIZER</span><span class="o">]</span><span class="w"> </span><span class="n">Cleaning</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">expensive</span><span class="w"> </span><span class="n">resource</span>

<span class="n">test_conditional_cleanup</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_without_expensive_resource</span><span class="w"> </span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="n">setup</span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="n">lightweight</span><span class="w"> </span><span class="n">resource</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">Resource</span><span class="w"> </span><span class="nl">type</span><span class="p">:</span><span class="w"> </span><span class="n">lightweight</span>
<span class="n">PASSED</span>

<span class="o">=========================</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.01</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>Notice that cleanup only ran for the first test, which actually created the expensive resource.</p>
<h2 id="decorator-parameters-summary">Decorator Parameters Summary</h2>
<p>Here's a complete reference of <code>@pytest.fixture</code> parameters:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Default</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>scope</code></td>
<td>str</td>
<td><code>"function"</code></td>
<td>When to create/destroy the fixture</td>
</tr>
<tr>
<td><code>params</code></td>
<td>list</td>
<td><code>None</code></td>
<td>Values to parametrize the fixture with</td>
</tr>
<tr>
<td><code>autouse</code></td>
<td>bool</td>
<td><code>False</code></td>
<td>Run automatically for all tests</td>
</tr>
<tr>
<td><code>ids</code></td>
<td>list/callable</td>
<td><code>None</code></td>
<td>Custom test IDs for parametrized fixtures</td>
</tr>
<tr>
<td><code>name</code></td>
<td>str</td>
<td>function name</td>
<td>Override the fixture name</td>
</tr>
</tbody>
</table>
<p>We'll explore <code>scope</code> and <code>params</code> in depth in the next sections.</p>
<h2 id="fixture-scope-function-class-module-and-session">Fixture Scope: Function, Class, Module, and Session</h2>
<h2 id="the-performance-problem">The Performance Problem</h2>
<p>Let's return to our authentication system. Suppose our <code>MockDatabase</code> is actually a real database connection that takes 2 seconds to initialize. With our current fixtures, every test creates a new database:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_slow_fixtures.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAuthenticator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SlowDatabase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulates a database with expensive initialization.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[DB] Initializing database (this takes 2 seconds)...&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Simulate expensive setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DB] Database ready&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This creates a new database for EVERY test.&quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">SlowDatabase</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">database</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticator</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_valid_user</span><span class="p">(</span><span class="n">authenticator</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_invalid_password</span><span class="p">(</span><span class="n">authenticator</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;wrong&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_nonexistent_user</span><span class="p">(</span><span class="n">authenticator</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="s1">&#39;any&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>
</code></pre></div>

<p>Let's run these tests and time them:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_slow_fixtures.py<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_slow_fixtures</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_authenticate_valid_user</span><span class="w"> </span>
<span class="o">[</span><span class="n">DB</span><span class="o">]</span><span class="w"> </span><span class="n">Initializing</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="p">(</span><span class="n">this</span><span class="w"> </span><span class="n">takes</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">seconds</span><span class="p">)...</span>
<span class="o">[</span><span class="n">DB</span><span class="o">]</span><span class="w"> </span><span class="k">Database</span><span class="w"> </span><span class="n">ready</span>
<span class="n">PASSED</span>

<span class="n">test_slow_fixtures</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_authenticate_invalid_password</span><span class="w"> </span>
<span class="o">[</span><span class="n">DB</span><span class="o">]</span><span class="w"> </span><span class="n">Initializing</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="p">(</span><span class="n">this</span><span class="w"> </span><span class="n">takes</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">seconds</span><span class="p">)...</span>
<span class="o">[</span><span class="n">DB</span><span class="o">]</span><span class="w"> </span><span class="k">Database</span><span class="w"> </span><span class="n">ready</span>
<span class="n">PASSED</span>

<span class="n">test_slow_fixtures</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_authenticate_nonexistent_user</span><span class="w"> </span>
<span class="o">[</span><span class="n">DB</span><span class="o">]</span><span class="w"> </span><span class="n">Initializing</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="p">(</span><span class="n">this</span><span class="w"> </span><span class="n">takes</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">seconds</span><span class="p">)...</span>
<span class="o">[</span><span class="n">DB</span><span class="o">]</span><span class="w"> </span><span class="k">Database</span><span class="w"> </span><span class="n">ready</span>
<span class="n">PASSED</span>

<span class="o">=========================</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">6.02</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p><strong>6 seconds for 3 tests!</strong> The database initialized three times‚Äîonce per test. This is wasteful because:</p>
<ol>
<li>Each test uses the same initial database state</li>
<li>Tests don't modify the database in ways that affect other tests</li>
<li>We're paying the 2-second initialization cost unnecessarily</li>
</ol>
<p>This is where <strong>fixture scope</strong> solves the problem.</p>
<h2 id="understanding-fixture-scope">Understanding Fixture Scope</h2>
<p><strong>Scope</strong> determines how often a fixture is created and destroyed. Instead of creating a new fixture for every test, you can share one fixture across multiple tests.</p>
<p>Pytest provides four scope levels:</p>
<table>
<thead>
<tr>
<th>Scope</th>
<th>Lifetime</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>function</code></td>
<td>Per test function (default)</td>
<td>Test isolation is critical</td>
</tr>
<tr>
<td><code>class</code></td>
<td>Per test class</td>
<td>Tests in a class share state</td>
</tr>
<tr>
<td><code>module</code></td>
<td>Per test file</td>
<td>Tests in a file share state</td>
</tr>
<tr>
<td><code>session</code></td>
<td>Entire test run</td>
<td>Expensive setup shared globally</td>
</tr>
</tbody>
</table>
<h3 id="scope-the-mental-model">Scope: The Mental Model</h3>
<p>Think of scope as <strong>how long the fixture lives</strong>:</p>
<ul>
<li><strong><code>function</code> scope</strong>: Born before each test, dies after each test</li>
<li><strong><code>class</code> scope</strong>: Born before the first test in a class, dies after the last test in that class</li>
<li><strong><code>module</code> scope</strong>: Born before the first test in a file, dies after the last test in that file</li>
<li><strong><code>session</code> scope</strong>: Born before any test runs, dies after all tests complete</li>
</ul>
<h2 id="module-scope-sharing-across-a-file">Module Scope: Sharing Across a File</h2>
<p>Let's fix our slow tests by using <code>scope="module"</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_module_scope.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAuthenticator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SlowDatabase</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[DB] Initializing database (this takes 2 seconds)...&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DB] Database ready&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This creates ONE database for ALL tests in this file.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FIXTURE] Creating module-scoped database&quot;</span><span class="p">)</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">SlowDatabase</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">database</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FIXTURE] Tearing down module-scoped database&quot;</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticator</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This still runs per test, but reuses the same db.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FIXTURE] Creating authenticator&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_valid_user</span><span class="p">(</span><span class="n">authenticator</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] test_authenticate_valid_user&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_invalid_password</span><span class="p">(</span><span class="n">authenticator</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] test_authenticate_invalid_password&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;wrong&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authenticate_nonexistent_user</span><span class="p">(</span><span class="n">authenticator</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] test_authenticate_nonexistent_user&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="s1">&#39;any&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_module_scope.py<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_module_scope</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_authenticate_valid_user</span><span class="w"> </span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Creating</span><span class="w"> </span><span class="k">module</span><span class="o">-</span><span class="n">scoped</span><span class="w"> </span><span class="k">database</span>
<span class="o">[</span><span class="n">DB</span><span class="o">]</span><span class="w"> </span><span class="n">Initializing</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="p">(</span><span class="n">this</span><span class="w"> </span><span class="n">takes</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">seconds</span><span class="p">)...</span>
<span class="o">[</span><span class="n">DB</span><span class="o">]</span><span class="w"> </span><span class="k">Database</span><span class="w"> </span><span class="n">ready</span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Creating</span><span class="w"> </span><span class="n">authenticator</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">test_authenticate_valid_user</span>
<span class="n">PASSED</span>

<span class="n">test_module_scope</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_authenticate_invalid_password</span><span class="w"> </span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Creating</span><span class="w"> </span><span class="n">authenticator</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">test_authenticate_invalid_password</span>
<span class="n">PASSED</span>

<span class="n">test_module_scope</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_authenticate_nonexistent_user</span><span class="w"> </span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Creating</span><span class="w"> </span><span class="n">authenticator</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">test_authenticate_nonexistent_user</span>
<span class="n">PASSED</span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Tearing</span><span class="w"> </span><span class="n">down</span><span class="w"> </span><span class="k">module</span><span class="o">-</span><span class="n">scoped</span><span class="w"> </span><span class="k">database</span>

<span class="o">=========================</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">2.03</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p><strong>2 seconds instead of 6!</strong> The database initialized only once. Notice:</p>
<ol>
<li>The database fixture ran before the first test</li>
<li>Each test got a new <code>authenticator</code>, but they all shared the same <code>db</code></li>
<li>The database teardown ran after all tests completed</li>
</ol>
<h3 id="diagnostic-analysis-reading-the-execution-flow">Diagnostic Analysis: Reading the Execution Flow</h3>
<p>Let's parse what happened:</p>
<p><strong>Before first test:</strong>
- <code>[FIXTURE] Creating module-scoped database</code> - The module-scoped fixture initializes
- <code>[DB] Initializing database...</code> - Expensive setup happens once</p>
<p><strong>For each test:</strong>
- <code>[FIXTURE] Creating authenticator</code> - Function-scoped fixture runs per test
- <code>[TEST] test_name</code> - Test executes</p>
<p><strong>After last test:</strong>
- <code>[FIXTURE] Tearing down module-scoped database</code> - Module-scoped teardown runs once</p>
<p>The key insight: <strong>Module-scoped fixtures are created once and shared across all tests in the file.</strong></p>
<h2 id="the-scope-hierarchy-and-composition-rules">The Scope Hierarchy and Composition Rules</h2>
<p>When fixtures depend on each other, their scopes must follow a rule:</p>
<p><strong>A fixture can only depend on fixtures with equal or broader scope.</strong></p>
<p>Valid combinations:
- <code>function</code> scope can use <code>function</code>, <code>class</code>, <code>module</code>, or <code>session</code> fixtures
- <code>class</code> scope can use <code>class</code>, <code>module</code>, or <code>session</code> fixtures
- <code>module</code> scope can use <code>module</code> or <code>session</code> fixtures
- <code>session</code> scope can only use <code>session</code> fixtures</p>
<p>Invalid combination:
- <code>module</code> scope <strong>cannot</strong> use <code>function</code> scope fixtures</p>
<p>Let's see what happens if we violate this rule:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_invalid_scope.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">function_fixture</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;function-scoped&quot;</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">module_fixture</span><span class="p">(</span><span class="n">function_fixture</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is INVALID: module scope using function scope.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;module using </span><span class="si">{</span><span class="n">function_fixture</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_example</span><span class="p">(</span><span class="n">module_fixture</span><span class="p">):</span>
    <span class="k">assert</span> <span class="kc">True</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_invalid_scope.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 1 item

test_invalid_scope.py::test_example ERROR

============================== ERRORS ===============================
ERROR at setup of test_example
ScopeMismatch: You tried to access the function scoped fixture function_fixture with a module scoped request object, involved factories:
test_invalid_scope.py::module_fixture
test_invalid_scope.py::function_fixture

========================= 1 error in 0.01s ===========================
</code></pre></div>

<h3 id="why-this-rule-exists">Why This Rule Exists</h3>
<p>The rule prevents logical impossibilities. Consider:</p>
<ul>
<li>A <code>module</code> fixture lives for the entire file</li>
<li>A <code>function</code> fixture lives for one test</li>
<li>If the module fixture depended on the function fixture, which function's fixture would it use?</li>
</ul>
<p>The module fixture would need to be recreated for each test (to get a fresh function fixture), which defeats the purpose of module scope.</p>
<h2 id="class-scope-sharing-within-test-classes">Class Scope: Sharing Within Test Classes</h2>
<p>Class scope is useful when you organize tests into classes and want to share setup across methods in that class:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_class_scope.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAuthenticator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MockDatabase</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Shared across all tests in a class.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FIXTURE] Creating class-scoped database&quot;</span><span class="p">)</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">database</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FIXTURE] Tearing down class-scoped database&quot;</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticator</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FIXTURE] Creating authenticator&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestAuthentication</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests in this class share the same database.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_valid_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authenticator</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] test_valid_credentials&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authenticator</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] test_invalid_credentials&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;wrong&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestAuthorization</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class gets its own database instance.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_admin_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] test_admin_check&quot;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;admin_pass&#39;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>
        <span class="n">authenticator</span> <span class="o">=</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">is_admin</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_class_scope.py<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_class_scope</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="nl">TestAuthentication</span><span class="p">:</span><span class="err">:</span><span class="n">test_valid_credentials</span><span class="w"> </span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Creating</span><span class="w"> </span><span class="k">class</span><span class="o">-</span><span class="n">scoped</span><span class="w"> </span><span class="k">database</span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Creating</span><span class="w"> </span><span class="n">authenticator</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">test_valid_credentials</span>
<span class="n">PASSED</span>

<span class="n">test_class_scope</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="nl">TestAuthentication</span><span class="p">:</span><span class="err">:</span><span class="n">test_invalid_credentials</span><span class="w"> </span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Creating</span><span class="w"> </span><span class="n">authenticator</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">test_invalid_credentials</span>
<span class="n">PASSED</span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Tearing</span><span class="w"> </span><span class="n">down</span><span class="w"> </span><span class="k">class</span><span class="o">-</span><span class="n">scoped</span><span class="w"> </span><span class="k">database</span>

<span class="n">test_class_scope</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="nl">TestAuthorization</span><span class="p">:</span><span class="err">:</span><span class="n">test_admin_check</span><span class="w"> </span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Creating</span><span class="w"> </span><span class="k">class</span><span class="o">-</span><span class="n">scoped</span><span class="w"> </span><span class="k">database</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">test_admin_check</span>
<span class="n">PASSED</span>
<span class="o">[</span><span class="n">FIXTURE</span><span class="o">]</span><span class="w"> </span><span class="n">Tearing</span><span class="w"> </span><span class="n">down</span><span class="w"> </span><span class="k">class</span><span class="o">-</span><span class="n">scoped</span><span class="w"> </span><span class="k">database</span>

<span class="o">=========================</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.02</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>Notice:
- The database was created twice: once for <code>TestAuthentication</code>, once for <code>TestAuthorization</code>
- Within <code>TestAuthentication</code>, both tests shared the same database
- Each class got its own isolated database instance</p>
<h2 id="session-scope-global-sharing">Session Scope: Global Sharing</h2>
<p>Session scope creates a fixture once for the entire test run, shared across all test files:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (shared configuration file)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">expensive_resource</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This runs ONCE for the entire test session.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[SESSION] Initializing expensive resource (5 seconds)...&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;initialized&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;shared data&quot;</span><span class="p">}</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SESSION] Resource ready&quot;</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">resource</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[SESSION] Cleaning up expensive resource&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_file_1.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_in_file_1</span><span class="p">(</span><span class="n">expensive_resource</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] test_file_1 using resource: </span><span class="si">{</span><span class="n">expensive_resource</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">expensive_resource</span><span class="p">[</span><span class="s2">&quot;initialized&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_another_in_file_1</span><span class="p">(</span><span class="n">expensive_resource</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] test_another_in_file_1 using resource: </span><span class="si">{</span><span class="n">expensive_resource</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">expensive_resource</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;shared data&quot;</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_file_2.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_in_file_2</span><span class="p">(</span><span class="n">expensive_resource</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] test_file_2 using resource: </span><span class="si">{</span><span class="n">expensive_resource</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">expensive_resource</span><span class="p">[</span><span class="s2">&quot;initialized&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_file_1.py<span class="w"> </span>test_file_2.py<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_file_1</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_in_file_1</span><span class="w"> </span>
<span class="o">[</span><span class="n">SESSION</span><span class="o">]</span><span class="w"> </span><span class="n">Initializing</span><span class="w"> </span><span class="n">expensive</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="n">seconds</span><span class="p">)...</span>
<span class="o">[</span><span class="n">SESSION</span><span class="o">]</span><span class="w"> </span><span class="n">Resource</span><span class="w"> </span><span class="n">ready</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">test_file_1</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="nl">resource</span><span class="p">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;initialized&#39;</span><span class="err">:</span><span class="w"> </span><span class="k">True</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;data&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;shared data&#39;</span><span class="err">}</span>
<span class="n">PASSED</span>

<span class="n">test_file_1</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_another_in_file_1</span><span class="w"> </span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">test_another_in_file_1</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="nl">resource</span><span class="p">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;initialized&#39;</span><span class="err">:</span><span class="w"> </span><span class="k">True</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;data&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;shared data&#39;</span><span class="err">}</span>
<span class="n">PASSED</span>

<span class="n">test_file_2</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_in_file_2</span><span class="w"> </span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">test_file_2</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="nl">resource</span><span class="p">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;initialized&#39;</span><span class="err">:</span><span class="w"> </span><span class="k">True</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;data&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;shared data&#39;</span><span class="err">}</span>
<span class="n">PASSED</span>
<span class="o">[</span><span class="n">SESSION</span><span class="o">]</span><span class="w"> </span><span class="n">Cleaning</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">expensive</span><span class="w"> </span><span class="n">resource</span>

<span class="o">=========================</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">5.02</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>The resource initialized once before any test ran, was shared across both files, and cleaned up after all tests completed.</p>
<h3 id="when-to-use-session-scope">When to Use Session Scope</h3>
<p><strong>Use session scope for:</strong>
- Database connections that are expensive to create
- Starting external services (Docker containers, test servers)
- Loading large datasets that don't change
- Initializing machine learning models</p>
<p><strong>Don't use session scope for:</strong>
- Resources that tests modify (breaks test isolation)
- Resources that are cheap to create
- Resources that need to be fresh for each test</p>
<h2 id="the-danger-of-shared-state">The Danger of Shared State</h2>
<p>Broader scopes improve performance but risk breaking test isolation. Consider this problematic example:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_shared_state_problem.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">shared_list</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A mutable object shared across tests.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_append_one</span><span class="p">(</span><span class="n">shared_list</span><span class="p">):</span>
    <span class="n">shared_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">shared_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_append_two</span><span class="p">(</span><span class="n">shared_list</span><span class="p">):</span>
    <span class="n">shared_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># This test expects the list to have 1 element, but it has 2!</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">shared_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># This will fail!</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_shared_state_problem.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 2 items

test_shared_state_problem.py::test_append_one PASSED           [ 50%]
test_shared_state_problem.py::test_append_two FAILED           [100%]

============================== FAILURES ==============================
________________________ test_append_two _____________________________

shared_list = [1, 2]

    def test_append_two(shared_list):
        shared_list.append(2)
<span class="k">&gt; </span><span class="ge">      assert len(shared_list) == 1</span>
E       assert 2 == 1
E        +  where 2 = len([1, 2])

test_shared_state_problem.py:14: AssertionError
========================= 1 failed, 1 passed in 0.02s ================
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-failure">Diagnostic Analysis: Reading the Failure</h3>
<p><strong>The summary line:</strong></p>
<div class="codehilite"><pre><span></span><code>test_shared_state_problem.py::test_append_two FAILED
</code></pre></div>

<p>This tells us the second test failed.</p>
<p><strong>The assertion introspection:</strong></p>
<div class="codehilite"><pre><span></span><code>shared_list = [1, 2]

    def test_append_two(shared_list):
        shared_list.append(2)
<span class="k">&gt; </span><span class="ge">      assert len(shared_list) == 1</span>
E       assert 2 == 1
E        +  where 2 = len([1, 2])
</code></pre></div>

<p>Pytest shows us:
1. The shared_list contains <code>[1, 2]</code> when the test runs
2. The test expected length 1, but got length 2
3. The list contains the element from the previous test</p>
<p><strong>Root cause:</strong> The first test modified the shared list, and that modification persisted to the second test.</p>
<p><strong>Solution:</strong> Either use <code>function</code> scope for isolation, or design tests to not depend on initial state.</p>
<h3 id="safe-patterns-for-broader-scopes">Safe Patterns for Broader Scopes</h3>
<p>To safely use broader scopes with mutable objects:</p>
<p><strong>Pattern 1: Read-only fixtures</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">config</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Safe because tests only read, never modify.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;api_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.example.com&quot;</span><span class="p">,</span>
        <span class="s2">&quot;timeout&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
        <span class="s2">&quot;retry_count&quot;</span><span class="p">:</span> <span class="mi">3</span>
    <span class="p">}</span>
</code></pre></div>

<p><strong>Pattern 2: Factory fixtures</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">database_factory</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a factory that creates fresh databases.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_database</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">create_database</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_example</span><span class="p">(</span><span class="n">database_factory</span><span class="p">):</span>
    <span class="c1"># Each test gets a fresh database</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">database_factory</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret&#39;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Pattern 3: Reset between tests</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">database</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">db</span>
    <span class="c1"># Reset after each test</span>
    <span class="n">db</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></pre></div>

<h2 id="scope-decision-framework">Scope Decision Framework</h2>
<p>When choosing fixture scope, ask these questions:</p>
<table>
<thead>
<tr>
<th>Question</th>
<th>Answer</th>
<th>Recommended Scope</th>
</tr>
</thead>
<tbody>
<tr>
<td>Is setup expensive (&gt;100ms)?</td>
<td>No</td>
<td><code>function</code></td>
</tr>
<tr>
<td>Is setup expensive?</td>
<td>Yes</td>
<td>Consider broader scope</td>
</tr>
<tr>
<td>Do tests modify the fixture?</td>
<td>Yes</td>
<td><code>function</code></td>
</tr>
<tr>
<td>Do tests only read the fixture?</td>
<td>Yes</td>
<td>Broader scope is safe</td>
</tr>
<tr>
<td>Is the fixture a database connection?</td>
<td>Yes</td>
<td><code>module</code> or <code>session</code></td>
</tr>
<tr>
<td>Is the fixture test data?</td>
<td>Yes</td>
<td><code>function</code></td>
</tr>
<tr>
<td>Is the fixture a configuration?</td>
<td>Yes</td>
<td><code>module</code> or <code>session</code></td>
</tr>
<tr>
<td>Do tests need isolation?</td>
<td>Yes</td>
<td><code>function</code></td>
</tr>
</tbody>
</table>
<p><strong>Default to <code>function</code> scope</strong> unless you have a specific reason to use broader scope. Test isolation is more important than performance in most cases.</p>
<h2 id="visualizing-scope-lifetimes">Visualizing Scope Lifetimes</h2>
<p>Here's a complete example showing all four scopes:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_all_scopes.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">session_fixture</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[SESSION] Setup&quot;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="s2">&quot;session&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[SESSION] Teardown&quot;</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">module_fixture</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[MODULE] Setup&quot;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="s2">&quot;module&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[MODULE] Teardown&quot;</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">class_fixture</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CLASS] Setup&quot;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="s2">&quot;class&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CLASS] Teardown&quot;</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">function_fixture</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FUNCTION] Setup&quot;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="s2">&quot;function&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FUNCTION] Teardown&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestGroup1</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_fixture</span><span class="p">,</span> <span class="n">module_fixture</span><span class="p">,</span> <span class="n">class_fixture</span><span class="p">,</span> <span class="n">function_fixture</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] test_1: </span><span class="si">{</span><span class="n">session_fixture</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">module_fixture</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">class_fixture</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">function_fixture</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_fixture</span><span class="p">,</span> <span class="n">module_fixture</span><span class="p">,</span> <span class="n">class_fixture</span><span class="p">,</span> <span class="n">function_fixture</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] test_2: </span><span class="si">{</span><span class="n">session_fixture</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">module_fixture</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">class_fixture</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">function_fixture</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestGroup2</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_fixture</span><span class="p">,</span> <span class="n">module_fixture</span><span class="p">,</span> <span class="n">class_fixture</span><span class="p">,</span> <span class="n">function_fixture</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] test_3: </span><span class="si">{</span><span class="n">session_fixture</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">module_fixture</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">class_fixture</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">function_fixture</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_all_scopes.py<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_all_scopes</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="nl">TestGroup1</span><span class="p">:</span><span class="err">:</span><span class="n">test_1</span><span class="w"> </span>
<span class="o">[</span><span class="n">SESSION</span><span class="o">]</span><span class="w"> </span><span class="n">Setup</span>
<span class="o">[</span><span class="n">MODULE</span><span class="o">]</span><span class="w"> </span><span class="n">Setup</span>
<span class="o">[</span><span class="n">CLASS</span><span class="o">]</span><span class="w"> </span><span class="n">Setup</span>
<span class="o">[</span><span class="n">FUNCTION</span><span class="o">]</span><span class="w"> </span><span class="n">Setup</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="nl">test_1</span><span class="p">:</span><span class="w"> </span><span class="k">session</span><span class="p">,</span><span class="w"> </span><span class="k">module</span><span class="p">,</span><span class="w"> </span><span class="k">class</span><span class="p">,</span><span class="w"> </span><span class="k">function</span>
<span class="n">PASSED</span>
<span class="o">[</span><span class="n">FUNCTION</span><span class="o">]</span><span class="w"> </span><span class="n">Teardown</span>

<span class="n">test_all_scopes</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="nl">TestGroup1</span><span class="p">:</span><span class="err">:</span><span class="n">test_2</span><span class="w"> </span>
<span class="o">[</span><span class="n">FUNCTION</span><span class="o">]</span><span class="w"> </span><span class="n">Setup</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="nl">test_2</span><span class="p">:</span><span class="w"> </span><span class="k">session</span><span class="p">,</span><span class="w"> </span><span class="k">module</span><span class="p">,</span><span class="w"> </span><span class="k">class</span><span class="p">,</span><span class="w"> </span><span class="k">function</span>
<span class="n">PASSED</span>
<span class="o">[</span><span class="n">FUNCTION</span><span class="o">]</span><span class="w"> </span><span class="n">Teardown</span>
<span class="o">[</span><span class="n">CLASS</span><span class="o">]</span><span class="w"> </span><span class="n">Teardown</span>

<span class="n">test_all_scopes</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="nl">TestGroup2</span><span class="p">:</span><span class="err">:</span><span class="n">test_3</span><span class="w"> </span>
<span class="o">[</span><span class="n">CLASS</span><span class="o">]</span><span class="w"> </span><span class="n">Setup</span>
<span class="o">[</span><span class="n">FUNCTION</span><span class="o">]</span><span class="w"> </span><span class="n">Setup</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="nl">test_3</span><span class="p">:</span><span class="w"> </span><span class="k">session</span><span class="p">,</span><span class="w"> </span><span class="k">module</span><span class="p">,</span><span class="w"> </span><span class="k">class</span><span class="p">,</span><span class="w"> </span><span class="k">function</span>
<span class="n">PASSED</span>
<span class="o">[</span><span class="n">FUNCTION</span><span class="o">]</span><span class="w"> </span><span class="n">Teardown</span>
<span class="o">[</span><span class="n">CLASS</span><span class="o">]</span><span class="w"> </span><span class="n">Teardown</span>
<span class="o">[</span><span class="n">MODULE</span><span class="o">]</span><span class="w"> </span><span class="n">Teardown</span>
<span class="o">[</span><span class="n">SESSION</span><span class="o">]</span><span class="w"> </span><span class="n">Teardown</span>

<span class="o">=========================</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.02</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>This reveals the complete lifecycle:</p>
<p><strong>Before any test:</strong>
- Session fixture initializes</p>
<p><strong>Before first test in file:</strong>
- Module fixture initializes</p>
<p><strong>Before first test in TestGroup1:</strong>
- Class fixture initializes</p>
<p><strong>For each test:</strong>
- Function fixture initializes
- Test runs
- Function fixture tears down</p>
<p><strong>After last test in TestGroup1:</strong>
- Class fixture tears down</p>
<p><strong>Before first test in TestGroup2:</strong>
- New class fixture initializes</p>
<p><strong>After last test in file:</strong>
- Module fixture tears down</p>
<p><strong>After all tests:</strong>
- Session fixture tears down</p>
<p>The key pattern: <strong>Broader scopes initialize earlier and tear down later.</strong></p>
<h2 id="using-fixtures-in-your-tests">Using Fixtures in Your Tests</h2>
<h2 id="beyond-simple-fixture-usage">Beyond Simple Fixture Usage</h2>
<p>We've seen the basics of requesting fixtures as test parameters. Now let's explore advanced patterns for using fixtures effectively in real-world scenarios.</p>
<h2 id="multiple-fixtures-in-one-test">Multiple Fixtures in One Test</h2>
<p>Tests can request as many fixtures as they need. Pytest resolves all dependencies automatically:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_multiple_fixtures.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAuthenticator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MockDatabase</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Logger</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a test database.&quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;admin_pass&#39;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">database</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">logger</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a logger for tracking operations.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Logger</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticator</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide an authenticator with logging.&quot;&quot;&quot;</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Authenticator created&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">auth</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authentication_with_logging</span><span class="p">(</span><span class="n">authenticator</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test can use both authenticator and logger.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Starting authentication test&quot;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authentication result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="s2">&quot;Starting authentication test&quot;</span> <span class="ow">in</span> <span class="n">logger</span><span class="o">.</span><span class="n">logs</span>
</code></pre></div>

<p>This test uses three fixtures:
1. <code>authenticator</code> (directly requested)
2. <code>logger</code> (directly requested)
3. <code>db</code> (indirectly, through <code>authenticator</code>)</p>
<p>Pytest automatically:
- Creates <code>db</code> first
- Creates <code>logger</code> second
- Creates <code>authenticator</code> third (using both <code>db</code> and <code>logger</code>)
- Passes <code>authenticator</code> and <code>logger</code> to the test</p>
<h2 id="fixtures-in-test-classes">Fixtures in Test Classes</h2>
<p>When using test classes, fixtures work the same way‚Äîrequest them as method parameters:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_fixtures_in_classes.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAuthenticator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MockDatabase</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;admin_pass&#39;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">database</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticator</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestUserAuthentication</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;All methods in this class can use fixtures.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_valid_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authenticator</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authenticator</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;wrong&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_can_access_db_directly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tests can also request the underlying fixtures.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestAdminAuthorization</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Each class gets fresh fixtures.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_admin_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authenticator</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">is_admin</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_regular_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authenticator</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">is_admin</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>
</code></pre></div>

<p>Key points:
- Fixtures are requested as method parameters (not <code>self.fixture</code>)
- Each test method can request different fixtures
- Each class gets fresh fixture instances (with default <code>function</code> scope)</p>
<h2 id="fixture-factories-creating-multiple-instances">Fixture Factories: Creating Multiple Instances</h2>
<p>Sometimes you need multiple instances of the same type of object in a single test. The <strong>factory pattern</strong> solves this:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_fixture_factory.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAuthenticator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MockDatabase</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">database_factory</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a factory function that creates databases.&quot;&quot;&quot;</span>
    <span class="n">created_databases</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_database</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">created_databases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span>

    <span class="k">yield</span> <span class="n">create_database</span>

    <span class="c1"># Cleanup: close all created databases</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[CLEANUP] Closing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">created_databases</span><span class="p">)</span><span class="si">}</span><span class="s2"> databases&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="n">created_databases</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CLEANUP] Closing database: </span><span class="si">{</span><span class="n">db</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_multiple_databases</span><span class="p">(</span><span class="n">database_factory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create multiple databases in one test.&quot;&quot;&quot;</span>
    <span class="c1"># Create separate databases for different purposes</span>
    <span class="n">user_db</span> <span class="o">=</span> <span class="n">database_factory</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">)</span>
    <span class="n">user_db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>

    <span class="n">admin_db</span> <span class="o">=</span> <span class="n">database_factory</span><span class="p">(</span><span class="s2">&quot;admins&quot;</span><span class="p">)</span>
    <span class="n">admin_db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;admin_pass&#39;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>

    <span class="c1"># Verify they&#39;re independent</span>
    <span class="k">assert</span> <span class="n">user_db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">user_db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="k">assert</span> <span class="n">admin_db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">admin_db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] Created databases: </span><span class="si">{</span><span class="n">user_db</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">admin_db</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_fixture_factory.py<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">item</span>

<span class="n">test_fixture_factory</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_multiple_databases</span><span class="w"> </span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">Created</span><span class="w"> </span><span class="nl">databases</span><span class="p">:</span><span class="w"> </span><span class="n">users</span><span class="p">,</span><span class="w"> </span><span class="n">admins</span>
<span class="n">PASSED</span>
<span class="o">[</span><span class="n">CLEANUP</span><span class="o">]</span><span class="w"> </span><span class="n">Closing</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">databases</span>
<span class="o">[</span><span class="n">CLEANUP</span><span class="o">]</span><span class="w"> </span><span class="n">Closing</span><span class="w"> </span><span class="k">database</span><span class="err">:</span><span class="w"> </span><span class="n">users</span>
<span class="o">[</span><span class="n">CLEANUP</span><span class="o">]</span><span class="w"> </span><span class="n">Closing</span><span class="w"> </span><span class="k">database</span><span class="err">:</span><span class="w"> </span><span class="n">admins</span>

<span class="o">=========================</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.01</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>The factory pattern:
1. The fixture returns a <strong>function</strong> (the factory)
2. Tests call that function to create instances
3. The fixture tracks all created instances
4. Teardown cleans up all instances</p>
<p>This is powerful for:
- Creating multiple test users
- Setting up multiple API clients
- Creating temporary files or directories
- Any scenario where you need N instances of something</p>
<h2 id="parameterized-fixtures-testing-multiple-configurations">Parameterized Fixtures: Testing Multiple Configurations</h2>
<p>The <code>params</code> parameter in <code>@pytest.fixture</code> creates multiple versions of a fixture. Each test that uses the fixture runs once per parameter value:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_parameterized_fixture.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAuthenticator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MockDatabase</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="s1">&#39;charlie&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">username</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This fixture provides three different usernames.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_with_user</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a database with the parameterized user.&quot;&quot;&quot;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">_password&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">db</span><span class="p">,</span> <span class="n">username</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_user_exists</span><span class="p">(</span><span class="n">db_with_user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This test runs three times, once per username.&quot;&quot;&quot;</span>
    <span class="n">db</span><span class="p">,</span> <span class="n">username</span> <span class="o">=</span> <span class="n">db_with_user</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">_password&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] Verified user: </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_parameterized_fixture.py<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_parameterized_fixture</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_user_exists</span><span class="o">[</span><span class="n">alice</span><span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">Verified</span><span class="w"> </span><span class="k">user</span><span class="err">:</span><span class="w"> </span><span class="n">alice</span>
<span class="n">PASSED</span>
<span class="n">test_parameterized_fixture</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_user_exists</span><span class="o">[</span><span class="n">bob</span><span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">Verified</span><span class="w"> </span><span class="k">user</span><span class="err">:</span><span class="w"> </span><span class="n">bob</span>
<span class="n">PASSED</span>
<span class="n">test_parameterized_fixture</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_user_exists</span><span class="o">[</span><span class="n">charlie</span><span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">Verified</span><span class="w"> </span><span class="k">user</span><span class="err">:</span><span class="w"> </span><span class="n">charlie</span>
<span class="n">PASSED</span>

<span class="o">=========================</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.02</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>One test function became three test executions. Notice the test IDs: <code>[alice]</code>, <code>[bob]</code>, <code>[charlie]</code>.</p>
<h3 id="custom-test-ids-for-parameterized-fixtures">Custom Test IDs for Parameterized Fixtures</h3>
<p>The default IDs (<code>[alice]</code>, <code>[bob]</code>) are the string representation of the parameter. For complex objects, this can be unclear. Use the <code>ids</code> parameter to provide custom names:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_custom_ids.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAuthenticator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MockDatabase</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="c1"># Define test configurations</span>
<span class="n">USER_CONFIGS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;secret123&#39;</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;bob_pass&#39;</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;admin_pass&#39;</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;admin&#39;</span><span class="p">},</span>
<span class="p">]</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span>
    <span class="n">params</span><span class="o">=</span><span class="n">USER_CONFIGS</span><span class="p">,</span>
    <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;regular_user_alice&#39;</span><span class="p">,</span> <span class="s1">&#39;regular_user_bob&#39;</span><span class="p">,</span> <span class="s1">&#39;admin_user&#39;</span><span class="p">]</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user_config</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide different user configurations with readable IDs.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_with_configured_user</span><span class="p">(</span><span class="n">user_config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a database with the configured user.&quot;&quot;&quot;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span>
        <span class="n">user_config</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
        <span class="n">user_config</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">],</span>
        <span class="n">user_config</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">db</span><span class="p">,</span> <span class="n">user_config</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_user_authentication</span><span class="p">(</span><span class="n">db_with_configured_user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test authentication for different user types.&quot;&quot;&quot;</span>
    <span class="n">db</span><span class="p">,</span> <span class="n">config</span> <span class="o">=</span> <span class="n">db_with_configured_user</span>
    <span class="n">authenticator</span> <span class="o">=</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] Authenticated </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_custom_ids.py<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_custom_ids</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_user_authentication</span><span class="o">[</span><span class="n">regular_user_alice</span><span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">Authenticated</span><span class="w"> </span><span class="n">alice</span><span class="w"> </span><span class="p">(</span><span class="k">user</span><span class="p">)</span>
<span class="n">PASSED</span>
<span class="n">test_custom_ids</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_user_authentication</span><span class="o">[</span><span class="n">regular_user_bob</span><span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">Authenticated</span><span class="w"> </span><span class="n">bob</span><span class="w"> </span><span class="p">(</span><span class="k">user</span><span class="p">)</span>
<span class="n">PASSED</span>
<span class="n">test_custom_ids</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_user_authentication</span><span class="o">[</span><span class="n">admin_user</span><span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="n">Authenticated</span><span class="w"> </span><span class="k">admin</span><span class="w"> </span><span class="p">(</span><span class="k">admin</span><span class="p">)</span>
<span class="n">PASSED</span>

<span class="o">=========================</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.02</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>The custom IDs make test output much more readable. You can also use a function to generate IDs dynamically:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">id_from_config</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate test ID from configuration.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span>
    <span class="n">params</span><span class="o">=</span><span class="n">USER_CONFIGS</span><span class="p">,</span>
    <span class="n">ids</span><span class="o">=</span><span class="n">id_from_config</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user_config</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>
</code></pre></div>

<h2 id="indirect-parametrization-parameterizing-fixture-inputs">Indirect Parametrization: Parameterizing Fixture Inputs</h2>
<p>Sometimes you want to parametrize the <strong>fixture itself</strong> rather than the test. Use <code>indirect=True</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_indirect_parametrization.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAuthenticator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MockDatabase</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a database with users specified by the test.&quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>

    <span class="c1"># request.param contains the list of users to create</span>
    <span class="k">for</span> <span class="n">user_data</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span><span class="p">:</span>
        <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="o">**</span><span class="n">user_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">database</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="p">[</span>
    <span class="p">[{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;secret123&#39;</span><span class="p">}],</span>
    <span class="p">[{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;bob_pass&#39;</span><span class="p">}],</span>
    <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;secret123&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;bob_pass&#39;</span><span class="p">}</span>
    <span class="p">],</span>
<span class="p">],</span> <span class="n">indirect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;single_user_alice&#39;</span><span class="p">,</span> <span class="s1">&#39;single_user_bob&#39;</span><span class="p">,</span> <span class="s1">&#39;multiple_users&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_database_users</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test with different database configurations.&quot;&quot;&quot;</span>
    <span class="n">user_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">users</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] Database has </span><span class="si">{</span><span class="n">user_count</span><span class="si">}</span><span class="s2"> user(s)&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user_count</span> <span class="o">&gt;</span> <span class="mi">0</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_indirect_parametrization.py<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_indirect_parametrization</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_database_users</span><span class="o">[</span><span class="n">single_user_alice</span><span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="k">Database</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">user</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="n">PASSED</span>
<span class="n">test_indirect_parametrization</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_database_users</span><span class="o">[</span><span class="n">single_user_bob</span><span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="k">Database</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">user</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="n">PASSED</span>
<span class="n">test_indirect_parametrization</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_database_users</span><span class="o">[</span><span class="n">multiple_users</span><span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="k">Database</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">user</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="n">PASSED</span>

<span class="o">=========================</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.02</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>With <code>indirect=True</code>:
1. The test is parametrized with different values
2. Those values are passed to the fixture via <code>request.param</code>
3. The fixture uses those values to create different configurations
4. The test receives the configured fixture</p>
<p>This is powerful for testing with different initial states or configurations.</p>
<h2 id="combining-multiple-parametrized-fixtures">Combining Multiple Parametrized Fixtures</h2>
<p>When multiple fixtures are parametrized, pytest creates the <strong>cartesian product</strong> of all combinations:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_multiple_parametrized_fixtures.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAuthenticator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MockDatabase</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;bob&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">username</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;correct_pass&#39;</span><span class="p">,</span> <span class="s1">&#39;wrong_pass&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">password</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create database with the parameterized username.&quot;&quot;&quot;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="s1">&#39;correct_pass&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">db</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_authentication_combinations</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test all combinations of username and password.&quot;&quot;&quot;</span>
    <span class="n">authenticator</span> <span class="o">=</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

    <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="n">password</span> <span class="o">==</span> <span class="s1">&#39;correct_pass&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">expected</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] User: </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">, Password: </span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s2">, Result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_multiple_parametrized_fixtures.py<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_multiple_parametrized_fixtures</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_authentication_combinations</span><span class="o">[</span><span class="n">alice-correct_pass</span><span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="k">User</span><span class="err">:</span><span class="w"> </span><span class="n">alice</span><span class="p">,</span><span class="w"> </span><span class="nl">Password</span><span class="p">:</span><span class="w"> </span><span class="n">correct_pass</span><span class="p">,</span><span class="w"> </span><span class="k">Result</span><span class="err">:</span><span class="w"> </span><span class="k">True</span>
<span class="n">PASSED</span>
<span class="n">test_multiple_parametrized_fixtures</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_authentication_combinations</span><span class="o">[</span><span class="n">alice-wrong_pass</span><span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="k">User</span><span class="err">:</span><span class="w"> </span><span class="n">alice</span><span class="p">,</span><span class="w"> </span><span class="nl">Password</span><span class="p">:</span><span class="w"> </span><span class="n">wrong_pass</span><span class="p">,</span><span class="w"> </span><span class="k">Result</span><span class="err">:</span><span class="w"> </span><span class="k">False</span>
<span class="n">PASSED</span>
<span class="n">test_multiple_parametrized_fixtures</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_authentication_combinations</span><span class="o">[</span><span class="n">bob-correct_pass</span><span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="k">User</span><span class="err">:</span><span class="w"> </span><span class="n">bob</span><span class="p">,</span><span class="w"> </span><span class="nl">Password</span><span class="p">:</span><span class="w"> </span><span class="n">correct_pass</span><span class="p">,</span><span class="w"> </span><span class="k">Result</span><span class="err">:</span><span class="w"> </span><span class="k">True</span>
<span class="n">PASSED</span>
<span class="n">test_multiple_parametrized_fixtures</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_authentication_combinations</span><span class="o">[</span><span class="n">bob-wrong_pass</span><span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="k">User</span><span class="err">:</span><span class="w"> </span><span class="n">bob</span><span class="p">,</span><span class="w"> </span><span class="nl">Password</span><span class="p">:</span><span class="w"> </span><span class="n">wrong_pass</span><span class="p">,</span><span class="w"> </span><span class="k">Result</span><span class="err">:</span><span class="w"> </span><span class="k">False</span>
<span class="n">PASSED</span>

<span class="o">=========================</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.02</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>Two usernames √ó two passwords = four test combinations. Pytest automatically generates all combinations and runs the test for each.</p>
<h2 id="fixture-usage-patterns-summary">Fixture Usage Patterns Summary</h2>
<table>
<thead>
<tr>
<th>Pattern</th>
<th>Use Case</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Multiple fixtures</td>
<td>Test needs several dependencies</td>
<td><code>def test(db, logger, config):</code></td>
</tr>
<tr>
<td>Fixture factory</td>
<td>Need multiple instances in one test</td>
<td><code>db1 = db_factory("users")</code></td>
</tr>
<tr>
<td>Parameterized fixture</td>
<td>Test same logic with different setups</td>
<td><code>@pytest.fixture(params=[...])</code></td>
</tr>
<tr>
<td>Indirect parametrization</td>
<td>Parametrize fixture configuration</td>
<td><code>@pytest.mark.parametrize(..., indirect=True)</code></td>
</tr>
<tr>
<td>Custom IDs</td>
<td>Readable test names</td>
<td><code>ids=['case1', 'case2']</code></td>
</tr>
<tr>
<td>Fixture in classes</td>
<td>Organize related tests</td>
<td><code>class TestAuth:</code> with fixture params</td>
</tr>
</tbody>
</table>
<p>Choose the pattern that makes your tests most readable and maintainable.</p>
<h2 id="fixture-dependencies-and-composition">Fixture Dependencies and Composition</h2>
<h2 id="building-complex-fixtures-from-simple-ones">Building Complex Fixtures from Simple Ones</h2>
<p>Real applications have complex dependencies. A web application test might need:
- A database connection
- A cache layer
- An authentication service
- A configured application instance</p>
<p>Instead of creating one massive fixture, build complex fixtures by <strong>composing</strong> simple ones. This is fixture composition‚Äîthe most powerful pattern in pytest.</p>
<h2 id="the-composition-pattern">The Composition Pattern</h2>
<p>Let's build a realistic example: testing a web API that requires multiple services.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># api.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Database</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection_string</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_string</span> <span class="o">=</span> <span class="n">connection_string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">email</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Cache</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ttl_seconds</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span> <span class="o">=</span> <span class="n">ttl_seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AuthService</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">cache</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="c1"># Check cache first</span>
        <span class="n">cached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;auth:</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cached</span> <span class="o">==</span> <span class="n">password</span>

        <span class="c1"># Check database</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="c1"># Cache the result</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;auth:</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="k">class</span><span class="w"> </span><span class="nc">APIServer</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auth_service</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">auth_service</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Unauthorized&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">401</span><span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Success accessing </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">}</span>
</code></pre></div>

<p>Now let's build fixtures that compose together to create a complete test environment:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_api_composition.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">api</span><span class="w"> </span><span class="kn">import</span> <span class="n">Database</span><span class="p">,</span> <span class="n">Cache</span><span class="p">,</span> <span class="n">AuthService</span><span class="p">,</span> <span class="n">APIServer</span>

<span class="c1"># Layer 1: Basic infrastructure fixtures</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_connection_string</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide database connection configuration.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;postgresql://test:test@localhost/testdb&quot;</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cache_ttl</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide cache TTL configuration.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">300</span>  <span class="c1"># 5 minutes</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_config</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide API server configuration.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
        <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">8000</span><span class="p">,</span>
        <span class="s2">&quot;debug&quot;</span><span class="p">:</span> <span class="kc">True</span>
    <span class="p">}</span>

<span class="c1"># Layer 2: Service fixtures that depend on Layer 1</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">database</span><span class="p">(</span><span class="n">db_connection_string</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a configured database.&quot;&quot;&quot;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="n">db_connection_string</span><span class="p">)</span>
    <span class="c1"># Add test users</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;alice@example.com&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="s1">&#39;bob@example.com&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">db</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cache</span><span class="p">(</span><span class="n">cache_ttl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a configured cache.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Cache</span><span class="p">(</span><span class="n">cache_ttl</span><span class="p">)</span>

<span class="c1"># Layer 3: Application services that depend on Layer 2</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">auth_service</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">cache</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide an authentication service.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">AuthService</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>

<span class="c1"># Layer 4: Complete application that depends on Layer 3</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_server</span><span class="p">(</span><span class="n">auth_service</span><span class="p">,</span> <span class="n">api_config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a fully configured API server.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">APIServer</span><span class="p">(</span><span class="n">auth_service</span><span class="p">,</span> <span class="n">api_config</span><span class="p">)</span>

<span class="c1"># Tests use the top-level fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_successful_authentication</span><span class="p">(</span><span class="n">api_server</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test successful API request with valid credentials.&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">api_server</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;alice_password&#39;</span><span class="p">,</span> <span class="s1">&#39;/users&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="s1">&#39;Success&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_failed_authentication</span><span class="p">(</span><span class="n">api_server</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test API request with invalid credentials.&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">api_server</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;wrong_password&#39;</span><span class="p">,</span> <span class="s1">&#39;/users&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">401</span>
    <span class="k">assert</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Unauthorized&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cache_is_used</span><span class="p">(</span><span class="n">api_server</span><span class="p">,</span> <span class="n">cache</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that authentication results are cached.&quot;&quot;&quot;</span>
    <span class="c1"># First request</span>
    <span class="n">api_server</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;alice_password&#39;</span><span class="p">,</span> <span class="s1">&#39;/users&#39;</span><span class="p">)</span>

    <span class="c1"># Verify cache was populated</span>
    <span class="n">cached_value</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;auth:alice&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cached_value</span> <span class="o">==</span> <span class="s1">&#39;alice_password&#39;</span>

    <span class="c1"># Second request should use cache</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">api_server</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;alice_password&#39;</span><span class="p">,</span> <span class="s1">&#39;/users&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">200</span>
</code></pre></div>

<p>Let's visualize the dependency graph:</p>
<div class="codehilite"><pre><span></span><code>api_server
    ‚îú‚îÄ‚îÄ auth_service
    ‚îÇ   ‚îú‚îÄ‚îÄ database
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ db_connection_string
    ‚îÇ   ‚îî‚îÄ‚îÄ cache
    ‚îÇ       ‚îî‚îÄ‚îÄ cache_ttl
    ‚îî‚îÄ‚îÄ api_config
</code></pre></div>

<p>When you request <code>api_server</code>, pytest automatically:
1. Creates <code>db_connection_string</code>
2. Creates <code>cache_ttl</code>
3. Creates <code>api_config</code>
4. Creates <code>database</code> (using <code>db_connection_string</code>)
5. Creates <code>cache</code> (using <code>cache_ttl</code>)
6. Creates <code>auth_service</code> (using <code>database</code> and <code>cache</code>)
7. Creates <code>api_server</code> (using <code>auth_service</code> and <code>api_config</code>)
8. Passes <code>api_server</code> to your test</p>
<p>Let's run these tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_api_composition.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 3 items

test_api_composition.py::test_successful_authentication PASSED  [ 33%]
test_api_composition.py::test_failed_authentication PASSED      [ 66%]
test_api_composition.py::test_cache_is_used PASSED              [100%]

========================= 3 passed in 0.02s ==========================
</code></pre></div>

<h2 id="benefits-of-fixture-composition">Benefits of Fixture Composition</h2>
<h3 id="1-modularity-and-reusability">1. Modularity and Reusability</h3>
<p>Each fixture is focused on one responsibility. Tests can mix and match:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_database_directly</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test just the database layer.&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;alice@example.com&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_auth_service_directly</span><span class="p">(</span><span class="n">auth_service</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test just the auth service.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">auth_service</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;alice_password&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_full_stack</span><span class="p">(</span><span class="n">api_server</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the complete application.&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">api_server</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;alice_password&#39;</span><span class="p">,</span> <span class="s1">&#39;/users&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">200</span>
</code></pre></div>

<h3 id="2-easy-configuration-changes">2. Easy Configuration Changes</h3>
<p>Want to test with a different cache TTL? Just override one fixture:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cache_ttl</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use a shorter TTL for testing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">10</span>  <span class="c1"># 10 seconds instead of 300</span>
</code></pre></div>

<p>All dependent fixtures automatically use the new value.</p>
<h3 id="3-clear-dependency-visualization">3. Clear Dependency Visualization</h3>
<p>The fixture dependency graph makes it obvious what each component needs:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">auth_service</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">cache</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The signature shows exactly what this service depends on.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">AuthService</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
</code></pre></div>

<h2 id="overriding-fixtures-in-specific-tests">Overriding Fixtures in Specific Tests</h2>
<p>Sometimes you need to customize a fixture for specific tests. Use fixture overriding:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_fixture_override.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">api</span><span class="w"> </span><span class="kn">import</span> <span class="n">Database</span><span class="p">,</span> <span class="n">Cache</span><span class="p">,</span> <span class="n">AuthService</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">database</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Default database with standard test users.&quot;&quot;&quot;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="s2">&quot;default_connection&quot;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;alice@example.com&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">db</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cache</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Default cache with 300 second TTL.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">auth_service</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">cache</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">AuthService</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_with_default_fixtures</span><span class="p">(</span><span class="n">auth_service</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This test uses the default database and cache.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">auth_service</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">database</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Override database for specific tests.&quot;&quot;&quot;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="s2">&quot;special_connection&quot;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;admin@example.com&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">db</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_with_admin_user</span><span class="p">(</span><span class="n">auth_service</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This test uses the overridden database.&quot;&quot;&quot;</span>
    <span class="c1"># The auth_service now uses the database with &#39;admin&#39; user</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">auth_service</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;admin_password&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span>
</code></pre></div>

<p>Wait‚Äîthis won't work as written! Both <code>database</code> fixtures have the same name in the same file. Pytest will only see the second one.</p>
<p>To override fixtures for specific tests, use <strong>fixture scope</strong> or <strong>conftest.py</strong> (covered in section 4.7). For now, here's the correct pattern using a different fixture name:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_fixture_customization.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">api</span><span class="w"> </span><span class="kn">import</span> <span class="n">Database</span><span class="p">,</span> <span class="n">Cache</span><span class="p">,</span> <span class="n">AuthService</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">standard_database</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Standard database with regular users.&quot;&quot;&quot;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="s2">&quot;standard_connection&quot;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;alice@example.com&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="s1">&#39;bob@example.com&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">db</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">admin_database</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Database with admin users.&quot;&quot;&quot;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="s2">&quot;admin_connection&quot;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;admin@example.com&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;superadmin&#39;</span><span class="p">,</span> <span class="s1">&#39;super@example.com&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">db</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cache</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_standard_users</span><span class="p">(</span><span class="n">standard_database</span><span class="p">,</span> <span class="n">cache</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test with standard users.&quot;&quot;&quot;</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">AuthService</span><span class="p">(</span><span class="n">standard_database</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">auth</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;alice_password&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">auth</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;admin_password&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_admin_users</span><span class="p">(</span><span class="n">admin_database</span><span class="p">,</span> <span class="n">cache</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test with admin users.&quot;&quot;&quot;</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">AuthService</span><span class="p">(</span><span class="n">admin_database</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">auth</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;admin_password&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">auth</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;alice_password&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>
</code></pre></div>

<h2 id="fixture-composition-patterns">Fixture Composition Patterns</h2>
<h3 id="pattern-1-layered-architecture">Pattern 1: Layered Architecture</h3>
<p>Organize fixtures in layers that mirror your application architecture:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Layer 1: Configuration</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_config</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">5432</span><span class="p">}</span>

<span class="c1"># Layer 2: Infrastructure</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">database</span><span class="p">(</span><span class="n">db_config</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Database</span><span class="p">(</span><span class="o">**</span><span class="n">db_config</span><span class="p">)</span>

<span class="c1"># Layer 3: Services</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user_service</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">UserService</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>

<span class="c1"># Layer 4: Application</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">app</span><span class="p">(</span><span class="n">user_service</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Application</span><span class="p">(</span><span class="n">user_service</span><span class="p">)</span>
</code></pre></div>

<h3 id="pattern-2-shared-base-with-variations">Pattern 2: Shared Base with Variations</h3>
<p>Create a base fixture and variations for different scenarios:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">base_database</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Minimal database setup.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Database</span><span class="p">(</span><span class="s2">&quot;test_connection&quot;</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">database_with_users</span><span class="p">(</span><span class="n">base_database</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Database with test users.&quot;&quot;&quot;</span>
    <span class="n">base_database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;alice@example.com&#39;</span><span class="p">)</span>
    <span class="n">base_database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="s1">&#39;bob@example.com&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">base_database</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">database_with_admin</span><span class="p">(</span><span class="n">base_database</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Database with admin user.&quot;&quot;&quot;</span>
    <span class="n">base_database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;admin@example.com&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">base_database</span>
</code></pre></div>

<h3 id="pattern-3-optional-dependencies">Pattern 3: Optional Dependencies</h3>
<p>Some fixtures might have optional dependencies:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">logger</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optional logging service.&quot;&quot;&quot;</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">Logger</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[LOG] </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Logger</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">auth_service_with_logging</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Auth service with optional logging.&quot;&quot;&quot;</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">LoggingAuthService</span><span class="p">(</span><span class="n">AuthService</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authenticating </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authentication result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="k">return</span> <span class="n">LoggingAuthService</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
</code></pre></div>

<h2 id="circular-dependencies-what-not-to-do">Circular Dependencies: What Not to Do</h2>
<p>Pytest will detect and reject circular fixture dependencies:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_circular_dependency.py (INVALID)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fixture_a</span><span class="p">(</span><span class="n">fixture_b</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;A depends on </span><span class="si">{</span><span class="n">fixture_b</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fixture_b</span><span class="p">(</span><span class="n">fixture_a</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;B depends on </span><span class="si">{</span><span class="n">fixture_a</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_circular</span><span class="p">(</span><span class="n">fixture_a</span><span class="p">):</span>
    <span class="k">assert</span> <span class="kc">True</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_circular_dependency.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">ERROR</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">setup</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">test_circular</span>

<span class="n">fixture</span><span class="w"> </span><span class="s1">&#39;fixture_a&#39;</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="k">found</span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">available</span><span class="w"> </span><span class="nl">fixtures</span><span class="p">:</span><span class="w"> </span><span class="p">...</span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="s1">&#39;pytest --fixtures [testpath]&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">help</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">them</span><span class="p">.</span>

<span class="nl">ERROR</span><span class="p">:</span><span class="w"> </span><span class="n">Fixture</span><span class="w"> </span><span class="ss">&quot;fixture_a&quot;</span><span class="w"> </span><span class="k">called</span><span class="w"> </span><span class="n">directly</span>
</code></pre></div>

<p>Pytest detects the circular dependency and refuses to run. This is a design error‚Äîfixtures should form a <strong>directed acyclic graph</strong> (DAG), not a cycle.</p>
<p>If you find yourself needing circular dependencies, it's a sign that your fixture design needs refactoring. Usually, you can:
1. Extract the shared logic into a third fixture
2. Combine the two fixtures into one
3. Rethink the dependency relationship</p>
<h2 id="visualizing-fixture-dependencies">Visualizing Fixture Dependencies</h2>
<p>To see the fixture dependency graph for your tests, use <code>pytest --fixtures</code>:
    ```</p>
<div class="codehilite"><pre><span></span><code>```bash
</code></pre></div>

<p>pytest --fixtures test_api_composition.py
    ```</p>
<p>This shows all available fixtures and their docstrings. For a specific test, use <code>--setup-show</code>:
    ```</p>
<div class="codehilite"><pre><span></span><code>```bash
</code></pre></div>

<p>pytest test_api_composition.py::test_cache_is_used --setup-show -v
    ```</p>
<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 1 item

test_api_composition.py::test_cache_is_used 
SETUP    F db_connection_string
SETUP    F cache_ttl
SETUP    F api_config
SETUP    F database (fixtures used: db_connection_string)
SETUP    F cache (fixtures used: cache_ttl)
SETUP    F auth_service (fixtures used: cache, database)
SETUP    F api_server (fixtures used: api_config, auth_service)
        test_api_composition.py::test_cache_is_used (fixtures used: api_server, cache)
PASSED
TEARDOWN F api_server
TEARDOWN F auth_service
TEARDOWN F cache
TEARDOWN F database
TEARDOWN F api_config
TEARDOWN F cache_ttl
TEARDOWN F db_connection_string

========================= 1 passed in 0.02s ==========================
</code></pre></div>

<p>This shows:
1. The order fixtures are created (SETUP)
2. Which fixtures each fixture depends on
3. The order fixtures are torn down (TEARDOWN)</p>
<p>Notice teardown happens in reverse order of setup‚Äîthis ensures dependencies are cleaned up correctly.</p>
<h2 id="composition-best-practices">Composition Best Practices</h2>
<h3 id="1-keep-fixtures-focused">1. Keep Fixtures Focused</h3>
<p>Each fixture should do one thing:</p>
<p>‚úÖ <strong>Good:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">database</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Database</span><span class="p">(</span><span class="s2">&quot;test_connection&quot;</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">database_with_users</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;alice@example.com&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">database</span>
</code></pre></div>

<p>‚ùå <strong>Bad:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">everything</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="s2">&quot;test_connection&quot;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;alice@example.com&#39;</span><span class="p">)</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">AuthService</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">db</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">auth</span>  <span class="c1"># Too many responsibilities</span>
</code></pre></div>

<h3 id="2-use-descriptive-names">2. Use Descriptive Names</h3>
<p>Fixture names should clearly indicate what they provide:</p>
<p>‚úÖ <strong>Good:</strong> <code>database_with_admin_user</code>, <code>authenticated_api_client</code>
‚ùå <strong>Bad:</strong> <code>db2</code>, <code>setup</code>, <code>fixture1</code></p>
<h3 id="3-document-dependencies">3. Document Dependencies</h3>
<p>Use docstrings to explain what each fixture provides and what it depends on:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">auth_service</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">cache</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provide an authentication service.</span>

<span class="sd">    Dependencies:</span>
<span class="sd">        - database: Must contain test users</span>
<span class="sd">        - cache: Used for caching authentication results</span>

<span class="sd">    Returns:</span>
<span class="sd">        AuthService instance configured for testing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">AuthService</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
</code></pre></div>

<h3 id="4-prefer-composition-over-monolithic-fixtures">4. Prefer Composition Over Monolithic Fixtures</h3>
<p>Build complex fixtures from simple ones rather than creating one giant fixture. This makes tests more flexible and fixtures more reusable.</p>
<h2 id="when-to-use-fixture-composition">When to Use Fixture Composition</h2>
<p><strong>Use composition when:</strong>
- Your application has multiple layers (database, services, API)
- Tests need different combinations of components
- Setup is complex and benefits from being broken into steps
- You want to test individual components in isolation</p>
<p><strong>Don't use composition when:</strong>
- Setup is simple and doesn't benefit from decomposition
- Fixtures would only be used once
- The dependency graph becomes too complex to understand</p>
<p>Balance is key. Start simple and add composition as complexity grows.</p>
<h2 id="sharing-fixtures-across-files-conftestpy">Sharing Fixtures Across Files (conftest.py)</h2>
<h2 id="the-problem-fixture-duplication-across-test-files">The Problem: Fixture Duplication Across Test Files</h2>
<p>As your test suite grows, you'll have multiple test files that need the same fixtures. Let's see this problem in action:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_authentication.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAuthenticator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MockDatabase</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">database</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticator</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_valid_credentials</span><span class="p">(</span><span class="n">authenticator</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_authorization.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAuthenticator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MockDatabase</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;admin_pass&#39;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">database</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticator</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_admin_privileges</span><span class="p">(</span><span class="n">authenticator</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">is_admin</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>
</code></pre></div>

<p>We've duplicated:
1. The <code>MockDatabase</code> class definition
2. The <code>db</code> fixture
3. The <code>authenticator</code> fixture</p>
<p>This creates maintenance problems:
- Changes to fixtures must be made in multiple files
- Inconsistencies can creep in between files
- More code to maintain</p>
<h2 id="the-solution-conftestpy">The Solution: conftest.py</h2>
<p><strong><code>conftest.py</code> is a special file where pytest looks for shared fixtures.</strong> Any fixture defined in <code>conftest.py</code> is automatically available to all test files in that directory and subdirectories.</p>
<p>Let's refactor our tests to use <code>conftest.py</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAuthenticator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MockDatabase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Shared database implementation for all tests.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a test database with standard users.&quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;admin_pass&#39;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">database</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticator</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide an authenticator connected to the test database.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">UserAuthenticator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_authentication.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_valid_credentials</span><span class="p">(</span><span class="n">authenticator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;No fixture definitions needed‚Äîthey come from conftest.py.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_credentials</span><span class="p">(</span><span class="n">authenticator</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;wrong&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_authorization.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_admin_privileges</span><span class="p">(</span><span class="n">authenticator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This also uses fixtures from conftest.py.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">is_admin</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_regular_user_not_admin</span><span class="p">(</span><span class="n">authenticator</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">authenticator</span><span class="o">.</span><span class="n">is_admin</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>
</code></pre></div>

<p>Let's run these tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_authentication.py<span class="w"> </span>test_authorization.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mh">4</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_authentication</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_valid_credentials</span><span class="w"> </span><span class="n">PASSED</span><span class="w">           </span><span class="p">[</span><span class="w"> </span><span class="mh">25</span><span class="o">%</span><span class="p">]</span>
<span class="n">test_authentication</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_invalid_credentials</span><span class="w"> </span><span class="n">PASSED</span><span class="w">         </span><span class="p">[</span><span class="w"> </span><span class="mh">50</span><span class="o">%</span><span class="p">]</span>
<span class="n">test_authorization</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_admin_privileges</span><span class="w"> </span><span class="n">PASSED</span><span class="w">             </span><span class="p">[</span><span class="w"> </span><span class="mh">75</span><span class="o">%</span><span class="p">]</span>
<span class="n">test_authorization</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_regular_user_not_admin</span><span class="w"> </span><span class="n">PASSED</span><span class="w">       </span><span class="p">[</span><span class="mh">100</span><span class="o">%</span><span class="p">]</span>

<span class="o">=========================</span><span class="w"> </span><span class="mh">4</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="mf">0.02</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>All tests pass, and they all use the fixtures from <code>conftest.py</code>. No duplication!</p>
<h2 id="how-conftestpy-works">How conftest.py Works</h2>
<h3 id="discovery-rules">Discovery Rules</h3>
<p>Pytest searches for <code>conftest.py</code> files in this order:</p>
<ol>
<li><strong>Test file's directory</strong>: First checks the directory containing the test file</li>
<li><strong>Parent directories</strong>: Walks up the directory tree to the project root</li>
<li><strong>Merges fixtures</strong>: Fixtures from all discovered <code>conftest.py</code> files are available</li>
</ol>
<h3 id="example-directory-structure">Example Directory Structure</h3>
<div class="codehilite"><pre><span></span><code>project/
‚îú‚îÄ‚îÄ conftest.py              # Root-level fixtures
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ conftest.py          # Test-level fixtures
‚îÇ   ‚îú‚îÄ‚îÄ test_auth.py
‚îÇ   ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ conftest.py      # Unit test fixtures
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_database.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_cache.py
‚îÇ   ‚îî‚îÄ‚îÄ integration/
‚îÇ       ‚îú‚îÄ‚îÄ conftest.py      # Integration test fixtures
‚îÇ       ‚îî‚îÄ‚îÄ test_api.py
</code></pre></div>

<p><strong>Fixture availability:</strong>
- <code>test_database.py</code> can use fixtures from: <code>unit/conftest.py</code>, <code>tests/conftest.py</code>, <code>project/conftest.py</code>
- <code>test_api.py</code> can use fixtures from: <code>integration/conftest.py</code>, <code>tests/conftest.py</code>, <code>project/conftest.py</code>
- <code>test_auth.py</code> can use fixtures from: <code>tests/conftest.py</code>, <code>project/conftest.py</code></p>
<h2 id="hierarchical-conftestpy-files">Hierarchical conftest.py Files</h2>
<p>Let's create a realistic project structure with multiple <code>conftest.py</code> files:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (root level)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">project_config</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Global configuration available to all tests.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;project_name&quot;</span><span class="p">:</span> <span class="s2">&quot;MyApp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;environment&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span>
    <span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># tests/conftest.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MockDatabase</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Database fixture available to all tests.&quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">database</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># tests/unit/conftest.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">unit_test_marker</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Marker to identify unit tests.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;UNIT_TEST&quot;</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># tests/integration/conftest.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">integration_test_marker</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Marker to identify integration tests.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;INTEGRATION_TEST&quot;</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_client</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;API client for integration tests.&quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">api</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIServer</span><span class="p">,</span> <span class="n">AuthService</span><span class="p">,</span> <span class="n">Cache</span>

    <span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">AuthService</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">APIServer</span><span class="p">(</span><span class="n">auth</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">8000</span><span class="p">})</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># tests/unit/test_database.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_database_add_user</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">unit_test_marker</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unit test can use fixtures from tests/conftest.py and tests/unit/conftest.py.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="n">unit_test_marker</span><span class="si">}</span><span class="s2">] Testing database&quot;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="s1">&#39;bob_pass&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="s1">&#39;bob&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_project_config_available</span><span class="p">(</span><span class="n">project_config</span><span class="p">,</span> <span class="n">unit_test_marker</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unit test can also use root-level fixtures.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="n">unit_test_marker</span><span class="si">}</span><span class="s2">] Project: </span><span class="si">{</span><span class="n">project_config</span><span class="p">[</span><span class="s1">&#39;project_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">project_config</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># tests/integration/test_api.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_api_authentication</span><span class="p">(</span><span class="n">api_client</span><span class="p">,</span> <span class="n">integration_test_marker</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Integration test uses fixtures from multiple conftest.py files.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="n">integration_test_marker</span><span class="si">}</span><span class="s2">] Testing API&quot;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">api_client</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;secret123&#39;</span><span class="p">,</span> <span class="s1">&#39;/users&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">200</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_api_with_project_config</span><span class="p">(</span><span class="n">api_client</span><span class="p">,</span> <span class="n">project_config</span><span class="p">,</span> <span class="n">integration_test_marker</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Integration test can access root-level fixtures.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="n">integration_test_marker</span><span class="si">}</span><span class="s2">] API version: </span><span class="si">{</span><span class="n">project_config</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">api_client</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;localhost&#39;</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>tests/<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">items</span>

<span class="n">tests</span><span class="o">/</span><span class="n">unit</span><span class="o">/</span><span class="n">test_database</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_database_add_user</span><span class="w"> </span>
<span class="o">[</span><span class="n">UNIT_TEST</span><span class="o">]</span><span class="w"> </span><span class="n">Testing</span><span class="w"> </span><span class="k">database</span>
<span class="n">PASSED</span>
<span class="n">tests</span><span class="o">/</span><span class="n">unit</span><span class="o">/</span><span class="n">test_database</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_project_config_available</span><span class="w"> </span>
<span class="o">[</span><span class="n">UNIT_TEST</span><span class="o">]</span><span class="w"> </span><span class="nl">Project</span><span class="p">:</span><span class="w"> </span><span class="n">MyApp</span>
<span class="n">PASSED</span>

<span class="n">tests</span><span class="o">/</span><span class="n">integration</span><span class="o">/</span><span class="n">test_api</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_api_authentication</span><span class="w"> </span>
<span class="o">[</span><span class="n">INTEGRATION_TEST</span><span class="o">]</span><span class="w"> </span><span class="n">Testing</span><span class="w"> </span><span class="n">API</span>
<span class="n">PASSED</span>
<span class="n">tests</span><span class="o">/</span><span class="n">integration</span><span class="o">/</span><span class="n">test_api</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_api_with_project_config</span><span class="w"> </span>
<span class="o">[</span><span class="n">INTEGRATION_TEST</span><span class="o">]</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="nl">version</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0.0</span>
<span class="n">PASSED</span>

<span class="o">=========================</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.03</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>Each test has access to:
- Fixtures from its own directory's <code>conftest.py</code>
- Fixtures from parent directories' <code>conftest.py</code> files
- Fixtures from the root <code>conftest.py</code></p>
<h2 id="fixture-overriding-in-conftestpy">Fixture Overriding in conftest.py</h2>
<p>Fixtures in child directories can override fixtures from parent directories:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py (root)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Default database with minimal setup.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[ROOT] Creating minimal database&quot;</span><span class="p">)</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">MinimalDB</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="n">MinimalDB</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># tests/integration/conftest.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Override with a more complete database for integration tests.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[INTEGRATION] Creating full-featured database&quot;</span><span class="p">)</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">FullDB</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="n">FullDB</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># tests/unit/test_simple.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_uses_root_db</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This uses the root-level db fixture.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] Database type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;users&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;sessions&#39;</span><span class="p">)</span>  <span class="c1"># MinimalDB doesn&#39;t have sessions</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># tests/integration/test_complex.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_uses_integration_db</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This uses the overridden db fixture.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEST] Database type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;users&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;sessions&#39;</span><span class="p">)</span>  <span class="c1"># FullDB has sessions</span>
    <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;cache&#39;</span><span class="p">)</span>     <span class="c1"># FullDB has cache</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>tests/<span class="w"> </span>-v<span class="w"> </span>-s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">items</span>

<span class="n">tests</span><span class="o">/</span><span class="n">unit</span><span class="o">/</span><span class="n">test_simple</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_uses_root_db</span><span class="w"> </span>
<span class="o">[</span><span class="n">ROOT</span><span class="o">]</span><span class="w"> </span><span class="n">Creating</span><span class="w"> </span><span class="n">minimal</span><span class="w"> </span><span class="k">database</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="k">Database</span><span class="w"> </span><span class="nl">type</span><span class="p">:</span><span class="w"> </span><span class="n">MinimalDB</span>
<span class="n">PASSED</span>

<span class="n">tests</span><span class="o">/</span><span class="n">integration</span><span class="o">/</span><span class="n">test_complex</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_uses_integration_db</span><span class="w"> </span>
<span class="o">[</span><span class="n">INTEGRATION</span><span class="o">]</span><span class="w"> </span><span class="n">Creating</span><span class="w"> </span><span class="k">full</span><span class="o">-</span><span class="n">featured</span><span class="w"> </span><span class="k">database</span>
<span class="o">[</span><span class="n">TEST</span><span class="o">]</span><span class="w"> </span><span class="k">Database</span><span class="w"> </span><span class="nl">type</span><span class="p">:</span><span class="w"> </span><span class="n">FullDB</span>
<span class="n">PASSED</span>

<span class="o">=========================</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.02</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>The unit test used the root-level fixture, while the integration test used the overridden version.</p>
<h2 id="organizing-fixtures-by-purpose">Organizing Fixtures by Purpose</h2>
<p>A common pattern is to organize fixtures in <code>conftest.py</code> by their purpose:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># Database Fixtures</span>
<span class="c1"># ============================================================================</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a clean test database.&quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">Database</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="s2">&quot;test_connection&quot;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">db</span>
    <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db_with_users</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Database pre-populated with test users.&quot;&quot;&quot;</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;alice@example.com&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="s1">&#39;bob@example.com&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">db</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># Authentication Fixtures</span>
<span class="c1"># ============================================================================</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">auth_service</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide an authentication service.&quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">AuthService</span>
    <span class="k">return</span> <span class="n">AuthService</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticated_user</span><span class="p">(</span><span class="n">auth_service</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide an authenticated user session.&quot;&quot;&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">auth_service</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;alice_password&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">session</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># API Fixtures</span>
<span class="c1"># ============================================================================</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_client</span><span class="p">(</span><span class="n">auth_service</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide an API client for testing.&quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">api</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIClient</span>
    <span class="k">return</span> <span class="n">APIClient</span><span class="p">(</span><span class="n">auth_service</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticated_api_client</span><span class="p">(</span><span class="n">api_client</span><span class="p">,</span> <span class="n">authenticated_user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide an authenticated API client.&quot;&quot;&quot;</span>
    <span class="n">api_client</span><span class="o">.</span><span class="n">set_session</span><span class="p">(</span><span class="n">authenticated_user</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">api_client</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># Configuration Fixtures</span>
<span class="c1"># ============================================================================</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_config</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide test configuration.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;database_url&quot;</span><span class="p">:</span> <span class="s2">&quot;postgresql://test:test@localhost/testdb&quot;</span><span class="p">,</span>
        <span class="s2">&quot;api_url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://localhost:8000&quot;</span><span class="p">,</span>
        <span class="s2">&quot;timeout&quot;</span><span class="p">:</span> <span class="mi">30</span>
    <span class="p">}</span>
</code></pre></div>

<p>This organization makes it easy to:
- Find related fixtures
- Understand fixture purposes
- Add new fixtures in the right place</p>
<h2 id="common-conftestpy-patterns">Common conftest.py Patterns</h2>
<h3 id="pattern-1-autouse-fixtures-for-test-environment-setup">Pattern 1: Autouse Fixtures for Test Environment Setup</h3>
<p>Use <code>autouse=True</code> in <code>conftest.py</code> to set up the test environment automatically:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">setup_test_environment</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up test environment before any tests run.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[SETUP] Configuring test environment&quot;</span><span class="p">)</span>

    <span class="c1"># Set environment variables</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TESTING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DATABASE_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;postgresql://test:test@localhost/testdb&#39;</span>

    <span class="k">yield</span>

    <span class="c1"># Cleanup</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[TEARDOWN] Cleaning up test environment&quot;</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TESTING&#39;</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DATABASE_URL&#39;</span><span class="p">]</span>
</code></pre></div>

<h3 id="pattern-2-fixture-factories-in-conftestpy">Pattern 2: Fixture Factories in conftest.py</h3>
<p>Provide factory fixtures for creating multiple instances:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user_factory</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for creating test users.&quot;&quot;&quot;</span>
    <span class="n">created_users</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">):</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">role</span><span class="p">)</span>
        <span class="n">created_users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">create_user</span>

    <span class="c1"># Cleanup: remove all created users</span>
    <span class="k">for</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">created_users</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">remove_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</code></pre></div>

<h3 id="pattern-3-conditional-fixtures-based-on-markers">Pattern 3: Conditional Fixtures Based on Markers</h3>
<p>Create fixtures that behave differently based on test markers:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide different database based on test marker.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;slow&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
        <span class="c1"># Use real database for slow tests</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FIXTURE] Using real database&quot;</span><span class="p">)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">RealDatabase</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">RealDatabase</span><span class="p">(</span><span class="s2">&quot;test_connection&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Use mock database for fast tests</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FIXTURE] Using mock database&quot;</span><span class="p">)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">MockDatabase</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">MockDatabase</span><span class="p">()</span>

    <span class="k">yield</span> <span class="n">db</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">):</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># test_example.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_fast_operation</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This uses MockDatabase.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">slow</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_slow_operation</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This uses RealDatabase.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</code></pre></div>

<h2 id="viewing-available-fixtures">Viewing Available Fixtures</h2>
<p>To see all fixtures available to your tests, including those from <code>conftest.py</code>:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>--fixtures
</code></pre></div>

<p>This shows:
- All fixtures defined in <code>conftest.py</code> files
- Built-in pytest fixtures
- Fixtures from installed plugins
- Each fixture's docstring</p>
<p>To see fixtures for a specific test file:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>--fixtures<span class="w"> </span>tests/unit/test_database.py
</code></pre></div>

<p>To see only your custom fixtures (not built-ins):</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>--fixtures<span class="w"> </span>-v<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="s2">&quot;conftest.py&quot;</span>
</code></pre></div>

<h2 id="conftestpy-best-practices">conftest.py Best Practices</h2>
<h3 id="1-keep-conftestpy-focused">1. Keep conftest.py Focused</h3>
<p>Don't put all fixtures in one root-level <code>conftest.py</code>. Organize by:
- <strong>Root <code>conftest.py</code></strong>: Session-scoped fixtures, global configuration
- <strong>tests/conftest.py<code>**: Common fixtures for all tests
- **tests/unit/conftest.py</code></strong>: Unit test-specific fixtures
- <strong>tests/integration/conftest.py`</strong>: Integration test-specific fixtures</p>
<h3 id="2-document-fixture-purpose">2. Document Fixture Purpose</h3>
<p>Every fixture in <code>conftest.py</code> should have a clear docstring:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">authenticated_api_client</span><span class="p">(</span><span class="n">api_client</span><span class="p">,</span> <span class="n">user_session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provide an API client with an authenticated user session.</span>

<span class="sd">    This fixture combines an API client with a valid user session,</span>
<span class="sd">    allowing tests to make authenticated requests without manual login.</span>

<span class="sd">    Dependencies:</span>
<span class="sd">        - api_client: Base API client</span>
<span class="sd">        - user_session: Valid user authentication session</span>

<span class="sd">    Returns:</span>
<span class="sd">        APIClient: Configured client ready for authenticated requests</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">api_client</span><span class="o">.</span><span class="n">set_session</span><span class="p">(</span><span class="n">user_session</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">api_client</span>
</code></pre></div>

<h3 id="3-avoid-circular-imports">3. Avoid Circular Imports</h3>
<p>Be careful with imports in <code>conftest.py</code>. If your fixtures import from test files, you can create circular dependencies:</p>
<p>‚ùå <strong>Bad:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">test_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_test_user</span>  <span class="c1"># Circular import!</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">create_test_user</span><span class="p">()</span>
</code></pre></div>

<p>‚úÖ <strong>Good:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># conftest.py</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user</span><span class="p">():</span>
    <span class="c1"># Import inside fixture to avoid circular dependency</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_test_user</span>
    <span class="k">return</span> <span class="n">create_test_user</span><span class="p">()</span>
</code></pre></div>

<p>Or better yet, move shared code to a separate module:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_utils.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_test_user</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;test_user&quot;</span><span class="p">)</span>

<span class="c1"># conftest.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">test_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_test_user</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">create_test_user</span><span class="p">()</span>
</code></pre></div>

<h3 id="4-use-scope-appropriately">4. Use Scope Appropriately</h3>
<p>In <code>conftest.py</code>, be especially careful with scope:
- <strong>Session scope</strong>: Only for truly global, immutable resources
- <strong>Module scope</strong>: For resources shared within a test file
- <strong>Function scope</strong>: Default, safest choice</p>
<h3 id="5-name-fixtures-clearly">5. Name Fixtures Clearly</h3>
<p>Fixture names should indicate what they provide:</p>
<p>‚úÖ <strong>Good:</strong> <code>authenticated_user</code>, <code>db_with_test_data</code>, <code>api_client_with_auth</code>
‚ùå <strong>Bad:</strong> <code>user</code>, <code>db</code>, <code>client</code> (too generic)</p>
<h2 id="when-to-use-conftestpy">When to Use conftest.py</h2>
<p><strong>Use conftest.py when:</strong>
- Multiple test files need the same fixtures
- You want to organize fixtures by test category (unit, integration, etc.)
- You need session-scoped fixtures available everywhere
- You want to set up test environment automatically</p>
<p><strong>Don't use conftest.py when:</strong>
- Fixtures are only used in one test file (keep them local)
- Fixtures are highly specific to one test scenario
- You're creating fixtures "just in case" (YAGNI principle)</p>
<h2 id="the-journey-from-duplication-to-shared-fixtures">The Journey: From Duplication to Shared Fixtures</h2>
<p>Let's review the progression:</p>
<table>
<thead>
<tr>
<th>Stage</th>
<th>Problem</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr>
<td>1. No fixtures</td>
<td>Duplicated setup in every test</td>
<td>Create fixtures</td>
</tr>
<tr>
<td>2. Local fixtures</td>
<td>Duplicated fixtures across files</td>
<td>Move to conftest.py</td>
</tr>
<tr>
<td>3. Flat conftest.py</td>
<td>All fixtures in one file</td>
<td>Hierarchical conftest.py</td>
</tr>
<tr>
<td>4. Organized conftest.py</td>
<td>Hard to find fixtures</td>
<td>Group by purpose, document</td>
</tr>
</tbody>
</table>
<p>Start simple with local fixtures. Move to <code>conftest.py</code> when duplication becomes painful. Organize hierarchically as your test suite grows.</p>
<h2 id="summary-the-power-of-conftestpy">Summary: The Power of conftest.py</h2>
<p><code>conftest.py</code> is pytest's solution to fixture sharing. It enables:
- <strong>Zero duplication</strong>: Write fixtures once, use everywhere
- <strong>Hierarchical organization</strong>: Different fixtures for different test categories
- <strong>Automatic discovery</strong>: No imports needed
- <strong>Fixture overriding</strong>: Customize fixtures for specific test directories
- <strong>Clear structure</strong>: Organize fixtures by purpose and scope</p>
<p>Combined with fixture composition (section 4.6), <code>conftest.py</code> gives you a powerful system for building maintainable test suites that scale from dozens to thousands of tests.</p>
        </div>
        <div class="footer">
            Generated on 2025-12-03 10:37:00 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>