<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>07 Assertions and Error Handling</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">02 Core Testing Concepts</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-7-assertions-and-error-handling">Chapter 7: Assertions and Error Handling</h1>
<h2 id="beyond-simple-assertions">Beyond Simple Assertions</h2>
<h2 id="the-heart-of-the-test-the-assert-statement">The Heart of the Test: The <code>assert</code> Statement</h2>
<p>At its core, every test performs three steps: Arrange, Act, and Assert. The assertion is the moment of truth‚Äîit's where we verify that the outcome of our action matches our expectation. Pytest is built around Python's native <code>assert</code> statement, supercharging it with a feature called "assertion introspection." This means you don't need special assertion methods like <code>self.assertEqual()</code> or <code>self.assertTrue()</code> that are common in other frameworks. A plain <code>assert</code> is all you need.</p>
<p>This chapter is dedicated to mastering assertions. We'll start with the basics, learn how to read pytest's incredibly detailed failure reports, and then move on to advanced techniques for handling expected errors and warnings.</p>
<h3 id="phase-1-establish-the-reference-implementation">Phase 1: Establish the Reference Implementation</h3>
<p>To explore these concepts, we need a realistic piece of code to test. We'll build a simple <code>UserValidator</code> that checks if a user data dictionary is valid for registration. This will be our <strong>anchor example</strong> for the entire chapter.</p>
<p>Our validator will check three things:
1.  The user must be at least 18 years old.
2.  The username must not be "admin".
3.  The email must contain an "@" symbol.</p>
<p>Here is the initial implementation of our validator and its first test.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_validator.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserValidator</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">user_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_age</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;User must be 18 or older.&quot;&quot;&quot;</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">birthdate</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;birthdate&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="n">age</span> <span class="o">=</span> <span class="n">today</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="n">birthdate</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="p">((</span><span class="n">today</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">today</span><span class="o">.</span><span class="n">day</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">birthdate</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">birthdate</span><span class="o">.</span><span class="n">day</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;User must be 18 or older&quot;</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s2">&quot;birthdate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Invalid date format&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Username cannot be &#39;admin&#39;.&quot;&quot;&quot;</span>
        <span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">username</span> <span class="o">==</span> <span class="s2">&quot;admin&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Username cannot be &#39;admin&#39;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Email must be valid.&quot;&quot;&quot;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;@&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">email</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Invalid email address&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Runs all validations and returns True if no errors.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Reset errors on each run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_age</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_username</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_email</span><span class="p">()</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_validation_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Runs validation and returns a detailed report.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="c1"># Ensure validation has run</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;is_valid&quot;</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span>
            <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span>
        <span class="p">}</span>

<span class="c1"># test_validator.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">user_validator</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserValidator</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_valid_user</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests a user with completely valid data.&quot;&quot;&quot;</span>
    <span class="n">valid_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;john_doe&quot;</span><span class="p">,</span>
        <span class="s2">&quot;birthdate&quot;</span><span class="p">:</span> <span class="s2">&quot;2001-05-15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;john.doe@example.com&quot;</span>
    <span class="p">}</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">UserValidator</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span>

    <span class="c1"># We expect the validation report to show success</span>
    <span class="n">expected_report</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;is_valid&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>

    <span class="n">actual_report</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">get_validation_report</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">actual_report</span> <span class="o">==</span> <span class="n">expected_report</span>
</code></pre></div>

<p>Let's run this to confirm our baseline is working.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v
<span class="o">=========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==========================</span>
...
collected<span class="w"> </span><span class="m">1</span><span class="w"> </span>item

test_validator.py::test_valid_user<span class="w"> </span>PASSED<span class="w">                         </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">==========================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span>...s<span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>Great. Now, let's write a test for an invalid user who is underage. This will expose our first assertion failure and set the stage for learning how to read pytest's output.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_validator.py (added test)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">user_validator</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserValidator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_valid_user</span><span class="p">():</span>
    <span class="c1"># ... (same as before) ...</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_underage_user</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests a user who is younger than 18.&quot;&quot;&quot;</span>
    <span class="c1"># A birthdate exactly 17 years ago</span>
    <span class="n">underage_birthdate</span> <span class="o">=</span> <span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">17</span><span class="o">*</span><span class="mi">365</span><span class="p">))</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

    <span class="n">invalid_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;jane_doe&quot;</span><span class="p">,</span>
        <span class="s2">&quot;birthdate&quot;</span><span class="p">:</span> <span class="n">underage_birthdate</span><span class="p">,</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;jane.doe@example.com&quot;</span>
    <span class="p">}</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">UserValidator</span><span class="p">(</span><span class="n">invalid_data</span><span class="p">)</span>

    <span class="n">expected_report</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;is_valid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="s2">&quot;User must be 18 or older&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">actual_report</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">get_validation_report</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">actual_report</span> <span class="o">==</span> <span class="n">expected_report</span>
</code></pre></div>

<p>This test seems correct. We create a user who is clearly underage and assert that the validation report reflects this specific error. Let's run it.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v
<span class="o">=========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==========================</span>
...
collected<span class="w"> </span><span class="m">2</span><span class="w"> </span>items

test_validator.py::test_valid_user<span class="w"> </span>PASSED<span class="w">                         </span><span class="o">[</span><span class="w"> </span><span class="m">50</span>%<span class="o">]</span>
test_validator.py::test_underage_user<span class="w"> </span>FAILED<span class="w">                      </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">===============================</span><span class="w"> </span><span class="nv">FAILURES</span><span class="w"> </span><span class="o">===============================</span>
__________________________<span class="w"> </span>test_underage_user<span class="w"> </span>__________________________

<span class="w">    </span>def<span class="w"> </span>test_underage_user<span class="o">()</span>:
<span class="w">        </span><span class="s2">&quot;&quot;&quot;Tests a user who is younger than 18.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="c1"># A birthdate exactly 17 years ago</span>
<span class="w">        </span><span class="nv">underage_birthdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>date.today<span class="o">()</span><span class="w"> </span>-<span class="w"> </span>timedelta<span class="o">(</span><span class="nv">days</span><span class="o">=</span><span class="m">17</span>*365<span class="o">))</span>.isoformat<span class="o">()</span>

<span class="w">        </span><span class="nv">invalid_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="s2">&quot;username&quot;</span>:<span class="w"> </span><span class="s2">&quot;jane_doe&quot;</span>,
<span class="w">            </span><span class="s2">&quot;birthdate&quot;</span>:<span class="w"> </span>underage_birthdate,
<span class="w">            </span><span class="s2">&quot;email&quot;</span>:<span class="w"> </span><span class="s2">&quot;jane.doe@example.com&quot;</span>
<span class="w">        </span><span class="o">}</span>
<span class="w">        </span><span class="nv">validator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>UserValidator<span class="o">(</span>invalid_data<span class="o">)</span>

<span class="w">        </span><span class="nv">expected_report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">            </span><span class="s2">&quot;is_valid&quot;</span>:<span class="w"> </span>False,
<span class="w">            </span><span class="s2">&quot;errors&quot;</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">                </span><span class="s2">&quot;age&quot;</span>:<span class="w"> </span><span class="s2">&quot;User must be 18 or older&quot;</span>
<span class="w">            </span><span class="o">}</span>
<span class="w">        </span><span class="o">}</span>

<span class="w">        </span><span class="nv">actual_report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>validator.get_validation_report<span class="o">()</span>

&gt;<span class="w">       </span>assert<span class="w"> </span><span class="nv">actual_report</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>expected_report
E<span class="w">       </span>AssertionError:<span class="w"> </span>assert<span class="w"> </span><span class="o">{</span><span class="s1">&#39;errors&#39;</span>:<span class="w"> </span><span class="o">{</span><span class="s1">&#39;...id&#39;</span>:<span class="w"> </span>False<span class="o">}</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">{</span><span class="s1">&#39;errors&#39;</span>:<span class="w"> </span><span class="o">{</span><span class="s1">&#39;...id&#39;</span>:<span class="w"> </span>False<span class="o">}</span>
E<span class="w">         </span>Differing<span class="w"> </span>items:
E<span class="w">         </span><span class="o">{</span><span class="s1">&#39;errors&#39;</span>:<span class="w"> </span><span class="o">{</span><span class="s1">&#39;age&#39;</span>:<span class="w"> </span><span class="s1">&#39;User must be 18 or older&#39;</span><span class="o">}}</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="s1">&#39;errors&#39;</span>:<span class="w"> </span><span class="o">{</span><span class="s1">&#39;age&#39;</span>:<span class="w"> </span><span class="s1">&#39;User must be at least 18&#39;</span><span class="o">}}</span>
E<span class="w">         </span>Full<span class="w"> </span>diff:
E<span class="w">         </span>-<span class="w"> </span><span class="o">{</span><span class="s1">&#39;errors&#39;</span>:<span class="w"> </span><span class="o">{</span><span class="s1">&#39;age&#39;</span>:<span class="w"> </span><span class="s1">&#39;User must be at least 18&#39;</span><span class="o">}</span>,<span class="w"> </span><span class="s1">&#39;is_valid&#39;</span>:<span class="w"> </span>False<span class="o">}</span>
E<span class="w">         </span>?<span class="w">                                  </span>---------
E<span class="w">         </span>+<span class="w"> </span><span class="o">{</span><span class="s1">&#39;errors&#39;</span>:<span class="w"> </span><span class="o">{</span><span class="s1">&#39;age&#39;</span>:<span class="w"> </span><span class="s1">&#39;User must be 18 or older&#39;</span><span class="o">}</span>,<span class="w"> </span><span class="s1">&#39;is_valid&#39;</span>:<span class="w"> </span>False<span class="o">}</span>
E<span class="w">         </span>?<span class="w">                                  </span>^^^^^^^^

test_validator.py:36:<span class="w"> </span><span class="nv">AssertionError</span>
<span class="o">=======================</span><span class="w"> </span>short<span class="w"> </span><span class="nb">test</span><span class="w"> </span>summary<span class="w"> </span><span class="nv">info</span><span class="w"> </span><span class="o">========================</span>
FAILED<span class="w"> </span>test_validator.py::test_underage_user<span class="w"> </span>-<span class="w"> </span>AssertionError:<span class="w"> </span>assert...
<span class="o">=====================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>failed,<span class="w"> </span><span class="m">1</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span>...s<span class="w"> </span><span class="o">=====================</span>
</code></pre></div>

<p>It failed! This is perfect. The failure isn't due to a complex logical bug, but a simple typo in our test's expectation. This provides an ideal opportunity to learn how to dissect pytest's rich failure reports.</p>
<h2 id="assertion-introspection-reading-failure-messages">Assertion Introspection: Reading Failure Messages</h2>
<h2 id="diagnostic-analysis-reading-the-failure">Diagnostic Analysis: Reading the Failure</h2>
<p>A failing test is not a dead end; it's a map that tells you exactly where your code deviates from your expectations. Learning to read this map is one of the most critical skills in testing. Pytest's output is dense with information, so let's break down the failure from the previous section piece by piece.</p>
<p><strong>The complete output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">===============================</span><span class="w"> </span><span class="nv">FAILURES</span><span class="w"> </span><span class="o">===============================</span>
__________________________<span class="w"> </span>test_underage_user<span class="w"> </span>__________________________

<span class="w">    </span>def<span class="w"> </span>test_underage_user<span class="o">()</span>:
<span class="w">        </span><span class="s2">&quot;&quot;&quot;Tests a user who is younger than 18.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="c1"># ... (code omitted for brevity) ...</span>

<span class="w">        </span><span class="nv">actual_report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>validator.get_validation_report<span class="o">()</span>

&gt;<span class="w">       </span>assert<span class="w"> </span><span class="nv">actual_report</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>expected_report
E<span class="w">       </span>AssertionError:<span class="w"> </span>assert<span class="w"> </span><span class="o">{</span><span class="s1">&#39;errors&#39;</span>:<span class="w"> </span><span class="o">{</span><span class="s1">&#39;...id&#39;</span>:<span class="w"> </span>False<span class="o">}</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">{</span><span class="s1">&#39;errors&#39;</span>:<span class="w"> </span><span class="o">{</span><span class="s1">&#39;...id&#39;</span>:<span class="w"> </span>False<span class="o">}</span>
E<span class="w">         </span>Differing<span class="w"> </span>items:
E<span class="w">         </span><span class="o">{</span><span class="s1">&#39;errors&#39;</span>:<span class="w"> </span><span class="o">{</span><span class="s1">&#39;age&#39;</span>:<span class="w"> </span><span class="s1">&#39;User must be 18 or older&#39;</span><span class="o">}}</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="s1">&#39;errors&#39;</span>:<span class="w"> </span><span class="o">{</span><span class="s1">&#39;age&#39;</span>:<span class="w"> </span><span class="s1">&#39;User must be at least 18&#39;</span><span class="o">}}</span>
E<span class="w">         </span>Full<span class="w"> </span>diff:
E<span class="w">         </span>-<span class="w"> </span><span class="o">{</span><span class="s1">&#39;errors&#39;</span>:<span class="w"> </span><span class="o">{</span><span class="s1">&#39;age&#39;</span>:<span class="w"> </span><span class="s1">&#39;User must be at least 18&#39;</span><span class="o">}</span>,<span class="w"> </span><span class="s1">&#39;is_valid&#39;</span>:<span class="w"> </span>False<span class="o">}</span>
E<span class="w">         </span>?<span class="w">                                  </span>---------
E<span class="w">         </span>+<span class="w"> </span><span class="o">{</span><span class="s1">&#39;errors&#39;</span>:<span class="w"> </span><span class="o">{</span><span class="s1">&#39;age&#39;</span>:<span class="w"> </span><span class="s1">&#39;User must be 18 or older&#39;</span><span class="o">}</span>,<span class="w"> </span><span class="s1">&#39;is_valid&#39;</span>:<span class="w"> </span>False<span class="o">}</span>
E<span class="w">         </span>?<span class="w">                                  </span>^^^^^^^^

test_validator.py:36:<span class="w"> </span>AssertionError
</code></pre></div>

<p><strong>Let's parse this section by section</strong>:</p>
<ol>
<li>
<p><strong>The summary line</strong>: <code>FAILED test_validator.py::test_underage_user - AssertionError: assert...</code></p>
<ul>
<li><strong>What this tells us</strong>: The test named <code>test_underage_user</code> in the file <code>test_validator.py</code> failed. The reason for the failure was an <code>AssertionError</code>, which means the condition in an <code>assert</code> statement evaluated to <code>False</code>.</li>
</ul>
</li>
<li>
<p><strong>The traceback</strong>:
    <code>python
    &gt;       assert actual_report == expected_report
    test_validator.py:36: AssertionError</code></p>
<ul>
<li><strong>What this tells us</strong>: This points to the exact line of code that failed. The <code>&gt;</code> character highlights line 36 in <code>test_validator.py</code>. This is the most important piece of information for locating the problem.</li>
</ul>
</li>
<li>
<p><strong>The assertion introspection</strong>:
    <code>E       AssertionError: assert {'errors': {'...id': False} == {'errors': {'...id': False}
    E         Differing items:
    E         {'errors': {'age': 'User must be 18 or older'}} != {'errors': {'age': 'User must be at least 18'}}
    E         Full diff:
    E         - {'errors': {'age': 'User must be at least 18'}, 'is_valid': False}
    E         ?                                  ---------
    E         + {'errors': {'age': 'User must be 18 or older'}, 'is_valid': False}
    E         ?                                  ^^^^^^^^</code></p>
<ul>
<li><strong>What this tells us</strong>: This is pytest's magic. It "introspects" the objects involved in the failed assertion and provides a detailed, human-readable diff.<ul>
<li>The first line shows the assertion that failed, with large data structures abbreviated (<code>...</code>).</li>
<li><code>Differing items:</code> gets to the heart of the matter. It isolates the exact key-value pair in the dictionary that didn't match. We can clearly see the string for the <code>'age'</code> error is different.</li>
<li><code>Full diff:</code> provides a standard <code>diff</code> format. Lines starting with <code>-</code> are from the left side of the <code>==</code> (the expected value in our case), and lines with <code>+</code> are from the right side (the actual value). The <code>?</code> lines highlight the precise characters that differ.</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><strong>Root cause identified</strong>: We have a typo in our test. The <code>UserValidator</code> produces the error message <code>"User must be 18 or older"</code>, but our test <em>expected</em> <code>"User must be at least 18"</code>.</p>
<p><strong>Why the current approach can't solve this</strong>: The approach is fine, but our data is wrong. The introspection gave us all the information we needed to spot the mistake instantly.</p>
<p><strong>What we need</strong>: We need to fix the expected string in our test to match the actual implementation.</p>
<p>Let's apply the fix.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_validator.py (fixed)</span>

<span class="c1"># ... (imports and test_valid_user are the same) ...</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_underage_user</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests a user who is younger than 18.&quot;&quot;&quot;</span>
    <span class="n">underage_birthdate</span> <span class="o">=</span> <span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">17</span><span class="o">*</span><span class="mi">365</span><span class="p">))</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

    <span class="n">invalid_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;jane_doe&quot;</span><span class="p">,</span>
        <span class="s2">&quot;birthdate&quot;</span><span class="p">:</span> <span class="n">underage_birthdate</span><span class="p">,</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;jane.doe@example.com&quot;</span>
    <span class="p">}</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">UserValidator</span><span class="p">(</span><span class="n">invalid_data</span><span class="p">)</span>

    <span class="c1"># BEFORE: The expected message was wrong</span>
    <span class="c1"># expected_report = {</span>
    <span class="c1">#     &quot;is_valid&quot;: False,</span>
    <span class="c1">#     &quot;errors&quot;: {</span>
    <span class="c1">#         &quot;age&quot;: &quot;User must be at least 18&quot;</span>
    <span class="c1">#     }</span>
    <span class="c1"># }</span>

    <span class="c1"># AFTER: The expected message now matches the implementation</span>
    <span class="n">expected_report</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;is_valid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="s2">&quot;User must be 18 or older&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">actual_report</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">get_validation_report</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">actual_report</span> <span class="o">==</span> <span class="n">expected_report</span>
</code></pre></div>

<p>Now, running pytest shows both tests passing.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v
<span class="o">=========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==========================</span>
...
collected<span class="w"> </span><span class="m">2</span><span class="w"> </span>items

test_validator.py::test_valid_user<span class="w"> </span>PASSED<span class="w">                         </span><span class="o">[</span><span class="w"> </span><span class="m">50</span>%<span class="o">]</span>
test_validator.py::test_underage_user<span class="w"> </span>PASSED<span class="w">                      </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">==========================</span><span class="w"> </span><span class="m">2</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span>...s<span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>This simple exercise demonstrates the power of assertion introspection. Without it, we would have just seen <code>AssertionError</code> and would have had to manually print both dictionaries to find the difference. Pytest saves you that step, accelerating the debug cycle.</p>
<h2 id="custom-assertion-messages">Custom Assertion Messages</h2>
<h2 id="iteration-1-adding-context-with-custom-messages">Iteration 1: Adding Context with Custom Messages</h2>
<p>Pytest's introspection is fantastic for comparing two objects, but sometimes the failure isn't about a difference between <code>a</code> and <code>b</code>. Sometimes, the failure is that a single value isn't what you expect it to be, and the reason <em>why</em> you expect it isn't obvious from the code.</p>
<h3 id="current-limitation">Current Limitation</h3>
<p>Our tests are good at checking the final <code>report</code> dictionary. But what if we wanted to test a property of the validator itself? Let's add a feature to count the number of validation rules.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_validator.py (updated)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserValidator</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">user_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># A list of all validation methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validations</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_age</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_username</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_email</span>
        <span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validation_rule_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_validations</span><span class="p">)</span>

    <span class="c1"># ... (_validate methods are the same) ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Runs all validations and returns True if no errors.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">validation_func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validations</span><span class="p">:</span>
            <span class="n">validation_func</span><span class="p">()</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span>

    <span class="c1"># ... (get_validation_report is the same) ...</span>
</code></pre></div>

<p>Now, let's write a test to ensure we always have exactly three validation rules. This acts as a safeguard against someone accidentally removing a rule.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_validator.py (added test)</span>

<span class="c1"># ... (other tests) ...</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validation_rule_count</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensures the number of validation rules is correct.&quot;&quot;&quot;</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">UserValidator</span><span class="p">({})</span> <span class="c1"># Data doesn&#39;t matter for this test</span>
    <span class="k">assert</span> <span class="n">validator</span><span class="o">.</span><span class="n">validation_rule_count</span> <span class="o">==</span> <span class="mi">3</span>
</code></pre></div>

<p>This test passes. But now, let's simulate a future change where a developer <em>removes</em> a validation rule, causing our safeguard test to fail.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_validator.py (temporarily broken)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserValidator</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">user_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># A developer accidentally removed a validation!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validations</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_age</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_username</span><span class="p">,</span>
            <span class="c1"># self._validate_email is missing!</span>
        <span class="p">]</span>
    <span class="c1"># ... (rest of the class) ...</span>
</code></pre></div>

<h3 id="failure-demonstration">Failure Demonstration</h3>
<p>Let's run pytest now.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v
<span class="o">=========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==========================</span>
...
collected<span class="w"> </span><span class="m">3</span><span class="w"> </span>items

test_validator.py::test_valid_user<span class="w"> </span>PASSED<span class="w">                         </span><span class="o">[</span><span class="w"> </span><span class="m">33</span>%<span class="o">]</span>
test_validator.py::test_underage_user<span class="w"> </span>PASSED<span class="w">                      </span><span class="o">[</span><span class="w"> </span><span class="m">66</span>%<span class="o">]</span>
test_validator.py::test_validation_rule_count<span class="w"> </span>FAILED<span class="w">              </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">===============================</span><span class="w"> </span><span class="nv">FAILURES</span><span class="w"> </span><span class="o">===============================</span>
______________________<span class="w"> </span>test_validation_rule_count<span class="w"> </span>______________________

<span class="w">    </span>def<span class="w"> </span>test_validation_rule_count<span class="o">()</span>:
<span class="w">        </span><span class="s2">&quot;&quot;&quot;Ensures the number of validation rules is correct.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="nv">validator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>UserValidator<span class="o">({})</span><span class="w"> </span><span class="c1"># Data doesn&#39;t matter for this test</span>
&gt;<span class="w">       </span>assert<span class="w"> </span>validator.validation_rule_count<span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">3</span>
E<span class="w">       </span>assert<span class="w"> </span><span class="nv">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">3</span>
E<span class="w">        </span>+<span class="w">  </span>where<span class="w"> </span><span class="nv">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>&lt;user_validator.UserValidator<span class="w"> </span>object<span class="w"> </span>at<span class="w"> </span>0x...&gt;.validation_rule_count

test_validator.py:42:<span class="w"> </span><span class="nv">AssertionError</span>
<span class="o">=======================</span><span class="w"> </span>short<span class="w"> </span><span class="nb">test</span><span class="w"> </span>summary<span class="w"> </span><span class="nv">info</span><span class="w"> </span><span class="o">========================</span>
FAILED<span class="w"> </span>test_validator.py::test_validation_rule_count<span class="w"> </span>-<span class="w"> </span>assert<span class="w"> </span><span class="nv">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">3</span>
<span class="o">=====================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>failed,<span class="w"> </span><span class="m">2</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span>...s<span class="w"> </span><span class="o">=====================</span>
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-failure_1">Diagnostic Analysis: Reading the Failure</h3>
<p><strong>The complete output</strong>: (Shown above)</p>
<p><strong>Let's parse this section by section</strong>:</p>
<ol>
<li>
<p><strong>The summary line</strong>: <code>FAILED test_validator.py::test_validation_rule_count - assert 2 == 3</code></p>
<ul>
<li><strong>What this tells us</strong>: The test failed because an assertion expected <code>3</code> but got <code>2</code>.</li>
</ul>
</li>
<li>
<p><strong>The traceback</strong>:
    <code>python
    &gt;       assert validator.validation_rule_count == 3
    test_validator.py:42: AssertionError</code></p>
<ul>
<li><strong>What this tells us</strong>: The failure is on line 42.</li>
</ul>
</li>
<li>
<p><strong>The assertion introspection</strong>:
    <code>E       assert 2 == 3
    E        +  where 2 = &lt;user_validator.UserValidator object at 0x...&gt;.validation_rule_count</code></p>
<ul>
<li><strong>What this tells us</strong>: Pytest does its best. It shows that the value <code>2</code> came from the property <code>validation_rule_count</code>. This is helpful, but it doesn't explain the <em>business logic</em> behind the number <code>3</code>. Why was <code>3</code> the magic number?</li>
</ul>
</li>
</ol>
<p><strong>Root cause identified</strong>: The number of validation rules has changed from 3 to 2.
<strong>Why the current approach is limited</strong>: The failure message is technically correct but lacks context. A developer seeing <code>assert 2 == 3</code> might not immediately understand the significance.
<strong>What we need</strong>: A way to add a human-readable message to the failure output to explain the <em>intent</em> of the assertion.</p>
<h3 id="technique-custom-assertion-messages">Technique: Custom Assertion Messages</h3>
<p>Python's <code>assert</code> statement has a second, optional argument: a message to display if the assertion fails.</p>
<div class="codehilite"><pre><span></span><code><span class="k">assert</span> <span class="o">&lt;</span><span class="n">condition</span><span class="o">&gt;</span><span class="p">,</span> <span class="s2">&quot;This is the message that will be shown on failure.&quot;</span>
</code></pre></div>

<p>Let's add a descriptive message to our test.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_validator.py (improved test)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_validation_rule_count</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensures the number of validation rules is correct.&quot;&quot;&quot;</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">UserValidator</span><span class="p">({})</span>

    <span class="c1"># BEFORE</span>
    <span class="c1"># assert validator.validation_rule_count == 3</span>

    <span class="c1"># AFTER</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;The number of validation rules has changed. &quot;</span>
        <span class="s2">&quot;If this was intentional, update the test. &quot;</span>
        <span class="s2">&quot;Rules should cover: age, username, email.&quot;</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">validator</span><span class="o">.</span><span class="n">validation_rule_count</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="n">message</span>
</code></pre></div>

<h3 id="verification">Verification</h3>
<p>Now, let's run the test again with our broken <code>UserValidator</code> (that still has only 2 rules).</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v
<span class="o">=========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==========================</span>
...
collected<span class="w"> </span><span class="m">3</span><span class="w"> </span>items

test_validator.py::test_valid_user<span class="w"> </span>PASSED<span class="w">                         </span><span class="o">[</span><span class="w"> </span><span class="m">33</span>%<span class="o">]</span>
test_validator.py::test_underage_user<span class="w"> </span>PASSED<span class="w">                      </span><span class="o">[</span><span class="w"> </span><span class="m">66</span>%<span class="o">]</span>
test_validator.py::test_validation_rule_count<span class="w"> </span>FAILED<span class="w">              </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">===============================</span><span class="w"> </span><span class="nv">FAILURES</span><span class="w"> </span><span class="o">===============================</span>
______________________<span class="w"> </span>test_validation_rule_count<span class="w"> </span>______________________

<span class="w">    </span>def<span class="w"> </span>test_validation_rule_count<span class="o">()</span>:
<span class="w">        </span><span class="s2">&quot;&quot;&quot;Ensures the number of validation rules is correct.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="nv">validator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>UserValidator<span class="o">({})</span>

<span class="w">        </span><span class="nv">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>
<span class="w">            </span><span class="s2">&quot;The number of validation rules has changed. &quot;</span>
<span class="w">            </span><span class="s2">&quot;If this was intentional, update the test. &quot;</span>
<span class="w">            </span><span class="s2">&quot;Rules should cover: age, username, email.&quot;</span>
<span class="w">        </span><span class="o">)</span>
&gt;<span class="w">       </span>assert<span class="w"> </span>validator.validation_rule_count<span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">3</span>,<span class="w"> </span>message
E<span class="w">       </span>AssertionError:<span class="w"> </span>The<span class="w"> </span>number<span class="w"> </span>of<span class="w"> </span>validation<span class="w"> </span>rules<span class="w"> </span>has<span class="w"> </span>changed.<span class="w"> </span>If<span class="w"> </span>this<span class="w"> </span>was<span class="w"> </span>intentional,<span class="w"> </span>update<span class="w"> </span>the<span class="w"> </span>test.<span class="w"> </span>Rules<span class="w"> </span>should<span class="w"> </span>cover:<span class="w"> </span>age,<span class="w"> </span>username,<span class="w"> </span>email.
E<span class="w">       </span>assert<span class="w"> </span><span class="nv">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">3</span>
E<span class="w">        </span>+<span class="w">  </span>where<span class="w"> </span><span class="nv">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>&lt;user_validator.UserValidator<span class="w"> </span>object<span class="w"> </span>at<span class="w"> </span>0x...&gt;.validation_rule_count

test_validator.py:50:<span class="w"> </span><span class="nv">AssertionError</span>
<span class="o">=======================</span><span class="w"> </span>short<span class="w"> </span><span class="nb">test</span><span class="w"> </span>summary<span class="w"> </span><span class="nv">info</span><span class="w"> </span><span class="o">========================</span>
FAILED<span class="w"> </span>test_validator.py::test_validation_rule_count<span class="w"> </span>-<span class="w"> </span>AssertionError:<span class="w"> </span>The...
<span class="o">=====================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>failed,<span class="w"> </span><span class="m">2</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span>...s<span class="w"> </span><span class="o">=====================</span>
</code></pre></div>

<p>Look at that! The custom message is now the first thing you see in the failure report. It immediately tells the developer what the number <code>3</code> means and what they should check. This transforms a simple <code>assert 2 == 3</code> into a rich, actionable piece of feedback.</p>
<p>(Remember to fix the <code>UserValidator</code> class by re-adding <code>_validate_email</code> to the list before proceeding.)</p>
<h2 id="testing-exceptions-with-pytestraises">Testing Exceptions with pytest.raises()</h2>
<h2 id="iteration-2-handling-expected-errors">Iteration 2: Handling Expected Errors</h2>
<p>Our current <code>UserValidator</code> is polite. When it finds invalid data, it adds an error to a dictionary. This is a valid design pattern, but often, invalid input should be treated more severely by raising an exception. This signals a programming error‚Äîthe caller should have sanitized the data <em>before</em> passing it to the object.</p>
<p>Let's refactor our validator. Instead of collecting errors, the <code>_validate_age</code> method will now raise a <code>ValueError</code> if the birthdate format is wrong.</p>
<h3 id="current-limitation_1">Current Limitation</h3>
<p>Our tests are designed to check the state of the <code>errors</code> dictionary. They have no mechanism to handle or expect exceptions.</p>
<h3 id="new-scenario-invalid-date-format">New Scenario: Invalid Date Format</h3>
<p>Let's change <code>_validate_age</code> to be stricter.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_validator.py (refactored)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserValidator</span><span class="p">:</span>
    <span class="c1"># ... (__init__ and other _validate methods are the same for now) ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_age</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;User must be 18 or older. Raises ValueError on bad date format.&quot;&quot;&quot;</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
        <span class="n">birthdate_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;birthdate&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">birthdate_str</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s2">&quot;birthdate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Birthdate is required&quot;</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">birthdate</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">birthdate_str</span><span class="p">)</span>
            <span class="n">age</span> <span class="o">=</span> <span class="n">today</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="n">birthdate</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="p">((</span><span class="n">today</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">today</span><span class="o">.</span><span class="n">day</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">birthdate</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">birthdate</span><span class="o">.</span><span class="n">day</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;User must be 18 or older&quot;</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># This is the new behavior!</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid date format for birthdate: &#39;</span><span class="si">{</span><span class="n">birthdate_str</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># ... (rest of the class) ...</span>
</code></pre></div>

<p>How do we test this? A naive approach might be to write a test that calls the validator with a bad date and see what happens.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_validator.py (added test)</span>

<span class="c1"># ... (other tests) ...</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_date_format_raises_exception</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests that a malformed birthdate string raises a ValueError.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">invalid_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;test_user&quot;</span><span class="p">,</span>
        <span class="s2">&quot;birthdate&quot;</span><span class="p">:</span> <span class="s2">&quot;2000-13-01&quot;</span><span class="p">,</span> <span class="c1"># Invalid month</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;test@example.com&quot;</span>
    <span class="p">}</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">UserValidator</span><span class="p">(</span><span class="n">invalid_data</span><span class="p">)</span>

    <span class="c1"># How do we assert that an exception is raised?</span>
    <span class="c1"># This line will crash the test.</span>
    <span class="n">validator</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>
</code></pre></div>

<h3 id="failure-demonstration_1">Failure Demonstration</h3>
<p>Running this new test results in an <code>ERROR</code>, not a <code>FAIL</code>. This is a crucial distinction. A <code>FAIL</code> means an assertion was proven false. An <code>ERROR</code> means the test itself crashed due to an unhandled exception.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v
<span class="o">=========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==========================</span>
...
collected<span class="w"> </span><span class="m">4</span><span class="w"> </span>items

test_validator.py::test_valid_user<span class="w"> </span>PASSED<span class="w">                         </span><span class="o">[</span><span class="w"> </span><span class="m">25</span>%<span class="o">]</span>
test_validator.py::test_underage_user<span class="w"> </span>PASSED<span class="w">                      </span><span class="o">[</span><span class="w"> </span><span class="m">50</span>%<span class="o">]</span>
test_validator.py::test_validation_rule_count<span class="w"> </span>PASSED<span class="w">              </span><span class="o">[</span><span class="w"> </span><span class="m">75</span>%<span class="o">]</span>
test_validator.py::test_invalid_date_format_raises_exception<span class="w"> </span>ERROR<span class="w"> </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">================================</span><span class="w"> </span><span class="nv">ERRORS</span><span class="w"> </span><span class="o">================================</span>
ERROR<span class="w"> </span>at<span class="w"> </span>setup<span class="w"> </span>of<span class="w"> </span>test_invalid_date_format_raises_exception
...
<span class="w">    </span>def<span class="w"> </span>test_invalid_date_format_raises_exception<span class="o">()</span>:
<span class="w">        </span><span class="c1"># ...</span>
<span class="w">        </span><span class="nv">validator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>UserValidator<span class="o">(</span>invalid_data<span class="o">)</span>

<span class="w">        </span><span class="c1"># This line will crash the test.</span>
&gt;<span class="w">       </span>validator.is_valid<span class="o">()</span>

test_validator.py:59:<span class="w"> </span>
_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>
user_validator.py:22:<span class="w"> </span><span class="k">in</span><span class="w"> </span>is_valid
<span class="w">    </span>validation_func<span class="o">()</span>
user_validator.py:36:<span class="w"> </span><span class="k">in</span><span class="w"> </span>_validate_age
<span class="w">    </span>raise<span class="w"> </span>ValueError<span class="o">(</span>f<span class="s2">&quot;Invalid date format for birthdate: &#39;{birthdate_str}&#39;&quot;</span><span class="o">)</span>
E<span class="w">   </span>ValueError:<span class="w"> </span>Invalid<span class="w"> </span>date<span class="w"> </span>format<span class="w"> </span><span class="k">for</span><span class="w"> </span>birthdate:<span class="w"> </span><span class="s1">&#39;2000-13-01&#39;</span>
<span class="o">=======================</span><span class="w"> </span>short<span class="w"> </span><span class="nb">test</span><span class="w"> </span>summary<span class="w"> </span><span class="nv">info</span><span class="w"> </span><span class="o">========================</span>
ERROR<span class="w"> </span>test_validator.py::test_invalid_date_format_raises_exception
<span class="o">=====================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>error,<span class="w"> </span><span class="m">3</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span>...s<span class="w"> </span><span class="o">======================</span>
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-failure_2">Diagnostic Analysis: Reading the Failure</h3>
<p><strong>The complete output</strong>: (Shown above)</p>
<ol>
<li>
<p><strong>The summary line</strong>: <code>ERROR test_validator.py::test_invalid_date_format_raises_exception</code></p>
<ul>
<li><strong>What this tells us</strong>: The test didn't fail an assertion; it crashed. This is an uncontrolled error.</li>
</ul>
</li>
<li>
<p><strong>The traceback</strong>:
    <code>user_validator.py:36: in _validate_age
        raise ValueError(f"Invalid date format for birthdate: '{birthdate_str}'")
    E   ValueError: Invalid date format for birthdate: '2000-13-01'</code></p>
<ul>
<li><strong>What this tells us</strong>: The traceback clearly shows a <code>ValueError</code> was raised from within our <code>_validate_age</code> method, exactly as we designed. The problem is that our test didn't catch it.</li>
</ul>
</li>
</ol>
<p><strong>Root cause identified</strong>: The test code does not handle the <code>ValueError</code> that the application code correctly raises.
<strong>Why the current approach can't solve this</strong>: A test function, by default, is expected to run to completion without raising exceptions. An unhandled exception is always an error.
<strong>What we need</strong>: A way to tell pytest, "I expect this specific block of code to raise this specific exception. If it does, the test passes. If it doesn't, or if it raises a different exception, the test fails."</p>
<h3 id="technique-the-pytestraises-context-manager">Technique: The <code>pytest.raises</code> Context Manager</h3>
<p>Pytest provides a clean, expressive context manager for this exact purpose: <code>pytest.raises</code>.</p>
<p>You use it like this:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_something_that_raises</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">ExpectedException</span><span class="p">):</span>
        <span class="c1"># Code that is expected to raise ExpectedException</span>
        <span class="n">call_my_function</span><span class="p">()</span>
</code></pre></div>

<p>If <code>call_my_function()</code> raises <code>ExpectedException</code>, the <code>with</code> block catches it, and the test passes. If it raises a different exception or no exception at all, the test fails.</p>
<p>Let's fix our test using this pattern.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_validator.py (fixed with pytest.raises)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="c1"># ... (other imports and tests) ...</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_date_format_raises_exception</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests that a malformed birthdate string raises a ValueError.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">invalid_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;test_user&quot;</span><span class="p">,</span>
        <span class="s2">&quot;birthdate&quot;</span><span class="p">:</span> <span class="s2">&quot;2000-13-01&quot;</span><span class="p">,</span> <span class="c1"># Invalid month</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;test@example.com&quot;</span>
    <span class="p">}</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">UserValidator</span><span class="p">(</span><span class="n">invalid_data</span><span class="p">)</span>

    <span class="c1"># BEFORE: This crashed the test</span>
    <span class="c1"># validator.is_valid()</span>

    <span class="c1"># AFTER: We wrap the call in pytest.raises</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">validator</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>
</code></pre></div>

<h3 id="verification_1">Verification</h3>
<p>Running pytest now shows all tests passing.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v
<span class="o">=========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==========================</span>
...
collected<span class="w"> </span><span class="m">4</span><span class="w"> </span>items

test_validator.py::test_valid_user<span class="w"> </span>PASSED<span class="w">                         </span><span class="o">[</span><span class="w"> </span><span class="m">25</span>%<span class="o">]</span>
test_validator.py::test_underage_user<span class="w"> </span>PASSED<span class="w">                      </span><span class="o">[</span><span class="w"> </span><span class="m">50</span>%<span class="o">]</span>
test_validator.py::test_validation_rule_count<span class="w"> </span>PASSED<span class="w">              </span><span class="o">[</span><span class="w"> </span><span class="m">75</span>%<span class="o">]</span>
test_validator.py::test_invalid_date_format_raises_exception<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">==========================</span><span class="w"> </span><span class="m">4</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span>...s<span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<h3 id="asserting-on-exception-details">Asserting on Exception Details</h3>
<p>Passing is good, but we can be more specific. What if the function raises a <code>ValueError</code> for the wrong reason? The <code>pytest.raises</code> context manager can give you access to the exception object itself.</p>
<p>You can capture it using <code>as excinfo</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_validator.py (enhanced test)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_date_format_raises_exception_with_message</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests that a malformed birthdate string raises a ValueError</span>
<span class="sd">    with a specific error message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bad_date</span> <span class="o">=</span> <span class="s2">&quot;2000-13-01&quot;</span>
    <span class="n">invalid_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;test_user&quot;</span><span class="p">,</span>
        <span class="s2">&quot;birthdate&quot;</span><span class="p">:</span> <span class="n">bad_date</span><span class="p">,</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;test@example.com&quot;</span>
    <span class="p">}</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">UserValidator</span><span class="p">(</span><span class="n">invalid_data</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">excinfo</span><span class="p">:</span>
        <span class="n">validator</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>

    <span class="c1"># excinfo is an ExceptionInfo object</span>
    <span class="c1"># .value is the actual exception instance</span>
    <span class="k">assert</span> <span class="n">bad_date</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">excinfo</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s2">&quot;Invalid date format&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">excinfo</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># A more convenient way is to use the match parameter</span>
    <span class="n">match_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid date format for birthdate: &#39;</span><span class="si">{</span><span class="n">bad_date</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="n">match_str</span><span class="p">):</span>
        <span class="n">validator</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>
</code></pre></div>

<p>The <code>match</code> parameter is particularly useful. It checks the exception's string representation against a regular expression. This makes your test more robust and readable.</p>
<h3 id="common-failure-modes-and-their-signatures">Common Failure Modes and Their Signatures</h3>
<h4 id="symptom-the-expected-exception-was-never-raised">Symptom: The expected exception was never raised.</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">&gt; </span><span class="ge">      with pytest.raises(ValueError):</span>
E       Failed: DID NOT RAISE &lt;class &#39;ValueError&#39;&gt;

test_validator.py:65: Failed
</code></pre></div>

<p><strong>Diagnostic clues</strong>: The output explicitly says <code>DID NOT RAISE</code>.
<strong>Root cause</strong>: The code inside the <code>with</code> block completed without raising the specified exception. This indicates a bug in your application code‚Äîit's not failing when it should.
<strong>Solution</strong>: Debug the application code to find out why the exception isn't being raised under the test conditions.</p>
<h4 id="symptom-a-different-exception-was-raised">Symptom: A different exception was raised.</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">&gt;</span><span class="w">       </span><span class="nv">with</span><span class="w"> </span><span class="nv">pytest</span>.<span class="nv">raises</span><span class="ss">(</span><span class="nv">ValueError</span><span class="ss">)</span>:
<span class="o">&gt;</span><span class="w">           </span><span class="nv">raise</span><span class="w"> </span><span class="nv">TypeError</span><span class="ss">(</span><span class="s2">&quot;Something else went wrong&quot;</span><span class="ss">)</span>
<span class="nv">E</span><span class="w">       </span><span class="nv">TypeError</span>:<span class="w"> </span><span class="nv">Something</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nv">went</span><span class="w"> </span><span class="nv">wrong</span>

...
<span class="nv">During</span><span class="w"> </span><span class="nv">handling</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">above</span><span class="w"> </span><span class="nv">exception</span>,<span class="w"> </span><span class="nv">another</span><span class="w"> </span><span class="nv">exception</span><span class="w"> </span><span class="nv">occurred</span>:
...
<span class="nv">E</span><span class="w">       </span><span class="nv">Failed</span>:<span class="w"> </span><span class="nv">DID</span><span class="w"> </span><span class="nv">NOT</span><span class="w"> </span><span class="nv">RAISE</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">class</span><span class="w"> </span><span class="s1">&#39;ValueError&#39;</span><span class="o">&gt;</span>
</code></pre></div>

<p><strong>Diagnostic clues</strong>: You'll see the traceback for the <em>unexpected</em> exception (<code>TypeError</code> in this case), followed by the <code>Failed: DID NOT RAISE &lt;class 'ValueError'&gt;</code> message.
<strong>Root cause</strong>: The code raised an exception, but not the one you were expecting. This could be a bug in your application or a mistake in your test's expectation.
<strong>Solution</strong>: Analyze the unexpected exception. Is it the correct behavior? If so, update your test to expect <code>TypeError</code>. If not, fix the application code to raise <code>ValueError</code> as intended.</p>
<h2 id="testing-warnings-with-pytestwarns">Testing Warnings with pytest.warns()</h2>
<h2 id="iteration-3-capturing-expected-warnings">Iteration 3: Capturing Expected Warnings</h2>
<p>Exceptions are for errors, but what about conditions that aren't errors yet but might be in the future? Python has a built-in warning system for this, commonly used for deprecation notices.</p>
<p>Let's evolve our <code>UserValidator</code>. Suppose we decide that the <code>username</code> field is being deprecated in favor of using the <code>email</code> as the primary identifier. We want to keep the username validation for now, but we want to warn the user whenever it's being validated.</p>
<h3 id="current-limitation_2">Current Limitation</h3>
<p>Our tests check for return values and exceptions, but they are completely blind to warnings. A test would pass, and the warning would be printed to the console, but it wouldn't be programmatically verified.</p>
<h3 id="new-scenario-deprecated-username-validation">New Scenario: Deprecated Username Validation</h3>
<p>Let's modify <code>_validate_username</code> to issue a <code>DeprecationWarning</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_validator.py (updated)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="c1"># ...</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserValidator</span><span class="p">:</span>
    <span class="c1"># ...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Username cannot be &#39;admin&#39;. Issues a warning.&quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;&#39;username&#39; is a deprecated field.&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span>
        <span class="p">)</span>
        <span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">username</span> <span class="o">==</span> <span class="s2">&quot;admin&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Username cannot be &#39;admin&#39;&quot;</span>
    <span class="c1"># ...</span>
</code></pre></div>

<p>If we run our existing tests, they will pass, but we'll see a <code>DeprecationWarning</code> in the output. This is okay, but it's not a guarantee. We want a test that <em>fails</em> if this warning is <em>not</em> issued.</p>
<h3 id="failure-demonstration_2">Failure Demonstration</h3>
<p>How can we make a test fail if a warning isn't present? A common CI/CD practice is to treat warnings as errors to keep the codebase clean. We can simulate this using the <code>-W error</code> pytest flag.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v<span class="w"> </span>-W<span class="w"> </span><span class="nv">error</span>
<span class="o">=========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==========================</span>
...
collected<span class="w"> </span><span class="m">5</span><span class="w"> </span>items

test_validator.py::test_valid_user<span class="w"> </span>FAILED<span class="w">                         </span><span class="o">[</span><span class="w"> </span><span class="m">20</span>%<span class="o">]</span>
test_validator.py::test_underage_user<span class="w"> </span>FAILED<span class="w">                      </span><span class="o">[</span><span class="w"> </span><span class="m">40</span>%<span class="o">]</span>
test_validator.py::test_validation_rule_count<span class="w"> </span>PASSED<span class="w">              </span><span class="o">[</span><span class="w"> </span><span class="m">60</span>%<span class="o">]</span>
test_validator.py::test_invalid_date_format_raises_exception_with_message<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="m">80</span>%<span class="o">]</span>
test_validator.py::test_invalid_date_format_raises_exception<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">===============================</span><span class="w"> </span><span class="nv">FAILURES</span><span class="w"> </span><span class="o">===============================</span>
____________________________<span class="w"> </span>test_valid_user<span class="w"> </span>___________________________
...
&gt;<span class="w">       </span>validator.is_valid<span class="o">()</span>
E<span class="w">       </span>DeprecationWarning:<span class="w"> </span><span class="s1">&#39;username&#39;</span><span class="w"> </span>is<span class="w"> </span>a<span class="w"> </span>deprecated<span class="w"> </span>field.
...
<span class="o">=======================</span><span class="w"> </span>short<span class="w"> </span><span class="nb">test</span><span class="w"> </span>summary<span class="w"> </span><span class="nv">info</span><span class="w"> </span><span class="o">========================</span>
FAILED<span class="w"> </span>test_validator.py::test_valid_user<span class="w"> </span>-<span class="w"> </span>DeprecationWarning:<span class="w"> </span><span class="s1">&#39;user...</span>
<span class="s1">FAILED test_validator.py::test_underage_user - DeprecationWarning: &#39;</span>u...
<span class="o">=====================</span><span class="w"> </span><span class="m">2</span><span class="w"> </span>failed,<span class="w"> </span><span class="m">3</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span>...s<span class="w"> </span><span class="o">=====================</span>
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-failure_3">Diagnostic Analysis: Reading the Failure</h3>
<p><strong>The complete output</strong>: (Shown above)</p>
<ol>
<li>
<p><strong>The summary line</strong>: <code>FAILED test_validator.py::test_valid_user - DeprecationWarning: ...</code></p>
<ul>
<li><strong>What this tells us</strong>: The test failed because it encountered a <code>DeprecationWarning</code>, which we told pytest to treat as an error.</li>
</ul>
</li>
<li>
<p><strong>The traceback</strong>:
    <code>&gt;       validator.is_valid()
    E       DeprecationWarning: 'username' is a deprecated field.</code></p>
<ul>
<li><strong>What this tells us</strong>: The warning was triggered by the call to <code>validator.is_valid()</code>.</li>
</ul>
</li>
</ol>
<p><strong>Root cause identified</strong>: Our code is correctly issuing a warning, but our tests aren't explicitly handling it. When running in a strict mode (<code>-W error</code>), this unhandled warning becomes a failure.
<strong>Why the current approach can't solve this</strong>: We have no mechanism to declare "this warning is expected and should be ignored for this specific test."
<strong>What we need</strong>: A tool similar to <code>pytest.raises</code> but for warnings.</p>
<h3 id="technique-the-pytestwarns-context-manager">Technique: The <code>pytest.warns</code> Context Manager</h3>
<p>Unsurprisingly, pytest provides <code>pytest.warns</code>, which has an almost identical API to <code>pytest.raises</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_something_that_warns</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">warns</span><span class="p">(</span><span class="n">ExpectedWarning</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;...&quot;</span><span class="p">):</span>
        <span class="c1"># Code that is expected to issue ExpectedWarning</span>
        <span class="n">call_my_function</span><span class="p">()</span>
</code></pre></div>

<p>This block will catch the expected warning, allowing the test to pass (even with <code>-W error</code>), and fail if the warning is not issued.</p>
<p>Let's write a new test specifically for this warning.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_validator.py (added test)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="c1"># ...</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_username_validation_issues_deprecation_warning</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests that validating a user with a username issues a DeprecationWarning.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;test_user&quot;</span><span class="p">,</span>
        <span class="s2">&quot;birthdate&quot;</span><span class="p">:</span> <span class="s2">&quot;2000-01-01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;test@example.com&quot;</span>
    <span class="p">}</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">UserValidator</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">warns</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;&#39;username&#39; is a deprecated field.&quot;</span><span class="p">):</span>
        <span class="n">validator</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>
</code></pre></div>

<h3 id="verification_2">Verification</h3>
<p>Now, when we run pytest, this new test will pass, and importantly, we can update our other tests to ignore this specific warning if needed, though it's often better to have a dedicated test for the warning and ensure other tests use data that doesn't trigger it.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v
<span class="o">=========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==========================</span>
...
collected<span class="w"> </span><span class="m">6</span><span class="w"> </span>items

...
test_validator.py::test_username_validation_issues_deprecation_warning<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">===================</span><span class="w"> </span><span class="m">5</span><span class="w"> </span>passed,<span class="w"> </span><span class="m">1</span><span class="w"> </span>skipped<span class="w"> </span><span class="k">in</span><span class="w"> </span>...s<span class="w"> </span><span class="o">====================</span>
<span class="o">(</span>Note:<span class="w"> </span>Previous<span class="w"> </span>tests<span class="w"> </span>might<span class="w"> </span>show<span class="w"> </span>warnings<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>output<span class="w"> </span><span class="k">if</span><span class="w"> </span>not<span class="w"> </span>run<span class="w"> </span>with<span class="w"> </span>-W<span class="w"> </span>error,<span class="w"> </span>but<span class="w"> </span>the<span class="w"> </span>new<span class="w"> </span><span class="nb">test</span><span class="w"> </span>passes<span class="w"> </span>cleanly<span class="o">)</span>
</code></pre></div>

<h3 id="common-failure-modes-and-their-signatures_1">Common Failure Modes and Their Signatures</h3>
<h4 id="symptom-the-expected-warning-was-not-issued">Symptom: The expected warning was not issued.</h4>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">&gt; </span><span class="ge">      with pytest.warns(DeprecationWarning):</span>
E       Failed: DID NOT WARN.

test_my_code.py:10: Failed
</code></pre></div>

<p><strong>Diagnostic clues</strong>: The output is a very clear <code>DID NOT WARN</code>.
<strong>Root cause</strong>: The code inside the <code>with</code> block completed without issuing any warnings of the specified type.
<strong>Solution</strong>: Debug the application code to see why the <code>warnings.warn()</code> call is not being reached.</p>
<h2 id="context-managers-for-advanced-assertions">Context Managers for Advanced Assertions</h2>
<h2 id="beyond-built-ins-custom-assertion-contexts">Beyond Built-ins: Custom Assertion Contexts</h2>
<p>We've seen how <code>pytest.raises</code> and <code>pytest.warns</code> are powerful tools. They work by wrapping a piece of code in a context manager (<code>with ...:</code>) and asserting something about the <em>behavior</em> of that code block‚Äîdid it raise? did it warn?</p>
<p>This pattern is not limited to pytest's built-in tools. You can create your own assertion context managers to verify complex behaviors that are difficult to check with a simple <code>assert</code> on a return value. This is an advanced technique, but it demonstrates the power and extensibility of Python's testing patterns.</p>
<h3 id="scenario-asserting-on-side-effects">Scenario: Asserting on Side Effects</h3>
<p>Let's imagine our <code>UserValidator</code> has a new requirement: when a user is successfully validated, their email must be added to a "welcome list" in a database.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_validator.py (final version)</span>
<span class="c1"># ... (imports)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MockDB</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A fake database for demonstration purposes.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">welcome_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_to_welcome_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2"> to welcome list.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">welcome_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserValidator</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">MockDB</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">user_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="c1"># ... (rest of __init__)</span>

    <span class="c1"># ... (other methods) ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs all validations. If successful, adds user email to the</span>
<span class="sd">        welcome list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">validation_func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validations</span><span class="p">:</span>
            <span class="n">validation_func</span><span class="p">()</span>

        <span class="n">is_successful</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span>
        <span class="k">if</span> <span class="n">is_successful</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">add_to_welcome_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">is_successful</span>
</code></pre></div>

<p>How do we test this? We could do this:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_validator.py (a simple test for the side effect)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">user_validator</span><span class="w"> </span><span class="kn">import</span> <span class="n">MockDB</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_valid_user_is_added_to_welcome_list</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">MockDB</span><span class="p">()</span>
    <span class="n">valid_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;john_doe&quot;</span><span class="p">,</span>
        <span class="s2">&quot;birthdate&quot;</span><span class="p">:</span> <span class="s2">&quot;2001-05-15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;john.doe@example.com&quot;</span>
    <span class="p">}</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">UserValidator</span><span class="p">(</span><span class="n">valid_data</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

    <span class="n">validator</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>

    <span class="k">assert</span> <span class="s2">&quot;john.doe@example.com&quot;</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">welcome_list</span>
</code></pre></div>

<p>This works, but what if we want to create a more general and expressive assertion? For example, "I assert that executing this block of code adds exactly one user to the welcome list."</p>
<h3 id="technique-creating-a-custom-assertion-context-manager">Technique: Creating a Custom Assertion Context Manager</h3>
<p>We can build our own context manager that checks the state of the database <em>before</em> and <em>after</em> the code block runs.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_validator.py (with a custom context manager)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_validator</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserValidator</span><span class="p">,</span> <span class="n">MockDB</span>

<span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">assert_adds_to_welcome_list</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">MockDB</span><span class="p">,</span> <span class="n">expected_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A context manager to assert that a block of code adds a specific</span>
<span class="sd">    number of users to the welcome list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ARRANGE: Get the state *before* the action</span>
    <span class="n">initial_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">welcome_list</span><span class="p">)</span>

    <span class="c1"># ACT: Yield to let the code inside the &#39;with&#39; block run</span>
    <span class="k">yield</span>

    <span class="c1"># ASSERT: Get the state *after* and compare</span>
    <span class="n">final_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">welcome_list</span><span class="p">)</span>
    <span class="n">added_count</span> <span class="o">=</span> <span class="n">final_count</span> <span class="o">-</span> <span class="n">initial_count</span>

    <span class="k">assert</span> <span class="n">added_count</span> <span class="o">==</span> <span class="n">expected_count</span><span class="p">,</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Expected to add </span><span class="si">{</span><span class="n">expected_count</span><span class="si">}</span><span class="s2"> user(s) to welcome list, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;but added </span><span class="si">{</span><span class="n">added_count</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="p">)</span>

<span class="c1"># New test using the context manager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_valid_user_is_added_to_welcome_list_with_context_manager</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">MockDB</span><span class="p">()</span>
    <span class="n">valid_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;john_doe&quot;</span><span class="p">,</span>
        <span class="s2">&quot;birthdate&quot;</span><span class="p">:</span> <span class="s2">&quot;2001-05-15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;john.doe@example.com&quot;</span>
    <span class="p">}</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">UserValidator</span><span class="p">(</span><span class="n">valid_data</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">assert_adds_to_welcome_list</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">expected_count</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">validator</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>

<span class="c1"># A test for the negative case</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_user_is_not_added_to_welcome_list</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">MockDB</span><span class="p">()</span>
    <span class="n">invalid_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">}</span> <span class="c1"># This will fail validation</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">UserValidator</span><span class="p">(</span><span class="n">invalid_data</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">assert_adds_to_welcome_list</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">expected_count</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">validator</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>
</code></pre></div>

<p>This custom context manager makes the test's intent incredibly clear. It reads like a sentence: "Assert that running <code>validator.is_valid()</code> adds exactly one user to the welcome list."</p>
<p>This pattern is extremely powerful for testing code with side effects, such as database interactions, file system changes, or API calls. It encapsulates the setup and teardown logic for the assertion, keeping the test itself clean and focused on the action. It's the same principle that makes <code>pytest.raises</code> and <code>pytest.warns</code> so effective, applied to your own application's logic.</p>
<h3 id="the-journey-from-problem-to-solution">The Journey: From Problem to Solution</h3>
<table>
<thead>
<tr>
<th>Iteration</th>
<th>Failure Mode</th>
<th>Technique Applied</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Simple assertion on a dictionary failed</td>
<td>Assertion Introspection</td>
<td>Pytest's diff pinpointed the exact string mismatch in our test data.</td>
</tr>
<tr>
<td>1</td>
<td><code>assert 2 == 3</code> lacked context</td>
<td>Custom Assertion Message</td>
<td>The failure report now explains the business logic behind the numbers.</td>
</tr>
<tr>
<td>2</td>
<td>An expected exception crashed the test</td>
<td><code>pytest.raises()</code></td>
<td>The test now correctly expects and catches the <code>ValueError</code>.</td>
</tr>
<tr>
<td>3</td>
<td>An expected warning was unverified</td>
<td><code>pytest.warns()</code></td>
<td>The test now guarantees that a <code>DeprecationWarning</code> is issued.</td>
</tr>
<tr>
<td>4</td>
<td>Asserting on a side-effect was verbose</td>
<td>Custom Context Manager</td>
<td>The test's intent is now declarative and encapsulated.</td>
</tr>
</tbody>
</table>
<h3 id="decision-framework-which-assertion-approach-when">Decision Framework: Which Assertion Approach When?</h3>
<table>
<thead>
<tr>
<th>Assertion Type</th>
<th>Use Case</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>assert a == b</code></td>
<td>Verifying the state or return value of an object. The most common case.</td>
<td><code>assert user.is_active() is True</code></td>
</tr>
<tr>
<td><code>assert a == b, "message"</code></td>
<td>The <code>assert</code> is simple, but the <em>reason</em> for the expected value is not.</td>
<td><code>assert len(items) == 5, "API should return 5 items per page"</code></td>
</tr>
<tr>
<td><code>with pytest.raises(Error):</code></td>
<td>Verifying that a specific block of code <em>must</em> raise an exception.</td>
<td><code>with pytest.raises(KeyError): my_dict["missing"]</code></td>
</tr>
<tr>
<td><code>with pytest.warns(Warning):</code></td>
<td>Verifying that a specific block of code <em>must</em> issue a warning.</td>
<td><code>with pytest.warns(FutureWarning): legacy_function()</code></td>
</tr>
<tr>
<td>Custom Context Manager</td>
<td>Verifying a complex side effect (e.g., DB change, file write, API call).</td>
<td><code>with assert_db_commit(): service.save()</code></td>
</tr>
</tbody>
</table>
<h3 id="lessons-learned">Lessons Learned</h3>
<ul>
<li><strong>Treat every failure as data.</strong> Pytest's output is a rich report, not a simple "pass/fail." Learn to read the traceback, introspection diffs, and summary lines to diagnose problems instantly.</li>
<li><strong>Use the right tool for the job.</strong> Don't write <code>try/except</code> blocks in your tests when <code>pytest.raises</code> exists. Use the framework's idiomatic tools to make your tests clearer and more concise.</li>
<li><strong>Assert on intent.</strong> A good assertion verifies not just <em>what</em> happened, but that it happened for the <em>right reason</em>. Adding custom messages or using <code>pytest.raises</code> with <code>match</code> makes your tests more precise.</li>
<li><strong>Think beyond return values.</strong> Tests should verify behavior and side effects, not just the output of a function. Context managers are the primary pattern for asserting on behavior over time.</li>
</ul>
        </div>
        <div class="footer">
            Generated on 2025-11-24 14:31:15 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>