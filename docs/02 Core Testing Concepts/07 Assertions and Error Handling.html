<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>07 Assertions and Error Handling</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">02 Core Testing Concepts</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-7-assertions-and-error-handling">Chapter 7: Assertions and Error Handling</h1>
<h2 id="beyond-simple-assertions">Beyond Simple Assertions</h2>
<h2 id="the-foundation-what-were-building-on">The Foundation: What We're Building On</h2>
<p>In previous chapters, you've written tests using simple assertions like <code>assert result == expected</code>. These work beautifully for straightforward comparisons, but real-world testing demands more sophisticated assertion strategies. This chapter transforms your understanding of assertions from basic equality checks into a comprehensive toolkit for validating complex behaviors, handling errors gracefully, and writing tests that communicate clearly when they fail.</p>
<p>We'll build our understanding around a realistic scenario: testing a user registration system. This will be our <strong>anchor example</strong> that we'll refine through multiple iterations, each time encountering new challenges that demand more sophisticated assertion techniques.</p>
<h2 id="phase-1-the-reference-implementation">Phase 1: The Reference Implementation</h2>
<p>Let's start with a user registration system that validates email addresses and passwords:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_registration.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RegistrationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base exception for registration failures&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">InvalidEmailError</span><span class="p">(</span><span class="n">RegistrationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when email format is invalid&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">WeakPasswordError</span><span class="p">(</span><span class="n">RegistrationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when password doesn&#39;t meet requirements&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;User(email=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">&#39;, username=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">validate_email</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if email has valid format&quot;&quot;&quot;</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$&#39;</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">email</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">validate_password</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate password strength.</span>
<span class="sd">    Returns (is_valid, error_message)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Password must be at least 8 characters&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Password must contain at least one uppercase letter&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Password must contain at least one digit&quot;</span>
    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">register_user</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">User</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register a new user with validation.</span>
<span class="sd">    Raises appropriate exceptions on validation failure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">validate_email</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">InvalidEmailError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid email format: </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">is_valid</span><span class="p">,</span> <span class="n">error_msg</span> <span class="o">=</span> <span class="n">validate_password</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">WeakPasswordError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
    <span class="c1"># In real system, would save to database here</span>
    <span class="k">return</span> <span class="n">user</span>
</code></pre></div>

<p>Now let's write our initial test suite using simple assertions:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_registration_v1.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_registration</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">register_user</span><span class="p">,</span> 
    <span class="n">User</span><span class="p">,</span>
    <span class="n">InvalidEmailError</span><span class="p">,</span>
    <span class="n">WeakPasswordError</span>
<span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_successful_registration</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that valid credentials create a user&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">register_user</span><span class="p">(</span>
        <span class="n">email</span><span class="o">=</span><span class="s2">&quot;alice@example.com&quot;</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="s2">&quot;SecurePass123&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Simple assertions</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="s2">&quot;alice@example.com&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s2">&quot;alice&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">is_active</span> <span class="o">==</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_email_rejected</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that invalid email raises exception&quot;&quot;&quot;</span>
    <span class="c1"># This will fail - we need better assertion techniques</span>
    <span class="n">register_user</span><span class="p">(</span>
        <span class="n">email</span><span class="o">=</span><span class="s2">&quot;not-an-email&quot;</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;bob&quot;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="s2">&quot;SecurePass123&quot;</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_weak_password_rejected</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that weak password raises exception&quot;&quot;&quot;</span>
    <span class="c1"># This will also fail</span>
    <span class="n">register_user</span><span class="p">(</span>
        <span class="n">email</span><span class="o">=</span><span class="s2">&quot;charlie@example.com&quot;</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;charlie&quot;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="s2">&quot;weak&quot;</span>
    <span class="p">)</span>
</code></pre></div>

<p>Let's run these tests to see what happens:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_registration_v1.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_registration_v1</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_successful_registration</span><span class="w"> </span><span class="n">PASSED</span><span class="w">    </span><span class="o">[</span><span class="n"> 33%</span><span class="o">]</span>
<span class="n">test_registration_v1</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_invalid_email_rejected</span><span class="w"> </span><span class="n">FAILED</span><span class="w">     </span><span class="o">[</span><span class="n"> 66%</span><span class="o">]</span>
<span class="n">test_registration_v1</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_weak_password_rejected</span><span class="w"> </span><span class="n">FAILED</span><span class="w">     </span><span class="o">[</span><span class="n">100%</span><span class="o">]</span>

<span class="o">==============================</span><span class="w"> </span><span class="n">FAILURES</span><span class="w"> </span><span class="o">==============================</span>
<span class="n">_________________</span><span class="w"> </span><span class="n">test_invalid_email_rejected</span><span class="w"> </span><span class="n">________________________</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">test_invalid_email_rejected</span><span class="p">()</span><span class="err">:</span>
<span class="w">        </span><span class="ss">&quot;&quot;&quot;Test that invalid email raises exception&quot;&quot;&quot;</span>
<span class="o">&gt;</span><span class="w">       </span><span class="n">register_user</span><span class="p">(</span>
<span class="w">            </span><span class="n">email</span><span class="o">=</span><span class="ss">&quot;not-an-email&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">username</span><span class="o">=</span><span class="ss">&quot;bob&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">password</span><span class="o">=</span><span class="ss">&quot;SecurePass123&quot;</span>
<span class="w">        </span><span class="p">)</span>
<span class="n">E</span><span class="w">       </span><span class="n">user_registration</span><span class="p">.</span><span class="nl">InvalidEmailError</span><span class="p">:</span><span class="w"> </span><span class="n">Invalid</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="nf">format</span><span class="err">:</span><span class="w"> </span><span class="ow">not</span><span class="o">-</span><span class="n">an</span><span class="o">-</span><span class="n">email</span>

<span class="n">test_registration_v1</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="mi">24</span><span class="err">:</span><span class="w"> </span><span class="n">InvalidEmailError</span>
<span class="n">_________________</span><span class="w"> </span><span class="n">test_weak_password_rejected</span><span class="w"> </span><span class="n">________________________</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">test_weak_password_rejected</span><span class="p">()</span><span class="err">:</span>
<span class="w">        </span><span class="ss">&quot;&quot;&quot;Test that weak password raises exception&quot;&quot;&quot;</span>
<span class="o">&gt;</span><span class="w">       </span><span class="n">register_user</span><span class="p">(</span>
<span class="w">            </span><span class="n">email</span><span class="o">=</span><span class="ss">&quot;charlie@example.com&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">username</span><span class="o">=</span><span class="ss">&quot;charlie&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">password</span><span class="o">=</span><span class="ss">&quot;weak&quot;</span>
<span class="w">        </span><span class="p">)</span>
<span class="n">E</span><span class="w">       </span><span class="n">user_registration</span><span class="p">.</span><span class="nl">WeakPasswordError</span><span class="p">:</span><span class="w"> </span><span class="n">Password</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">least</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">characters</span>

<span class="n">test_registration_v1</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="mi">32</span><span class="err">:</span><span class="w"> </span><span class="n">WeakPasswordError</span>
<span class="o">====================</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">failed</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.12</span><span class="n">s</span><span class="w"> </span><span class="o">=====================</span>
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-failure">Diagnostic Analysis: Reading the Failure</h3>
<p><strong>The complete output shows</strong>:</p>
<ol>
<li><strong>The summary line</strong>: <code>test_invalid_email_rejected FAILED</code></li>
<li>
<p>What this tells us: The test itself failed, not just an assertion</p>
</li>
<li>
<p><strong>The traceback</strong>:</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="o">&gt;</span><span class="w">       </span><span class="n">register_user</span><span class="p">(</span>
<span class="w">            </span><span class="n">email</span><span class="o">=</span><span class="s">&quot;not-an-email&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">username</span><span class="o">=</span><span class="s">&quot;bob&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">password</span><span class="o">=</span><span class="s">&quot;SecurePass123&quot;</span>
<span class="w">        </span><span class="p">)</span>
<span class="n">E</span><span class="w">       </span><span class="n">user_registration</span><span class="p">.</span><span class="nl">InvalidEmailError:</span><span class="w"> </span><span class="n">Invalid</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="nl">format:</span><span class="w"> </span><span class="k">not</span><span class="o">-</span><span class="n">an</span><span class="o">-</span><span class="n">email</span>
</code></pre></div>

<ul>
<li>What this tells us: An exception was raised but not caught</li>
<li>
<p>Key line: The <code>E</code> marker shows the exception propagated out of the test</p>
</li>
<li>
<p><strong>No assertion introspection</strong>:</p>
</li>
<li>What this tells us: We never reached an assertion‚Äîthe exception killed the test first</li>
</ul>
<p><strong>Root cause identified</strong>: We're testing that exceptions <em>should</em> be raised, but we have no mechanism to catch and verify them.</p>
<p><strong>Why the current approach can't solve this</strong>: Simple assertions like <code>assert result == expected</code> only work when code completes successfully. When we <em>expect</em> an exception, we need a way to catch it, verify it's the right type, and optionally inspect its message.</p>
<p><strong>What we need</strong>: A context manager that captures exceptions so we can assert on their properties.</p>
<h2 id="iteration-1-testing-expected-exceptions">Iteration 1: Testing Expected Exceptions</h2>
<p>Our tests are failing because exceptions are propagating uncaught. We need <code>pytest.raises()</code> to capture and verify exceptions:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_registration_v2.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_registration</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">register_user</span><span class="p">,</span>
    <span class="n">User</span><span class="p">,</span>
    <span class="n">InvalidEmailError</span><span class="p">,</span>
    <span class="n">WeakPasswordError</span>
<span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_successful_registration</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that valid credentials create a user&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">register_user</span><span class="p">(</span>
        <span class="n">email</span><span class="o">=</span><span class="s2">&quot;alice@example.com&quot;</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="s2">&quot;SecurePass123&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="s2">&quot;alice@example.com&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s2">&quot;alice&quot;</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">is_active</span> <span class="o">==</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_email_rejected</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that invalid email raises InvalidEmailError&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">InvalidEmailError</span><span class="p">):</span>
        <span class="n">register_user</span><span class="p">(</span>
            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;not-an-email&quot;</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="s2">&quot;bob&quot;</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="s2">&quot;SecurePass123&quot;</span>
        <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_weak_password_rejected</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that weak password raises WeakPasswordError&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">WeakPasswordError</span><span class="p">):</span>
        <span class="n">register_user</span><span class="p">(</span>
            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;charlie@example.com&quot;</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="s2">&quot;charlie&quot;</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="s2">&quot;weak&quot;</span>
        <span class="p">)</span>
</code></pre></div>

<p>Run the updated tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_registration_v2.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mh">3</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_registration_v2</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_successful_registration</span><span class="w"> </span><span class="n">PASSED</span><span class="w">    </span><span class="p">[</span><span class="w"> </span><span class="mh">33</span><span class="o">%</span><span class="p">]</span>
<span class="n">test_registration_v2</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_invalid_email_rejected</span><span class="w"> </span><span class="n">PASSED</span><span class="w">     </span><span class="p">[</span><span class="w"> </span><span class="mh">66</span><span class="o">%</span><span class="p">]</span>
<span class="n">test_registration_v2</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_weak_password_rejected</span><span class="w"> </span><span class="n">PASSED</span><span class="w">     </span><span class="p">[</span><span class="mh">100</span><span class="o">%</span><span class="p">]</span>

<span class="o">=========================</span><span class="w"> </span><span class="mh">3</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="mf">0.08</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p><strong>Expected vs. Actual improvement</strong>: All tests now pass. The <code>pytest.raises()</code> context manager captures the expected exceptions, preventing them from failing the test.</p>
<h3 id="how-pytestraises-works">How pytest.raises() Works</h3>
<p>The <code>pytest.raises()</code> context manager:</p>
<ol>
<li><strong>Enters a protected block</strong>: Code inside the <code>with</code> block is monitored</li>
<li><strong>Expects an exception</strong>: If the specified exception type is raised, it's caught</li>
<li><strong>Validates the exception type</strong>: Only the exact type (or subclasses) pass</li>
<li><strong>Fails if no exception occurs</strong>: If the block completes without raising, the test fails</li>
</ol>
<p>Think of it as an "assertion that an exception happens."</p>
<p><strong>Current limitation</strong>: We're only verifying that <em>some</em> exception of the right type was raised. We're not checking the error message, which means we can't distinguish between different failure scenarios. What if we want to verify that the password error message specifically mentions "8 characters" vs "uppercase letter"?</p>
<h2 id="iteration-2-inspecting-exception-messages">Iteration 2: Inspecting Exception Messages</h2>
<p>Let's add a test that needs to verify the specific error message:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_registration_v3.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_registration</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">register_user</span><span class="p">,</span>
    <span class="n">InvalidEmailError</span><span class="p">,</span>
    <span class="n">WeakPasswordError</span>
<span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_password_too_short_specific_message</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that short password gives specific error message&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">WeakPasswordError</span><span class="p">):</span>
        <span class="n">register_user</span><span class="p">(</span>
            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;dave@example.com&quot;</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="s2">&quot;dave&quot;</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="s2">&quot;Short1&quot;</span>  <span class="c1"># Only 6 characters</span>
        <span class="p">)</span>
    <span class="c1"># How do we check the message says &quot;at least 8 characters&quot;?</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_password_missing_uppercase_specific_message</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that password without uppercase gives specific error&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">WeakPasswordError</span><span class="p">):</span>
        <span class="n">register_user</span><span class="p">(</span>
            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;eve@example.com&quot;</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="s2">&quot;eve&quot;</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="s2">&quot;lowercase123&quot;</span>  <span class="c1"># No uppercase</span>
        <span class="p">)</span>
    <span class="c1"># How do we check the message says &quot;uppercase letter&quot;?</span>
</code></pre></div>

<p>Run these tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_registration_v3.py::test_password_too_short_specific_message<span class="w"> </span>-v
pytest<span class="w"> </span>test_registration_v3.py::test_password_missing_uppercase_specific_message<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mh">1</span><span class="w"> </span><span class="n">item</span>

<span class="n">test_registration_v3</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_password_too_short_specific_message</span><span class="w"> </span><span class="n">PASSED</span><span class="w"> </span><span class="p">[</span><span class="mh">100</span><span class="o">%</span><span class="p">]</span>

<span class="o">=========================</span><span class="w"> </span><span class="mh">1</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="mf">0.05</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>

<span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mh">1</span><span class="w"> </span><span class="n">item</span>

<span class="n">test_registration_v3</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_password_missing_uppercase_specific_message</span><span class="w"> </span><span class="n">PASSED</span><span class="w"> </span><span class="p">[</span><span class="mh">100</span><span class="o">%</span><span class="p">]</span>

<span class="o">=========================</span><span class="w"> </span><span class="mh">1</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="mf">0.05</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<h3 id="diagnostic-analysis-the-hidden-problem">Diagnostic Analysis: The Hidden Problem</h3>
<p><strong>The tests pass, but are they testing enough?</strong></p>
<p>Both tests pass because they verify that <code>WeakPasswordError</code> is raised. But they don't verify <em>which</em> validation rule failed. This is a <strong>false positive</strong>‚Äîthe tests would still pass even if we swapped the error messages.</p>
<p>Let's prove this by introducing a bug:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_registration_buggy.py (modified validate_password)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_password</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate password strength - WITH BUG&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;WRONG MESSAGE&quot;</span>  <span class="c1"># Bug: wrong error message</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;ALSO WRONG&quot;</span>  <span class="c1"># Bug: wrong error message</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Password must contain at least one digit&quot;</span>
    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span>
</code></pre></div>

<p>Run the tests again with the buggy version:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_registration_v3.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mh">2</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_registration_v3</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_password_too_short_specific_message</span><span class="w"> </span><span class="n">PASSED</span><span class="w"> </span><span class="p">[</span><span class="mh">50</span><span class="o">%</span><span class="p">]</span>
<span class="n">test_registration_v3</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_password_missing_uppercase_specific_message</span><span class="w"> </span><span class="n">PASSED</span><span class="w"> </span><span class="p">[</span><span class="mh">100</span><span class="o">%</span><span class="p">]</span>

<span class="o">=========================</span><span class="w"> </span><span class="mh">2</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="mf">0.06</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p><strong>Root cause identified</strong>: Our tests pass even with wrong error messages because we're not inspecting the exception content.</p>
<p><strong>What we need</strong>: Access to the exception object so we can assert on its message.</p>
<h3 id="solution-capturing-the-exception-object">Solution: Capturing the Exception Object</h3>
<p><code>pytest.raises()</code> can capture the exception into a variable using the <code>as</code> keyword:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_registration_v4.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_registration</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">register_user</span><span class="p">,</span>
    <span class="n">WeakPasswordError</span>
<span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_password_too_short_specific_message</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that short password gives specific error message&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">WeakPasswordError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="n">register_user</span><span class="p">(</span>
            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;dave@example.com&quot;</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="s2">&quot;dave&quot;</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="s2">&quot;Short1&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Now we can inspect the exception</span>
    <span class="k">assert</span> <span class="s2">&quot;at least 8 characters&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_password_missing_uppercase_specific_message</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that password without uppercase gives specific error&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">WeakPasswordError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="n">register_user</span><span class="p">(</span>
            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;eve@example.com&quot;</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="s2">&quot;eve&quot;</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="s2">&quot;lowercase123&quot;</span>
        <span class="p">)</span>

    <span class="k">assert</span> <span class="s2">&quot;uppercase letter&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_password_missing_digit_specific_message</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that password without digit gives specific error&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">WeakPasswordError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="n">register_user</span><span class="p">(</span>
            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;frank@example.com&quot;</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="s2">&quot;frank&quot;</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="s2">&quot;NoDigitsHere&quot;</span>
        <span class="p">)</span>

    <span class="k">assert</span> <span class="s2">&quot;at least one digit&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>

<p>Run with the correct implementation:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_registration_v4.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mh">3</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_registration_v4</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_password_too_short_specific_message</span><span class="w"> </span><span class="n">PASSED</span><span class="w"> </span><span class="p">[</span><span class="mh">33</span><span class="o">%</span><span class="p">]</span>
<span class="n">test_registration_v4</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_password_missing_uppercase_specific_message</span><span class="w"> </span><span class="n">PASSED</span><span class="w"> </span><span class="p">[</span><span class="mh">66</span><span class="o">%</span><span class="p">]</span>
<span class="n">test_registration_v4</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_password_missing_digit_specific_message</span><span class="w"> </span><span class="n">PASSED</span><span class="w"> </span><span class="p">[</span><span class="mh">100</span><span class="o">%</span><span class="p">]</span>

<span class="o">=========================</span><span class="w"> </span><span class="mh">3</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="mf">0.07</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p>Now run with the buggy implementation:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_registration_v4.py<span class="w"> </span>-v<span class="w">  </span><span class="c1"># Using buggy version</span>
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_registration_v4</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_password_too_short_specific_message</span><span class="w"> </span><span class="n">FAILED</span><span class="w"> </span><span class="o">[</span><span class="n">33%</span><span class="o">]</span>
<span class="n">test_registration_v4</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_password_missing_uppercase_specific_message</span><span class="w"> </span><span class="n">FAILED</span><span class="w"> </span><span class="o">[</span><span class="n">66%</span><span class="o">]</span>
<span class="n">test_registration_v4</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_password_missing_digit_specific_message</span><span class="w"> </span><span class="n">PASSED</span><span class="w"> </span><span class="o">[</span><span class="n">100%</span><span class="o">]</span>

<span class="o">==============================</span><span class="w"> </span><span class="n">FAILURES</span><span class="w"> </span><span class="o">==============================</span>
<span class="n">_____________</span><span class="w"> </span><span class="n">test_password_too_short_specific_message</span><span class="w"> </span><span class="n">_______________</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">test_password_too_short_specific_message</span><span class="p">()</span><span class="err">:</span>
<span class="w">        </span><span class="k">with</span><span class="w"> </span><span class="n">pytest</span><span class="p">.</span><span class="n">raises</span><span class="p">(</span><span class="n">WeakPasswordError</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nl">exc_info</span><span class="p">:</span>
<span class="w">            </span><span class="n">register_user</span><span class="p">(</span>
<span class="w">                </span><span class="n">email</span><span class="o">=</span><span class="ss">&quot;dave@example.com&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">username</span><span class="o">=</span><span class="ss">&quot;dave&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">password</span><span class="o">=</span><span class="ss">&quot;Short1&quot;</span>
<span class="w">            </span><span class="p">)</span>

<span class="o">&gt;</span><span class="w">       </span><span class="n">assert</span><span class="w"> </span><span class="ss">&quot;at least 8 characters&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="n">exc_info</span><span class="p">.</span><span class="k">value</span><span class="p">)</span>
<span class="n">E</span><span class="w">       </span><span class="nl">AssertionError</span><span class="p">:</span><span class="w"> </span><span class="n">assert</span><span class="w"> </span><span class="s1">&#39;at least 8 characters&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="s1">&#39;WRONG MESSAGE&#39;</span>
<span class="n">E</span><span class="w">        </span><span class="o">+</span><span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="s1">&#39;WRONG MESSAGE&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="n">WeakPasswordError</span><span class="p">(</span><span class="s1">&#39;WRONG MESSAGE&#39;</span><span class="p">))</span>

<span class="n">test_registration_v4</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="mi">16</span><span class="err">:</span><span class="w"> </span><span class="n">AssertionError</span>
<span class="n">____________</span><span class="w"> </span><span class="n">test_password_missing_uppercase_specific_message</span><span class="w"> </span><span class="n">________</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">test_password_missing_uppercase_specific_message</span><span class="p">()</span><span class="err">:</span>
<span class="w">        </span><span class="k">with</span><span class="w"> </span><span class="n">pytest</span><span class="p">.</span><span class="n">raises</span><span class="p">(</span><span class="n">WeakPasswordError</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nl">exc_info</span><span class="p">:</span>
<span class="w">            </span><span class="n">register_user</span><span class="p">(</span>
<span class="w">                </span><span class="n">email</span><span class="o">=</span><span class="ss">&quot;eve@example.com&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">username</span><span class="o">=</span><span class="ss">&quot;eve&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">password</span><span class="o">=</span><span class="ss">&quot;lowercase123&quot;</span>
<span class="w">            </span><span class="p">)</span>

<span class="o">&gt;</span><span class="w">       </span><span class="n">assert</span><span class="w"> </span><span class="ss">&quot;uppercase letter&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="n">exc_info</span><span class="p">.</span><span class="k">value</span><span class="p">)</span>
<span class="n">E</span><span class="w">       </span><span class="nl">AssertionError</span><span class="p">:</span><span class="w"> </span><span class="n">assert</span><span class="w"> </span><span class="s1">&#39;uppercase letter&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="s1">&#39;ALSO WRONG&#39;</span>
<span class="n">E</span><span class="w">        </span><span class="o">+</span><span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="s1">&#39;ALSO WRONG&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="n">WeakPasswordError</span><span class="p">(</span><span class="s1">&#39;ALSO WRONG&#39;</span><span class="p">))</span>

<span class="n">test_registration_v4</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="mi">27</span><span class="err">:</span><span class="w"> </span><span class="n">AssertionError</span>
<span class="o">====================</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">failed</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.11</span><span class="n">s</span><span class="w"> </span><span class="o">=====================</span>
</code></pre></div>

<p><strong>Expected vs. Actual improvement</strong>: Now our tests correctly fail when error messages are wrong. The <code>exc_info.value</code> gives us access to the actual exception object, and we can assert on its string representation.</p>
<h3 id="understanding-exceptioninfo">Understanding ExceptionInfo</h3>
<p>When you use <code>with pytest.raises(ExceptionType) as exc_info:</code>, the <code>exc_info</code> object has several useful attributes:</p>
<ul>
<li><code>exc_info.value</code>: The actual exception instance</li>
<li><code>exc_info.type</code>: The exception class</li>
<li><code>exc_info.traceback</code>: The traceback object</li>
</ul>
<p>Most commonly, you'll use <code>exc_info.value</code> to access the exception message.</p>
<p><strong>Current limitation</strong>: We're using substring matching (<code>in str(exc_info.value)</code>), which is flexible but imprecise. What if we want exact message matching? Or regex patterns? Or to verify exception attributes beyond the message?</p>
<h2 id="assertion-introspection-reading-failure-messages">Assertion Introspection: Reading Failure Messages</h2>
<h2 id="the-power-of-pytests-assertion-rewriting">The Power of Pytest's Assertion Rewriting</h2>
<p>Before we continue refining our exception testing, let's understand one of pytest's most powerful features: <strong>assertion introspection</strong>. This is the magic that makes pytest's failure messages so informative.</p>
<p>When you write <code>assert x == y</code>, pytest doesn't just evaluate the boolean result. It rewrites your assertion at import time to capture intermediate values, allowing it to show you <em>exactly</em> what went wrong.</p>
<h2 id="iteration-3-complex-object-comparisons">Iteration 3: Complex Object Comparisons</h2>
<p>Let's extend our user registration system to return more complex data:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_registration_extended.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserProfile</span><span class="p">:</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">roles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">is_active</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_user_profile</span><span class="p">(</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">roles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UserProfile</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a complete user profile&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">UserProfile</span><span class="p">(</span>
        <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
        <span class="n">full_name</span><span class="o">=</span><span class="n">full_name</span><span class="p">,</span>
        <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
        <span class="n">roles</span><span class="o">=</span><span class="n">roles</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">],</span>
        <span class="n">is_active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;registration&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">}</span>
    <span class="p">)</span>
</code></pre></div>

<p>Now let's write a test with a deliberate mistake to see assertion introspection in action:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_profile_v1.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_registration_extended</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_user_profile</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_user_profile_creation</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that user profile is created with correct attributes&quot;&quot;&quot;</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">create_user_profile</span><span class="p">(</span>
        <span class="n">email</span><span class="o">=</span><span class="s2">&quot;alice@example.com&quot;</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span>
        <span class="n">full_name</span><span class="o">=</span><span class="s2">&quot;Alice Anderson&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Deliberate mistake: wrong username</span>
    <span class="n">expected_username</span> <span class="o">=</span> <span class="s2">&quot;alicia&quot;</span>  <span class="c1"># Bug: should be &quot;alice&quot;</span>
    <span class="k">assert</span> <span class="n">profile</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">expected_username</span>
</code></pre></div>

<p>Run the test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_profile_v1.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">item</span>

<span class="n">test_profile_v1</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_user_profile_creation</span><span class="w"> </span><span class="n">FAILED</span><span class="w">           </span><span class="o">[</span><span class="n">100%</span><span class="o">]</span>

<span class="o">==============================</span><span class="w"> </span><span class="n">FAILURES</span><span class="w"> </span><span class="o">==============================</span>
<span class="n">_________________</span><span class="w"> </span><span class="n">test_user_profile_creation</span><span class="w"> </span><span class="n">_________________________</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">test_user_profile_creation</span><span class="p">()</span><span class="err">:</span>
<span class="w">        </span><span class="n">profile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_user_profile</span><span class="p">(</span>
<span class="w">            </span><span class="n">email</span><span class="o">=</span><span class="ss">&quot;alice@example.com&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">username</span><span class="o">=</span><span class="ss">&quot;alice&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">full_name</span><span class="o">=</span><span class="ss">&quot;Alice Anderson&quot;</span>
<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="n">expected_username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;alicia&quot;</span>
<span class="o">&gt;</span><span class="w">       </span><span class="n">assert</span><span class="w"> </span><span class="n">profile</span><span class="p">.</span><span class="n">username</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">expected_username</span>
<span class="n">E</span><span class="w">       </span><span class="nl">AssertionError</span><span class="p">:</span><span class="w"> </span><span class="n">assert</span><span class="w"> </span><span class="s1">&#39;alice&#39;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;alicia&#39;</span>
<span class="n">E</span><span class="w">         </span><span class="o">-</span><span class="w"> </span><span class="n">alicia</span>
<span class="n">E</span><span class="w">         </span><span class="o">+</span><span class="w"> </span><span class="n">alice</span>

<span class="n">test_profile_v1</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="mi">13</span><span class="err">:</span><span class="w"> </span><span class="n">AssertionError</span>
<span class="o">=========================</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.09</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<h3 id="diagnostic-analysis-understanding-introspection">Diagnostic Analysis: Understanding Introspection</h3>
<p><strong>The assertion introspection shows</strong>:</p>
<ol>
<li><strong>The assertion line</strong>: <code>assert profile.username == expected_username</code></li>
<li>
<p>What this tells us: The exact comparison that failed</p>
</li>
<li>
<p><strong>The evaluated values</strong>: <code>assert 'alice' == 'alicia'</code></p>
</li>
<li>What this tells us: Pytest evaluated both sides and shows the actual values</li>
<li>
<p>Key insight: We see both <code>profile.username</code> (evaluated to <code>'alice'</code>) and <code>expected_username</code> (evaluated to <code>'alicia'</code>)</p>
</li>
<li>
<p><strong>The diff visualization</strong>:</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code>E       - alicia
E       + alice
</code></pre></div>

<ul>
<li>What this tells us: The <code>-</code> line shows what was expected, <code>+</code> shows what was actual</li>
<li>This is a unified diff format, familiar from version control</li>
</ul>
<p><strong>Root cause identified</strong>: The expected value is wrong in our test.</p>
<p><strong>Why this matters</strong>: Without introspection, we'd only see <code>AssertionError</code> with no context. Pytest's rewriting gives us the full picture.</p>
<h2 id="comparing-complex-objects">Comparing Complex Objects</h2>
<p>Let's test a more complex scenario where we compare entire objects:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_profile_v2.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_registration_extended</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_user_profile</span><span class="p">,</span> <span class="n">UserProfile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_user_profile_complete_comparison</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test complete profile structure&quot;&quot;&quot;</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">create_user_profile</span><span class="p">(</span>
        <span class="n">email</span><span class="o">=</span><span class="s2">&quot;bob@example.com&quot;</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;bob&quot;</span><span class="p">,</span>
        <span class="n">full_name</span><span class="o">=</span><span class="s2">&quot;Bob Builder&quot;</span><span class="p">,</span>
        <span class="n">roles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Create expected profile with deliberate mistakes</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="n">UserProfile</span><span class="p">(</span>
        <span class="n">email</span><span class="o">=</span><span class="s2">&quot;bob@example.com&quot;</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;bob&quot;</span><span class="p">,</span>
        <span class="n">full_name</span><span class="o">=</span><span class="s2">&quot;Bob Builder&quot;</span><span class="p">,</span>
        <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Wrong: won&#39;t match actual</span>
        <span class="n">roles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;moderator&quot;</span><span class="p">],</span>  <span class="c1"># Wrong: should be &quot;admin&quot;</span>
        <span class="n">is_active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Wrong: should be False</span>
        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;registration&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">profile</span> <span class="o">==</span> <span class="n">expected</span>
</code></pre></div>

<p>Run the test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_profile_v2.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">item</span>

<span class="n">test_profile_v2</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_user_profile_complete_comparison</span><span class="w"> </span><span class="n">FAILED</span><span class="w"> </span><span class="o">[</span><span class="n">100%</span><span class="o">]</span>

<span class="o">==============================</span><span class="w"> </span><span class="n">FAILURES</span><span class="w"> </span><span class="o">==============================</span>
<span class="n">__________</span><span class="w"> </span><span class="n">test_user_profile_complete_comparison</span><span class="w"> </span><span class="n">_____________________</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">test_user_profile_complete_comparison</span><span class="p">()</span><span class="err">:</span>
<span class="w">        </span><span class="n">profile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_user_profile</span><span class="p">(</span>
<span class="w">            </span><span class="n">email</span><span class="o">=</span><span class="ss">&quot;bob@example.com&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">username</span><span class="o">=</span><span class="ss">&quot;bob&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">full_name</span><span class="o">=</span><span class="ss">&quot;Bob Builder&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">roles</span><span class="o">=[</span><span class="n">&quot;user&quot;, &quot;admin&quot;</span><span class="o">]</span>
<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserProfile</span><span class="p">(</span>
<span class="w">            </span><span class="n">email</span><span class="o">=</span><span class="ss">&quot;bob@example.com&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">username</span><span class="o">=</span><span class="ss">&quot;bob&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">full_name</span><span class="o">=</span><span class="ss">&quot;Bob Builder&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">created_at</span><span class="o">=</span><span class="nc">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">            </span><span class="n">roles</span><span class="o">=[</span><span class="n">&quot;user&quot;, &quot;moderator&quot;</span><span class="o">]</span><span class="p">,</span>
<span class="w">            </span><span class="n">is_active</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
<span class="w">            </span><span class="n">metadata</span><span class="o">=</span><span class="err">{</span><span class="ss">&quot;source&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;registration&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;version&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;1.0&quot;</span><span class="err">}</span>
<span class="w">        </span><span class="p">)</span>

<span class="o">&gt;</span><span class="w">       </span><span class="n">assert</span><span class="w"> </span><span class="n">profile</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">expected</span>
<span class="n">E</span><span class="w">       </span><span class="nl">AssertionError</span><span class="p">:</span><span class="w"> </span><span class="n">assert</span><span class="w"> </span><span class="n">UserProfile</span><span class="p">(</span><span class="n">em</span><span class="p">...</span><span class="n">version</span><span class="s1">&#39;: &#39;</span><span class="mf">1.0</span><span class="s1">&#39;}) == UserProfile(em...version&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;1.0&#39;</span><span class="err">}</span><span class="p">)</span>
<span class="n">E</span><span class="w">         </span>
<span class="n">E</span><span class="w">         </span><span class="n">Omitting</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">identical</span><span class="w"> </span><span class="n">items</span><span class="p">,</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="o">-</span><span class="n">vv</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">show</span>
<span class="n">E</span><span class="w">         </span><span class="n">Differing</span><span class="w"> </span><span class="nl">attributes</span><span class="p">:</span>
<span class="n">E</span><span class="w">         </span><span class="o">[</span><span class="n">&#39;created_at&#39;, &#39;is_active&#39;, &#39;roles&#39;</span><span class="o">]</span>

<span class="n">test_profile_v2</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="mi">24</span><span class="err">:</span><span class="w"> </span><span class="n">AssertionError</span>
<span class="o">=========================</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.10</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<h3 id="diagnostic-analysis-dataclass-comparison">Diagnostic Analysis: Dataclass Comparison</h3>
<p><strong>The introspection shows</strong>:</p>
<ol>
<li><strong>Omitted identical items</strong>: Pytest recognizes that some fields match and focuses on differences</li>
<li><strong>Differing attributes</strong>: Lists exactly which fields don't match: <code>created_at</code>, <code>is_active</code>, <code>roles</code></li>
</ol>
<p>But we want more detail. Let's use pytest's verbose mode:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_profile_v2.py<span class="w"> </span>-vv
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">item</span>

<span class="n">test_profile_v2</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_user_profile_complete_comparison</span><span class="w"> </span><span class="n">FAILED</span><span class="w"> </span><span class="o">[</span><span class="n">100%</span><span class="o">]</span>

<span class="o">==============================</span><span class="w"> </span><span class="n">FAILURES</span><span class="w"> </span><span class="o">==============================</span>
<span class="n">__________</span><span class="w"> </span><span class="n">test_user_profile_complete_comparison</span><span class="w"> </span><span class="n">_____________________</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">test_user_profile_complete_comparison</span><span class="p">()</span><span class="err">:</span>
<span class="w">        </span><span class="n">profile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_user_profile</span><span class="p">(</span>
<span class="w">            </span><span class="n">email</span><span class="o">=</span><span class="ss">&quot;bob@example.com&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">username</span><span class="o">=</span><span class="ss">&quot;bob&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">full_name</span><span class="o">=</span><span class="ss">&quot;Bob Builder&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">roles</span><span class="o">=[</span><span class="n">&quot;user&quot;, &quot;admin&quot;</span><span class="o">]</span>
<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserProfile</span><span class="p">(</span>
<span class="w">            </span><span class="n">email</span><span class="o">=</span><span class="ss">&quot;bob@example.com&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">username</span><span class="o">=</span><span class="ss">&quot;bob&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">full_name</span><span class="o">=</span><span class="ss">&quot;Bob Builder&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">created_at</span><span class="o">=</span><span class="nc">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">            </span><span class="n">roles</span><span class="o">=[</span><span class="n">&quot;user&quot;, &quot;moderator&quot;</span><span class="o">]</span><span class="p">,</span>
<span class="w">            </span><span class="n">is_active</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
<span class="w">            </span><span class="n">metadata</span><span class="o">=</span><span class="err">{</span><span class="ss">&quot;source&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;registration&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;version&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;1.0&quot;</span><span class="err">}</span>
<span class="w">        </span><span class="p">)</span>

<span class="o">&gt;</span><span class="w">       </span><span class="n">assert</span><span class="w"> </span><span class="n">profile</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">expected</span>
<span class="n">E</span><span class="w">       </span><span class="nl">AssertionError</span><span class="p">:</span><span class="w"> </span><span class="n">assert</span><span class="w"> </span><span class="n">UserProfile</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s1">&#39;bob@example.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">full_name</span><span class="o">=</span><span class="s1">&#39;Bob Builder&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">created_at</span><span class="o">=</span><span class="nc">datetime</span><span class="p">.</span><span class="nc">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="mi">123456</span><span class="p">),</span><span class="w"> </span><span class="n">roles</span><span class="o">=[</span><span class="n">&#39;user&#39;, &#39;admin&#39;</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">is_active</span><span class="o">=</span><span class="k">False</span><span class="p">,</span><span class="w"> </span><span class="n">metadata</span><span class="o">=</span><span class="err">{</span><span class="s1">&#39;source&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;registration&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;version&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;1.0&#39;</span><span class="err">}</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UserProfile</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s1">&#39;bob@example.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">full_name</span><span class="o">=</span><span class="s1">&#39;Bob Builder&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">created_at</span><span class="o">=</span><span class="nc">datetime</span><span class="p">.</span><span class="nc">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">roles</span><span class="o">=[</span><span class="n">&#39;user&#39;, &#39;moderator&#39;</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">is_active</span><span class="o">=</span><span class="k">True</span><span class="p">,</span><span class="w"> </span><span class="n">metadata</span><span class="o">=</span><span class="err">{</span><span class="s1">&#39;source&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;registration&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;version&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;1.0&#39;</span><span class="err">}</span><span class="p">)</span>
<span class="n">E</span><span class="w">         </span>
<span class="n">E</span><span class="w">         </span><span class="n">Matching</span><span class="w"> </span><span class="nl">attributes</span><span class="p">:</span>
<span class="n">E</span><span class="w">         </span><span class="o">[</span><span class="n">&#39;email&#39;, &#39;full_name&#39;, &#39;metadata&#39;, &#39;username&#39;</span><span class="o">]</span>
<span class="n">E</span><span class="w">         </span><span class="n">Differing</span><span class="w"> </span><span class="nl">attributes</span><span class="p">:</span>
<span class="n">E</span><span class="w">         </span><span class="o">[</span><span class="n">&#39;created_at&#39;, &#39;is_active&#39;, &#39;roles&#39;</span><span class="o">]</span>
<span class="n">E</span><span class="w">         </span>
<span class="n">E</span><span class="w">         </span><span class="n">Drill</span><span class="w"> </span><span class="n">down</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">differing</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="nl">created_at</span><span class="p">:</span>
<span class="n">E</span><span class="w">           </span><span class="nl">created_at</span><span class="p">:</span><span class="w"> </span><span class="nc">datetime</span><span class="p">.</span><span class="nc">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="mi">123456</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nc">datetime</span><span class="p">.</span><span class="nc">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="n">E</span><span class="w">         </span>
<span class="n">E</span><span class="w">         </span><span class="n">Drill</span><span class="w"> </span><span class="n">down</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">differing</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="nl">is_active</span><span class="p">:</span>
<span class="n">E</span><span class="w">           </span><span class="nl">is_active</span><span class="p">:</span><span class="w"> </span><span class="k">False</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">True</span>
<span class="n">E</span><span class="w">         </span>
<span class="n">E</span><span class="w">         </span><span class="n">Drill</span><span class="w"> </span><span class="n">down</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">differing</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="nl">roles</span><span class="p">:</span>
<span class="n">E</span><span class="w">           </span><span class="nl">roles</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">&#39;user&#39;, &#39;admin&#39;</span><span class="o">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">[</span><span class="n">&#39;user&#39;, &#39;moderator&#39;</span><span class="o">]</span>

<span class="n">test_profile_v2</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="mi">24</span><span class="err">:</span><span class="w"> </span><span class="n">AssertionError</span>
<span class="o">=========================</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.11</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p><strong>Expected vs. Actual improvement</strong>: With <code>-vv</code>, pytest shows:
- Full object representations
- Which attributes match
- Which attributes differ
- Detailed drill-down into each differing attribute</p>
<p>This level of detail makes debugging complex object comparisons trivial.</p>
<h2 id="iteration-4-collection-comparisons">Iteration 4: Collection Comparisons</h2>
<p>Let's test list and dictionary comparisons to see how introspection handles collections:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_collections.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_list_comparison</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test list comparison with differences&quot;&quot;&quot;</span>
    <span class="n">actual_roles</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;moderator&quot;</span><span class="p">]</span>
    <span class="n">expected_roles</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;editor&quot;</span><span class="p">,</span> <span class="s2">&quot;moderator&quot;</span><span class="p">]</span>

    <span class="k">assert</span> <span class="n">actual_roles</span> <span class="o">==</span> <span class="n">expected_roles</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_dict_comparison</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test dictionary comparison with differences&quot;&quot;&quot;</span>
    <span class="n">actual_metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;registration&quot;</span><span class="p">,</span>
        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;2fa&quot;</span><span class="p">],</span>
        <span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;api_calls&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}</span>
    <span class="p">}</span>

    <span class="n">expected_metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;registration&quot;</span><span class="p">,</span>
        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>  <span class="c1"># Different</span>
        <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;sso&quot;</span><span class="p">],</span>  <span class="c1"># Different</span>
        <span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;api_calls&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}</span>
    <span class="p">}</span>

    <span class="k">assert</span> <span class="n">actual_metadata</span> <span class="o">==</span> <span class="n">expected_metadata</span>
</code></pre></div>

<p>Run the tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_collections.py<span class="w"> </span>-vv
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mh">2</span><span class="w"> </span><span class="n">items</span>

<span class="n">test_collections</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_list_comparison</span><span class="w"> </span><span class="n">FAILED</span><span class="w">                </span><span class="p">[</span><span class="mh">50</span><span class="o">%</span><span class="p">]</span>
<span class="n">test_collections</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_dict_comparison</span><span class="w"> </span><span class="n">FAILED</span><span class="w">                </span><span class="p">[</span><span class="mh">100</span><span class="o">%</span><span class="p">]</span>

<span class="o">==============================</span><span class="w"> </span><span class="n">FAILURES</span><span class="w"> </span><span class="o">==============================</span>
<span class="n">______________________</span><span class="w"> </span><span class="n">test_list_comparison</span><span class="w"> </span><span class="n">__________________________</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">test_list_comparison</span><span class="p">()</span><span class="o">:</span>
<span class="w">        </span><span class="n">actual_roles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;admin&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;moderator&quot;</span><span class="p">]</span>
<span class="w">        </span><span class="n">expected_roles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;editor&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;moderator&quot;</span><span class="p">]</span>

<span class="o">&gt;</span><span class="w">       </span><span class="n">assert</span><span class="w"> </span><span class="n">actual_roles</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">expected_roles</span>
<span class="n">E</span><span class="w">       </span><span class="nl">AssertionError:</span><span class="w"> </span><span class="n">assert</span><span class="w"> </span><span class="p">[&#39;</span><span class="n">user</span><span class="p">&#39;,</span><span class="w"> </span><span class="p">&#39;</span><span class="n">admin</span><span class="p">&#39;,</span><span class="w"> </span><span class="p">&#39;</span><span class="n">moderator</span><span class="p">&#39;]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[&#39;</span><span class="n">user</span><span class="p">&#39;,</span><span class="w"> </span><span class="p">&#39;</span><span class="n">editor</span><span class="p">&#39;,</span><span class="w"> </span><span class="p">&#39;</span><span class="n">moderator</span><span class="p">&#39;]</span>
<span class="n">E</span><span class="w">         </span><span class="n">At</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="mh">1</span><span class="w"> </span><span class="nl">diff:</span><span class="w"> </span><span class="p">&#39;</span><span class="n">admin</span><span class="p">&#39;</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">&#39;</span><span class="n">editor</span><span class="p">&#39;</span>
<span class="n">E</span><span class="w">         </span><span class="n">Use</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">diff</span>

<span class="n">test_collections</span><span class="p">.</span><span class="nl">py:</span><span class="mh">5</span><span class="o">:</span><span class="w"> </span><span class="n">AssertionError</span>
<span class="n">______________________</span><span class="w"> </span><span class="n">test_dict_comparison</span><span class="w"> </span><span class="n">__________________________</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">test_dict_comparison</span><span class="p">()</span><span class="o">:</span>
<span class="w">        </span><span class="n">actual_metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s">&quot;source&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;registration&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;version&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;1.0&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;features&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;email&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;2fa&quot;</span><span class="p">],</span>
<span class="w">            </span><span class="s">&quot;limits&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;api_calls&quot;</span><span class="o">:</span><span class="w"> </span><span class="mh">1000</span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">expected_metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s">&quot;source&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;registration&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;version&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;2.0&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;features&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;email&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sso&quot;</span><span class="p">],</span>
<span class="w">            </span><span class="s">&quot;limits&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;api_calls&quot;</span><span class="o">:</span><span class="w"> </span><span class="mh">1000</span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="o">&gt;</span><span class="w">       </span><span class="n">assert</span><span class="w"> </span><span class="n">actual_metadata</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">expected_metadata</span>
<span class="n">E</span><span class="w">       </span><span class="nl">AssertionError:</span><span class="w"> </span><span class="n">assert</span><span class="w"> </span><span class="p">{&#39;</span><span class="n">features</span><span class="p">&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[...],</span><span class="w"> </span><span class="p">...}</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">{&#39;</span><span class="n">features</span><span class="p">&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[...],</span><span class="w"> </span><span class="p">...}</span>
<span class="n">E</span><span class="w">         </span>
<span class="n">E</span><span class="w">         </span><span class="n">Omitting</span><span class="w"> </span><span class="mh">2</span><span class="w"> </span><span class="n">identical</span><span class="w"> </span><span class="n">items</span><span class="p">,</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="o">-</span><span class="n">vv</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">show</span>
<span class="n">E</span><span class="w">         </span><span class="n">Differing</span><span class="w"> </span><span class="nl">items:</span>
<span class="n">E</span><span class="w">         </span><span class="p">{&#39;</span><span class="n">version</span><span class="p">&#39;</span><span class="o">:</span><span class="w"> </span><span class="m">&#39;1</span><span class="mf">.0</span><span class="p">&#39;}</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">{&#39;</span><span class="n">version</span><span class="p">&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">&#39;</span><span class="mf">2.0</span><span class="p">&#39;}</span>
<span class="n">E</span><span class="w">         </span><span class="p">{&#39;</span><span class="n">features</span><span class="p">&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[&#39;</span><span class="n">email</span><span class="p">&#39;,</span><span class="w"> </span><span class="p">&#39;</span><span class="mf">2f</span><span class="n">a</span><span class="p">&#39;]}</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">{&#39;</span><span class="n">features</span><span class="p">&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[&#39;</span><span class="n">email</span><span class="p">&#39;,</span><span class="w"> </span><span class="p">&#39;</span><span class="n">sso</span><span class="p">&#39;]}</span>

<span class="n">test_collections</span><span class="p">.</span><span class="nl">py:</span><span class="mh">20</span><span class="o">:</span><span class="w"> </span><span class="n">AssertionError</span>
<span class="o">=========================</span><span class="w"> </span><span class="mh">1</span><span class="w"> </span><span class="n">failed</span><span class="p">,</span><span class="w"> </span><span class="mh">1</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="mf">0.12</span><span class="n">s</span><span class="w"> </span><span class="o">=====================</span>
</code></pre></div>

<h3 id="diagnostic-analysis-collection-introspection">Diagnostic Analysis: Collection Introspection</h3>
<p><strong>For lists</strong>:
- Pytest identifies the exact index where differences occur: <code>At index 1 diff: 'admin' != 'editor'</code>
- This pinpoints the problem immediately</p>
<p><strong>For dictionaries</strong>:
- Pytest shows which keys have matching values (omitted for brevity)
- Pytest shows which keys have differing values with both sides of the comparison
- Nested structures are handled intelligently</p>
<p><strong>Key insight</strong>: Pytest's introspection adapts to the data structure being compared, providing context-appropriate failure messages.</p>
<h2 id="when-introspection-isnt-enough">When Introspection Isn't Enough</h2>
<p>Sometimes you need more control over comparison logic. Let's see a case where simple equality fails:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_floating_point.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_calculation_result</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test a calculation that produces floating point results&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">+</span> <span class="mf">0.2</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="mf">0.3</span>

    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">expected</span>
</code></pre></div>

<p>Run the test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_floating_point.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 1 item

test_floating_point.py::test_calculation_result FAILED          [100%]

============================== FAILURES ==============================
__________________ test_calculation_result ___________________________

    def test_calculation_result():
        result = 0.1 + 0.2
        expected = 0.3

<span class="k">&gt; </span><span class="ge">      assert result == expected</span>
E       AssertionError: assert 0.30000000000000004 == 0.3

test_floating_point.py:5: AssertionError
========================= 1 failed in 0.06s ==========================
</code></pre></div>

<h3 id="diagnostic-analysis-floating-point-precision">Diagnostic Analysis: Floating Point Precision</h3>
<p><strong>The introspection reveals</strong>:
- <code>0.1 + 0.2</code> evaluates to <code>0.30000000000000004</code>, not <code>0.3</code>
- This is a fundamental limitation of binary floating point representation</p>
<p><strong>Root cause identified</strong>: We need approximate comparison, not exact equality.</p>
<p><strong>What we need</strong>: A way to assert "close enough" rather than "exactly equal."</p>
<p>This is where we move beyond simple assertions to more sophisticated comparison strategies, which we'll cover in Section 7.3.</p>
<h2 id="summary-reading-pytests-failure-messages">Summary: Reading Pytest's Failure Messages</h2>
<p>When a test fails, pytest provides a structured narrative:</p>
<ol>
<li><strong>Test location</strong>: Which file and function failed</li>
<li><strong>Assertion line</strong>: The exact line of code that failed</li>
<li><strong>Evaluated values</strong>: What each side of the comparison actually was</li>
<li><strong>Diff visualization</strong>: How the values differ (for strings, lists, dicts, objects)</li>
<li><strong>Context</strong>: Surrounding code for understanding the failure</li>
</ol>
<p><strong>How to read a failure systematically</strong>:</p>
<ol>
<li>Start with the summary line to identify which test failed</li>
<li>Look at the assertion line to see what was being compared</li>
<li>Read the evaluated values to understand what actually happened</li>
<li>Study the diff to pinpoint exact differences</li>
<li>Trace back through the code to understand why the values differ</li>
</ol>
<p>This systematic approach transforms debugging from guesswork into methodical problem-solving.</p>
<h2 id="custom-assertion-messages">Custom Assertion Messages</h2>
<h2 id="when-default-messages-arent-enough">When Default Messages Aren't Enough</h2>
<p>Pytest's introspection is powerful, but sometimes you need to add domain-specific context to make failures immediately understandable. This is especially true when:</p>
<ul>
<li>The assertion logic is complex</li>
<li>The failure could have multiple causes</li>
<li>You want to guide the developer toward the fix</li>
<li>The values being compared need interpretation</li>
</ul>
<h2 id="iteration-5-adding-context-to-assertions">Iteration 5: Adding Context to Assertions</h2>
<p>Let's return to our user registration system and add a feature that requires custom messages:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_validation.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="k">def</span><span class="w"> </span><span class="nf">check_username_availability</span><span class="p">(</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">existing_usernames</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if username is available and meets requirements.</span>
<span class="sd">    Returns (is_available, reason)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;too_short&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;too_long&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span><span class="o">.</span><span class="n">isalnum</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;invalid_characters&quot;</span>
    <span class="k">if</span> <span class="n">username</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">existing_usernames</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;already_taken&quot;</span>
    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;available&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">validate_user_registration</span><span class="p">(</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">existing_usernames</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate complete registration.</span>
<span class="sd">    Returns (is_valid, list_of_errors)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Email validation</span>
    <span class="k">if</span> <span class="s2">&quot;@&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">email</span> <span class="ow">or</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">email</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;invalid_email&quot;</span><span class="p">)</span>

    <span class="c1"># Username validation</span>
    <span class="n">is_available</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">check_username_availability</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">existing_usernames</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_available</span><span class="p">:</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;username_</span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Password validation</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;password_too_short&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">password</span><span class="p">):</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;password_no_uppercase&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">password</span><span class="p">):</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;password_no_digit&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">errors</span>
</code></pre></div>

<p>Now let's write tests without custom messages first:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_validation_v1.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_validation</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_user_registration</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_valid_registration</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that valid data passes all checks&quot;&quot;&quot;</span>
    <span class="n">is_valid</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">validate_user_registration</span><span class="p">(</span>
        <span class="n">email</span><span class="o">=</span><span class="s2">&quot;alice@example.com&quot;</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="s2">&quot;SecurePass123&quot;</span><span class="p">,</span>
        <span class="n">existing_usernames</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;bob&quot;</span><span class="p">,</span> <span class="s2">&quot;charlie&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">is_valid</span>
    <span class="k">assert</span> <span class="n">errors</span> <span class="o">==</span> <span class="p">[]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_multiple_validation_errors</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that multiple errors are caught&quot;&quot;&quot;</span>
    <span class="n">is_valid</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">validate_user_registration</span><span class="p">(</span>
        <span class="n">email</span><span class="o">=</span><span class="s2">&quot;not-an-email&quot;</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;ab&quot;</span><span class="p">,</span>  <span class="c1"># Too short</span>
        <span class="n">password</span><span class="o">=</span><span class="s2">&quot;weak&quot;</span><span class="p">,</span>  <span class="c1"># Too short, no uppercase, no digit</span>
        <span class="n">existing_usernames</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="n">is_valid</span>
    <span class="c1"># This assertion will fail - let&#39;s see the default message</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>  <span class="c1"># Wrong: should be 4</span>
</code></pre></div>

<p>Run the test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_validation_v1.py::test_multiple_validation_errors<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mh">1</span><span class="w"> </span><span class="n">item</span>

<span class="n">test_validation_v1</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_multiple_validation_errors</span><span class="w"> </span><span class="n">FAILED</span><span class="w">   </span><span class="p">[</span><span class="mh">100</span><span class="o">%</span><span class="p">]</span>

<span class="o">==============================</span><span class="w"> </span><span class="n">FAILURES</span><span class="w"> </span><span class="o">==============================</span>
<span class="n">_____________</span><span class="w"> </span><span class="n">test_multiple_validation_errors</span><span class="w"> </span><span class="n">________________________</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">test_multiple_validation_errors</span><span class="p">()</span><span class="o">:</span>
<span class="w">        </span><span class="n">is_valid</span><span class="p">,</span><span class="w"> </span><span class="n">errors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">validate_user_registration</span><span class="p">(</span>
<span class="w">            </span><span class="n">email</span><span class="o">=</span><span class="s">&quot;not-an-email&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">username</span><span class="o">=</span><span class="s">&quot;ab&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">password</span><span class="o">=</span><span class="s">&quot;weak&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">existing_usernames</span><span class="o">=</span><span class="p">[]</span>
<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="n">assert</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">is_valid</span>
<span class="o">&gt;</span><span class="w">       </span><span class="n">assert</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">3</span>
<span class="n">E</span><span class="w">       </span><span class="nl">AssertionError:</span><span class="w"> </span><span class="n">assert</span><span class="w"> </span><span class="mh">5</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">3</span>
<span class="n">E</span><span class="w">        </span><span class="o">+</span><span class="w">  </span><span class="n">where</span><span class="w"> </span><span class="mh">5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len</span><span class="p">([&#39;</span><span class="n">invalid_email</span><span class="p">&#39;,</span><span class="w"> </span><span class="p">&#39;</span><span class="n">username_too_short</span><span class="p">&#39;,</span><span class="w"> </span><span class="p">&#39;</span><span class="n">password_too_short</span><span class="p">&#39;,</span><span class="w"> </span><span class="p">&#39;</span><span class="n">password_no_uppercase</span><span class="p">&#39;,</span><span class="w"> </span><span class="p">&#39;</span><span class="n">password_no_digit</span><span class="p">&#39;])</span>

<span class="n">test_validation_v1</span><span class="p">.</span><span class="nl">py:</span><span class="mh">20</span><span class="o">:</span><span class="w"> </span><span class="n">AssertionError</span>
<span class="o">=========================</span><span class="w"> </span><span class="mh">1</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="mf">0.08</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<h3 id="diagnostic-analysis-when-introspection-needs-help">Diagnostic Analysis: When Introspection Needs Help</h3>
<p><strong>The introspection shows</strong>:
- <code>len(errors) == 5</code>, not <code>3</code>
- The actual errors list: <code>['invalid_email', 'username_too_short', 'password_too_short', 'password_no_uppercase', 'password_no_digit']</code></p>
<p><strong>The problem</strong>: While we can see the error list, we have to mentally parse it to understand what went wrong. The assertion doesn't explain <em>why</em> we expected 3 errors or <em>which</em> errors we were expecting.</p>
<p><strong>What we need</strong>: A custom message that explains the expectation and helps debug the failure.</p>
<h2 id="adding-custom-messages-with-the-second-argument">Adding Custom Messages with the Second Argument</h2>
<p>Python's <code>assert</code> statement accepts an optional second argument‚Äîa message to display on failure:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_validation_v2.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_validation</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_user_registration</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_multiple_validation_errors_with_message</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that multiple errors are caught - with custom message&quot;&quot;&quot;</span>
    <span class="n">is_valid</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">validate_user_registration</span><span class="p">(</span>
        <span class="n">email</span><span class="o">=</span><span class="s2">&quot;not-an-email&quot;</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&quot;ab&quot;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="s2">&quot;weak&quot;</span><span class="p">,</span>
        <span class="n">existing_usernames</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="n">is_valid</span>

    <span class="n">expected_errors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;invalid_email&quot;</span><span class="p">,</span>
        <span class="s2">&quot;username_too_short&quot;</span><span class="p">,</span>
        <span class="s2">&quot;password_too_short&quot;</span>
    <span class="p">}</span>
    <span class="n">actual_errors</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">actual_errors</span> <span class="o">==</span> <span class="n">expected_errors</span><span class="p">,</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Expected exactly these errors: </span><span class="si">{</span><span class="n">expected_errors</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;But got: </span><span class="si">{</span><span class="n">actual_errors</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Missing: </span><span class="si">{</span><span class="n">expected_errors</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">actual_errors</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Extra: </span><span class="si">{</span><span class="n">actual_errors</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">expected_errors</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
</code></pre></div>

<p>Run the test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_validation_v2.py::test_multiple_validation_errors_with_message<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mh">1</span><span class="w"> </span><span class="n">item</span>

<span class="n">test_validation_v2</span><span class="p">.</span><span class="n">py</span><span class="o">::</span><span class="n">test_multiple_validation_errors_with_message</span><span class="w"> </span><span class="n">FAILED</span><span class="w"> </span><span class="p">[</span><span class="mh">100</span><span class="o">%</span><span class="p">]</span>

<span class="o">==============================</span><span class="w"> </span><span class="n">FAILURES</span><span class="w"> </span><span class="o">==============================</span>
<span class="n">______</span><span class="w"> </span><span class="n">test_multiple_validation_errors_with_message</span><span class="w"> </span><span class="n">__________________</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">test_multiple_validation_errors_with_message</span><span class="p">()</span><span class="o">:</span>
<span class="w">        </span><span class="n">is_valid</span><span class="p">,</span><span class="w"> </span><span class="n">errors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">validate_user_registration</span><span class="p">(</span>
<span class="w">            </span><span class="n">email</span><span class="o">=</span><span class="s">&quot;not-an-email&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">username</span><span class="o">=</span><span class="s">&quot;ab&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">password</span><span class="o">=</span><span class="s">&quot;weak&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">existing_usernames</span><span class="o">=</span><span class="p">[]</span>
<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="n">assert</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">is_valid</span>

<span class="w">        </span><span class="n">expected_errors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s">&quot;invalid_email&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;username_too_short&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;password_too_short&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">actual_errors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">set</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

<span class="o">&gt;</span><span class="w">       </span><span class="n">assert</span><span class="w"> </span><span class="n">actual_errors</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">expected_errors</span><span class="p">,</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="n">f</span><span class="s">&quot;Expected exactly these errors: {expected_errors}</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">            </span><span class="n">f</span><span class="s">&quot;But got: {actual_errors}</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">            </span><span class="n">f</span><span class="s">&quot;Missing: {expected_errors - actual_errors}</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">            </span><span class="n">f</span><span class="s">&quot;Extra: {actual_errors - expected_errors}&quot;</span>
<span class="w">        </span><span class="p">)</span>
<span class="n">E</span><span class="w">       </span><span class="nl">AssertionError:</span><span class="w"> </span><span class="n">Expected</span><span class="w"> </span><span class="n">exactly</span><span class="w"> </span><span class="n">these</span><span class="w"> </span><span class="nl">errors:</span><span class="w"> </span><span class="p">{&#39;</span><span class="n">username_too_short</span><span class="p">&#39;,</span><span class="w"> </span><span class="p">&#39;</span><span class="n">password_too_short</span><span class="p">&#39;,</span><span class="w"> </span><span class="p">&#39;</span><span class="n">invalid_email</span><span class="p">&#39;}</span>
<span class="n">E</span><span class="w">       </span><span class="n">But</span><span class="w"> </span><span class="nl">got:</span><span class="w"> </span><span class="p">{&#39;</span><span class="n">password_no_digit</span><span class="p">&#39;,</span><span class="w"> </span><span class="p">&#39;</span><span class="n">username_too_short</span><span class="p">&#39;,</span><span class="w"> </span><span class="p">&#39;</span><span class="n">password_too_short</span><span class="p">&#39;,</span><span class="w"> </span><span class="p">&#39;</span><span class="n">password_no_uppercase</span><span class="p">&#39;,</span><span class="w"> </span><span class="p">&#39;</span><span class="n">invalid_email</span><span class="p">&#39;}</span>
<span class="n">E</span><span class="w">       </span><span class="nl">Missing:</span><span class="w"> </span><span class="n">set</span><span class="p">()</span>
<span class="n">E</span><span class="w">       </span><span class="nl">Extra:</span><span class="w"> </span><span class="p">{&#39;</span><span class="n">password_no_digit</span><span class="p">&#39;,</span><span class="w"> </span><span class="p">&#39;</span><span class="n">password_no_uppercase</span><span class="p">&#39;}</span>
<span class="n">E</span><span class="w">       </span>
<span class="n">E</span><span class="w">       </span><span class="n">assert</span><span class="w"> </span><span class="p">{&#39;</span><span class="n">invalid_emai</span><span class="p">...</span><span class="n">o_uppercase</span><span class="p">&#39;}</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">{&#39;</span><span class="n">invalid_emai</span><span class="p">...</span><span class="n">sword_too_short</span><span class="p">&#39;}</span>
<span class="n">E</span><span class="w">         </span><span class="n">Extra</span><span class="w"> </span><span class="n">items</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="nl">set:</span>
<span class="n">E</span><span class="w">         </span><span class="p">&#39;</span><span class="n">password_no_digit</span><span class="p">&#39;</span>
<span class="n">E</span><span class="w">         </span><span class="p">&#39;</span><span class="n">password_no_uppercase</span><span class="p">&#39;</span>

<span class="n">test_validation_v2</span><span class="p">.</span><span class="nl">py:</span><span class="mh">18</span><span class="o">:</span><span class="w"> </span><span class="n">AssertionError</span>
<span class="o">=========================</span><span class="w"> </span><span class="mh">1</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="mf">0.09</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p><strong>Expected vs. Actual improvement</strong>: Now the failure message immediately tells us:
- What we expected
- What we got
- What's missing (none in this case)
- What's extra (<code>password_no_digit</code>, <code>password_no_uppercase</code>)</p>
<p>This makes the problem obvious: we forgot to account for the additional password validation rules.</p>
<h2 id="iteration-6-contextual-messages-for-complex-logic">Iteration 6: Contextual Messages for Complex Logic</h2>
<p>Let's test a more complex scenario where custom messages provide essential context:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_permissions.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Set</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Permission</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">READ</span> <span class="o">=</span> <span class="s2">&quot;read&quot;</span>
    <span class="n">WRITE</span> <span class="o">=</span> <span class="s2">&quot;write&quot;</span>
    <span class="n">DELETE</span> <span class="o">=</span> <span class="s2">&quot;delete&quot;</span>
    <span class="n">ADMIN</span> <span class="o">=</span> <span class="s2">&quot;admin&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Role</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">permissions</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Permission</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">permissions</span> <span class="o">=</span> <span class="n">permissions</span>

<span class="k">def</span><span class="w"> </span><span class="nf">check_user_can_perform_action</span><span class="p">(</span>
    <span class="n">user_roles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Role</span><span class="p">],</span>
    <span class="n">required_permission</span><span class="p">:</span> <span class="n">Permission</span><span class="p">,</span>
    <span class="n">resource_owner</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if user can perform action.</span>
<span class="sd">    Returns (can_perform, reason)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Collect all permissions from all roles</span>
    <span class="n">user_permissions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">user_roles</span><span class="p">:</span>
        <span class="n">user_permissions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">role</span><span class="o">.</span><span class="n">permissions</span><span class="p">)</span>

    <span class="c1"># Admin can do anything</span>
    <span class="k">if</span> <span class="n">Permission</span><span class="o">.</span><span class="n">ADMIN</span> <span class="ow">in</span> <span class="n">user_permissions</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;admin_override&quot;</span>

    <span class="c1"># Owner can do anything to their own resources</span>
    <span class="k">if</span> <span class="n">resource_owner</span> <span class="o">==</span> <span class="n">current_user</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;owner_privilege&quot;</span>

    <span class="c1"># Check if user has required permission</span>
    <span class="k">if</span> <span class="n">required_permission</span> <span class="ow">in</span> <span class="n">user_permissions</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;has_permission&quot;</span>

    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;insufficient_permissions&quot;</span>
</code></pre></div>

<p>Now let's write tests with detailed custom messages:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_permissions.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">user_permissions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Permission</span><span class="p">,</span>
    <span class="n">Role</span><span class="p">,</span>
    <span class="n">check_user_can_perform_action</span>
<span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_admin_can_delete_any_resource</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that admin role grants delete permission on any resource&quot;&quot;&quot;</span>
    <span class="n">admin_role</span> <span class="o">=</span> <span class="n">Role</span><span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">Permission</span><span class="o">.</span><span class="n">ADMIN</span><span class="p">})</span>

    <span class="n">can_perform</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">check_user_can_perform_action</span><span class="p">(</span>
        <span class="n">user_roles</span><span class="o">=</span><span class="p">[</span><span class="n">admin_role</span><span class="p">],</span>
        <span class="n">required_permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span>
        <span class="n">resource_owner</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span>
        <span class="n">current_user</span><span class="o">=</span><span class="s2">&quot;bob&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">can_perform</span><span class="p">,</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Admin should be able to delete any resource, but got: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;User roles: </span><span class="si">{</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">admin_role</span><span class="p">]]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Required permission: </span><span class="si">{</span><span class="n">Permission</span><span class="o">.</span><span class="n">DELETE</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Resource owner: alice, Current user: bob&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">reason</span> <span class="o">==</span> <span class="s2">&quot;admin_override&quot;</span><span class="p">,</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Expected reason &#39;admin_override&#39; for admin action, got: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_user_cannot_delete_others_resources</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that regular user cannot delete others&#39; resources&quot;&quot;&quot;</span>
    <span class="n">reader_role</span> <span class="o">=</span> <span class="n">Role</span><span class="p">(</span><span class="s2">&quot;reader&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">Permission</span><span class="o">.</span><span class="n">READ</span><span class="p">})</span>

    <span class="n">can_perform</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">check_user_can_perform_action</span><span class="p">(</span>
        <span class="n">user_roles</span><span class="o">=</span><span class="p">[</span><span class="n">reader_role</span><span class="p">],</span>
        <span class="n">required_permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span>
        <span class="n">resource_owner</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span>
        <span class="n">current_user</span><span class="o">=</span><span class="s2">&quot;bob&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="n">can_perform</span><span class="p">,</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;User without delete permission should not be able to delete, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;but got can_perform=</span><span class="si">{</span><span class="n">can_perform</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;User roles: </span><span class="si">{</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">reader_role</span><span class="p">]]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;User permissions: </span><span class="si">{</span><span class="n">reader_role</span><span class="o">.</span><span class="n">permissions</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Required permission: </span><span class="si">{</span><span class="n">Permission</span><span class="o">.</span><span class="n">DELETE</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Resource owner: alice, Current user: bob&quot;</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_owner_can_delete_own_resource</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that resource owner can delete their own resource&quot;&quot;&quot;</span>
    <span class="n">reader_role</span> <span class="o">=</span> <span class="n">Role</span><span class="p">(</span><span class="s2">&quot;reader&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">Permission</span><span class="o">.</span><span class="n">READ</span><span class="p">})</span>

    <span class="n">can_perform</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">check_user_can_perform_action</span><span class="p">(</span>
        <span class="n">user_roles</span><span class="o">=</span><span class="p">[</span><span class="n">reader_role</span><span class="p">],</span>
        <span class="n">required_permission</span><span class="o">=</span><span class="n">Permission</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span>
        <span class="n">resource_owner</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span>
        <span class="n">current_user</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span>  <span class="c1"># Same user</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">can_perform</span><span class="p">,</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Resource owner should be able to delete their own resource</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;User roles: </span><span class="si">{</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">reader_role</span><span class="p">]]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;User permissions: </span><span class="si">{</span><span class="n">reader_role</span><span class="o">.</span><span class="n">permissions</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Required permission: </span><span class="si">{</span><span class="n">Permission</span><span class="o">.</span><span class="n">DELETE</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Resource owner: alice, Current user: alice</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Got reason: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">reason</span> <span class="o">==</span> <span class="s2">&quot;owner_privilege&quot;</span><span class="p">,</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Expected reason &#39;owner_privilege&#39; for owner action, got: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
</code></pre></div>

<p>Run the tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_permissions.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 3 items

test_permissions.py::test_admin_can_delete_any_resource PASSED  [33%]
test_permissions.py::test_user_cannot_delete_others_resources PASSED [66%]
test_permissions.py::test_owner_can_delete_own_resource PASSED  [100%]

========================= 3 passed in 0.08s ==========================
</code></pre></div>

<p>Now let's introduce a bug to see the custom messages in action:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># user_permissions_buggy.py (modified check function)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">check_user_can_perform_action</span><span class="p">(</span>
    <span class="n">user_roles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Role</span><span class="p">],</span>
    <span class="n">required_permission</span><span class="p">:</span> <span class="n">Permission</span><span class="p">,</span>
    <span class="n">resource_owner</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if user can perform action - WITH BUG&quot;&quot;&quot;</span>
    <span class="n">user_permissions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">user_roles</span><span class="p">:</span>
        <span class="n">user_permissions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">role</span><span class="o">.</span><span class="n">permissions</span><span class="p">)</span>

    <span class="c1"># BUG: Removed admin override check</span>

    <span class="c1"># Owner can do anything to their own resources</span>
    <span class="k">if</span> <span class="n">resource_owner</span> <span class="o">==</span> <span class="n">current_user</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;owner_privilege&quot;</span>

    <span class="k">if</span> <span class="n">required_permission</span> <span class="ow">in</span> <span class="n">user_permissions</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;has_permission&quot;</span>

    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;insufficient_permissions&quot;</span>
</code></pre></div>

<p>Run the tests with the buggy version:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_permissions.py::test_admin_can_delete_any_resource<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">=========================</span>
<span class="n">collected</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">item</span>

<span class="n">test_permissions</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_admin_can_delete_any_resource</span><span class="w"> </span><span class="n">FAILED</span><span class="w">  </span><span class="o">[</span><span class="n">100%</span><span class="o">]</span>

<span class="o">==============================</span><span class="w"> </span><span class="n">FAILURES</span><span class="w"> </span><span class="o">==============================</span>
<span class="n">____________</span><span class="w"> </span><span class="n">test_admin_can_delete_any_resource</span><span class="w"> </span><span class="n">______________________</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">test_admin_can_delete_any_resource</span><span class="p">()</span><span class="err">:</span>
<span class="w">        </span><span class="n">admin_role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">Role</span><span class="p">(</span><span class="ss">&quot;admin&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">{</span><span class="n">Permission</span><span class="p">.</span><span class="k">ADMIN</span><span class="err">}</span><span class="p">)</span>

<span class="w">        </span><span class="n">can_perform</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">check_user_can_perform_action</span><span class="p">(</span>
<span class="w">            </span><span class="n">user_roles</span><span class="o">=[</span><span class="n">admin_role</span><span class="o">]</span><span class="p">,</span>
<span class="w">            </span><span class="n">required_permission</span><span class="o">=</span><span class="n">Permission</span><span class="p">.</span><span class="k">DELETE</span><span class="p">,</span>
<span class="w">            </span><span class="n">resource_owner</span><span class="o">=</span><span class="ss">&quot;alice&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nf">current_user</span><span class="o">=</span><span class="ss">&quot;bob&quot;</span>
<span class="w">        </span><span class="p">)</span>

<span class="o">&gt;</span><span class="w">       </span><span class="n">assert</span><span class="w"> </span><span class="n">can_perform</span><span class="p">,</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="n">f</span><span class="ss">&quot;Admin should be able to delete any resource, but got: {reason}\n&quot;</span>
<span class="w">            </span><span class="n">f</span><span class="ss">&quot;User roles: {[r.name for r in [admin_role]]}\n&quot;</span>
<span class="w">            </span><span class="n">f</span><span class="ss">&quot;Required permission: {Permission.DELETE}\n&quot;</span>
<span class="w">            </span><span class="n">f</span><span class="ss">&quot;Resource owner: alice, Current user: bob&quot;</span>
<span class="w">        </span><span class="p">)</span>
<span class="n">E</span><span class="w">       </span><span class="nl">AssertionError</span><span class="p">:</span><span class="w"> </span><span class="k">Admin</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">able</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">delete</span><span class="w"> </span><span class="ow">any</span><span class="w"> </span><span class="n">resource</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="nl">got</span><span class="p">:</span><span class="w"> </span><span class="n">insufficient_permissions</span>
<span class="n">E</span><span class="w">       </span><span class="k">User</span><span class="w"> </span><span class="nl">roles</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">&#39;admin&#39;</span><span class="o">]</span>
<span class="n">E</span><span class="w">       </span><span class="k">User</span><span class="w"> </span><span class="nl">roles</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">&#39;admin&#39;</span><span class="o">]</span>
<span class="n">E</span><span class="w">       </span><span class="n">Required</span><span class="w"> </span><span class="nl">permission</span><span class="p">:</span><span class="w"> </span><span class="n">Permission</span><span class="p">.</span><span class="k">DELETE</span>
<span class="n">E</span><span class="w">       </span><span class="n">Resource</span><span class="w"> </span><span class="nl">owner</span><span class="p">:</span><span class="w"> </span><span class="n">alice</span><span class="p">,</span><span class="w"> </span><span class="k">Current</span><span class="w"> </span><span class="k">user</span><span class="err">:</span><span class="w"> </span><span class="n">bob</span>
<span class="n">E</span><span class="w">       </span><span class="n">assert</span><span class="w"> </span><span class="k">False</span>

<span class="n">test_permissions</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="mi">18</span><span class="err">:</span><span class="w"> </span><span class="n">AssertionError</span>
<span class="o">=========================</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.09</span><span class="n">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p><strong>Expected vs. Actual improvement</strong>: The custom message immediately tells us:
- What should have happened: "Admin should be able to delete any resource"
- What actually happened: "got: insufficient_permissions"
- All relevant context: user roles, required permission, resource owner, current user</p>
<p>Without the custom message, we'd only see <code>assert False</code>, which provides no context.</p>
<h2 id="best-practices-for-custom-messages">Best Practices for Custom Messages</h2>
<h3 id="1-include-relevant-context">1. Include Relevant Context</h3>
<p>Always include the values that led to the failure:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Good: Includes context</span>
<span class="k">assert</span> <span class="n">result</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">,</span> <span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;Result </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2"> should exceed threshold </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="sa">f</span><span class="s2">&quot;Input values: x=</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">, y=</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="p">)</span>

<span class="c1"># Bad: No context</span>
<span class="k">assert</span> <span class="n">result</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">,</span> <span class="s2">&quot;Result too low&quot;</span>
</code></pre></div>

<h3 id="2-explain-the-expectation">2. Explain the Expectation</h3>
<p>State what should have happened, not just what went wrong:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Good: Explains expectation</span>
<span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">,</span> <span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2"> should be active after email verification, &quot;</span>
    <span class="sa">f</span><span class="s2">&quot;but is_active=</span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="p">)</span>

<span class="c1"># Bad: Just states the failure</span>
<span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">,</span> <span class="s2">&quot;User not active&quot;</span>
</code></pre></div>

<h3 id="3-use-multi-line-strings-for-readability">3. Use Multi-line Strings for Readability</h3>
<p>For complex messages, use parentheses and line breaks:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Good: Readable multi-line message</span>
<span class="k">assert</span> <span class="n">actual</span> <span class="o">==</span> <span class="n">expected</span><span class="p">,</span> <span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;Configuration mismatch:</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="sa">f</span><span class="s2">&quot;Expected: </span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="sa">f</span><span class="s2">&quot;Actual: </span><span class="si">{</span><span class="n">actual</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="sa">f</span><span class="s2">&quot;Difference: </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">expected</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="nb">set</span><span class="p">(</span><span class="n">actual</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="p">)</span>

<span class="c1"># Bad: Hard to read single line</span>
<span class="k">assert</span> <span class="n">actual</span> <span class="o">==</span> <span class="n">expected</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Config mismatch: expected </span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s2"> but got </span><span class="si">{</span><span class="n">actual</span><span class="si">}</span><span class="s2"> with diff </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">expected</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="nb">set</span><span class="p">(</span><span class="n">actual</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>

<h3 id="4-dont-duplicate-introspection">4. Don't Duplicate Introspection</h3>
<p>Pytest already shows the values being compared, so don't just repeat them:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bad: Duplicates what pytest shows</span>
<span class="k">assert</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;x (</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">) should equal y (</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">)&quot;</span>

<span class="c1"># Good: Adds context pytest doesn&#39;t have</span>
<span class="k">assert</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Calculation result should match expected value for input=</span><span class="si">{</span><span class="n">input_val</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>

<h3 id="5-use-custom-messages-for-complex-logic">5. Use Custom Messages for Complex Logic</h3>
<p>When the assertion involves complex logic, explain the business rule:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Good: Explains the business rule</span>
<span class="k">assert</span> <span class="p">(</span>
    <span class="n">user</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">18</span> <span class="ow">or</span> <span class="n">user</span><span class="o">.</span><span class="n">has_parental_consent</span>
<span class="p">),</span> <span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2"> (age </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">age</span><span class="si">}</span><span class="s2">) must be 18+ or have parental consent. &quot;</span>
    <span class="sa">f</span><span class="s2">&quot;has_parental_consent=</span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">has_parental_consent</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="p">)</span>

<span class="c1"># Bad: Just restates the code</span>
<span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">18</span> <span class="ow">or</span> <span class="n">user</span><span class="o">.</span><span class="n">has_parental_consent</span><span class="p">,</span> <span class="s2">&quot;Age or consent check failed&quot;</span>
</code></pre></div>

<h2 id="when-to-use-custom-messages">When to Use Custom Messages</h2>
<p><strong>Use custom messages when</strong>:
- The assertion logic is complex or non-obvious
- You need to explain business rules or domain concepts
- Multiple conditions are being checked
- The failure could have multiple causes
- You want to guide the developer toward the fix</p>
<p><strong>Don't use custom messages when</strong>:
- Simple equality checks where introspection is sufficient
- The assertion is self-explanatory
- You're just repeating what pytest already shows</p>
<h2 id="approximate-comparisons-with-pytestapprox">Approximate Comparisons with pytest.approx</h2>
<p>Earlier we saw floating point comparison fail. Here's the solution:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_floating_point_fixed.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculation_result_with_approx</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test floating point calculation with approximate comparison&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">+</span> <span class="mf">0.2</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="mf">0.3</span>

    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_calculation_with_custom_tolerance</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test with custom tolerance&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">+</span> <span class="mf">0.2</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="mf">0.3</span>

    <span class="c1"># Allow 1% relative difference or 0.01 absolute difference</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">rel</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="nb">abs</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_list_of_floats</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that pytest.approx works with collections&quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span> <span class="o">+</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span> <span class="o">+</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span> <span class="o">+</span> <span class="mf">0.4</span><span class="p">]</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">]</span>

    <span class="k">assert</span> <span class="n">results</span> <span class="o">==</span> <span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>
</code></pre></div>

<p>Run the tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_floating_point_fixed.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 3 items

test_floating_point_fixed.py::test_calculation_result_with_approx PASSED [33%]
test_floating_point_fixed.py::test_calculation_with_custom_tolerance PASSED [66%]
test_floating_point_fixed.py::test_list_of_floats PASSED        [100%]

========================= 3 passed in 0.06s ==========================
</code></pre></div>

<p><code>pytest.approx()</code> handles floating point comparison with configurable tolerance, and works with numbers, lists, tuples, and dictionaries containing numbers.</p>
<h2 id="testing-exceptions-with-pytestraises">Testing Exceptions with pytest.raises()</h2>
<h2 id="deep-dive-exception-testing-patterns">Deep Dive: Exception Testing Patterns</h2>
<p>We introduced <code>pytest.raises()</code> in Section 7.1, but there's much more to learn about testing exceptions effectively. Let's explore advanced patterns and common pitfalls.</p>
<h2 id="iteration-7-verifying-exception-attributes">Iteration 7: Verifying Exception Attributes</h2>
<p>Beyond checking exception type and message, you often need to verify custom exception attributes:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># payment_processing.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base exception for payment failures&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">error_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">amount</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Decimal</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">transaction_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">error_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transaction_id</span> <span class="o">=</span> <span class="n">transaction_id</span>

<span class="k">class</span><span class="w"> </span><span class="nc">InsufficientFundsError</span><span class="p">(</span><span class="n">PaymentError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when account has insufficient funds&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">required</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span>
        <span class="n">available</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span>
        <span class="n">transaction_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Insufficient funds: need </span><span class="si">{</span><span class="n">required</span><span class="si">}</span><span class="s2">, have </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="n">error_code</span><span class="o">=</span><span class="s2">&quot;INSUFFICIENT_FUNDS&quot;</span><span class="p">,</span>
            <span class="n">amount</span><span class="o">=</span><span class="n">required</span><span class="p">,</span>
            <span class="n">transaction_id</span><span class="o">=</span><span class="n">transaction_id</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="n">required</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available</span> <span class="o">=</span> <span class="n">available</span>

<span class="k">class</span><span class="w"> </span><span class="nc">InvalidCardError</span><span class="p">(</span><span class="n">PaymentError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when card is invalid&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid card </span><span class="si">{</span><span class="n">card_number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="n">error_code</span><span class="o">=</span><span class="s2">&quot;INVALID_CARD&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">card_number</span> <span class="o">=</span> <span class="n">card_number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span>
    <span class="n">amount</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span>
    <span class="n">card_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">account_balance</span><span class="p">:</span> <span class="n">Decimal</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a payment.</span>
<span class="sd">    Returns transaction_id on success.</span>
<span class="sd">    Raises PaymentError on failure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate card</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">card_number</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">card_number</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidCardError</span><span class="p">(</span>
            <span class="n">card_number</span><span class="o">=</span><span class="n">card_number</span><span class="p">,</span>
            <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;must be 16 digits&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Check funds</span>
    <span class="k">if</span> <span class="n">account_balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
        <span class="n">transaction_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;TXN_</span><span class="si">{</span><span class="n">card_number</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="n">InsufficientFundsError</span><span class="p">(</span>
            <span class="n">required</span><span class="o">=</span><span class="n">amount</span><span class="p">,</span>
            <span class="n">available</span><span class="o">=</span><span class="n">account_balance</span><span class="p">,</span>
            <span class="n">transaction_id</span><span class="o">=</span><span class="n">transaction_id</span>
        <span class="p">)</span>

    <span class="c1"># Process payment</span>
    <span class="n">transaction_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;TXN_</span><span class="si">{</span><span class="n">card_number</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">_SUCCESS&quot;</span>
    <span class="k">return</span> <span class="n">transaction_id</span>
</code></pre></div>

<p>Now let's write tests that verify exception attributes:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_v1.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">process_payment</span><span class="p">,</span>
    <span class="n">InsufficientFundsError</span><span class="p">,</span>
    <span class="n">InvalidCardError</span>
<span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_insufficient_funds_exception_attributes</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that InsufficientFundsError contains correct attributes&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">InsufficientFundsError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="n">process_payment</span><span class="p">(</span>
            <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
            <span class="n">card_number</span><span class="o">=</span><span class="s2">&quot;1234567890123456&quot;</span><span class="p">,</span>
            <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;50.00&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Access the exception object</span>
    <span class="n">exc</span> <span class="o">=</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span>

    <span class="c1"># Verify all attributes</span>
    <span class="k">assert</span> <span class="n">exc</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;INSUFFICIENT_FUNDS&quot;</span>
    <span class="k">assert</span> <span class="n">exc</span><span class="o">.</span><span class="n">required</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">exc</span><span class="o">.</span><span class="n">available</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;50.00&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">exc</span><span class="o">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">exc</span><span class="o">.</span><span class="n">transaction_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;TXN_1234&quot;</span><span class="p">)</span>

    <span class="c1"># Verify message format</span>
    <span class="k">assert</span> <span class="s2">&quot;need 100.00&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s2">&quot;have 50.00&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_card_exception_attributes</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that InvalidCardError contains correct attributes&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">InvalidCardError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="n">process_payment</span><span class="p">(</span>
            <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
            <span class="n">card_number</span><span class="o">=</span><span class="s2">&quot;123&quot;</span><span class="p">,</span>  <span class="c1"># Too short</span>
            <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;200.00&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">exc</span> <span class="o">=</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span>

    <span class="k">assert</span> <span class="n">exc</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;INVALID_CARD&quot;</span>
    <span class="k">assert</span> <span class="n">exc</span><span class="o">.</span><span class="n">card_number</span> <span class="o">==</span> <span class="s2">&quot;123&quot;</span>
    <span class="k">assert</span> <span class="n">exc</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="s2">&quot;must be 16 digits&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;Invalid card 123&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
</code></pre></div>

<p>Run the tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_v1.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 2 items

test_payment_v1.py::test_insufficient_funds_exception_attributes PASSED [50%]
test_payment_v1.py::test_invalid_card_exception_attributes PASSED [100%]

========================= 2 passed in 0.07s ==========================
</code></pre></div>

<p><strong>Key pattern</strong>: Use <code>exc_info.value</code> to access the exception object, then assert on its attributes just like any other object.</p>
<h2 id="iteration-8-testing-exception-inheritance">Iteration 8: Testing Exception Inheritance</h2>
<p>Sometimes you need to verify that the right exception type is raised, considering inheritance:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_v2.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">process_payment</span><span class="p">,</span>
    <span class="n">PaymentError</span><span class="p">,</span>
    <span class="n">InsufficientFundsError</span><span class="p">,</span>
    <span class="n">InvalidCardError</span>
<span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_insufficient_funds_is_payment_error</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that InsufficientFundsError is a subclass of PaymentError&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">PaymentError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="n">process_payment</span><span class="p">(</span>
            <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
            <span class="n">card_number</span><span class="o">=</span><span class="s2">&quot;1234567890123456&quot;</span><span class="p">,</span>
            <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;50.00&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Verify it&#39;s specifically InsufficientFundsError</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">InsufficientFundsError</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;INSUFFICIENT_FUNDS&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_card_is_payment_error</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that InvalidCardError is a subclass of PaymentError&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">PaymentError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="n">process_payment</span><span class="p">(</span>
            <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
            <span class="n">card_number</span><span class="o">=</span><span class="s2">&quot;invalid&quot;</span><span class="p">,</span>
            <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;200.00&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Verify it&#39;s specifically InvalidCardError</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">InvalidCardError</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;INVALID_CARD&quot;</span>
</code></pre></div>

<p>Run the tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_v2.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 2 items

test_payment_v2.py::test_insufficient_funds_is_payment_error PASSED [50%]
test_payment_v2.py::test_invalid_card_is_payment_error PASSED [100%]

========================= 2 passed in 0.06s ==========================
</code></pre></div>

<p><strong>Key insight</strong>: <code>pytest.raises(BaseException)</code> will catch any subclass of <code>BaseException</code>. Use <code>isinstance()</code> to verify the specific subclass when needed.</p>
<h2 id="iteration-9-testing-exception-messages-with-regex">Iteration 9: Testing Exception Messages with Regex</h2>
<p>Sometimes you need more flexible message matching than substring search:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_v3.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">process_payment</span><span class="p">,</span>
    <span class="n">InsufficientFundsError</span>
<span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_insufficient_funds_message_format</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that error message follows expected format&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
        <span class="n">InsufficientFundsError</span><span class="p">,</span>
        <span class="n">match</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Insufficient funds: need \d+\.\d+, have \d+\.\d+&quot;</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="n">process_payment</span><span class="p">(</span>
            <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
            <span class="n">card_number</span><span class="o">=</span><span class="s2">&quot;1234567890123456&quot;</span><span class="p">,</span>
            <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;50.00&quot;</span><span class="p">)</span>
        <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_card_message_format</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that invalid card message follows expected format&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
        <span class="n">InvalidCardError</span><span class="p">,</span>
        <span class="n">match</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Invalid card \d+: must be 16 digits&quot;</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="n">process_payment</span><span class="p">(</span>
            <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
            <span class="n">card_number</span><span class="o">=</span><span class="s2">&quot;123&quot;</span><span class="p">,</span>
            <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;200.00&quot;</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div>

<p>Run the tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_v3.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 2 items

test_payment_v3.py::test_insufficient_funds_message_format PASSED [50%]
test_payment_v3.py::test_invalid_card_message_format PASSED [100%]

========================= 2 passed in 0.07s ==========================
</code></pre></div>

<p>The <code>match</code> parameter accepts a regex pattern. The test passes if the exception message matches the pattern.</p>
<p>Let's see what happens when the pattern doesn't match:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_v3_failing.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processing</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_payment</span><span class="p">,</span> <span class="n">InsufficientFundsError</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_insufficient_funds_wrong_pattern</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test with wrong regex pattern&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
        <span class="n">InsufficientFundsError</span><span class="p">,</span>
        <span class="n">match</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Account balance too low&quot;</span>  <span class="c1"># Wrong pattern</span>
    <span class="p">):</span>
        <span class="n">process_payment</span><span class="p">(</span>
            <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
            <span class="n">card_number</span><span class="o">=</span><span class="s2">&quot;1234567890123456&quot;</span><span class="p">,</span>
            <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;50.00&quot;</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div>

<p>Run the failing test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_v3_failing.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 1 item

test_payment_v3_failing.py::test_insufficient_funds_wrong_pattern FAILED [100%]

============================== FAILURES ==============================
__________ test_insufficient_funds_wrong_pattern _____________________

    def test_insufficient_funds_wrong_pattern():
        with pytest.raises(
            InsufficientFundsError,
            match=r&quot;Account balance too low&quot;
        ):
<span class="k">&gt; </span><span class="ge">          process_payment(</span>
                amount=Decimal(&quot;100.00&quot;),
                card_number=&quot;1234567890123456&quot;,
                account_balance=Decimal(&quot;50.00&quot;)
            )
E           AssertionError: Pattern &#39;Account balance too low&#39; does not match &#39;Insufficient funds: need 100.00, have 50.00&#39;

test_payment_v3_failing.py:10: AssertionError
========================= 1 failed in 0.08s ==========================
</code></pre></div>

<h3 id="diagnostic-analysis-match-parameter-failure">Diagnostic Analysis: Match Parameter Failure</h3>
<p><strong>The output shows</strong>:
- The pattern we expected: <code>'Account balance too low'</code>
- The actual message: <code>'Insufficient funds: need 100.00, have 50.00'</code>
- Clear indication that the pattern didn't match</p>
<p><strong>Key insight</strong>: The <code>match</code> parameter is useful for verifying message format without hardcoding exact values.</p>
<h2 id="common-failure-modes-and-their-signatures">Common Failure Modes and Their Signatures</h2>
<h3 id="symptom-test-passes-when-no-exception-is-raised">Symptom: Test passes when no exception is raised</h3>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>FAILED test_file.py::test_name - Failed: DID NOT RAISE &lt;class &#39;ExceptionType&#39;&gt;
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Message explicitly states "DID NOT RAISE"
- Shows the expected exception type</p>
<p><strong>Root cause</strong>: The code path didn't raise the expected exception</p>
<p><strong>Solution</strong>: Verify your test inputs actually trigger the error condition</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Example of this failure</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_email_should_raise</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This test will fail - email is actually valid&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">InvalidEmailError</span><span class="p">):</span>
        <span class="n">register_user</span><span class="p">(</span>
            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;valid@example.com&quot;</span><span class="p">,</span>  <span class="c1"># Bug: this is valid!</span>
            <span class="n">username</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="s2">&quot;SecurePass123&quot;</span>
        <span class="p">)</span>
</code></pre></div>

<h3 id="symptom-wrong-exception-type-is-raised">Symptom: Wrong exception type is raised</h3>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>FAILED test_file.py::test_name - ValueError: some message
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Shows the actual exception type that was raised
- No mention of "DID NOT RAISE"</p>
<p><strong>Root cause</strong>: Code raises a different exception than expected</p>
<p><strong>Solution</strong>: Either fix the code or update the test to expect the correct exception type</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Example of this failure</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_expects_custom_but_gets_builtin</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This test will fail - raises ValueError, not CustomError&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">CustomError</span><span class="p">):</span>
        <span class="c1"># Code actually raises ValueError</span>
        <span class="nb">int</span><span class="p">(</span><span class="s2">&quot;not a number&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="symptom-exception-message-doesnt-match-pattern">Symptom: Exception message doesn't match pattern</h3>
<p><strong>Pytest output pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">AssertionError</span><span class="o">:</span><span class="w"> </span><span class="n">Pattern</span><span class="w"> </span><span class="s1">&#39;expected pattern&#39;</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="s1">&#39;actual message&#39;</span>
</code></pre></div>

<p><strong>Diagnostic clues</strong>:
- Shows both the expected pattern and actual message
- Indicates regex match failure</p>
<p><strong>Root cause</strong>: Exception message format changed or pattern is incorrect</p>
<p><strong>Solution</strong>: Update the pattern or fix the message format</p>
<h2 id="testing-multiple-exceptions-in-one-test">Testing Multiple Exceptions in One Test</h2>
<p>Sometimes you need to test that different inputs raise different exceptions:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_v4.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">process_payment</span><span class="p">,</span>
    <span class="n">InsufficientFundsError</span><span class="p">,</span>
    <span class="n">InvalidCardError</span>
<span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_various_payment_failures</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that different invalid inputs raise appropriate exceptions&quot;&quot;&quot;</span>

    <span class="c1"># Test insufficient funds</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">InsufficientFundsError</span><span class="p">):</span>
        <span class="n">process_payment</span><span class="p">(</span>
            <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
            <span class="n">card_number</span><span class="o">=</span><span class="s2">&quot;1234567890123456&quot;</span><span class="p">,</span>
            <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;50.00&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Test invalid card - too short</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">InvalidCardError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="n">process_payment</span><span class="p">(</span>
            <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
            <span class="n">card_number</span><span class="o">=</span><span class="s2">&quot;123&quot;</span><span class="p">,</span>
            <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;200.00&quot;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">assert</span> <span class="s2">&quot;must be 16 digits&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># Test invalid card - non-numeric</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">InvalidCardError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="n">process_payment</span><span class="p">(</span>
            <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
            <span class="n">card_number</span><span class="o">=</span><span class="s2">&quot;abcd567890123456&quot;</span><span class="p">,</span>
            <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;200.00&quot;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">assert</span> <span class="s2">&quot;must be 16 digits&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>

<p><strong>Pattern</strong>: Multiple <code>with pytest.raises()</code> blocks in one test function. Each block tests a different error condition.</p>
<p><strong>When to use this</strong>: When testing related error conditions that share setup logic.</p>
<p><strong>When to avoid this</strong>: When error conditions are unrelated‚Äîseparate tests are clearer.</p>
<h2 id="testing-that-exceptions-are-not-raised">Testing That Exceptions Are NOT Raised</h2>
<p>Sometimes you need to verify that code completes successfully without raising:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_v5.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processing</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_payment</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_successful_payment_no_exception</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that valid payment completes without exception&quot;&quot;&quot;</span>
    <span class="c1"># This is the pattern: just call the function</span>
    <span class="c1"># If it raises, the test fails</span>
    <span class="n">transaction_id</span> <span class="o">=</span> <span class="n">process_payment</span><span class="p">(</span>
        <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
        <span class="n">card_number</span><span class="o">=</span><span class="s2">&quot;1234567890123456&quot;</span><span class="p">,</span>
        <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;200.00&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Then verify the result</span>
    <span class="k">assert</span> <span class="n">transaction_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;TXN_1234&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s2">&quot;SUCCESS&quot;</span> <span class="ow">in</span> <span class="n">transaction_id</span>
</code></pre></div>

<p><strong>Key insight</strong>: You don't need special syntax to test that exceptions aren't raised. Just call the function normally‚Äîif it raises, the test fails automatically.</p>
<h2 id="advanced-pattern-parametrizing-exception-tests">Advanced Pattern: Parametrizing Exception Tests</h2>
<p>When you have multiple similar exception scenarios, use parametrization:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_payment_v6.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">payment_processing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">process_payment</span><span class="p">,</span>
    <span class="n">InvalidCardError</span>
<span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;card_number,expected_reason&quot;</span><span class="p">,</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;123&quot;</span><span class="p">,</span> <span class="s2">&quot;must be 16 digits&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;12345678901234567&quot;</span><span class="p">,</span> <span class="s2">&quot;must be 16 digits&quot;</span><span class="p">),</span>  <span class="c1"># Too long</span>
    <span class="p">(</span><span class="s2">&quot;abcd567890123456&quot;</span><span class="p">,</span> <span class="s2">&quot;must be 16 digits&quot;</span><span class="p">),</span>  <span class="c1"># Non-numeric</span>
    <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;must be 16 digits&quot;</span><span class="p">),</span>  <span class="c1"># Empty</span>
<span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_card_numbers</span><span class="p">(</span><span class="n">card_number</span><span class="p">,</span> <span class="n">expected_reason</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that various invalid card numbers raise InvalidCardError&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">InvalidCardError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="n">process_payment</span><span class="p">(</span>
            <span class="n">amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span>
            <span class="n">card_number</span><span class="o">=</span><span class="n">card_number</span><span class="p">,</span>
            <span class="n">account_balance</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;200.00&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">assert</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">card_number</span> <span class="o">==</span> <span class="n">card_number</span>
    <span class="k">assert</span> <span class="n">expected_reason</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>

<p>Run the parametrized tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_payment_v6.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 4 items

test_payment_v6.py::test_invalid_card_numbers[123-must be 16 digits] PASSED [25%]
test_payment_v6.py::test_invalid_card_numbers[12345678901234567-must be 16 digits] PASSED [50%]
test_payment_v6.py::test_invalid_card_numbers[abcd567890123456-must be 16 digits] PASSED [75%]
test_payment_v6.py::test_invalid_card_numbers[-must be 16 digits] PASSED [100%]

========================= 4 passed in 0.09s ==========================
</code></pre></div>

<p>This pattern efficiently tests multiple error conditions with minimal code duplication.</p>
<h2 id="testing-warnings-with-pytestwarns">Testing Warnings with pytest.warns()</h2>
<h2 id="understanding-python-warnings">Understanding Python Warnings</h2>
<p>Python's warning system is designed for non-fatal issues that developers should know about but that don't prevent code execution. Common use cases:</p>
<ul>
<li>Deprecation notices</li>
<li>Performance concerns</li>
<li>Potential misuse of APIs</li>
<li>Configuration issues</li>
</ul>
<p>Testing warnings ensures your code properly alerts users to these issues.</p>
<h2 id="iteration-10-basic-warning-testing">Iteration 10: Basic Warning Testing</h2>
<p>Let's create a system that issues warnings for deprecated features:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># api_client.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DeprecationWarning</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Warning for deprecated features&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">APIClient</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;https://api.example.com&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fetch_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetch user data.</span>

<span class="sd">        DEPRECATED: Use fetch_user_v2() instead.</span>
<span class="sd">        This method will be removed in version 3.0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;fetch_user() is deprecated, use fetch_user_v2() instead&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;User&quot;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fetch_user_v2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch user data (new version)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;User&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">cache_ttl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetch data from endpoint.</span>

<span class="sd">        Args:</span>
<span class="sd">            endpoint: API endpoint</span>
<span class="sd">            use_cache: Whether to use cache</span>
<span class="sd">            cache_ttl: Cache TTL in seconds (deprecated parameter)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cache_ttl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;cache_ttl parameter is deprecated and will be ignored. &quot;</span>
                <span class="s2">&quot;Use cache configuration instead.&quot;</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;endpoint&quot;</span><span class="p">:</span> <span class="n">endpoint</span><span class="p">,</span> <span class="s2">&quot;cached&quot;</span><span class="p">:</span> <span class="n">use_cache</span><span class="p">}</span>
</code></pre></div>

<p>Now let's write tests for these warnings:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_warnings_v1.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">api_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIClient</span><span class="p">,</span> <span class="ne">DeprecationWarning</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_fetch_user_issues_deprecation_warning</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that fetch_user() issues a deprecation warning&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">APIClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test-key&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">warns</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">fetch_user</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_fetch_user_v2_no_warning</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that fetch_user_v2() does not issue a warning&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">APIClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test-key&quot;</span><span class="p">)</span>

    <span class="c1"># This should complete without warnings</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">fetch_user_v2</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cache_ttl_parameter_warning</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that cache_ttl parameter issues a warning&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">APIClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test-key&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">warns</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;/users&quot;</span><span class="p">,</span> <span class="n">cache_ttl</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</code></pre></div>

<p>Run the tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_warnings_v1.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 3 items

test_warnings_v1.py::test_fetch_user_issues_deprecation_warning PASSED [33%]
test_warnings_v1.py::test_fetch_user_v2_no_warning PASSED       [66%]
test_warnings_v1.py::test_cache_ttl_parameter_warning PASSED    [100%]

========================= 3 passed in 0.08s ==========================
</code></pre></div>

<p><strong>Key pattern</strong>: <code>pytest.warns()</code> works just like <code>pytest.raises()</code>‚Äîit's a context manager that captures warnings.</p>
<h2 id="iteration-11-inspecting-warning-messages">Iteration 11: Inspecting Warning Messages</h2>
<p>Just like with exceptions, you often need to verify the warning message:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_warnings_v2.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">api_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIClient</span><span class="p">,</span> <span class="ne">DeprecationWarning</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_fetch_user_warning_message</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that deprecation warning has correct message&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">APIClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test-key&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">warns</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">)</span> <span class="k">as</span> <span class="n">warning_info</span><span class="p">:</span>
        <span class="n">client</span><span class="o">.</span><span class="n">fetch_user</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>

    <span class="c1"># Access the warning message</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">warning_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">warning</span> <span class="o">=</span> <span class="n">warning_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="s2">&quot;fetch_user() is deprecated&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">warning</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s2">&quot;fetch_user_v2()&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">warning</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cache_ttl_warning_message</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that cache_ttl warning has correct message&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">APIClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test-key&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">warns</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">)</span> <span class="k">as</span> <span class="n">warning_info</span><span class="p">:</span>
        <span class="n">client</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;/users&quot;</span><span class="p">,</span> <span class="n">cache_ttl</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">warning_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">warning</span> <span class="o">=</span> <span class="n">warning_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="s2">&quot;cache_ttl parameter is deprecated&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">warning</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s2">&quot;cache configuration&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">warning</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
</code></pre></div>

<p>Run the tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_warnings_v2.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 2 items

test_warnings_v2.py::test_fetch_user_warning_message PASSED     [50%]
test_warnings_v2.py::test_cache_ttl_warning_message PASSED      [100%]

========================= 2 passed in 0.07s ==========================
</code></pre></div>

<h3 id="understanding-warninginfo">Understanding WarningInfo</h3>
<p>When you use <code>with pytest.warns() as warning_info:</code>, the <code>warning_info</code> object is a list of warnings. Each warning has:</p>
<ul>
<li><code>message</code>: The warning message</li>
<li><code>category</code>: The warning class</li>
<li><code>filename</code>: Where the warning was issued</li>
<li><code>lineno</code>: Line number where the warning was issued</li>
</ul>
<h2 id="iteration-12-testing-multiple-warnings">Iteration 12: Testing Multiple Warnings</h2>
<p>Sometimes code issues multiple warnings:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># api_client_extended.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="k">class</span><span class="w"> </span><span class="nc">APIClientExtended</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">complex_operation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">param1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">param2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">param3</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">param4</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Complex operation with multiple deprecated parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings_issued</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">param2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;param2 is deprecated&quot;</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">warnings_issued</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;param2&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">param3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;param3 is deprecated&quot;</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">warnings_issued</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;param3&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">param4</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;param4 is deprecated&quot;</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">warnings_issued</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;param4&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;param1&quot;</span><span class="p">:</span> <span class="n">param1</span><span class="p">,</span>
            <span class="s2">&quot;warnings&quot;</span><span class="p">:</span> <span class="n">warnings_issued</span>
        <span class="p">}</span>
</code></pre></div>

<p>Test multiple warnings:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_warnings_v3.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">api_client_extended</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIClientExtended</span><span class="p">,</span> <span class="ne">DeprecationWarning</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_multiple_deprecated_parameters</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that using multiple deprecated parameters issues multiple warnings&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">APIClientExtended</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test-key&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">warns</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">)</span> <span class="k">as</span> <span class="n">warning_info</span><span class="p">:</span>
        <span class="n">client</span><span class="o">.</span><span class="n">complex_operation</span><span class="p">(</span>
            <span class="n">param1</span><span class="o">=</span><span class="s2">&quot;value1&quot;</span><span class="p">,</span>
            <span class="n">param2</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
            <span class="n">param3</span><span class="o">=</span><span class="s2">&quot;value3&quot;</span><span class="p">,</span>
            <span class="n">param4</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="c1"># Verify we got exactly 3 warnings</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">warning_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="c1"># Verify each warning message</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">message</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">warning_info</span><span class="p">]</span>
    <span class="k">assert</span> <span class="s2">&quot;param2 is deprecated&quot;</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="s2">&quot;param3 is deprecated&quot;</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">assert</span> <span class="s2">&quot;param4 is deprecated&quot;</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_single_deprecated_parameter</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that using one deprecated parameter issues one warning&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">APIClientExtended</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test-key&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">warns</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">)</span> <span class="k">as</span> <span class="n">warning_info</span><span class="p">:</span>
        <span class="n">client</span><span class="o">.</span><span class="n">complex_operation</span><span class="p">(</span>
            <span class="n">param1</span><span class="o">=</span><span class="s2">&quot;value1&quot;</span><span class="p">,</span>
            <span class="n">param2</span><span class="o">=</span><span class="mi">42</span>
        <span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">warning_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="s2">&quot;param2 is deprecated&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">warning_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
</code></pre></div>

<p>Run the tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_warnings_v3.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 2 items

test_warnings_v3.py::test_multiple_deprecated_parameters PASSED [50%]
test_warnings_v3.py::test_single_deprecated_parameter PASSED    [100%]

========================= 2 passed in 0.08s ==========================
</code></pre></div>

<h2 id="testing-that-warnings-are-not-issued">Testing That Warnings Are NOT Issued</h2>
<p>To verify that code doesn't issue warnings, use <code>warnings.simplefilter()</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_warnings_v4.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">api_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIClient</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_fetch_user_v2_no_warnings</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that fetch_user_v2() issues no warnings&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">APIClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test-key&quot;</span><span class="p">)</span>

    <span class="c1"># Turn warnings into errors for this test</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>

        <span class="c1"># If any warning is issued, this will raise an exception</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">fetch_user_v2</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_get_data_without_deprecated_params</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that get_data() without deprecated params issues no warnings&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">APIClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test-key&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;/users&quot;</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;endpoint&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;/users&quot;</span>
</code></pre></div>

<p>Run the tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_warnings_v4.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 2 items

test_warnings_v4.py::test_fetch_user_v2_no_warnings PASSED      [50%]
test_warnings_v4.py::test_get_data_without_deprecated_params PASSED [100%]

========================= 2 passed in 0.07s ==========================
</code></pre></div>

<p><strong>Key pattern</strong>: <code>warnings.simplefilter("error")</code> converts warnings to exceptions, so any warning will fail the test.</p>
<h2 id="using-match-parameter-with-pytestwarns">Using match Parameter with pytest.warns()</h2>
<p>Just like <code>pytest.raises()</code>, <code>pytest.warns()</code> accepts a <code>match</code> parameter for regex matching:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_warnings_v5.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">api_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIClient</span><span class="p">,</span> <span class="ne">DeprecationWarning</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_warning_message_format</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that warning message follows expected format&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">APIClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test-key&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">warns</span><span class="p">(</span>
        <span class="ne">DeprecationWarning</span><span class="p">,</span>
        <span class="n">match</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;fetch_user\(\) is deprecated, use fetch_user_v2\(\) instead&quot;</span>
    <span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">fetch_user</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cache_ttl_warning_format</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test cache_ttl warning message format&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">APIClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test-key&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">warns</span><span class="p">(</span>
        <span class="ne">DeprecationWarning</span><span class="p">,</span>
        <span class="n">match</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;cache_ttl parameter is deprecated.*cache configuration&quot;</span>
    <span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;/users&quot;</span><span class="p">,</span> <span class="n">cache_ttl</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</code></pre></div>

<p>Run the tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_warnings_v5.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 2 items

test_warnings_v5.py::test_warning_message_format PASSED         [50%]
test_warnings_v5.py::test_cache_ttl_warning_format PASSED       [100%]

========================= 2 passed in 0.07s ==========================
</code></pre></div>

<h2 id="common-warning-testing-pitfalls">Common Warning Testing Pitfalls</h2>
<h3 id="pitfall-1-warnings-not-captured">Pitfall 1: Warnings Not Captured</h3>
<p>If your test doesn't capture a warning you expect:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_warnings_pitfall1.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">api_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIClient</span><span class="p">,</span> <span class="ne">DeprecationWarning</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_warning_not_captured</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This test will fail - warning is issued before the context manager&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">APIClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test-key&quot;</span><span class="p">)</span>

    <span class="c1"># BUG: Warning issued here, outside the context manager</span>
    <span class="n">client</span><span class="o">.</span><span class="n">fetch_user</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>

    <span class="c1"># Context manager expects a warning but won&#39;t see it</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">warns</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">):</span>
        <span class="k">pass</span>  <span class="c1"># No warning issued here!</span>
</code></pre></div>

<p>Run the failing test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_warnings_pitfall1.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="nx">test</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="nx">starts</span><span class="w"> </span><span class="o">========================</span><span class="p">=</span>
<span class="nx">collected</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nx">item</span>

<span class="nx">test_warnings_pitfall1</span><span class="p">.</span><span class="nx">py</span><span class="o">::</span><span class="nx">test_warning_not_captured</span><span class="w"> </span><span class="nx">FAILED</span><span class="w">    </span><span class="p">[</span><span class="mi">100</span><span class="o">%</span><span class="p">]</span>

<span class="o">==============================</span><span class="w"> </span><span class="nx">FAILURES</span><span class="w"> </span><span class="o">==============================</span>
<span class="nx">_________________</span><span class="w"> </span><span class="nx">test_warning_not_captured</span><span class="w"> </span><span class="nx">__________________________</span>

<span class="w">    </span><span class="nx">def</span><span class="w"> </span><span class="nx">test_warning_not_captured</span><span class="p">():</span>
<span class="w">        </span><span class="nx">client</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">APIClient</span><span class="p">(</span><span class="nx">api_key</span><span class="p">=</span><span class="s">&quot;test-key&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nx">client</span><span class="p">.</span><span class="nx">fetch_user</span><span class="p">(</span><span class="nx">user_id</span><span class="p">=</span><span class="mi">123</span><span class="p">)</span>

<span class="p">&gt;</span><span class="w">       </span><span class="nx">with</span><span class="w"> </span><span class="nx">pytest</span><span class="p">.</span><span class="nx">warns</span><span class="p">(</span><span class="nx">DeprecationWarning</span><span class="p">):</span>
<span class="w">            </span><span class="nx">pass</span>
<span class="nx">E</span><span class="w">       </span><span class="nx">Failed</span><span class="p">:</span><span class="w"> </span><span class="nx">DID</span><span class="w"> </span><span class="nx">NOT</span><span class="w"> </span><span class="nx">WARN</span><span class="p">.</span><span class="w"> </span><span class="nx">No</span><span class="w"> </span><span class="nx">warnings</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="p">(&lt;</span><span class="kd">class</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">api_client</span><span class="p">.</span><span class="nx">DeprecationWarning</span><span class="err">&#39;</span><span class="p">&gt;,)</span><span class="w"> </span><span class="nx">were</span><span class="w"> </span><span class="nx">emitted</span><span class="p">.</span>

<span class="nx">test_warnings_pitfall1</span><span class="p">.</span><span class="nx">py</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="w"> </span><span class="nx">Failed</span>
<span class="o">========================</span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nx">failed</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m m-Double">0.09</span><span class="nx">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p><strong>Solution</strong>: Ensure the code that issues the warning is inside the <code>with pytest.warns()</code> block.</p>
<h3 id="pitfall-2-wrong-warning-category">Pitfall 2: Wrong Warning Category</h3>
<p>If you expect the wrong warning type:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_warnings_pitfall2.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">api_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIClient</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_wrong_warning_type</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This test will fail - expects UserWarning but gets DeprecationWarning&quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">APIClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;test-key&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">warns</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">):</span>  <span class="c1"># Wrong: should be DeprecationWarning</span>
        <span class="n">client</span><span class="o">.</span><span class="n">fetch_user</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
</code></pre></div>

<p>Run the failing test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_warnings_pitfall2.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span><span class="w"> </span><span class="nx">test</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="nx">starts</span><span class="w"> </span><span class="o">========================</span><span class="p">=</span>
<span class="nx">collected</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nx">item</span>

<span class="nx">test_warnings_pitfall2</span><span class="p">.</span><span class="nx">py</span><span class="o">::</span><span class="nx">test_wrong_warning_type</span><span class="w"> </span><span class="nx">FAILED</span><span class="w">       </span><span class="p">[</span><span class="mi">100</span><span class="o">%</span><span class="p">]</span>

<span class="o">==============================</span><span class="w"> </span><span class="nx">FAILURES</span><span class="w"> </span><span class="o">==============================</span>
<span class="nx">__________________</span><span class="w"> </span><span class="nx">test_wrong_warning_type</span><span class="w"> </span><span class="nx">___________________________</span>

<span class="w">    </span><span class="nx">def</span><span class="w"> </span><span class="nx">test_wrong_warning_type</span><span class="p">():</span>
<span class="w">        </span><span class="nx">client</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">APIClient</span><span class="p">(</span><span class="nx">api_key</span><span class="p">=</span><span class="s">&quot;test-key&quot;</span><span class="p">)</span>

<span class="p">&gt;</span><span class="w">       </span><span class="nx">with</span><span class="w"> </span><span class="nx">pytest</span><span class="p">.</span><span class="nx">warns</span><span class="p">(</span><span class="nx">UserWarning</span><span class="p">):</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">fetch_user</span><span class="p">(</span><span class="nx">user_id</span><span class="p">=</span><span class="mi">123</span><span class="p">)</span>
<span class="nx">E</span><span class="w">       </span><span class="nx">Failed</span><span class="p">:</span><span class="w"> </span><span class="nx">DID</span><span class="w"> </span><span class="nx">NOT</span><span class="w"> </span><span class="nx">WARN</span><span class="p">.</span><span class="w"> </span><span class="nx">No</span><span class="w"> </span><span class="nx">warnings</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="p">(&lt;</span><span class="kd">class</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">UserWarning</span><span class="err">&#39;</span><span class="p">&gt;,)</span><span class="w"> </span><span class="nx">were</span><span class="w"> </span><span class="nx">emitted</span><span class="p">.</span><span class="w"> </span><span class="nx">The</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">emitted</span><span class="w"> </span><span class="nx">warnings</span><span class="w"> </span><span class="k">is</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="nx">DeprecationWarning</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">fetch_user</span><span class="p">()</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">deprecated</span><span class="p">,</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">fetch_user_v2</span><span class="p">()</span><span class="w"> </span><span class="nx">instead</span><span class="err">&#39;</span><span class="p">)].</span>

<span class="nx">test_warnings_pitfall2</span><span class="p">.</span><span class="nx">py</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="w"> </span><span class="nx">Failed</span>
<span class="o">========================</span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nx">failed</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m m-Double">0.09</span><span class="nx">s</span><span class="w"> </span><span class="o">==========================</span>
</code></pre></div>

<p><strong>Diagnostic clues</strong>: The error message helpfully shows what warnings <em>were</em> emitted, making it easy to fix the test.</p>
<h2 id="when-to-test-warnings">When to Test Warnings</h2>
<p><strong>Test warnings when</strong>:
- You're deprecating features and want to ensure users are notified
- You have configuration issues that should warn but not fail
- You're alerting users to performance concerns
- You want to ensure warnings are issued at the right time</p>
<p><strong>Don't test warnings when</strong>:
- The warning comes from a third-party library you don't control
- The warning is purely informational with no action required
- You're testing that warnings don't occur (use <code>warnings.simplefilter("error")</code> instead)</p>
<h2 id="context-managers-for-advanced-assertions">Context Managers for Advanced Assertions</h2>
<h2 id="beyond-pytestraises-and-pytestwarns">Beyond pytest.raises() and pytest.warns()</h2>
<p>We've seen how <code>pytest.raises()</code> and <code>pytest.warns()</code> use context managers to capture and verify exceptions and warnings. Now let's explore how to create custom context managers for more sophisticated assertion patterns.</p>
<h2 id="iteration-13-testing-state-changes">Iteration 13: Testing State Changes</h2>
<p>Let's create a system that tracks state changes and verify they happen correctly:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># state_machine.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span><span class="w"> </span><span class="nc">OrderStatus</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">PENDING</span> <span class="o">=</span> <span class="s2">&quot;pending&quot;</span>
    <span class="n">PROCESSING</span> <span class="o">=</span> <span class="s2">&quot;processing&quot;</span>
    <span class="n">SHIPPED</span> <span class="o">=</span> <span class="s2">&quot;shipped&quot;</span>
    <span class="n">DELIVERED</span> <span class="o">=</span> <span class="s2">&quot;delivered&quot;</span>
    <span class="n">CANCELLED</span> <span class="o">=</span> <span class="s2">&quot;cancelled&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">InvalidTransitionError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when state transition is invalid&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Order</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">order_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PENDING</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">OrderStatus</span><span class="p">,</span> <span class="n">datetime</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">OrderStatus</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">transition_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_status</span><span class="p">:</span> <span class="n">OrderStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transition to new status.</span>
<span class="sd">        Raises InvalidTransitionError if transition is not allowed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid_transitions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PENDING</span><span class="p">:</span> <span class="p">{</span><span class="n">OrderStatus</span><span class="o">.</span><span class="n">PROCESSING</span><span class="p">,</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">},</span>
            <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PROCESSING</span><span class="p">:</span> <span class="p">{</span><span class="n">OrderStatus</span><span class="o">.</span><span class="n">SHIPPED</span><span class="p">,</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">},</span>
            <span class="n">OrderStatus</span><span class="o">.</span><span class="n">SHIPPED</span><span class="p">:</span> <span class="p">{</span><span class="n">OrderStatus</span><span class="o">.</span><span class="n">DELIVERED</span><span class="p">},</span>
            <span class="n">OrderStatus</span><span class="o">.</span><span class="n">DELIVERED</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span>
            <span class="n">OrderStatus</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">new_status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_transitions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">InvalidTransitionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot transition from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new_status</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">new_status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">new_status</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_status_history</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OrderStatus</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return list of statuses in order&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">status</span> <span class="k">for</span> <span class="n">status</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">]</span>
</code></pre></div>

<p>Let's write tests that verify state changes:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_state_v1.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">state_machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Order</span><span class="p">,</span> <span class="n">OrderStatus</span><span class="p">,</span> <span class="n">InvalidTransitionError</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_valid_order_lifecycle</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test complete order lifecycle&quot;&quot;&quot;</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="s2">&quot;ORD-001&quot;</span><span class="p">)</span>

    <span class="c1"># Initial state</span>
    <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PENDING</span>

    <span class="c1"># Transition to processing</span>
    <span class="n">order</span><span class="o">.</span><span class="n">transition_to</span><span class="p">(</span><span class="n">OrderStatus</span><span class="o">.</span><span class="n">PROCESSING</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PROCESSING</span>

    <span class="c1"># Transition to shipped</span>
    <span class="n">order</span><span class="o">.</span><span class="n">transition_to</span><span class="p">(</span><span class="n">OrderStatus</span><span class="o">.</span><span class="n">SHIPPED</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">SHIPPED</span>

    <span class="c1"># Transition to delivered</span>
    <span class="n">order</span><span class="o">.</span><span class="n">transition_to</span><span class="p">(</span><span class="n">OrderStatus</span><span class="o">.</span><span class="n">DELIVERED</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">DELIVERED</span>

    <span class="c1"># Verify history</span>
    <span class="n">expected_history</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span>
        <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PROCESSING</span><span class="p">,</span>
        <span class="n">OrderStatus</span><span class="o">.</span><span class="n">SHIPPED</span><span class="p">,</span>
        <span class="n">OrderStatus</span><span class="o">.</span><span class="n">DELIVERED</span>
    <span class="p">]</span>
    <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">get_status_history</span><span class="p">()</span> <span class="o">==</span> <span class="n">expected_history</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_transition</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that invalid transition raises error&quot;&quot;&quot;</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="s2">&quot;ORD-002&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">InvalidTransitionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc_info</span><span class="p">:</span>
        <span class="c1"># Cannot go directly from PENDING to SHIPPED</span>
        <span class="n">order</span><span class="o">.</span><span class="n">transition_to</span><span class="p">(</span><span class="n">OrderStatus</span><span class="o">.</span><span class="n">SHIPPED</span><span class="p">)</span>

    <span class="k">assert</span> <span class="s2">&quot;Cannot transition from pending to shipped&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_info</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="c1"># Verify state didn&#39;t change</span>
    <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PENDING</span>
</code></pre></div>

<p>Run the tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_state_v1.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 2 items

test_state_v1.py::test_valid_order_lifecycle PASSED             [50%]
test_state_v1.py::test_invalid_transition PASSED                [100%]

========================= 2 passed in 0.08s ==========================
</code></pre></div>

<p><strong>Current limitation</strong>: The test is verbose and repetitive. Each state transition requires:
1. Call <code>transition_to()</code>
2. Assert the new status
3. Optionally verify the transition succeeded</p>
<p>What if we could create a context manager that automatically verifies state changes?</p>
<h2 id="creating-a-custom-context-manager-for-state-verification">Creating a Custom Context Manager for State Verification</h2>
<p>Let's create a context manager that captures the before and after state:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_helpers.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span>

<span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">assert_state_changes</span><span class="p">(</span>
    <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">attribute</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">expected_before</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">expected_after</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context manager that verifies an attribute changes from one value to another.</span>

<span class="sd">    Usage:</span>
<span class="sd">        with assert_state_changes(order, &#39;status&#39;, OrderStatus.PENDING, OrderStatus.PROCESSING):</span>
<span class="sd">            order.transition_to(OrderStatus.PROCESSING)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Verify initial state</span>
    <span class="n">actual_before</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">actual_before</span> <span class="o">==</span> <span class="n">expected_before</span><span class="p">,</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s2"> to be </span><span class="si">{</span><span class="n">expected_before</span><span class="si">}</span><span class="s2"> before operation, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;but was </span><span class="si">{</span><span class="n">actual_before</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Yield control to the test</span>
    <span class="k">yield</span>

    <span class="c1"># Verify final state</span>
    <span class="n">actual_after</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">actual_after</span> <span class="o">==</span> <span class="n">expected_after</span><span class="p">,</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s2"> to be </span><span class="si">{</span><span class="n">expected_after</span><span class="si">}</span><span class="s2"> after operation, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;but was </span><span class="si">{</span><span class="n">actual_after</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
</code></pre></div>

<p>Now let's use this context manager in our tests:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_state_v2.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">state_machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Order</span><span class="p">,</span> <span class="n">OrderStatus</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">test_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">assert_state_changes</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_order_lifecycle_with_context_manager</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test order lifecycle using custom context manager&quot;&quot;&quot;</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="s2">&quot;ORD-003&quot;</span><span class="p">)</span>

    <span class="c1"># Each transition is verified automatically</span>
    <span class="k">with</span> <span class="n">assert_state_changes</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PROCESSING</span><span class="p">):</span>
        <span class="n">order</span><span class="o">.</span><span class="n">transition_to</span><span class="p">(</span><span class="n">OrderStatus</span><span class="o">.</span><span class="n">PROCESSING</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">assert_state_changes</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PROCESSING</span><span class="p">,</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">SHIPPED</span><span class="p">):</span>
        <span class="n">order</span><span class="o">.</span><span class="n">transition_to</span><span class="p">(</span><span class="n">OrderStatus</span><span class="o">.</span><span class="n">SHIPPED</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">assert_state_changes</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">SHIPPED</span><span class="p">,</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">DELIVERED</span><span class="p">):</span>
        <span class="n">order</span><span class="o">.</span><span class="n">transition_to</span><span class="p">(</span><span class="n">OrderStatus</span><span class="o">.</span><span class="n">DELIVERED</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cancelled_order</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test cancelling an order&quot;&quot;&quot;</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="s2">&quot;ORD-004&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">assert_state_changes</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">):</span>
        <span class="n">order</span><span class="o">.</span><span class="n">transition_to</span><span class="p">(</span><span class="n">OrderStatus</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">)</span>
</code></pre></div>

<p>Run the tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_state_v2.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 2 items

test_state_v2.py::test_order_lifecycle_with_context_manager PASSED [50%]
test_state_v2.py::test_cancelled_order PASSED                   [100%]

========================= 2 passed in 0.07s ==========================
</code></pre></div>

<p><strong>Expected vs. Actual improvement</strong>: The tests are more concise and the intent is clearer. The context manager handles both the before and after verification.</p>
<p>Let's see what happens when a state change fails:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_state_v2_failing.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">state_machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Order</span><span class="p">,</span> <span class="n">OrderStatus</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">test_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">assert_state_changes</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_state_change_fails</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test what happens when state doesn&#39;t change as expected&quot;&quot;&quot;</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="s2">&quot;ORD-005&quot;</span><span class="p">)</span>

    <span class="c1"># This will fail - we expect SHIPPED but will get PROCESSING</span>
    <span class="k">with</span> <span class="n">assert_state_changes</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">SHIPPED</span><span class="p">):</span>
        <span class="n">order</span><span class="o">.</span><span class="n">transition_to</span><span class="p">(</span><span class="n">OrderStatus</span><span class="o">.</span><span class="n">PROCESSING</span><span class="p">)</span>  <span class="c1"># Wrong transition!</span>
</code></pre></div>

<p>Run the failing test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_state_v2_failing.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">========================</span> <span class="n">test</span> <span class="n">session</span> <span class="n">starts</span> <span class="o">=========================</span>
<span class="n">collected</span> <span class="mi">1</span> <span class="n">item</span>

<span class="n">test_state_v2_failing</span><span class="p">.</span><span class="n">py</span><span class="p">::</span><span class="n">test_state_change_fails</span> <span class="n">FAILED</span>        <span class="p">[</span><span class="mi">100</span><span class="err">%</span><span class="p">]</span>

<span class="o">==============================</span> <span class="n">FAILURES</span> <span class="o">==============================</span>
<span class="n">__________________</span> <span class="n">test_state_change_fails</span> <span class="n">___________________________</span>

    <span class="n">def</span> <span class="n">test_state_change_fails</span><span class="p">():</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="s">&quot;ORD-005&quot;</span><span class="p">)</span>

        <span class="n">with</span> <span class="n">assert_state_changes</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="s">&#39;status&#39;</span><span class="p">,</span> <span class="n">OrderStatus</span><span class="p">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">OrderStatus</span><span class="p">.</span><span class="n">SHIPPED</span><span class="p">):</span>
<span class="o">&gt;</span>           <span class="n">order</span><span class="p">.</span><span class="n">transition_to</span><span class="p">(</span><span class="n">OrderStatus</span><span class="p">.</span><span class="n">PROCESSING</span><span class="p">)</span>

<span class="n">test_helpers</span><span class="p">.</span><span class="n">py</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span> <span class="n">AssertionError</span>
<span class="n">E</span>       <span class="n">AssertionError</span><span class="p">:</span> <span class="n">Expected</span> <span class="n">status</span> <span class="n">to</span> <span class="n">be</span> <span class="n">OrderStatus</span><span class="p">.</span><span class="n">SHIPPED</span> <span class="n">after</span> <span class="n">operation</span><span class="p">,</span> <span class="n">but</span> <span class="n">was</span> <span class="n">OrderStatus</span><span class="p">.</span><span class="n">PROCESSING</span>

<span class="n">test_state_v2_failing</span><span class="p">.</span><span class="n">py</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span> 
<span class="o">=========================</span> <span class="mi">1</span> <span class="n">failed</span> <span class="n">in</span> <span class="mf">0.09</span><span class="n">s</span> <span class="o">==========================</span>
</code></pre></div>

<p><strong>Diagnostic Analysis</strong>: The context manager's custom message clearly explains:
- What attribute was being checked: <code>status</code>
- What value was expected: <code>OrderStatus.SHIPPED</code>
- What value was actually found: <code>OrderStatus.PROCESSING</code></p>
<h2 id="iteration-14-testing-resource-cleanup">Iteration 14: Testing Resource Cleanup</h2>
<p>Context managers are perfect for testing that resources are properly cleaned up:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># resource_manager.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FileResource</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages a temporary file resource&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_handle</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_open</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open the file resource&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_open</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write to the file&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_open</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Resource not open&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the file resource&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_handle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_handle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_open</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove the file&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ResourceManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages multiple resources with automatic cleanup&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">FileResource</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FileResource</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create and track a new resource&quot;&quot;&quot;</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">FileResource</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resource</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up all resources&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">:</span>
            <span class="n">resource</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_all</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>

<p>Let's create a context manager to verify cleanup:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_helpers_extended.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">assert_files_cleaned_up</span><span class="p">(</span><span class="o">*</span><span class="n">filenames</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context manager that verifies files are cleaned up after operation.</span>

<span class="sd">    Usage:</span>
<span class="sd">        with assert_files_cleaned_up(&#39;temp1.txt&#39;, &#39;temp2.txt&#39;):</span>
<span class="sd">            # Create and use files</span>
<span class="sd">            # They should be cleaned up by the end</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Verify files don&#39;t exist before</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>  <span class="c1"># Clean up from previous test</span>

    <span class="c1"># Yield control</span>
    <span class="k">yield</span>

    <span class="c1"># Verify files are cleaned up after</span>
    <span class="n">remaining_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">remaining_files</span><span class="p">,</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Expected all files to be cleaned up, but found: </span><span class="si">{</span><span class="n">remaining_files</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
</code></pre></div>

<p>Now test resource cleanup:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_resources.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">resource_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">ResourceManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">test_helpers_extended</span><span class="w"> </span><span class="kn">import</span> <span class="n">assert_files_cleaned_up</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_resource_manager_cleanup</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that ResourceManager cleans up all resources&quot;&quot;&quot;</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;test1.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;test2.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;test3.txt&#39;</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">assert_files_cleaned_up</span><span class="p">(</span><span class="o">*</span><span class="n">filenames</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">ResourceManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">manager</span><span class="p">:</span>
            <span class="c1"># Create resources</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                <span class="n">resource</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">create_resource</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">resource</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
                <span class="n">resource</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;test content&quot;</span><span class="p">)</span>

            <span class="c1"># Verify files exist during operation</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># After exiting ResourceManager context, files should be cleaned up</span>
        <span class="c1"># The assert_files_cleaned_up context manager will verify this</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_manual_cleanup</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test manual cleanup of resources&quot;&quot;&quot;</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;manual1.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;manual2.txt&#39;</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">assert_files_cleaned_up</span><span class="p">(</span><span class="o">*</span><span class="n">filenames</span><span class="p">):</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="n">ResourceManager</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">create_resource</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">resource</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
            <span class="n">resource</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;test content&quot;</span><span class="p">)</span>

        <span class="c1"># Manually trigger cleanup</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">cleanup_all</span><span class="p">()</span>
</code></pre></div>

<p>Run the tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_resources.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 2 items

test_resources.py::test_resource_manager_cleanup PASSED         [50%]
test_resources.py::test_manual_cleanup PASSED                   [100%]

========================= 2 passed in 0.08s ==========================
</code></pre></div>

<p>Let's see what happens when cleanup fails:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_resources_failing.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">resource_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">ResourceManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">test_helpers_extended</span><span class="w"> </span><span class="kn">import</span> <span class="n">assert_files_cleaned_up</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_cleanup_failure</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test what happens when cleanup fails&quot;&quot;&quot;</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;leak1.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;leak2.txt&#39;</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">assert_files_cleaned_up</span><span class="p">(</span><span class="o">*</span><span class="n">filenames</span><span class="p">):</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="n">ResourceManager</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">create_resource</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">resource</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
            <span class="n">resource</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;test content&quot;</span><span class="p">)</span>

        <span class="c1"># BUG: Forgot to call cleanup!</span>
        <span class="c1"># Files will still exist when context manager exits</span>
</code></pre></div>

<p>Run the failing test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_resources_failing.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 1 item

test_resources_failing.py::test_cleanup_failure FAILED          [100%]

============================== FAILURES ==============================
____________________ test_cleanup_failure ____________________________

    def test_cleanup_failure():
        filenames = [&#39;leak1.txt&#39;, &#39;leak2.txt&#39;]

        with assert_files_cleaned_up(*filenames):
            manager = ResourceManager()

            for filename in filenames:
                resource = manager.create_resource(filename)
                resource.open()
                resource.write(&quot;test content&quot;)

test_helpers_extended.py:21: AssertionError
E       AssertionError: Expected all files to be cleaned up, but found: [&#39;leak1.txt&#39;, &#39;leak2.txt&#39;]

test_resources_failing.py:9: 
========================= 1 failed in 0.10s ==========================
</code></pre></div>

<p><strong>Expected vs. Actual improvement</strong>: The context manager immediately identifies which files weren't cleaned up, making resource leaks obvious.</p>
<h2 id="iteration-15-combining-multiple-context-managers">Iteration 15: Combining Multiple Context Managers</h2>
<p>You can stack context managers to test multiple aspects simultaneously:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_combined.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">state_machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Order</span><span class="p">,</span> <span class="n">OrderStatus</span><span class="p">,</span> <span class="n">InvalidTransitionError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">test_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">assert_state_changes</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_transition_preserves_state</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that failed transition doesn&#39;t change state&quot;&quot;&quot;</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="s2">&quot;ORD-006&quot;</span><span class="p">)</span>

    <span class="c1"># Transition to processing first</span>
    <span class="k">with</span> <span class="n">assert_state_changes</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PROCESSING</span><span class="p">):</span>
        <span class="n">order</span><span class="o">.</span><span class="n">transition_to</span><span class="p">(</span><span class="n">OrderStatus</span><span class="o">.</span><span class="n">PROCESSING</span><span class="p">)</span>

    <span class="c1"># Now try invalid transition - state should remain PROCESSING</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">InvalidTransitionError</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">assert_state_changes</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PROCESSING</span><span class="p">,</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PROCESSING</span><span class="p">):</span>
            <span class="c1"># This will raise, but state should not change</span>
            <span class="n">order</span><span class="o">.</span><span class="n">transition_to</span><span class="p">(</span><span class="n">OrderStatus</span><span class="o">.</span><span class="n">DELIVERED</span><span class="p">)</span>  <span class="c1"># Invalid: skips SHIPPED</span>
</code></pre></div>

<p>Run the test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_combined.py<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 1 item

test_combined.py::test_invalid_transition_preserves_state PASSED [100%]

========================= 1 passed in 0.07s ==========================
</code></pre></div>

<p>This pattern verifies both that:
1. An exception is raised (via <code>pytest.raises()</code>)
2. The state doesn't change (via <code>assert_state_changes()</code>)</p>
<h2 id="advanced-pattern-timing-context-manager">Advanced Pattern: Timing Context Manager</h2>
<p>Let's create a context manager that verifies operations complete within a time limit:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_helpers_timing.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">assert_completes_within</span><span class="p">(</span><span class="n">seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context manager that verifies operation completes within time limit.</span>

<span class="sd">    Usage:</span>
<span class="sd">        with assert_completes_within(1.0):</span>
<span class="sd">            slow_operation()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">yield</span>

    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="k">assert</span> <span class="n">elapsed</span> <span class="o">&lt;=</span> <span class="n">seconds</span><span class="p">,</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Operation took </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s, expected &lt;= </span><span class="si">{</span><span class="n">seconds</span><span class="si">}</span><span class="s2">s&quot;</span>
    <span class="p">)</span>
</code></pre></div>

<p>Use it to test performance requirements:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_timing.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">test_helpers_timing</span><span class="w"> </span><span class="kn">import</span> <span class="n">assert_completes_within</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fast_operation</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulates a fast operation&quot;&quot;&quot;</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;done&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">slow_operation</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulates a slow operation&quot;&quot;&quot;</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;done&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_fast_operation_performance</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that fast operation completes quickly&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">assert_completes_within</span><span class="p">(</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">fast_operation</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;done&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_slow_operation_fails_timing</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that slow operation exceeds time limit&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">assert_completes_within</span><span class="p">(</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">slow_operation</span><span class="p">()</span>  <span class="c1"># This will fail the timing assertion</span>
        <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;done&quot;</span>
</code></pre></div>

<p>Run the tests:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_timing.py::test_fast_operation_performance<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 1 item

test_timing.py::test_fast_operation_performance PASSED          [100%]

========================= 1 passed in 0.11s ==========================
</code></pre></div>

<p>Run the failing test:</p>
<div class="codehilite"><pre><span></span><code>pytest<span class="w"> </span>test_timing.py::test_slow_operation_fails_timing<span class="w"> </span>-v
</code></pre></div>

<p><strong>Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>======================== test session starts =========================
collected 1 item

test_timing.py::test_slow_operation_fails_timing FAILED         [100%]

============================== FAILURES ==============================
_____________ test_slow_operation_fails_timing _______________________

    def test_slow_operation_fails_timing():
        with assert_completes_within(1.0):
<span class="k">&gt; </span><span class="ge">          result = slow_operation()</span>

test_helpers_timing.py:18: AssertionError
E       AssertionError: Operation took 2.001s, expected &lt;= 1.0s

test_timing.py:23: 
========================= 1 failed in 2.01s ==========================
</code></pre></div>

<h2 id="when-to-create-custom-context-managers">When to Create Custom Context Managers</h2>
<p><strong>Create custom context managers when</strong>:
- You have repeated setup/teardown patterns across multiple tests
- You need to verify state before and after an operation
- You want to ensure resources are cleaned up
- You need to capture and verify side effects
- You want to make test intent clearer</p>
<p><strong>Don't create custom context managers when</strong>:
- The pattern is used in only one or two tests
- Built-in context managers (<code>pytest.raises()</code>, <code>pytest.warns()</code>) already handle your case
- The abstraction makes tests harder to understand</p>
<h2 id="summary-the-journey-from-simple-to-sophisticated-assertions">Summary: The Journey from Simple to Sophisticated Assertions</h2>
<p>We started with simple equality assertions and progressively built up to sophisticated testing patterns:</p>
<table>
<thead>
<tr>
<th>Iteration</th>
<th>Challenge</th>
<th>Solution</th>
<th>Key Technique</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Basic validation</td>
<td>Simple <code>assert</code> statements</td>
<td>Equality checks</td>
</tr>
<tr>
<td>1</td>
<td>Expected exceptions</td>
<td><code>pytest.raises()</code></td>
<td>Exception capture</td>
</tr>
<tr>
<td>2</td>
<td>Exception messages</td>
<td><code>exc_info.value</code></td>
<td>Exception inspection</td>
</tr>
<tr>
<td>3</td>
<td>Complex object comparison</td>
<td>Pytest introspection</td>
<td>Automatic diff generation</td>
</tr>
<tr>
<td>4</td>
<td>Collection comparison</td>
<td>Pytest introspection</td>
<td>Index/key-specific diffs</td>
</tr>
<tr>
<td>5</td>
<td>Domain context</td>
<td>Custom assertion messages</td>
<td>Second argument to <code>assert</code></td>
</tr>
<tr>
<td>6</td>
<td>Complex business logic</td>
<td>Detailed custom messages</td>
<td>Multi-line explanations</td>
</tr>
<tr>
<td>7</td>
<td>Exception attributes</td>
<td><code>exc_info.value</code> attribute access</td>
<td>Full exception inspection</td>
</tr>
<tr>
<td>8</td>
<td>Exception inheritance</td>
<td><code>isinstance()</code> checks</td>
<td>Type verification</td>
</tr>
<tr>
<td>9</td>
<td>Message patterns</td>
<td><code>match</code> parameter</td>
<td>Regex matching</td>
</tr>
<tr>
<td>10</td>
<td>Warning testing</td>
<td><code>pytest.warns()</code></td>
<td>Warning capture</td>
</tr>
<tr>
<td>11</td>
<td>Warning messages</td>
<td><code>warning_info</code> inspection</td>
<td>Warning details</td>
</tr>
<tr>
<td>12</td>
<td>Multiple warnings</td>
<td><code>len(warning_info)</code></td>
<td>Warning counting</td>
</tr>
<tr>
<td>13</td>
<td>State changes</td>
<td>Custom context manager</td>
<td>Before/after verification</td>
</tr>
<tr>
<td>14</td>
<td>Resource cleanup</td>
<td>Custom cleanup context manager</td>
<td>Cleanup verification</td>
</tr>
<tr>
<td>15</td>
<td>Combined verification</td>
<td>Stacked context managers</td>
<td>Multiple simultaneous assertions</td>
</tr>
<tr>
<td>Advanced</td>
<td>Performance requirements</td>
<td>Timing context manager</td>
<td>Time-bounded operations</td>
</tr>
</tbody>
</table>
<h2 id="decision-framework-which-assertion-approach-when">Decision Framework: Which Assertion Approach When?</h2>
<h3 id="for-simple-value-comparisons">For Simple Value Comparisons</h3>
<ul>
<li><strong>Use</strong>: Plain <code>assert</code> with pytest introspection</li>
<li><strong>When</strong>: Comparing primitives, strings, numbers, simple collections</li>
<li><strong>Example</strong>: <code>assert result == expected</code></li>
</ul>
<h3 id="for-floating-point-comparisons">For Floating Point Comparisons</h3>
<ul>
<li><strong>Use</strong>: <code>pytest.approx()</code></li>
<li><strong>When</strong>: Comparing floating point numbers or collections containing them</li>
<li><strong>Example</strong>: <code>assert result == pytest.approx(expected, rel=1e-6)</code></li>
</ul>
<h3 id="for-exception-testing">For Exception Testing</h3>
<ul>
<li><strong>Use</strong>: <code>pytest.raises(ExceptionType)</code></li>
<li><strong>When</strong>: Verifying that code raises expected exceptions</li>
<li><strong>Add <code>match</code></strong>: When you need to verify exception message format</li>
<li><strong>Use <code>exc_info.value</code></strong>: When you need to inspect exception attributes</li>
<li><strong>Example</strong>: <code>with pytest.raises(ValueError, match=r"invalid.*") as exc_info:</code></li>
</ul>
<h3 id="for-warning-testing">For Warning Testing</h3>
<ul>
<li><strong>Use</strong>: <code>pytest.warns(WarningType)</code></li>
<li><strong>When</strong>: Verifying that code issues warnings</li>
<li><strong>Add <code>match</code></strong>: When you need to verify warning message format</li>
<li><strong>Use <code>warning_info</code></strong>: When you need to inspect multiple warnings</li>
<li><strong>Example</strong>: <code>with pytest.warns(DeprecationWarning, match=r"deprecated") as warning_info:</code></li>
</ul>
<h3 id="for-complex-assertions">For Complex Assertions</h3>
<ul>
<li><strong>Use</strong>: Custom assertion messages</li>
<li><strong>When</strong>: The assertion logic is complex or non-obvious</li>
<li><strong>When</strong>: You need to explain business rules</li>
<li><strong>When</strong>: Multiple conditions are being checked</li>
<li><strong>Example</strong>: <code>assert condition, f"Detailed explanation with {context}"</code></li>
</ul>
<h3 id="for-state-verification">For State Verification</h3>
<ul>
<li><strong>Use</strong>: Custom context managers</li>
<li><strong>When</strong>: You need to verify before/after state</li>
<li><strong>When</strong>: You have repeated verification patterns</li>
<li><strong>When</strong>: You need to ensure cleanup happens</li>
<li><strong>Example</strong>: <code>with assert_state_changes(obj, 'attr', before, after):</code></li>
</ul>
<h3 id="for-resource-management">For Resource Management</h3>
<ul>
<li><strong>Use</strong>: Custom cleanup context managers</li>
<li><strong>When</strong>: Testing that resources are properly released</li>
<li><strong>When</strong>: Verifying file/connection/handle cleanup</li>
<li><strong>Example</strong>: <code>with assert_files_cleaned_up('file1.txt', 'file2.txt'):</code></li>
</ul>
<h2 id="best-practices-summary">Best Practices Summary</h2>
<ol>
<li><strong>Start simple</strong>: Use plain <code>assert</code> until you need more</li>
<li><strong>Let pytest introspect</strong>: Don't add custom messages that just repeat what pytest shows</li>
<li><strong>Add context when needed</strong>: Use custom messages to explain business logic</li>
<li><strong>Test exceptions explicitly</strong>: Use <code>pytest.raises()</code> for expected exceptions</li>
<li><strong>Inspect when necessary</strong>: Use <code>exc_info.value</code> to verify exception details</li>
<li><strong>Match patterns flexibly</strong>: Use <code>match</code> parameter for regex-based verification</li>
<li><strong>Test warnings deliberately</strong>: Use <code>pytest.warns()</code> for deprecation and other warnings</li>
<li><strong>Create abstractions judiciously</strong>: Custom context managers for repeated patterns only</li>
<li><strong>Combine techniques</strong>: Stack context managers when testing multiple aspects</li>
<li><strong>Make failures informative</strong>: Every assertion should clearly explain what went wrong</li>
</ol>
<p>The goal is not to use every technique in every test, but to choose the right tool for each situation. Simple tests should remain simple; complex scenarios deserve sophisticated assertion strategies.</p>
        </div>
        <div class="footer">
            Generated on 2025-12-03 10:37:02 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>